import{_ as p,r as o,o as c,c as l,a as n,b as s,d as t,e}from"./app-ac79e38e.js";const i={},u=e(`<h2 id="说明" tabindex="-1"><a class="header-anchor" href="#说明" aria-hidden="true">#</a> 说明</h2><p>当 APP 目标版本是 Android 10（API 29）及以后时，由于 Android 引入了分区存储，APP 不能直接通过路径访问文件，访问外部存储空间中的媒体文件除了需要<code>READ_EXTERNAL_STORAGE</code> 或 <code>WRITE_EXTERNAL_STORAGE</code> 权限之外，需要通过其他 APP 分享的<code>Uri</code>读写文件，同理要给其余 APP 分享文件也许要通过<code>FileProvider</code>生成<code>Uri</code>并赋予对应的权限。</p><p>本文以从相册中获取图片、请求系统裁剪并返回图片为例展示对应的适配方法。</p><h2 id="实际操作" tabindex="-1"><a class="header-anchor" href="#实际操作" aria-hidden="true">#</a> 实际操作</h2><p>1.<strong>从相册中获取图片</strong></p><p>从相册中获取到的图片<code>Uri</code>一般如：<code>content://raw//storage/emulated/0/DCIM/Camera/IMG_20210531_183008.HEIC</code></p><p>app 内部要读取其内容的话，可以通过<code>context.getContentResolver().openInputStream(imageUri)</code></p><p>或者</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Cursor</span> cursor <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> filePathColumn<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从系统表中查询指定 Uri 对应的照片</span>
            cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> columnIndex <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span>filePathColumn<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>columnIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                picturePath <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>等方式读取，操作该图片。</p><p>2.<strong>将外部文件保存到本地并获取 Uri</strong></p><p>由于上述方式获取到的<code>Uri</code>只对本 APP 赋予了权限，要是希望将此图片分享给第三方 APP 进一步加工处理，则可能出现第三方 APP 没有读写权限而导致操作失败的情况，为了避免这种情况，可以将获取到的图片缓存到 APP 私有目录，并且重新生成<code>Uri</code>并赋予将要处理该图的第三方 APP 对应权限。</p><p>将外部文件缓存本地的步骤参考第一步操作即可自行完成，主要讲解一下如何将对外分享的<code>Uri</code>赋予读写权限。</p><p>下面这个方法在不同系统分别采用不同方式获取文件对应的<code>Uri</code>。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Uri</span> <span class="token function">getUriForFile</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">FileProvider</span><span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;com.your.app.packagename.fileprovider&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15),r=n("code",null,"com.your.app.packagename.fileprovider",-1),d={href:"https://developer.android.google.cn/reference/androidx/core/content/FileProvider",target:"_blank",rel:"noopener noreferrer"},k=n("code",null,"FileProvider",-1),v=n("code",null,"authorities",-1),m=n("code",null,"FileProvider",-1),g={href:"https://developer.android.google.cn/reference/androidx/core/content/FileProvider#ProviderDefinition",target:"_blank",rel:"noopener noreferrer"},_=n("code",null,"authorities",-1),b=n("code",null,"FileProvider",-1),h=n("code",null,"FileProvider",-1),f=n("code",null,"name",-1),P=e(`<div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span><span class="token punctuation">&gt;</span></span>
        ...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provider</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>androidx.core.content.FileProvider<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>authorities</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.mydomain.fileprovider<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>grantUriPermissions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>
                <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.support.FILE_PROVIDER_PATHS<span class="token punctuation">&quot;</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@xml/file_paths<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>provider</span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),I=n("code",null,"FileProvider",-1),x=n("code",null,"res/xml",-1),A=n("code",null,"file_paths.xml",-1),q={href:"https://www.jianshu.com/p/6192f04eca11",target:"_blank",rel:"noopener noreferrer"},R=e(`<div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paths</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root-path</span>
        <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>camera_photos<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    &lt;external-files-path // 对应Context#getExternalFilesDir(String)获取的路径，一般为存储卡中Android/data/com.your.app.packagename/file下面的目录
        name=&quot;external_files&quot;
        path=&quot;.&quot; /&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paths</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.<strong>对外分享有权限的 Uri</strong></p><p>对于上述步骤获取到的图片 Uri 赋予权限有两种方式：</p><p>第一种，通过<code>Intent</code>传递出去的<code>imgUri</code>，可以使用以下方式：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_GRANT_READ_URI_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_GRANT_WRITE_URI_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>imgUri<span class="token punctuation">,</span> <span class="token string">&quot;image/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是这种只适用于主动分享出去的文件，在调用第三方 APP 裁剪的场景中，一般还需要一个<code>outPutUri</code>用于保存裁剪之后的图片，对于这种场景，可以查询可能会调用的 APP 并赋予其访问权限：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>Q</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">&gt;</span></span> resInfoList <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">queryIntentActivities</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">MATCH_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResolveInfo</span> resolveInfo <span class="token operator">:</span> resInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> packageName <span class="token operator">=</span> resolveInfo<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
        contextWrap<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">grantUriPermission</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> outPutUri<span class="token punctuation">,</span>
                <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_GRANT_WRITE_URI_PERMISSION</span> <span class="token operator">|</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_GRANT_READ_URI_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样不管是分享出去的原图，还是裁剪之后保存的图片都给第三方 APP 赋予了权限，保证其可以正常访问。</p><h2 id="参考文献" tabindex="-1"><a class="header-anchor" href="#参考文献" aria-hidden="true">#</a> 参考文献</h2>`,9),F={href:"https://developer.android.google.cn/reference/androidx/core/content/FileProvider",target:"_blank",rel:"noopener noreferrer"},E={href:"https://www.jianshu.com/p/6192f04eca11",target:"_blank",rel:"noopener noreferrer"};function N(U,S){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("p",null,[s("其中"),r,s("是"),n("a",d,[k,t(a)]),s("的"),v,s("。")]),n("p",null,[s("要使用"),m,s("可以参考"),n("a",g,[s("定义 FileProvider"),t(a)]),s("操作，一般只需要修改"),_,s("即可，同时如果是开发 Android 库，为了避免与主工程已有的"),b,s("冲突，可以继承"),h,s("类并修改下文中"),f,s("字段。")]),P,n("p",null,[s("同时，为了定义此"),I,s("可以使用的文件目录范围，可以在"),x,s("文件夹中新建"),A,s("并做如下配置，也可参考官方文档或者"),n("a",q,[s("Android N 7.0 FileProvider 兼容适配 原理解析"),t(a)]),s("：")]),R,n("p",null,[n("a",F,[s("https://developer.android.google.cn/reference/androidx/core/content/FileProvider"),t(a)])]),n("p",null,[n("a",E,[s("Android N 7.0 FileProvider 兼容适配 原理解析"),t(a)])])])}const w=p(i,[["render",N],["__file","12cb887a.html.vue"]]);export{w as default};
