import{_ as p,r as e,o,c,a as n,b as s,d as t,e as l}from"./app-4152d5c1.js";const i={},u=n("h2",{id:"isolate",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#isolate","aria-hidden":"true"},"#"),s(" Isolate")],-1),r=n("p",null,"ğŸ’¡ æœ¬æ–‡åŸºäº Dart 2.17.1",-1),k={href:"https://api.dart.cn/stable/2.17.1/dart-isolate/Isolate-class.html",target:"_blank",rel:"noopener noreferrer"},d=n("strong",null,"code can access classes and values only from the same isolate",-1),m=n("strong",null,"sending values through ports",-1),v={href:"https://api.dart.cn/stable/2.17.1/dart-isolate/ReceivePort-class.html",target:"_blank",rel:"noopener noreferrer"},b={href:"https://api.dart.cn/stable/2.17.1/dart-isolate/SendPort-class.html",target:"_blank",rel:"noopener noreferrer"},g=n("br",null,null,-1),_={href:"https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375",target:"_blank",rel:"noopener noreferrer"},f=n("p",null,[s("The new isolate has its "),n("strong",null,"own memory and its own thread"),s(" working in parallel with the main isolate.")],-1),w=n("img",{src:"https://jixiaoyong.github.io/images/isolate_and_isolate_group.png",alt:"https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel=Flutterly",tabindex:"0",loading:"lazy"},null,-1),h={href:"https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel=Flutterly",target:"_blank",rel:"noopener noreferrer"},y={href:"https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel=Flutterly",target:"_blank",rel:"noopener noreferrer"},I=l(`<p>Isolate åˆ›å»ºä¼šå ç”¨å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨<code>IsolateGroup</code>æ¥è§£å†³ï¼Œå¹¶ä¸”ç›®å‰ä¸ºæ­¢ Dart å’Œ Flutter éƒ½é»˜è®¤æ”¯æŒåœ¨ä½¿ç”¨<code>Isolate.spawn</code>åˆ›å»ºæ–° Isolate çš„æ—¶å€™ä½¿ç”¨ IsolateGroupï¼ˆ<code>Isolate.spwanUri</code>åˆ›å»ºçš„æ—¶å€™ä¼šåˆ›å»º<strong>å•ç‹¬</strong>çš„ IsolateGroup å’Œ Isolateï¼‰ã€‚</p><blockquote><p>ğŸ’¡ åœ¨åˆ›å»º isolate çš„æ—¶å€™å¯ä»¥æ·»åŠ <code>addOnExitListener</code> æˆ–è€…<code>addErrorListener</code>ä¹‹ç±»çš„ç›‘å¬ï¼Œä½†æ˜¯å¯èƒ½åœ¨æ‰§è¡Œæ·»åŠ ä»£ç çš„æ—¶å€™<strong>isolate å°±å·²ç»ç»ˆæ­¢äº†</strong>è€Œå¯¼è‡´è¿™äº›æ–¹æ³•æ”¶ä¸åˆ°å›è°ƒã€‚<br> ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥åœ¨åˆ›å»º isolate çš„æ—¶å€™æŒ‡å®šä»–çš„çŠ¶æ€ä¸º**<code>paused</code>**ã€‚</p></blockquote><p>ä¸ isolate æœ‰å…³çš„ç±»æœ‰ï¼š</p><ul><li><code>Isolate</code> ä½ç½®åœ¨<code>sdk\\lib\\isolate\\isolate.dart</code>ã€‚ä¸»è¦æ˜¯<code>Isolate</code> é€šç”¨æ–¹æ³•ã€å±æ€§çš„æŠ½è±¡æè¿°ï¼Œæ²¡æœ‰å…·ä½“å®ç°ã€‚</li><li><code>Isolate</code> ä½ç½®åœ¨<code>sdk\\lib\\_internal\\vm\\lib\\isolate_patch.dart</code>ï¼Œæ˜¯ app ç­‰å¹³å°å¯¹åº”çš„å…·ä½“å®ç°ï¼Œéƒ¨åˆ†æ–¹æ³•è°ƒç”¨äº† native å±‚çš„ Isolate å®ç°ã€‚</li><li><code>Isolate</code> ä½ç½®åœ¨<code>runtime\\vm\\isolate.h</code>ä»¥åŠ<code>runtime\\vm\\isolate.cc</code>ä¸­ï¼Œæ˜¯ Isolate çš„ native å±‚å®ç°ã€‚</li></ul><p>ä»–ä»¬çš„å…³ç³»å¤§è‡´å¦‚å›¾ï¼š</p><figure><img src="https://jixiaoyong.github.io/images/isolate_class_dart_and_native.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h2 id="ç®€å•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#ç®€å•ä½¿ç”¨" aria-hidden="true">#</a> ç®€å•ä½¿ç”¨</h2><h3 id="åˆ›å»ºæ–°-isolate-çš„æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºæ–°-isolate-çš„æ–¹å¼" aria-hidden="true">#</a> åˆ›å»ºæ–° Isolate çš„æ–¹å¼ï¼š</h3><ul><li><code>Isolate(\`\`SendPort controlPort\`\`, {this.pauseCapability, this.terminateCapability});</code> è¿™ç§æ–¹å¼åˆ›å»ºä¸€ç§<strong>èƒ½åŠ›å—é™</strong>çš„ Isolateã€‚The capabilities should be the subset of the capabilities that are available to the original isolate.æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰åœ¨ native å±‚å­µåŒ–ä¸€ä¸ªæ–°çš„ Isolateã€‚</li></ul><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">var</span> newIsolate <span class="token operator">=</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>controlPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newIsolate<span class="token punctuation">.</span><span class="token function">addOnExitListener</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>controlPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newIsolate<span class="token punctuation">.</span><span class="token function">addErrorListener</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>controlPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    newIsolate<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;try kill new isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// after thisï¼Œthe dart code finish</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;finish&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>Isolate.spawn(\`\`void entryPoint(T message), T message,...)</code> åˆ›å»ºä¸€ä¸ªå’Œå½“å‰ Isolate<strong>å…±äº«åŒä¸€ä»½ä»£ç </strong>çš„ Isolateï¼Œå¹¶æ‰§è¡Œ entryPoint æ–¹æ³•ï¼Œä¸€èˆ¬åœ¨ message ä¸­ä¼ å…¥ SendPort ä»¥ä¾¿ä» entryPoint ä¸­å‘æ¥æ—¶çš„ Isolate å‘é€æ¶ˆæ¯ï¼Œæ–°å»ºçš„ Isolate å’Œå½“å‰ Isolate åœ¨åŒä¸€ä¸ª IsolateGroup ä¸­ã€‚</li></ul><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">spawnIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> receivePort <span class="token operator">=</span> <span class="token class-name">ReceivePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  receivePort<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;receivePort(</span><span class="token interpolation"><span class="token punctuation">\${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">) received msg: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//åˆ›å»ºä¸€ä¸ªå’Œå½“å‰çš„ isolate å…±äº«åŒä¸€ä»½ä»£ç çš„ Isolate</span>
<span class="token keyword">var</span> isolate <span class="token operator">=</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Isolate initial function(</span><span class="token interpolation"><span class="token punctuation">\${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">) received msg: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>message <span class="token operator">as</span> <span class="token class-name">SendPort</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;HELLO_FORM_ISOLATE(</span><span class="token interpolation"><span class="token punctuation">\${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">)&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> receivePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span>debugName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;another_isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>Isolate.spawnUriï¼ˆUri uri,List&lt;String&gt; args,var message,...ï¼‰</code>* æŒ‡å®šçš„<code>uri</code>ä¸­åˆ›å»ºå¹¶å­µåŒ–ä¸€ä¸ª isolateï¼Œæ‰§è¡Œ uri å¯¹åº”çš„ library ä¸­çš„<code>main</code>æ–¹æ³•ï¼ˆ0~2 ä¸ªå…¥å‚ï¼‰ï¼Œå¹¶ä¼ å…¥æ— å‚ã€args æˆ– message ä½œä¸ºå‚æ•°</li></ul><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">var</span> receivePort <span class="token operator">=</span> <span class="token class-name">ReceivePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  receivePort<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;receivePort(</span><span class="token interpolation"><span class="token punctuation">\${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">) received msg: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ›å»ºä¸€ä¸ªå’Œå½“å‰çš„ isolate å…±äº«åŒä¸€ä»½ä»£ç çš„ Isolate</span>
  <span class="token keyword">var</span> isolate <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span><span class="token function">spawnUri</span><span class="token punctuation">(</span>
      <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">r&quot;E:\\workspace\\others\\flutter_dart_source_code_analysis\\lib\\dart\\another_dart_file_to_spawn_uri.dart&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      receivePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span>
      debugName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;another_isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    receivePort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isolate<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>priority<span class="token punctuation">:</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span>immediate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;try kill new isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä½¿ç”¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨æ–¹æ³•" aria-hidden="true">#</a> ä½¿ç”¨æ–¹æ³•</h3><h4 id="pause" tabindex="-1"><a class="header-anchor" href="#pause" aria-hidden="true">#</a> <strong>pause</strong></h4><p><code>Capability pause([Capability? resumeCapability])</code>ï¼Œæš‚åœ Isolateï¼Œåœæ­¢ä»*<code>event loop queue</code>* ä¸­å–ï¼ˆå¹¶å¤„ç†ï¼‰æ¶ˆæ¯ï¼Œä½†æ˜¯ä¾ç„¶å¯ä»¥å¾€é‡Œé¢åŠ å…¥æ¶ˆæ¯</p><p><em><code>resumeCapability</code></em> æ˜¯ç”¨æ¥åŒºåˆ† pause çš„ï¼Œå¿…é¡»ä½¿ç”¨åŒä¸€ä¸ª*<code>resumeCapability</code>*æ¥ resume isolateã€‚</p><ul><li>ä½¿ç”¨åŒä¸€ä¸ª*<code>resumeCapability</code>*å¤šæ¬¡<code>pause</code>ï¼Œåªéœ€ä¸€æ¬¡<code>resume</code>å°±å¯ä»¥æ¢å¤<code>isolate</code></li><li>ä½¿ç”¨ä¸åŒ*<code>resumeCapability</code><em>å¤šæ¬¡<code>pause</code>ï¼Œå¿…é¡»ä½¿ç”¨å¯¹åº”çš„</em><code>resumeCapability</code><em>ä¾æ¬¡<code>resume</code>æ‰å¯ä»¥æ¢å¤<code>isolate</code> ï¼ˆ<strong>æ³¨æ„</strong>ï¼šè¿™é‡Œä¹Ÿåªéœ€è¦ä½¿ç”¨å½“æ—¶ pause isolate çš„</em><code>resumeCapability</code>* ä¾æ¬¡è°ƒç”¨ resume å³å¯ï¼Œè€Œä¸ç”¨ä¿æŒæ¬¡æ•°ä¸€è‡´ï¼Œæ¯”å¦‚ï¼Œæœ‰ 2 ä¸ª*<code>resumeCapability</code> ï¼Œ*è°ƒç”¨ pause æ¬¡æ•°åˆ†åˆ«ä¸º a 1,b 2ï¼Œé‚£ä¹ˆè¦æƒ³ resume isolateï¼Œä¹Ÿåªéœ€è¦åˆ†åˆ«ä½¿ç”¨ a,b è°ƒç”¨ä¸€æ¬¡ resume å³å¯ï¼‰</li></ul><h4 id="ping" tabindex="-1"><a class="header-anchor" href="#ping" aria-hidden="true">#</a> ping</h4><p>ä½¿ç”¨ isolate å¾€<code>receivePort.sendPort</code>å‘é€ response æ¶ˆæ¯ï¼Œ<strong>å³ä½¿ isolate å½“å‰è¢« pause ä¹Ÿå¯ä»¥æ­£å¸¸å‘é€</strong></p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code>isolate<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
isolate<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span>receivePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;is isolate resume?&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//receivePort ä¾ç„¶å¯ä»¥æ”¶åˆ°æ¶ˆæ¯</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ping å¯ä»¥æ­£å¸¸å‘é€çš„åŸå› æ˜¯ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\isolate\\isolate.dart</span>

<span class="token comment">// ping æ–¹æ³•æ˜¯ä¸€ä¸ª external æ–¹æ³•</span>
<span class="token keyword">external</span> <span class="token keyword">void</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span> responsePort<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Object</span><span class="token operator">?</span> response<span class="token punctuation">,</span> int priority <span class="token operator">=</span> immediate<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span>

<span class="token metadata function">@patch</span>
  <span class="token keyword">void</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span> responsePort<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Object</span><span class="token operator">?</span> response<span class="token punctuation">,</span> int priority<span class="token punctuation">:</span> immediate<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">filled</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// Make room for OOM message type.</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _PING
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> responsePort
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> priority
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">;</span>
    <span class="token function">_sendOOB</span><span class="token punctuation">(</span>controlPort<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_sendOOB&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_sendOOB</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// -&gt; runtime/lib/isolate.cc</span>

<span class="token comment">// åˆ›å»ºäº†ä¸€ä¸ª oob æ¶ˆæ¯å¹¶å‹å…¥ oob_queue_</span>
<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_sendOOB</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">GET_NON_NULL_NATIVE_ARGUMENT</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> arguments<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NativeArgAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">GET_NON_NULL_NATIVE_ARGUMENT</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> arguments<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NativeArgAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Make sure to route this request to the isolate library OOB mesage handler.</span>
  <span class="token class-name"><span class="token namespace">msg<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Smi</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Smi</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">:</span><span class="token punctuation">:</span>kIsolateLibOOBMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Ensure message writer (and it&#39;s resources, e.g. forwarding tables) are</span>
  <span class="token comment">// cleaned up before handling interrupts.</span>
  <span class="token punctuation">{</span>
    <span class="token class-name">PortMap</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">PostMessage</span><span class="token punctuation">(</span><span class="token class-name">WriteMessage</span><span class="token punctuation">(</span><span class="token comment">/* can_send_any_object */</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                      <span class="token comment">/* same_group */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">port<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token class-name">Message</span><span class="token punctuation">:</span><span class="token punctuation">:</span>kOOBPriority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Drain interrupts before running so any IMMEDIATE operations on the current</span>
  <span class="token comment">// isolate happen synchronously.</span>
  <span class="token keyword">const</span> <span class="token class-name">Error</span><span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>thread<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">HandleInterrupts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Exceptions</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">PropagateError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNREACHABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ MessageHandler ä¸­æœ‰ä¸¤ç§ MessageQueueï¼š<code>oob_queue_</code>å’Œ<code>queue_</code> ï¼Œå‰è€…ä¼˜å…ˆçº§é«˜ï¼Œå³ä½¿ isolate è¢« pause ä¹Ÿä¼šæ‰§è¡Œ</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\vm\\message_handler.h</span>

<span class="token comment">// æ™®é€šæ¶ˆæ¯ï¼Œæš‚åœæ—¶ä¸èƒ½å¤„ç†</span>
<span class="token class-name">MessageQueue</span><span class="token operator">*</span> queue_<span class="token punctuation">;</span>
<span class="token comment">// ä¼˜å…ˆæ¶ˆæ¯ï¼Œå³ä½¿å¤„ç†æ¶ˆæ¯æ—¶ï¼Œä¼˜å…ˆå¤„ç† obb_queue æ¶ˆæ¯ï¼Œå¦‚æœä¸ºç©ºå†å»è€ƒè™‘å¤„ç†æ™®é€šæ¶ˆæ¯</span>
<span class="token comment">// å³ä½¿ isolate è¢« pause ä¹Ÿå¯ä»¥è¢«å¤„ç†</span>
<span class="token class-name">MessageQueue</span><span class="token operator">*</span> oob_queue_<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åƒæ˜¯<code>ping</code>/<code>kill</code>/<code>pause</code>/<code>addOnExitListener</code>/<code>removeOnExitListener</code>è¿™äº›æŒ‡ä»¤æ¶ˆæ¯éƒ½æ˜¯å‹å…¥åˆ°<code>obb_queue_</code>ä¸­ä¼˜å…ˆå¤„ç†çš„ã€‚</p><h2 id="æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æºç åˆ†æ" aria-hidden="true">#</a> æºç åˆ†æ</h2><p>å…ˆçœ‹ä¸€ä¸‹å¸¸ç”¨çš„å‡ ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><h3 id="è·å–å½“å‰-isolate" tabindex="-1"><a class="header-anchor" href="#è·å–å½“å‰-isolate" aria-hidden="true">#</a> è·å–å½“å‰ Isolate</h3><p>ï¼ˆ<em>sdk/lib/isolate/isolate.dart</em>ï¼‰<code>Isolate.current</code> â†’</p><p>(<em>sdk/lib/_internal/vm/lib/isolate_patch.dart</em>) <code>Isolate get current</code> â†’ <code>Isolate._getCurrentIsolate()</code> â†’ <code>_getPortAndCapabilitiesOfCurrentIsolate()</code></p><p>ï¼ˆ<em>runtime/lib/isolate.cc</em>ï¼‰<code>DEFINE_NATIVE_ENTRY(Isolate_getPortAndCapabilitiesOfCurrentIsolate, 0, 0)</code></p><p>å…ˆçœ‹ä¸€ä¸‹<em>sdk/lib/_internal/vm/lib/isolate_patch.dart</em>ä¸­çš„å®ç°ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> _currentIsolate <span class="token operator">=</span> <span class="token function">_getCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token metadata function">@patch</span>
  <span class="token keyword">static</span> <span class="token class-name">Isolate</span> <span class="token keyword">get</span> current <span class="token operator">=</span><span class="token operator">&gt;</span> _currentIsolate<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">Isolate</span> <span class="token function">_getCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span> portAndCapabilities <span class="token operator">=</span> <span class="token function">_getPortAndCapabilitiesOfCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// è¿™é‡Œçš„å‚æ•°åˆ†åˆ«æ˜¯ SendPortï¼ŒCapabilityï¼ŒCapability</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span>portAndCapabilities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        pauseCapability<span class="token punctuation">:</span> portAndCapabilities<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        terminateCapability<span class="token punctuation">:</span> portAndCapabilities<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_getPortAndCapabilitiesOfCurrentIsolate&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token class-name">List</span> <span class="token function">_getPortAndCapabilitiesOfCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åæ˜¯æ ¹æ® native ç«¯è¿”å›çš„ä¿¡æ¯ï¼Œæ–°å»ºäº†ä¸€ä¸ª Isolate å¼•ç”¨ï¼Œä½†æ˜¯å› ä¸º<code>_currentIsolate</code>æ˜¯<code>static final</code>çš„ï¼Œæ‰€ä»¥åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿äº†åœ¨ Dart SDK ä¸­è°ƒç”¨<code>Isolate.current</code> æ—¶è·å–çš„æ˜¯å½“å‰å”¯ä¸€çš„ Isolateã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨ native ä¸­æ˜¯å¦‚ä½•æ‰¾åˆ°å½“å‰çš„ Isolate çš„ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; \\runtime\\lib\\isolate.cc</span>

<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_getPortAndCapabilitiesOfCurrentIsolate</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">Array</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">result<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">result<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">pause_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">result<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span>
      <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">terminate_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯è§æ˜¯ç›´æ¥å–çš„<strong>å½“å‰çº¿ç¨‹å¯¹åº”çš„ isolate</strong>å¯¹åº”çš„å€¼ï¼Œç»è¿‡åŒ…è£…å†è¿”å›åˆ°è°ƒç”¨æ–¹ã€‚</p><h3 id="åˆ›å»º-isolate" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-isolate" aria-hidden="true">#</a> åˆ›å»º Isolate</h3><p>åœ¨ Dart ä¸­åˆ›å»º Isolate æœ‰ 3 ç§æ–¹å¼ï¼š</p><ul><li><code>Isolate(this.controlPort, {this.pauseCapability, this.terminateCapability});</code> <strong>*create</strong> an* <em>isolateï¼Œæœ¬è´¨ä¸Šåªæ˜¯å°†</em><code>controlPort</code> ç­‰è®¾ç½®ä¸ºä¼ å…¥çš„å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰åœ¨ native å±‚æ–°å»º Isolate</li><li><code>Isolate.spawn</code> <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li><li><code>Isolate.spawnUri</code> <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li></ul><figure><img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è¿™é‡Œåˆ†æä¸€ä¸‹åé¢ä¸¤ç§æ–¹å¼ï¼Œå¯¹æ¯”ä¸€ä¸‹å·®å¼‚ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk\\lib\\isolate\\isolate.dart</span>

<span class="token comment">// Creates a new [Isolate] object with a restricted set of capabilities.</span>
<span class="token class-name">Isolate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controlPort<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>pauseCapability<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>terminateCapability<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// Creates and spawns an isolate that shares the same code as the current</span>
<span class="token comment">/// isolate.</span>
<span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> spawn<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      <span class="token keyword">void</span> <span class="token function">entryPoint</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">T</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      <span class="token metadata function">@Since</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;2.3&quot;</span></span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/// Creates and spawns an isolate that runs the code from the library with</span>
  <span class="token comment">/// the specified URI.</span>
  <span class="token comment">///</span>
  <span class="token comment">/// The isolate starts executing the top-level \`main\` function of the library</span>
  <span class="token comment">/// with the given URI.</span>
	<span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">spawnUri</span><span class="token punctuation">(</span>
      <span class="token class-name">Uri</span> uri<span class="token punctuation">,</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">,</span>
      <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      bool<span class="token operator">?</span> checked<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> environment<span class="token punctuation">,</span>
      <span class="token metadata function">@Deprecated</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;The packages/ dir is not supported in Dart 2&#39;</span></span><span class="token punctuation">)</span>
          <span class="token class-name">Uri</span><span class="token operator">?</span> packageRoot<span class="token punctuation">,</span>
      <span class="token class-name">Uri</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      bool automaticPackageResolution <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token metadata function">@Since</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;2.3&quot;</span></span><span class="token punctuation">)</span>
          <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äº APP ç­‰æ¥è¯´ï¼Œä¸Šè¿°<code>Isolate.spawn</code>å’Œ<code>Isolate.spawnUri</code>çš„å®ç°éƒ½åœ¨<code>vm</code>ä¸‹é¢çš„<code>isolate_patch.dart</code>ä¸­ï¼ˆjs ä¼šè¿”å›<code>_unsupported()</code>ï¼‰ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk\\lib\\_internal\\vm\\lib\\isolate_patch.dart</span>

  <span class="token metadata function">@patch</span>
  <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> spawn<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">entryPoint</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">T</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// \`paused\` isn&#39;t handled yet.</span>
    <span class="token comment">// Check for the type of \`entryPoint\` on the spawning isolate to make</span>
    <span class="token comment">// error-handling easier.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entryPoint <span class="token operator">is!</span> _UnaryFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentError</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// The VM will invoke [_startIsolate] with entryPoint as argument.</span>

    <span class="token comment">// We do not inherit the package config settings from the parent isolate,</span>
    <span class="token comment">// instead we use the values that were set on the command line.</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">final</span> <span class="token class-name">RawReceivePort</span> readyPort <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">RawReceivePort</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&#39;Isolate.spawn ready&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token operator">*</span>_spawnFunction<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>readyPort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span> script<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> message<span class="token punctuation">,</span>
          paused<span class="token punctuation">,</span> errorsAreFatal<span class="token punctuation">,</span> onExit<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> packageConfig<span class="token punctuation">,</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token operator">*</span><span class="token operator">*</span>_spawnCommon<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>readyPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> st<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token metadata function">@patch</span>
  <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">spawnUri</span><span class="token punctuation">(</span><span class="token class-name">Uri</span> uri<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">,</span> <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      bool<span class="token operator">?</span> checked<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> environment<span class="token punctuation">,</span>
      <span class="token class-name">Uri</span><span class="token operator">?</span> packageRoot<span class="token punctuation">,</span>
      <span class="token class-name">Uri</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      bool automaticPackageResolution <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>

    <span class="token comment">// Verify that no mutually exclusive arguments have been passed.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Resolve the uri against the current isolate&#39;s root Uri first.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// The VM will invoke [_startIsolate] and not \`main\`.</span>
    <span class="token keyword">final</span> packageConfigString <span class="token operator">=</span> packageConfig<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">RawReceivePort</span> readyPort <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">RawReceivePort</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&#39;Isolate.spawnUri ready&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token operator">*</span>_spawnUri<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>
          readyPort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span>
          spawnedUri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          args<span class="token punctuation">,</span>
          message<span class="token punctuation">,</span>
          paused<span class="token punctuation">,</span>
          onExit<span class="token punctuation">,</span>
          onError<span class="token punctuation">,</span>
          errorsAreFatal<span class="token punctuation">,</span>
          checked<span class="token punctuation">,</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token comment">/* environment */</span>
          packageConfigString<span class="token punctuation">,</span>
          debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token operator">*</span><span class="token operator">*</span>_spawnCommon<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>readyPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">rethrow</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">//  Isolate.spawn call</span>
<span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_spawnFunction&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_spawnFunction</span><span class="token punctuation">(</span>
      <span class="token class-name">SendPort</span> readyPort<span class="token punctuation">,</span>
      <span class="token class-name">String</span> uri<span class="token punctuation">,</span>
      <span class="token class-name">Function</span> topLevelFunction<span class="token punctuation">,</span>
      <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      bool paused<span class="token punctuation">,</span>
      bool errorsAreFatal<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  Isolate.spawnUri call</span>
<span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_spawnUri&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_spawnUri</span><span class="token punctuation">(</span>
      <span class="token class-name">SendPort</span> readyPort<span class="token punctuation">,</span>
      <span class="token class-name">String</span> uri<span class="token punctuation">,</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">,</span>
      <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      bool paused<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      bool errorsAreFatal<span class="token punctuation">,</span>
      bool<span class="token operator">?</span> checked<span class="token punctuation">,</span>
      <span class="token class-name">List</span><span class="token operator">?</span> environment<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ç›‘å¬ Isolate spawn çŠ¶æ€ï¼Œç­‰æˆåŠŸä¹‹åå°†å…¶å¤„ç†åè¿”å›ç»™ Dart å±‚çš„è°ƒç”¨è€…</span>
<span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">_spawnCommon</span><span class="token punctuation">(</span><span class="token class-name">RawReceivePort</span> readyPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> completer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Completer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token keyword">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    readyPort<span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token punctuation">(</span>readyMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>readyMessage <span class="token operator">is</span> <span class="token class-name">List</span> <span class="token operator">&amp;&amp;</span> readyMessage<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SendPort</span> controlPort <span class="token operator">=</span> readyMessage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span> capabilities <span class="token operator">=</span> readyMessage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token operator">*</span>completer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span>controlPort<span class="token punctuation">,</span>
            pauseCapability<span class="token punctuation">:</span> capabilities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            terminateCapability<span class="token punctuation">:</span> capabilities<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>readyMessage <span class="token operator">is</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We encountered an error while starting the new isolate.</span>
        completer<span class="token punctuation">.</span><span class="token function">completeError</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsolateSpawnException</span><span class="token punctuation">(</span>
            <span class="token string-literal"><span class="token string">&#39;Unable to spawn isolate: </span><span class="token interpolation"><span class="token punctuation">\${</span><span class="token expression">readyMessage</span><span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// This shouldn&#39;t happen.</span>
        completer<span class="token punctuation">.</span><span class="token function">completeError</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsolateSpawnException</span><span class="token punctuation">(</span>
            <span class="token string-literal"><span class="token string">&quot;Internal error: unexpected format for ready message: &quot;</span></span>
            <span class="token string-literal"><span class="token string">&quot;&#39;</span><span class="token interpolation"><span class="token punctuation">\${</span><span class="token expression">readyMessage</span><span class="token punctuation">}</span></span><span class="token string">&#39;&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> completer<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å®ï¼Œæ ¹æ®ä¸Šè¿°çš„ä»£ç ï¼Œä¸ç®¡æ˜¯<code>Isolate.spawnUri()</code> è¿˜æ˜¯<code>Isolate.spawn</code>ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨<code>RawReceivePort</code>è·å–<code>RawReceivePort readyPort</code>ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨äº†<code>_spawnCommon(readyPort)</code> æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡<code>new Isolate(controlPort, pauseCapability: capabilities[0], terminateCapability: capabilities[1])</code>æ–¹æ³•åˆ›å»ºäº†æ–°çš„<code>Isolate</code> ã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰åœ¨<code>sdk/lib/isolate/isolate.dart</code>ä¸­ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk/lib/isolate/isolate.dart</span>
<span class="token keyword">final</span> <span class="token class-name">SendPort</span> controlPort<span class="token punctuation">;</span>

<span class="token class-name">Isolate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controlPort<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>pauseCapability<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>terminateCapability<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Dart ä¸­ï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„ Isolate ä¸»è¦æ˜¯<strong>æŒæœ‰ä¸€ä¸ªå’Œ native ä¸­å¯¹åº” SendPort</strong>ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼š</p><ul><li><code>Isolate.spawn</code>æœ€åè°ƒç”¨äº†<code>_spawnFunction</code>æ–¹æ³•ï¼ˆnative å±‚å®ç°ä¸º<code>Isolate_spawnFunction</code>ï¼‰ï¼›</li><li><code>Isolate.spawnUri</code>æœ€åè°ƒç”¨äº†<code>_spawnUri</code>æ–¹æ³•ï¼ˆnative å±‚å®ç°ä¸º<code>Isolate_spawnUri</code>ï¼‰ã€‚</li></ul><blockquote><p>ğŸ’¡ <code>new RawReceivePort()</code>æ–¹æ³•ä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ªä¸å­˜åœ¨äº<code>_RawReceivePortImpl</code>çš„<code>static final _portMap = &lt;int, Map&lt;String, dynamic&gt;&gt;{};</code> ä¸­çš„ SendPortï¼ˆå…·ä½“å®ç°åœ¨<code>PortMap::CreatePort</code>ä¸­ï¼‰ã€‚</p></blockquote><h4 id="isolate-spawnfunction" tabindex="-1"><a class="header-anchor" href="#isolate-spawnfunction" aria-hidden="true">#</a> Isolate_spawnFunction</h4><p><code>Isolate.spawn</code>æœ€åè°ƒç”¨äº†<code>_spawnFunction</code>æ–¹æ³•ï¼Œæ¥çœ‹ä¸€ä¸‹å¯¹åº”çš„<code>Isolate_spawnFunction</code> çš„å®ç°ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\lib\\isolate.cc</span>

<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_spawnFunction</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// è§£æå‚æ•°</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// closure_tuple_handle å¯¹åº”æˆ‘ä»¬åœ¨ Dart ä¸­ Isolate.spawn() ä¸­ä¼ å…¥çš„ entryPoint</span>
    <span class="token comment">// ä¹Ÿå°±æ˜¯ isolate åˆ›å»ºå¥½ä»¥åæ‰§è¡Œçš„æ–¹æ³•</span>

  std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateSpawnState</span><span class="token punctuation">&gt;</span></span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsolateSpawnState</span><span class="token punctuation">(</span>
      <span class="token class-name"><span class="token namespace">port<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String2UTF8</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">)</span><span class="token punctuation">,</span>
      closure_tuple_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>message_buffer<span class="token punctuation">,</span> utf8_package_config<span class="token punctuation">,</span>
      paused<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fatal_errors<span class="token punctuation">,</span> on_exit_port<span class="token punctuation">,</span> on_error_port<span class="token punctuation">,</span>
      utf8_debug_name<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Since this is a call to Isolate.spawn, copy the parent isolate&#39;s code.</span>
  state<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>copy_parent_code <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Run</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpawnIsolateTask</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                                                         std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯è§ï¼Œ<code>Isolate_spawnFunction</code>æ–¹æ³•ä¸­ä¸»è¦è¿˜æ˜¯è§£ææ”¶åˆ°çš„å„ç§å‚æ•°ï¼Œæœ€ååœ¨å½“å‰ isolate å¯¹åº”çš„ IsolateGroup çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œ<code>SpawnIsolateTask</code>ï¼š</p><h5 id="spawnisolatetask" tabindex="-1"><a class="header-anchor" href="#spawnisolatetask" aria-hidden="true">#</a> SpawnIsolateTask</h5><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\lib\\isolate.cc</span>

<span class="token keyword">class</span> <span class="token class-name">SpawnIsolateTask</span> <span class="token punctuation">:</span> public <span class="token class-name">ThreadPool</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Task</span> <span class="token punctuation">{</span>
	<span class="token class-name">SpawnIsolateTask</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token operator">*</span> parent_isolate<span class="token punctuation">,</span>
                   std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateSpawnState</span><span class="token punctuation">&gt;</span></span> state<span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token function">parent_isolate_</span><span class="token punctuation">(</span>parent_isolate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">state_</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parent_isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">IncrementSpawnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token class-name">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">const</span> char<span class="token operator">*</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
                           <span class="token operator">?</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">function_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                           <span class="token punctuation">:</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    auto group <span class="token operator">=</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">RunHeavyweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">RunLightweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="runlightweight" tabindex="-1"><a class="header-anchor" href="#runlightweight" aria-hidden="true">#</a> RunLightWeight</h5><p>å› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„<code>isolateâ†’group</code>ä¸ä¸ºç©ºï¼Œæ‰€ä»¥èµ°çš„æ˜¯<code>RunLightWeight</code>:</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\lib\\isolate.cc</span>

<span class="token keyword">void</span> <span class="token class-name">RunLightweight</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The create isolate initialize callback is mandatory.</span>
    auto initialize_callback <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitializeCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialize_callback <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">&quot;Lightweight isolate spawn is not supported by this Dart embedder\\n&quot;</span></span><span class="token punctuation">,</span>
          <span class="token comment">/*has_current_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    char<span class="token operator">*</span> error <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    auto group <span class="token operator">=</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> isolate <span class="token operator">=</span> <span class="token class-name">CreateWithinExistingIsolateGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    parent_isolate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">DecrementSpawnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parent_isolate_ <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token comment">/*has_current_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span><span class="token operator">*</span> child_isolate_data <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token keyword">const</span> bool success <span class="token operator">=</span> <span class="token function">initialize_callback</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>child_isolate_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Dart_ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_init_callback_data</span><span class="token punctuation">(</span>child_isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ³¨æ„è¿™é‡Œçš„ Run æ–¹æ³•ï¼Œåœ¨**RunHeavyweight æ–¹æ³•çš„æœ€åä¹Ÿè°ƒç”¨äº†</span>
    <span class="token comment">// åˆ°æ—¶å€™ä¼šä¸€èµ·åˆ†æä¸€ä¸‹</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Run</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\dart_api_impl.cc</span>

<span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">CreateWithinExistingIsolateGroup</span><span class="token punctuation">(</span><span class="token class-name">IsolateGroup</span><span class="token operator">*</span> group<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">,</span>
                                          char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">API_TIMELINE_DURATION</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_NO_ISOLATE</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  auto spawning_group <span class="token operator">=</span> group<span class="token punctuation">;</span>

  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> isolate <span class="token operator">=</span><span class="token operator">*</span><span class="token operator">*</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">Isolate</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>spawning_group<span class="token punctuation">,</span> <span class="token comment">/*is_new_group=*/</span><span class="token boolean">false</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span>
                    <span class="token comment">/*isolate_data=*/</span>nullptr<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>

	<span class="token comment">// å› ä¸ºæ‰§è¡Œåˆ°è¿™é‡Œçš„éƒ½æœ‰ IsolateGroupï¼Œå…±äº«åŒä¸€ä»½ä»£ç </span>
  auto source <span class="token operator">=</span> spawning_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œä¸»è¦è¿›è¡Œäº† 2 æ­¥ï¼š</p><ul><li>ä½¿ç”¨<code>CreateWithinExistingIsolateGroup</code>åˆ›å»º Isolate</li><li>ä½¿ç”¨å…¨å±€çš„<code>initialize_callback</code> ï¼ˆä¹Ÿå°±æ˜¯<code>Isolate::InitializeCallback()</code>ï¼‰åˆå§‹åŒ– Isolate</li></ul><h6 id="isolate-initializecallback" tabindex="-1"><a class="header-anchor" href="#isolate-initializecallback" aria-hidden="true">#</a> Isolate::InitializeCallback()</h6><p>è¿™å…¶ä¸­çš„<code>Isolate::InitializeCallback()</code>æ˜¯åœ¨<code>Dart::Init</code>çš„æ—¶å€™å°±å·²ç»è®¾ç½®äº†çš„ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime/bin/main.cc</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char<span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// Initialize the Dart VM.</span>
  <span class="token class-name">Dart_InitializeParams</span> init_params<span class="token punctuation">;</span>
	init_params<span class="token punctuation">.</span>version <span class="token operator">=</span> DART_INITIALIZE_PARAMS_CURRENT_VERSION<span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>vm_snapshot_data <span class="token operator">=</span> vm_snapshot_data<span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>vm_snapshot_instructions <span class="token operator">=</span> vm_snapshot_instructions<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span>init_params<span class="token punctuation">.</span>create_group <span class="token operator">=</span> <span class="token class-name">CreateIsolateGroupAndSetup</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token operator">*</span><span class="token operator">*</span>init_params<span class="token punctuation">.</span>initialize_isolate <span class="token operator">=</span> <span class="token class-name">OnIsolateInitialize</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  init_params<span class="token punctuation">.</span>shutdown_isolate <span class="token operator">=</span> <span class="token class-name">OnIsolateShutdown</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>cleanup_isolate <span class="token operator">=</span> <span class="token class-name">DeleteIsolateData</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>cleanup_group <span class="token operator">=</span> <span class="token class-name">DeleteIsolateGroupData</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_open <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">OpenFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_read <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">ReadFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_write <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">WriteFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_close <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CloseFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>entropy_source <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">EntropySource</span><span class="token punctuation">;</span>

	error <span class="token operator">=</span> <span class="token class-name">Dart_Initialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\dart_api_impl.cc</span>

DART_EXPORT char<span class="token operator">*</span> <span class="token class-name">Dart_Initialize</span><span class="token punctuation">(</span><span class="token class-name">Dart_InitializeParams</span><span class="token operator">*</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">&quot;Dart_Initialize: &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;Dart_InitializeParams is null.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>version <span class="token operator">!=</span> DART_INITIALIZE_PARAMS_CURRENT_VERSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">&quot;Dart_Initialize: &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;Invalid Dart_InitializeParams version.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\dart.cc</span>

char<span class="token operator">*</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Dart_InitializeParams</span><span class="token operator">*</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">init_state_<span class="token punctuation">.</span></span>SetInitializing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">&quot;Bad VM initialization state, &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;already initialized or &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;multiple threads initializing the VM.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  char<span class="token operator">*</span> retval <span class="token operator">=</span> <span class="token class-name">DartInit</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name"><span class="token namespace">init_state_<span class="token punctuation">.</span></span>ResetInitializing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name"><span class="token namespace">init_state_<span class="token punctuation">.</span></span>SetInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

char<span class="token operator">*</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">DartInit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Dart_InitializeParams</span><span class="token operator">*</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token class-name">OSThread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Zone</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">IsolateGroup</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">PortMap</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Service</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">ExitIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Unregister the VM isolate from this thread.</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetCreateGroupCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>create_group<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetInitializeCallback_</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>initialize_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetShutdownCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>shutdown_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetCleanupCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>cleanup_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetGroupCleanupCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>cleanup_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetRegisterKernelBlobCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>register_kernel_blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetUnregisterKernelBlobCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>unregister_kernel_blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šæ–‡çš„<code>Isolate::InitializeCallback()</code>å®é™…ä¸Šå°±æ˜¯<code>OnIsolateInitialize</code>ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯åœ¨ isolate åˆ›å»ºå¥½ä¹‹åè¿›è¡Œç»Ÿä¸€çš„åˆå§‹åŒ–æ“ä½œï¼Œç»‘å®šä¸€äº›æ•°æ®ï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\bin\\main.cc</span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">OnIsolateInitialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> child_callback_data<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dart_Isolate isolate <span class="token operator">=</span> <span class="token function">Dart_CurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>isolate <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> isolate_group_data <span class="token operator">=</span>
      <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>IsolateGroupData<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">Dart_CurrentIsolateGroupData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateData</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>child_callback_data <span class="token operator">=</span> isolate_data<span class="token punctuation">;</span>

  <span class="token function">Dart_EnterScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">*</span><span class="token operator">*</span>script_uri<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">=</span> isolate_group_data<span class="token operator">-&gt;</span>script_url<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">bool</span> <span class="token operator">*</span><span class="token operator">*</span>isolate_run_app_snapshot<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">=</span>
      isolate_group_data<span class="token operator">-&gt;</span><span class="token function">RunFromAppSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Dart_Handle <span class="token operator">*</span><span class="token operator">*</span>result<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">=</span> <span class="token function">SetupCoreLibraries</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span>
                                          <span class="token comment">/*group_start=*/</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                                          <span class="token comment">/*resolved_packages_config=*/</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate_run_app_snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token class-name">Loader</span><span class="token double-colon punctuation">::</span><span class="token function">InitForSnapshot</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token double-colon punctuation">::</span><span class="token function">ResolveScript</span><span class="token punctuation">(</span><span class="token function">Dart_NewStringFromCString</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate_group_data<span class="token operator">-&gt;</span><span class="token function">kernel_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Various core-library parts will send requests to the Loader to resolve</span>
      <span class="token comment">// relative URIs and perform other related tasks. We need Loader to be</span>
      <span class="token comment">// initialized for this to work because loading from Kernel binary</span>
      <span class="token comment">// bypasses normal source code loading paths that initialize it.</span>
      <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> resolved_script_uri <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">Dart_StringToCString</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resolved_script_uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token class-name">Loader</span><span class="token double-colon punctuation">::</span><span class="token function">InitForSnapshot</span><span class="token punctuation">(</span>resolved_script_uri<span class="token punctuation">,</span> isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">Dart_ExitScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

failed<span class="token operator">:</span>
  <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">StrDup</span><span class="token punctuation">(</span><span class="token function">Dart_GetError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Dart_ExitScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="createwithinexistingisolategroup" tabindex="-1"><a class="header-anchor" href="#createwithinexistingisolategroup" aria-hidden="true">#</a> CreateWithinExistingIsolateGroup</h6><p><code>CreateWithinExistingIsolateGroup</code> â†’ <code>CreateIsolate</code></p><p>å†çœ‹ä¸€ä¸‹åˆ›å»º Isolate çš„å…·ä½“æ–¹æ³•ï¼Œè¿™ä¸ªåœ¨ä¸åŒçš„ device ä¸Šé¢ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åªå…³æ³¨ vm ä¸‹é¢çš„å®ç°ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\vm\\dart_api_impl.cc</span>

<span class="token keyword">static</span> <span class="token class-name">Dart_Isolate</span> <span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span><span class="token class-name">IsolateGroup</span><span class="token operator">*</span> group<span class="token punctuation">,</span>
                                  bool is_new_group<span class="token punctuation">,</span>
                                  <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">,</span>
                                  <span class="token keyword">void</span><span class="token operator">*</span> isolate_data<span class="token punctuation">,</span>
                                  char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token operator">*</span>CHECK_NO_ISOLATE<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  auto source <span class="token operator">=</span> group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">I</span> <span class="token operator">=</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>flags<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">I</span> <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Isolate creation failed&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dart_Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Thread</span><span class="token operator">*</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    <span class="token class-name">StackZone</span> <span class="token function">zone</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We enter an API scope here as InitializeIsolate could compile some</span>
    <span class="token comment">// bootstrap library files which call out to a tag handler that may create</span>
    <span class="token comment">// Api Handles when an error is encountered.</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">EnterApiScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">Error</span><span class="token operator">&amp;</span> error_obj <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
        <span class="token class-name">Z</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitializeIsolate</span><span class="token punctuation">(</span>
               source<span class="token operator">-</span><span class="token operator">&gt;</span>snapshot_data<span class="token punctuation">,</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>snapshot_instructions<span class="token punctuation">,</span>
               source<span class="token operator">-</span><span class="token operator">&gt;</span>kernel_buffer<span class="token punctuation">,</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>kernel_buffer_size<span class="token punctuation">,</span>
               is_new_group <span class="token operator">?</span> nullptr <span class="token punctuation">:</span> group<span class="token punctuation">,</span> isolate_data<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">error_obj<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FLAG_check_function_fingerprints</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">FLAG_precompiled_mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Library</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CheckFunctionFingerprints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
#endif  <span class="token comment">// defined(DEBUG) &amp;&amp; !defined(DART_PRECOMPILED_RUNTIME).</span>
      success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">error_obj<span class="token punctuation">.</span></span>ToErrorCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// We exit the API scope entered above.</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">ExitApiScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_new_group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">InitGrowthControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// A Thread structure has been associated to the thread, we do the</span>
    <span class="token comment">// safepoint transition explicitly here instead of using the</span>
    <span class="token comment">// TransitionXXX scope objects as the reverse transition happens</span>
    <span class="token comment">// outside this scope in Dart_ShutdownIsolate/Dart_ExitIsolate.</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_execution_state</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span>kThreadInNative<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">EnterSafepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Api</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CastIsolate</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dart_Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œä¸»è¦æœ‰ä¸¤æ­¥ï¼š</p><ul><li><code>Dart::CreateIsolate</code>åˆ›å»ºäº†<code>Isolate* I</code>ï¼›</li><li>ç„¶åè°ƒç”¨<code>Dart::InitializeIsolate</code>åˆå§‹åŒ– isolateã€‚</li></ul><p><strong>Dart::CreateIsolateï¼š</strong></p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\vm\\dart.cc</span>

<span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name_prefix<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">&amp;</span> api_flags<span class="token punctuation">,</span>
                             <span class="token class-name">IsolateGroup</span><span class="token operator">*</span> isolate_group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create a new isolate.</span>
  <span class="token class-name">Isolate</span><span class="token operator">*</span> isolate <span class="token operator">=</span>
      <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitIsolate</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">,</span> isolate_group<span class="token punctuation">,</span> api_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ğŸ’¡ åœ¨ Dart è™šæ‹Ÿæœºå¯åŠ¨ï¼ˆ<code>Dart::DartInit</code>ï¼‰çš„æ—¶å€™ï¼Œä¹Ÿä¼šè°ƒç”¨<code>Dart::InitIsolate</code>åˆ›å»ºè™šæ‹Ÿæœºå¯¹åº”çš„ Isolateï¼Œæ‰§è¡Œ UI æ“ä½œï¼š<br><code>vm_isolate_ = Isolate::InitIsolate(kVmIsolateName, group, api_flags, is_vm_isolate);</code></p></blockquote><p>åœ¨<code>Isolate::InitIsolate</code>æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯ç”¨<code>isolate_group</code>åˆ›å»ºäº†æ–°çš„ Isolateï¼Œç„¶åå°†å…¶ä¸<code>Thread</code>ï¼Œ<code>MessageHandler</code>ï¼Œ<code>SendPort</code>ç­‰ç»‘å®šï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\vm\\isolate.cc</span>

<span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitIsolate</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name_prefix<span class="token punctuation">,</span>
                              <span class="token class-name">IsolateGroup</span><span class="token operator">*</span> isolate_group<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">&amp;</span> api_flags<span class="token punctuation">,</span>
                              bool is_vm_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// åˆ›å»ºæ–°çš„ Isolate</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span>isolate_group<span class="token punctuation">,</span> api_flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">BuildName</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_vm_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vm isolate object store is initialized later, after null instance</span>
    <span class="token comment">// is created (in Dart::Init).</span>
    <span class="token comment">// Non-vm isolates need to have isolate object store initialized is that</span>
    <span class="token comment">// exit_listeners have to be null-initialized as they will be used if</span>
    <span class="token comment">// we fail to create isolate below, have to do low level shutdown.</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ASSERT</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
<span class="token comment">// Initialize metrics.</span>
#define <span class="token function">ISOLATE_METRIC_INIT</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> variable<span class="token punctuation">,</span> name<span class="token punctuation">,</span> unit<span class="token punctuation">)</span>                        \\
  result<span class="token operator">-</span><span class="token operator">&gt;</span>metric_##variable##_<span class="token punctuation">.</span><span class="token function">InitInstance</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> name<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> <span class="token class-name">Metric</span><span class="token punctuation">:</span><span class="token punctuation">:</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ISOLATE_METRIC_LIST</span><span class="token punctuation">(</span>ISOLATE_METRIC_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
#undef ISOLATE_METRIC_INIT
#endif  <span class="token comment">// !defined(PRODUCT)</span>

  <span class="token comment">// First we ensure we enter the isolate. This will ensure we&#39;re participating</span>
  <span class="token comment">// in any safepointing requests from this point on. Other threads requesting a</span>
  <span class="token comment">// safepoint operation will therefore wait until we&#39;ve stopped.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Though the [result] isolate is still in a state where no memory has been</span>
  <span class="token comment">// allocated, which means it&#39;s safe to GC the isolate group until here.</span>
  <span class="token comment">// åˆ›å»ºä¸€ä¸ª Thread å¹¶å’Œå½“å‰ isolate ç»‘å®š</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">EnterIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    delete result<span class="token punctuation">;</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Setup the isolate message handler.</span>
  <span class="token class-name">MessageHandler</span><span class="token operator">*</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IsolateMessageHandler</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>handler <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// åœ¨è¿™é‡Œç»‘å®šäº† message handler</span>
  <span class="token operator">*</span><span class="token operator">*</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_message_handler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>

  <span class="token operator">*</span><span class="token operator">*</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_main_port</span><span class="token punctuation">(</span><span class="token class-name">PortMap</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreatePort</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
  <span class="token comment">// Verify that we are never reusing a live origin id.</span>
  <span class="token class-name">VerifyOriginId</span> <span class="token function">id_verifier</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">VisitIsolates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id_verifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_origin_id</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_pause_capability</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NextUInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_terminate_capability</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NextUInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span>debugger_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Debugger</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token comment">// Now we register the isolate in the group. From this point on any GC would</span>
  <span class="token comment">// traverse the isolate roots (before this point, the roots are only pointing</span>
  <span class="token comment">// to vm-isolate objects, e.g. null)</span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">RegisterIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">NameEquals</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetServiceIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KernelIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">NameEquals</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">KernelIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">KernelIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetKernelIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif  <span class="token comment">// !defined(DART_PRECOMPILED_RUNTIME)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FLAG_trace_isolates</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name_prefix <span class="token operator">==</span> nullptr <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;vm-isolate&quot;</span></span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      OS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">PrintErr</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">&quot;[+] Starting isolate:\\n&quot;</span></span>
          <span class="token string-literal"><span class="token string">&quot;\\tisolate:    %s\\n&quot;</span></span><span class="token punctuation">,</span>
          result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Add to isolate list. Shutdown and delete the isolate on failure.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TryMarkIsolateReady</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">LowLevelShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">LowLevelCleanup</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Dart::InitializeIsolate</strong></p><p>è¿™é‡Œä¸»è¦æ˜¯å¯¹ isolate è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶åœ¨åˆå§‹åŒ–å®Œæˆåé€šçŸ¥åˆ›å»ºè¿™ä¸ª isolate çš„ isolateã€‚</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\vm\\dart.cc</span>

<span class="token class-name">ErrorPtr</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitializeIsolate</span><span class="token punctuation">(</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_data<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_instructions<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> kernel_buffer<span class="token punctuation">,</span>
                                 intptr_t kernel_buffer_size<span class="token punctuation">,</span>
                                 <span class="token class-name">IsolateGroup</span><span class="token operator">*</span> source_isolate_group<span class="token punctuation">,</span>
                                 <span class="token keyword">void</span><span class="token operator">*</span> isolate_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Initialize the new isolate.</span>
  <span class="token class-name">Thread</span><span class="token operator">*</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">I</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  auto IG <span class="token operator">=</span> <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>SUPPORT_TIMELINE<span class="token punctuation">)</span>
  <span class="token class-name">TimelineBeginEndScope</span> <span class="token function">tbes</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Timeline</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">GetIsolateStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token string-literal"><span class="token string">&quot;InitializeIsolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">tbes<span class="token punctuation">.</span></span>SetNumArguments</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">tbes<span class="token punctuation">.</span></span>CopyArgument</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;isolateName&quot;</span></span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">I</span> <span class="token operator">!=</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">StackZone</span> <span class="token function">zone</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">HandleScope</span> <span class="token function">handle_scope</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool was_child_cloned_into_existing_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source_isolate_group <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If a static field gets registered in [IsolateGroup::RegisterStaticField]:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   * before this block it will ignore this isolate. The [Clone] of the</span>
    <span class="token comment">//     initial field table will pick up the new value.</span>
    <span class="token comment">//   * after this block it will add the new static field to this isolate.</span>
    <span class="token punctuation">{</span>
      <span class="token class-name">SafepointReadRwLocker</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> source_isolate_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">program_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span>set_field_table<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span>
                         source_isolate_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">initial_field_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Clone</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">field_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">MarkReadyToUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">}</span>

    was_child_cloned_into_existing_isolate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">Error</span><span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
				<span class="token comment">// ä» IsolateGroup ä¸­å¼•ç”¨ä¸€äº›é€šç”¨çš„å˜é‡ï¼ˆå¸¸é‡ç­‰ç­‰ï¼‰</span>
        <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">InitIsolateFromSnapshot</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> snapshot_data<span class="token punctuation">,</span> snapshot_instructions<span class="token punctuation">,</span>
                                kernel_buffer<span class="token punctuation">,</span> kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> error<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">VerifyBuiltinVtables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DEBUG_ONLY</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Verify</span><span class="token punctuation">(</span>kForbidMarked<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
  <span class="token keyword">const</span> bool kIsAotRuntime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
#<span class="token keyword">else</span>
  <span class="token keyword">const</span> bool kIsAotRuntime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
#endif

  <span class="token keyword">if</span> <span class="token punctuation">(</span>kIsAotRuntime <span class="token operator">||</span> was_child_cloned_into_existing_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>TARGET_ARCH_IA32<span class="token punctuation">)</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_generic_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
           <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
           <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>TARGET_ARCH_IA32<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">I</span> <span class="token operator">!=</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">vm_isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_generic_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
          nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SafepointWriteRwLocker</span> <span class="token function">ml</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">program_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_generic_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
            nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_build_generic_method_extractor_code</span><span class="token punctuation">(</span>
              <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
                  <span class="token class-name">StubCode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">GetBuildGenericMethodExtractorStub</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
          nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SafepointWriteRwLocker</span> <span class="token function">ml</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">program_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
            nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span>
              <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
                  <span class="token class-name">StubCode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">GetBuildNonGenericMethodExtractorStub</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(TARGET_ARCH_IA32)</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_ic_miss_code</span><span class="token punctuation">(</span><span class="token class-name">StubCode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SwitchableCallMiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Error</span><span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot_data <span class="token operator">==</span> nullptr <span class="token operator">||</span> kernel_buffer <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    error <span class="token operator">^=</span> IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">PreallocateObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> error<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> auto<span class="token operator">&amp;</span> out_of_memory <span class="token operator">=</span>
      <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">out_of_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  error <span class="token operator">^=</span> <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">PreallocateObjects</span><span class="token punctuation">(</span>out_of_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>was_child_cloned_into_existing_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">InitGrowthControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_init_callback_data</span><span class="token punctuation">(</span>isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FLAG_print_class_table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">class_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
  <span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">MaybeMakeServiceIsolate</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">IsSystemIsolate</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_should_pause_on_start</span><span class="token punctuation">(</span>
        <span class="token class-name">FLAG_pause_isolates_on_start</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_should_pause_on_exit</span><span class="token punctuation">(</span><span class="token class-name">FLAG_pause_isolates_on_exit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(PRODUCT)</span>

  <span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SendIsolateStartupMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NotifyIsolateCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token comment">// Create tag table.</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_tag_table</span><span class="token punctuation">(</span><span class="token class-name">GrowableObjectArray</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">GrowableObjectArray</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Set up default UserTag.</span>
  <span class="token keyword">const</span> <span class="token class-name">UserTag</span><span class="token operator">&amp;</span> default_tag <span class="token operator">=</span> <span class="token class-name">UserTag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">UserTag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">DefaultTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_current_tag</span><span class="token punctuation">(</span>default_tag<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init_loaded_prefixes_set_storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯è°ƒç”¨<code>Isolate.spawn()</code>çš„è¯ï¼Œå…ˆä»å½“å‰ isolate è·å–å¯¹åº”çš„ Isolate Groupï¼Œç„¶åä½¿ç”¨è¿™ä¸ª Isolate Group åˆ›å»ºé…ç½®ä¸€ä¸ªæ–°çš„ isolateï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ª isolate group ä¸­çš„ Isolate å¯ä»¥å…±äº«å¸¸é‡ï¼Œheap ç­‰ã€‚</p><h4 id="isolate-spawnuri" tabindex="-1"><a class="header-anchor" href="#isolate-spawnuri" aria-hidden="true">#</a> Isolate_spawnUri</h4><p>å¦‚æœæ˜¯ä½¿ç”¨<code>Isolate.spawnUri()</code>çš„è¯ï¼Œå°±ä¼šé€šè¿‡<code>Isolate_spawnUri</code>æ¥åˆ›å»º isolateã€‚</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\lib\\isolate.cc</span>

	<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_spawnUri</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// è§£æå‚æ•°</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Canonicalize the uri with respect to the current isolate.</span>
  <span class="token keyword">const</span> <span class="token class-name">Library</span><span class="token operator">&amp;</span> root_lib <span class="token operator">=</span>
      <span class="token class-name">Library</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">root_library</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  char<span class="token operator">*</span> error <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
<span class="token comment">// è·å– canonical_uri</span>
  <span class="token keyword">const</span> char<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">*</span>canonical_uri <span class="token operator">=</span> <span class="token class-name">CanonicalizeUri</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> root_lib<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>canonical_uri <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">String</span><span class="token operator">&amp;</span> msg <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowIsolateSpawnException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> char<span class="token operator">*</span> utf8_package_config <span class="token operator">=</span>
      <span class="token class-name"><span class="token namespace">packageConfig<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> NULL <span class="token punctuation">:</span> <span class="token class-name">String2UTF8</span><span class="token punctuation">(</span>packageConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> char<span class="token operator">*</span> utf8_debug_name <span class="token operator">=</span>
      <span class="token class-name"><span class="token namespace">debugName<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> NULL <span class="token punctuation">:</span> <span class="token class-name">String2UTF8</span><span class="token punctuation">(</span>debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateSpawnState</span><span class="token punctuation">&gt;</span></span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">IsolateSpawnState</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>
      <span class="token class-name"><span class="token namespace">port<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canonical_uri<span class="token punctuation">,</span> utf8_package_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arguments_buffer<span class="token punctuation">,</span>
      <span class="token operator">&amp;</span>message_buffer<span class="token punctuation">,</span> paused<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fatal_errors<span class="token punctuation">,</span> on_exit_port<span class="token punctuation">,</span>
			<span class="token comment">// æ³¨æ„ä¸‹é¢è¿™é‡Œçš„ group=nullptr</span>
      on_error_port<span class="token punctuation">,</span> utf8_debug_name<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token comment">/*group=*/</span>nullptr<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If we were passed a value then override the default flags state for</span>
  <span class="token comment">// checked mode.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">checked<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">*</span> flags <span class="token operator">=</span> state<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flags<span class="token operator">-</span><span class="token operator">&gt;</span>enable_asserts <span class="token operator">=</span> checked<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Since this is a call to Isolate.spawnUri, don&#39;t copy the parent&#39;s code.</span>
  state<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>copy_parent_code <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Run</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpawnIsolateTask</span><span class="token punctuation">&gt;</span></span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                                                         std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°<code>Isolate_spawnUri</code>è¿˜æ˜¯æ‰§è¡Œäº†<code>SpawnIsolateTask</code> ã€‚</p><h5 id="spawnisolatetask-1" tabindex="-1"><a class="header-anchor" href="#spawnisolatetask-1" aria-hidden="true">#</a> SpawnIsolateTask</h5><p>åœ¨<code>SpawnIsolateTask.Run</code>æ–¹æ³•ä¸­ï¼Œå› ä¸º<code>spawnUri</code>ä¸­<code>IsolateSpawnState</code>çš„<code>IsolateGroup</code>ä¸º<code>nulltrp</code>ï¼Œæ‰€ä»¥è¿™é‡Œæ‰§è¡Œçš„æ˜¯<code>RunHeavyweight(name)</code>ï¼š</p><h5 id="runheavyweight" tabindex="-1"><a class="header-anchor" href="#runheavyweight" aria-hidden="true">#</a> RunHeavyweight</h5><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt;</span>

<span class="token keyword">class</span> <span class="token class-name">SpawnIsolateTask</span> <span class="token punctuation">:</span> public <span class="token class-name">ThreadPool</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Task</span> <span class="token punctuation">{</span>

<span class="token keyword">void</span> <span class="token class-name">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">const</span> char<span class="token operator">*</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
                           <span class="token operator">?</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">function_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                           <span class="token punctuation">:</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    auto group <span class="token operator">=</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">RunHeavyweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">RunLightweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">RunHeavyweight</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The create isolate group callback is mandatory.  If not provided we</span>
    <span class="token comment">// cannot spawn isolates.</span>
		<span class="token comment">// åœ¨ Dart::DartInit ä¸­å·²ç»è¢«è®¾ç½®ï¼Œåœ¨ Isolate åˆ›å»ºæ—¶ä¼šè¢«å›è°ƒ</span>
    <span class="token operator">*</span><span class="token operator">*</span>auto create_group_callback <span class="token operator">=</span> <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreateGroupCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>create_group_callback <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Isolate spawn is not supported by this Dart embedder\\n&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    char<span class="token operator">*</span> error <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token comment">// Make a copy of the state&#39;s isolate flags and hand it to the callback.</span>
    <span class="token class-name">Dart_IsolateFlags</span> api_flags <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    api_flags<span class="token punctuation">.</span>is_system_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// åˆ›å»º isolate</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Dart_Isolate</span> isolate <span class="token operator">=</span>
        <span class="token punctuation">(</span>create_group_callback<span class="token punctuation">)</span><span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">script_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span>
                                state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">package_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>api_flags<span class="token punctuation">,</span>
                                parent_isolate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init_callback_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    parent_isolate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">DecrementSpawnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parent_isolate_ <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token comment">/*has_current_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// åˆ‡æ¢åˆ°æŒ‡å®šçš„ isolate</span>
    <span class="token class-name">Dart_EnterIsolate</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿™é‡Œä¹Ÿè°ƒç”¨äº† Run æ–¹æ³•</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Run</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">Isolate</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸»è¦åˆ›å»º Isolate çš„è¿‡ç¨‹åœ¨<code>Isolate::CreateGroupCallback();</code>ä¸­ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»–æ˜¯æ€ä¹ˆæ¥çš„ï¼š</p><h5 id="isolate-creategroupcallback" tabindex="-1"><a class="header-anchor" href="#isolate-creategroupcallback" aria-hidden="true">#</a> Isolate::CreateGroupCallback()</h5><p>ä»–å’Œä¸Šè¿°<code>Isolate::InitializeCallback_</code>çš„æ¥æºä¸€è‡´ï¼Œéƒ½æ˜¯åœ¨<code>Dart_Initialize</code>ä¸­é…ç½®çš„ï¼Œæ­¤å¤–ï¼Œè¿˜ä½¿ç”¨äº†<code>parent_isolate_-&gt;init_callback_data()</code>ã€‚</p><p>å…ˆçœ‹ä¸€ä¸‹çš„<code>CreateIsolateGroupAndSetup</code>å®ç°ï¼š</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\\bin\\main.cc</span>

<span class="token keyword">static</span> <span class="token class-name">Dart_Isolate</span> <span class="token class-name">CreateIsolateGroupAndSetup</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> script_uri<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> char<span class="token operator">*</span> main<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> char<span class="token operator">*</span> package_root<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> char<span class="token operator">*</span> package_config<span class="token punctuation">,</span>
                                               <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">*</span> flags<span class="token punctuation">,</span>
                                               <span class="token keyword">void</span><span class="token operator">*</span> callback_data<span class="token punctuation">,</span>
                                               char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// The VM should never call the isolate helper with a NULL flags.</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>flags <span class="token operator">!=</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>flags<span class="token operator">-</span><span class="token operator">&gt;</span>version <span class="token operator">==</span> DART_FLAGS_CURRENT_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>package_root <span class="token operator">==</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  bool dontneed_safe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DART_HOST_OS_LINUX<span class="token punctuation">)</span>
  <span class="token comment">// This would also be true in Linux, except that Google3 overrides the default</span>
  <span class="token comment">// ELF interpreter to one that apparently doesn&#39;t create proper mappings.</span>
  dontneed_safe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
#elif <span class="token function">defined</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
  <span class="token comment">// If the snapshot isn&#39;t file-backed, madvise(DONT_NEED) is destructive.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">force_load_elf_from_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dontneed_safe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif
  flags<span class="token operator">-</span><span class="token operator">&gt;</span>snapshot_is_dontneed_safe <span class="token operator">=</span> dontneed_safe<span class="token punctuation">;</span>

  int exit_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>EXCLUDE_CFE_AND_KERNEL_PLATFORM<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> DART_KERNEL_ISOLATE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateAndSetupKernelIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> error<span class="token punctuation">,</span>
                                       <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span>

#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> DART_DEV_ISOLATE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateAndSetupDartDevIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                        error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(DART_PRECOMPILED_RUNTIME)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> DART_VM_SERVICE_ISOLATE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateAndSetupServiceIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                        error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool is_main_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateIsolateGroupAndSetupHelper</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>is_main_isolate<span class="token punctuation">,</span> script_uri<span class="token punctuation">,</span> main<span class="token punctuation">,</span>
                                          package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> callback_data<span class="token punctuation">,</span>
                                          error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œåˆ›å»º Isolate çš„æ—¶å€™ï¼ŒåŒºåˆ†äº†å‡ ç§æƒ…å†µï¼š</p><ul><li>å¦‚æœæ˜¯ kernel-serviceï¼ˆ<code>DART_KERNEL_ISOLATE_NAME</code>ï¼‰å°±æ‰§è¡Œ<code>CreateAndSetupKernelIsolate</code></li><li>å¦‚æœæ˜¯ dartdevï¼ˆ<code>DART_DEV_ISOLATE_NAME</code>ï¼‰å°±æ‰§è¡Œ<code>CreateAndSetupDartDevIsolate</code></li><li>å¦‚æœæ˜¯ vm-serviceï¼ˆ<code>DART_VM_SERVICE_ISOLATE_NAME</code>ï¼‰å°±æ‰§è¡Œ<code>CreateAndSetupServiceIsolate</code></li><li>å¦‚æœä»¥ä¸Šéƒ½ä¸æ»¡è¶³ï¼Œå°±æ‰§è¡Œ<code>CreateIsolateGroupAndSetupHelper</code></li></ul><p>æ˜¾ç„¶ï¼Œå½“æˆ‘ä»¬åœ¨ Dart ä»£ç ä¸­è°ƒç”¨<code>Isolate.spawnUri</code>çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæ‰§è¡Œçš„æ˜¯<code>CreateIsolateGroupAndSetupHelper</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\bin\\main.cc</span>

<span class="token comment">// è°ƒç”¨æ–¹</span>
	<span class="token keyword">bool</span> is_main_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">CreateIsolateGroupAndSetupHelper</span><span class="token punctuation">(</span>is_main_isolate<span class="token punctuation">,</span> script_uri<span class="token punctuation">,</span> main<span class="token punctuation">,</span>
                                          package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> callback_data<span class="token punctuation">,</span>
                                          error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns newly created Isolate on success, NULL on failure.</span>
<span class="token keyword">static</span> Dart_Isolate <span class="token function">CreateIsolateGroupAndSetupHelper</span><span class="token punctuation">(</span>
		<span class="token keyword">bool</span> is_main_isolate<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> script_uri<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> packages_config<span class="token punctuation">,</span>
    Dart_IsolateFlags<span class="token operator">*</span> flags<span class="token punctuation">,</span>
    <span class="token keyword">void</span><span class="token operator">*</span> callback_data<span class="token punctuation">,</span>
    <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">,</span>
    <span class="token keyword">int</span><span class="token operator">*</span> exit_code<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// æ ¹æ®æ˜¯ AOT è¿˜æ˜¯ JIT è·å– kernel_bufferï¼Œapp_snapshotï¼Œisolate_run_app_snapshot ç­‰æ•°æ®</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span><span class="token punctuation">{</span></span></span>
<span class="token comment">// AOT: All isolates need to be run from AOT compiled snapshots.</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token expression"><span class="token punctuation">{</span></span></span>
	<span class="token comment">// JIT: Main isolate starts from the app snapshot, if any. Other isolates</span>
  <span class="token comment">// use the core libraries snapshot.</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»º isolate_group_data</span>
	<span class="token keyword">auto</span> isolate_group_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateGroupData</span><span class="token punctuation">(</span>
      script_uri<span class="token punctuation">,</span> packages_config<span class="token punctuation">,</span> app_snapshot<span class="token punctuation">,</span> isolate_run_app_snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// copy_parent_code ä¸º true çš„è¯ï¼Œè¿™é‡Œçš„ kernel_buffer ä¸º NULL</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>kernel_buffer <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kernel_buffer_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isolate_group_data<span class="token operator">-&gt;</span><span class="token function">SetKernelBufferAlreadyOwned</span><span class="token punctuation">(</span>
          std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>kernel_buffer_ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      isolate_group_data<span class="token operator">-&gt;</span><span class="token function">SetKernelBufferNewlyOwned</span><span class="token punctuation">(</span>kernel_buffer<span class="token punctuation">,</span>
                                                    kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

	Dart_Isolate isolate <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  IsolateData<span class="token operator">*</span> isolate_data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span></span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate_run_app_snapshot <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>isolate_snapshot_data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> platform_kernel_buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    intptr_t platform_kernel_buffer_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    dfe<span class="token punctuation">.</span><span class="token function">LoadPlatform</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_kernel_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>platform_kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>platform_kernel_buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      platform_kernel_buffer <span class="token operator">=</span> kernel_buffer<span class="token punctuation">;</span>
      platform_kernel_buffer_size <span class="token operator">=</span> kernel_buffer_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>platform_kernel_buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>EXCLUDE_CFE_AND_KERNEL_PLATFORM<span class="token punctuation">)</span></span></span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Binary built with --exclude-kernel-service. Cannot run&quot;</span>
          <span class="token string">&quot; from source.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">&quot;platform_program cannot be NULL.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO(sivachandra): When the platform program is unavailable, check if</span>
    <span class="token comment">// application kernel binary is self contained or an incremental binary.</span>
    <span class="token comment">// Isolate should be created only if it is a self contained kernel binary.</span>
    isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateData</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isolate <span class="token operator">=</span> <span class="token function">Dart_CreateIsolateGroupFromKernel</span><span class="token punctuation">(</span>
        script_uri<span class="token punctuation">,</span> name<span class="token punctuation">,</span> platform_kernel_buffer<span class="token punctuation">,</span> platform_kernel_buffer_size<span class="token punctuation">,</span>
        flags<span class="token punctuation">,</span> isolate_group_data<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateData</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Creates a new isolate. The new isolate becomes the current isolate.</span>
    isolate <span class="token operator">=</span> <span class="token function">Dart_CreateIsolateGroup</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> name<span class="token punctuation">,</span> isolate_snapshot_data<span class="token punctuation">,</span>
                                      isolate_snapshot_instructions<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                      isolate_group_data<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> IsolateData<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Creates a new isolate. The new isolate becomes the current isolate.</span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate <span class="token operator">=</span> Dart_CreateIsolateGroup<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> name<span class="token punctuation">,</span> isolate_snapshot_data<span class="token punctuation">,</span>
                                    isolate_snapshot_instructions<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                    <span class="token operator">*</span><span class="token operator">*</span>isolate_group_data<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>isolate_data<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span>

  Dart_Isolate created_isolate <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> isolate_data<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> isolate_group_data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token operator">*</span>created_isolate <span class="token operator">=</span> IsolateSetupHelper<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>
        isolate<span class="token punctuation">,</span> is_main_isolate<span class="token punctuation">,</span> script_uri<span class="token punctuation">,</span> packages_config<span class="token punctuation">,</span>
        isolate_run_app_snapshot<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> error<span class="token punctuation">,</span> exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">int64_t</span> end <span class="token operator">=</span> <span class="token function">Dart_TimelineGetMicros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Dart_TimelineEvent</span><span class="token punctuation">(</span><span class="token string">&quot;CreateIsolateGroupAndSetupHelper&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span>
                     Dart_Timeline_Event_Duration<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> created_isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>CreateIsolateGroupAndSetupHelper</code>æŒ‰ç…§æ˜¯ JIT è¿˜æ˜¯ AOT çš„ç¼–è¯‘æ–¹å¼ï¼Œæœ‰ä¸åŒçš„è·å–æ•°æ®çš„æ–¹å¼ï¼Œä½†ä¸ç®¡å“ªç§æ–¹å¼ï¼Œæœ€åéƒ½æ‰§è¡Œäº†ä¸€ä¸‹ä¸‰æ­¥ï¼š</p><ul><li>åˆ›å»º<code>IsolateData* isolate_data</code> ä½¿ç”¨<code>isolate_group_data</code>åˆ›å»º IsolateData</li><li>åˆ›å»º<code>Dart_Isolate isolate</code> åˆ›å»º<code>Dart_Isolate</code>ï¼Œå°†<code>script_uri</code>ï¼Œ<code>isolate_data</code>ï¼Œå’Œ<code>isolate_group_data</code>ç­‰ç»‘å®š</li><li>åˆ›å»ºå¹¶è¿”å›<code>Dart_Isolate created_isolate</code>åŒ…è£…<code>isolate</code> ï¼Œè¿›è¡Œæ•°æ®ç»‘å®šï¼Œå¹¶å°† isolate æ ‡è®°ä¸º<code>runnable</code></li></ul><h6 id="dart-createisolategroup" tabindex="-1"><a class="header-anchor" href="#dart-createisolategroup" aria-hidden="true">#</a> Dart_CreateIsolateGroup</h6><p>è¿™é‡Œåˆ†æä¸€ä¸‹**<code>Dart_CreateIsolateGroup</code>çš„è¿‡ç¨‹ï¼š**</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// --&gt; runtime/vm/dart_api_impl.cc#L1371</span>

DART_EXPORT <span class="token class-name">Dart_Isolate</span>
<span class="token class-name">Dart_CreateIsolateGroup</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> script_uri<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_data<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_instructions<span class="token punctuation">,</span>
                        <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">*</span> flags<span class="token punctuation">,</span>
                        <span class="token keyword">void</span><span class="token operator">*</span> isolate_group_data<span class="token punctuation">,</span>
                        <span class="token keyword">void</span><span class="token operator">*</span> isolate_data<span class="token punctuation">,</span>
                        char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">API_TIMELINE_DURATION</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Dart_IsolateFlags</span> api_flags<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">FlagsInitialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    flags <span class="token operator">=</span> <span class="token operator">&amp;</span>api_flags<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> char<span class="token operator">*</span> non_null_name <span class="token operator">=</span> name <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string-literal"><span class="token string">&quot;isolate&quot;</span></span> <span class="token punctuation">:</span> name<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateGroupSource</span><span class="token punctuation">&gt;</span></span> <span class="token function">source</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">IsolateGroupSource</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> non_null_name<span class="token punctuation">,</span> snapshot_data<span class="token punctuation">,</span>
                             snapshot_instructions<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ›å»º Isolate Group</span>
  auto group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IsolateGroup</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> isolate_group_data<span class="token punctuation">,</span> <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ›å»º Isolate Group æŒæœ‰çš„ Heapï¼Œç”±æ‰€æœ‰åœ¨è¿™ä¸ª Isolate Group ä¸‹çš„ isolate å…±äº«</span>
  group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">CreateHeap</span><span class="token punctuation">(</span>
      <span class="token comment">/*is_vm_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">IsServiceOrKernelIsolateName</span><span class="token punctuation">(</span>non_null_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IsolateGroup</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">RegisterIsolateGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ ¹æ®åˆšåˆšåˆ›å»ºçš„ Isolate Group åˆ›å»º Isolate</span>
  <span class="token class-name">Dart_Isolate</span> isolate <span class="token operator">=</span> <span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token comment">/*is_new_group=*/</span><span class="token boolean">true</span><span class="token punctuation">,</span>
                                       non_null_name<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_initial_spawn_successful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="run-isolate-child" tabindex="-1"><a class="header-anchor" href="#run-isolate-child" aria-hidden="true">#</a> Run(Isolate* child)</h4><p>åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæ— è®ºæ˜¯<code>RunHeavyweight(const char* name)</code>è¿˜æ˜¯<code>RunLightweight(const char* name)</code>æ–¹æ³•ï¼Œæœ€ååœ¨åˆ›å»ºäº†æ–°çš„ isolate ä¹‹åï¼Œéƒ½æ‰§è¡Œäº†<code>Run(Isolate* child)</code>æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ­£å¼å¯åŠ¨äº† isolateï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\lib\\isolate.cc</span>

<span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">EnsureIsRunnable</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Dart_ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    state_<span class="token operator">-&gt;</span><span class="token function">set_isolate</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// origin_id is set to parent isolate main port id when spawning via</span>
      <span class="token comment">// spawnFunction.</span>
      child<span class="token operator">-&gt;</span><span class="token function">set_origin_id</span><span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
			<span class="token keyword">auto</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// TransitionNativeToVM is used to transition the safepoint state of a</span>
      <span class="token comment">// thread from &quot;running native code&quot; to &quot;running vm code&quot; and ensures</span>
      <span class="token comment">// that the state is reverted back to &quot;running native code&quot; when</span>
      <span class="token comment">// exiting the scope/frame.</span>
      TransitionNativeToVM <span class="token function">transition</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Create an empty zone and set is at the current zone for the Thread.</span>
      StackZone <span class="token function">zone</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// The class HandleScope is used to start a new handles scope in the</span>
      <span class="token comment">//  code.</span>
      HandleScope <span class="token function">hs</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

      success <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>EnqueueEntrypointInvocationAndNotifySpawner<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      <span class="token function">Dart_ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// All preconditions are met for this to always succeed.</span>
    <span class="token keyword">char</span><span class="token operator">*</span> error <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		<span class="token comment">// Lets the VM run message processing for the isolate.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span><span class="token operator">*</span>Dart_RunLoopAsync<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">errors_are_fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">on_error_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           state_<span class="token operator">-&gt;</span><span class="token function">on_exit_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">&quot;Dart_RunLoopAsync() failed: %s. Please file a Dart VM bug report.&quot;</span><span class="token punctuation">,</span>
            error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œåªæ˜¯åšäº†ä¸€äº›ç¯å¢ƒå‡†å¤‡ï¼Œç„¶ååœ¨<code>EnqueueEntrypointInvocationAndNotifySpawner</code>æ–¹æ³•ä¸­å°† isolate è¦è¿è¡Œçš„æ‰€æœ‰ä¸œè¥¿éƒ½å‡†å¤‡å¥½ï¼Œç„¶åå†åœ¨<code>Dart_RunLoopAsync</code>æ–¹æ³•ä¸­æ­£å¼å¼€å§‹ isolate å¤„ç† event queue.</p><p><strong>EnqueueEntrypointInvocationAndNotifySpawner</strong></p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\lib\\isolate.cc</span>

<span class="token keyword">bool</span> <span class="token function">EnqueueEntrypointInvocationAndNotifySpawner</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> isolate <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> zone <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> is_spawn_uri <span class="token operator">=</span> state_<span class="token operator">-&gt;</span><span class="token function">is_spawn_uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step 1) Resolve the entrypoint function.</span>
    <span class="token comment">// æŸ¥æ‰¾ isolate å¼€å§‹è¿è¡Œçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚ Isolate.spawn çš„ spawn æˆ–è€… Isolate.spawnUri çš„ main æ–¹æ³•</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;</span> entrypoint_closure <span class="token operator">=</span> <span class="token class-name">Closure</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">closure_tuple_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>
          zone<span class="token punctuation">,</span>
          <span class="token function">ReadObjectGraphCopyMessage</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">closure_tuple_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ReportError</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Failed to deserialize the passed entrypoint to the new isolate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      entrypoint_closure <span class="token operator">=</span> <span class="token class-name">Closure</span><span class="token double-colon punctuation">::</span><span class="token function">RawCast</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">ResolveFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>is_spawn_uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ReportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to resolve entrypoint function.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">ASSERT</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">auto</span><span class="token operator">&amp;</span> func <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Cast</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      func <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">ImplicitClosureFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      entrypoint_closure <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">ImplicitStaticClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 2) Enqueue delayed invocation of entrypoint callback.</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> args_obj <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">BuildArgs</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args_obj<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportError</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Failed to deserialize the passed arguments to the new isolate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>args_obj<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> args_obj<span class="token punctuation">.</span><span class="token function">IsInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> message_obj <span class="token operator">=</span>
        <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">BuildMessage</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message_obj<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportError</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Failed to deserialize the passed arguments to the new isolate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>message_obj<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> message_obj<span class="token punctuation">.</span><span class="token function">IsInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è§£æå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ isolate åˆå§‹è¿è¡Œæ–¹æ³•ï¼Œå‚æ•° argsã€messgaeã€æ˜¯å¦ spawn_uri</span>
    <span class="token keyword">const</span> Array<span class="token operator">&amp;</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> entrypoint_closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> message_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> is_spawn_uri <span class="token operator">?</span> <span class="token class-name">Bool</span><span class="token double-colon punctuation">::</span><span class="token function">True</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Bool</span><span class="token double-colon punctuation">::</span><span class="token function">False</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> lib <span class="token operator">=</span> <span class="token class-name">Library</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Library</span><span class="token double-colon punctuation">::</span><span class="token function">IsolateLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;_startIsolate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry_point <span class="token operator">=</span>
        <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> lib<span class="token punctuation">.</span><span class="token function">LookupLocalFunction</span><span class="token punctuation">(</span>entry_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">.</span><span class="token function">IsFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entry_point<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span>
        <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">DartEntry</span><span class="token double-colon punctuation">::</span><span class="token function">InvokeFunction</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to enqueue delayed entrypoint invocation.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 3) Pause the isolate if required &amp; Notify parent isolate about</span>
    <span class="token comment">// isolate creation.</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> capabilities <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;</span> capability <span class="token operator">=</span> <span class="token class-name">Capability</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    capability <span class="token operator">=</span> <span class="token class-name">Capability</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-&gt;</span><span class="token function">pause_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    capabilities<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    capability <span class="token operator">=</span> <span class="token class-name">Capability</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-&gt;</span><span class="token function">terminate_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    capabilities<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> send_port <span class="token operator">=</span>
        <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> message <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> send_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      capability <span class="token operator">^=</span> capabilities<span class="token punctuation">.</span><span class="token function">At</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token keyword">bool</span> added <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">AddResumeCapability</span><span class="token punctuation">(</span>capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ASSERT</span><span class="token punctuation">(</span>added<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isolate<span class="token operator">-&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">increment_paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// If parent isolate died, we ignore the fact that we cannot notify it.</span>
      <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Message å¹¶å°†å…¶å‹å…¥ Isolate çš„çˆ¶ Isolate å¯¹åº”çš„ MessageHandler çš„ event queue ä¸­</span>
      <span class="token class-name">PortMap</span><span class="token double-colon punctuation">::</span><span class="token function">PostMessage</span><span class="token punctuation">(</span><span class="token function">WriteMessage</span><span class="token punctuation">(</span><span class="token comment">/* can_send_any_object */</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                        <span class="token comment">/* same_group */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span>
                                        state_<span class="token operator">-&gt;</span><span class="token function">parent_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        Message<span class="token double-colon punctuation">::</span>kNormalPriority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œä¸»è¦åšäº† 3 ä»¶äº‹ï¼š</p><ul><li>æŸ¥æ‰¾ isolate å¼€å§‹è¿è¡Œçš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>entrypoint</code>ï¼Œæ¯”å¦‚<code>Isolate.spawn</code>çš„<code>entrypoint</code>æˆ–è€…<code>Isolate.spawnUri</code>çš„<code>main</code>æ–¹æ³•</li><li>è§£æå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ isolate åˆå§‹è¿è¡Œæ–¹æ³•ï¼Œå‚æ•°<code>args</code>ã€<code>messgae</code>ã€æ˜¯å¦<code>spawn_uri</code>ç­‰ç­‰ï¼Œå°†å…¶ä¸ä¸Šä¸€æ­¥æ‰¾åˆ°çš„<code>entrypoint</code>ç»“åˆ</li><li>ï¼ˆå¦‚æœéœ€è¦çš„è¯æš‚åœåˆ›å»ºå¥½çš„ isolateï¼‰ï¼Œå¹¶é€šçŸ¥ isolate çš„çˆ¶ isolate å½“å‰ isolate åˆ›å»ºæˆåŠŸï¼ˆé™„å¸¦å½“å‰ isolate çš„<code>send_port</code>ï¼‰</li></ul><p>è‡³æ­¤ï¼ŒIsolate çš„åˆ›å»ºå·¥ä½œå·²ç»å®Œæˆï¼Œåœ¨<code>Dart_RunLoopAsync</code>å¼€å§‹ isolate å¤„ç†æ¶ˆæ¯ï¼š</p><p><strong>Dart_RunLoopAsync</strong></p><p>åœ¨è¿™é‡Œä¸»è¦æ˜¯å¼€å§‹å¤„ç† event loopã€‚</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt;  runtime\\vm\\dart_api_impl.cc</span>

DART_EXPORT <span class="token keyword">bool</span> <span class="token function">Dart_RunLoopAsync</span><span class="token punctuation">(</span><span class="token keyword">bool</span> errors_are_fatal<span class="token punctuation">,</span>
                                   Dart_Port on_error_port<span class="token punctuation">,</span>
                                   Dart_Port on_exit_port<span class="token punctuation">,</span>
                                   <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> isolate <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_ISOLATE</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">api_top_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">StrDup</span><span class="token punctuation">(</span><span class="token string">&quot;There must not be an active api scope.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token operator">-&gt;</span><span class="token function">is_runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> error_msg <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">MakeRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error_msg <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">StrDup</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  isolate<span class="token operator">-&gt;</span><span class="token function">SetErrorsFatal</span><span class="token punctuation">(</span>errors_are_fatal<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>on_error_port <span class="token operator">!=</span> ILLEGAL_PORT <span class="token operator">||</span> on_exit_port <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TransitionNativeToVM <span class="token function">transition</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    StackZone <span class="token function">zone</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>on_error_port <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> port <span class="token operator">=</span>
          <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>on_error_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      isolate<span class="token operator">-&gt;</span><span class="token function">AddErrorListener</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>on_exit_port <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> port <span class="token operator">=</span>
          <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>on_exit_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      isolate<span class="token operator">-&gt;</span><span class="token function">AddExitListener</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token double-colon punctuation">::</span><span class="token function">null_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">Dart_ExitIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\isolate.cc</span>
<span class="token keyword">void</span> <span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> ShutdownIsolate<span class="token punctuation">,</span>
                         <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>uword<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Isolate::Run()</code>å®é™…ä¸Šæ˜¯å¼€å¯äº†å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt;</span>

<span class="token comment">// Runs this message handler on the thread pool.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Before processing messages, the optional StartFunction is run.</span>
  <span class="token comment">//</span>
  <span class="token comment">// A message handler will run until it terminates either normally or</span>
  <span class="token comment">// abnormally.  Normal termination occurs when the message handler</span>
  <span class="token comment">// no longer has any live ports.  Abnormal termination occurs when</span>
  <span class="token comment">// HandleMessage() indicates that an error has occurred during</span>
  <span class="token comment">// message processing.</span>

  <span class="token comment">// Returns false if the handler terminated abnormally, otherwise it</span>
  <span class="token comment">// returns true.</span>
<span class="token keyword">bool</span> <span class="token class-name">MessageHandler</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">,</span>
                         StartCallback start_callback<span class="token punctuation">,</span>
                         EndCallback end_callback<span class="token punctuation">,</span>
                         CallbackData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
        <span class="token string">&quot;[+] Starting message handler:\\n&quot;</span>
        <span class="token string">&quot;\\thandler:    %s\\n&quot;</span><span class="token punctuation">,</span>
        <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>pool_ <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>delete_me_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pool_ <span class="token operator">=</span> pool<span class="token punctuation">;</span>
  start_callback_ <span class="token operator">=</span> start_callback<span class="token punctuation">;</span>
  end_callback_ <span class="token operator">=</span> end_callback<span class="token punctuation">;</span>
  callback_data_ <span class="token operator">=</span> data<span class="token punctuation">;</span>
  task_running_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> result <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>pool_<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">Run</span><span class="token generic class-name"><span class="token operator">&lt;</span>MessageHandlerTask<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pool_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    start_callback_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    end_callback_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    callback_data_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\thread_pool.h</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
	<span class="token keyword">bool</span> <span class="token function">Run</span><span class="token punctuation">(</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">RunImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">T</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\thread_pool.cc</span>

<span class="token keyword">bool</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">RunImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Worker<span class="token operator">*</span> new_worker <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool_monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shutting_down_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// ä»çº¿ç¨‹æ± ä¸­è·å– taskï¼Œå¦‚æœæœ‰ç©ºé—²çš„/è¾¾åˆ°æœ€å¤§æ•°é‡å°±å°è¯•å¤ç”¨ï¼ˆæ­¤æ—¶è¿™é‡Œè¿”å› nullï¼‰</span>
		<span class="token comment">// å¦åˆ™åˆ›å»ºæ–°çš„å¹¶è¿”å›</span>
    new_worker <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>ScheduleTaskLocked<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_worker <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Worker åœ¨æ–°çš„ç³»ç»Ÿçº¿ç¨‹è¿è¡Œ task</span>
    new_worker<span class="token operator">-&gt;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">StartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ThreadPool<span class="token double-colon punctuation">::</span><span class="token class-name">Worker</span><span class="token double-colon punctuation">::</span><span class="token function">StartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼Œè¿è¡ŒæŒ‡å®šçš„ä»£ç ï¼Œ</span>
	<span class="token comment">//  android çš„å®ç°åœ¨ runtime\\vm\\os_thread_android.cc</span>
  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">OSThread</span><span class="token double-colon punctuation">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">&quot;DartWorker&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>Worker<span class="token double-colon punctuation">::</span>Main<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span>
                               <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>uword<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FATAL1</span><span class="token punctuation">(</span><span class="token string">&quot;Could not start worker thread: result = %d.&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé€šè¿‡<code>ThreadPool::ScheduleTaskLocked</code>æ–¹æ³•è·å–<code>new_worker</code>ï¼š</p><ul><li>å¦‚æœå·²æœ‰çš„ worker æœ‰ç©ºé—²çš„æˆ–è€…å·²ç»è¾¾åˆ°æœ€å¤§æ•°ç›®äº†ï¼Œå°±ç­‰å¾…å·²æœ‰çš„ worker æ‰§è¡Œä»»åŠ¡</li><li>å¦åˆ™å°±åˆ›å»ºæ–°çš„ workerï¼Œå¹¶åœ¨æ–°çš„çº¿ç¨‹è¿è¡Œ</li></ul><p>åœ¨è·å–åˆ° worker ä¹‹åï¼Œå°±æ‰§è¡Œ<code>MessageHandlerTask</code>ï¼ˆè§ä¸‹æ–‡è¯¦ç»†åˆ†æï¼‰ã€‚</p><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ 3 ç‚¹ï¼š</p><ul><li><code>ScheduleTaskLocked</code> åˆ†é… Worker</li><li><code>OSThread::Start</code>ä¸­ä½¿ç”¨<code>&amp;Worker::Main</code> åœ¨æ–°ç³»ç»Ÿçº¿ç¨‹å¼€å¯ Worker å¾ªç¯</li><li><code>MessageHandlerTask</code> æ‰§è¡Œå…·ä½“çš„æ¶ˆæ¯åˆ†å‘å†…å®¹</li></ul><h5 id="scheduletasklocked" tabindex="-1"><a class="header-anchor" href="#scheduletasklocked" aria-hidden="true">#</a> <strong>ScheduleTaskLocked</strong></h5><p>å…ˆè¯¦ç»†çœ‹ä¸€ä¸‹è·å–<code>new_worker</code>çš„<code>ThreadPool::ScheduleTaskLocked</code>æ–¹æ³•ï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\vm\\thread_pool.cc</span>

ThreadPool<span class="token double-colon punctuation">::</span>Worker<span class="token operator">*</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleTaskLocked</span><span class="token punctuation">(</span>MonitorLocker<span class="token operator">*</span> ml<span class="token punctuation">,</span>
                                                   std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Enqueue the new task.</span>
  tasks_<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pending_tasks_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>pending_tasks_ <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Notify existing idle worker (if available).</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count_idle_ <span class="token operator">&gt;=</span> pending_tasks_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>idle_workers_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ml<span class="token operator">-&gt;</span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If we have maxed out the number of threads running, we will not start a</span>
  <span class="token comment">// new one.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>max_pool_size_ <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>count_idle_ <span class="token operator">+</span> count_running_<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> max_pool_size_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>idle_workers_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ml<span class="token operator">-&gt;</span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Otherwise start a new worker.</span>
  <span class="token keyword">auto</span> new_worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Worker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  idle_workers_<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>new_worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
  count_idle_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> new_worker<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š</p><p>å°†å½“å‰ä»»åŠ¡åŠ å…¥åˆ°<code>tasks_</code>é˜Ÿåˆ—ä¸­ã€‚</p><ul><li>å¦‚æœç©ºé—²<code>count_idle_</code> çš„ Worker æ¯”ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•°<code>pending_tasks_</code>å¤šï¼Œé‚£å°±å‘é€é€šçŸ¥ï¼Œä½¿ç”¨å·²æœ‰çš„ Worker å¤„ç†ä»»åŠ¡ã€‚</li><li>å¦‚æœå½“å‰ Worker æ•°é‡å·²ç»æœ€å¤§äº†ï¼Œé‚£å°±å°†ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•° pending<em>tasks</em> åŠ ä¸€ï¼Œç­‰å¾…æœ‰ç©ºé—²çš„ Worker å¤„ç†ä»»åŠ¡ã€‚</li><li>å¦åˆ™ï¼Œå°±æ–°å»ºä¸€ä¸ª Workerï¼ˆä¼šå¯¹åº”åˆ›å»ºä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼‰æ¥å¤„ç†ä»»åŠ¡ã€‚</li></ul><h5 id="worker-main" tabindex="-1"><a class="header-anchor" href="#worker-main" aria-hidden="true">#</a> &amp;<strong>Worker::Main</strong></h5><p>åœ¨<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>è¿™é‡Œï¼ŒStartThread çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ**<code>&amp;Worker::Main</code>**å¯åŠ¨äº†ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­çš„åœ¨ä»»åŠ¡é˜Ÿåˆ—<code>tasks_</code>ä¸­å–å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\vm\\thread_pool.cc</span>

ThreadPool<span class="token double-colon punctuation">::</span><span class="token class-name">Worker</span><span class="token double-colon punctuation">::</span><span class="token function">Main</span><span class="token punctuation">(</span>uword args<span class="token punctuation">)</span><span class="token punctuation">{</span>
Worker<span class="token operator">*</span> worker <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Worker<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ThreadPool<span class="token operator">*</span> pool <span class="token operator">=</span> worker<span class="token operator">-&gt;</span>pool_<span class="token punctuation">;</span>

pool<span class="token operator">-&gt;</span><span class="token function">WorkerLoop</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">WorkerLoop</span><span class="token punctuation">(</span>Worker<span class="token operator">*</span> worker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WorkerList dead_workers_to_join<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool_monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// worker ä¼šä» task_å–å‡ºä¸€ä¸ª task å¹¶è¿è¡Œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">IdleToRunningLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>tasks_<span class="token punctuation">.</span><span class="token function">RemoveFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pending_tasks_<span class="token operator">--</span><span class="token punctuation">;</span>
        MonitorLeaveScope <span class="token function">mls</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token operator">*</span>task<span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">RunningToIdleLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>running_workers_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ASSERT</span><span class="token punctuation">(</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnEnterIdleLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>shutting_down_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ObtainDeadWorkersLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dead_workers_to_join<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">IdleToDeadLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Sleep until we get a new task, we time out or we&#39;re shutdown.</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> idle_start <span class="token operator">=</span> <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrentMonotonicMicros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span> result <span class="token operator">=</span> ml<span class="token punctuation">.</span><span class="token function">WaitMicros</span><span class="token punctuation">(</span><span class="token function">ComputeTimeout</span><span class="token punctuation">(</span>idle_start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// We have to drain all pending tasks.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>shutting_down_ <span class="token operator">||</span> result <span class="token operator">==</span> Monitor<span class="token double-colon punctuation">::</span>kTimedOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ObtainDeadWorkersLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dead_workers_to_join<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">IdleToDeadLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Before we transitioned to dead we obtained the list of previously died dead</span>
  <span class="token comment">// workers, which we join here. Since every death of a worker will join</span>
  <span class="token comment">// previously died workers, we keep the pending non-joined [dead_workers_] to</span>
  <span class="token comment">// effectively 1.</span>
  <span class="token function">JoinDeadWorkersLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dead_workers_to_join<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>MessageHandlerTask</strong></p><p>æ— è®ºæ˜¯å“ªç§ Workerï¼Œæœ€åéƒ½æ˜¯æ‰§è¡Œçš„<code>MessageHandlerTask</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\\vm\\message_handler.cc</span>

<span class="token keyword">class</span> <span class="token class-name">MessageHandlerTask</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> ThreadPool<span class="token double-colon punctuation">::</span><span class="token class-name">Task</span></span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token keyword">explicit</span> <span class="token function">MessageHandlerTask</span><span class="token punctuation">(</span>MessageHandler<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">handler_</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">ASSERT</span><span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">ASSERT</span><span class="token punctuation">(</span>handler_ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
handler_<span class="token operator">-&gt;</span><span class="token function">TaskCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">MessageHandler</span><span class="token double-colon punctuation">::</span><span class="token function">TaskCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  MessageStatus status <span class="token operator">=</span> kOK<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> run_end_callback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> delete_me <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  EndCallback end_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  CallbackData callback_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// We will occasionally release and reacquire this monitor in this</span>
    <span class="token comment">// function. Whenever we reacquire the monitor we *must* process</span>
    <span class="token comment">// all pending OOB messages, or we may miss a request for vm</span>
    <span class="token comment">// shutdown.</span>
    MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This method is running on the message handler task. Which means no</span>
    <span class="token comment">// other message handler tasks will be started until this one sets</span>
    <span class="token comment">// [task_running_] to false.</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>task_running_<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span></span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnStart</span><span class="token punctuation">(</span>kOK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_paused_on_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PausedOnStartLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// More messages may have come in before we (re)acquired the monitor.</span>
      status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnStart</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Still paused.</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// No task in queue.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PausedOnStartLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_paused_on_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnExit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Still paused.</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// No task in queue.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PausedOnExitLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(PRODUCT)</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> kOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>start_callback_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Initialize the message handler by running its start function,</span>
        <span class="token comment">// if we have one.  For an isolate, this will run the isolate&#39;s</span>
        <span class="token comment">// main() function.</span>
        <span class="token comment">//</span>
        <span class="token comment">// Release the monitor_ temporarily while we call the start callback.</span>
        ml<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token function">start_callback_</span><span class="token punctuation">(</span>callback_data_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        start_callback_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        ml<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Handle any pending messages for this message handler.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> kShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> kOK<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The isolate exits when it encounters an error or when it no</span>
    <span class="token comment">// longer has live ports.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> kOK <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">HasLivePorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span></span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnExit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_service_pause_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
              <span class="token string">&quot;Isolate %s paused before exiting. &quot;</span>
              <span class="token string">&quot;Use the Observatory to release it.\\n&quot;</span><span class="token punctuation">,</span>
              <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">PausedOnExitLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// More messages may have come in while we released the monitor.</span>
        <span class="token operator">*</span><span class="token operator">*</span>status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnExit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Still paused.</span>
          <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// No task in queue.</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">PausedOnExitLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(PRODUCT)</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> kOK <span class="token operator">&amp;&amp;</span> <span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> Error<span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sticky_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
              <span class="token string">&quot;[-] Stopping message handler (%s):\\n&quot;</span>
              <span class="token string">&quot;\\thandler:    %s\\n&quot;</span>
              <span class="token string">&quot;\\terror:    %s\\n&quot;</span><span class="token punctuation">,</span>
              <span class="token function">MessageStatusString</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">ToCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
              <span class="token string">&quot;[-] Stopping message handler (%s):\\n&quot;</span>
              <span class="token string">&quot;\\thandler:    %s\\n&quot;</span><span class="token punctuation">,</span>
              <span class="token function">MessageStatusString</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      pool_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token comment">// Decide if we have a callback before releasing the monitor.</span>
      end_callback <span class="token operator">=</span> end_callback_<span class="token punctuation">;</span>
      callback_data <span class="token operator">=</span> callback_data_<span class="token punctuation">;</span>
      run_end_callback <span class="token operator">=</span> end_callback_ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      delete_me <span class="token operator">=</span> delete_me_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Clear task_running_ last.  This allows other tasks to potentially start</span>
    <span class="token comment">// for this message handler.</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The handler may have been deleted by another thread here if it is a native</span>
  <span class="token comment">// message handler.</span>

  <span class="token comment">// Message handlers either use delete_me or end_callback but not both.</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>delete_me <span class="token operator">||</span> <span class="token operator">!</span>run_end_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>run_end_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>end_callback <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">end_callback</span><span class="token punctuation">(</span>callback_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The handler may have been deleted after this point.</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>delete_me<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ‰§è¡Œäº†<code>MessageHandler::HandleMessages</code>æ–¹æ³•ï¼Œæ¥å¤„ç†æ¶ˆæ¯ï¼š</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token comment">// -&gt; runtime\\vm\\message_handler.cc</span>

<span class="token literal-property property">MessageHandler</span><span class="token operator">:</span><span class="token operator">:</span>MessageStatus MessageHandler<span class="token operator">:</span><span class="token operator">:</span><span class="token function">HandleMessages</span><span class="token punctuation">(</span>
    <span class="token parameter">MonitorLocker<span class="token operator">*</span> ml<span class="token punctuation">,</span>
    bool allow_normal_messages<span class="token punctuation">,</span>
    bool allow_multiple_normal_messages</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">ASSERT</span><span class="token punctuation">(</span>monitor_<span class="token punctuation">.</span><span class="token function">IsOwnedByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Scheduling of the mutator thread during the isolate start can cause this</span>
  <span class="token comment">// thread to safepoint.</span>
  <span class="token comment">// We want to avoid holding the message handler monitor during the safepoint</span>
  <span class="token comment">// operation to avoid possible deadlocks, which can occur if other threads are</span>
  <span class="token comment">// sending messages to this message handler.</span>
  <span class="token comment">//</span>
  <span class="token comment">// If isolate() returns nullptr [StartIsolateScope] does nothing.</span>
  ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  StartIsolateScope <span class="token function">start_isolate</span><span class="token punctuation">(</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  auto idle_time_handler <span class="token operator">=</span>
      <span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr <span class="token operator">?</span> <span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">idle_time_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> nullptr<span class="token punctuation">;</span>

  MessageStatus max_status <span class="token operator">=</span> kOK<span class="token punctuation">;</span>
  <span class="token literal-property property">Message</span><span class="token operator">:</span><span class="token operator">:</span>Priority min_priority <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>allow_normal_messages <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority
                                            <span class="token operator">:</span> Message<span class="token operator">:</span><span class="token operator">:</span>kOOBPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> **message = DequeueMessage(min_priority);**
  while (message != nullptr) </span><span class="token punctuation">{</span>
    intptr_t message_len <span class="token operator">=</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">OS</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
          <span class="token string">&quot;[&lt;] Handling message:\\n&quot;</span>
          <span class="token string">&quot;\\tlen:        %&quot;</span> Pd
          <span class="token string">&quot;\\n&quot;</span>
          <span class="token string">&quot;\\thandler:    %s\\n&quot;</span>
          <span class="token string">&quot;\\tport:       %&quot;</span> Pd64 <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">,</span>
          message_len<span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dest_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the monitor_ temporarily while we handle the message.</span>
    <span class="token comment">// The monitor was acquired in MessageHandler::TaskCallback().</span>
    ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token literal-property property">Message</span><span class="token operator">:</span><span class="token operator">:</span>Priority saved_priority <span class="token operator">=</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Dart_Port saved_dest_port <span class="token operator">=</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dest_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MessageStatus status <span class="token operator">=</span> kOK<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
      DisableIdleTimerScope <span class="token function">disable_idle_timer</span><span class="token punctuation">(</span>idle_time_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> <span class="token function">HandleMessage</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;</span> max_status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      max_status <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">OS</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
          <span class="token string">&quot;[.] Message handled (%s):\\n&quot;</span>
          <span class="token string">&quot;\\tlen:        %&quot;</span> Pd
          <span class="token string">&quot;\\n&quot;</span>
          <span class="token string">&quot;\\thandler:    %s\\n&quot;</span>
          <span class="token string">&quot;\\tport:       %&quot;</span> Pd64 <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">,</span>
          <span class="token function">MessageStatusString</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> message_len<span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> saved_dest_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If we are shutting down, do not process any more messages.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> kShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ClearOOBQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Remember time since the last message. Don&#39;t consider OOB messages so</span>
    <span class="token comment">// using Observatory doesn&#39;t trigger additional idle tasks.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FLAG_idle_timeout_micros <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>saved_priority <span class="token operator">==</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>idle_time_handler <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idle_time_handler<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">UpdateStartIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Some callers want to process only one normal message and then quit. At</span>
    <span class="token comment">// the same time it is OK to process multiple OOB messages.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>saved_priority <span class="token operator">==</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>allow_multiple_normal_messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We processed one normal message.  Allow no more.</span>
      allow_normal_messages <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Reevaluate the minimum allowable priority.  The paused state</span>
    <span class="token comment">// may have changed as part of handling the message.  We may also</span>
    <span class="token comment">// have encountered an error during message processing.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Even if we encounter an error, we still process pending OOB</span>
    <span class="token comment">// messages so that we don&#39;t lose the message notification.</span>
    min_priority <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>max_status <span class="token operator">==</span> kOK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allow_normal_messages <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">?</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority
                        <span class="token operator">:</span> Message<span class="token operator">:</span><span class="token operator">:</span>kOOBPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    message <span class="token operator">=</span> <span class="token function">DequeueMessage</span><span class="token punctuation">(</span>min_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">
  return max_status;
}
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>MessageHandler::DequeueMessage</code>åˆ™æ˜¯æŒ‰ç…§ä¼˜å…ˆçº§ï¼Œä¾æ¬¡ä»<code>oob_queue_</code>å’Œ<code>queue_</code>ä¸­è·å–æ¶ˆæ¯ï¼š</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token comment">// -&gt; runtime\\vm\\message_handler.cc</span>

<span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> MessageHandler::DequeueMessage(
    Message::Priority min_priority) </span><span class="token punctuation">{</span>
  <span class="token comment">// TODO(turnidge): Add assert that monitor_ is held here.</span>
  <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> message = oob_queue_-&gt;Dequeue();
  if ((message == nullptr) &amp;&amp; (min_priority &lt; Message::kOOBPriority)) </span><span class="token punctuation">{</span>
    message <span class="token operator">=</span> queue_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">
  return message;
}
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äº<code>oob_queue_</code>å’Œ<code>queue_</code> çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token comment">// -&gt;</span>

<span class="token keyword">class</span> <span class="token class-name">MessageHandler</span> <span class="token punctuation">{</span>
	MessageQueue<span class="token operator">*</span> queue_<span class="token punctuation">;</span>
  MessageQueue<span class="token operator">*</span> oob_queue_<span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\\vm\\message.h</span>

<span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
	<span class="token comment">// A message processed at any interrupt point (stack overflow check) instead</span>
  <span class="token comment">// of at the top of the message loop. Control messages from dart:isolate or</span>
  <span class="token comment">// vm-service requests.</span>
  bool <span class="token function">IsOOB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> priority_ <span class="token operator">==</span> Message<span class="token operator">:</span><span class="token operator">:</span>kOOBPriority<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæ¶ˆæ¯å¤„ç†çš„æ­¥éª¤ä¹Ÿå¯åŠ¨äº†ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>Dart_RunLoopAsync</code>çš„ä¸»è¦åŠŸèƒ½æ˜¯è§¦å‘ isolate çš„<code>message_handler</code>å¤„ç†æ¶ˆæ¯åˆ†å‘ï¼š</p><p><code>Dart_RunLoopAsync</code> â†’ <code>Isolate::Run()</code> â†’ <code>message_handler()-&gt;Run()</code> â†’ <strong>pool_-&gt;</strong><code>Run&lt;MessageHandlerTask&gt;</code> <strong>â†’</strong> <code>ThreadPool::RunImpl</code></p><p>åœ¨<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>è¿™é‡Œä¸»è¦è§¦å‘äº† 2 æ­¥ï¼š</p><ul><li><code>ScheduleTaskLocked</code>è·å–åˆ°<code>new_worker</code></li><li><code>new_worker</code>è°ƒç”¨<code>ThreadPool::Worker::StartThread()</code>æ–¹æ³•å¼€å¯å¾ªç¯</li></ul><p>ç„¶åæ ¹æ®æ˜¯å¦åˆ›å»ºäº†<code>new_worker</code>æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>æœ‰<code>new_worker</code>ï¼Œä½¿ç”¨åœ¨<code>OSThread::Start</code>æ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼Œæ‰§è¡Œ<code>ThreadPool::Worker::Main</code>ï¼ˆè¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨ä½¿ç”¨<code>new_worker</code>ä»çº¿ç¨‹æ± ä¸­çš„å–å‡ºä»»åŠ¡æ‰§è¡Œï¼‰</li><li>æ²¡æœ‰<code>new_worker</code>ï¼Œé‚£ä¹ˆç­‰å¾…å·²æœ‰çš„ Worker ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡</li></ul><p>æ— è®ºå¦‚ä½•ï¼Œè¿™é‡Œçš„ Worker è¦æ‰§è¡Œçš„ä»»åŠ¡éƒ½æ˜¯åœ¨<code>MessageHandler::Run</code>æ–¹æ³•ä¸­æŒ‡å®šçš„<code>MessageHandlerTask</code> ï¼Œè€Œè¿™ä¸ªä»»åŠ¡çš„å†…å®¹ä¾¿æ˜¯å¼€å¯<code>MessageHandler::HandleMessages</code> æ–¹æ³•ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§ä¸æ–­çš„ä¾æ¬¡ä»<code>oob_queue_</code>å’Œ<code>queue_</code>ä¸­è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><figure><img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri_dart_and_native.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Isolate æ˜¯ Dart ä»£ç è¿è¡Œçš„åœ°æ–¹ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„ event loopï¼Œå’Œå…¨å±€å˜é‡ï¼Œåœ¨è‡ªå·±å•ç‹¬çš„çº¿ç¨‹è¿è¡Œã€‚</p><p>Isolate.spawn é»˜è®¤ä¼šåˆ›å»ºåœ¨åŒä¸€ä¸ª IsolateGroup ä¸­çš„ Isolateï¼Œä»–ä»¬ä¹‹é—´å…±äº« Heapï¼ˆè¿™é‡Œä¼šå‘ç”Ÿ GCï¼‰å’Œä¸€ä¸ªçº¿ç¨‹æ± ã€‚</p><p>Isolate.spawnUri ä¼šä»åˆ¶å®šçš„ Uri ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ IsolateGroup å’Œå¯¹åº”çš„ Isolateï¼Œå¹¶æ‰§è¡Œ Uri ä¸­çš„ main æ–¹æ³•ã€‚</p><p>Isolate å†…éƒ¨ç»´æŒä¸€ä¸ª Event Loopã€‚</p>`,158);function S(T,E){const a=e("ExternalLinkIcon");return o(),c("div",null,[u,r,n("p",null,[n("a",k,[s("Isolate"),t(a)]),s(", an isolated Dart execution context.")]),n("p",null,[s("All Dart code runs in an isolate, and "),d,s(". Different isolates can communicate by "),m,s(" (see "),n("a",v,[s("ReceivePort"),t(a)]),s(", "),n("a",b,[s("SendPort"),t(a)]),s(").")]),n("blockquote",null,[n("p",null,[s("In Dart an isolate has its own event loop, its own global fields, can run in parallel with other isolates and have their own live-cycle."),g,s(" â€” "),n("a",_,[s("https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375"),t(a)])])]),f,n("figure",null,[w,n("figcaption",null,[n("a",h,[s("https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel=Flutterly"),t(a)])])]),n("p",null,[n("a",y,[s("https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel=Flutterly"),t(a)])]),I])}const R=p(i,[["render",S],["__file","a951661c.html.vue"]]);export{R as default};
