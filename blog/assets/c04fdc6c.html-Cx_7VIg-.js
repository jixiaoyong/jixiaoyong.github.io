import{_ as i,c as s,o as e,a}from"./app-B5JKrna8.js";const n={},t=a(`<h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p><a href="http://jixiaoyong.github.io/blog/posts/2822c354/" target="_blank" rel="noopener noreferrer">上篇文章</a>介绍了<code>Dagger 2</code> 的基本使用，本文跟随<a href="https://google.github.io/dagger/android" target="_blank" rel="noopener noreferrer">官方文档</a>实践一下<code>Dagger 2 </code>在<code>Android</code>中的使用，可以看做是官方文档的不完全翻译。</p><p>本文有关<code>Dagger 2</code>的使用分为<code>Activity</code>和<code>Fragment</code>两部分，二者的使用几乎没有差别，最后介绍一下在 Google 官方 Demo 中学到的一个小技巧，可以将几乎所有的和<code>Dagger 2</code>的逻辑放到一份代码里面，对<code>Android</code>工程的影响极小。</p><p>首先要添加相关依赖（Kotlin 环境）：</p><div class="language-gradle line-numbers-mode" data-highlighter="shiki" data-ext="gradle" data-title="gradle" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apply plugin: &#39;kotlin-kapt&#39;//引用该插件</span></span>
<span class="line"><span>implementation &quot;com.google.dagger:dagger:$rootProject.dagger2Version&quot;</span></span>
<span class="line"><span>implementation &quot;com.google.dagger:dagger-android-support:$rootProject.dagger2Version&quot;//Android 特需</span></span>
<span class="line"><span>kapt &quot;com.google.dagger:dagger-compiler:$rootProject.dagger2Version&quot;//注意如果是 kotlin 语言，这里需要时#kapt#</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="在-activity-中的使用" tabindex="-1"><a class="header-anchor" href="#在-activity-中的使用"><span>在 Activity 中的使用</span></a></h2><h3 id="application-范围内的-component" tabindex="-1"><a class="header-anchor" href="#application-范围内的-component"><span>Application 范围内的@Component</span></a></h3><p>首先创建整个应用程序使用的<code>@Component</code>，并将<code>AndroidInjectionModule</code>加入其中，实现<code>Inject</code>注入入口：</p><div class="language-kotlin line-numbers-mode" data-highlighter="shiki" data-ext="kotlin" data-title="kotlin" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">@Component</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(modules </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [AndroidInjectionModule::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, MainActivityModule::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> AppComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(application: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">MainApplication</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AppComponent</code>的范围是整个应用程序都有效。</p><h3 id="创建单个-activity-的-subcomponent" tabindex="-1"><a class="header-anchor" href="#创建单个-activity-的-subcomponent"><span>创建单个 Activity 的@Subcomponent</span></a></h3><p>创建某个<code>Activity</code>专属的<code>@Subcomponent</code>，用于提供<code>AndroidInjector.Builder</code>。</p><div class="language-kotlin line-numbers-mode" data-highlighter="shiki" data-ext="kotlin" data-title="kotlin" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">@Subcomponent</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MainActivitySubComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">AndroidInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">MainActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    @Subcomponent.Builder</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    abstract</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Builder</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">AndroidInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Builder</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">MainActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建单个-activity-的-module" tabindex="-1"><a class="header-anchor" href="#创建单个-activity-的-module"><span>创建单个 Activity 的@Module</span></a></h3><p>创建属于整个<code>Activity</code>的<code>@Module</code>，注意这里要指明<code>@subcomponents</code>为刚刚创建的<code>MainActivitySubComponent</code>。</p><div class="language-kotlin line-numbers-mode" data-highlighter="shiki" data-ext="kotlin" data-title="kotlin" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">@Module</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(includes </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [MainActivityModule.InnerModule::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">], subcomponents </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [MainActivitySubComponent::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MainActivityModule</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    @Provides</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> bindWaitForInjectClass</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> WaitForInjectClass</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    @Module</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    abstract</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> InnerModule</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">        @Binds</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">        @IntoMap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">        @ClassKey</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(MainActivity::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        abstract</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> bindInjectorFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(builder: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">MainActivitySubComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.Builder): </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">AndroidInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.Factory</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">&lt;*&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//注意这里是 Factory&lt;*&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> WaitForInjectClass</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> //一个供依赖注入的类</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到在<code>MainActivityModule</code>中提供了一个方法利用刚刚<code>MainActivitySubComponent</code>中提供的<code>MainActivitySubComponent.Builder</code>实例生成了一个<code>AndroidInjector.Factory</code>，而这个<code>Factory</code>就是我们后面要将<code>MainActivityModule</code>中的依赖实例通过<code>AppComponent</code>传递给<code>MainActivity</code>实例的关键。</p><blockquote><p>此外还可以看到提供该 Factory 的方法是放到了另外一个抽象类里面然后再导入 MainActivityModule 中的，这是因为该方法的注解@Binds 要求方法是抽象的，而 MainActivityModule 要是需要给 Activity 提供依赖实例所必须的@Provides 又要求类不能是抽象的，否则就要求该方法是静态的。权衡之下我觉得这种方式是比较能接受的，当然也不排除有其他更优雅的解决方案，欢迎提<a href="https://github.com/jixiaoyong/jixiaoyong.github.io/issues" target="_blank" rel="noopener noreferrer">Issue</a>告知。</p></blockquote><p>然后，将<code>MainActivityModule</code>加入到应用程序的<code>@Component</code>——<code>AppComponent</code>中。</p><h3 id="使-application-继承自-hasactivityinjector" tabindex="-1"><a class="header-anchor" href="#使-application-继承自-hasactivityinjector"><span>使 Application 继承自 <a href="https://google.github.io/dagger/api/latest/dagger/android/HasActivityInjector.html" target="_blank" rel="noopener noreferrer"><code>HasActivityInjector</code></a></span></a></h3><p>使当前<code>MainApplication</code>继承自<code>HasActivityInjector</code>，该接口只有一个方法：</p><div class="language-kotlin line-numbers-mode" data-highlighter="shiki" data-ext="kotlin" data-title="kotlin" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">/** Returns an {@link AndroidInjector} of {@link Activity}s. */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">AndroidInjector</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">Activity</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> activityInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个类是用来为相应的<code>Activity</code>提供一个<code>AndroidInjector</code>。由于我们已经在<code>AppComponent</code>中包括了<code>AndroidInjectionModule</code>，所以<code>Dagger 2</code>已经可以自动为我们注入<code>DispatchingAndroidInjector</code>依赖，所以接下来的代码如下：</p><div class="language-kotlin line-numbers-mode" data-highlighter="shiki" data-ext="kotlin" data-title="kotlin" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MainApplication</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">HasActivityInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Application</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    override</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> onCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">onCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        DaggerAppComponent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    @Inject</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    lateinit</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> var</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> dispatchActivityInjector: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">DispatchingAndroidInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Activity</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    override</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> activityInjector</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> dispatchActivityInjector</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//返回 Dagger 2 为我们注入的 dispatchActivityInjector 对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>onCreate()</code>方法中传入当前<code>Application</code>的依赖。</p><h3 id="在-activity-中使用自动注入依赖" tabindex="-1"><a class="header-anchor" href="#在-activity-中使用自动注入依赖"><span>在 Activity 中使用自动注入依赖</span></a></h3><p>做完了以上所有内容，我们只需要在<code>Activity</code>中添加如下代码就可以实现自动注入：</p><div class="language-kotlin line-numbers-mode" data-highlighter="shiki" data-ext="kotlin" data-title="kotlin" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MainActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">AppCompatActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    @Inject</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    lateinit</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> var</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> waitForInjectClass: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">WaitForInjectClass</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    override</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> onCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(savedInstanceState: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Bundle</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">?) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        AndroidInjection.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//注意这里，在 super() 之前调用</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">onCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(savedInstanceState)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        setContentView</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(R.layout.activity_dagger2_x_android_main)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        Log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">d</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;TAG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;The Class is </span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;">$waitForInjectClass</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上所有代码如下，或者也可以<a href="https://gist.github.com/jixiaoyong/db7e5f18b7106ce9cb36b61bf7134340" target="_blank" rel="noopener noreferrer">在这里找到</a>：</p><h3 id="这一切是怎么实现的呢" tabindex="-1"><a class="header-anchor" href="#这一切是怎么实现的呢"><span>这一切是怎么实现的呢？</span></a></h3><p>在<code>Android</code>程序运行时，<code>AndroidInjection.inject()</code>从<code>Application</code>中的<code>activityInjector()</code>方法获取到 <code>DispatchingAndroidInjector&lt;Activity&gt;</code> ，然后将<code>Activity</code>传入<code>inject(Activity)</code>。</p><p><code>DispatchingAndroidInjector</code> 通过<code>AppComponent</code>找到我们在<code>MainActivityModule</code>提供的对应的<code>AndroidInjector.Factory</code>，然后创建了 <code>AndroidInjector</code> ——这就是我们当前<code>Activity</code>对应的<code>MainActivitySubComponent</code>。</p><p>接下来便按照之前的逻辑，从<code>MainActivitySubComponent</code>中查找提供<code>waitForInjectClass</code>的实例方法完成注入。</p><h2 id="在-fragment-中的使用" tabindex="-1"><a class="header-anchor" href="#在-fragment-中的使用"><span>在 Fragment 中的使用</span></a></h2><p><code>Dagger 2</code>在<code>Fragment</code>的使用和在<code>Activity</code>中的使用十分相似。</p><p>通过之前的代码我们可以知道，其基本的原理依旧是利用<code>@Component</code>和<code>@subcomponent</code>，<code>@Module</code>之间的关联关系将<code>Application</code>和<code>Activity</code>等的依赖注入通过<code>AndroidInjector</code>关联起来的：</p><p><code>MainActivitySubComponent</code>通过将<code>MainActivityModule</code>加入到<code>AppComponent</code>之中，然后当<code>MainActivity</code>之中需要使用到<code>MainActivitySubComponent</code>时，又通过<code>AndroidInjector</code>从<code>AppComponent</code>中拿到<code>MainActivityModule</code>中的<code>AndroidInjector.Factory</code>，通过该<code>Factory</code>和<code>MainActivitySubComponent</code>中的<code>Builder</code>产生关联，从而获取到了<code>MainActivitySubComponent</code>的实例供<code>Activity</code>使用。</p><p>在<code>Fragment</code>中我们也可以这样处理，只不过由于<code>Fragment</code>的特性，他的<code>@Module</code>不仅可以交给<code>Application</code>的<code>@Component</code>，也可以交给其他<code>Fragment</code>或者<code>Activity</code>的<code>@Component</code>，让其实现<code>HasFragmentInjector</code>即可，这取决于我们想要给<code>Fragment</code>绑定的依赖。</p><p>具体的实现一般分为下面几步：</p><ul><li><p>创建<code>Application</code>的<code>@Component</code>并添加<code>AndroidInjectionModule</code></p></li><li><p>创建实现了<code>AndroidInjector&lt;MainFragment&gt;</code>的<code>MainFragmentSubComponent</code>，其内部有方法提供<code>AndroidInjector.Builder&lt;MainFragment&gt;</code></p></li><li><p>创建包含了提供<code>AndroidInjector.Factory&lt;*&gt;</code>的抽象方法的<code>MainFragmentModule</code>，指定其<code>subcomponents</code>为<code>MainFragmentSubComponent</code>；</p></li><li><p>将<code>MainFragmentSubComponent</code>加入到想要加入的类的<code>@Component</code>中，比如<code>AppComponent</code>类</p></li><li><p>在<code>Application</code>（如果上一步是<code>Activity</code>，则本步也是<code>Activity</code>等）中参照在<code>Activity</code>实现的步骤实现<code>HasFragmentInjector</code></p><p>上述完整的代码如下，或者也可以<a href="https://gist.github.com/jixiaoyong/a24e76ca29f4c8062bf5c6a98529d252" target="_blank" rel="noopener noreferrer">在这里找到</a>：</p></li></ul><p>关于<code>Fragment</code>加入到<code>Activity</code>的 Demo 在官方文档有，这里就不再赘述了，其实只要掌握原理，其他用法的完全可以触类旁通。</p><h2 id="一个小技巧" tabindex="-1"><a class="header-anchor" href="#一个小技巧"><span>一个小技巧</span></a></h2><p>通过观察上面的两份代码，我们发现虽然这<code>Dagger 2</code>已经替我们做了好多事情，我们只需要在需要使用依赖注入的类中使用诸如<code>AndroidInjection.inject(this)</code>这样的代码就可以了，但是如果<code>Activity</code>、<code>Fragment</code>类过多的时候，这样的重复性工作仍然是个不小的工作量，万一有某处遗忘了便会导致出错。</p><p>这时就可以用到我在<a href="https://github.com/googlesamples/android-architecture-components/tree/master/GithubBrowserSample" target="_blank" rel="noopener noreferrer">Google 官方示例代码</a>中学到的一个小技巧了 (针对本文中的例子做了一些修改)，或者你也可以<a href="https://gist.github.com/jixiaoyong/9260c3ae2a70555e14f40c4b95364715" target="_blank" rel="noopener noreferrer">到这里查看源码</a>：</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h2><p><a href="https://google.github.io/dagger/android" target="_blank" rel="noopener noreferrer">Dagger 2 官方文档 Android 篇</a></p><p><a href="https://github.com/googlesamples/android-architecture-components/tree/master/GithubBrowserSample" target="_blank" rel="noopener noreferrer">Google 官方示例代码——GithubBrowserSample</a></p>`,47),l=[t];function d(o,p){return e(),s("div",null,l)}const c=i(n,[["render",d],["__file","c04fdc6c.html.vue"]]),r=JSON.parse('{"path":"/posts/c04fdc6c.html","title":"Dagger 2 ❤️ Android","lang":"zh-CN","frontmatter":{"permalink":"/posts/c04fdc6c.html","title":"Dagger 2 ❤️ Android","tag":"dagger2","abbrlink":"c04fdc6c","date":"2019-01-27T13:23:50.000Z","updated":"2023-12-30T08:17:02.000Z","isOriginal":true,"description":"前言 上篇文章介绍了Dagger 2 的基本使用，本文跟随官方文档实践一下Dagger 2 在Android中的使用，可以看做是官方文档的不完全翻译。 本文有关Dagger 2的使用分为Activity和Fragment两部分，二者的使用几乎没有差别，最后介绍一下在 Google 官方 Demo 中学到的一个小技巧，可以将几乎所有的和Dagger 2的...","head":[["meta",{"property":"og:url","content":"https://jixiaoyong.github.io/blog/posts/c04fdc6c.html"}],["meta",{"property":"og:site_name","content":"JI,XIAOYONG"}],["meta",{"property":"og:title","content":"Dagger 2 ❤️ Android"}],["meta",{"property":"og:description","content":"前言 上篇文章介绍了Dagger 2 的基本使用，本文跟随官方文档实践一下Dagger 2 在Android中的使用，可以看做是官方文档的不完全翻译。 本文有关Dagger 2的使用分为Activity和Fragment两部分，二者的使用几乎没有差别，最后介绍一下在 Google 官方 Demo 中学到的一个小技巧，可以将几乎所有的和Dagger 2的..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-31T16:00:22.000Z"}],["meta",{"property":"article:author","content":"JI,XIAOYONG"}],["meta",{"property":"article:tag","content":"dagger2"}],["meta",{"property":"article:published_time","content":"2019-01-27T13:23:50.000Z"}],["meta",{"property":"article:modified_time","content":"2024-05-31T16:00:22.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Dagger 2 ❤️ Android\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2019-01-27T13:23:50.000Z\\",\\"dateModified\\":\\"2024-05-31T16:00:22.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"JI,XIAOYONG\\",\\"url\\":\\"https://jixiaoyong.github.io\\"}]}"]]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"在 Activity 中的使用","slug":"在-activity-中的使用","link":"#在-activity-中的使用","children":[{"level":3,"title":"Application 范围内的@Component","slug":"application-范围内的-component","link":"#application-范围内的-component","children":[]},{"level":3,"title":"创建单个 Activity 的@Subcomponent","slug":"创建单个-activity-的-subcomponent","link":"#创建单个-activity-的-subcomponent","children":[]},{"level":3,"title":"创建单个 Activity 的@Module","slug":"创建单个-activity-的-module","link":"#创建单个-activity-的-module","children":[]},{"level":3,"title":"使 Application 继承自 HasActivityInjector","slug":"使-application-继承自-hasactivityinjector","link":"#使-application-继承自-hasactivityinjector","children":[]},{"level":3,"title":"在 Activity 中使用自动注入依赖","slug":"在-activity-中使用自动注入依赖","link":"#在-activity-中使用自动注入依赖","children":[]},{"level":3,"title":"这一切是怎么实现的呢？","slug":"这一切是怎么实现的呢","link":"#这一切是怎么实现的呢","children":[]}]},{"level":2,"title":"在 Fragment 中的使用","slug":"在-fragment-中的使用","link":"#在-fragment-中的使用","children":[]},{"level":2,"title":"一个小技巧","slug":"一个小技巧","link":"#一个小技巧","children":[]},{"level":2,"title":"参考资料","slug":"参考资料","link":"#参考资料","children":[]}],"git":{"createdTime":1653726847000,"updatedTime":1717171222000,"contributors":[{"name":"jixiaoyong","email":"jixiaoyong1995@gmail.com","commits":3},{"name":"JI,XIAOYONG","email":"jixiaoyong1995@gmail.com","commits":1}]},"readingTime":{"minutes":5.17,"words":1551},"filePathRelative":"_posts/Dagger2在Android上的应用.md","localizedDate":"2019年1月27日","excerpt":"<h2>前言</h2>\\n<p><a href=\\"http://jixiaoyong.github.io/blog/posts/2822c354/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">上篇文章</a>介绍了<code>Dagger 2</code> 的基本使用，本文跟随<a href=\\"https://google.github.io/dagger/android\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">官方文档</a>实践一下<code>Dagger 2 </code>在<code>Android</code>中的使用，可以看做是官方文档的不完全翻译。</p>","autoDesc":true}');export{c as comp,r as data};
