import{_ as s,c as a,a as n,o as e}from"./app-DQAvLgyB.js";const l={};function t(p,i){return e(),a("div",null,i[0]||(i[0]=[n(`<p>当 APP 的 minSdkVersion 低于 Android 5 时，在方法数大于 65536 时，需要将 APP 打包为多个 DEX 文件，此时需要添加 MultiDex 依赖。</p><p>官方方法如下：</p><p>1.<code>build.gradle</code></p><div class="language-groovy line-numbers-mode" data-highlighter="shiki" data-ext="groovy" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">android {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    defaultConfig {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        minSdkVersion </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">15</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        targetSdkVersion </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">28</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        multiDexEnabled </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">dependencies {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  compile </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;com.android.support:multidex:1.0.3&#39;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.<code>MyApplication</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">方式❶：</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyApplication</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MultiDexApplication</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ...</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">方式❷：</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyApplication</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SomeOtherApplication</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> attachBaseContext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Context</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> base</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">attachBaseContext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(base);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     MultiDex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">install</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，为了避免一些启动期间需要的任何类未在主 DEX 文件中提供而导致<code>java.lang.NoClassDefFoundError</code>，还需要告诉 AS 将这些类添加到主 DEX 文件中：</p><p>3.<code>build.gradle</code></p><div class="language-groovy line-numbers-mode" data-highlighter="shiki" data-ext="groovy" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">android {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    buildTypes {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        release {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            ❶ multiDexKeepFile </span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;multidex-config.txt&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            ❷ </span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">multiDexKeepProguard</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;multidex-config.pro&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//multidex-config.txt</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">com</span><span style="--shiki-light:#0184BC;--shiki-dark:#E06C75;">/example/</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">MyClass</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.class</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">com</span><span style="--shiki-light:#0184BC;--shiki-dark:#E06C75;">/example/</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">MyOtherClass</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.class</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//multidex-config.pro</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">keep </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.example.MyClass</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-keep </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.example.MyClassToo</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-keep </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.example.** { </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; } </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// All classes in the com.example package</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是在实际运行中，Android 4.x 的系统会在 APP 安装后第一次启动时，在<code>MultiDex.install(this)</code>方法中进行 DEX 文件合并优化等耗时操作（主线程），往往会持续数十秒以上，从而导致 APP 第一次启动时长时间白屏，十分影响体验。</p><p>查阅相应的资料后大体有以下几种方案</p><ol><li><p>设置主 Activity 的背景为透明色</p><p>这样当用户点击 APP 图标启动 APP 时，在主 Activity 启动之前看到的一直是桌面的样子而非白屏，但这只是一种障眼法，用户可能会以为系统卡顿，体验并不好。</p></li><li><p>在 Application 中检测到是第一次启动的话，新开一个进程并在其中进行<code>MultiDex.install(this)</code></p><p>这种方法在主进程启动时，检测到尚未进行 MultidexOpt，则阻塞当前进程，新开一个进程，在其中加载一个 Activity，并在后台进程运行<code>MultiDex.install(this)</code>，当 MultidexOpt 完成后再关闭当前进程，返回主进程继续正常开启 APP。</p><p>由于主进程被阻塞的同时成为了后台进程，所以也不会触发 ANR，此外子进程中的过渡 Activity 也只用到了基本的类，所以基本不用担心会触发<code>java.lang.NoClassDefFoundError</code>，而且过渡 Activity 可以展示进度、提示等用户友好的页面，相对来说体验也好了很多。</p></li></ol><p>但是这种方法从子进程返回主进程涉及到进程间通信，以及主进程的主 Activity 启动时生命周期会出现异常 (异常 (<code>onCreate()</code> -&gt; <code>onStart()</code> -&gt; <code>onResume()</code> -&gt; <code>onPause()</code>-&gt;<code>onResume()</code>)，仍然不是很好的解决方法。</p><p>结合上述的分析后，可以看到这种问题的优化思路主要在于如何在避免<code>java.lang.NoClassDefFoundError</code>的同时，在后台可靠的通过<code>MultiDex.install(this)</code>执行 MultidexOpt 操作。</p><p>通过以上方案 1 和 2 的结合，可以有一个比较完美的解决方案：</p><ol><li>方案 2 中在过渡 Activity 的后台线程进行 MultidexOpt 操作思路是正确的，但是不需要再单独开一个进程，我们完全可以将其当做主进程的第一个 Activity，等待 MultidexOpt 操作完成后再跳转到主 Activity 并 finish 掉本 Activity，这样主 Activity 的生命周期也不会受影响。</li><li>这种情况下在部分低端机上，过渡 Activity 到主 Activity 跳转时会出现短暂黑屏，我们可以在过渡页面将 Activity 切换动画设置为渐变效果，并将主 Activity 背景设置为透明，待主 Activity 完全加载好后再将背景切换为普通模式。</li></ol><p>综上处理，我们的 Application 无需改动，甚至主 Activity 也可以不做改动，只需要添加一个过渡页面为启动 Activity，在其中后台进行 MultidexOpt，等 DEX 文件处理完毕后再加载主 Activity。对项目改动少并且逻辑较为简单。</p><p>注：</p><ol><li>MultiDexOpt 即执行<code>MultiDex.install(getApplication());</code>方法；</li><li>需要注意过渡 Activity 尽量少的使用类，并且要确保过渡 Activity 可能会调用到的类加载到了主 dex 文件中。</li></ol><h2 id="参考文档" tabindex="-1"><a class="header-anchor" href="#参考文档"><span>参考文档</span></a></h2><p><a href="https://developer.android.google.cn/studio/build/multidex.html?hl=zh-CN" target="_blank" rel="noopener noreferrer">配置方法数超过 64K 的应用</a></p><p><a href="https://www.jianshu.com/p/c2d7b76ff063" target="_blank" rel="noopener noreferrer">Android MultiDex 初次启动 APP 优化方案优雅的实现</a></p><p><a href="https://www.zybuluo.com/946898963/note/1219741" target="_blank" rel="noopener noreferrer">MultiDex 深入学习</a></p>`,23)]))}const d=s(l,[["render",t]]),k=JSON.parse(`{"path":"/posts/caa169b7.html","title":"Android 5.x 以下加载 MultiDex 白屏的处理优化","lang":"zh-CN","frontmatter":{"permalink":"/posts/caa169b7.html","title":"Android 5.x 以下加载 MultiDex 白屏的处理优化","tag":"android","abbrlink":"caa169b7","date":"2019-08-10T03:39:00.000Z","updated":"2023-12-30T08:17:02.000Z","isOriginal":true,"description":"当 APP 的 minSdkVersion 低于 Android 5 时，在方法数大于 65536 时，需要将 APP 打包为多个 DEX 文件，此时需要添加 MultiDex 依赖。 官方方法如下： 1.build.gradle 2.MyApplication 此外，为了避免一些启动期间需要的任何类未在主 DEX 文件中提供而导致java.lang....","head":[["meta",{"property":"og:url","content":"https://jixiaoyong.github.io/blog/posts/caa169b7.html"}],["meta",{"property":"og:site_name","content":"JI,XIAOYONG"}],["meta",{"property":"og:title","content":"Android 5.x 以下加载 MultiDex 白屏的处理优化"}],["meta",{"property":"og:description","content":"当 APP 的 minSdkVersion 低于 Android 5 时，在方法数大于 65536 时，需要将 APP 打包为多个 DEX 文件，此时需要添加 MultiDex 依赖。 官方方法如下： 1.build.gradle 2.MyApplication 此外，为了避免一些启动期间需要的任何类未在主 DEX 文件中提供而导致java.lang...."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-31T16:00:22.000Z"}],["meta",{"property":"article:tag","content":"android"}],["meta",{"property":"article:published_time","content":"2019-08-10T03:39:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-05-31T16:00:22.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Android 5.x 以下加载 MultiDex 白屏的处理优化\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2019-08-10T03:39:00.000Z\\",\\"dateModified\\":\\"2024-05-31T16:00:22.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"JI,XIAOYONG\\",\\"url\\":\\"https://jixiaoyong.github.io\\"}]}"]]},"git":{"createdTime":1653726847000,"updatedTime":1717171222000,"contributors":[{"name":"jixiaoyong","username":"jixiaoyong","email":"jixiaoyong1995@gmail.com","commits":5,"url":"https://github.com/jixiaoyong"},{"name":"JI,XIAOYONG","username":"","email":"jixiaoyong1995@gmail.com","commits":1}]},"readingTime":{"minutes":3.5,"words":1051},"filePathRelative":"_posts/AndroidMultiDexOpt.md","localizedDate":"2019年8月10日","excerpt":"<p>当 APP 的 minSdkVersion 低于 Android 5 时，在方法数大于 65536 时，需要将 APP 打包为多个 DEX 文件，此时需要添加 MultiDex 依赖。</p>\\n<p>官方方法如下：</p>\\n<p>1.<code>build.gradle</code></p>\\n<div class=\\"language-groovy line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"groovy\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">android {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    defaultConfig {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">        ...</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">        minSdkVersion </span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\">15</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">        targetSdkVersion </span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\">28</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">        multiDexEnabled </span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\">true</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    }</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    ...</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">dependencies {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">  compile </span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">'com.android.support:multidex:1.0.3'</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">}</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}`);export{d as comp,k as data};
