import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as c,o,c as l,a as n,b as s,d as e,e as t}from"./app-67ad359b.js";const i={},d=t(`<blockquote><p>本文基于 Flutter 3.0</p></blockquote><p>Flutter App 基于 Dart 语言编写，提供了一套简单易用的 API，可以让开发者在 Flutter 中快速开发出一个精美的 APP。那么在 Flutter 中是如何绘制一个 APP 呢，runApp 是怎么将我们编写的 Widget 等添加到手机上的呢？本文简单从 Widget,Element,RenderObjet 三者的关系来梳理一下 Flutter 的绘制过程。</p><p>让我们运行一个“最”简单的 Flutter App，分析一下在这个过程中涉及到的 Widget、Element、RenderObject 这三个 tree 的关系。</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
    <span class="token comment">// Center 非必须，为了让文本居中显得更清晰</span>
    child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>
      <span class="token string-literal"><span class="token string">&quot;Hello center text!&quot;</span></span><span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span> <span class="token comment">// 文本方向</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码的效果如下：</p><figure><img src="https://jixiaoyong.github.io/images/flutter_run_app/flutter_run_app_hello_center_text.png" alt="flutter_run_app_hello_center_text" tabindex="0" loading="lazy"><figcaption>flutter_run_app_hello_center_text</figcaption></figure><p>让我们使用 Flutter DevTools 看一下实际生成的 Widget Details Tree</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[root]
 &gt;renderObject:RenderView#a00a5

 Center
  alignment:Alignment.center
  widthFactor:null
  heightFactor:null
  &gt;renderObject:RenderPositionedBox#94e0d

  Text
   &quot;Hello center text!&quot;
   textAlign:null
   textDirection:ltr
   locale:null
   softWrap:null
   overflow:null
   textScaleFactor:null
   maxLines:null
   textWidthBasis:null
   textHeightBehavior:null

   RichText
    textDirection:ltr
    softWrap:wrapping at box width
    maxLines:unlimited
    text:&quot;Hello center text!&quot;
    renderObject:RenderParagraph#71aa1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，除了我们在代码里面添加的 Center 和 Text 这两个 Widget 之外，还多出来好几个 Widget/RenderObject，当我们仔细查看具体的 Widget，可以看到其内部还有 XXXElement，BuildOwner 之类的字段：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Center
 alignment:Alignment.center
 widthFactor:null
 heightFactor:null
 renderObject:RenderPositionedBox#94e0d
 &gt;_parent:RenderObjectToWidgetElement
 _debugReassembleConfig:null
 _notificationTree:null
 &gt;_slot:Object
 _depth:2
 &gt;_widget:Center
 &gt;_owner:BuildOwner
 &gt;_lifecycleState:_ElementLifecycle
 &gt;_debugForgottenChildrenWithGlobalKey:_HashSet
 _inheritedWidgets:null
 _dependencies:null
 _hadUnsatisfiedDependencies:true
 _dirty:false
 _inDirtyList:false
 _debugBuiltOnce:false
 _debugA1lowIgnoredCallsToMarkNeedsBuild:false
 _debugDoingBuild:false
 &gt;_ancestorRenderObjectElement:RenderObjectToWidgetElement
 &gt;_child:StatelessElement

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述涉及到的几个类彼此之间到底是什么关系，我们的“<code>Hello center text!</code>”又是怎样才显示到屏幕上的，让我们接下来一个一个分析一下：</p><h1 id="runapp" tabindex="-1"><a class="header-anchor" href="#runapp" aria-hidden="true">#</a> runApp</h1><p>在执行 runApp 的时候主要执行了三步</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; \\lib\\src\\widgets\\binding.dart</span>

<span class="token keyword">void</span> <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token class-name">Widget</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 创建 render tree 的根节点 RenderView</span>
  <span class="token class-name">WidgetsFlutterBinding</span><span class="token punctuation">.</span><span class="token function">ensureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 将我们的 app widget 绑定到 RenderView</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">scheduleAttachRootWidget</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
		<span class="token comment">// 安排屏幕帧绘制</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">scheduleWarmUpFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="widgetsflutterbinding-ensureinitialized" tabindex="-1"><a class="header-anchor" href="#widgetsflutterbinding-ensureinitialized" aria-hidden="true">#</a> WidgetsFlutterBinding.ensureInitialized()</h2><p>创建 RenderView 具体的逻辑在<code>WidgetsFlutterBinding.ensureInitialized</code>方法中：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; \\lib\\src\\widgets\\binding.dart</span>

<span class="token keyword">class</span> <span class="token class-name">WidgetsFlutterBinding</span> <span class="token keyword">extends</span> <span class="token class-name">BindingBase</span> <span class="token keyword">with</span> <span class="token class-name">GestureBinding</span><span class="token punctuation">,</span> <span class="token class-name">SchedulerBinding</span><span class="token punctuation">,</span> <span class="token class-name">ServicesBinding</span><span class="token punctuation">,</span> <span class="token class-name">PaintingBinding</span><span class="token punctuation">,</span> <span class="token class-name">SemanticsBinding</span><span class="token punctuation">,</span> <span class="token class-name">RendererBinding</span><span class="token punctuation">,</span> <span class="token class-name">WidgetsBinding</span> <span class="token punctuation">{</span>

	<span class="token keyword">static</span> <span class="token class-name">WidgetsBinding</span> <span class="token function">ensureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">WidgetsBinding</span><span class="token punctuation">.</span>_instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token class-name">WidgetsFlutterBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">WidgetsBinding</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>ensureInitialized</code>方法中，如果<code>WidgetsBinding._instance</code>为 null 则会先用构造方法创建，因为<code>WidgetsFlutterBinding</code>继承自 BindingBase，所以实际上执行下方的方法：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\foundation\\binding.dart</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BindingBase</span> <span class="token punctuation">{</span>
	<span class="token class-name">BindingBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initServiceExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token metadata function">@protected</span>
  <span class="token metadata function">@mustCallSuper</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里主要做了 2 件事，我们关注<code>initInstances()</code>方法，这个方法的主要逻辑都在他的子类中，也就是之前<code>WidgetsFlutterBinding</code>混合的几个 BindingBase 子类中，我们关注和屏幕渲染有关的 RendererBinding：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\rendering\\binding.dart</span>

<span class="token comment">/// The glue between the render tree and the Flutter engine.</span>
<span class="token keyword">mixin</span> <span class="token class-name">RendererBinding</span> <span class="token keyword">on</span> <span class="token class-name">BindingBase</span><span class="token punctuation">,</span> <span class="token class-name">ServicesBinding</span><span class="token punctuation">,</span> <span class="token class-name">SchedulerBinding</span><span class="token punctuation">,</span> <span class="token class-name">GestureBinding</span><span class="token punctuation">,</span> <span class="token class-name">SemanticsBinding</span><span class="token punctuation">,</span> <span class="token class-name">HitTestable</span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里创建了 PipelineOwner，用来管理 rendering pipeline 也就是我们 app 中所有的 RenderObject</span>
    _pipelineOwner <span class="token operator">=</span> <span class="token class-name">PipelineOwner</span><span class="token punctuation">(</span>
      onNeedVisualUpdate<span class="token punctuation">:</span> ensureVisualUpdate<span class="token punctuation">,</span>
      onSemanticsOwnerCreated<span class="token punctuation">:</span> _handleSemanticsOwnerCreated<span class="token punctuation">,</span>
      onSemanticsOwnerDisposed<span class="token punctuation">:</span> _handleSemanticsOwnerDisposed<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    platformDispatcher
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onMetricsChanged <span class="token operator">=</span> handleMetricsChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onTextScaleFactorChanged <span class="token operator">=</span> handleTextScaleFactorChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onPlatformBrightnessChanged <span class="token operator">=</span> handlePlatformBrightnessChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onSemanticsEnabledChanged <span class="token operator">=</span> _handleSemanticsEnabledChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onSemanticsAction <span class="token operator">=</span> _handleSemanticsAction<span class="token punctuation">;</span>
    <span class="token comment">// 注意这里创建了 RenderView</span>
    <span class="token function">initRenderView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_handleSemanticsEnabledChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>renderView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addPersistentFrameCallback</span><span class="token punctuation">(</span>_handlePersistentFrameCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initMouseTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kIsWeb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addPostFrameCallback</span><span class="token punctuation">(</span>_handleWebFirstFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Creates a [RenderView] object to be the root of the</span>
  <span class="token comment">/// [RenderObject] rendering tree, and initializes it so that it</span>
  <span class="token comment">/// will be rendered when the next frame is requested.</span>
  <span class="token comment">///</span>
  <span class="token comment">/// Called automatically when the binding is created.</span>
  <span class="token keyword">void</span> <span class="token function">initRenderView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderView <span class="token operator">=</span> <span class="token class-name">RenderView</span><span class="token punctuation">(</span>configuration<span class="token punctuation">:</span> <span class="token function">createViewConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window<span class="token punctuation">:</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderView<span class="token punctuation">.</span><span class="token function">prepareInitialFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">set</span> <span class="token function">renderView</span><span class="token punctuation">(</span><span class="token class-name">RenderView</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意这里，将 renderView 设置为_pipeline 的根节点</span>
    _pipelineOwner<span class="token punctuation">.</span>rootNode <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们主要关注两件事：</p><ul><li><p>创建了用于管理渲染管道的 PipelineOwner <code>_pipelineOwner</code></p><p>Pipeline 是用来管理 rendering tree，其内部持有我们的 renderView 作为 rootNode，同时维护了_nodesNeedingLayout，_nodesNeedingCompositingBitsUpdate，_nodesNeedingPaint，_nodesNeedingSemantics 四个列表，当 flutter framework 每次需要往屏幕上绘制内容时会依次遍历这四个列表，将 RenderObject 绘制到屏幕上面。</p></li><li><p>创建了 rendering tree 的根节点<code>renderView</code> ，并将其设置为<code>_pipelineOwner</code>的根节点</p></li></ul><h2 id="scheduleattachrootwidget-app" tabindex="-1"><a class="header-anchor" href="#scheduleattachrootwidget-app" aria-hidden="true">#</a> ..scheduleAttachRootWidget(app)</h2><p>此方法是<code>WidgetsFlutterBinding</code>的另外一个混合类<code>WidgetsBinding</code>负责具体实现：</p><p><code>WidgetsBinding</code>的<code>scheduleAttachRootWidget</code> 方法最后调用了<code>attachRootWidget(Widget rootWidget)</code> ：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\binding.dart</span>

<span class="token comment">/// The glue between the widgets layer and the Flutter engine.</span>
<span class="token keyword">mixin</span> <span class="token class-name">WidgetsBinding</span> <span class="token keyword">on</span> <span class="token class-name">BindingBase</span><span class="token punctuation">,</span> <span class="token class-name">ServicesBinding</span><span class="token punctuation">,</span> <span class="token class-name">SchedulerBinding</span><span class="token punctuation">,</span> <span class="token class-name">GestureBinding</span><span class="token punctuation">,</span> <span class="token class-name">RendererBinding</span><span class="token punctuation">,</span> <span class="token class-name">SemanticsBinding</span> <span class="token punctuation">{</span>

 <span class="token comment">// 将 rootWidget 绑定到 renderViewElement</span>
 <span class="token keyword">void</span> <span class="token function">attachRootWidget</span><span class="token punctuation">(</span><span class="token class-name">Widget</span> rootWidget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> bool isBootstrapFrame <span class="token operator">=</span> renderViewElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _readyToProduceFrames <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于将 rootWidget 绑定到 renderView 上面</span>
    _renderViewElement <span class="token operator">=</span> <span class="token class-name">RenderObjectToWidgetAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderBox</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      container<span class="token punctuation">:</span> renderView<span class="token punctuation">,</span>
      debugShortDescription<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&#39;[root]&#39;</span></span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> rootWidget<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
   <span class="token comment">// 在此创建或者使用已有的 RenderObjectToWidgetElement，并作为根 Element</span>
   <span class="token comment">// 并将 RenderObjectToWidgetAdapter 和 RenderView 与之绑定</span>
   <span class="token comment">// 这里的_buildOwner 在 WidgetsBinding.initInstances 方法创建，用于管理 widget 框架的类</span>
   <span class="token punctuation">.</span><span class="token function">attachToRenderTree</span><span class="token punctuation">(</span>buildOwner<span class="token operator">!</span><span class="token punctuation">,</span> renderViewElement <span class="token operator">as</span> <span class="token class-name">RenderObjectToWidgetElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderBox</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBootstrapFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是启动框架，就安排更新帧</span>
      <span class="token class-name">SchedulerBinding</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">ensureVisualUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里主要有 3 步：</p><ul><li>创建 RenderObjectToWidgetAdapter 包装 RenderView</li><li>在<code>attachToRenderTree</code>方法中创建 RenderObjectToWidgetElement 并<code>mount</code>到 element tree 中（widget tree 实际上并不存在，而是通过 element tree 管理）</li><li>需要的话安排一次 frame（刷新页面）</li></ul><p>还需要注意一个新的角色<code>buildOwner</code>，这个对象全局唯一（一般由 parent 传给 child），在<code>WidgetsBinding.initInstances</code>方法创建，用来管理与 Widget tree 相关的类，实际上就是通过管理 Element 的插入，移除，更新来间接管理 Widget tree（对应我们在之前遇到的用来管理 rendering tree 的<code>pipelineOwner</code> ，这两个 Owner 管理着我们所说的 Flutter 的 Widget/Element/RenderObject“三”个 tree）。</p><h3 id="renderobjecttowidgetadapter" tabindex="-1"><a class="header-anchor" href="#renderobjecttowidgetadapter" aria-hidden="true">#</a> RenderObjectToWidgetAdapter</h3><p>前面我们知道<code>renderView</code>其实是一个 RenderObject，所以这里为他创建了一个对应的 Widget——<code>RenderObjectToWidgetAdapter</code>，其主要作用是将<code>rootWidget</code>（也就是我们最开始写的 Center Widget 及其 child）绑定到之前生成的<code>renderView</code>上面，并将<code>renderView</code>作为自己对应的 RenderObject。</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\binding.dart</span>

<span class="token keyword">class</span> <span class="token class-name">RenderObjectToWidgetAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObject</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">RenderObjectWidget</span> <span class="token punctuation">{</span>
  <span class="token comment">/// Creates a bridge from a [RenderObject] to an [Element] tree.</span>
  <span class="token comment">///</span>
  <span class="token comment">/// Used by [WidgetsBinding] to attach the root widget to the [RenderView].</span>
  <span class="token class-name">RenderObjectToWidgetAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>debugShortDescription<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
   <span class="token comment">// 注意这里用 container 也就是 RenderView 创建了一个 GlobalObjectKey，</span>
   <span class="token comment">// 在 RenderObjectToWidgetElementmount 的时候会用到</span>
   <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token class-name">GlobalObjectKey</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token metadata function">@override</span>
  <span class="token class-name">RenderObjectToWidgetElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RenderObjectToWidgetElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">RenderObjectWithChildMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> container<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>RenderObjectToWidgetAdapter.createRenderObject</code> 返回的就是<code>container</code> 也就是我们的 RenderView。</p><h3 id="attachtorendertree" tabindex="-1"><a class="header-anchor" href="#attachtorendertree" aria-hidden="true">#</a> attachToRenderTree</h3><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\binding.dart</span>
<span class="token keyword">class</span> <span class="token class-name">RenderObjectToWidgetAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObject</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">RenderObjectWidget</span> <span class="token punctuation">{</span>
  <span class="token class-name">RenderObjectToWidgetElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">attachToRenderTree</span><span class="token punctuation">(</span><span class="token class-name">BuildOwner</span> owner<span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token class-name">RenderObjectToWidgetElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> element <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      owner<span class="token punctuation">.</span><span class="token function">lockState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 RenderObjectToWidgetElement，并将 RenderObjectToWidgetAdapter 与之绑定</span>
        element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>element <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建好 Element 之后，将 BuildOwner 与之绑定</span>
        element<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">assignOwner</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      owner<span class="token punctuation">.</span><span class="token function">buildScope</span><span class="token punctuation">(</span>element<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里最终会通过 updateChild 方法将 rootWidget 对应的 Element 插入到</span>
        <span class="token comment">// RenderObjectToWidgetElement 下面，在 rootWidget 中第一个 RenderObjectElement</span>
        <span class="token comment">// 的 mount 方法中，通过 attachRenderObject(newSlot) 将自己的 renderObject 绑定到 renderView</span>
        element<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      element<span class="token punctuation">.</span>_newWidget <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      element<span class="token punctuation">.</span><span class="token function">markNeedsBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> element<span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>RenderObjectToWidgetAdapter</code>在<code>attachToRenderTree</code> 方法中，创建对应的<code>RenderObjectToWidgetElement</code> 与自己绑定，并且同时也将<code>rootWidget</code>和之前创建的 rendering tree 的根节点<code>renderView</code>绑定。</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token operator">|</span>— <span class="token class-name">RenderObjectToWidgetAdapter</span>   —<span class="token operator">|</span>— <span class="token class-name">RenderObjectToWidgetElement</span>  —<span class="token operator">|</span>— <span class="token class-name">RenderView</span> —<span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>我们再来看一下<code>RenderObjectToWidgetElement</code>调用的父类<code>RenderObjectElement.mount</code>方法：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RenderObjectElement</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token operator">?</span> parent<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 本例中这里实际上获取到的是 RenderView</span>
    _renderObject <span class="token operator">=</span> <span class="token punctuation">(</span>widget <span class="token operator">as</span> <span class="token class-name">RenderObjectWidget</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 RenderView 绑定到指定 newSlot(这里是 null) 中</span>
    <span class="token function">attachRenderObject</span><span class="token punctuation">(</span>newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">attachRenderObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_ancestorRenderObjectElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _slot <span class="token operator">=</span> newSlot<span class="token punctuation">;</span>
    <span class="token comment">// 这里因为 RenderView 是根节点，所以_ancestorRenderObjectElement 和 parentDataElement 都为 null</span>
    <span class="token comment">// 但是对于 RenderView 下级的节点，比如本例中的 Center Widget，他对应的祖先节点就是持有 RenderView</span>
    <span class="token comment">// 的 RenderObjectToWidgetElement，所以这里会将 CenterWidget 的 RenderPositionedBox</span>
    <span class="token comment">// 作为 RenderView 的 child</span>
    _ancestorRenderObjectElement <span class="token operator">=</span> <span class="token function">_findAncestorRenderObjectElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _ancestorRenderObjectElement<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">insertRenderObjectChild</span><span class="token punctuation">(</span>renderObject<span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ParentDataElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParentData</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> parentDataElement <span class="token operator">=</span> <span class="token function">_findAncestorParentDataElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentDataElement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token function">_updateParentData</span><span class="token punctuation">(</span>parentDataElement<span class="token punctuation">.</span>widget <span class="token operator">as</span> <span class="token class-name">ParentDataWidget</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParentData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，还会调用的<code>Element.mount</code>方法：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token comment">// Element 的方法：</span>

   <span class="token keyword">void</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token operator">?</span> parent<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    _slot <span class="token operator">=</span> newSlot<span class="token punctuation">;</span>
    _lifecycleState <span class="token operator">=</span> _ElementLifecycle<span class="token punctuation">.</span>active<span class="token punctuation">;</span>
    _depth <span class="token operator">=</span> _parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> _parent<span class="token operator">!</span><span class="token punctuation">.</span>depth <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Only assign ownership if the parent is non-null. If parent is null</span>
      <span class="token comment">// (the root node), the owner should have already been assigned.</span>
      <span class="token comment">// See RootRenderObjectElement.assignOwner().</span>
      _owner <span class="token operator">=</span> parent<span class="token punctuation">.</span>owner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里将 RenderObjectToWidgetElement 注册到 owner 中，key 是创建 RenderObjectToWidgetAdapter 时候创建的 GlobalObjectKey</span>
    <span class="token keyword">final</span> <span class="token class-name">Key</span><span class="token operator">?</span> key <span class="token operator">=</span> widget<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">is</span> <span class="token class-name">GlobalKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      owner<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">_registerGlobalKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">_updateInheritance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">attachNotificationTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，这里将<code>RenderObjectToWidgetElement</code> 注册到了 BuildOwner 中</p><p>在<code>RenderObjectToWidgetElement</code>的<code>mount</code>方法执行时，除了调用父类的<code>mount</code>方法外，还会触发<code>_rebuild()</code> 方法：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">RenderObjectToWidgetElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObject</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">RootRenderObjectElement</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>
  <span class="token class-name">Element</span><span class="token operator">?</span> _child<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">_rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在这里分析可知，这里的 widget 即\`RenderObjectToWidgetElement\` 的 widget，也就是</span>
  <span class="token comment">// \`RenderObjectToWidgetAdapter\`，他的 child 也就是 rootWidget</span>
  <span class="token comment">// 所以 updateChild 传入的值分别是 null，RenderObjectToWidgetAdapter.child</span>
  <span class="token comment">// 会创建 rootWidget 对应的 element 并将其作为当前 element 的 child</span>
      _child <span class="token operator">=</span> <span class="token function">updateChild</span><span class="token punctuation">(</span>_child<span class="token punctuation">,</span> <span class="token punctuation">(</span>widget <span class="token operator">as</span> <span class="token class-name">RenderObjectToWidgetAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>child<span class="token punctuation">,</span> _rootChildSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>exception<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>_rebuild</code>方法中，我们可以看到，在<code>WidgetsBinding.attachRootWidget</code>方法中给 RenderObjectToWidgetAdapter 作为<code>child</code>参数传入的<code>rootWidget</code>（也即我们示例中的<code>Center</code>Widget），在这里被传入了 RenderView 对应的 RenderObjectToWidgetElement 的<code>child</code>中（这里的过程我们下面 Center 一节再分析），从而将其插入到 Flutter 的渲染树中。</p><p>这样 RenderView（<code>RenderObject</code>）就有了对应的<code>Widget</code>和<code>Element</code>，并且有了自己的<code>child</code>。</p><h2 id="schedulewarmupframe" tabindex="-1"><a class="header-anchor" href="#schedulewarmupframe" aria-hidden="true">#</a> ..scheduleWarmUpFrame()</h2><p>这个方法则是尽快安排一个 frame 以便在屏幕下次刷新的时候显示 app 的内容（在 app 启动之后的第一次！！！），这样我们的 app 启动了，我们写的内容也能正常显示到屏幕上。</p><p>通过上述分析，我们可以得知，runApp 方法执行之后，创建了<code>RenderView</code>对象，并将其作为整个 Flutter APP 的 RenderObject rendering tree 的根节点（后续所有的 Widget 创建的 RenderObject 都是在 RenderView 的下层），并且初始化它以便在下一帧的时候对其进行渲染。</p><br><p>分析完了<code>runApp</code>，我们再来看一下刚刚提到的几个类，以及他们是如何添加到我们的 flutter app 中的。</p><h1 id="renderview" tabindex="-1"><a class="header-anchor" href="#renderview" aria-hidden="true">#</a> RenderView</h1>`,53),u={href:"https://github.com/flutter/flutter/blob/a0248ebdf20d2befe29cdf325dc7331826151dab/packages/flutter/lib/src/rendering/view.dart#L63",target:"_blank",rel:"noopener noreferrer"},r=t(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>↓[root]
 &gt;renderObject:RenderView#a00a5
 parent:null
 _debugReassembleConfig:null
 _notificationTree:nul1
 slot:null
 depth:1
 _widget:RenderObjectToWidgetAdapter
 &gt;_owner:BuildOwner
 _lifecycleState:_ElementLifecycle
 _debugForgottenChildrenWithGlobalKey:_HashSet
 _inheritedWidgets:nul1
 _dependencies:null
 _hadUnsatisfiedDependencies:false
 _dirty:false
 _inDirtyList:false
 _debugBuiltOnce:false
 _debugA1lowIgnoredCallsToMarkNeedsBuild:false
 _debugDoingBuild:false
 _ancestorRenderObjectElement:null
 _child:SingleChildRenderObjectElement
 _newWidget:null
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查阅源码可知，RenderView 是 RenderObject，一般情况下是 Flutter 的根 View，表示整个 rendering tree 的 output surface，处理引导着 render pipeline。</p><p>RenderView 有且仅有一个 RenderBox 类型的<code>child</code>，他会强制将<code>child</code>的<code>size</code>改为 RenderView 初始化时候的入参<code>configuration</code>的值（一般是当前<code>window</code>也就是<strong>手机屏幕</strong>的逻辑像素<code>size</code>）。</p><h1 id="center" tabindex="-1"><a class="header-anchor" href="#center" aria-hidden="true">#</a> Center</h1><p>上节我们说道，Center Widget 通过<code>RenderObjectToWidgetElement.updateChild</code>（最终调用 Element 同名方法）方法插入到渲染树中，下面我们详细分析一下这个过程：</p><p>在<code>updateChild</code>中，因为<code>child==null</code>，而<code>newWidget</code>也就是 Center 不为<code>null</code>，所以直接使用<code>inflateWidget(newWidget, newSlot)</code>创建新的 Element 并作为 RenderObjectToWidgetElement 的<code>_child</code>，而作为第一次创建的 Center，在<code>Element.inflateWidget</code>方法中大概会执行下面几步：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token comment">// Element 的 inflateWidget 方法：</span>

<span class="token keyword">final</span> <span class="token class-name">Element</span> newChild <span class="token operator">=</span> newWidget<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
newChild<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> newChild<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是这里先执行了<code>Center.createElement</code>方法创建 Element，然后调用此<code>Element.mount</code>方法将 Element 添加到 Element tree。</p><p>让我们再看一下 Center 的 Widget Details Tree：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Center
 alignment:Alignment.center
 widthFactor:null
 heightFactor:null
 renderObject:RenderPositionedBox#94e0d
 &gt;_parent:RenderObjectToWidgetElement
 _debugReassembleConfig:null
 _notificationTree:null
 &gt;_slot:Object
 _depth:2
 &gt;_widget:Center
 &gt;_owner:BuildOwner
 &gt;_lifecycleState:_ElementLifecycle
 &gt;_debugForgottenChildrenWithGlobalKey:_HashSet
 _inheritedWidgets:null
 _dependencies:null
 _hadUnsatisfiedDependencies:true
 _dirty:false
 _inDirtyList:false
 _debugBuiltOnce:false
 _debugA1lowIgnoredCallsToMarkNeedsBuild:false
 _debugDoingBuild:false
 &gt;_ancestorRenderObjectElement:RenderObjectToWidgetElement
 &gt;_child:StatelessElement

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 Center 的<code>_parent</code>和<code>_ancestorRenderObjectElement</code>是 RenderObjectToWidgetElement，<code>_depth</code>是 2，这个和我们最初的分析一致，因为 Center（其实严格来说，是 Center Widget 的（或子级的）RenderObject）是 RenderView 的<code>child</code>。</p><p>我们接下来主要关注一下几个属性：</p><ul><li><code>alignment</code>: Alignment.center</li><li><code>renderObject</code>: RenderPositionedBox</li><li><code>_widget</code>: Center</li><li><code>_child</code>: StatelessElement</li></ul><p>先看一下 Center 的源码：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\basic.dart</span>

<span class="token keyword">class</span> <span class="token class-name">Center</span> <span class="token keyword">extends</span> <span class="token class-name">Align</span> <span class="token punctuation">{</span>
  <span class="token comment">/// Creates a widget that centers its child.</span>
  <span class="token keyword">const</span> <span class="token class-name">Center</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span> double<span class="token operator">?</span> widthFactor<span class="token punctuation">,</span> double<span class="token operator">?</span> heightFactor<span class="token punctuation">,</span> <span class="token class-name">Widget</span><span class="token operator">?</span> child <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">,</span> widthFactor<span class="token punctuation">:</span> widthFactor<span class="token punctuation">,</span> heightFactor<span class="token punctuation">:</span> heightFactor<span class="token punctuation">,</span> child<span class="token punctuation">:</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Center 代码十分简单，主要的逻辑在他的父类 Align 中：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\basic.dart</span>

<span class="token keyword">class</span> <span class="token class-name">Align</span> <span class="token keyword">extends</span> <span class="token class-name">SingleChildRenderObjectWidget</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token class-name">Align</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token comment">// 这里 alignment 默认是居中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>alignment <span class="token operator">=</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>widthFactor<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heightFactor<span class="token punctuation">,</span>
    <span class="token class-name">Widget</span><span class="token operator">?</span> child<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">,</span> child<span class="token punctuation">:</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">RenderPositionedBox</span> <span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Center 的父类可以创建自己的 RenderObject</span>
    <span class="token keyword">return</span> <span class="token class-name">RenderPositionedBox</span><span class="token punctuation">(</span>
      alignment<span class="token punctuation">:</span> alignment<span class="token punctuation">,</span>
      widthFactor<span class="token punctuation">:</span> widthFactor<span class="token punctuation">,</span>
      heightFactor<span class="token punctuation">:</span> heightFactor<span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">Directionality</span><span class="token punctuation">.</span><span class="token function">maybeOf</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">updateRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">RenderPositionedBox</span> renderObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderObject
      <span class="token punctuation">.</span><span class="token punctuation">.</span>alignment <span class="token operator">=</span> alignment
      <span class="token punctuation">.</span><span class="token punctuation">.</span>widthFactor <span class="token operator">=</span> widthFactor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>heightFactor <span class="token operator">=</span> heightFactor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>textDirection <span class="token operator">=</span> <span class="token class-name">Directionality</span><span class="token punctuation">.</span><span class="token function">maybeOf</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Align 其实是一个<code>SingleChildRenderObjectWidget</code> ,对应的 Element 是<code>SingleChildRenderObjectElement</code>，他创建的 RenderObject 是<code>RenderPositionedBox</code> 。</p><p><code>SingleChildRenderObjectElement</code> 是一个<code>RenderObjectElement</code> 也就意味着他在 rendering tree 有一个关联的 RenderObject 负责 layout，painting 以及 hit-test。</p><p>回到我们的 Center Widget 中：</p><h2 id="alignment-alignment-center" tabindex="-1"><a class="header-anchor" href="#alignment-alignment-center" aria-hidden="true">#</a> <strong>alignment: Alignment.center</strong></h2><p><strong>Alignment.center</strong>是在创建 Center 的时候默认设置的对齐方式</p><h2 id="renderobject-renderpositionedbox" tabindex="-1"><a class="header-anchor" href="#renderobject-renderpositionedbox" aria-hidden="true">#</a> <strong>renderObject: RenderPositionedBox</strong></h2><p><strong>RenderPositionedBox</strong>是 Center Widget 对应的 RenderObject，在<code>SingleChildRenderObjectWidget.mount</code> 的时候创建。其本身并不在屏幕上绘制肉眼可见的内容，而是将 child 按照指定的对齐方式进行定位。</p><p><code>RenderPositionedBox</code> 的继承关系：<code>RenderPositionedBox</code> → <code>RenderAligningShiftedBox</code> → <code>RenderShiftedBox</code> → <code>RenderBox</code> → <code>RenderObject</code></p><p><strong>RenderPositionedBox</strong>可以按照给定的<code>AlignmentGeometry</code>定位 child。在本例中，他的几个属性如下：</p><ul><li><code>alignment</code>: Alignment.center</li><li><code>_owner</code>: PipelineOwner</li><li><code>_parent</code>: RenderView</li><li><code>_child</code>: RenderParagraph</li></ul><p>前三个属性含义很明显，这里我们注意到他的<code>_child</code>并不是我们预期的<code>Text</code>，这个原因我们后面再分析。</p><h2 id="widget-center" tabindex="-1"><a class="header-anchor" href="#widget-center" aria-hidden="true">#</a> <strong>_widget: Center</strong></h2><p>其实通过上述的分析，我们应该已经知道，我们在 Widget Details Tree 中看到的 Center 其实是 Center Widget 对应的 Element，也就是<code>SingleChildRenderObjectElement</code> 。</p><p>其继承关系：<code>SingleChildRenderObjectElement</code> → <code>RenderObjectElement</code> → <code>Element</code></p><p>根据 Element 的定义，这里的 Widget 是在 Widget 创建<code>SingleChildRenderObjectElement</code>的时候传入的：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>

<span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token class-name">Widget</span> widget<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token keyword">assert</span><span class="token punctuation">(</span>widget <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _widget <span class="token operator">=</span> widget<span class="token punctuation">;</span>

<span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleChildRenderObjectWidget</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObjectWidget</span> <span class="token punctuation">{</span>
  <span class="token comment">/// Abstract const constructor. This constructor enables subclasses to provide</span>
  <span class="token comment">/// const constructors so that they can be used in const expressions.</span>
  <span class="token keyword">const</span> <span class="token class-name">SingleChildRenderObjectWidget</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// The widget below this widget in the tree.</span>
  <span class="token comment">///</span>
  <span class="token comment">/// {@macro flutter.widgets.ProxyWidget.child}</span>
  <span class="token keyword">final</span> <span class="token class-name">Widget</span><span class="token operator">?</span> child<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">SingleChildRenderObjectElement</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">SingleChildRenderObjectElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后这个 Element 在上述<code>WidgetsBinding.attachRootWidget</code>步骤中通过一系列操作，最终在 RenderObjectToWidgetElement 的<code>updateChild</code>方法被创建并被<code>BuildOwner</code> 插入到 tree 中。</p><p>这里的<code>_widget</code>才真正对应着我们在<code>runApp</code>里面传入的 Center Widget，他的<code>child</code>也正是我们的 Text。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Center
 alignment:Alignment.center
 widthFactor:null
 heightFactor:null
 &gt;renderObject:RenderPositionedBox#6e802
 &gt;_parent:RenderObjectToWidgetElement
 _debugReassembleConfig:null
 _notificationTree:null
 _slot:Object
 denth:2 _
 [[[widget:Center]]] //注意这里
  key:null
  location:_Location
  [[[child:Text]]] //注意这里
   key:null
   &gt;_location:_Location
   data:&#39;Hello center text!&#39;
   textSpan:null
   style:null
   strutStyle:null
   textAlign:null
   &gt;textDirection:TextDirection
   locale:null
   softWrap:null
   overflow:null
   textScaleFactor:null
   maxLines:null
   semanticsLabel:null
   textWidthBasis:null
   textHeightBehavior:null
  &gt;alignment:Alignment
  widthFactor:null
  heightFactor:nul1
 &gt;_owner:BuildOwner
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="child-statelesselement" tabindex="-1"><a class="header-anchor" href="#child-statelesselement" aria-hidden="true">#</a> <strong>_child: StatelessElement</strong></h2><p>Center 对应的 Element 的<code>_child</code>是一个 StatelessElement，按照我们上一步的分析，StatelessElement 应该是 Text Widget 创建，事实也确实如此：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>↓_child: StatelessElement
 &gt;_parent: SingleChildRenderObjectElement
 debugReassembleConfig： null
 _notificationTree: null
 slot: null
 depth: 3
 &gt;_widget: Text
 &gt;_owner: BuildOwner
 &gt;_lifecycleState: _ElementLifecycle
 &gt;_debugForgottenChildrenWithGlobalKey: _HashSet
 _inheritedWidgets: null
 dependencies: null
 _hadUnsatisfiedDependencies: true
 _dirty: false
 _inDirtyList: false
 debugBuiltOnce: false
 _debugAllowIgnoredCallsToMarkNeedsBuild: false
 &gt;_child: MultichildRenderObjectElement
 debugDoingBuild: false
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>让我们分析一下这个<code>_child</code>的赋值过程：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token keyword">class</span> <span class="token class-name">SingleChildRenderObjectElement</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObjectElement</span> <span class="token punctuation">{</span>
	<span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token operator">?</span> parent<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _child <span class="token operator">=</span> <span class="token function">updateChild</span><span class="token punctuation">(</span>_child<span class="token punctuation">,</span> <span class="token punctuation">(</span>widget <span class="token operator">as</span> <span class="token class-name">SingleChildRenderObjectWidget</span><span class="token punctuation">)</span><span class="token punctuation">.</span>child<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Center 对应的 Element——<code>SingleChildRenderObjectElement</code> 在<code>mount</code>的时候，同时也会更新<code>child</code>（本例中 Center 的<code>child</code>是 Text），这里调用的是 Element 的<code>updateChild</code>方法，他的逻辑如下：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token operator">|</span>                     <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>newWidget <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>newWidget <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">*</span><span class="token operator">*</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token punctuation">:</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">:</span> <span class="token operator">|</span> <span class="token punctuation">:</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">|</span> <span class="token punctuation">:</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token operator">*</span><span class="token operator">*</span>child <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">|</span>  <span class="token class-name">Returns</span> <span class="token keyword">null</span><span class="token punctuation">.</span>         <span class="token operator">|</span>  <span class="token class-name">Returns</span> <span class="token keyword">new</span> <span class="token punctuation">[</span><span class="token class-name">Element</span><span class="token punctuation">]</span><span class="token punctuation">.</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token operator">*</span><span class="token operator">*</span>child <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">|</span>  <span class="token class-name">Old</span> child <span class="token operator">is</span> removed<span class="token punctuation">,</span> returns <span class="token keyword">null</span><span class="token punctuation">.</span> <span class="token operator">|</span> <span class="token class-name">Old</span> child updated <span class="token keyword">if</span> possible<span class="token punctuation">,</span> returns child or <span class="token keyword">new</span> <span class="token punctuation">[</span><span class="token class-name">Element</span><span class="token punctuation">]</span><span class="token punctuation">.</span> <span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>updateChild</code>的逻辑分为 4 种情况：其余情况都比较简单，只有<code>newWidget != null</code>或者<code>child != null</code>的时候需要判断一下，如果可以更新就更新否则就创建新的 Element，可以分为下面这几种情况：</p><ul><li><code>child.widget == newWidget</code>：两个是同一个对象，就只更新<code>child</code>的<code>slot</code></li><li><code>Widget.canUpdate(child.widget, newWidget)</code>：二者的<code>runtimeType</code>和<code>key</code>一样，就调用<code>child.update(newWidget)</code>更新<code>child._widget</code>，必要时更新<code>child</code>的<code>slot</code></li><li>否则创建新的<code>element</code>并替代</li></ul><p>到这里跟 Center 插入到 render tree 的步骤一样，将 Text 插入到了 tree 中。</p><h1 id="text" tabindex="-1"><a class="header-anchor" href="#text" aria-hidden="true">#</a> Text</h1><p>接下来我们分析一下 Text 是如何被加入 Widget Details Tree 的。</p><p>其继承关系：<code>Text</code> → <code>StatelessWidget</code> → <code>Widget</code></p><p>Text 是 StatelessWidget，他的内容比较简单，主要的逻辑都在<code>build</code>方法中：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; \\lib\\src\\widgets\\text.dart</span>

<span class="token keyword">class</span> <span class="token class-name">Text</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
       textSpan <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">DefaultTextStyle</span> defaultTextStyle <span class="token operator">=</span> <span class="token class-name">DefaultTextStyle</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TextStyle</span><span class="token operator">?</span> effectiveTextStyle <span class="token operator">=</span> style<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>style <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> style<span class="token operator">!</span><span class="token punctuation">.</span>inherit<span class="token punctuation">)</span>
      effectiveTextStyle <span class="token operator">=</span> defaultTextStyle<span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">boldTextOverride</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
      effectiveTextStyle <span class="token operator">=</span> effectiveTextStyle<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>bold<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意这里返回了 RichText</span>
    <span class="token class-name">Widget</span> result <span class="token operator">=</span> <span class="token class-name">RichText</span><span class="token punctuation">(</span>
      textAlign<span class="token punctuation">:</span> textAlign <span class="token operator">?</span><span class="token operator">?</span> defaultTextStyle<span class="token punctuation">.</span>textAlign <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">TextAlign</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> textDirection<span class="token punctuation">,</span> <span class="token comment">// RichText uses Directionality.of to obtain a default if this is null.</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      text<span class="token punctuation">:</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
        style<span class="token punctuation">:</span> effectiveTextStyle<span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> data<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> textSpan <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InlineSpan</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>textSpan<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样，作为 StatelessWidget，他也创建了一个<code>StatelessElement</code> ：</p><p>其继承关系：<code>StatelessElement</code> → <code>ComponentElement</code> → <code>Element</code></p><p>按照之前的分析，Text 插入到 tree 中执行的方法分别是<code>Text.createElement</code>和 Text 对应的 Element——<code>StatelessElement.mount</code>方法：</p><p>Text 是 StatelessWidget 的子类，他的主要逻辑都在 StatelessWidget：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StatelessWidget</span> <span class="token keyword">extends</span> <span class="token class-name">Widget</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> <span class="token class-name">StatelessWidget</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Key</span><span class="token operator">?</span> key <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">StatelessElement</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">StatelessElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token metadata function">@protected</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到其<code>createElement</code>创建的是 StatelessElement，也就是说 Text 插入到 Center 过程主要在 StatelessElement 中。</p><p><code>StatelessElement.mount</code>方法主要逻辑在 ComponentElement 中，这个方法除了调用 Element 同名方法外，还调用了<code>ComponentElement._firstBuild()</code> → <code>Element.rebuild()</code> → <code>ComponentElement.performRebuild()</code> ：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token comment">// ComponentElement 类中的方法</span>

<span class="token keyword">void</span> <span class="token function">performRebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Widget</span><span class="token operator">?</span> built<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里调用 Element 对应的 Widget 的 build 方法创建 Widget，也就是 RichText</span>
      built <span class="token operator">=</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// We delay marking the element as clean until after calling build() so</span>
      <span class="token comment">// that attempts to markNeedsBuild() during build() will be ignored.</span>
      _dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">_debugSetAllowIgnoredCallsToMarkNeedsBuild</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将上述创建的 Widget：built 经过处理后赋值给 Element 的_child</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      _child <span class="token operator">=</span> <span class="token function">updateChild</span><span class="token punctuation">(</span>_child<span class="token punctuation">,</span> built<span class="token punctuation">,</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>_child <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      built <span class="token operator">=</span> <span class="token class-name">ErrorWidget</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _child <span class="token operator">=</span> <span class="token function">updateChild</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> built<span class="token punctuation">,</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的主要有两个步骤：</p><ul><li>调用<code>ComponentElement.build</code>方法，生产 Widget（本例中，间接调用了 Text 的<code>build</code>方法）</li><li>调用<code>ComponentElement.updateChild</code>方法，更新<code>child</code>（最终执行的是 Element 同名方法逻辑）</li></ul><p>到目前为止，我们的 Widget/Element/RenderObject tree 如下（第四级 RichText 下面再分析）：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Widget</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span>       <span class="token class-name">RenderObjectToWidgetAdapter</span> → <span class="token class-name">Center</span>                         → <span class="token class-name">Text</span>              → <span class="token operator">*</span><span class="token class-name">RichText</span><span class="token operator">*</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Element</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span>      <span class="token class-name">RenderObjectToWidgetElement</span> → <span class="token class-name">SingleChildRenderObjectElement</span> → <span class="token class-name">StatelessElement</span>  → <span class="token operator">*</span><span class="token class-name">MultiChildRenderObjectElement</span><span class="token operator">*</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">RenderObject</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span> <span class="token class-name">RenderView</span>                  → <span class="token class-name">RenderPositionedBox</span>            → <span class="token punctuation">[</span><span class="token class-name">X</span><span class="token punctuation">]</span>               → <span class="token operator">*</span><span class="token class-name">RenderParagraph</span><span class="token operator">*</span>

注：
<span class="token number">1.</span> 这里的<span class="token punctuation">[</span><span class="token class-name">X</span><span class="token punctuation">]</span>实际上不存在，只是为了和<span class="token class-name">Text</span>对应表示这里本应该有一个对应的<span class="token class-name">RenderObject</span>
<span class="token number">2.</span> 最后一列<span class="token operator">*</span><span class="token class-name">RichText</span><span class="token operator">*</span>对应的节点目前还没有分析到，此处仅做提前展示
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不难看出，在从定往下数第三层也就是 Text 对应的这一级中，RenderObject tree 这里并没有对应的对象，在上面的分析中，我们也看到了 StatelessWidget 本身并没有创建 RenderObject 的方法。实际上，Widget 分为多个种类，只有 RenderObject 类及其子类才会创建 RenderObject：</p><figure><img src="https://jixiaoyong.github.io/images/flutter_run_app/heritance_of_widget.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h2 id="richtext" tabindex="-1"><a class="header-anchor" href="#richtext" aria-hidden="true">#</a> RichText</h2><p>终于到了我们这个 app 真正在屏幕上显示的内容这里了，上面我们分析到，Text 作为 StatelessWidget，本身并不会产生可以在屏幕上绘制的 RenderObject，而是通过他的<code>build</code>方法返回一个可以产生 RenderObject 的 Widget，在本例中，这个 Widget 就是 RichText：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\basic.dart</span>

<span class="token keyword">class</span> <span class="token class-name">RichText</span> <span class="token keyword">extends</span> <span class="token class-name">MultiChildRenderObjectWidget</span> <span class="token punctuation">{</span>
	<span class="token metadata function">@override</span>
  <span class="token class-name">RenderParagraph</span> <span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>textDirection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">debugCheckHasDirectionality</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RenderParagraph</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span>
      textAlign<span class="token punctuation">:</span> textAlign<span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> textDirection <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Directionality</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      softWrap<span class="token punctuation">:</span> softWrap<span class="token punctuation">,</span>
      overflow<span class="token punctuation">:</span> overflow<span class="token punctuation">,</span>
      textScaleFactor<span class="token punctuation">:</span> textScaleFactor<span class="token punctuation">,</span>
      maxLines<span class="token punctuation">:</span> maxLines<span class="token punctuation">,</span>
      strutStyle<span class="token punctuation">:</span> strutStyle<span class="token punctuation">,</span>
      textWidthBasis<span class="token punctuation">:</span> textWidthBasis<span class="token punctuation">,</span>
      textHeightBehavior<span class="token punctuation">:</span> textHeightBehavior<span class="token punctuation">,</span>
      locale<span class="token punctuation">:</span> locale <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Localizations</span><span class="token punctuation">.</span><span class="token function">maybeLocaleOf</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RichText 继承自<code>MultiChildRenderObjectWidget</code> ，如上节分析的，是一种<code>RenderObjectWidget</code>，它创建了真正在屏幕上渲染的 RenderObject——<code>RenderParagraph</code>：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\rendering\\paragraph.dart</span>

<span class="token keyword">class</span> <span class="token class-name">RenderParagraph</span> <span class="token keyword">extends</span> <span class="token class-name">RenderBox</span>
    <span class="token keyword">with</span> <span class="token class-name">ContainerRenderObjectMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderBox</span><span class="token punctuation">,</span> <span class="token class-name">TextParentData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
             <span class="token class-name">RenderBoxContainerDefaultsMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderBox</span><span class="token punctuation">,</span> <span class="token class-name">TextParentData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
                  <span class="token class-name">RelayoutWhenSystemFontsChangeMixin</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面说道，Text 本身作为 StatelessWidget 并不产生 RenderObject，那么这里的 RenderParagraph 是如何找到并插入到 rendering tree 中的呢？</p><p>带着这个疑问，我们看一下<code>MultiChildRenderObjectWidget</code> 创建的<code>MultiChildRenderObjectElement</code> ：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>

<span class="token keyword">class</span> <span class="token class-name">MultiChildRenderObjectElement</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObjectElement</span> <span class="token punctuation">{</span>
	<span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token operator">?</span> parent<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MultiChildRenderObjectWidget</span> multiChildRenderObjectWidget <span class="token operator">=</span> widget <span class="token operator">as</span> <span class="token class-name">MultiChildRenderObjectWidget</span><span class="token punctuation">;</span>
    <span class="token comment">// 本例中不涉及 children</span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Element</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Element</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">filled</span><span class="token punctuation">(</span>multiChildRenderObjectWidget<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">,</span> _NullElement<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Element</span><span class="token operator">?</span> previousChild<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token class-name">Element</span> newChild <span class="token operator">=</span> <span class="token function">inflateWidget</span><span class="token punctuation">(</span>multiChildRenderObjectWidget<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">IndexedSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Element</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> previousChild<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> newChild<span class="token punctuation">;</span>
      previousChild <span class="token operator">=</span> newChild<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _children <span class="token operator">=</span> children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里可以看到，在 MultiChildRenderObjectElement 的<code>mount</code>方法中：</p><ul><li>调用父类<code>mount</code>方法</li><li>遍历了所有的<code>children</code>将其插入到 MultiChildRenderObjectElement 中。</li></ul><p>在前面的 Text 源码中，我们注意到给只给<code>RichText.text</code>赋值了，RichText 的<code>textSpan</code>和<code>children</code>都是<code>null</code>，所以后面对<code>children</code>的处理在本例中不涉及，让我们看一下<code>super.mount(parent, newSlot)</code>方法：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RenderObjectElement</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token operator">?</span> parent<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里调用对应的 RenderObjectWidget 创建_renderObject</span>
    _renderObject <span class="token operator">=</span> <span class="token punctuation">(</span>widget <span class="token operator">as</span> <span class="token class-name">RenderObjectWidget</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将其绑定到 rendering tree 中</span>
    <span class="token function">attachRenderObject</span><span class="token punctuation">(</span>newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里主要有 2 步：</p><ul><li>通过<code>widget.createRenderObject</code> 创建<code>_renderObject</code>，本例中就是用 RichText 创建了 RenderParagraph</li><li>调用<code>RenderObjectElement.attachRenderObject</code>方法将<code>_renderObject</code>插入到 rendering tree</li></ul><p>让我们看一下 attachRenderObject 的实现：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token comment">// RenderObjectElement 类的方法</span>
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">attachRenderObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token operator">?</span> newSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_ancestorRenderObjectElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _slot <span class="token operator">=</span> newSlot<span class="token punctuation">;</span>
    <span class="token comment">// 向上遍历，找到父级节点中最近的 RenderObjectElement</span>
    _ancestorRenderObjectElement <span class="token operator">=</span> <span class="token function">_findAncestorRenderObjectElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 renderObject 插入</span>
    _ancestorRenderObjectElement<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">insertRenderObjectChild</span><span class="token punctuation">(</span>renderObject<span class="token punctuation">,</span> newSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ParentDataElement</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParentData</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> parentDataElement <span class="token operator">=</span> <span class="token function">_findAncestorParentDataElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentDataElement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token function">_updateParentData</span><span class="token punctuation">(</span>parentDataElement<span class="token punctuation">.</span>widget <span class="token operator">as</span> <span class="token class-name">ParentDataWidget</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParentData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">RenderObjectElement</span><span class="token operator">?</span> <span class="token function">_findAncestorRenderObjectElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Element</span><span class="token operator">?</span> ancestor <span class="token operator">=</span> _parent<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ancestor <span class="token operator">is!</span> <span class="token class-name">RenderObjectElement</span><span class="token punctuation">)</span>
      ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>_parent<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ancestor <span class="token operator">as</span> <span class="token class-name">RenderObjectElement</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在<code>attachRenderObject</code>方法中插入的方式很简单：先在当前 tree 中向上找到父级中离得最近的 RenderObjectElement，在本例中是 Center 这个 Widget 对应的 SingleChildRenderObjectElement（注意不是创建 RichText 的 Text），然后调用其<code>insertRenderObjectChild</code>方法将当前的 RenderParagraph 插入到 rendering tree 中：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\\src\\widgets\\framework.dart</span>
<span class="token keyword">class</span> <span class="token class-name">SingleChildRenderObjectElement</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObjectElement</span> <span class="token punctuation">{</span>
	<span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">insertRenderObjectChild</span><span class="token punctuation">(</span><span class="token class-name">RenderObject</span> child<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">?</span> slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">RenderObjectWithChildMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderObject</span><span class="token punctuation">&gt;</span></span> renderObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderObject <span class="token operator">as</span> <span class="token class-name">RenderObjectWithChildMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
    renderObject<span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 SingleChildRenderObjectElement 的<code>insertRenderObjectChild</code>方法中先是查找当前 Element 持有的<code>renderObject</code>,然后将我们传入的 RichText 的 RenderObject——RenderParagraph 赋值给<code>renderObject.child</code>。</p><p>到这里，我们的所有 Widget 在 Element 的组织下，将对于的 RenderObject 添加到 Rendering Tree 中，他们的关系如下：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Widget</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span>       <span class="token class-name">RenderObjectToWidgetAdapter</span> → <span class="token class-name">Center</span>                         → <span class="token class-name">Text</span>              → <span class="token class-name">RichText</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Element</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span>      <span class="token class-name">RenderObjectToWidgetElement</span> → <span class="token class-name">SingleChildRenderObjectElement</span> → <span class="token class-name">StatelessElement</span>  → <span class="token class-name">MultiChildRenderObjectElement</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">RenderObject</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span> <span class="token class-name">RenderView</span>                  → <span class="token class-name">RenderPositionedBox</span>                                → <span class="token class-name">RenderParagraph</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，当屏幕刷新的时候，这些内容便绘制在屏幕上面。</p><h1 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h1><p>在<code>runApp</code>方法中，WidgetsFlutterBinding 作为将 flutter framework 绑定到 flutter engine 的粘合剂：</p><ul><li><p>在<code>ensureInitialized</code>方法中创建了<code>_pipelineOwner</code>（管理 rendering tree）、<code>renderView</code>和<code>buildOwner</code>（通过管理 Element tree 间接管理 widget tree），并将<code>renderView</code>设置为<code>_pipelineOwner</code>的根节点。</p></li><li><p>在<code>scheduleAttachRootWidget</code>方法中，为<code>renderView</code>创建并绑定了对应的 Widget（RenderObjectToWidgetAdapter）和 Element（RenderObjectToWidgetElement）。然后通过<code>RenderObjectToWidgetElement.mount</code>方法，将之前创建的<code>buildOwner</code>与自己绑定。</p><p>并且将我们在<code>runApp</code>传入的 Widget<code>rootWidget</code>（也就是本例中的 Center Widget）对应的 Element 添加为 RenderObjectToWidgetElement 的子节点。并依此将 Text、Text 内部的 RichText 等对应的 Element 都加入到 Element tree 中，直到遍历完整个 Widget tree。</p></li><li><p>在<code>scheduleWarmUpFrame</code>方法中安排在下一次屏幕刷新的时候将我们的内容展示在屏幕上面。</p></li></ul><p>下面是我们这个“最”简单的 Flutter App 的结构示意：</p><figure><img src="https://jixiaoyong.github.io/images/flutter_run_app/flutter_run_app_widget_elelemt_renderobject_tree.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h1>`,93),k={href:"https://api.flutter.dev/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://www.youtube.com/watch?v=PnWxW21vDak",target:"_blank",rel:"noopener noreferrer"},v={href:"https://www.youtube.com/watch?v=FU2Eeizo95o&ab_channel=RetroPortalStudio",target:"_blank",rel:"noopener noreferrer"},b={href:"http://zxfcumtcs.github.io/2020/12/05/deepinto-flutter-pipelineowner/",target:"_blank",rel:"noopener noreferrer"};function g(h,w){const a=c("ExternalLinkIcon");return o(),l("div",null,[d,n("p",null,[s("先看一下在最顶层的"),n("a",u,[s("RenderView"),e(a)]),s("：")]),r,n("p",null,[n("a",k,[s("Flutter - Dart API docs"),e(a)])]),n("p",null,[n("a",m,[s("Flutter, what are Widgets, RenderObjects and Elements? - Norbert Kozsir | Flutter Europe"),e(a)])]),n("p",null,[n("a",v,[s("Flutter Widgets Explained | Understand How Flutter Works!"),e(a)])]),n("p",null,[n("a",b,[s("深入浅出 Flutter Framework 之 PipelineOwner"),e(a)])])])}const y=p(i,[["render",g],["__file","4cbcfe72.html.vue"]]);export{y as default};
