<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Dart Isolateæºç åˆ†æ</title>
      <link href="/blog/posts/a951661c/"/>
      <url>/blog/posts/a951661c/</url>
      
        <content type="html"><![CDATA[<h1 id="Isolate"><a href="#Isolate" class="headerlink" title="Isolate"></a>Isolate</h1><p>ğŸ’¡ æœ¬æ–‡åŸºäºDart 2.17.1</p><p><a href="https://api.dart.cn/stable/2.17.1/dart-isolate/Isolate-class.html" target="_blank" rel="noopener">Isolate</a>, an isolated Dart execution context.</p><p>All Dart code runs in an isolate, and <strong>code can access classes and values only from the same isolate</strong>. Different isolates can communicate by <strong>sending values through ports</strong> (see <a href="https://api.dart.cn/stable/2.17.1/dart-isolate/ReceivePort-class.html" target="_blank" rel="noopener">ReceivePort</a>, <a href="https://api.dart.cn/stable/2.17.1/dart-isolate/SendPort-class.html" target="_blank" rel="noopener">SendPort</a>).</p><blockquote><p>In Dart an isolate has its own event loop, its own global fields, can run in parallel with other isolates and have their own live-cycle.<br>â€” <a href="https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375" target="_blank" rel="noopener">https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375</a></p></blockquote><p> The new isolate has its <strong>own memory and its own thread</strong> working in parallel with the main isolate.</p><p><img src="https://jixiaoyong.github.io/images/isolate_and_isolate_group.png" alt="[https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly](https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly)"></p><p><a href="https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly" target="_blank" rel="noopener">https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly</a></p><p>Isolateåˆ›å»ºä¼šå ç”¨å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨<code>IsolateGroup</code>æ¥è§£å†³ï¼Œå¹¶ä¸”ç›®å‰ä¸ºæ­¢Dartå’ŒFlutteréƒ½é»˜è®¤æ”¯æŒåœ¨ä½¿ç”¨<code>Isolate.spawn</code>åˆ›å»ºæ–°Isolateçš„æ—¶å€™ä½¿ç”¨IsolateGroupï¼ˆ<code>Isolate.spwanUri</code>åˆ›å»ºçš„æ—¶å€™ä¼šåˆ›å»º<strong>å•ç‹¬</strong>çš„IsolateGroupå’ŒIsolateï¼‰ã€‚</p><blockquote><p>ğŸ’¡ åœ¨åˆ›å»ºisolateçš„æ—¶å€™å¯ä»¥æ·»åŠ <code>addOnExitListener</code> æˆ–è€…<code>addErrorListener</code>ä¹‹ç±»çš„ç›‘å¬ï¼Œä½†æ˜¯å¯èƒ½åœ¨æ‰§è¡Œæ·»åŠ ä»£ç çš„æ—¶å€™<strong>isolateå°±å·²ç»ç»ˆæ­¢äº†</strong>è€Œå¯¼è‡´è¿™äº›æ–¹æ³•æ”¶ä¸åˆ°å›è°ƒã€‚<br>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥åœ¨åˆ›å»ºisolateçš„æ—¶å€™æŒ‡å®šä»–çš„çŠ¶æ€ä¸º<strong><code>paused</code></strong>ã€‚</p></blockquote><p>ä¸isolateæœ‰å…³çš„ç±»æœ‰ï¼š</p><ul><li><code>Isolate</code> ä½ç½®åœ¨<code>sdk\lib\isolate\isolate.dart</code>ã€‚ä¸»è¦æ˜¯<code>Isolate</code> é€šç”¨æ–¹æ³•ã€å±æ€§çš„æŠ½è±¡æè¿°ï¼Œæ²¡æœ‰å…·ä½“å®ç°ã€‚</li><li><code>Isolate</code> ä½ç½®åœ¨<code>sdk\lib\_internal\vm\lib\isolate_patch.dart</code>ï¼Œæ˜¯appç­‰å¹³å°å¯¹åº”çš„å…·ä½“å®ç°ï¼Œéƒ¨åˆ†æ–¹æ³•è°ƒç”¨äº†nativeå±‚çš„Isolateå®ç°ã€‚</li><li><code>Isolate</code>  ä½ç½®åœ¨<code>runtime\vm\isolate.h</code>ä»¥åŠ<code>runtime\vm\isolate.cc</code>ä¸­ï¼Œæ˜¯Isolateçš„nativeå±‚å®ç°ã€‚</li></ul><p>ä»–ä»¬çš„å…³ç³»å¤§è‡´å¦‚å›¾ï¼š</p><p><img src="https://jixiaoyong.github.io/images/isolate_class_dart_and_native.png" alt="Untitled"></p><h1 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h1><h2 id="åˆ›å»ºæ–°Isolateçš„æ–¹å¼"><a href="#åˆ›å»ºæ–°Isolateçš„æ–¹å¼" class="headerlink" title="åˆ›å»ºæ–°Isolateçš„æ–¹å¼:"></a>åˆ›å»ºæ–°Isolateçš„æ–¹å¼:</h2><ul><li><code>Isolate(`</code>SendPort controlPort<code></code>, {this.pauseCapability, this.terminateCapability});` è¿™ç§æ–¹å¼åˆ›å»ºä¸€ç§<strong>èƒ½åŠ›å—é™</strong>çš„Isolateã€‚The capabilities should be the subset of the capabilities that are available to the original isolate.æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰åœ¨nativeå±‚å­µåŒ–ä¸€ä¸ªæ–°çš„Isolateã€‚</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newIsolate = Isolate(Isolate.current.controlPort);</span><br><span class="line">  newIsolate.addOnExitListener(Isolate.current.controlPort);</span><br><span class="line">  newIsolate.addErrorListener(Isolate.current.controlPort);</span><br><span class="line">  Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>),()&#123;</span><br><span class="line">    newIsolate.kill();</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"try kill new isolate"</span>); <span class="comment">// after thisï¼Œthe dart code finish</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"finish"</span>);</span><br></pre></td></tr></table></figure><ul><li><code>Isolate.spawn(`</code>void entryPoint(T message), T message,â€¦)` åˆ›å»ºä¸€ä¸ªå’Œå½“å‰Isolate<strong>å…±äº«åŒä¸€ä»½ä»£ç </strong>çš„Isolateï¼Œå¹¶æ‰§è¡ŒentryPointæ–¹æ³•ï¼Œä¸€èˆ¬åœ¨messageä¸­ä¼ å…¥SendPortä»¥ä¾¿ä»entryPointä¸­å‘æ¥æ—¶çš„Isolateå‘é€æ¶ˆæ¯ï¼Œæ–°å»ºçš„Isolateå’Œå½“å‰Isolateåœ¨åŒä¸€ä¸ªIsolateGroupä¸­ã€‚</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> spawnIsolate() &#123;</span><br><span class="line">  <span class="keyword">var</span> receivePort = ReceivePort();</span><br><span class="line">  receivePort.listen((message) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"receivePort(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>) received msg: <span class="subst">$message</span>"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªå’Œå½“å‰çš„isolateå…±äº«åŒä¸€ä»½ä»£ç çš„Isolate</span></span><br><span class="line"><span class="keyword">var</span> isolate = Isolate.spawn((message) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Isolate initial function(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>) received msg: <span class="subst">$message</span>"</span>);</span><br><span class="line">    (message <span class="keyword">as</span> SendPort).send(<span class="string">"HELLO_FORM_ISOLATE(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>)"</span>);</span><br><span class="line">  &#125;, receivePort.sendPort,debugName: <span class="string">"another_isolate"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Isolate.spawnUriï¼ˆUri uri,List&lt;String&gt; args,var message,...ï¼‰</code>* æŒ‡å®šçš„<code>uri</code>ä¸­åˆ›å»ºå¹¶å­µåŒ–ä¸€ä¸ªisolateï¼Œæ‰§è¡Œuriå¯¹åº”çš„libraryä¸­çš„<code>main</code>æ–¹æ³•ï¼ˆ0~2ä¸ªå…¥å‚ï¼‰ï¼Œå¹¶ä¼ å…¥æ— å‚ã€argsæˆ–messageä½œä¸ºå‚æ•°</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> receivePort = ReceivePort();</span><br><span class="line">  receivePort.listen((message) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"receivePort(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>) received msg: <span class="subst">$message</span>"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªå’Œå½“å‰çš„isolateå…±äº«åŒä¸€ä»½ä»£ç çš„Isolate</span></span><br><span class="line">  <span class="keyword">var</span> isolate = <span class="keyword">await</span> Isolate.spawnUri(</span><br><span class="line">      <span class="built_in">Uri</span>.file(</span><br><span class="line">          <span class="string">r"E:\workspace\others\flutter_dart_source_code_analysis\lib\dart\another_dart_file_to_spawn_uri.dart"</span>),</span><br><span class="line">      [],</span><br><span class="line">      receivePort.sendPort,</span><br><span class="line">      debugName: <span class="string">"another_isolate"</span>);</span><br><span class="line">  Future.delayed(<span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">2</span>), () &#123;</span><br><span class="line">    receivePort.close();</span><br><span class="line">    isolate.kill(priority: Isolate.immediate);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"try kill new isolate"</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h2><h3 id="pause"><a href="#pause" class="headerlink" title="pause"></a><strong>pause</strong></h3><p><code>Capability pause([Capability? resumeCapability])</code>ï¼Œæš‚åœIsolateï¼Œåœæ­¢ä»<em><code>event loop queue</code></em> ä¸­å–ï¼ˆå¹¶å¤„ç†ï¼‰æ¶ˆæ¯ï¼Œä½†æ˜¯ä¾ç„¶å¯ä»¥å¾€é‡Œé¢åŠ å…¥æ¶ˆæ¯</p><p><em><code>resumeCapability</code></em> æ˜¯ç”¨æ¥åŒºåˆ†pauseçš„ï¼Œå¿…é¡»ä½¿ç”¨åŒä¸€ä¸ª<em><code>resumeCapability</code></em>æ¥resume isolateã€‚</p><ul><li>ä½¿ç”¨åŒä¸€ä¸ª<em><code>resumeCapability</code></em>å¤šæ¬¡<code>pause</code>ï¼Œåªéœ€ä¸€æ¬¡<code>resume</code>å°±å¯ä»¥æ¢å¤<code>isolate</code></li><li>ä½¿ç”¨ä¸åŒ<em><code>resumeCapability</code></em>å¤šæ¬¡<code>pause</code>ï¼Œå¿…é¡»ä½¿ç”¨å¯¹åº”çš„<em><code>resumeCapability</code></em>ä¾æ¬¡<code>resume</code>æ‰å¯ä»¥æ¢å¤<code>isolate</code> ï¼ˆ<strong>æ³¨æ„</strong>ï¼šè¿™é‡Œä¹Ÿåªéœ€è¦ä½¿ç”¨å½“æ—¶pause isolateçš„<em><code>resumeCapability</code></em> ä¾æ¬¡è°ƒç”¨resumeå³å¯ï¼Œè€Œä¸ç”¨ä¿æŒæ¬¡æ•°ä¸€è‡´ï¼Œæ¯”å¦‚ï¼Œæœ‰2ä¸ª<em><code>resumeCapability</code> ï¼Œ</em>è°ƒç”¨pauseæ¬¡æ•°åˆ†åˆ«ä¸ºa 1,b 2ï¼Œé‚£ä¹ˆè¦æƒ³resume isolateï¼Œä¹Ÿåªéœ€è¦åˆ†åˆ«ä½¿ç”¨a,bè°ƒç”¨ä¸€æ¬¡resumeå³å¯ï¼‰</li></ul><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>ä½¿ç”¨isolateå¾€<code>receivePort.sendPort</code>å‘é€responseæ¶ˆæ¯ï¼Œ<strong>å³ä½¿isolateå½“å‰è¢«pauseä¹Ÿå¯ä»¥æ­£å¸¸å‘é€</strong></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">isolate.pause();</span><br><span class="line">isolate.ping(receivePort.sendPort, response: <span class="string">"is isolate resume?"</span>);<span class="comment">//receivePortä¾ç„¶å¯ä»¥æ”¶åˆ°æ¶ˆæ¯</span></span><br></pre></td></tr></table></figure><p>pingå¯ä»¥æ­£å¸¸å‘é€çš„åŸå› æ˜¯ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; lib\isolate\isolate.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pingæ–¹æ³•æ˜¯ä¸€ä¸ªexternalæ–¹æ³•</span></span><br><span class="line"><span class="keyword">external</span> <span class="keyword">void</span> ping(SendPort responsePort,</span><br><span class="line">      &#123;<span class="built_in">Object</span>? response, <span class="built_in">int</span> priority = immediate&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">void</span> ping(SendPort responsePort,</span><br><span class="line">      &#123;<span class="built_in">Object</span>? response, <span class="built_in">int</span> priority: immediate&#125;) &#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="keyword">new</span> <span class="built_in">List</span>&lt;<span class="built_in">Object</span>?&gt;.filled(<span class="number">5</span>, <span class="keyword">null</span>)</span><br><span class="line">      ..[<span class="number">0</span>] = <span class="number">0</span> <span class="comment">// Make room for OOM message type.</span></span><br><span class="line">      ..[<span class="number">1</span>] = _PING</span><br><span class="line">      ..[<span class="number">2</span>] = responsePort</span><br><span class="line">      ..[<span class="number">3</span>] = priority</span><br><span class="line">      ..[<span class="number">4</span>] = response;</span><br><span class="line">    _sendOOB(controlPort, msg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">"vm:external-name"</span>, <span class="string">"Isolate_sendOOB"</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="keyword">void</span> _sendOOB(port, msg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime/lib/isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºäº†ä¸€ä¸ªoobæ¶ˆæ¯å¹¶å‹å…¥oob_queue_</span></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_sendOOB, <span class="number">0</span>, <span class="number">2</span>) &#123;</span><br><span class="line">  GET_NON_NULL_NATIVE_ARGUMENT(SendPort, port, arguments-&gt;NativeArgAt(<span class="number">0</span>));</span><br><span class="line">  GET_NON_NULL_NATIVE_ARGUMENT(Array, msg, arguments-&gt;NativeArgAt(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure to route this request to the isolate library OOB mesage handler.</span></span><br><span class="line">  msg.SetAt(<span class="number">0</span>, Smi::Handle(Smi::New(Message::kIsolateLibOOBMsg)));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ensure message writer (and it's resources, e.g. forwarding tables) are</span></span><br><span class="line">  <span class="comment">// cleaned up before handling interrupts.</span></span><br><span class="line">  &#123;</span><br><span class="line">    PortMap::PostMessage(WriteMessage(<span class="comment">/* can_send_any_object */</span> <span class="keyword">false</span>,</span><br><span class="line">                                      <span class="comment">/* same_group */</span> <span class="keyword">false</span>, msg, port.Id(),</span><br><span class="line">                                      Message::kOOBPriority));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Drain interrupts before running so any IMMEDIATE operations on the current</span></span><br><span class="line">  <span class="comment">// isolate happen synchronously.</span></span><br><span class="line">  <span class="keyword">const</span> Error&amp; error = Error::Handle(thread-&gt;HandleInterrupts());</span><br><span class="line">  <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">    Exceptions::PropagateError(error);</span><br><span class="line">    UNREACHABLE();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨MessageHandlerä¸­æœ‰ä¸¤ç§MessageQueueï¼š<code>oob_queue_</code>å’Œ<code>queue_</code> ï¼Œå‰è€…ä¼˜å…ˆçº§é«˜ï¼Œå³ä½¿isolateè¢«pauseä¹Ÿä¼šæ‰§è¡Œ</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ™®é€šæ¶ˆæ¯ï¼Œæš‚åœæ—¶ä¸èƒ½å¤„ç†</span></span><br><span class="line">MessageQueue* queue_;</span><br><span class="line"><span class="comment">// ä¼˜å…ˆæ¶ˆæ¯ï¼Œå³ä½¿å¤„ç†æ¶ˆæ¯æ—¶ï¼Œä¼˜å…ˆå¤„ç†obb_queueæ¶ˆæ¯ï¼Œå¦‚æœä¸ºç©ºå†å»è€ƒè™‘å¤„ç†æ™®é€šæ¶ˆæ¯</span></span><br><span class="line"><span class="comment">// å³ä½¿isolateè¢«pauseä¹Ÿå¯ä»¥è¢«å¤„ç†</span></span><br><span class="line">MessageQueue* oob_queue_;</span><br></pre></td></tr></table></figure><p>åƒæ˜¯<code>ping</code>/<code>kill</code>/<code>pause</code>/<code>addOnExitListener</code>/<code>removeOnExitListener</code>è¿™äº›æŒ‡ä»¤æ¶ˆæ¯éƒ½æ˜¯å‹å…¥åˆ°<code>obb_queue_</code>ä¸­ä¼˜å…ˆå¤„ç†çš„ã€‚</p><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><p>å…ˆçœ‹ä¸€ä¸‹å¸¸ç”¨çš„å‡ ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><h2 id="è·å–å½“å‰Isolate"><a href="#è·å–å½“å‰Isolate" class="headerlink" title="è·å–å½“å‰Isolate"></a>è·å–å½“å‰Isolate</h2><p>ï¼ˆ<em>sdk/lib/isolate/isolate.dart</em>ï¼‰<code>Isolate.current</code> â†’</p><p>  (<em>sdk/lib/_internal/vm/lib/isolate_patch.dart</em>) <code>Isolate get current</code>  â†’ <code>Isolate._getCurrentIsolate()</code> â†’ <code>_getPortAndCapabilitiesOfCurrentIsolate()</code></p><p>ï¼ˆ<em>runtime/lib/isolate.cc</em>ï¼‰<code>DEFINE_NATIVE_ENTRY(Isolate_getPortAndCapabilitiesOfCurrentIsolate, 0, 0)</code></p><p>å…ˆçœ‹ä¸€ä¸‹<em>sdk/lib/_internal/vm/lib/isolate_patch.dart</em>ä¸­çš„å®ç°ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> _currentIsolate = _getCurrentIsolate();</span><br><span class="line"><span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Isolate <span class="keyword">get</span> current =&gt; _currentIsolate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Isolate _getCurrentIsolate() &#123;</span><br><span class="line">    <span class="built_in">List</span> portAndCapabilities = _getPortAndCapabilitiesOfCurrentIsolate();</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„å‚æ•°åˆ†åˆ«æ˜¯SendPortï¼ŒCapabilityï¼ŒCapability</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Isolate(portAndCapabilities[<span class="number">0</span>],</span><br><span class="line">        pauseCapability: portAndCapabilities[<span class="number">1</span>],</span><br><span class="line">        terminateCapability: portAndCapabilities[<span class="number">2</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@pragma</span>(<span class="string">"vm:external-name"</span>, <span class="string">"Isolate_getPortAndCapabilitiesOfCurrentIsolate"</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="built_in">List</span> _getPortAndCapabilitiesOfCurrentIsolate();</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åæ˜¯æ ¹æ®nativeç«¯è¿”å›çš„ä¿¡æ¯ï¼Œæ–°å»ºäº†ä¸€ä¸ªIsolateå¼•ç”¨ï¼Œä½†æ˜¯å› ä¸º<code>_currentIsolate</code>æ˜¯<code>static final</code>çš„ï¼Œæ‰€ä»¥åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿äº†åœ¨Dart SDKä¸­è°ƒç”¨<code>Isolate.current</code> æ—¶è·å–çš„æ˜¯å½“å‰å”¯ä¸€çš„Isolateã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨nativeä¸­æ˜¯å¦‚ä½•æ‰¾åˆ°å½“å‰çš„Isolateçš„ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; \runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_getPortAndCapabilitiesOfCurrentIsolate, <span class="number">0</span>, <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> Array&amp; result = Array::Handle(Array::New(<span class="number">3</span>));</span><br><span class="line">  result.SetAt(<span class="number">0</span>, SendPort::Handle(SendPort::New(isolate-&gt;main_port())));</span><br><span class="line">  result.SetAt(</span><br><span class="line">      <span class="number">1</span>, Capability::Handle(Capability::New(isolate-&gt;pause_capability())));</span><br><span class="line">  result.SetAt(</span><br><span class="line">      <span class="number">2</span>, Capability::Handle(Capability::New(isolate-&gt;terminate_capability())));</span><br><span class="line">  <span class="keyword">return</span> result.ptr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§æ˜¯ç›´æ¥å–çš„<strong>å½“å‰çº¿ç¨‹å¯¹åº”çš„isolate</strong>å¯¹åº”çš„å€¼ï¼Œç»è¿‡åŒ…è£…å†è¿”å›åˆ°è°ƒç”¨æ–¹ã€‚</p><h2 id="åˆ›å»ºIsolate"><a href="#åˆ›å»ºIsolate" class="headerlink" title="åˆ›å»ºIsolate"></a>åˆ›å»ºIsolate</h2><p>åœ¨Dartä¸­åˆ›å»ºIsolateæœ‰3ç§æ–¹å¼ï¼š</p><ul><li><code>Isolate(this.controlPort, {this.pauseCapability, this.terminateCapability});</code>  <strong>*create</strong> an<em> </em>isolateï¼Œæœ¬è´¨ä¸Šåªæ˜¯å°†*<code>controlPort</code> ç­‰è®¾ç½®ä¸ºä¼ å…¥çš„å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰åœ¨nativeå±‚æ–°å»ºIsolate</li><li><code>Isolate.spawn</code>  <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li><li><code>Isolate.spawnUri</code>  <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li></ul><p><img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri.png" alt></p><p>è¿™é‡Œåˆ†æä¸€ä¸‹åé¢ä¸¤ç§æ–¹å¼ï¼Œå¯¹æ¯”ä¸€ä¸‹å·®å¼‚ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\isolate\isolate.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates a new [Isolate] object with a restricted set of capabilities.</span></span><br><span class="line">Isolate(<span class="keyword">this</span>.controlPort, &#123;<span class="keyword">this</span>.pauseCapability, <span class="keyword">this</span>.terminateCapability&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Creates and spawns an isolate that shares the same code as the current</span></span><br><span class="line"><span class="comment">/// isolate.</span></span><br><span class="line"><span class="keyword">external</span> <span class="keyword">static</span> Future&lt;Isolate&gt; spawn&lt;T&gt;(</span><br><span class="line">      <span class="keyword">void</span> entryPoint(T message), T message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="meta">@Since</span>(<span class="string">"2.3"</span>) <span class="built_in">String</span>? debugName&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Creates and spawns an isolate that runs the code from the library with</span></span><br><span class="line">  <span class="comment">/// the specified URI.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The isolate starts executing the top-level `main` function of the library</span></span><br><span class="line">  <span class="comment">/// with the given URI.</span></span><br><span class="line"><span class="keyword">external</span> <span class="keyword">static</span> Future&lt;Isolate&gt; spawnUri(</span><br><span class="line">      <span class="built_in">Uri</span> uri,</span><br><span class="line">      <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args,</span><br><span class="line">      <span class="keyword">var</span> message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      <span class="built_in">bool</span>? checked,</span><br><span class="line">      <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;? environment,</span><br><span class="line">      <span class="meta">@Deprecated</span>(<span class="string">'The packages/ dir is not supported in Dart 2'</span>)</span><br><span class="line">          <span class="built_in">Uri</span>? packageRoot,</span><br><span class="line">      <span class="built_in">Uri</span>? packageConfig,</span><br><span class="line">      <span class="built_in">bool</span> automaticPackageResolution = <span class="keyword">false</span>,</span><br><span class="line">      <span class="meta">@Since</span>(<span class="string">"2.3"</span>)</span><br><span class="line">          <span class="built_in">String</span>? debugName&#125;);</span><br></pre></td></tr></table></figure><p>å¯¹äºAPPç­‰æ¥è¯´ï¼Œä¸Šè¿°<code>Isolate.spawn</code>å’Œ<code>Isolate.spawnUri</code>çš„å®ç°éƒ½åœ¨<code>vm</code>ä¸‹é¢çš„<code>isolate_patch.dart</code>ä¸­ï¼ˆjsä¼šè¿”å›<code>_unsupported()</code>ï¼‰ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\_internal\vm\lib\isolate_patch.dart</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;Isolate&gt; spawn&lt;T&gt;(<span class="keyword">void</span> entryPoint(T message), T message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">String</span>? debugName&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">// `paused` isn't handled yet.</span></span><br><span class="line">    <span class="comment">// Check for the type of `entryPoint` on the spawning isolate to make</span></span><br><span class="line">    <span class="comment">// error-handling easier.</span></span><br><span class="line">    <span class="keyword">if</span> (entryPoint <span class="keyword">is</span>! _UnaryFunction) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentError(entryPoint);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The VM will invoke [_startIsolate] with entryPoint as argument.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// We do not inherit the package config settings from the parent isolate,</span></span><br><span class="line">    <span class="comment">// instead we use the values that were set on the command line.</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> RawReceivePort readyPort =</span><br><span class="line">        <span class="keyword">new</span> RawReceivePort(<span class="keyword">null</span>, <span class="string">'Isolate.spawn ready'</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      **_spawnFunction**(readyPort.sendPort, script.toString(), entryPoint, message,</span><br><span class="line">          paused, errorsAreFatal, onExit, onError, packageConfig, debugName);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> **_spawnCommon**(readyPort);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e, st) &#123;</span><br><span class="line">      readyPort.close();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> Future&lt;Isolate&gt;.error(e, st);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;Isolate&gt; spawnUri(<span class="built_in">Uri</span> uri, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args, <span class="keyword">var</span> message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      <span class="built_in">bool</span>? checked,</span><br><span class="line">      <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;? environment,</span><br><span class="line">      <span class="built_in">Uri</span>? packageRoot,</span><br><span class="line">      <span class="built_in">Uri</span>? packageConfig,</span><br><span class="line">      <span class="built_in">bool</span> automaticPackageResolution = <span class="keyword">false</span>,</span><br><span class="line">      <span class="built_in">String</span>? debugName&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify that no mutually exclusive arguments have been passed.</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment">// Resolve the uri against the current isolate's root Uri first.</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The VM will invoke [_startIsolate] and not `main`.</span></span><br><span class="line">    <span class="keyword">final</span> packageConfigString = packageConfig?.toString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> RawReceivePort readyPort =</span><br><span class="line">        <span class="keyword">new</span> RawReceivePort(<span class="keyword">null</span>, <span class="string">'Isolate.spawnUri ready'</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      **_spawnUri**(</span><br><span class="line">          readyPort.sendPort,</span><br><span class="line">          spawnedUri.toString(),</span><br><span class="line">          args,</span><br><span class="line">          message,</span><br><span class="line">          paused,</span><br><span class="line">          onExit,</span><br><span class="line">          onError,</span><br><span class="line">          errorsAreFatal,</span><br><span class="line">          checked,</span><br><span class="line">          <span class="keyword">null</span>,</span><br><span class="line">          <span class="comment">/* environment */</span></span><br><span class="line">          packageConfigString,</span><br><span class="line">          debugName);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> **_spawnCommon**(readyPort);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      readyPort.close();</span><br><span class="line">      <span class="keyword">rethrow</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  Isolate.spawn call</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">"vm:external-name"</span>, <span class="string">"Isolate_spawnFunction"</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="keyword">void</span> _spawnFunction(</span><br><span class="line">      SendPort readyPort,</span><br><span class="line">      <span class="built_in">String</span> uri,</span><br><span class="line">      <span class="built_in">Function</span> topLevelFunction,</span><br><span class="line">      <span class="keyword">var</span> message,</span><br><span class="line">      <span class="built_in">bool</span> paused,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">String</span>? packageConfig,</span><br><span class="line">      <span class="built_in">String</span>? debugName);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  Isolate.spawnUri call</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">"vm:external-name"</span>, <span class="string">"Isolate_spawnUri"</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="keyword">void</span> _spawnUri(</span><br><span class="line">      SendPort readyPort,</span><br><span class="line">      <span class="built_in">String</span> uri,</span><br><span class="line">      <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args,</span><br><span class="line">      <span class="keyword">var</span> message,</span><br><span class="line">      <span class="built_in">bool</span> paused,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal,</span><br><span class="line">      <span class="built_in">bool</span>? checked,</span><br><span class="line">      <span class="built_in">List</span>? environment,</span><br><span class="line">      <span class="built_in">String</span>? packageConfig,</span><br><span class="line">      <span class="built_in">String</span>? debugName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬Isolate spawnçŠ¶æ€ï¼Œç­‰æˆåŠŸä¹‹åå°†å…¶å¤„ç†åè¿”å›ç»™Dartå±‚çš„è°ƒç”¨è€…</span></span><br><span class="line"><span class="keyword">static</span> Future&lt;Isolate&gt; _spawnCommon(RawReceivePort readyPort) &#123;</span><br><span class="line">    <span class="keyword">final</span> completer = <span class="keyword">new</span> Completer&lt;Isolate&gt;.<span class="keyword">sync</span>();</span><br><span class="line">    readyPort.handler = (readyMessage) &#123;</span><br><span class="line">      readyPort.close();</span><br><span class="line">      <span class="keyword">if</span> (readyMessage <span class="keyword">is</span> <span class="built_in">List</span> &amp;&amp; readyMessage.length == <span class="number">2</span>) &#123;</span><br><span class="line">        SendPort controlPort = readyMessage[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">List</span> capabilities = readyMessage[<span class="number">1</span>];</span><br><span class="line">        **completer.complete(<span class="keyword">new</span> Isolate(controlPort,</span><br><span class="line">            pauseCapability: capabilities[<span class="number">0</span>],</span><br><span class="line">            terminateCapability: capabilities[<span class="number">1</span>]));**</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readyMessage <span class="keyword">is</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">        <span class="comment">// We encountered an error while starting the new isolate.</span></span><br><span class="line">        completer.completeError(<span class="keyword">new</span> IsolateSpawnException(</span><br><span class="line">            <span class="string">'Unable to spawn isolate: <span class="subst">$&#123;readyMessage&#125;</span>'</span>));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This shouldn't happen.</span></span><br><span class="line">        completer.completeError(<span class="keyword">new</span> IsolateSpawnException(</span><br><span class="line">            <span class="string">"Internal error: unexpected format for ready message: "</span></span><br><span class="line">            <span class="string">"'<span class="subst">$&#123;readyMessage&#125;</span>'"</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œæ ¹æ®ä¸Šè¿°çš„ä»£ç ï¼Œä¸ç®¡æ˜¯<code>Isolate.spawnUri()</code> è¿˜æ˜¯<code>Isolate.spawn</code>ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨<code>RawReceivePort</code>è·å–<code>RawReceivePort readyPort</code>ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨äº†<code>_spawnCommon(readyPort)</code> æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡<code>new Isolate(controlPort, pauseCapability: capabilities[0], terminateCapability: capabilities[1])</code>æ–¹æ³•åˆ›å»ºäº†æ–°çš„<code>Isolate</code> ã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰åœ¨<code>sdk/lib/isolate/isolate.dart</code>ä¸­ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk/lib/isolate/isolate.dart</span></span><br><span class="line"><span class="keyword">final</span> SendPort controlPort;</span><br><span class="line"></span><br><span class="line">Isolate(<span class="keyword">this</span>.controlPort, &#123;<span class="keyword">this</span>.pauseCapability, <span class="keyword">this</span>.terminateCapability&#125;);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Dartä¸­ï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„Isolateä¸»è¦æ˜¯<strong>æŒæœ‰ä¸€ä¸ªå’Œnativeä¸­å¯¹åº”SendPort</strong>ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼š</p><ul><li><code>Isolate.spawn</code>æœ€åè°ƒç”¨äº†<code>_spawnFunction</code>æ–¹æ³•ï¼ˆnativeå±‚å®ç°ä¸º<code>Isolate_spawnFunction</code>ï¼‰ï¼›</li><li><code>Isolate.spawnUri</code>æœ€åè°ƒç”¨äº†<code>_spawnUri</code>æ–¹æ³•ï¼ˆnativeå±‚å®ç°ä¸º<code>Isolate_spawnUri</code>ï¼‰ã€‚</li></ul><blockquote><p>ğŸ’¡ <code>new RawReceivePort()</code>æ–¹æ³•ä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ªä¸å­˜åœ¨äº<code>_RawReceivePortImpl</code>çš„<code>static final _portMap = &lt;int, Map&lt;String, dynamic&gt;&gt;{};</code> ä¸­çš„SendPortï¼ˆå…·ä½“å®ç°åœ¨<code>PortMap::CreatePort</code>ä¸­ï¼‰ã€‚</p></blockquote><h3 id="Isolate-spawnFunction"><a href="#Isolate-spawnFunction" class="headerlink" title="Isolate_spawnFunction"></a>Isolate_spawnFunction</h3><p><code>Isolate.spawn</code>æœ€åè°ƒç”¨äº†<code>_spawnFunction</code>æ–¹æ³•ï¼Œæ¥çœ‹ä¸€ä¸‹å¯¹åº”çš„<code>Isolate_spawnFunction</code> çš„å®ç°ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_spawnFunction, <span class="number">0</span>, <span class="number">10</span>) &#123;</span><br><span class="line"><span class="comment">// è§£æå‚æ•°</span></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// closure_tuple_handleå¯¹åº”æˆ‘ä»¬åœ¨Dartä¸­Isolate.spawn()ä¸­ä¼ å…¥çš„entryPoint</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå°±æ˜¯isolateåˆ›å»ºå¥½ä»¥åæ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  std::unique_ptr&lt;IsolateSpawnState&gt; state(<span class="keyword">new</span> IsolateSpawnState(</span><br><span class="line">      port.Id(), isolate-&gt;origin_id(), String2UTF8(script_uri),</span><br><span class="line">      closure_tuple_handle, &amp;message_buffer, utf8_package_config,</span><br><span class="line">      paused.value(), fatal_errors, on_exit_port, on_error_port,</span><br><span class="line">      utf8_debug_name, **isolate-&gt;group()**));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since this is a call to Isolate.spawn, copy the parent isolate's code.</span></span><br><span class="line">  state-&gt;isolate_flags()-&gt;copy_parent_code = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  **isolate-&gt;group()**-&gt;thread_pool()-&gt;Run&lt;SpawnIsolateTask&gt;(isolate,</span><br><span class="line">                                                         std::move(state));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œ<code>Isolate_spawnFunction</code>æ–¹æ³•ä¸­ä¸»è¦è¿˜æ˜¯è§£ææ”¶åˆ°çš„å„ç§å‚æ•°ï¼Œæœ€ååœ¨å½“å‰isolateå¯¹åº”çš„IsolateGroupçš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œ<code>SpawnIsolateTask</code>ï¼š</p><h4 id="SpawnIsolateTask"><a href="#SpawnIsolateTask" class="headerlink" title="SpawnIsolateTask"></a>SpawnIsolateTask</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpawnIsolateTask</span> : <span class="title">public</span> <span class="title">ThreadPool</span>::<span class="title">Task</span> </span>&#123;</span><br><span class="line">SpawnIsolateTask(Isolate* parent_isolate,</span><br><span class="line">                   std::unique_ptr&lt;IsolateSpawnState&gt; state)</span><br><span class="line">      : parent_isolate_(parent_isolate), state_(std::move(state)) &#123;</span><br><span class="line">    parent_isolate-&gt;IncrementSpawnCount();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Run() override &#123;</span><br><span class="line">    <span class="keyword">const</span> char* name = (state_-&gt;debug_name() == nullptr)</span><br><span class="line">                           ? state_-&gt;function_name()</span><br><span class="line">                           : state_-&gt;debug_name();</span><br><span class="line">    ASSERT(name != nullptr);</span><br><span class="line"></span><br><span class="line">    auto group = state_-&gt;isolate_group();</span><br><span class="line">    <span class="keyword">if</span> (group == nullptr) &#123;</span><br><span class="line">      RunHeavyweight(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      RunLightweight(name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RunLightWeight"><a href="#RunLightWeight" class="headerlink" title="RunLightWeight"></a>RunLightWeight</h4><p>å› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„<code>isolateâ†’group</code>ä¸ä¸ºç©ºï¼Œæ‰€ä»¥èµ°çš„æ˜¯<code>RunLightWeight</code>:</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RunLightweight(<span class="keyword">const</span> char* name) &#123;</span><br><span class="line">    <span class="comment">// The create isolate initialize callback is mandatory.</span></span><br><span class="line">    auto initialize_callback = **Isolate::InitializeCallback();**</span><br><span class="line">    <span class="keyword">if</span> (initialize_callback == nullptr) &#123;</span><br><span class="line">      FailedSpawn(</span><br><span class="line">          <span class="string">"Lightweight isolate spawn is not supported by this Dart embedder\n"</span>,</span><br><span class="line">          <span class="comment">/*has_current_isolate=*/</span><span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char* error = nullptr;</span><br><span class="line"></span><br><span class="line">    auto group = state_-&gt;isolate_group();</span><br><span class="line">    **Isolate* isolate = CreateWithinExistingIsolateGroup(group, name, &amp;error);**</span><br><span class="line">    parent_isolate_-&gt;DecrementSpawnCount();</span><br><span class="line">    parent_isolate_ = nullptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolate == nullptr) &#123;</span><br><span class="line">      FailedSpawn(error, <span class="comment">/*has_current_isolate=*/</span><span class="keyword">false</span>);</span><br><span class="line">      free(error);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* child_isolate_data = nullptr;</span><br><span class="line">    **<span class="keyword">const</span> <span class="built_in">bool</span> success = initialize_callback(&amp;child_isolate_data, &amp;error);**</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">      FailedSpawn(error);</span><br><span class="line">      Dart_ShutdownIsolate();</span><br><span class="line">      free(error);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    **isolate-&gt;set_init_callback_data(child_isolate_data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œçš„Runæ–¹æ³•ï¼Œåœ¨**RunHeavyweightæ–¹æ³•çš„æœ€åä¹Ÿè°ƒç”¨äº†</span></span><br><span class="line">    <span class="comment">// åˆ°æ—¶å€™ä¼šä¸€èµ·åˆ†æä¸€ä¸‹</span></span><br><span class="line">    **Run(isolate);**</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line">Isolate* CreateWithinExistingIsolateGroup(IsolateGroup* group,</span><br><span class="line">                                          <span class="keyword">const</span> char* name,</span><br><span class="line">                                          char** error) &#123;</span><br><span class="line">  API_TIMELINE_DURATION(Thread::Current());</span><br><span class="line">  CHECK_NO_ISOLATE(Isolate::Current());</span><br><span class="line"></span><br><span class="line">  auto spawning_group = group;</span><br><span class="line"></span><br><span class="line">  **Isolate* isolate =** reinterpret_cast&lt;Isolate*&gt;(</span><br><span class="line">      **CreateIsolate**(spawning_group, <span class="comment">/*is_new_group=*/</span><span class="keyword">false</span>, name,</span><br><span class="line">                    <span class="comment">/*isolate_data=*/</span>nullptr, error));</span><br><span class="line">  <span class="keyword">if</span> (isolate == nullptr) <span class="keyword">return</span> nullptr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å› ä¸ºæ‰§è¡Œåˆ°è¿™é‡Œçš„éƒ½æœ‰IsolateGroupï¼Œå…±äº«åŒä¸€ä»½ä»£ç </span></span><br><span class="line">  auto source = spawning_group-&gt;source();</span><br><span class="line">  ASSERT(isolate-&gt;source() == source);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦è¿›è¡Œäº†2æ­¥ï¼š</p><ul><li>ä½¿ç”¨<code>CreateWithinExistingIsolateGroup</code>åˆ›å»ºIsolate</li><li>ä½¿ç”¨å…¨å±€çš„<code>initialize_callback</code> ï¼ˆä¹Ÿå°±æ˜¯<code>Isolate::InitializeCallback()</code>ï¼‰åˆå§‹åŒ–Isolate</li></ul><h5 id="Isolate-InitializeCallback"><a href="#Isolate-InitializeCallback" class="headerlink" title="Isolate::InitializeCallback()"></a>Isolate::InitializeCallback()</h5><p>è¿™å…¶ä¸­çš„<code>Isolate::InitializeCallback()</code>æ˜¯åœ¨<code>Dart::Init</code>çš„æ—¶å€™å°±å·²ç»è®¾ç½®äº†çš„ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime/bin/main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main(<span class="built_in">int</span> argc, char** argv) &#123;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// Initialize the Dart VM.</span></span><br><span class="line">  Dart_InitializeParams init_params;</span><br><span class="line">init_params.version = DART_INITIALIZE_PARAMS_CURRENT_VERSION;</span><br><span class="line">  init_params.vm_snapshot_data = vm_snapshot_data;</span><br><span class="line">  init_params.vm_snapshot_instructions = vm_snapshot_instructions;</span><br><span class="line">  **init_params.create_group = CreateIsolateGroupAndSetup;**</span><br><span class="line">  **init_params.initialize_isolate = OnIsolateInitialize;**</span><br><span class="line">  init_params.shutdown_isolate = OnIsolateShutdown;</span><br><span class="line">  init_params.cleanup_isolate = DeleteIsolateData;</span><br><span class="line">  init_params.cleanup_group = DeleteIsolateGroupData;</span><br><span class="line">  init_params.file_open = DartUtils::OpenFile;</span><br><span class="line">  init_params.file_read = DartUtils::ReadFile;</span><br><span class="line">  init_params.file_write = DartUtils::WriteFile;</span><br><span class="line">  init_params.file_close = DartUtils::CloseFile;</span><br><span class="line">  init_params.entropy_source = DartUtils::EntropySource;</span><br><span class="line"></span><br><span class="line">error = Dart_Initialize(&amp;init_params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line">DART_EXPORT char* Dart_Initialize(Dart_InitializeParams* params) &#123;</span><br><span class="line">  <span class="keyword">if</span> (params == NULL) &#123;</span><br><span class="line">    <span class="keyword">return</span> Utils::StrDup(</span><br><span class="line">        <span class="string">"Dart_Initialize: "</span></span><br><span class="line">        <span class="string">"Dart_InitializeParams is null."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (params-&gt;version != DART_INITIALIZE_PARAMS_CURRENT_VERSION) &#123;</span><br><span class="line">    <span class="keyword">return</span> Utils::StrDup(</span><br><span class="line">        <span class="string">"Dart_Initialize: "</span></span><br><span class="line">        <span class="string">"Invalid Dart_InitializeParams version."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Dart::Init(params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\dart.cc</span></span><br><span class="line"></span><br><span class="line">char* Dart::Init(<span class="keyword">const</span> Dart_InitializeParams* params) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!init_state_.SetInitializing()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Utils::StrDup(</span><br><span class="line">        <span class="string">"Bad VM initialization state, "</span></span><br><span class="line">        <span class="string">"already initialized or "</span></span><br><span class="line">        <span class="string">"multiple threads initializing the VM."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  char* retval = DartInit(params);</span><br><span class="line">  <span class="keyword">if</span> (retval != NULL) &#123;</span><br><span class="line">    init_state_.ResetInitializing();</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line">  init_state_.SetInitialized();</span><br><span class="line">  <span class="keyword">return</span> NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">char* Dart::DartInit(<span class="keyword">const</span> Dart_InitializeParams* params) &#123;</span><br><span class="line">...</span><br><span class="line">OSThread::Init();</span><br><span class="line">  Zone::Init();</span><br><span class="line">IsolateGroup::Init();</span><br><span class="line">  Isolate::InitVM();</span><br><span class="line">PortMap::Init();</span><br><span class="line">  Service::Init();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Thread::ExitIsolate();  <span class="comment">// Unregister the VM isolate from this thread.</span></span><br><span class="line">  **Isolate::SetCreateGroupCallback(params-&gt;create_group);**</span><br><span class="line">  **Isolate::SetInitializeCallback_(params-&gt;initialize_isolate);**</span><br><span class="line">  Isolate::SetShutdownCallback(params-&gt;shutdown_isolate);</span><br><span class="line">  Isolate::SetCleanupCallback(params-&gt;cleanup_isolate);</span><br><span class="line">  Isolate::SetGroupCleanupCallback(params-&gt;cleanup_group);</span><br><span class="line">  Isolate::SetRegisterKernelBlobCallback(params-&gt;register_kernel_blob);</span><br><span class="line">  Isolate::SetUnregisterKernelBlobCallback(params-&gt;unregister_kernel_blob);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šæ–‡çš„<code>Isolate::InitializeCallback()</code>å®é™…ä¸Šå°±æ˜¯<code>OnIsolateInitialize</code>ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯åœ¨isolateåˆ›å»ºå¥½ä¹‹åè¿›è¡Œç»Ÿä¸€çš„åˆå§‹åŒ–æ“ä½œï¼Œç»‘å®šä¸€äº›æ•°æ®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">OnIsolateInitialize</span><span class="params">(<span class="keyword">void</span>** child_callback_data, <span class="keyword">char</span>** error)</span> </span>&#123;</span><br><span class="line">  Dart_Isolate isolate = Dart_CurrentIsolate();</span><br><span class="line">  ASSERT(isolate != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> isolate_group_data =</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;IsolateGroupData*&gt;(Dart_CurrentIsolateGroupData());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> isolate_data = <span class="keyword">new</span> IsolateData(isolate_group_data);</span><br><span class="line">  *child_callback_data = isolate_data;</span><br><span class="line"></span><br><span class="line">  Dart_EnterScope();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> **script_uri** = isolate_group_data-&gt;script_url;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> **isolate_run_app_snapshot** =</span><br><span class="line">      isolate_group_data-&gt;RunFromAppSnapshot();</span><br><span class="line">  Dart_Handle **result** = SetupCoreLibraries(isolate, isolate_data,</span><br><span class="line">                                          <span class="comment">/*group_start=*/</span><span class="literal">false</span>,</span><br><span class="line">                                          <span class="comment">/*resolved_packages_config=*/</span><span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsError(result)) <span class="keyword">goto</span> failed;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isolate_run_app_snapshot) &#123;</span><br><span class="line">    result = Loader::InitForSnapshot(script_uri, isolate_data);</span><br><span class="line">    <span class="keyword">if</span> (Dart_IsError(result)) <span class="keyword">goto</span> failed;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result = DartUtils::ResolveScript(Dart_NewStringFromCString(script_uri));</span><br><span class="line">    <span class="keyword">if</span> (Dart_IsError(result)) <span class="keyword">goto</span> failed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolate_group_data-&gt;kernel_buffer() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="comment">// Various core-library parts will send requests to the Loader to resolve</span></span><br><span class="line">      <span class="comment">// relative URIs and perform other related tasks. We need Loader to be</span></span><br><span class="line">      <span class="comment">// initialized for this to work because loading from Kernel binary</span></span><br><span class="line">      <span class="comment">// bypasses normal source code loading paths that initialize it.</span></span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">char</span>* resolved_script_uri = <span class="literal">NULL</span>;</span><br><span class="line">      result = Dart_StringToCString(result, &amp;resolved_script_uri);</span><br><span class="line">      <span class="keyword">if</span> (Dart_IsError(result)) <span class="keyword">goto</span> failed;</span><br><span class="line">      result = Loader::InitForSnapshot(resolved_script_uri, isolate_data);</span><br><span class="line">      <span class="keyword">if</span> (Dart_IsError(result)) <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Dart_ExitScope();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">  *error = Utils::StrDup(Dart_GetError(result));</span><br><span class="line">  Dart_ExitScope();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="CreateWithinExistingIsolateGroup"><a href="#CreateWithinExistingIsolateGroup" class="headerlink" title="CreateWithinExistingIsolateGroup"></a>CreateWithinExistingIsolateGroup</h5><p><code>CreateWithinExistingIsolateGroup</code> â†’ <code>CreateIsolate</code></p><p>å†çœ‹ä¸€ä¸‹åˆ›å»ºIsolateçš„å…·ä½“æ–¹æ³•ï¼Œè¿™ä¸ªåœ¨ä¸åŒçš„deviceä¸Šé¢ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åªå…³æ³¨vmä¸‹é¢çš„å®ç°ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Dart_Isolate CreateIsolate(IsolateGroup* group,</span><br><span class="line">                                  <span class="built_in">bool</span> is_new_group,</span><br><span class="line">                                  <span class="keyword">const</span> char* name,</span><br><span class="line">                                  <span class="keyword">void</span>* isolate_data,</span><br><span class="line">                                  char** error) &#123;</span><br><span class="line">  **CHECK_NO_ISOLATE**(Isolate::Current());</span><br><span class="line"></span><br><span class="line">  auto source = group-&gt;source();</span><br><span class="line">  **Isolate* I = Dart::CreateIsolate(name, source-&gt;flags, group);**</span><br><span class="line">  <span class="keyword">if</span> (I == NULL) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error != NULL) &#123;</span><br><span class="line">      *error = Utils::StrDup(<span class="string">"Isolate creation failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> reinterpret_cast&lt;Dart_Isolate&gt;(NULL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Thread* T = Thread::Current();</span><br><span class="line">  <span class="built_in">bool</span> success = <span class="keyword">false</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    StackZone zone(T);</span><br><span class="line">    <span class="comment">// We enter an API scope here as InitializeIsolate could compile some</span></span><br><span class="line">    <span class="comment">// bootstrap library files which call out to a tag handler that may create</span></span><br><span class="line">    <span class="comment">// Api Handles when an error is encountered.</span></span><br><span class="line">    T-&gt;EnterApiScope();</span><br><span class="line">    <span class="keyword">const</span> Error&amp; error_obj = Error::Handle(</span><br><span class="line">        Z, **Dart::InitializeIsolate(</span><br><span class="line">               source-&gt;snapshot_data, source-&gt;snapshot_instructions,</span><br><span class="line">               source-&gt;kernel_buffer, source-&gt;kernel_buffer_size,</span><br><span class="line">               is_new_group ? nullptr : group, isolate_data)**);</span><br><span class="line">    <span class="keyword">if</span> (error_obj.IsNull()) &#123;</span><br><span class="line">#<span class="keyword">if</span> defined(DEBUG) &amp;&amp; !defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">      <span class="keyword">if</span> (FLAG_check_function_fingerprints &amp;&amp; !FLAG_precompiled_mode) &#123;</span><br><span class="line">        Library::CheckFunctionFingerprints();</span><br><span class="line">      &#125;</span><br><span class="line">#endif  <span class="comment">// defined(DEBUG) &amp;&amp; !defined(DART_PRECOMPILED_RUNTIME).</span></span><br><span class="line">      success = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error != NULL) &#123;</span><br><span class="line">      *error = Utils::StrDup(error_obj.ToErrorCString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We exit the API scope entered above.</span></span><br><span class="line">    T-&gt;ExitApiScope();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (success) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_new_group) &#123;</span><br><span class="line">      group-&gt;heap()-&gt;InitGrowthControl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// A Thread structure has been associated to the thread, we do the</span></span><br><span class="line">    <span class="comment">// safepoint transition explicitly here instead of using the</span></span><br><span class="line">    <span class="comment">// TransitionXXX scope objects as the reverse transition happens</span></span><br><span class="line">    <span class="comment">// outside this scope in Dart_ShutdownIsolate/Dart_ExitIsolate.</span></span><br><span class="line">    T-&gt;set_execution_state(Thread::kThreadInNative);</span><br><span class="line">    T-&gt;EnterSafepoint();</span><br><span class="line">    <span class="keyword">if</span> (error != NULL) &#123;</span><br><span class="line">      *error = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Api::CastIsolate(I);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Dart::ShutdownIsolate();</span><br><span class="line">  <span class="keyword">return</span> reinterpret_cast&lt;Dart_Isolate&gt;(NULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æœ‰ä¸¤æ­¥ï¼š</p><ul><li><code>Dart::CreateIsolate</code>åˆ›å»ºäº†<code>Isolate* I</code>ï¼›</li><li>ç„¶åè°ƒç”¨<code>Dart::InitializeIsolate</code>åˆå§‹åŒ–isolateã€‚</li></ul><p><strong>Dart::CreateIsolateï¼š</strong></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart.cc</span></span><br><span class="line"></span><br><span class="line">Isolate* Dart::CreateIsolate(<span class="keyword">const</span> char* name_prefix,</span><br><span class="line">                             <span class="keyword">const</span> Dart_IsolateFlags&amp; api_flags,</span><br><span class="line">                             IsolateGroup* isolate_group) &#123;</span><br><span class="line">  <span class="comment">// Create a new isolate.</span></span><br><span class="line">  Isolate* isolate =</span><br><span class="line">      Isolate::InitIsolate(name_prefix, isolate_group, api_flags);</span><br><span class="line">  <span class="keyword">return</span> isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ’¡ åœ¨Dartè™šæ‹Ÿæœºå¯åŠ¨ï¼ˆ<code>Dart::DartInit</code>ï¼‰çš„æ—¶å€™ï¼Œä¹Ÿä¼šè°ƒç”¨<code>Dart::InitIsolate</code>åˆ›å»ºè™šæ‹Ÿæœºå¯¹åº”çš„Isolateï¼Œæ‰§è¡ŒUIæ“ä½œï¼š<br><code>vm_isolate_ = Isolate::InitIsolate(kVmIsolateName, group, api_flags, is_vm_isolate);</code></p></blockquote><p>åœ¨<code>Isolate::InitIsolate</code>æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯ç”¨<code>isolate_group</code>åˆ›å»ºäº†æ–°çš„Isolateï¼Œç„¶åå°†å…¶ä¸<code>Thread</code>ï¼Œ<code>MessageHandler</code>ï¼Œ<code>SendPort</code>ç­‰ç»‘å®šï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\isolate.cc</span></span><br><span class="line"></span><br><span class="line">Isolate* Isolate::InitIsolate(<span class="keyword">const</span> char* name_prefix,</span><br><span class="line">                              IsolateGroup* isolate_group,</span><br><span class="line">                              <span class="keyword">const</span> Dart_IsolateFlags&amp; api_flags,</span><br><span class="line">                              <span class="built_in">bool</span> is_vm_isolate) &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºæ–°çš„Isolate</span></span><br><span class="line">  **Isolate* result = <span class="keyword">new</span> Isolate(isolate_group, api_flags);**</span><br><span class="line">  result-&gt;BuildName(name_prefix);</span><br><span class="line">  <span class="keyword">if</span> (!is_vm_isolate) &#123;</span><br><span class="line">    <span class="comment">// vm isolate object store is initialized later, after null instance</span></span><br><span class="line">    <span class="comment">// is created (in Dart::Init).</span></span><br><span class="line">    <span class="comment">// Non-vm isolates need to have isolate object store initialized is that</span></span><br><span class="line">    <span class="comment">// exit_listeners have to be null-initialized as they will be used if</span></span><br><span class="line">    <span class="comment">// we fail to create isolate below, have to do low level shutdown.</span></span><br><span class="line">    ASSERT(result-&gt;group()-&gt;object_store() != nullptr);</span><br><span class="line">    result-&gt;isolate_object_store()-&gt;Init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ASSERT(result != nullptr);</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line"><span class="comment">// Initialize metrics.</span></span><br><span class="line">#define ISOLATE_METRIC_INIT(type, variable, name, unit)                        \</span><br><span class="line">  result-&gt;metric_##variable##_.InitInstance(result, name, NULL, Metric::unit);</span><br><span class="line">  ISOLATE_METRIC_LIST(ISOLATE_METRIC_INIT);</span><br><span class="line">#undef ISOLATE_METRIC_INIT</span><br><span class="line">#endif  <span class="comment">// !defined(PRODUCT)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// First we ensure we enter the isolate. This will ensure we're participating</span></span><br><span class="line">  <span class="comment">// in any safepointing requests from this point on. Other threads requesting a</span></span><br><span class="line">  <span class="comment">// safepoint operation will therefore wait until we've stopped.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Though the [result] isolate is still in a state where no memory has been</span></span><br><span class="line">  <span class="comment">// allocated, which means it's safe to GC the isolate group until here.</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªThreadå¹¶å’Œå½“å‰isolateç»‘å®š</span></span><br><span class="line">  <span class="keyword">if</span> (!**Thread::EnterIsolate(result)**) &#123;</span><br><span class="line">    delete result;</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the isolate message handler.</span></span><br><span class="line">  MessageHandler* handler = <span class="keyword">new</span> IsolateMessageHandler(result);</span><br><span class="line">  ASSERT(handler != nullptr);</span><br><span class="line"><span class="comment">// åœ¨è¿™é‡Œç»‘å®šäº†message handler</span></span><br><span class="line">  **result-&gt;set_message_handler(handler);**</span><br><span class="line"></span><br><span class="line">  **result-&gt;set_main_port(PortMap::CreatePort(result-&gt;message_handler()));**</span><br><span class="line">#<span class="keyword">if</span> defined(DEBUG)</span><br><span class="line">  <span class="comment">// Verify that we are never reusing a live origin id.</span></span><br><span class="line">  VerifyOriginId id_verifier(result-&gt;main_port());</span><br><span class="line">  Isolate::VisitIsolates(&amp;id_verifier);</span><br><span class="line">#endif</span><br><span class="line">  result-&gt;set_origin_id(result-&gt;main_port());</span><br><span class="line">  result-&gt;set_pause_capability(result-&gt;random()-&gt;NextUInt64());</span><br><span class="line">  result-&gt;set_terminate_capability(result-&gt;random()-&gt;NextUInt64());</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line">  result-&gt;debugger_ = <span class="keyword">new</span> Debugger(result);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now we register the isolate in the group. From this point on any GC would</span></span><br><span class="line">  <span class="comment">// traverse the isolate roots (before this point, the roots are only pointing</span></span><br><span class="line">  <span class="comment">// to vm-isolate objects, e.g. null)</span></span><br><span class="line">  **isolate_group-&gt;RegisterIsolate(result);**</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ServiceIsolate::NameEquals(name_prefix)) &#123;</span><br><span class="line">    ASSERT(!ServiceIsolate::Exists());</span><br><span class="line">    ServiceIsolate::SetServiceIsolate(result);</span><br><span class="line">#<span class="keyword">if</span> !defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (KernelIsolate::NameEquals(name_prefix)) &#123;</span><br><span class="line">    ASSERT(!KernelIsolate::Exists());</span><br><span class="line">    KernelIsolate::SetKernelIsolate(result);</span><br><span class="line">#endif  <span class="comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name_prefix == nullptr || strcmp(name_prefix, <span class="string">"vm-isolate"</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      OS::PrintErr(</span><br><span class="line">          <span class="string">"[+] Starting isolate:\n"</span></span><br><span class="line">          <span class="string">"\tisolate:    %s\n"</span>,</span><br><span class="line">          result-&gt;name());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add to isolate list. Shutdown and delete the isolate on failure.</span></span><br><span class="line">  <span class="keyword">if</span> (!TryMarkIsolateReady(result)) &#123;</span><br><span class="line">    result-&gt;LowLevelShutdown();</span><br><span class="line">    Isolate::LowLevelCleanup(result);</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Dart::InitializeIsolate</strong></p><p>è¿™é‡Œä¸»è¦æ˜¯å¯¹isolateè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶åœ¨åˆå§‹åŒ–å®Œæˆåé€šçŸ¥åˆ›å»ºè¿™ä¸ªisolateçš„isolateã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart.cc</span></span><br><span class="line"></span><br><span class="line">ErrorPtr Dart::InitializeIsolate(<span class="keyword">const</span> uint8_t* snapshot_data,</span><br><span class="line">                                 <span class="keyword">const</span> uint8_t* snapshot_instructions,</span><br><span class="line">                                 <span class="keyword">const</span> uint8_t* kernel_buffer,</span><br><span class="line">                                 intptr_t kernel_buffer_size,</span><br><span class="line">                                 IsolateGroup* source_isolate_group,</span><br><span class="line">                                 <span class="keyword">void</span>* isolate_data) &#123;</span><br><span class="line">  <span class="comment">// Initialize the new isolate.</span></span><br><span class="line">  Thread* T = Thread::Current();</span><br><span class="line">  Isolate* I = T-&gt;isolate();</span><br><span class="line">  auto IG = T-&gt;isolate_group();</span><br><span class="line">#<span class="keyword">if</span> defined(SUPPORT_TIMELINE)</span><br><span class="line">  TimelineBeginEndScope tbes(T, Timeline::GetIsolateStream(),</span><br><span class="line">                             <span class="string">"InitializeIsolate"</span>);</span><br><span class="line">  tbes.SetNumArguments(<span class="number">1</span>);</span><br><span class="line">  tbes.CopyArgument(<span class="number">0</span>, <span class="string">"isolateName"</span>, I-&gt;name());</span><br><span class="line">#endif</span><br><span class="line">  ASSERT(I != NULL);</span><br><span class="line">  StackZone zone(T);</span><br><span class="line">  HandleScope handle_scope(T);</span><br><span class="line">  <span class="built_in">bool</span> was_child_cloned_into_existing_isolate = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (source_isolate_group != nullptr) &#123;</span><br><span class="line">    <span class="comment">// If a static field gets registered in [IsolateGroup::RegisterStaticField]:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//   * before this block it will ignore this isolate. The [Clone] of the</span></span><br><span class="line">    <span class="comment">//     initial field table will pick up the new value.</span></span><br><span class="line">    <span class="comment">//   * after this block it will add the new static field to this isolate.</span></span><br><span class="line">    &#123;</span><br><span class="line">      SafepointReadRwLocker reader(T, source_isolate_group-&gt;program_lock());</span><br><span class="line">      **I-&gt;set_field_table**(T,</span><br><span class="line">                         source_isolate_group-&gt;initial_field_table()-&gt;Clone(I));</span><br><span class="line">      **I-&gt;field_table()-&gt;MarkReadyToUse();**</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    was_child_cloned_into_existing_isolate = <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> Error&amp; error = Error::Handle(</span><br><span class="line"><span class="comment">// ä»IsolateGroupä¸­å¼•ç”¨ä¸€äº›é€šç”¨çš„å˜é‡ï¼ˆå¸¸é‡ç­‰ç­‰ï¼‰</span></span><br><span class="line">        **InitIsolateFromSnapshot**(T, I, snapshot_data, snapshot_instructions,</span><br><span class="line">                                kernel_buffer, kernel_buffer_size));</span><br><span class="line">    <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> error.ptr();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>::VerifyBuiltinVtables();</span><br><span class="line">  <span class="keyword">if</span> (T-&gt;isolate()-&gt;origin_id() == <span class="number">0</span>) &#123;</span><br><span class="line">    DEBUG_ONLY(IG-&gt;heap()-&gt;Verify(kForbidMarked));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">bool</span> kIsAotRuntime = <span class="keyword">true</span>;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">bool</span> kIsAotRuntime = <span class="keyword">false</span>;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (kIsAotRuntime || was_child_cloned_into_existing_isolate) &#123;</span><br><span class="line">#<span class="keyword">if</span> !defined(TARGET_ARCH_IA32)</span><br><span class="line">    ASSERT(IG-&gt;object_store()-&gt;build_generic_method_extractor_code() !=</span><br><span class="line">           Code::<span class="keyword">null</span>());</span><br><span class="line">    ASSERT(IG-&gt;object_store()-&gt;build_nongeneric_method_extractor_code() !=</span><br><span class="line">           Code::<span class="keyword">null</span>());</span><br><span class="line">#endif</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">#<span class="keyword">if</span> !defined(TARGET_ARCH_IA32)</span><br><span class="line">    <span class="keyword">if</span> (I != Dart::vm_isolate()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_generic_method_extractor_code() !=</span><br><span class="line">          nullptr) &#123;</span><br><span class="line">        SafepointWriteRwLocker ml(T, IG-&gt;program_lock());</span><br><span class="line">        <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_generic_method_extractor_code() !=</span><br><span class="line">            nullptr) &#123;</span><br><span class="line">          IG-&gt;object_store()-&gt;set_build_generic_method_extractor_code(</span><br><span class="line">              Code::Handle(</span><br><span class="line">                  StubCode::GetBuildGenericMethodExtractorStub(nullptr)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_nongeneric_method_extractor_code() !=</span><br><span class="line">          nullptr) &#123;</span><br><span class="line">        SafepointWriteRwLocker ml(T, IG-&gt;program_lock());</span><br><span class="line">        <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_nongeneric_method_extractor_code() !=</span><br><span class="line">            nullptr) &#123;</span><br><span class="line">          IG-&gt;object_store()-&gt;set_build_nongeneric_method_extractor_code(</span><br><span class="line">              Code::Handle(</span><br><span class="line">                  StubCode::GetBuildNonGenericMethodExtractorStub(nullptr)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(TARGET_ARCH_IA32)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  I-&gt;set_ic_miss_code(StubCode::SwitchableCallMiss());</span><br><span class="line"></span><br><span class="line">  Error&amp; error = Error::Handle();</span><br><span class="line">  <span class="keyword">if</span> (snapshot_data == nullptr || kernel_buffer != nullptr) &#123;</span><br><span class="line">    error ^= IG-&gt;object_store()-&gt;PreallocateObjects();</span><br><span class="line">    <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> error.ptr();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> auto&amp; out_of_memory =</span><br><span class="line">      <span class="built_in">Object</span>::Handle(IG-&gt;object_store()-&gt;out_of_memory());</span><br><span class="line">  error ^= I-&gt;isolate_object_store()-&gt;PreallocateObjects(out_of_memory);</span><br><span class="line">  <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">    <span class="keyword">return</span> error.ptr();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!was_child_cloned_into_existing_isolate) &#123;</span><br><span class="line">    IG-&gt;heap()-&gt;InitGrowthControl();</span><br><span class="line">  &#125;</span><br><span class="line">  I-&gt;set_init_callback_data(isolate_data);</span><br><span class="line">  <span class="keyword">if</span> (FLAG_print_class_table) &#123;</span><br><span class="line">    IG-&gt;class_table()-&gt;Print();</span><br><span class="line">  &#125;</span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line">  ServiceIsolate::MaybeMakeServiceIsolate(I);</span><br><span class="line">  <span class="keyword">if</span> (!Isolate::IsSystemIsolate(I)) &#123;</span><br><span class="line">    I-&gt;message_handler()-&gt;set_should_pause_on_start(</span><br><span class="line">        FLAG_pause_isolates_on_start);</span><br><span class="line">    I-&gt;message_handler()-&gt;set_should_pause_on_exit(FLAG_pause_isolates_on_exit);</span><br><span class="line">  &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(PRODUCT)</span></span><br><span class="line"></span><br><span class="line">  ServiceIsolate::SendIsolateStartupMessage();</span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line">  I-&gt;debugger()-&gt;NotifyIsolateCreated();</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create tag table.</span></span><br><span class="line">  I-&gt;set_tag_table(GrowableObjectArray::Handle(GrowableObjectArray::New()));</span><br><span class="line">  <span class="comment">// Set up default UserTag.</span></span><br><span class="line">  <span class="keyword">const</span> UserTag&amp; default_tag = UserTag::Handle(UserTag::DefaultTag());</span><br><span class="line">  I-&gt;set_current_tag(default_tag);</span><br><span class="line"></span><br><span class="line">  I-&gt;init_loaded_prefixes_set_storage();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Error::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯è°ƒç”¨<code>Isolate.spawn()</code>çš„è¯ï¼Œå…ˆä»å½“å‰isolateè·å–å¯¹åº”çš„Isolate Groupï¼Œç„¶åä½¿ç”¨è¿™ä¸ªIsolate Groupåˆ›å»ºé…ç½®ä¸€ä¸ªæ–°çš„isolateï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªisolate groupä¸­çš„Isolateå¯ä»¥å…±äº«å¸¸é‡ï¼Œheapç­‰ã€‚</p><h3 id="Isolate-spawnUri"><a href="#Isolate-spawnUri" class="headerlink" title="Isolate_spawnUri"></a>Isolate_spawnUri</h3><p>å¦‚æœæ˜¯ä½¿ç”¨<code>Isolate.spawnUri()</code>çš„è¯ï¼Œå°±ä¼šé€šè¿‡<code>Isolate_spawnUri</code>æ¥åˆ›å»ºisolateã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_spawnUri, <span class="number">0</span>, <span class="number">12</span>) &#123;</span><br><span class="line"><span class="comment">// è§£æå‚æ•°</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Canonicalize the uri with respect to the current isolate.</span></span><br><span class="line">  <span class="keyword">const</span> Library&amp; root_lib =</span><br><span class="line">      Library::Handle(isolate-&gt;group()-&gt;object_store()-&gt;root_library());</span><br><span class="line">  char* error = NULL;</span><br><span class="line"><span class="comment">// è·å–canonical_uri </span></span><br><span class="line">  <span class="keyword">const</span> char* **canonical_uri = CanonicalizeUri**(thread, root_lib, uri, &amp;error);</span><br><span class="line">  <span class="keyword">if</span> (canonical_uri == NULL) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">String</span>&amp; msg = <span class="built_in">String</span>::Handle(<span class="built_in">String</span>::New(error));</span><br><span class="line">    ThrowIsolateSpawnException(msg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> char* utf8_package_config =</span><br><span class="line">      packageConfig.IsNull() ? NULL : String2UTF8(packageConfig);</span><br><span class="line">  <span class="keyword">const</span> char* utf8_debug_name =</span><br><span class="line">      debugName.IsNull() ? NULL : String2UTF8(debugName);</span><br><span class="line"></span><br><span class="line">  std::unique_ptr&lt;IsolateSpawnState&gt; state(<span class="keyword">new</span> **IsolateSpawnState**(</span><br><span class="line">      port.Id(), canonical_uri, utf8_package_config, &amp;arguments_buffer,</span><br><span class="line">      &amp;message_buffer, paused.value(), fatal_errors, on_exit_port,</span><br><span class="line"><span class="comment">// æ³¨æ„ä¸‹é¢è¿™é‡Œçš„group=nullptr</span></span><br><span class="line">      on_error_port, utf8_debug_name, **<span class="comment">/*group=*/</span>nullptr**));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we were passed a value then override the default flags state for</span></span><br><span class="line">  <span class="comment">// checked mode.</span></span><br><span class="line">  <span class="keyword">if</span> (!checked.IsNull()) &#123;</span><br><span class="line">    Dart_IsolateFlags* flags = state-&gt;isolate_flags();</span><br><span class="line">    flags-&gt;enable_asserts = checked.value();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since this is a call to Isolate.spawnUri, don't copy the parent's code.</span></span><br><span class="line">  state-&gt;isolate_flags()-&gt;copy_parent_code = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  isolate-&gt;group()-&gt;thread_pool()-&gt;**Run&lt;SpawnIsolateTask&gt;**(isolate,</span><br><span class="line">                                                         std::move(state));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>Isolate_spawnUri</code>è¿˜æ˜¯æ‰§è¡Œäº†<code>SpawnIsolateTask</code> ã€‚</p><h4 id="SpawnIsolateTask-1"><a href="#SpawnIsolateTask-1" class="headerlink" title="SpawnIsolateTask"></a>SpawnIsolateTask</h4><p>åœ¨<code>SpawnIsolateTask.Run</code>æ–¹æ³•ä¸­ï¼Œå› ä¸º<code>spawnUri</code>ä¸­<code>IsolateSpawnState</code>çš„<code>IsolateGroup</code>ä¸º<code>nulltrp</code>ï¼Œæ‰€ä»¥è¿™é‡Œæ‰§è¡Œçš„æ˜¯<code>RunHeavyweight(name)</code>ï¼š</p><h4 id="RunHeavyweight"><a href="#RunHeavyweight" class="headerlink" title="RunHeavyweight"></a>RunHeavyweight</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpawnIsolateTask</span> : <span class="title">public</span> <span class="title">ThreadPool</span>::<span class="title">Task</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Run() override &#123;</span><br><span class="line">    <span class="keyword">const</span> char* name = (state_-&gt;debug_name() == nullptr)</span><br><span class="line">                           ? state_-&gt;function_name()</span><br><span class="line">                           : state_-&gt;debug_name();</span><br><span class="line">    ASSERT(name != nullptr);</span><br><span class="line"></span><br><span class="line">    auto group = state_-&gt;isolate_group();</span><br><span class="line">    <span class="keyword">if</span> (group == nullptr) &#123;</span><br><span class="line">      **RunHeavyweight(name);**</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      RunLightweight(name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RunHeavyweight(<span class="keyword">const</span> char* name) &#123;</span><br><span class="line">    <span class="comment">// The create isolate group callback is mandatory.  If not provided we</span></span><br><span class="line">    <span class="comment">// cannot spawn isolates.</span></span><br><span class="line"><span class="comment">// åœ¨Dart::DartInitä¸­å·²ç»è¢«è®¾ç½®ï¼Œåœ¨Isolateåˆ›å»ºæ—¶ä¼šè¢«å›è°ƒ</span></span><br><span class="line">    **auto create_group_callback = Isolate::CreateGroupCallback();**</span><br><span class="line">    <span class="keyword">if</span> (create_group_callback == nullptr) &#123;</span><br><span class="line">      FailedSpawn(<span class="string">"Isolate spawn is not supported by this Dart embedder\n"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char* error = nullptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make a copy of the state's isolate flags and hand it to the callback.</span></span><br><span class="line">    Dart_IsolateFlags api_flags = *(state_-&gt;isolate_flags());</span><br><span class="line">    api_flags.is_system_isolate = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// åˆ›å»ºisolate</span></span><br><span class="line">    **Dart_Isolate isolate =</span><br><span class="line">        (create_group_callback)(state_-&gt;script_url(), name, nullptr,</span><br><span class="line">                                state_-&gt;package_config(), &amp;api_flags,</span><br><span class="line">                                parent_isolate_-&gt;init_callback_data(), &amp;error);**</span><br><span class="line">    parent_isolate_-&gt;DecrementSpawnCount();</span><br><span class="line">    parent_isolate_ = nullptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolate == nullptr) &#123;</span><br><span class="line">      FailedSpawn(error, <span class="comment">/*has_current_isolate=*/</span><span class="keyword">false</span>);</span><br><span class="line">      free(error);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// åˆ‡æ¢åˆ°æŒ‡å®šçš„isolate</span></span><br><span class="line">    Dart_EnterIsolate(isolate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œä¹Ÿè°ƒç”¨äº†Runæ–¹æ³•</span></span><br><span class="line">    **Run(reinterpret_cast&lt;Isolate*&gt;(isolate));**</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åˆ›å»ºIsolateçš„è¿‡ç¨‹åœ¨<code>Isolate::CreateGroupCallback();</code>ä¸­ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»–æ˜¯æ€ä¹ˆæ¥çš„ï¼š</p><h4 id="Isolate-CreateGroupCallback"><a href="#Isolate-CreateGroupCallback" class="headerlink" title="Isolate::CreateGroupCallback()"></a>Isolate::CreateGroupCallback()</h4><p>ä»–å’Œä¸Šè¿°<code>Isolate::InitializeCallback_</code>çš„æ¥æºä¸€è‡´ï¼Œéƒ½æ˜¯åœ¨<code>Dart_Initialize</code>ä¸­é…ç½®çš„ï¼Œæ­¤å¤–ï¼Œè¿˜ä½¿ç”¨äº†<code>parent_isolate_-&gt;init_callback_data()</code>ã€‚</p><p>å…ˆçœ‹ä¸€ä¸‹çš„<code>CreateIsolateGroupAndSetup</code>å®ç°ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Dart_Isolate CreateIsolateGroupAndSetup(<span class="keyword">const</span> char* script_uri,</span><br><span class="line">                                               <span class="keyword">const</span> char* main,</span><br><span class="line">                                               <span class="keyword">const</span> char* package_root,</span><br><span class="line">                                               <span class="keyword">const</span> char* package_config,</span><br><span class="line">                                               Dart_IsolateFlags* flags,</span><br><span class="line">                                               <span class="keyword">void</span>* callback_data,</span><br><span class="line">                                               char** error) &#123;</span><br><span class="line">  <span class="comment">// The VM should never call the isolate helper with a NULL flags.</span></span><br><span class="line">  ASSERT(flags != NULL);</span><br><span class="line">  ASSERT(flags-&gt;version == DART_FLAGS_CURRENT_VERSION);</span><br><span class="line">  ASSERT(package_root == nullptr);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> dontneed_safe = <span class="keyword">true</span>;</span><br><span class="line">#<span class="keyword">if</span> defined(DART_HOST_OS_LINUX)</span><br><span class="line">  <span class="comment">// This would also be true in Linux, except that Google3 overrides the default</span></span><br><span class="line">  <span class="comment">// ELF interpreter to one that apparently doesn't create proper mappings.</span></span><br><span class="line">  dontneed_safe = <span class="keyword">false</span>;</span><br><span class="line">#elif defined(DEBUG)</span><br><span class="line">  <span class="comment">// If the snapshot isn't file-backed, madvise(DONT_NEED) is destructive.</span></span><br><span class="line">  <span class="keyword">if</span> (Options::force_load_elf_from_memory()) &#123;</span><br><span class="line">    dontneed_safe = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">#endif</span><br><span class="line">  flags-&gt;snapshot_is_dontneed_safe = dontneed_safe;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> exit_code = <span class="number">0</span>;</span><br><span class="line">#<span class="keyword">if</span> !defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span><br><span class="line">  <span class="keyword">if</span> (strcmp(script_uri, DART_KERNEL_ISOLATE_NAME) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> **CreateAndSetupKernelIsolate**(script_uri, package_config, flags, error,</span><br><span class="line">                                       &amp;exit_code);</span><br><span class="line">  &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">  <span class="keyword">if</span> (strcmp(script_uri, DART_DEV_ISOLATE_NAME) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> **CreateAndSetupDartDevIsolate**(script_uri, package_config, flags,</span><br><span class="line">                                        error, &amp;exit_code);</span><br><span class="line">  &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (strcmp(script_uri, DART_VM_SERVICE_ISOLATE_NAME) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> **CreateAndSetupServiceIsolate**(script_uri, package_config, flags,</span><br><span class="line">                                        error, &amp;exit_code);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> is_main_isolate = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">return</span> **CreateIsolateGroupAndSetupHelper**(is_main_isolate, script_uri, main,</span><br><span class="line">                                          package_config, flags, callback_data,</span><br><span class="line">                                          error, &amp;exit_code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºIsolateçš„æ—¶å€™ï¼ŒåŒºåˆ†äº†å‡ ç§æƒ…å†µï¼š</p><ul><li>å¦‚æœæ˜¯kernel-serviceï¼ˆ<code>DART_KERNEL_ISOLATE_NAME</code>ï¼‰å°±æ‰§è¡Œ<code>CreateAndSetupKernelIsolate</code></li><li>å¦‚æœæ˜¯dartdevï¼ˆ<code>DART_DEV_ISOLATE_NAME</code>ï¼‰å°±æ‰§è¡Œ<code>CreateAndSetupDartDevIsolate</code></li><li>å¦‚æœæ˜¯vm-serviceï¼ˆ<code>DART_VM_SERVICE_ISOLATE_NAME</code>ï¼‰å°±æ‰§è¡Œ<code>CreateAndSetupServiceIsolate</code></li><li>å¦‚æœä»¥ä¸Šéƒ½ä¸æ»¡è¶³ï¼Œå°±æ‰§è¡Œ<code>CreateIsolateGroupAndSetupHelper</code></li></ul><p>æ˜¾ç„¶,å½“æˆ‘ä»¬åœ¨Dartä»£ç ä¸­è°ƒç”¨<code>Isolate.spawnUri</code>çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæ‰§è¡Œçš„æ˜¯<code>CreateIsolateGroupAndSetupHelper</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨æ–¹</span></span><br><span class="line"><span class="keyword">bool</span> is_main_isolate = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> CreateIsolateGroupAndSetupHelper(is_main_isolate, script_uri, main,</span><br><span class="line">                                          package_config, flags, callback_data,</span><br><span class="line">                                          error, &amp;exit_code);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns newly created Isolate on success, NULL on failure.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Dart_Isolate <span class="title">CreateIsolateGroupAndSetupHelper</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">bool</span> is_main_isolate,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span>* script_uri,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span>* packages_config,</span></span></span><br><span class="line"><span class="function"><span class="params">    Dart_IsolateFlags* flags,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span>* callback_data,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">char</span>** error,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span>* exit_code)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// æ ¹æ®æ˜¯AOTè¿˜æ˜¯JITè·å–kernel_bufferï¼Œapp_snapshotï¼Œisolate_run_app_snapshotç­‰æ•°æ®</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DART_PRECOMPILED_RUNTIME)&#123;</span></span><br><span class="line"><span class="comment">// AOT: All isolates need to be run from AOT compiled snapshots.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>&#123;</span></span><br><span class="line"><span class="comment">// JIT: Main isolate starts from the app snapshot, if any. Other isolates</span></span><br><span class="line">  <span class="comment">// use the core libraries snapshot.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºisolate_group_data</span></span><br><span class="line"><span class="keyword">auto</span> isolate_group_data = <span class="keyword">new</span> IsolateGroupData(</span><br><span class="line">      script_uri, packages_config, app_snapshot, isolate_run_app_snapshot);</span><br><span class="line"><span class="comment">// copy_parent_codeä¸ºtrueçš„è¯ï¼Œè¿™é‡Œçš„kernel_bufferä¸ºNULL</span></span><br><span class="line">  <span class="keyword">if</span> (kernel_buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (kernel_buffer_ptr) &#123;</span><br><span class="line">      isolate_group_data-&gt;SetKernelBufferAlreadyOwned(</span><br><span class="line">          <span class="built_in">std</span>::move(kernel_buffer_ptr), kernel_buffer_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isolate_group_data-&gt;SetKernelBufferNewlyOwned(kernel_buffer,</span><br><span class="line">                                                    kernel_buffer_size);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">Dart_Isolate isolate = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  IsolateData* isolate_data = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(DART_PRECOMPILED_RUNTIME)</span></span><br><span class="line">  <span class="keyword">if</span> (!isolate_run_app_snapshot &amp;&amp; (isolate_snapshot_data == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* platform_kernel_buffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">intptr_t</span> platform_kernel_buffer_size = <span class="number">0</span>;</span><br><span class="line">    dfe.LoadPlatform(&amp;platform_kernel_buffer, &amp;platform_kernel_buffer_size);</span><br><span class="line">    <span class="keyword">if</span> (platform_kernel_buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      platform_kernel_buffer = kernel_buffer;</span><br><span class="line">      platform_kernel_buffer_size = kernel_buffer_size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (platform_kernel_buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span><br><span class="line">      FATAL(</span><br><span class="line">          <span class="string">"Binary built with --exclude-kernel-service. Cannot run"</span></span><br><span class="line">          <span class="string">" from source."</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      FATAL(<span class="string">"platform_program cannot be NULL."</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO(sivachandra): When the platform program is unavailable, check if</span></span><br><span class="line">    <span class="comment">// application kernel binary is self contained or an incremental binary.</span></span><br><span class="line">    <span class="comment">// Isolate should be created only if it is a self contained kernel binary.</span></span><br><span class="line">    isolate_data = <span class="keyword">new</span> IsolateData(isolate_group_data);</span><br><span class="line">    isolate = Dart_CreateIsolateGroupFromKernel(</span><br><span class="line">        script_uri, name, platform_kernel_buffer, platform_kernel_buffer_size,</span><br><span class="line">        flags, isolate_group_data, isolate_data, error);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isolate_data = <span class="keyword">new</span> IsolateData(isolate_group_data);</span><br><span class="line"><span class="comment">// Creates a new isolate. The new isolate becomes the current isolate.</span></span><br><span class="line">    isolate = Dart_CreateIsolateGroup(script_uri, name, isolate_snapshot_data,</span><br><span class="line">                                      isolate_snapshot_instructions, flags,</span><br><span class="line">                                      isolate_group_data, isolate_data, error);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  **isolate_data = <span class="keyword">new</span> IsolateData**(isolate_group_data);</span><br><span class="line"><span class="comment">// Creates a new isolate. The new isolate becomes the current isolate.</span></span><br><span class="line">  **isolate = Dart_CreateIsolateGroup**(script_uri, name, isolate_snapshot_data,</span><br><span class="line">                                    isolate_snapshot_instructions, flags,</span><br><span class="line">                                    **isolate_group_data**, **isolate_data**, error);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span></span><br><span class="line"></span><br><span class="line">  Dart_Isolate created_isolate = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (isolate == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">delete</span> isolate_data;</span><br><span class="line">    <span class="keyword">delete</span> isolate_group_data;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    **created_isolate = IsolateSetupHelper**(</span><br><span class="line">        isolate, is_main_isolate, script_uri, packages_config,</span><br><span class="line">        isolate_run_app_snapshot, flags, error, exit_code);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int64_t</span> end = Dart_TimelineGetMicros();</span><br><span class="line">  Dart_TimelineEvent(<span class="string">"CreateIsolateGroupAndSetupHelper"</span>, start, end,</span><br><span class="line">                     Dart_Timeline_Event_Duration, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">return</span> created_isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>CreateIsolateGroupAndSetupHelper</code>æŒ‰ç…§æ˜¯JITè¿˜æ˜¯AOTçš„ç¼–è¯‘æ–¹å¼ï¼Œæœ‰ä¸åŒçš„è·å–æ•°æ®çš„æ–¹å¼ï¼Œä½†ä¸ç®¡å“ªç§æ–¹å¼ï¼Œæœ€åéƒ½æ‰§è¡Œäº†ä¸€ä¸‹ä¸‰æ­¥ï¼š</p><ul><li>åˆ›å»º<code>IsolateData* isolate_data</code> ä½¿ç”¨<code>isolate_group_data</code>åˆ›å»ºIsolateData</li><li>åˆ›å»º<code>Dart_Isolate isolate</code> åˆ›å»º<code>Dart_Isolate</code>ï¼Œå°†<code>script_uri</code>ï¼Œ<code>isolate_data</code>ï¼Œå’Œ<code>isolate_group_data</code>ç­‰ç»‘å®š</li><li>åˆ›å»ºå¹¶è¿”å›<code>Dart_Isolate created_isolate</code>åŒ…è£…<code>isolate</code> ï¼Œè¿›è¡Œæ•°æ®ç»‘å®šï¼Œå¹¶å°†isolateæ ‡è®°ä¸º<code>runnable</code></li></ul><h5 id="Dart-CreateIsolateGroup"><a href="#Dart-CreateIsolateGroup" class="headerlink" title="Dart_CreateIsolateGroup"></a>Dart_CreateIsolateGroup</h5><p>è¿™é‡Œåˆ†æä¸€ä¸‹<strong><code>Dart_CreateIsolateGroup</code>çš„è¿‡ç¨‹ï¼š</strong></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --&gt; runtime/vm/dart_api_impl.cc#L1371</span></span><br><span class="line"></span><br><span class="line">DART_EXPORT Dart_Isolate</span><br><span class="line">Dart_CreateIsolateGroup(<span class="keyword">const</span> char* script_uri,</span><br><span class="line">                        <span class="keyword">const</span> char* name,</span><br><span class="line">                        <span class="keyword">const</span> uint8_t* snapshot_data,</span><br><span class="line">                        <span class="keyword">const</span> uint8_t* snapshot_instructions,</span><br><span class="line">                        Dart_IsolateFlags* flags,</span><br><span class="line">                        <span class="keyword">void</span>* isolate_group_data,</span><br><span class="line">                        <span class="keyword">void</span>* isolate_data,</span><br><span class="line">                        char** error) &#123;</span><br><span class="line">  API_TIMELINE_DURATION(Thread::Current());</span><br><span class="line"></span><br><span class="line">  Dart_IsolateFlags api_flags;</span><br><span class="line">  <span class="keyword">if</span> (flags == nullptr) &#123;</span><br><span class="line">    Isolate::FlagsInitialize(&amp;api_flags);</span><br><span class="line">    flags = &amp;api_flags;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> char* non_null_name = name == nullptr ? <span class="string">"isolate"</span> : name;</span><br><span class="line">  std::unique_ptr&lt;IsolateGroupSource&gt; source(</span><br><span class="line">      <span class="keyword">new</span> IsolateGroupSource(script_uri, non_null_name, snapshot_data,</span><br><span class="line">                             snapshot_instructions, nullptr, <span class="number">-1</span>, *flags));</span><br><span class="line">  <span class="comment">// åˆ›å»ºIsolate Group</span></span><br><span class="line">  auto group = <span class="keyword">new</span> IsolateGroup(std::move(source), isolate_group_data, *flags);</span><br><span class="line">  <span class="comment">// åˆ›å»ºIsolate GroupæŒæœ‰çš„Heapï¼Œç”±æ‰€æœ‰åœ¨è¿™ä¸ªIsolate Groupä¸‹çš„isolateå…±äº«</span></span><br><span class="line">  group-&gt;CreateHeap(</span><br><span class="line">      <span class="comment">/*is_vm_isolate=*/</span><span class="keyword">false</span>, IsServiceOrKernelIsolateName(non_null_name));</span><br><span class="line">  IsolateGroup::RegisterIsolateGroup(group);</span><br><span class="line">  <span class="comment">// æ ¹æ®åˆšåˆšåˆ›å»ºçš„Isolate Groupåˆ›å»ºIsolate</span></span><br><span class="line">  Dart_Isolate isolate = CreateIsolate(group, <span class="comment">/*is_new_group=*/</span><span class="keyword">true</span>,</span><br><span class="line">                                       non_null_name, isolate_data, error);</span><br><span class="line">  <span class="keyword">if</span> (isolate != nullptr) &#123;</span><br><span class="line">    group-&gt;set_initial_spawn_successful();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Run-Isolate-child"><a href="#Run-Isolate-child" class="headerlink" title="Run(Isolate* child)"></a>Run(Isolate* child)</h3><p>åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæ— è®ºæ˜¯<code>RunHeavyweight(const char* name)</code>è¿˜æ˜¯<code>RunLightweight(const char* name)</code>æ–¹æ³•ï¼Œæœ€ååœ¨åˆ›å»ºäº†æ–°çš„isolateä¹‹åï¼Œéƒ½æ‰§è¡Œäº†<code>Run(Isolate* child)</code>æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ­£å¼å¯åŠ¨äº†isolateï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">(Isolate* child)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!EnsureIsRunnable(child)) &#123;</span><br><span class="line">      Dart_ShutdownIsolate();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    state_-&gt;set_isolate(child);</span><br><span class="line">    <span class="keyword">if</span> (state_-&gt;origin_id() != ILLEGAL_PORT) &#123;</span><br><span class="line">      <span class="comment">// origin_id is set to parent isolate main port id when spawning via</span></span><br><span class="line">      <span class="comment">// spawnFunction.</span></span><br><span class="line">      child-&gt;set_origin_id(state_-&gt;origin_id());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> success = <span class="literal">true</span>;</span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">auto</span> thread = Thread::Current();</span><br><span class="line">      <span class="comment">// TransitionNativeToVM is used to transition the safepoint state of a</span></span><br><span class="line">      <span class="comment">// thread from "running native code" to "running vm code" and ensures</span></span><br><span class="line">      <span class="comment">// that the state is reverted back to "running native code" when</span></span><br><span class="line">      <span class="comment">// exiting the scope/frame.</span></span><br><span class="line">      <span class="function">TransitionNativeToVM <span class="title">transition</span><span class="params">(thread)</span></span>;</span><br><span class="line">      <span class="comment">// Create an empty zone and set is at the current zone for the Thread.</span></span><br><span class="line">      <span class="function">StackZone <span class="title">zone</span><span class="params">(thread)</span></span>;</span><br><span class="line">      <span class="comment">// The class HandleScope is used to start a new handles scope in the</span></span><br><span class="line">      <span class="comment">//  code.</span></span><br><span class="line">      <span class="function">HandleScope <span class="title">hs</span><span class="params">(thread)</span></span>;</span><br><span class="line"></span><br><span class="line">      success = **EnqueueEntrypointInvocationAndNotifySpawner**(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">      state_ = <span class="literal">nullptr</span>;</span><br><span class="line">      Dart_ShutdownIsolate();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All preconditions are met for this to always succeed.</span></span><br><span class="line">    <span class="keyword">char</span>* error = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="comment">// Lets the VM run message processing for the isolate.</span></span><br><span class="line">    <span class="keyword">if</span> (!**Dart_RunLoopAsync**(state_-&gt;errors_are_fatal(), state_-&gt;on_error_port(),</span><br><span class="line">                           state_-&gt;on_exit_port(), &amp;error)) &#123;</span><br><span class="line">      FATAL(<span class="string">"Dart_RunLoopAsync() failed: %s. Please file a Dart VM bug report."</span>,</span><br><span class="line">            error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯åšäº†ä¸€äº›ç¯å¢ƒå‡†å¤‡ï¼Œç„¶ååœ¨<code>EnqueueEntrypointInvocationAndNotifySpawner</code>æ–¹æ³•ä¸­å°†isolateè¦è¿è¡Œçš„æ‰€æœ‰ä¸œè¥¿éƒ½å‡†å¤‡å¥½ï¼Œç„¶åå†åœ¨<code>Dart_RunLoopAsync</code>æ–¹æ³•ä¸­æ­£å¼å¼€å§‹isolateå¤„ç†event queue.</p><p><strong>EnqueueEntrypointInvocationAndNotifySpawner</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">EnqueueEntrypointInvocationAndNotifySpawner</span><span class="params">(Thread* thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> isolate = thread-&gt;isolate();</span><br><span class="line">    <span class="keyword">auto</span> zone = thread-&gt;zone();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> is_spawn_uri = state_-&gt;is_spawn_uri();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1) Resolve the entrypoint function.</span></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾isolateå¼€å§‹è¿è¡Œçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚Isolate.spawnçš„spawnæˆ–è€…Isolate.spawnUriçš„mainæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; entrypoint_closure = Closure::Handle(zone);</span><br><span class="line">    <span class="keyword">if</span> (state_-&gt;closure_tuple_handle() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; result = Object::Handle(</span><br><span class="line">          zone,</span><br><span class="line">          ReadObjectGraphCopyMessage(thread, state_-&gt;closure_tuple_handle()));</span><br><span class="line">      <span class="keyword">if</span> (result.IsError()) &#123;</span><br><span class="line">        ReportError(</span><br><span class="line">            <span class="string">"Failed to deserialize the passed entrypoint to the new isolate."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      entrypoint_closure = Closure::RawCast(result.ptr());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; result = Object::Handle(zone, state_-&gt;ResolveFunction());</span><br><span class="line">      <span class="keyword">if</span> (result.IsError()) &#123;</span><br><span class="line">        ASSERT(is_spawn_uri);</span><br><span class="line">        ReportError(<span class="string">"Failed to resolve entrypoint function."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ASSERT(result.IsFunction());</span><br><span class="line">      <span class="keyword">auto</span>&amp; func = Function::Handle(zone, Function::Cast(result).ptr());</span><br><span class="line">      func = func.ImplicitClosureFunction();</span><br><span class="line">      entrypoint_closure = func.ImplicitStaticClosure();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2) Enqueue delayed invocation of entrypoint callback.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; args_obj = Object::Handle(zone, state_-&gt;BuildArgs(thread));</span><br><span class="line">    <span class="keyword">if</span> (args_obj.IsError()) &#123;</span><br><span class="line">      ReportError(</span><br><span class="line">          <span class="string">"Failed to deserialize the passed arguments to the new isolate."</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ASSERT(args_obj.IsNull() || args_obj.IsInstance());</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; message_obj =</span><br><span class="line">        Object::Handle(zone, state_-&gt;BuildMessage(thread));</span><br><span class="line">    <span class="keyword">if</span> (message_obj.IsError()) &#123;</span><br><span class="line">      ReportError(</span><br><span class="line">          <span class="string">"Failed to deserialize the passed arguments to the new isolate."</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ASSERT(message_obj.IsNull() || message_obj.IsInstance());</span><br><span class="line">    <span class="comment">// è§£æå‚æ•°ï¼Œåˆ†åˆ«æ˜¯isolateåˆå§‹è¿è¡Œæ–¹æ³•ï¼Œå‚æ•°argsã€messgaeã€æ˜¯å¦spawn_uri</span></span><br><span class="line">    <span class="keyword">const</span> Array&amp; args = Array::Handle(zone, Array::New(<span class="number">4</span>));</span><br><span class="line">    args.SetAt(<span class="number">0</span>, entrypoint_closure);</span><br><span class="line">    args.SetAt(<span class="number">1</span>, args_obj);</span><br><span class="line">    args.SetAt(<span class="number">2</span>, message_obj);</span><br><span class="line">    args.SetAt(<span class="number">3</span>, is_spawn_uri ? Bool::True() : Bool::False());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; lib = Library::Handle(zone, Library::IsolateLibrary());</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; entry_name = String::Handle(zone, String::New(<span class="string">"_startIsolate"</span>));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; entry_point =</span><br><span class="line">        Function::Handle(zone, lib.LookupLocalFunction(entry_name));</span><br><span class="line">    ASSERT(entry_point.IsFunction() &amp;&amp; !entry_point.IsNull());</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; result =</span><br><span class="line">        Object::Handle(zone, DartEntry::InvokeFunction(entry_point, args));</span><br><span class="line">    <span class="keyword">if</span> (result.IsError()) &#123;</span><br><span class="line">      ReportError(<span class="string">"Failed to enqueue delayed entrypoint invocation."</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3) Pause the isolate if required &amp; Notify parent isolate about</span></span><br><span class="line">    <span class="comment">// isolate creation.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; capabilities = Array::Handle(zone, Array::New(<span class="number">2</span>));</span><br><span class="line">    <span class="keyword">auto</span>&amp; capability = Capability::Handle(zone);</span><br><span class="line">    capability = Capability::New(isolate-&gt;pause_capability());</span><br><span class="line">    capabilities.SetAt(<span class="number">0</span>, capability);</span><br><span class="line">    capability = Capability::New(isolate-&gt;terminate_capability());</span><br><span class="line">    capabilities.SetAt(<span class="number">1</span>, capability);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; send_port =</span><br><span class="line">        SendPort::Handle(zone, SendPort::New(isolate-&gt;main_port()));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; message = Array::Handle(zone, Array::New(<span class="number">2</span>));</span><br><span class="line">    message.SetAt(<span class="number">0</span>, send_port);</span><br><span class="line">    message.SetAt(<span class="number">1</span>, capabilities);</span><br><span class="line">    <span class="keyword">if</span> (state_-&gt;paused()) &#123;</span><br><span class="line">      capability ^= capabilities.At(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">bool</span> added = isolate-&gt;AddResumeCapability(capability);</span><br><span class="line">      ASSERT(added);</span><br><span class="line">      isolate-&gt;message_handler()-&gt;increment_paused();</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// If parent isolate died, we ignore the fact that we cannot notify it.</span></span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„Messageå¹¶å°†å…¶å‹å…¥Isolateçš„çˆ¶Isolateå¯¹åº”çš„MessageHandlerçš„event queueä¸­</span></span><br><span class="line">      PortMap::PostMessage(WriteMessage(<span class="comment">/* can_send_any_object */</span> <span class="literal">false</span>,</span><br><span class="line">                                        <span class="comment">/* same_group */</span> <span class="literal">false</span>, message,</span><br><span class="line">                                        state_-&gt;parent_port(),</span><br><span class="line">                                        Message::kNormalPriority));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦åšäº†3ä»¶äº‹ï¼š</p><ul><li>æŸ¥æ‰¾isolateå¼€å§‹è¿è¡Œçš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>entrypoint</code>ï¼Œæ¯”å¦‚<code>Isolate.spawn</code>çš„<code>entrypoint</code>æˆ–è€…<code>Isolate.spawnUri</code>çš„<code>main</code>æ–¹æ³•</li><li>è§£æå‚æ•°ï¼Œåˆ†åˆ«æ˜¯isolateåˆå§‹è¿è¡Œæ–¹æ³•ï¼Œå‚æ•°<code>args</code>ã€<code>messgae</code>ã€æ˜¯å¦<code>spawn_uri</code>ç­‰ç­‰ï¼Œå°†å…¶ä¸ä¸Šä¸€æ­¥æ‰¾åˆ°çš„<code>entrypoint</code>ç»“åˆ</li><li>ï¼ˆå¦‚æœéœ€è¦çš„è¯æš‚åœåˆ›å»ºå¥½çš„isolateï¼‰ï¼Œå¹¶é€šçŸ¥isolateçš„çˆ¶isolateå½“å‰isolateåˆ›å»ºæˆåŠŸï¼ˆé™„å¸¦å½“å‰isolateçš„<code>send_port</code>ï¼‰</li></ul><p>è‡³æ­¤ï¼ŒIsolateçš„åˆ›å»ºå·¥ä½œå·²ç»å®Œæˆï¼Œåœ¨<code>Dart_RunLoopAsync</code>å¼€å§‹isolateå¤„ç†æ¶ˆæ¯ï¼š</p><p><strong>Dart_RunLoopAsync</strong></p><p>åœ¨è¿™é‡Œä¸»è¦æ˜¯å¼€å§‹å¤„ç†event loopã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt;  runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">DART_EXPORT <span class="keyword">bool</span> <span class="title">Dart_RunLoopAsync</span><span class="params">(<span class="keyword">bool</span> errors_are_fatal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   Dart_Port on_error_port,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   Dart_Port on_exit_port,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">char</span>** error)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> thread = Thread::Current();</span><br><span class="line">  <span class="keyword">auto</span> isolate = thread-&gt;isolate();</span><br><span class="line">  CHECK_ISOLATE(isolate);</span><br><span class="line">  *error = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (thread-&gt;api_top_scope() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *error = Utils::StrDup(<span class="string">"There must not be an active api scope."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isolate-&gt;is_runnable()) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* error_msg = isolate-&gt;MakeRunnable();</span><br><span class="line">    <span class="keyword">if</span> (error_msg != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error = Utils::StrDup(error_msg);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isolate-&gt;SetErrorsFatal(errors_are_fatal);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (on_error_port != ILLEGAL_PORT || on_exit_port != ILLEGAL_PORT) &#123;</span><br><span class="line">    <span class="keyword">auto</span> thread = Thread::Current();</span><br><span class="line">    <span class="function">TransitionNativeToVM <span class="title">transition</span><span class="params">(thread)</span></span>;</span><br><span class="line">    <span class="function">StackZone <span class="title">zone</span><span class="params">(thread)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (on_error_port != ILLEGAL_PORT) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; port =</span><br><span class="line">          SendPort::Handle(thread-&gt;zone(), SendPort::New(on_error_port));</span><br><span class="line">      isolate-&gt;AddErrorListener(port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (on_exit_port != ILLEGAL_PORT) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; port =</span><br><span class="line">          SendPort::Handle(thread-&gt;zone(), SendPort::New(on_exit_port));</span><br><span class="line">      isolate-&gt;AddExitListener(port, Instance::null_instance());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Dart_ExitIsolate();</span><br><span class="line">  **isolate-&gt;Run();**</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\isolate.cc</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Isolate::Run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  message_handler()-&gt;Run(group()-&gt;thread_pool(), <span class="literal">nullptr</span>, ShutdownIsolate,</span><br><span class="line">                         <span class="keyword">reinterpret_cast</span>&lt;uword&gt;(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Isolate::Run()</code>å®é™…ä¸Šæ˜¯å¼€å¯äº†å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Runs this message handler on the thread pool.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Before processing messages, the optional StartFunction is run.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// A message handler will run until it terminates either normally or</span></span><br><span class="line">  <span class="comment">// abnormally.  Normal termination occurs when the message handler</span></span><br><span class="line">  <span class="comment">// no longer has any live ports.  Abnormal termination occurs when</span></span><br><span class="line">  <span class="comment">// HandleMessage() indicates that an error has occurred during</span></span><br><span class="line">  <span class="comment">// message processing.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns false if the handler terminated abnormally, otherwise it</span></span><br><span class="line">  <span class="comment">// returns true.</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MessageHandler::Run</span><span class="params">(ThreadPool* pool,</span></span></span><br><span class="line"><span class="function"><span class="params">                         StartCallback start_callback,</span></span></span><br><span class="line"><span class="function"><span class="params">                         EndCallback end_callback,</span></span></span><br><span class="line"><span class="function"><span class="params">                         CallbackData data)</span> </span>&#123;</span><br><span class="line">  <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;monitor_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">    OS::PrintErr(</span><br><span class="line">        <span class="string">"[+] Starting message handler:\n"</span></span><br><span class="line">        <span class="string">"\thandler:    %s\n"</span>,</span><br><span class="line">        name());</span><br><span class="line">  &#125;</span><br><span class="line">  ASSERT(pool_ == <span class="literal">NULL</span>);</span><br><span class="line">  ASSERT(!delete_me_);</span><br><span class="line">  pool_ = pool;</span><br><span class="line">  start_callback_ = start_callback;</span><br><span class="line">  end_callback_ = end_callback;</span><br><span class="line">  callback_data_ = data;</span><br><span class="line">  task_running_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">bool</span> result = **pool_-&gt;Run&lt;MessageHandlerTask&gt;(<span class="keyword">this</span>);**</span><br><span class="line">  <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">    pool_ = <span class="literal">nullptr</span>;</span><br><span class="line">    start_callback_ = <span class="literal">nullptr</span>;</span><br><span class="line">    end_callback_ = <span class="literal">nullptr</span>;</span><br><span class="line">    callback_data_ = <span class="number">0</span>;</span><br><span class="line">    task_running_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> &#123;</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Run</span><span class="params">(Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RunImpl(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt;(<span class="keyword">new</span> T(<span class="built_in">std</span>::forward&lt;Args&gt;(args)...)));</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ThreadPool::RunImpl</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; task)</span> </span>&#123;</span><br><span class="line">  Worker* new_worker = <span class="literal">nullptr</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;pool_monitor_)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (shutting_down_) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ä»çº¿ç¨‹æ± ä¸­è·å–taskï¼Œå¦‚æœæœ‰ç©ºé—²çš„/è¾¾åˆ°æœ€å¤§æ•°é‡å°±å°è¯•å¤ç”¨ï¼ˆæ­¤æ—¶è¿™é‡Œè¿”å›nullï¼‰</span></span><br><span class="line"><span class="comment">// å¦åˆ™åˆ›å»ºæ–°çš„å¹¶è¿”å›</span></span><br><span class="line">    new_worker = **ScheduleTaskLocked**(&amp;ml, <span class="built_in">std</span>::move(task));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (new_worker != <span class="literal">nullptr</span>) &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„Workeråœ¨æ–°çš„ç³»ç»Ÿçº¿ç¨‹è¿è¡Œtask</span></span><br><span class="line">    new_worker-&gt;**StartThread()**;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ThreadPool::Worker::StartThread() &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼Œè¿è¡ŒæŒ‡å®šçš„ä»£ç ï¼Œ</span></span><br><span class="line"><span class="comment">//  androidçš„å®ç°åœ¨runtime\vm\os_thread_android.cc</span></span><br><span class="line">  <span class="keyword">int</span> result = OSThread::Start(<span class="string">"DartWorker"</span>, &amp;**Worker::Main**,</span><br><span class="line">                               <span class="keyword">reinterpret_cast</span>&lt;uword&gt;(<span class="keyword">this</span>));</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">    FATAL1(<span class="string">"Could not start worker thread: result = %d."</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>ThreadPool::ScheduleTaskLocked</code>æ–¹æ³•è·å–<code>new_worker</code>ï¼š</p><ul><li>å¦‚æœå·²æœ‰çš„workeræœ‰ç©ºé—²çš„æˆ–è€…å·²ç»è¾¾åˆ°æœ€å¤§æ•°ç›®äº†ï¼Œå°±ç­‰å¾…å·²æœ‰çš„workeræ‰§è¡Œä»»åŠ¡</li><li>å¦åˆ™å°±åˆ›å»ºæ–°çš„workerï¼Œå¹¶åœ¨æ–°çš„çº¿ç¨‹è¿è¡Œ</li></ul><p>åœ¨è·å–åˆ°workerä¹‹åï¼Œå°±æ‰§è¡Œ<code>MessageHandlerTask</code>ï¼ˆè§ä¸‹æ–‡è¯¦ç»†åˆ†æï¼‰ã€‚</p><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨3ç‚¹ï¼š</p><ul><li><code>ScheduleTaskLocked</code> åˆ†é…Worker</li><li><code>OSThread::Start</code>ä¸­ä½¿ç”¨<code>&amp;Worker::Main</code> åœ¨æ–°ç³»ç»Ÿçº¿ç¨‹å¼€å¯Workerå¾ªç¯</li><li><code>MessageHandlerTask</code> æ‰§è¡Œå…·ä½“çš„æ¶ˆæ¯åˆ†å‘å†…å®¹</li></ul><h4 id="ScheduleTaskLocked"><a href="#ScheduleTaskLocked" class="headerlink" title="ScheduleTaskLocked"></a><strong>ScheduleTaskLocked</strong></h4><p>å…ˆè¯¦ç»†çœ‹ä¸€ä¸‹è·å–<code>new_worker</code>çš„<code>ThreadPool::ScheduleTaskLocked</code>æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">ThreadPool::Worker* <span class="title">ThreadPool::ScheduleTaskLocked</span><span class="params">(MonitorLocker* ml,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                   <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; task)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Enqueue the new task.</span></span><br><span class="line">  tasks_.Append(task.release());</span><br><span class="line">  pending_tasks_++;</span><br><span class="line">  ASSERT(pending_tasks_ &gt;= <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify existing idle worker (if available).</span></span><br><span class="line">  <span class="keyword">if</span> (count_idle_ &gt;= pending_tasks_) &#123;</span><br><span class="line">    ASSERT(!idle_workers_.IsEmpty());</span><br><span class="line">    ml-&gt;Notify();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have maxed out the number of threads running, we will not start a</span></span><br><span class="line">  <span class="comment">// new one.</span></span><br><span class="line">  <span class="keyword">if</span> (max_pool_size_ &gt; <span class="number">0</span> &amp;&amp; (count_idle_ + count_running_) &gt;= max_pool_size_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!idle_workers_.IsEmpty()) &#123;</span><br><span class="line">      ml-&gt;Notify();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Otherwise start a new worker.</span></span><br><span class="line">  <span class="keyword">auto</span> new_worker = <span class="keyword">new</span> Worker(<span class="keyword">this</span>);</span><br><span class="line">  idle_workers_.Append(new_worker);</span><br><span class="line">  count_idle_++;</span><br><span class="line">  <span class="keyword">return</span> new_worker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š</p><p>å°†å½“å‰ä»»åŠ¡åŠ å…¥åˆ°<code>tasks_</code>é˜Ÿåˆ—ä¸­ã€‚</p><ul><li>å¦‚æœç©ºé—²<code>count_idle_</code> çš„Workeræ¯”ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•°<code>pending_tasks_</code>å¤šï¼Œé‚£å°±å‘é€é€šçŸ¥ï¼Œä½¿ç”¨å·²æœ‰çš„Workerå¤„ç†ä»»åŠ¡ã€‚</li><li>å¦‚æœå½“å‰Workeræ•°é‡å·²ç»æœ€å¤§äº†ï¼Œé‚£å°±å°†ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•°pending_tasks_ åŠ ä¸€ï¼Œç­‰å¾…æœ‰ç©ºé—²çš„Workerå¤„ç†ä»»åŠ¡ã€‚</li><li>å¦åˆ™ï¼Œå°±æ–°å»ºä¸€ä¸ªWorkerï¼ˆä¼šå¯¹åº”åˆ›å»ºä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼‰æ¥å¤„ç†ä»»åŠ¡ã€‚</li></ul><h4 id="amp-Worker-Main"><a href="#amp-Worker-Main" class="headerlink" title="&amp;Worker::Main"></a>&amp;<strong>Worker::Main</strong></h4><p>åœ¨<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>è¿™é‡Œï¼ŒStartThreadçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<strong><code>&amp;Worker::Main</code></strong>å¯åŠ¨äº†ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­çš„åœ¨ä»»åŠ¡é˜Ÿåˆ—<code>tasks_</code>ä¸­å–å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line">ThreadPool::Worker::Main(uword args)&#123;</span><br><span class="line">Worker* worker = <span class="keyword">reinterpret_cast</span>&lt;Worker*&gt;(args);</span><br><span class="line">  ThreadPool* pool = worker-&gt;pool_;</span><br><span class="line"></span><br><span class="line">pool-&gt;WorkerLoop(worker);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ThreadPool::WorkerLoop</span><span class="params">(Worker* worker)</span> </span>&#123;</span><br><span class="line">  WorkerList dead_workers_to_join;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;pool_monitor_)</span></span>;</span><br><span class="line"><span class="comment">// workerä¼šä»task_å–å‡ºä¸€ä¸ªtaskå¹¶è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (!tasks_.IsEmpty()) &#123;</span><br><span class="line">      IdleToRunningLocked(worker);</span><br><span class="line">      <span class="keyword">while</span> (!tasks_.IsEmpty()) &#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; <span class="title">task</span><span class="params">(tasks_.RemoveFirst())</span></span>;</span><br><span class="line">        pending_tasks_--;</span><br><span class="line">        <span class="function">MonitorLeaveScope <span class="title">mls</span><span class="params">(&amp;ml)</span></span>;</span><br><span class="line">        **task-&gt;Run();**</span><br><span class="line">        ASSERT(Isolate::Current() == <span class="literal">nullptr</span>);</span><br><span class="line">        task.reset();</span><br><span class="line">      &#125;</span><br><span class="line">      RunningToIdleLocked(worker);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (running_workers_.IsEmpty()) &#123;</span><br><span class="line">      ASSERT(tasks_.IsEmpty());</span><br><span class="line">      OnEnterIdleLocked(&amp;ml);</span><br><span class="line">      <span class="keyword">if</span> (!tasks_.IsEmpty()) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shutting_down_) &#123;</span><br><span class="line">      ObtainDeadWorkersLocked(&amp;dead_workers_to_join);</span><br><span class="line">      IdleToDeadLocked(worker);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sleep until we get a new task, we time out or we're shutdown.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int64_t</span> idle_start = OS::GetCurrentMonotonicMicros();</span><br><span class="line">    <span class="keyword">bool</span> done = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> result = ml.WaitMicros(ComputeTimeout(idle_start));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// We have to drain all pending tasks.</span></span><br><span class="line">      <span class="keyword">if</span> (!tasks_.IsEmpty()) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (shutting_down_ || result == Monitor::kTimedOut) &#123;</span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">      ObtainDeadWorkersLocked(&amp;dead_workers_to_join);</span><br><span class="line">      IdleToDeadLocked(worker);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before we transitioned to dead we obtained the list of previously died dead</span></span><br><span class="line">  <span class="comment">// workers, which we join here. Since every death of a worker will join</span></span><br><span class="line">  <span class="comment">// previously died workers, we keep the pending non-joined [dead_workers_] to</span></span><br><span class="line">  <span class="comment">// effectively 1.</span></span><br><span class="line">  JoinDeadWorkersLocked(&amp;dead_workers_to_join);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>MessageHandlerTask</strong> </p><p>æ— è®ºæ˜¯å“ªç§Worker,æœ€åéƒ½æ˜¯æ‰§è¡Œçš„<code>MessageHandlerTask</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageHandlerTask</span> :</span> <span class="keyword">public</span> ThreadPool::Task &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">MessageHandlerTask</span><span class="params">(MessageHandler* handler)</span> : <span class="title">handler_</span><span class="params">(handler)</span> </span>&#123;</span><br><span class="line">ASSERT(handler != <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">ASSERT(handler_ != <span class="literal">NULL</span>);</span><br><span class="line">handler_-&gt;TaskCallback();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MessageHandler::TaskCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ASSERT(Isolate::Current() == <span class="literal">NULL</span>);</span><br><span class="line">  MessageStatus status = kOK;</span><br><span class="line">  <span class="keyword">bool</span> run_end_callback = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> delete_me = <span class="literal">false</span>;</span><br><span class="line">  EndCallback end_callback = <span class="literal">NULL</span>;</span><br><span class="line">  CallbackData callback_data = <span class="number">0</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// We will occasionally release and reacquire this monitor in this</span></span><br><span class="line">    <span class="comment">// function. Whenever we reacquire the monitor we *must* process</span></span><br><span class="line">    <span class="comment">// all pending OOB messages, or we may miss a request for vm</span></span><br><span class="line">    <span class="comment">// shutdown.</span></span><br><span class="line">    <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;monitor_)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This method is running on the message handler task. Which means no</span></span><br><span class="line">    <span class="comment">// other message handler tasks will be started until this one sets</span></span><br><span class="line">    <span class="comment">// [task_running_] to false.</span></span><br><span class="line">    ASSERT(task_running_);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(PRODUCT)</span></span><br><span class="line">    <span class="keyword">if</span> (ShouldPauseOnStart(kOK)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!is_paused_on_start()) &#123;</span><br><span class="line">        PausedOnStartLocked(&amp;ml, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// More messages may have come in before we (re)acquired the monitor.</span></span><br><span class="line">      status = HandleMessages(&amp;ml, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (ShouldPauseOnStart(status)) &#123;</span><br><span class="line">        <span class="comment">// Still paused.</span></span><br><span class="line">        ASSERT(oob_queue_-&gt;IsEmpty());</span><br><span class="line">        task_running_ = <span class="literal">false</span>;  <span class="comment">// No task in queue.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PausedOnStartLocked(&amp;ml, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_paused_on_exit()) &#123;</span><br><span class="line">      status = HandleMessages(&amp;ml, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (ShouldPauseOnExit(status)) &#123;</span><br><span class="line">        <span class="comment">// Still paused.</span></span><br><span class="line">        ASSERT(oob_queue_-&gt;IsEmpty());</span><br><span class="line">        task_running_ = <span class="literal">false</span>;  <span class="comment">// No task in queue.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PausedOnExitLocked(&amp;ml, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !defined(PRODUCT)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == kOK) &#123;</span><br><span class="line">      <span class="keyword">if</span> (start_callback_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// Initialize the message handler by running its start function,</span></span><br><span class="line">        <span class="comment">// if we have one.  For an isolate, this will run the isolate's</span></span><br><span class="line">        <span class="comment">// main() function.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Release the monitor_ temporarily while we call the start callback.</span></span><br><span class="line">        ml.Exit();</span><br><span class="line">        status = start_callback_(callback_data_);</span><br><span class="line">        ASSERT(Isolate::Current() == <span class="literal">NULL</span>);</span><br><span class="line">        start_callback_ = <span class="literal">NULL</span>;</span><br><span class="line">        ml.Enter();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Handle any pending messages for this message handler.</span></span><br><span class="line">      <span class="keyword">if</span> (status != kShutdown) &#123;</span><br><span class="line">        status = HandleMessages(&amp;ml, (status == kOK), <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The isolate exits when it encounters an error or when it no</span></span><br><span class="line">    <span class="comment">// longer has live ports.</span></span><br><span class="line">    <span class="keyword">if</span> (status != kOK || !HasLivePorts()) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(PRODUCT)</span></span><br><span class="line">      <span class="keyword">if</span> (ShouldPauseOnExit(status)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (FLAG_trace_service_pause_events) &#123;</span><br><span class="line">          OS::PrintErr(</span><br><span class="line">              <span class="string">"Isolate %s paused before exiting. "</span></span><br><span class="line">              <span class="string">"Use the Observatory to release it.\n"</span>,</span><br><span class="line">              name());</span><br><span class="line">        &#125;</span><br><span class="line">        PausedOnExitLocked(&amp;ml, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// More messages may have come in while we released the monitor.</span></span><br><span class="line">        **status = HandleMessages(&amp;ml, <span class="literal">false</span>, <span class="literal">false</span>);**</span><br><span class="line">        <span class="keyword">if</span> (ShouldPauseOnExit(status)) &#123;</span><br><span class="line">          <span class="comment">// Still paused.</span></span><br><span class="line">          ASSERT(oob_queue_-&gt;IsEmpty());</span><br><span class="line">          task_running_ = <span class="literal">false</span>;  <span class="comment">// No task in queue.</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          PausedOnExitLocked(&amp;ml, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !defined(PRODUCT)</span></span></span><br><span class="line">      <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status != kOK &amp;&amp; thread() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> Error&amp; error = Error::Handle(thread()-&gt;sticky_error());</span><br><span class="line">          OS::PrintErr(</span><br><span class="line">              <span class="string">"[-] Stopping message handler (%s):\n"</span></span><br><span class="line">              <span class="string">"\thandler:    %s\n"</span></span><br><span class="line">              <span class="string">"\terror:    %s\n"</span>,</span><br><span class="line">              MessageStatusString(status), name(), error.ToCString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          OS::PrintErr(</span><br><span class="line">              <span class="string">"[-] Stopping message handler (%s):\n"</span></span><br><span class="line">              <span class="string">"\thandler:    %s\n"</span>,</span><br><span class="line">              MessageStatusString(status), name());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      pool_ = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="comment">// Decide if we have a callback before releasing the monitor.</span></span><br><span class="line">      end_callback = end_callback_;</span><br><span class="line">      callback_data = callback_data_;</span><br><span class="line">      run_end_callback = end_callback_ != <span class="literal">NULL</span>;</span><br><span class="line">      delete_me = delete_me_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear task_running_ last.  This allows other tasks to potentially start</span></span><br><span class="line">    <span class="comment">// for this message handler.</span></span><br><span class="line">    ASSERT(oob_queue_-&gt;IsEmpty());</span><br><span class="line">    task_running_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The handler may have been deleted by another thread here if it is a native</span></span><br><span class="line">  <span class="comment">// message handler.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Message handlers either use delete_me or end_callback but not both.</span></span><br><span class="line">  ASSERT(!delete_me || !run_end_callback);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (run_end_callback) &#123;</span><br><span class="line">    ASSERT(end_callback != <span class="literal">NULL</span>);</span><br><span class="line">    end_callback(callback_data);</span><br><span class="line">    <span class="comment">// The handler may have been deleted after this point.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (delete_me) &#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ‰§è¡Œäº†<code>MessageHandler::HandleMessages</code>æ–¹æ³•ï¼Œæ¥å¤„ç†æ¶ˆæ¯ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line">MessageHandler::MessageStatus MessageHandler::HandleMessages(</span><br><span class="line">    MonitorLocker* ml,</span><br><span class="line">    bool allow_normal_messages,</span><br><span class="line">    bool allow_multiple_normal_messages) &#123;</span><br><span class="line">  ASSERT(monitor_.IsOwnedByCurrentThread());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Scheduling of the mutator thread during the isolate start can cause this</span></span><br><span class="line">  <span class="comment">// thread to safepoint.</span></span><br><span class="line">  <span class="comment">// We want to avoid holding the message handler monitor during the safepoint</span></span><br><span class="line">  <span class="comment">// operation to avoid possible deadlocks, which can occur if other threads are</span></span><br><span class="line">  <span class="comment">// sending messages to this message handler.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// If isolate() returns nullptr [StartIsolateScope] does nothing.</span></span><br><span class="line">  ml-&gt;Exit();</span><br><span class="line">  StartIsolateScope start_isolate(isolate());</span><br><span class="line">  ml-&gt;Enter();</span><br><span class="line"></span><br><span class="line">  auto idle_time_handler =</span><br><span class="line">      isolate() != nullptr ? isolate()-&gt;group()-&gt;idle_time_handler() : nullptr;</span><br><span class="line"></span><br><span class="line">  MessageStatus max_status = kOK;</span><br><span class="line">  Message::Priority min_priority =</span><br><span class="line">      ((allow_normal_messages &amp;&amp; !paused()) ? Message::kNormalPriority</span><br><span class="line">                                            : Message::kOOBPriority);</span><br><span class="line">  std::unique_ptr&lt;Message&gt; **message = DequeueMessage(min_priority);**</span><br><span class="line">  <span class="keyword">while</span> (message != nullptr) &#123;</span><br><span class="line">    intptr_t message_len = message-&gt;Size();</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">      OS::PrintErr(</span><br><span class="line">          <span class="string">"[&lt;] Handling message:\n"</span></span><br><span class="line">          <span class="string">"\tlen:        %"</span> Pd</span><br><span class="line">          <span class="string">"\n"</span></span><br><span class="line">          <span class="string">"\thandler:    %s\n"</span></span><br><span class="line">          <span class="string">"\tport:       %"</span> Pd64 <span class="string">"\n"</span>,</span><br><span class="line">          message_len, name(), message-&gt;dest_port());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Release the monitor_ temporarily while we handle the message.</span></span><br><span class="line">    <span class="comment">// The monitor was acquired in MessageHandler::TaskCallback().</span></span><br><span class="line">    ml-&gt;Exit();</span><br><span class="line">    Message::Priority saved_priority = message-&gt;priority();</span><br><span class="line">    Dart_Port saved_dest_port = message-&gt;dest_port();</span><br><span class="line">    MessageStatus status = kOK;</span><br><span class="line">    &#123;</span><br><span class="line">      DisableIdleTimerScope disable_idle_timer(idle_time_handler);</span><br><span class="line">      status = HandleMessage(std::move(message));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status &gt; max_status) &#123;</span><br><span class="line">      max_status = status;</span><br><span class="line">    &#125;</span><br><span class="line">    ml-&gt;Enter();</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">      OS::PrintErr(</span><br><span class="line">          <span class="string">"[.] Message handled (%s):\n"</span></span><br><span class="line">          <span class="string">"\tlen:        %"</span> Pd</span><br><span class="line">          <span class="string">"\n"</span></span><br><span class="line">          <span class="string">"\thandler:    %s\n"</span></span><br><span class="line">          <span class="string">"\tport:       %"</span> Pd64 <span class="string">"\n"</span>,</span><br><span class="line">          MessageStatusString(status), message_len, name(), saved_dest_port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If we are shutting down, do not process any more messages.</span></span><br><span class="line">    <span class="keyword">if</span> (status == kShutdown) &#123;</span><br><span class="line">      ClearOOBQueue();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember time since the last message. Don't consider OOB messages so</span></span><br><span class="line">    <span class="comment">// using Observatory doesn't trigger additional idle tasks.</span></span><br><span class="line">    <span class="keyword">if</span> ((FLAG_idle_timeout_micros != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        (saved_priority == Message::kNormalPriority)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (idle_time_handler != nullptr) &#123;</span><br><span class="line">        idle_time_handler-&gt;UpdateStartIdleTime();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some callers want to process only one normal message and then quit. At</span></span><br><span class="line">    <span class="comment">// the same time it is OK to process multiple OOB messages.</span></span><br><span class="line">    <span class="keyword">if</span> ((saved_priority == Message::kNormalPriority) &amp;&amp;</span><br><span class="line">        !allow_multiple_normal_messages) &#123;</span><br><span class="line">      <span class="comment">// We processed one normal message.  Allow no more.</span></span><br><span class="line">      allow_normal_messages = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reevaluate the minimum allowable priority.  The paused state</span></span><br><span class="line">    <span class="comment">// may have changed as part of handling the message.  We may also</span></span><br><span class="line">    <span class="comment">// have encountered an error during message processing.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Even if we encounter an error, we still process pending OOB</span></span><br><span class="line">    <span class="comment">// messages so that we don't lose the message notification.</span></span><br><span class="line">    min_priority = (((max_status == kOK) &amp;&amp; allow_normal_messages &amp;&amp; !paused())</span><br><span class="line">                        ? Message::kNormalPriority</span><br><span class="line">                        : Message::kOOBPriority);</span><br><span class="line">    message = DequeueMessage(min_priority);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> max_status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MessageHandler::DequeueMessage</code>åˆ™æ˜¯æŒ‰ç…§ä¼˜å…ˆçº§ï¼Œä¾æ¬¡ä»<code>oob_queue_</code>å’Œ<code>queue_</code>ä¸­è·å–æ¶ˆæ¯ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;Message&gt; MessageHandler::DequeueMessage(</span><br><span class="line">    Message::Priority min_priority) &#123;</span><br><span class="line">  <span class="comment">// TODO(turnidge): Add assert that monitor_ is held here.</span></span><br><span class="line">  std::unique_ptr&lt;Message&gt; message = oob_queue_-&gt;Dequeue();</span><br><span class="line">  <span class="keyword">if</span> ((message == nullptr) &amp;&amp; (min_priority &lt; Message::kOOBPriority)) &#123;</span><br><span class="line">    message = queue_-&gt;Dequeue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äº<code>oob_queue_</code>å’Œ<code>queue_</code> çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageHandler</span> </span>&#123;</span><br><span class="line">MessageQueue* queue_;</span><br><span class="line">  MessageQueue* oob_queue_;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\message.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"><span class="comment">// A message processed at any interrupt point (stack overflow check) instead</span></span><br><span class="line">  <span class="comment">// of at the top of the message loop. Control messages from dart:isolate or</span></span><br><span class="line">  <span class="comment">// vm-service requests.</span></span><br><span class="line">  bool IsOOB() <span class="keyword">const</span> &#123; <span class="keyword">return</span> priority_ == Message::kOOBPriority; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¶ˆæ¯å¤„ç†çš„æ­¥éª¤ä¹Ÿå¯åŠ¨äº†ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>Dart_RunLoopAsync</code>çš„ä¸»è¦åŠŸèƒ½æ˜¯è§¦å‘isolateçš„<code>message_handler</code>å¤„ç†æ¶ˆæ¯åˆ†å‘ï¼š</p><p><code>Dart_RunLoopAsync</code> â†’ <code>Isolate::Run()</code> â†’  <code>message_handler()-&gt;Run()</code> â†’ <strong>pool_-&gt;</strong><code>Run&lt;MessageHandlerTask&gt;</code> <strong>â†’</strong> <code>ThreadPool::RunImpl</code></p><p>åœ¨<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>è¿™é‡Œä¸»è¦è§¦å‘äº†2æ­¥ï¼š</p><ul><li><code>ScheduleTaskLocked</code>è·å–åˆ°<code>new_worker</code></li><li><code>new_worker</code>è°ƒç”¨<code>ThreadPool::Worker::StartThread()</code>æ–¹æ³•å¼€å¯å¾ªç¯</li></ul><p>ç„¶åæ ¹æ®æ˜¯å¦åˆ›å»ºäº†<code>new_worker</code>æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>æœ‰<code>new_worker</code>ï¼Œä½¿ç”¨åœ¨<code>OSThread::Start</code>æ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼Œæ‰§è¡Œ<code>ThreadPool::Worker::Main</code>ï¼ˆè¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨ä½¿ç”¨<code>new_worker</code>ä»çº¿ç¨‹æ± ä¸­çš„å–å‡ºä»»åŠ¡æ‰§è¡Œï¼‰</li><li>æ²¡æœ‰<code>new_worker</code>ï¼Œé‚£ä¹ˆç­‰å¾…å·²æœ‰çš„Workerç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡</li></ul><p>æ— è®ºå¦‚ä½•ï¼Œè¿™é‡Œçš„Workerè¦æ‰§è¡Œçš„ä»»åŠ¡éƒ½æ˜¯åœ¨<code>MessageHandler::Run</code>æ–¹æ³•ä¸­æŒ‡å®šçš„<code>MessageHandlerTask</code> ï¼Œè€Œè¿™ä¸ªä»»åŠ¡çš„å†…å®¹ä¾¿æ˜¯å¼€å¯<code>MessageHandler::HandleMessages</code> æ–¹æ³•ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§ä¸æ–­çš„ä¾æ¬¡ä»<code>oob_queue_</code>å’Œ<code>queue_</code>ä¸­è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p> <img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri_dart_and_native.png" alt></p><p>Isolateæ˜¯Dartä»£ç è¿è¡Œçš„åœ°æ–¹ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„event loopï¼Œå’Œå…¨å±€å˜é‡ï¼Œåœ¨è‡ªå·±å•ç‹¬çš„çº¿ç¨‹è¿è¡Œã€‚</p><p>Isolate.spawné»˜è®¤ä¼šåˆ›å»ºåœ¨åŒä¸€ä¸ªIsolateGroupä¸­çš„Isolateï¼Œä»–ä»¬ä¹‹é—´å…±äº«Heapï¼ˆè¿™é‡Œä¼šå‘ç”ŸGCï¼‰å’Œä¸€ä¸ªçº¿ç¨‹æ± ã€‚</p><p>Isolate.spawnUriä¼šä»åˆ¶å®šçš„Uriä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„IsolateGroupå’Œå¯¹åº”çš„Isolateï¼Œå¹¶æ‰§è¡ŒUriä¸­çš„mainæ–¹æ³•ã€‚</p><p>Isolateå†…éƒ¨ç»´æŒä¸€ä¸ªEvent Loopã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Flutter UI ç»˜åˆ¶ä¸InheritedWidgetè§£æ</title>
      <link href="/blog/posts/4c220635/"/>
      <url>/blog/posts/4c220635/</url>
      
        <content type="html"><![CDATA[<h1 id="Flutter-UI-ç»˜åˆ¶ä¸InheritedWidgetè§£æ"><a href="#Flutter-UI-ç»˜åˆ¶ä¸InheritedWidgetè§£æ" class="headerlink" title="Flutter UI ç»˜åˆ¶ä¸InheritedWidgetè§£æ"></a>Flutter UI ç»˜åˆ¶ä¸InheritedWidgetè§£æ</h1><p>Flutterçš„<code>Widget</code>åˆ†ä¸º<code>StatefulWidget</code>å’Œ<code>StatelessWidget</code> ï¼ŒäºŒè€…éƒ½ç»§æ‰¿è‡ª<code>Widget</code>ã€‚</p><p>æ­¤å¤–è¿˜æœ‰ä¸€ç§ç”¨æ¥ä¼ è¾“æ•°æ®çš„<code>Widget</code>â€”â€”<code>InheritedWidget</code>ï¼Œä¸ä¸Šè¿°ä¸¤è€…ä¸å¤ªä¸€æ ·çš„æ˜¯ï¼Œä»–çš„ç»§æ‰¿å…³ç³»æ˜¯ï¼š<code>InheritedWidget</code>â†’<code>ProxyWidget</code> â†’<code>Widget</code> ã€‚</p><p>Flutterçš„æ¸²æŸ“æµç¨‹å¦‚å›¾ï¼š</p><p><img src="https://jixiaoyong.github.io/images/flutter_widget_element_renderobject_relationship.png" alt="flutter_widget_element_renderobject_relationship"></p><p>å¯ä»¥ç®€å•ç†è§£ä¸ºï¼Œ <code>Widget</code>æ˜¯é…ç½®ä¿¡æ¯ï¼Œ<code>Element</code>ä»£è¡¨åœ¨æ ‘ä¸­è¯¦ç»†çš„ä½ç½®ï¼Œè€Œ<code>RenderObject</code>åˆ™æ˜¯å®é™…æ¸²æŸ“ã€‚</p><p><code>StatelessWidget</code>å’Œ<code>StatefulWidget</code>åœ¨åˆ›å»ºä¹‹åå°±ä¸ä¼šå†å˜åŒ–ï¼Œè€Œ<code>StatefulWidget</code>å› ä¸ºæœ‰<code>State</code>ï¼Œæ‰€ä»¥å¯ä»¥åœ¨<code>State</code>è°ƒç”¨<code>setState()</code>æ–¹æ³•ä¹‹åï¼Œé‡æ–°æ‰§è¡Œ<code>State</code>çš„<code>build()</code>æ–¹æ³•ï¼Œä»è€Œæ›´æ–°ç•Œé¢ã€‚</p><p>å¦‚æœ<code>Widget</code>æ˜¯<code>const</code>çš„ï¼Œé‚£ä¹ˆä»–å°±ä¸ä¼šè¢«<code>rebuild</code>ã€‚</p><h1 id="Widget-Rebuildçš„è¿‡ç¨‹"><a href="#Widget-Rebuildçš„è¿‡ç¨‹" class="headerlink" title="Widget Rebuildçš„è¿‡ç¨‹"></a>Widget Rebuildçš„è¿‡ç¨‹</h1><p>ä»¥StatefulWidgetä¸ºä¾‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/flutter_render_flow_chart.png" alt="flutter_render_flow_chart"></p><ol><li><p>è°ƒç”¨<code>setState()</code>æ–¹æ³•ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„<code>Element</code>çš„<code>markNeedsBuild()</code> æ–¹æ³•ï¼Œé€šè¿‡<code>BuildOwner</code>çš„<code>scheduleBuildFor(Element element)</code> æ–¹æ³•å°†å½“å‰<code>Element</code>æ ‡è®°ä¸º<code>dirty</code>ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡å±å¹•åˆ·æ–°æ—¶å®‰æ’<em><code>rebuilt</code> ã€‚</em></p></li><li><p>ä¸‹ä¸€å¸§å±å¹•åˆ·æ–°ï¼Œè°ƒç”¨<code>BuildOwner</code>çš„<code>buildScope(Element context, [ VoidCallback? callback ])</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šéå†<code>_dirtyElements</code> ä¸­æ‰€æœ‰<code>dirty</code>çš„<code>element</code>æ‰§è¡Œ<code>element.rebuild();</code> æ–¹æ³•ï¼Œåœ¨å…¶å†…éƒ¨è°ƒç”¨äº†<code>Element</code>çš„<code>performRebuild()</code> æ–¹æ³•ã€‚</p></li><li><p><code>Element</code>çš„<code>performRebuild()</code> æ–¹æ³•å› å„ä¸ª<code>Element</code>çš„å®ç°è€Œå¼‚ï¼š</p><ol><li><p><code>StatelessElement</code> ã€<em><code>InheritedElement</code></em>ï¼šä¸çˆ¶ç±»<code>ComponentElement</code> ä¿æŒä¸€è‡´</p></li><li><p><code>StatefulElement</code> ï¼šåˆ¤æ–­æœ‰éœ€è¦æ—¶è°ƒç”¨<code>state.didChangeDependencies();</code> ï¼Œå…¶ä½™ä¸çˆ¶ç±»<code>ComponentElement</code> ä¿æŒä¸€è‡´</p></li></ol></li></ol><p>è€Œ<code>ComponentElement</code> çš„<code>performRebuild()</code> ä¸»è¦åšäº†2ä»¶äº‹ï¼š<br>ï¼ˆ1ï¼‰<code>built = build();</code> ï¼›ï¼ˆ2ï¼‰<code>_child = updateChild(_child, built, slot);</code></p><p>åœ¨è¿™å…¶ä¸­<code>build()</code>ï¼š</p><ol><li><code>StatelessElement</code>:<code>build() =&gt; widget.build(this);</code></li><li><code>StatefulElement</code> : <code>build() =&gt; state.build(this);</code></li><li><code>InheritedElement</code> :<code>build() =&gt; widget.child;</code></li></ol><p><code>updateChild</code> ä¼šåˆ¤æ–­ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><table><thead><tr><th></th><th>newWidget == null</th><th>newWidget != null</th></tr></thead><tbody><tr><td>child == null</td><td>return null</td><td>return new Element</td></tr><tr><td>child != null</td><td>remove old child, return null</td><td>Old child updated if possible, returns child or new Element</td></tr></tbody></table><p>å…¶ä¸­ï¼Œ<code>old child updated</code> çš„æ—¶å€™è°ƒç”¨çš„æ˜¯<code>child.update(newWidget);</code> æ–¹æ³•ä¼šè§¦å‘<code>Widget</code>çš„<code>rebuild()</code> ã€‚</p><p>è¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡Rebuildã€‚</p><h1 id="InheritedWidgetçš„Rebuildè¿‡ç¨‹"><a href="#InheritedWidgetçš„Rebuildè¿‡ç¨‹" class="headerlink" title="InheritedWidgetçš„Rebuildè¿‡ç¨‹"></a>InheritedWidgetçš„Rebuildè¿‡ç¨‹</h1><p><code>InheritedWidget</code>æ˜¯æŒæœ‰çŠ¶æ€çš„<code>Widget</code>ï¼Œä»–çš„å­<code>Widget</code>å¯ä»¥é€šè¿‡ä»–æ¥è·å–è¿™äº›çŠ¶æ€ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>InheritedWidget</code>æŒæœ‰çš„çŠ¶æ€æ˜¯<code>final</code>çš„ï¼Œå¦‚æœè¦æ›´æ–°çŠ¶æ€ï¼Œå°±éœ€è¦åœ¨å…¶å¤–éƒ¨åŒ…è£¹ä¸€ä¸ª<code>StatefulWidget</code>ï¼Œé€šè¿‡<code>StatefulWidget</code>çš„<code>State.setState()</code>æ¥è§¦å‘<code>InheritedWidget</code>é‡å»ºï¼ˆå®é™…ä¸Š<code>InheritedElement</code>æ²¡æœ‰é‡æ–°åˆ›å»ºï¼‰ï¼Œä»è€Œæ›´æ–°é‚£äº›ä¾èµ–äº†<code>InheritedWidget</code>çš„å­<code>Widget</code>ã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªè¢«<code>StatefulWidget</code>åŒ…è£¹çš„<code>InheritedWidget</code>åœ¨<code>setSate(){}</code>æ–¹æ³•æ‰§è¡Œåçš„æµç¨‹å›¾ï¼š</p><p><img src="https://jixiaoyong.github.io/images/flutter_render_flow_chart_with_inheritedwidget.png" alt="flutter_render_flow_chart_with_inheritedwidget"></p><p>å½“å¤–å±‚<code>StatefulWidget</code>çš„<code>Element</code>æ‰§è¡Œåˆ°<code>updateChild(child,build,solt);</code>ä¼šè°ƒç”¨<code>InheritedElement</code>çš„<code>update()</code> æ–¹æ³•ã€‚</p><p>è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨<code>updated(oldWidget)</code> æ–¹æ³•ï¼Œåœ¨å†…éƒ¨é€šè¿‡<code>notifyClients(oldWidget);</code> æ–¹æ³•ï¼Œé€šçŸ¥åŸå…ˆçš„<code>InheritedElement</code>çš„<code>_dependents</code> ï¼Œå°†å…¶æ ‡è®°ä¸º<code>dirty</code>ï¼Œå‡†å¤‡<code>rebuild</code>ã€‚</p><p>åœ¨æ­¤ä¹‹åï¼Œ<code>update()</code>æ–¹æ³•è¿˜ä¼šå°†å½“å‰<code>Element</code>æ ‡è®°ä¸º<code>dirty</code>ï¼Œé€šè¿‡è°ƒç”¨<code>rebuild();</code> æ‰§è¡Œ<code>performRebuild();</code> </p><p>åœ¨<code>performRebuild()</code>æ–¹æ³•ä¸­ï¼š</p><ul><li><code>built = build();</code> ä¸­çš„<code>build</code>æ–¹æ³•ï¼š<code>build() =&gt; widget.child;</code> å®é™…ä¸Šå–äº†<code>widget</code>çš„<code>child</code>ã€‚</li><li>ç„¶åæ‰§è¡Œ<code>_child = updateChild(_child, built, slot);</code> è¿™ä¸ªè¿‡ç¨‹ä¸æ™®é€š<code>Widget</code>ä¸€è‡´ã€‚</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>updateChild</code> ä¸­ï¼Œå¦‚æœå­<code>Widget</code>ä¸æ˜¯<code>const</code> ï¼ˆæˆ–è€…è¢«<code>InheritedWidget</code>å¤–å±‚çš„<code>widget</code>/<code>state</code>ä¹‹ç±»çš„æŒæœ‰ï¼‰å°±ä¼šè¢«è®¤ä¸º<code>built!=_child</code>  ä»è€Œå¯¼è‡´<code>InheritedWidget</code>çš„å­<code>Widget</code>é‡å»ºã€‚å¯¼è‡´çš„ç»“æœå°±æ˜¯ï¼šè™½ç„¶<code>InheritedWidget</code>çš„ç¡®åªæ ‡è®°äº†é‚£äº›ä¾èµ–äº†ä»–çš„<code>Widget</code>ï¼Œä½†æ˜¯ç”±äºç›´æ¥å­<code>Widget</code>è¦é‡å»ºï¼Œæ‰€ä»¥è¿˜æ˜¯æ‰€æœ‰çš„<code>éconst Widget</code>éƒ½é‡å»ºäº†ã€‚</p><h2 id="InheritedWidgetçš„è·å–æ–¹å¼"><a href="#InheritedWidgetçš„è·å–æ–¹å¼" class="headerlink" title="InheritedWidgetçš„è·å–æ–¹å¼"></a>InheritedWidgetçš„è·å–æ–¹å¼</h2><ul><li><code>T? dependOnInheritedWidgetOfExactType&lt;T extends InheritedWidget&gt;({ Object? aspect });</code> è·å–æŒ‡å®šç±»å‹çš„<code>InheritedWidget</code>ï¼Œå¹¶ä¸”å°†è‡ªå·±æ³¨å†Œåˆ°æ­¤<code>Widget</code>ï¼Œä»¥ä¾¿å½“è¯¥<code>Widget</code>å˜åŒ–çš„æ—¶å€™ï¼Œè‡ªå·±ä¹Ÿèƒ½<em><code>rebuilt</code> ã€‚å¤æ‚åº¦**<code>O(1)</code> ã€‚</em></li><li><code>T? findAncestorWidgetOfExactType&lt;T extends Widget&gt;();</code> åªè·å–æŒ‡å®šç±»å‹çš„<em><code>Widget</code> ï¼ŒåŒ…æ‹¬</em><code>InheritedWidget</code> ï¼Œä»…è·å–è¯¥<code>Widget</code>æ‰§è¡Œä¸€äº›æ“ä½œï¼Œé€šå¸¸ç”¨åœ¨<em><code>interaction event handlers</code></em> ä¹‹ç±»ä¸­ã€‚å¤æ‚åº¦<em><code>(O(N)</code> ã€‚</em></li></ul><h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>æ ¹æ®ä¸Šè¿°ç†è®ºï¼Œåˆ›å»ºä¸€ä¸ª<code>InheritedWidget</code>æ¥ä¼ é€’æ•°æ®ï¼š</p><p>1ã€<code>AppColor.dart</code> ä¸€ä¸ªæŒæœ‰<code>color</code> çš„<code>InheritedWidget</code>ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppColor</span> <span class="keyword">extends</span> <span class="title">InheritedWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Color color;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Function</span>(Color)? onColorChanged;</span><br><span class="line"></span><br><span class="line">  AppColor(&#123;</span><br><span class="line">    required <span class="keyword">this</span>.color,</span><br><span class="line">    required <span class="keyword">this</span>.child,</span><br><span class="line">    <span class="keyword">this</span>.onColorChanged,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(child: child);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> updateShouldNotify(<span class="keyword">covariant</span> AppColor oldWidget) =&gt;</span><br><span class="line">      color != oldWidget.color;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> AppColor? of(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;AppColor&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€å®šä¹‰ä¸€äº›ç±»ï¼Œä½¿ç”¨æˆ–æœªä½¿ç”¨åˆ°<code>InheritedWidget</code>ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoName</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> NoName(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"NoName build <span class="subst">$&#123;<span class="keyword">this</span>.hashCode&#125;</span>"</span>);</span><br><span class="line">    <span class="keyword">return</span> Column(</span><br><span class="line">      children: [</span><br><span class="line">        Column(</span><br><span class="line">          children: [</span><br><span class="line">            <span class="comment">// è¿™é‡ŒAppColorçš„_dependentsä¼šåŠ å…¥ColorfulContainer(dependencies: [AppColor])</span></span><br><span class="line">            <span class="comment">// å› ä¸ºä»–ç”¨äº†context.dependOnInheritedWidgetOfExactType&lt;AppColor&gt;();</span></span><br><span class="line">            <span class="comment">// ä¼šå°†è‡ªå·±æ³¨å†Œåˆ°AppColor</span></span><br><span class="line">            ColorfulContainer(),</span><br><span class="line">            ChangeStateButton(),</span><br><span class="line">            Text(<span class="string">"This Text Should Not Rebuild"</span>),</span><br><span class="line">          ],</span><br><span class="line">        )</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColorfulContainer</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  ColorfulContainer(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> appColor = AppColor.of(context);</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">"_ColorfulContainerState appColor?.color:<span class="subst">$&#123;appColor?.color&#125;</span> appColor:<span class="subst">$&#123;appColor.hashCode&#125;</span>"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      color: appColor?.color,</span><br><span class="line">      height: <span class="number">100</span>,</span><br><span class="line">      child: Text(<span class="string">"hello color <span class="subst">$&#123;appColor?.color&#125;</span>"</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeStateButton</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;ChangeStateButton&gt; createState() =&gt; _ChangeStateButtonState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ChangeStateButtonState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ChangeStateButton</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialButton(</span><br><span class="line">      onPressed: () &#123;</span><br><span class="line">        <span class="comment">// æ³¨æ„ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œåªæ˜¯æŸ¥æ‰¾åˆ°InheritedWidgetçš„å¼•ç”¨ï¼Œå¹¶æ²¡æœ‰æ³¨å†Œä¾èµ–</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å½“InheritedWidgetå˜åŒ–çš„æ—¶å€™å¹¶ä¸ä¼šè§¦å‘æ­¤æ§ä»¶é‡å»º</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæ¯æ¬¡onColorChangedæ—¶AppColoréƒ½ä¼šé‡å»ºï¼Œæ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œè·å–æœ€æ–°çš„</span></span><br><span class="line">        <span class="keyword">var</span> appColor = context.findAncestorWidgetOfExactType&lt;AppColor&gt;();</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">"_ChangeStateButtonState appColor?.color:<span class="subst">$&#123;appColor?.color&#125;</span> appColor:<span class="subst">$&#123;appColor.hashCode&#125;</span>"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> color = appColor?.color;</span><br><span class="line">        <span class="keyword">var</span> newColor = color == Colors.teal ? Colors.blueAccent : Colors.teal;</span><br><span class="line">        appColor?.onColorChanged?.call(newColor);</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">"_ChangeStateButtonState onPressed appColor?.color:<span class="subst">$&#123;appColor?.color&#125;</span> appColor:<span class="subst">$&#123;appColor.hashCode&#125;</span>"</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      child: Text(<span class="string">"Change State Button, Shlould NOT Rebuild"</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3ã€æ¥ä¸‹æ¥å®ç°ä¸€ç§åŸºç¡€çš„ä½¿ç”¨<code>InheritedWidget</code>çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•ä¼šåœ¨<code>InheritedWidget</code>æ›´æ–°çš„æ—¶å€™ï¼Œrebuilt <code>InheritedWidget</code>ä¸‹é¢çš„æ‰€æœ‰å­ç±»ï¼Œæ— è®ºä»–ä»¬æ˜¯å¦ä½¿ç”¨åˆ°äº†<code>InheritedWidget</code>ï¼ˆåŸå› æ˜¯ä¸Šé¢è¯´åˆ°çš„Flutter rebuildçš„æœºåˆ¶å¯¼è‡´çš„ï¼Œå®é™…ä¸Š<code>InheritedWidget</code>æœ¬èº«åªæ ‡è®°äº†<code>ColorfulContainer</code>ä¸º<em><code>dirty</code></em>ï¼‰ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlwaysRebuildWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Color color;</span><br><span class="line"></span><br><span class="line">  AlwaysRebuildWidget(&#123;Key? key, required <span class="keyword">this</span>.color&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;AlwaysRebuildWidget&gt; createState() =&gt; _AlwaysRebuildWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AlwaysRebuildWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AlwaysRebuildWidget</span>&gt; </span>&#123;</span><br><span class="line">  late Color _color;</span><br><span class="line">  <span class="keyword">var</span> child = NoName();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _color = widget.color;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// è¿™ç§å†™æ³•ï¼ŒAppColorçš„_dependentsä¹Ÿåªæœ‰1ä¸ª. ColorfulContainer(dependencies: [AppColor])</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æ¯æ¬¡setStateå¼•èµ·AlwaysRebuildWidgeté‡æ–°ç»˜åˆ¶ï¼Œå¼•èµ·AppColoré‡æ–°åˆ›å»ºï¼Œæœ¬åº”è¯¥ä¼šé‡å»ºColorfulContainer</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯å› ä¸ºbuildæ–¹æ³•é‡æ–°æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œæ‰€ä»¥AppColorå’Œæ•´ä¸ªNoNameéƒ½è¢«é‡å»ºï¼Œ</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"AlwaysRebuildWidget build<span class="subst">$&#123;widget.hashCode&#125;</span>"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> AppColor(</span><br><span class="line">        color: _color,</span><br><span class="line">        onColorChanged: (color) &#123;</span><br><span class="line">          setState(() &#123;</span><br><span class="line">            _color = color;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// è¿™ç§å†™æ³•ï¼ŒAppColoråœ¨updateChildçš„æ—¶å€™ä¼šåˆ¤æ–­widget.childä¸_child.widgetçš„NoNameä¸ä¸€è‡´</span></span><br><span class="line">        <span class="comment">// ï¼ˆè¿™æ˜¯å› ä¸ºï¼ŒAppColoråœ¨notifyClientsçš„æ—¶å€™ä¿®æ”¹äº†NoNameçš„childä¹‹ä¸€ColorfulContainerä¸ºdirtyï¼‰</span></span><br><span class="line">        <span class="comment">// ä»è€Œä¼šæ›´æ–°NoNameï¼Œå¯¼è‡´NoNameä¸‹é¢æ‰€æœ‰çš„å­Widgetå…¨éƒ¨é‡æ–°ç»˜åˆ¶</span></span><br><span class="line">         child: NoName());</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ä¸Šé¢åˆ†æçš„é€»è¾‘ï¼Œåœ¨è¿™é‡ŒåŠ ä¸Šconstï¼Œé‚£ä¹ˆä¾æ—§ç”¨çš„æ˜¯ä¹‹å‰çš„NoNameï¼Œå°±ä¸ä¼šrepaintæ•´ä¸ªçš„NoNameäº†</span></span><br><span class="line">    <span class="comment">// child: const NoName());</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4ã€æ¥ä¸‹æ¥å®ç°ä¸€ç§ä½¿ç”¨<code>InheritedWidget</code>çš„æ–¹æ³•ï¼Œå½“<code>InheritedWidget</code>æ›´æ–°çš„æ—¶å€™ï¼Œåªä¼šæ›´æ–°é‚£äº›åœ¨<code>InheritedWidget</code>è¿™é‡Œæ³¨å†Œä¾èµ–äº†çš„<code>Widget</code>ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SelectiveRebuildWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Color color;</span><br><span class="line"></span><br><span class="line">  SelectiveRebuildWidget(&#123;Key? key, required <span class="keyword">this</span>.child, required <span class="keyword">this</span>.color&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(key: key) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;SelectiveRebuildWidget&gt; createState() =&gt; _SelectiveRebuildWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_SelectiveRebuildWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">SelectiveRebuildWidget</span>&gt; </span>&#123;</span><br><span class="line">  late Color _color;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _color = widget.color;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">"SelectiveRebuildWidget build<span class="subst">$&#123;widget.child.hashCode&#125;</span>  <span class="subst">$&#123;widget.hashCode&#125;</span>"</span>);</span><br><span class="line">    <span class="keyword">return</span> AppColor(</span><br><span class="line">      color: _color,</span><br><span class="line">      onColorChanged: (color) &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          _color = color;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// è¿™é‡Œçš„AppColorçš„_dependentsåªæœ‰1ä¸ª. ColorfulContainer(dependencies: [AppColor])</span></span><br><span class="line">      <span class="comment">// å› ä¸ºsetStateä¸ä¼šé‡æ–°åˆ›å»ºSelectiveRebuildWidgetï¼Œæ‰€ä»¥widget.childä¹Ÿæ²¡æœ‰è¢«é‡æ–°</span></span><br><span class="line">      <span class="comment">// åˆ›å»ºï¼ˆä½†æ˜¯é‡æ–°ç»˜åˆ¶äº†ï¼Œå¯¼è‡´AppColorä¹Ÿé‡æ–°ç»˜åˆ¶ï¼‰</span></span><br><span class="line">      <span class="comment">// æ‰€ä»¥AppColorçš„childè¿˜æ˜¯ä¹‹å‰çš„ï¼ŒæŒ‰ç…§InheritedWidgetçš„è§„åˆ™ï¼Œåªæœ‰ColorfulContaineré‡æ–°ç»˜åˆ¶äº†</span></span><br><span class="line">      child: widget.child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://petercoding.com/flutter/2021/07/04/using-inherited-widget-in-flutter/" target="_blank" rel="noopener">Using Inherited Widget In Flutter</a></p><p><a href="https://www.cnblogs.com/lxlx1798/p/11190230.html?share_token=1bd95081-524b-4a3b-af65-686ab5c88ce4" target="_blank" rel="noopener">ã€Flutterå­¦ä¹ ã€‘ä¹‹Widgetæ•°æ®å…±äº«ä¹‹InheritedWidget æ¢é£å®‡</a></p><p><a href="https://stackoverflow.com/questions/54494398/inheritedwidget-confusion" target="_blank" rel="noopener">InheritedWidget confusion</a></p><p><a href="https://medium.com/flutter/managing-flutter-application-state-with-inheritedwidgets-1140452befe1" target="_blank" rel="noopener">Managing Flutter Application State With InheritedWidgets</a></p><p><a href="https://stackoverflow.com/questions/53492705/does-using-const-in-the-widget-tree-improve-performance" target="_blank" rel="noopener">Does using const in the widget tree improve performance?</a></p><p><a href="https://api.flutter-io.cn/flutter/widgets/StatefulWidget-class.html" target="_blank" rel="noopener">StatefulWidget</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter Expanded VS Flexible</title>
      <link href="/blog/posts/767a594/"/>
      <url>/blog/posts/767a594/</url>
      
        <content type="html"><![CDATA[<p>åœ¨Flutterä¸­ï¼Œå½“éœ€è¦å¡«å……å®¹å™¨ï¼ˆ<code>Row</code>, <code>Column</code>, or <code>Flex</code>ï¼‰å‰©ä½™ç©ºé—´çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨<code>Expanded</code>æˆ–<code>Flexible</code>ï¼Œæœ¬æ–‡å¯¹è¿™äºŒè€…çš„å·®å¼‚åšä¸€åˆ†æã€‚</p><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p><code>Expanded</code> æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä»–ä¼šå¼ºåˆ¶childæ”¹å˜å¤§å°ï¼Œå æ®å®¹å™¨çš„å‰©ä½™ç©ºé—´ï¼Œå¦‚æœæœ‰å¤šä¸ª<code>Expanded</code>çš„è¯ï¼Œä¼šæŒ‰ç…§ä»–ä»¬çš„flexå æ¯”æ¥åˆ†é…æ¯ä¸ªchildå¯ä»¥å æ®çš„ç©ºé—´å¤§å°ã€‚  </p><p><code>Flexible</code> ç¨å¾®ç‰¹æ®Šä¸€äº›ï¼Œæœ‰æ—¶å€™çœ‹èµ·æ¥ä¼¼ä¹ä»–çš„childå æ®çš„å¤§å°æ—¢ä¸å…¨æ˜¯çˆ¶å¸ƒå±€çš„å‰©ä½™ç©ºé—´ï¼Œä¹Ÿä¸å…¨æ˜¯åˆšåˆšåŒ…è£¹childå†…å®¹çš„å¤§å°ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>Flexible</code>çš„æºç ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Flexible(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.flex = <span class="number">1</span>,</span><br><span class="line">  <span class="keyword">this</span>.fit = FlexFit.loose,</span><br><span class="line">  required Widget child,</span><br><span class="line">&#125;) : <span class="keyword">super</span>(key: key, child: child);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»–ä½¿ç”¨çš„<code>fit</code>æ¨¡å¼æ˜¯<code>FlexFit.loose</code>ï¼ŒæŸ¥é˜…æ–‡æ¡£å®šä¹‰å¯çŸ¥ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FlexFit.looseï¼šThe child can be at most <span class="keyword">as</span> large <span class="keyword">as</span> the available space (but <span class="keyword">is</span> allowed to be smaller).</span><br><span class="line"></span><br><span class="line">FlexFit.tightï¼šThe child <span class="keyword">is</span> forced to fill the available space.</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Flexible</code>çš„childæœ€å¤§å¯ä»¥æ˜¯çˆ¶å®¹å™¨åˆ†é…ç»™<code>Flexible</code>çš„å¤§å°ï¼ˆå‡è®¾ä¸º<code>MaxSzie</code>ï¼‰ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœchildçš„å¤§å°æ¯”è¿™ä¸ª<code>MaxSzie</code>è¦å°çš„è¯ï¼Œé‚£ä¹ˆå…è®¸childæŒ‰ç…§è‡ªå·±çš„å¤§å°æ¥æ˜¾ç¤ºã€‚</p><p>è€Œå¦‚æœ<code>Flexible</code>çš„<code>fit</code>æ˜¯<code>FlexFit.tight</code>çš„è¯ï¼Œå°±ä¼šå¼ºåˆ¶childå¤§å°ä¸º<code>MaxSzie</code>ï¼Œæ•ˆæœå’Œ<code>Expanded</code>ä¸€è‡´ï¼Œå®é™…ä¸Š<code>Expanded</code>å°±æ˜¯<code>FlexFit.tight</code>æ¨¡å¼çš„<code>Flexible</code>ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Expanded</span> <span class="keyword">extends</span> <span class="title">Flexible</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Creates a widget that expands a child of a [Row], [Column], or [Flex]</span></span><br><span class="line">  <span class="comment">/// so that the child fills the available space along the flex widget's</span></span><br><span class="line">  <span class="comment">/// main axis.</span></span><br><span class="line">  <span class="keyword">const</span> Expanded(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="built_in">int</span> flex = <span class="number">1</span>,</span><br><span class="line">    required Widget child,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key, flex: flex, fit: FlexFit.tight, child: child);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šè¿°çš„ç»“è®ºï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„ä»£ç ä¸­å¾—åˆ°è¯å®ï¼š</p><p><img src="https://s3.bmp.ovh/imgs/2022/05/11/8559625d0d49ae28.png" alt="Untitled"></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">main() =&gt; runApp(MaterialApp(home: BodyWidget()));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BodyWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;StatefulWidget&gt; createState() &#123;</span><br><span class="line">    <span class="keyword">return</span> _BodyState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_BodyState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">BodyWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">double</span> width = MediaQuery.of(context).size.width;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> count = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Material(</span><br><span class="line">      child: Container(</span><br><span class="line">        color: Colors.grey.shade200,</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [</span><br><span class="line">            Row(</span><br><span class="line">              mainAxisSize: MainAxisSize.max,</span><br><span class="line">              children: [</span><br><span class="line">                Container(</span><br><span class="line">                    color: Colors.teal,</span><br><span class="line">                    child: Text(</span><br><span class="line">                      <span class="string">'Container Text '</span>,</span><br><span class="line">                    )),</span><br><span class="line">                Flexible(</span><br><span class="line">                  child: Container(</span><br><span class="line">                      color: Colors.blue,</span><br><span class="line">                      child: Text(<span class="string">' Text.Flexible Text.Flexible Text.Flexible.'</span>)),</span><br><span class="line">                ),</span><br><span class="line">                Flexible(</span><br><span class="line">                  child: Container(</span><br><span class="line">                      color: Colors.yellow, child: Text(<span class="string">'Flexible Text.'</span>)),</span><br><span class="line">                ),</span><br><span class="line">                Flexible(</span><br><span class="line">                  child: Container(</span><br><span class="line">                      color: Colors.lightGreen, child: Text(<span class="string">'Flexible.'</span>)),</span><br><span class="line">                ),</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">            SizedBox(</span><br><span class="line">              height: <span class="number">80</span>,</span><br><span class="line">              width: width,</span><br><span class="line">              child: ListView.builder(</span><br><span class="line">                itemBuilder: (context, index) &#123;</span><br><span class="line">                  <span class="keyword">return</span> SizedBox(</span><br><span class="line">                    width: width / count,</span><br><span class="line">                    child: Column(</span><br><span class="line">                      mainAxisSize: MainAxisSize.max,</span><br><span class="line">                      children: [</span><br><span class="line">                        Container(</span><br><span class="line">                          width: <span class="number">1</span>,</span><br><span class="line">                          height: index % <span class="number">5</span> == <span class="number">0</span> ? <span class="number">30</span> : <span class="number">20</span>,</span><br><span class="line">                          color: Colors.purple,</span><br><span class="line">                        ),</span><br><span class="line">                        <span class="keyword">if</span> (index % <span class="number">5</span> == <span class="number">0</span>)</span><br><span class="line">                          Flexible(</span><br><span class="line">                            child: Text(</span><br><span class="line">                              <span class="string">'<span class="subst">$index</span>'</span>,</span><br><span class="line">                              style: <span class="keyword">const</span> TextStyle(fontSize: <span class="number">5</span>),</span><br><span class="line">                            ),</span><br><span class="line">                          ),</span><br><span class="line">                      ],</span><br><span class="line">                    ),</span><br><span class="line">                  );</span><br><span class="line">                &#125;,</span><br><span class="line">                itemCount: count,</span><br><span class="line">                scrollDirection: Axis.horizontal,</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><code>Expanded</code>å’Œ<code>Flexible</code>é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šæŒ‰ç…§<code>flex</code>å æ®çˆ¶å®¹å™¨å‰©ä½™çš„å¯ç”¨ç©ºé—´ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œ<code>Expanded</code>ä¼šå¼ºåˆ¶childæ”¹å˜å¤§å°ä¸ºçˆ¶å®¹å™¨åˆ†é…çš„å¤§å°ï¼Œè€Œ<code>Flexible</code>åˆ™ä¼šå‘Šè¯‰childï¼Œ<strong>æœ€å¤§åªèƒ½æ˜¯çˆ¶å®¹å™¨åˆ†é…çš„å¤§å°ï¼Œè¦æ˜¯childæƒ³è¦å°ä¸€äº›çš„è¯ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§childçš„å¤§å°æ˜¾ç¤º</strong>ã€‚</p><p>å¦‚æœæ”¹å˜<code>Flexible</code>çš„<code>fit</code>ä¸º<code>FlexFit.tight</code>çš„è¯ï¼Œ<code>Expanded</code>å’Œ<code>Flexible</code>æ²¡æœ‰å·®åˆ«ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Composeå±å¹•é€‚é…</title>
      <link href="/blog/posts/e15dda2e/"/>
      <url>/blog/posts/e15dda2e/</url>
      
        <content type="html"><![CDATA[<h1 id="Composeå±å¹•é€‚é…"><a href="#Composeå±å¹•é€‚é…" class="headerlink" title="Composeå±å¹•é€‚é…"></a>Composeå±å¹•é€‚é…</h1><p>ä¸€ç§<strong>Compose</strong>ä¸­å±å¹•é€‚é…çš„è§£å†³æ–¹æ¡ˆï¼Œçµæ„Ÿå‚è€ƒ<em>å¤´æ¡å±å¹•é€‚é…</em>ã€<em>AndroidAutoSize</em>ç­‰ï¼Œä»¥è®¾è®¡ç¨¿å®½åº¦å’Œå±å¹•æ°´å¹³æ–¹æ³•å¤§å°ä¸ºå‡†ï¼Œç­‰æ¯”æ‹‰ä¼¸æ§ä»¶å¤§å°ã€‚</p><p>åæ–‡é™„æœ‰æœ¬æ–¹æ¡ˆçš„Kotlinè¯­è¨€å®ç°ï¼Œä½¿ç”¨åªéœ€è¦ä¸¤ä¸ªæ­¥éª¤å³å¯ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 åˆå§‹åŒ–</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> : <span class="type">Application</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        SizeEtx.<span class="keyword">init</span>(<span class="keyword">this</span>, <span class="number">375</span>) <span class="comment">// 375ä¸ºè®¾è®¡ç¨¿å®½åº¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 ä½¿ç”¨</span></span><br><span class="line">size(width = <span class="number">9</span>.composeDp, height = <span class="number">16</span>.composeDp)</span><br></pre></td></tr></table></figure><h1 id="ä¸»è¦çš„è®¾è®¡æ€æƒ³"><a href="#ä¸»è¦çš„è®¾è®¡æ€æƒ³" class="headerlink" title="ä¸»è¦çš„è®¾è®¡æ€æƒ³"></a>ä¸»è¦çš„è®¾è®¡æ€æƒ³</h1><p>å‡è®¾å¦‚ä¸‹å˜é‡ï¼šè®¾è®¡ç¨¿æ€»å®½åº¦<code>dpx</code>ï¼Œæ§ä»¶åœ¨è®¾è®¡ç¨¿ä¸­çš„å¤§å°<code>n</code>ï¼Œå±å¹•çš„å®é™…æ°´å¹³dpå¤§å°<code>rdp</code>ï¼Œä»¥åŠæˆ‘ä»¬éœ€è¦æ±‚å¾—çš„æ§ä»¶åœ¨è®¾å¤‡ä¸­çš„dpå€¼<code>m</code>ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾å¾—åˆ°ä»¥ä¸‹æ–¹ç¨‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n / dpx = m / rdp</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±å¯ä»¥æ¨å¯¼å‡ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m = n * (rdp / dpx)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å€¼ä¸­ï¼Œåªæœ‰å±å¹•æ°´å¹³dpå€¼<code>rdp</code>è¿˜æ˜¯æœªçŸ¥çš„ï¼Œåˆæ ¹æ®<strong>ï¼ˆ<code>density</code> åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šéƒ½æ˜¯å›ºå®šçš„ï¼Œ<code>DPI</code> / 160 = <code>density</code>ï¼Œå±å¹•çš„æ€» px å®½åº¦<code>wpx</code> / <code>density</code> = å±å¹•çš„æ€» dp å®½åº¦<code>rdp</code>ï¼‰</strong>å¯çŸ¥ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdp = wpx / density</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m = n * (rdp / dpx)</span><br><span class="line">  = n * ( wpx / density ) / dpx</span><br><span class="line">  = n * wpx / (density * dpx)</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œç­‰å¼åé¢çš„æ‰€æœ‰æ•°æ®éƒ½ä¸ºå·²çŸ¥æˆ–è€…åœ¨appè¿è¡Œæ—¶å¯çŸ¥ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºè®¾è®¡ç¨¿ä¸­çš„æ§ä»¶åœ¨Composeä¸­å¯¹åº”çš„dpå¤§å°ã€‚</p><p>ä¸‹é¢æ˜¯ä»¥ä¸Šæ€è·¯çš„kotlinå®ç°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration</span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources</span><br><span class="line"><span class="keyword">import</span> android.graphics.Point</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.view.WindowManager</span><br><span class="line"><span class="keyword">import</span> androidx.compose.ui.unit.Dp</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> : jixiaoyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> ï¼šCompose å±å¹•é€‚é…æ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ ¹æ®è®¾è®¡ç¨¿å®½åº¦ï¼ˆè®¾è®¡ç¨¿å®½åº¦å¯¹åº”è®¾å¤‡æ°´å¹³æ–¹å‘ï¼‰å’Œè®¾è®¡ç¨¿å¯¹åº”ç‰©ä½“å¤§å°ï¼Œè®¡ç®—å®é™…åº”è¯¥å¡«å†™çš„dp</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="comment"> * åœ¨Application onCreate()æ–¹æ³•ä¸­æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * SizeEtx.init(this, 375)</span></span><br><span class="line"><span class="comment"> * å…¶ä¸­375ä½è®¾è®¡ç¨¿å±å¹•å®½åº¦ï¼Œç„¶ååœ¨ä»£ç ä¸­ä½¿ç”¨width(315.composeDp)ä½œä¸ºå¤§å°å•ä½å³å¯ï¼Œ</span></span><br><span class="line"><span class="comment"> * å…¶ä¸­315ä¸ºè®¾è®¡ç¨¿ä¸­çš„æ§ä»¶å¤§å°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è®¡ç®—æ–¹å¼ä¸ºï¼š</span></span><br><span class="line"><span class="comment"> * wpx å±å¹•å®é™…åƒç´ å®½åº¦</span></span><br><span class="line"><span class="comment"> * dpx è®¾è®¡ç¨¿å±å¹•å®½åº¦</span></span><br><span class="line"><span class="comment"> * n æ§ä»¶è®¾è®¡ç¨¿ä¸­çš„å®½åº¦ï¼ˆdpã€pxéƒ½å¯ï¼Œä¸dpxå•ä½ä¿æŒä¸€è‡´ï¼‰</span></span><br><span class="line"><span class="comment"> * m æ§ä»¶åœ¨appä¸­å¯¹åº”çš„dp</span></span><br><span class="line"><span class="comment"> * rpx æ§ä»¶åœ¨å±å¹•ä¸­åº”è¯¥å±•ç¤ºçš„åƒç´ å¤§å°</span></span><br><span class="line"><span class="comment"> * å·²çŸ¥æ¡ä»¶ï¼šdp = px / density</span></span><br><span class="line"><span class="comment"> * ï¼ˆdensity åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šéƒ½æ˜¯å›ºå®šçš„ï¼ŒDPI / 160 = densityï¼Œå±å¹•çš„æ€» px å®½åº¦ / density = å±å¹•çš„æ€» dp å®½åº¦ï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DisplayMetrics#density å°±æ˜¯ä¸Šè¿°çš„density</span></span><br><span class="line"><span class="comment"> * DisplayMetrics#densityDpi å°±æ˜¯ä¸Šè¿°çš„dpi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç»¼ä¸Šå¾—å‡ºå¦‚ä¸‹ç»“è®º(ä»¥ç«–å±æƒ…å†µä¸‹å±å¹•å®½åº¦ä¸ºä¾‹)ï¼š</span></span><br><span class="line"><span class="comment"> * å±å¹•å®½åº¦æ€»dp ï¼š rdp = wpx / density</span></span><br><span class="line"><span class="comment"> * m / rdp = n / dpx</span></span><br><span class="line"><span class="comment"> * é‚£ä¹ˆï¼Œm = (rdp / dpx) * n</span></span><br><span class="line"><span class="comment"> * å…¶ä¸­(rdp / dpx)è¢«æˆ‘ä»¬å½“åšè®¾è®¡ç¨¿ä¸­æ§ä»¶å¤§å°ä¸è®¾å¤‡ä¸­æ§ä»¶dpå¤§å°ä¹‹é—´çš„ç¼©æ”¾ç³»æ•°ï¼šdpWidthScale</span></span><br><span class="line"><span class="comment"> * æ‰€ä»¥ï¼šm = dpWidthScale * n</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> : jixiaoyong1995<span class="doctag">@gmail</span>.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> : 2021/8/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SizeEtx</span> <span class="keyword">private</span> <span class="keyword">constructor</span></span>(context: Context, dpx: <span class="built_in">Int</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> density = Resources.getSystem().displayMetrics.density</span><br><span class="line">        <span class="keyword">var</span> wpx = Resources.getSystem().displayMetrics.widthPixels</span><br><span class="line">        dpWidthScale = wpx.toFloat() / (dpx * density)</span><br><span class="line">        dpHeightScale =</span><br><span class="line">            getScreenRealHeightPx(context).toFloat() / (dpx * density)</span><br><span class="line">        pxWidthScale = wpx.toFloat() / dpx.toFloat()</span><br><span class="line"><span class="comment">// ä»¥ä¸‹æ•°æ®ä¸ºRedmi Note 5 çš„æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="comment">//        "getScreenRealHeight $&#123;getScreenRealHeightPx(context)&#125;".logd() // 2160,å®é™…è®¾å¤‡é«˜åº¦ä¸º2160</span></span><br><span class="line"><span class="comment">//        "Resources.getSystem().displayMetrics.heightPixels $&#123;Resources.getSystem().displayMetrics.heightPixels&#125;".logd() // 2033,å®é™…è®¾å¤‡é«˜åº¦ä¸º2160</span></span><br><span class="line"><span class="comment">//        "Resources.getSystem().displayMetrics.density $&#123;Resources.getSystem().displayMetrics.density&#125;".logd() // 2.7</span></span><br><span class="line"><span class="comment">//        "Resources.getSystem().displayMetrics.densityDpi $&#123;Resources.getSystem().displayMetrics.densityDpi&#125;".logd() // 432</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å¾—å±å¹•çœŸå®é«˜åº¦ï¼ˆåŒ…å«åº•éƒ¨å¯¼èˆªæ ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getScreenRealHeightPx</span><span class="params">(context: <span class="type">Context</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> windowManager = context.getSystemService(Context.WINDOW_SERVICE) <span class="keyword">as</span> WindowManager</span><br><span class="line">        <span class="keyword">val</span> display = windowManager.defaultDisplay</span><br><span class="line">        <span class="keyword">val</span> outPoint = Point()</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</span><br><span class="line">            <span class="comment">// å¯èƒ½æœ‰è™šæ‹ŸæŒ‰é”®çš„æƒ…å†µ</span></span><br><span class="line">            display.getRealSize(outPoint)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸å¯èƒ½æœ‰è™šæ‹ŸæŒ‰é”®</span></span><br><span class="line">            display.getSize(outPoint)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰‹æœºå±å¹•çœŸå®é«˜åº¦</span></span><br><span class="line">        <span class="keyword">return</span> outPoint.y</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆå§‹åŒ–å¤§å°é€‚é…å·¥å…·ç±»</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> dpx è®¾è®¡ç¨¿ä¸­çš„å±å¹•å®½åº¦ï¼Œä¾‹å¦‚375ï¼Œåœ¨ä½¿ç”¨åˆ°æœ¬å·¥å…·çš„æ‰€æœ‰åœ°æ–¹ï¼Œéƒ½åº”è¯¥ä»¥æ­¤å®½åº¦ä¸ºå‡†æ¥è·å–å…¶ä»–æ§ä»¶çš„å¤§å°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">(context: <span class="type">Context</span>, dpx: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            SizeEtx(context, dpx)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dpWidthScale = <span class="number">1.0f</span></span><br><span class="line">        <span class="keyword">var</span> dpHeightScale = <span class="number">1.0f</span></span><br><span class="line">        <span class="keyword">var</span> pxWidthScale = <span class="number">1.0f</span></span><br><span class="line">        <span class="keyword">var</span> pxHeightScale = <span class="number">1.0f</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compose å±å¹•é€‚é…æ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–Composeä¸­å¯¹åº”çš„dpï¼Œè¾“å…¥å€¼ä¸ºè®¾è®¡ç¨¿ä¸­å¯¹åº”çš„æ§ä»¶å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">val</span> Number.composeDp: Dp</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">val</span> isPortrait = isPortrait()</span><br><span class="line">        <span class="keyword">return</span> Dp(<span class="keyword">this</span>.toFloat() * <span class="keyword">if</span> (isPortrait) SizeEtx.dpWidthScale <span class="keyword">else</span> SizeEtx.dpHeightScale)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–Composeä¸­å¯¹åº”çš„pxï¼Œè¾“å…¥å€¼ä¸ºè®¾è®¡ç¨¿ä¸­å¯¹åº”çš„æ§ä»¶å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">val</span> Number.composePx: <span class="built_in">Int</span></span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">val</span> isPortrait = isPortrait()</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.toFloat() * <span class="keyword">if</span> (isPortrait) SizeEtx.pxWidthScale <span class="keyword">else</span> SizeEtx.pxHeightScale).toInt()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦ç«–å±</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">isPortrait</span><span class="params">()</span></span> =</span><br><span class="line">    Resources.getSystem().configuration.orientation == Configuration.ORIENTATION_PORTRAIT</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="https://github.com/JessYanCoding/AndroidAutoSize" target="_blank" rel="noopener">AndroidAutoSize</a></p><p><a href="https://mp.weixin.qq.com/s/d9QCoBP6kV9VSWvVldVVwA" target="_blank" rel="noopener">ä¸€ç§æä½æˆæœ¬çš„Androidå±å¹•é€‚é…æ–¹å¼</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Flutterä¸­çš„å¼‚å¸¸å¤„ç†</title>
      <link href="/blog/posts/9e235953/"/>
      <url>/blog/posts/9e235953/</url>
      
        <content type="html"><![CDATA[<h1 id="Flutterä¸­çš„å¼‚å¸¸å¤„ç†"><a href="#Flutterä¸­çš„å¼‚å¸¸å¤„ç†" class="headerlink" title="Flutterä¸­çš„å¼‚å¸¸å¤„ç†"></a>Flutterä¸­çš„å¼‚å¸¸å¤„ç†</h1><h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p><code>FLutter</code>ä¸­çš„é”™è¯¯ä¸ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå¥”æºƒï¼Œåªä¼šç»ˆæ­¢æ‰§è¡Œå‡ºé”™ä»£ç ä¹‹åçš„é€»è¾‘ï¼Œåœ¨å¯¼è‡´<code>Widget.build()</code>è¿”å›ä¸º<code>null</code>çš„é”™è¯¯ä¼šå¯¼è‡´<code>Widget</code>æ„å»ºå¤±è´¥ï¼Œå¹¶è¿”å›çº¢åº•é»„å­—çš„é”™è¯¯åŸå› <code>Widget</code>ï¼ˆåœ¨Releaseæ¨¡å¼åˆ™ä¼šæ˜¾ç¤ºä¸ºç°åº•åŒºåŸŸï¼‰ï¼Œå¯¹äºå¼‚æ­¥æ–¹æ³•äº§ç”Ÿå¼‚å¸¸ç­‰<code>Flutteræ¡†æ¶</code>æ²¡æœ‰æ•è·çš„æƒ…å†µï¼Œä¼šäº¤ç”±å½“å‰ä»£ç æ‰€åœ¨çš„<code>Zone</code>å¤„ç†ã€‚</p><blockquote><p><strong>ä¸ºä»€ä¹ˆ flutter è§¦å‘å¼‚å¸¸çš„æ—¶å€™ä¸ä¼šå´©æºƒï¼Ÿ</strong><br>è¿™ä¸ªå’Œ <code>flutter</code> çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶æœ‰å…³ï¼Œä»»åŠ¡åˆ†ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯å¾®ä»»åŠ¡ <code>microtask</code>ï¼Œä¸€ä¸ªæ˜¯äº‹ä»¶ <code>event</code>ï¼Œä»–ä»¬æœ‰è‡ªå·±çš„é˜Ÿåˆ—ï¼Œæ¯ä¸ªä»»åŠ¡æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸€æ—¦æŸä¸ªä»»åŠ¡è§¦å‘å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯å¯¼è‡´è¿™ä¸ªä»»åŠ¡åç»­ä»£ç æ— æ³•æ‰§è¡Œï¼Œå¹¶ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡æ‰§è¡Œ</p></blockquote><p><em>æœ¬æ–‡åŸºäºFlutter (Channel stable, 2.2.3)</em></p><h1 id="è¯¦ç»†è¯´æ˜"><a href="#è¯¦ç»†è¯´æ˜" class="headerlink" title="è¯¦ç»†è¯´æ˜"></a>è¯¦ç»†è¯´æ˜</h1><p>Flutterä¸­çš„é”™è¯¯å¤„ç†åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><h2 id="try-catch"><a href="#try-catch" class="headerlink" title="try...catch"></a><code>try...catch</code></h2><p>å¯¹äºæ™®é€šçš„é”™è¯¯ï¼Œå¯ä»¥é€šè¿‡<code>try...catch</code>æ¥æ•è·ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="keyword">var</span> list = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">   <span class="keyword">var</span> three = list[<span class="number">3</span>];</span><br><span class="line"> &#125; <span class="keyword">on</span> RangeError <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"è¿™é‡Œæ˜¯æ•è·RangeErrorç±»å‹çš„å¼‚å¸¸ <span class="subst">$e</span>"</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"è¿™é‡Œæ˜¯å…œåº•çš„æ•è·å¼‚å¸¸ <span class="subst">$e</span>"</span>);</span><br><span class="line"> &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"è¿™é‡Œæ˜¯æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œçš„ä»£ç "</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºï¼Œå¼‚æ­¥å¼‚å¸¸ï¼Œå¯ä»¥ä½¿ç”¨<code>await</code>ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•ï¼Œå°†å…¶å˜ä¸ºåŒæ­¥ä»»åŠ¡ï¼Œå¦åˆ™æ— æ³•åˆ™æ•è·ã€‚</p><h2 id="ErrorWidget-builder"><a href="#ErrorWidget-builder" class="headerlink" title="ErrorWidget.builder"></a><code>ErrorWidget.builder</code></h2><p>å½“åœ¨<code>Widget</code>æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå¯¼è‡´<code>build()</code>æ–¹æ³•è¿”å›<code>null</code>ï¼Œ<code>Flutteræ¡†æ¶</code>ä¼šè°ƒç”¨<code>ErrorWidget.builder</code>è¿”å›ä¸€ä¸ª<code>Widget</code>æ›¿ä»£<code>å‡ºé”™çš„Widget</code>ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>debug</code>æ¨¡å¼è¿”å›çš„æ˜¯çº¢åº•é»„å­—çš„é”™è¯¯æç¤ºï¼Œè€Œ<code>release</code>æ¨¡å¼è¿”å›çš„æ˜¯<code>ç°è‰²Widget</code>ã€‚</p><p>å¯ä»¥åœ¨<code>RunApp</code>æ–¹æ³•ä¸­æ›¿æ¢è¿™ä¸ªé»˜è®¤çš„é”™è¯¯ç•Œé¢ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">runApp(MaterialApp(</span><br><span class="line">      home: Scaffold(</span><br><span class="line">        appBar: AppBar(),</span><br><span class="line">        body: BodyWidget(),</span><br><span class="line">      ),</span><br><span class="line">      builder: (context, widget) &#123;</span><br><span class="line">        <span class="comment">// Widgetåœ¨Buildæ—¶å‡ºé”™çš„è¯ï¼Œå±•ç¤ºæ­¤Widgetï¼Œ</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸å®šä¹‰çš„è¯ï¼Œdebugä¸‹ä¸ºçº¢åº•é»„å­—é”™è¯¯ä¿¡æ¯ï¼Œreleaseä¼šæ˜¾ç¤ºä¸ºç°è‰²å¸ƒå±€</span></span><br><span class="line">        <span class="comment">// errorDetailsåœ¨releaseæ¨¡å¼ä¸‹ä¸ºç©º</span></span><br><span class="line">        ErrorWidget.builder = (FlutterErrorDetails errorDetails) &#123;</span><br><span class="line">          <span class="keyword">return</span> MainErrorWidget(widget, errorDetails);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> widget ?? Container();</span><br><span class="line">      &#125;,</span><br><span class="line">    ));</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­çš„<code>MainErrorWidget</code>æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å±•ç¤ºé”™è¯¯ä¿¡æ¯çš„é¡µé¢ã€‚</p><ul><li><p><code>MainErrorWidget</code>çš„ä¸€ç§å®ç°æ–¹å¼</p>  <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainErrorWidget</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  Widget? parentWidget;</span><br><span class="line"></span><br><span class="line">  FlutterErrorDetails errorDetails;</span><br><span class="line"></span><br><span class="line">  MainErrorWidget(<span class="keyword">this</span>.parentWidget, <span class="keyword">this</span>.errorDetails);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"3. å¸ƒå±€å‡ºç°é”™è¯¯ï¼Œå±•ç¤ºé”™è¯¯é¡µé¢,æ­¤å¤„é”™è¯¯åœ¨releaseä¸­ä¹Ÿä¼šè°ƒç”¨FlutterError.onError"</span>);</span><br><span class="line"></span><br><span class="line">    Widget error = Card(</span><br><span class="line">      child: SingleChildScrollView(</span><br><span class="line">        child: Container(</span><br><span class="line">          padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">20</span>),</span><br><span class="line">          color: Colors.green,</span><br><span class="line">          child: Text(</span><br><span class="line">            <span class="string">'å¸ƒå±€å‡ºç°é”™è¯¯ï¼Œä»¥ä¸‹æ˜¯é”™è¯¯ä¿¡æ¯:\n<span class="subst">$errorDetails</span>'</span>,</span><br><span class="line">            style: TextStyle(fontSize: <span class="number">10</span>, color: Colors.white),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (parentWidget <span class="keyword">is</span> Scaffold || parentWidget <span class="keyword">is</span> Navigator) &#123;</span><br><span class="line">      debugPrint(</span><br><span class="line">          <span class="string">"widget<span class="subst">$&#123;parentWidget?.key?.toString()&#125;</span> (<span class="subst">$parentWidget</span>)  is Scaffold <span class="subst">$&#123;parentWidget <span class="keyword">is</span> Scaffold&#125;</span> or Navigator <span class="subst">$&#123;parentWidget <span class="keyword">is</span> Navigator&#125;</span>"</span>);</span><br><span class="line">      <span class="comment">// error = Container(child: error);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé”™è¯¯<code>Widget</code>åœ¨<code>Debug</code>å’Œ<code>Release</code>æ¨¡å¼ä¸‹æœ‰ä¸€äº›åŒºåˆ«ï¼š</p><ul><li><code>Debug</code>æ¨¡å¼ä¸‹<code>ErrorWidget.builder</code>ä¼šè¿”å›é”™è¯¯è¯¦ç»†ä¿¡æ¯<code>FlutterErrorDetails</code> ï¼Œ<code>Release</code>ä¸‹åˆ™ä¸ä¼šï¼›</li><li><code>Debug</code>æ¨¡å¼ä¸‹ï¼Œ<code>Widget</code>ç­‰å‡ºé”™ä¼šæ‰“å°<code>Exception caught by widgets library ...</code> ç­‰æç¤ºå¹¶è¾“å‡ºé”™è¯¯å †æ ˆä¿¡æ¯ï¼Œä½†æ˜¯<code>Release</code>æ¨¡å¼ä¸‹ä¸ä¼šï¼›</li><li><code>Debug</code>æ¨¡å¼ä¸‹ï¼Œå‡ºé”™ä¸ä¼šè°ƒç”¨<code>FlutterError.onError</code>ï¼Œ<code>Release</code>æ¨¡å¼ä¸‹ä¼šã€‚</li></ul><h2 id="FlutterError-onError"><a href="#FlutterError-onError" class="headerlink" title="FlutterError.onError"></a><code>FlutterError.onError</code></h2><p>ä¸Šè¿°å‡ ç§æƒ…å†µéƒ½æ²¡æœ‰å¤„ç†çš„ï¼Œè¢«Flutteræ¡†æ¶å¼•èµ·çš„å¼‚å¸¸ï¼Œä¼šåœ¨è¿™é‡Œè¢«å¤„ç†ã€‚</p><p>åœ¨<code>Flutter 2.2.3</code>ä¸­ï¼Œ<code>Debug</code>æ¨¡å¼ä¸‹å¦‚<code>onPressed</code>ä¸­çš„æœªæ•è·é”™è¯¯ç­‰éƒ½ä¼šè¢«Widgetç­‰æ•è·ï¼Œè€Œä¸ä¼šèµ°åˆ°è¿™é‡Œæ¥ï¼Œåœ¨<code>Release</code>æ¨¡å¼ä¸‹åˆ™ä¼šè°ƒç”¨<code>FlutterError.onError</code>ã€‚</p><p>åœ¨è¿™é‡Œå¯ä»¥å¯¹é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚è¾“å‡ºåˆ°æ§åˆ¶å°ã€äº¤ç»™Zoneç»Ÿä¸€å¤„ç†ã€ç›´æ¥ç»“æŸæ‰APPç­‰ï¼š</p><ul><li><code>FlutterError.dumpErrorToConsole(details);</code> è¾“å‡ºåˆ°æ§åˆ¶å°</li><li><code>exit(1);</code> é€€å‡ºAPP</li><li><code>Zone.current.handleUncaughtError(details.exception, details.stack);</code> äº¤ç»™Zoneç»Ÿä¸€å¤„ç†</li><li><code>defaultOnError?.call(details);</code>   è‡ªå·±å¤„ç†å®Œå¼‚å¸¸åï¼Œä¹Ÿè¦æŠŠå¼‚å¸¸å‘ä¸ŠæŠ› ã€æ¨èã€‘ï¼Œå…¶ä¸­<code>defaultOnError</code> å¯ä»¥é¢„å…ˆç¼“å­˜<code>final defaultOnError = FlutterError.onError;</code></li></ul><h2 id="runZonedGuarded-onError"><a href="#runZonedGuarded-onError" class="headerlink" title="runZonedGuarded(onError)"></a><code>runZonedGuarded(onError)</code></h2><p>ä¸Šè¿°å‡ ç§æƒ…å†µéƒ½æ²¡æœ‰å¤„ç†çš„å¼‚å¸¸ï¼Œä¼šè¢«å‘é€åˆ°è¿™é‡Œå¤„ç†ï¼Œå¯ä»¥ç±»æ¯”ä¸º<code>Android</code>ä¸­çš„<code>Thread.UncaughtExceptionHandler</code>ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">runZonedGuarded(() <span class="keyword">async</span> &#123;</span><br><span class="line">    runApp(...);</span><br><span class="line">  &#125;,</span><br><span class="line">  (<span class="built_in">Object</span> error, StackTrace stack) &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰è¢«Flutteræ•è·çš„é”™è¯¯,å…¨å±€æœªæ•è·å¼‚å¸¸å¤„ç†,ç±»ä¼¼äºAndroidçš„Thread.UncaughtExceptionHandler</span></span><br><span class="line">    <span class="comment">/// æ¯”å¦‚å¼‚æ­¥çš„æ–¹æ³•</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"2. runZonedGuarded.onError <span class="subst">$error</span>"</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>Zoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ²™ç›’ï¼Œå…¶ä¸­çš„ä»£ç å‡ºé”™ï¼ŒåŒ…æ‹¬å¼‚æ­¥çš„éƒ½å¯ä»¥æ•è·åˆ°ã€‚ä½†æ˜¯å¦‚æœæ˜¯å¦å¤–ä¸€ä¸ªæ²™ç›’ä¸­çš„é”™è¯¯åˆ™æ— æ³•å¤„ç†ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="https://flutter.cn/docs/testing/errors#define-a-custom-error-widget-for-build-phase-errors" target="_blank" rel="noopener">Flutter å®˜ç½‘å¼‚å¸¸å¤„ç†</a></p><p><a href="https://www.fnzblog.site/Flutter%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html" target="_blank" rel="noopener">Flutterå¼‚å¸¸å¤„ç†</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Android11æ–‡ä»¶åˆ†åŒºå­˜å‚¨åœ¨å›¾ç‰‡è¯»å†™çš„é€‚é…</title>
      <link href="/blog/posts/12cb887a/"/>
      <url>/blog/posts/12cb887a/</url>
      
        <content type="html"><![CDATA[<h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>å½“APPç›®æ ‡ç‰ˆæœ¬æ˜¯Android 10ï¼ˆAPI 29ï¼‰åŠä»¥åæ—¶ï¼Œç”±äºAndroidå¼•å…¥äº†åˆ†åŒºå­˜å‚¨ï¼ŒAPPä¸èƒ½ç›´æ¥é€šè¿‡è·¯å¾„è®¿é—®æ–‡ä»¶ï¼Œè®¿é—®å¤–éƒ¨å­˜å‚¨ç©ºé—´ä¸­çš„åª’ä½“æ–‡ä»¶é™¤äº†éœ€è¦<code>READ_EXTERNAL_STORAGE</code> æˆ– <code>WRITE_EXTERNAL_STORAGE</code> æƒé™ä¹‹å¤–ï¼Œéœ€è¦é€šè¿‡å…¶ä»–APPåˆ†äº«çš„<code>Uri</code>è¯»å†™æ–‡ä»¶ï¼ŒåŒç†è¦ç»™å…¶ä½™APPåˆ†äº«æ–‡ä»¶ä¹Ÿè®¸è¦é€šè¿‡<code>FileProvider</code>ç”Ÿæˆ<code>Uri</code>å¹¶èµ‹äºˆå¯¹åº”çš„æƒé™ã€‚</p><p>æœ¬æ–‡ä»¥ä»ç›¸å†Œä¸­è·å–å›¾ç‰‡ã€è¯·æ±‚ç³»ç»Ÿè£å‰ªå¹¶è¿”å›å›¾ç‰‡ä¸ºä¾‹å±•ç¤ºå¯¹åº”çš„é€‚é…æ–¹æ³•ã€‚</p><h1 id="å®é™…æ“ä½œ"><a href="#å®é™…æ“ä½œ" class="headerlink" title="å®é™…æ“ä½œ"></a>å®é™…æ“ä½œ</h1><p>1.<strong>ä»ç›¸å†Œä¸­è·å–å›¾ç‰‡</strong></p><p>ä»ç›¸å†Œä¸­è·å–åˆ°çš„å›¾ç‰‡<code>Uri</code>ä¸€èˆ¬å¦‚ï¼š<code>content://raw//storage/emulated/0/DCIM/Camera/IMG_20210531_183008.HEIC</code></p><p>appå†…éƒ¨è¦è¯»å–å…¶å†…å®¹çš„è¯ï¼Œå¯ä»¥é€šè¿‡<code>context.getContentResolver().openInputStream(imageUri)</code></p><p>æˆ–è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Cursor cursor = context.getContentResolver().query(uri, filePathColumn, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);<span class="comment">//ä»ç³»ç»Ÿè¡¨ä¸­æŸ¥è¯¢æŒ‡å®šUriå¯¹åº”çš„ç…§ç‰‡</span></span><br><span class="line">            cursor.moveToFirst();</span><br><span class="line">            <span class="keyword">int</span> columnIndex = cursor.getColumnIndex(filePathColumn[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (columnIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                picturePath = cursor.getString(columnIndex); </span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>ç­‰æ–¹å¼è¯»å–ï¼Œæ“ä½œè¯¥å›¾ç‰‡ã€‚</p><p>2.<strong>å°†å¤–éƒ¨æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°å¹¶è·å–Uri</strong></p><p>ç”±äºä¸Šè¿°æ–¹å¼è·å–åˆ°çš„<code>Uri</code>åªå¯¹æœ¬APPèµ‹äºˆäº†æƒé™ï¼Œè¦æ˜¯å¸Œæœ›å°†æ­¤å›¾ç‰‡åˆ†äº«ç»™ç¬¬ä¸‰æ–¹APPè¿›ä¸€æ­¥åŠ å·¥å¤„ç†ï¼Œåˆ™å¯èƒ½å‡ºç°ç¬¬ä¸‰æ–¹APPæ²¡æœ‰è¯»å†™æƒé™è€Œå¯¼è‡´æ“ä½œå¤±è´¥çš„æƒ…å†µï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥å°†è·å–åˆ°çš„å›¾ç‰‡ç¼“å­˜åˆ°APPç§æœ‰ç›®å½•ï¼Œå¹¶ä¸”é‡æ–°ç”Ÿæˆ<code>Uri</code>å¹¶èµ‹äºˆå°†è¦å¤„ç†è¯¥å›¾çš„ç¬¬ä¸‰æ–¹APPå¯¹åº”æƒé™ã€‚</p><p>å°†å¤–éƒ¨æ–‡ä»¶ç¼“å­˜æœ¬åœ°çš„æ­¥éª¤å‚è€ƒç¬¬ä¸€æ­¥æ“ä½œå³å¯è‡ªè¡Œå®Œæˆï¼Œä¸»è¦è®²è§£ä¸€ä¸‹å¦‚ä½•å°†å¯¹å¤–åˆ†äº«çš„<code>Uri</code>èµ‹äºˆè¯»å†™æƒé™ã€‚</p><p>ä¸‹é¢è¿™ä¸ªæ–¹æ³•åœ¨ä¸åŒç³»ç»Ÿåˆ†åˆ«é‡‡ç”¨ä¸åŒæ–¹å¼è·å–æ–‡ä»¶å¯¹åº”çš„<code>Uri</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Uri <span class="title">getUriForFile</span><span class="params">(Context context, File file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">        <span class="keyword">return</span> FileProvider.getUriForFile(context, <span class="string">"com.your.app.packagename.fileprovider"</span>, file);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Uri.fromFile(file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>com.your.app.packagename.fileprovider</code>æ˜¯<a href="https://developer.android.google.cn/reference/androidx/core/content/FileProvider" target="_blank" rel="noopener"><code>FileProvider</code></a>çš„<code>authorities</code>ã€‚</p><p>è¦ä½¿ç”¨<code>FileProvider</code>å¯ä»¥å‚è€ƒ<a href="https://developer.android.google.cn/reference/androidx/core/content/FileProvider#ProviderDefinition" target="_blank" rel="noopener">å®šä¹‰FileProvider</a>æ“ä½œï¼Œä¸€èˆ¬åªéœ€è¦ä¿®æ”¹<code>authorities</code>å³å¯ï¼ŒåŒæ—¶å¦‚æœæ˜¯å¼€å‘Androidåº“ï¼Œä¸ºäº†é¿å…ä¸ä¸»å·¥ç¨‹å·²æœ‰çš„<code>FileProvider</code>å†²çªï¼Œå¯ä»¥ç»§æ‰¿<code>FileProvider</code>ç±»å¹¶ä¿®æ”¹ä¸‹æ–‡ä¸­<code>name</code>å­—æ®µã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"androidx.core.content.FileProvider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:authorities</span>=<span class="string">"com.mydomain.fileprovider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:grantUriPermissions</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:name</span>=<span class="string">"android.support.FILE_PROVIDER_PATHS"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:resource</span>=<span class="string">"@xml/file_paths"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œä¸ºäº†å®šä¹‰æ­¤<code>FileProvider</code>å¯ä»¥ä½¿ç”¨çš„æ–‡ä»¶ç›®å½•èŒƒå›´ï¼Œå¯ä»¥åœ¨<code>res/xml</code>æ–‡ä»¶å¤¹ä¸­æ–°å»º<code>file_paths.xml</code>å¹¶åšå¦‚ä¸‹é…ç½®ï¼Œä¹Ÿå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£æˆ–è€…<a href="https://www.jianshu.com/p/6192f04eca11" target="_blank" rel="noopener">Android N 7.0 FileProvider å…¼å®¹é€‚é… åŸç†è§£æ</a>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root-path</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"camera_photos"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">path</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-files-path</span> // å¯¹åº”<span class="attr">Context</span>#<span class="attr">getExternalFilesDir</span>(<span class="attr">String</span>)è·å–çš„è·¯å¾„ï¼Œä¸€èˆ¬ä¸ºå­˜å‚¨å¡ä¸­<span class="attr">Android</span>/<span class="attr">data</span>/<span class="attr">com.your.app.packagename</span>/<span class="attr">file</span>ä¸‹é¢çš„ç›®å½•</span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"external_files"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">path</span>=<span class="string">"."</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3.<strong>å¯¹å¤–åˆ†äº«æœ‰æƒé™çš„Uri</strong></p><p>å¯¹äºä¸Šè¿°æ­¥éª¤è·å–åˆ°çš„å›¾ç‰‡Urièµ‹äºˆæƒé™æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p>ç¬¬ä¸€ç§ï¼Œé€šè¿‡<code>Intent</code>ä¼ é€’å‡ºå»çš„<code>imgUri</code>ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">intent.setDataAndType(imgUri, <span class="string">"image/*"</span>);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§åªé€‚ç”¨äºä¸»åŠ¨åˆ†äº«å‡ºå»çš„æ–‡ä»¶ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸‰æ–¹APPè£å‰ªçš„åœºæ™¯ä¸­ï¼Œä¸€èˆ¬è¿˜éœ€è¦ä¸€ä¸ª<code>outPutUri</code>ç”¨äºä¿å­˜è£å‰ªä¹‹åçš„å›¾ç‰‡ï¼Œå¯¹äºè¿™ç§åœºæ™¯ï¼Œå¯ä»¥æŸ¥è¯¢å¯èƒ½ä¼šè°ƒç”¨çš„APPå¹¶èµ‹äºˆå…¶è®¿é—®æƒé™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">    List&lt;ResolveInfo&gt; resInfoList = context.getPackageManager()</span><br><span class="line">            .queryIntentActivities(intent, PackageManager.MATCH_ALL);</span><br><span class="line">    <span class="keyword">for</span> (ResolveInfo resolveInfo : resInfoList) &#123;</span><br><span class="line">        String packageName = resolveInfo.activityInfo.packageName;</span><br><span class="line">        contextWrap.getActivity().grantUriPermission(packageName, outPutUri,</span><br><span class="line">                Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸ç®¡æ˜¯åˆ†äº«å‡ºå»çš„åŸå›¾ï¼Œè¿˜æ˜¯è£å‰ªä¹‹åä¿å­˜çš„å›¾ç‰‡éƒ½ç»™ç¬¬ä¸‰æ–¹APPèµ‹äºˆäº†æƒé™ï¼Œä¿è¯å…¶å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://developer.android.google.cn/reference/androidx/core/content/FileProvider" target="_blank" rel="noopener">https://developer.android.google.cn/reference/androidx/core/content/FileProvider</a></p><p><a href="https://www.jianshu.com/p/6192f04eca11" target="_blank" rel="noopener">Android N 7.0 FileProvider å…¼å®¹é€‚é… åŸç†è§£æ</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kotlinç¬”è®°ä¹‹Flow</title>
      <link href="/blog/posts/10414aef/"/>
      <url>/blog/posts/10414aef/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><code>Flow</code>æ˜¯Kotlinåç¨‹åº“ä¸­çš„åº“ï¼Œç”¨äº<strong>å¼‚æ­¥è¿”å›å¤šä¸ªå€¼</strong>ï¼Œå®˜æ–¹ä»‹ç»æ˜¯å‚è€ƒ<code>RxJava</code>ç­‰å“åº”å¼æµå®ç°çš„ï¼Œä½†æ˜¯â€œ<em>æ‹¥æœ‰å°½å¯èƒ½ç®€å•çš„è®¾è®¡ï¼Œ å¯¹ Kotlin ä»¥åŠæŒ‚èµ·å‹å¥½ä¸”éµä»ç»“æ„åŒ–å¹¶å‘</em>â€ã€‚æœ¬æ–‡ä¸»è¦å‚è€ƒ<a href="https://www.kotlincn.net/docs/reference/coroutines/flow.html" target="_blank" rel="noopener">Flowä¸­æ–‡æ–‡æ¡£</a>ï¼Œæ¢³ç†äº†å­¦ä¹ è¿‡ç¨‹ä¸­çš„è¦ç‚¹å’Œç†è§£ï¼Œä»¥ä¾¿æ—¥åæŸ¥éªŒã€‚</p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p>å¯¹äºå¼‚æ­¥è¿”å›å¤šä¸ªå€¼çš„éœ€æ±‚ï¼Œé›†åˆï¼ˆå¦‚<code>List</code>ç­‰ï¼‰åªèƒ½ä¸€æ¬¡æ€§è¿”å›å¤šä¸ªå€¼ï¼Œè€Œåºåˆ—ï¼ˆ <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.sequences/index.html" target="_blank" rel="noopener"><code>Sequence</code></a> ï¼‰åªæ”¯æŒé˜»å¡ä»£ç ï¼Œ<code>Flow</code>åˆ™æ”¯æŒæŒ‚èµ·å‡½æ•°å¼‚æ­¥è¿”å›å¤šä¸ªå€¼ã€‚</p><h2 id="åˆ›å»ºFlow"><a href="#åˆ›å»ºFlow" class="headerlink" title="åˆ›å»ºFlow"></a>åˆ›å»ºFlow</h2><ol><li><p><code>flow{...}</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// å‡è£…æˆ‘ä»¬å¼‚æ­¥ç­‰å¾…äº† 100 æ¯«ç§’ï¼Œä¹Ÿå¯ä»¥ç”¨Thread.sleep()ä½†æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">        emit(i) <span class="comment">// å‘å°„ä¸‹ä¸€ä¸ªå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>.asFlow()</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = (<span class="number">1</span>..<span class="number">10</span>).asFlow()</span><br></pre></td></tr></table></figure></li><li><p><code>flowOf{}</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flowOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure></li></ol><p>å› ä¸º<strong>æµåªä¼šåœ¨è¢«æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«å¯åŠ¨</strong>ï¼ˆæŒ‡æ‰§è¡Œç±»ä¼¼<code>flow{...}</code>ä¸­çš„å†…å®¹ï¼‰ï¼Œæ‰€ä»¥ä¸Šè¿°<code>simple()</code>åœ¨è¢«è°ƒç”¨æ—¶ä¼šå°½å¿«è¿”å›ä¸”ä¸ç­‰å¾…ï¼Œæ‰€ä»¥æ— éœ€<code>suspend</code>ä¿®é¥°ã€‚</p><h2 id="æµçš„æ”¶é›†-æœ«ç«¯æµæ“ä½œç¬¦"><a href="#æµçš„æ”¶é›†-æœ«ç«¯æµæ“ä½œç¬¦" class="headerlink" title="æµçš„æ”¶é›†/æœ«ç«¯æµæ“ä½œç¬¦"></a>æµçš„æ”¶é›†/æœ«ç«¯æµæ“ä½œç¬¦</h2><ul><li><p><code>collect{...}</code> æ”¶é›†<code>emit</code>å‘é€çš„å€¼</p><p>é…åˆ<code>onEach{}</code>å¯ä»¥å°†<code>collect</code>ä¸­æ‰§è¡Œçš„ä»£ç æ”¾åˆ°<code>onEach</code>ä¸­ã€‚</p></li><li><p><code>collectLatest{...}</code> æ”¶é›†<code>emit</code>å‘é€çš„å€¼ï¼Œä½†æ¯æ¬¡æ–°çš„<code>emit</code>åˆ°æ¥æ—¶ï¼Œå–æ¶ˆä¹‹å‰çš„æ”¶é›†å™¨ï¼Œåˆ›å»ºæ–°çš„æ”¶é›†å™¨ï¼ˆç”¨æ–°çš„å€¼æ‰§è¡Œ<code>{...}</code>ä¸­çš„ä»£ç ï¼‰</p></li><li><p><code>launchIn</code> æŒ‡å®šåœ¨å•ç‹¬çš„åç¨‹ä¸­å¯åŠ¨æµçš„æ”¶é›†ï¼Œè¿™æ ·å°±å¯ä»¥ç«‹å³ç»§ç»­è¿›ä¸€æ­¥æ‰§è¡Œä»£ç ï¼Œä¸ä¼šæŒ‚èµ·åé¢çš„åç¨‹ä»£ç ã€‚</p></li><li><p><code>single()</code> åªæ¥å—flowå‘é€çš„ä¸€ä¸ªå€¼ï¼Œ0ä¸ªæˆ–å¤šä¸ªéƒ½ä¼šæŠ¥é”™</p></li><li><p><code>first{...}</code> æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼</p></li><li><p><code>reduce()</code> æ±‚å’Œ</p></li><li><p><code>fold(initial,{...})</code> åœ¨åˆå§‹å€¼<code>initial</code>çš„åŸºç¡€ä¸Šæ±‚å’Œ</p></li><li><p><code>toList</code>ã€<code>toSet</code></p></li></ul><h2 id="è¿‡æ¸¡æµæ“ä½œç¬¦"><a href="#è¿‡æ¸¡æµæ“ä½œç¬¦" class="headerlink" title="è¿‡æ¸¡æµæ“ä½œç¬¦"></a>è¿‡æ¸¡æµæ“ä½œç¬¦</h2><p>è¿‡æ¸¡æ“ä½œç¬¦åº”ç”¨äºä¸Šæ¸¸æµï¼Œå¹¶è¿”å›ä¸‹æ¸¸æµã€‚å°±åƒæµä¸€æ ·ã€‚è¿™ç±»æ“ä½œç¬¦æœ¬èº«ä¸æ˜¯æŒ‚èµ·å‡½æ•°ã€‚å®ƒè¿è¡Œçš„é€Ÿåº¦å¾ˆå¿«ï¼Œè¿”å›æ–°çš„è½¬æ¢æµçš„å®šä¹‰ã€‚</p><ul><li><code>map{}</code></li><li><code>filter{}</code></li><li><code>take(n)</code> é™é•¿æ“ä½œç¬¦ï¼Œåªå–å‰nä¸ªå‘å°„çš„å€¼</li></ul><h2 id="æµä¸Šä¸‹æ–‡"><a href="#æµä¸Šä¸‹æ–‡" class="headerlink" title="æµä¸Šä¸‹æ–‡"></a>æµä¸Šä¸‹æ–‡</h2><p>æµé»˜è®¤è¿è¡Œåœ¨æ”¶é›†å™¨æä¾›çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡<code>flowOn</code>æ›´æ”¹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;.flowOn(Dispatchers.Default) <span class="comment">// åœ¨æµæ„å»ºå™¨ä¸­æ”¹å˜æ¶ˆè€— CPU ä»£ç ä¸Šä¸‹æ–‡çš„æ­£ç¡®æ–¹å¼</span></span><br></pre></td></tr></table></figure><h2 id="å±•å¹³æµ"><a href="#å±•å¹³æµ" class="headerlink" title="å±•å¹³æµ"></a>å±•å¹³æµ</h2><p>å°†åµŒå¥—æœ‰<code>Flow</code>çš„<code>Flow</code>ï¼ˆå¦‚<code>Flow&lt;Flow&lt;String&gt;&gt;</code>ï¼‰<strong>å±•å¹³</strong>ä¸ºå•ä¸ªæµï¼ˆå¦‚<code>Flow&lt;String&gt;</code>ï¼‰ã€‚</p><ul><li><p><code>flatMapConcat</code> å°†æ”¶é›†åˆ°çš„æµäº¤ç»™<code>{...}</code>å¤„ç†åï¼Œç­‰å¾…å†…éƒ¨æµå¤„ç†å®Œæ¯•åï¼Œå†å»è¯·æ±‚ä¸‹ä¸€ä¸ªæµ</p></li><li><p><code>flatMapMerge</code> å…ˆé¡ºåºæ”¶é›†æ‰€æœ‰æµï¼Œå†åŒæ—¶æ”¶é›†ç»“æœæµ</p></li><li><p><code>flatMapLatest{...}</code> ç±»ä¼¼äº<code>collectLatest{...}</code>ï¼Œåœ¨æ–°æµå‘å‡ºçš„æ—¶å€™ï¼Œç«‹å³å–æ¶ˆ<code>{...}</code>ä¸­æ‰€æœ‰çš„ä»£ç </p></li><li><p><code>flattenConcat</code> ä¾æ¬¡å±•å¹³æµ</p></li><li><p><code>flattenMerge{...}</code> å¹¶å‘æ‹¼æ¥ï¼Œå…ˆæ‰§è¡Œ<code>{...}</code>ä¸­çš„æ–¹æ³•ï¼Œå†æ‰§è¡Œ<code>collect</code>ç­‰æ–¹æ³•ï¼Œé¡ºåºä¼šä¹±ã€‚</p></li></ul><h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><ul><li><p><code>try/catch</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        println(<span class="string">"Emitting <span class="variable">$i</span>"</span>)</span><br><span class="line">        emit(i) <span class="comment">// å‘å°„ä¸‹ä¸€ä¸ªå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        simple().collect &#123; value -&gt;         </span><br><span class="line">            println(value)</span><br><span class="line">            check(value &lt;= <span class="number">1</span>) &#123; <span class="string">"Collected <span class="variable">$value</span>"</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">        println(<span class="string">"Caught <span class="variable">$e</span>"</span>)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>catch()</code></p><p><strong>é€æ˜æ•è·</strong>ï¼šåªæ•è·ä¸Šæ¸¸å¼‚å¸¸ï¼Œå…¶ä¹‹åçš„å¼‚å¸¸ä¸ä¼šè¢«å¤„ç†ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">simple()</span><br><span class="line">    .<span class="keyword">catch</span> &#123; e -&gt; emit(<span class="string">"Caught <span class="variable">$e</span>"</span>) &#125; <span class="comment">// å‘å°„ä¸€ä¸ªå¼‚å¸¸</span></span><br><span class="line">    .collect &#123; </span><br><span class="line">        value -&gt; println(value) <span class="comment">//æ­¤å¤„å¦‚æœ‰å¼‚å¸¸ï¼Œä¸ä¼šè¢«catchæ•è·</span></span><br><span class="line">             &#125;</span><br></pre></td></tr></table></figure><p><strong>å£°æ˜å¼æ•è·</strong>ï¼šå°†<code>collect</code>çš„ä»£ç ç§»åŠ¨åˆ°<code>onEach</code>ä¸­ï¼Œå°†å…¶æ”¾åˆ°<code>catch</code>ä¹‹å‰ï¼Œä»è€Œä½¿å…¶è¢«<code>catch</code>æ•è·ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">simple()</span><br><span class="line">    .onEach &#123; value -&gt;</span><br><span class="line">        check(value &lt;= <span class="number">1</span>) &#123; <span class="string">"Collected <span class="variable">$value</span>"</span> &#125; <span class="comment">//æ­¤å¤„å¼‚å¸¸ä¼šè¢«catchæ•è·             </span></span><br><span class="line">        println(value) </span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="keyword">catch</span> &#123; e -&gt; println(<span class="string">"Caught <span class="variable">$e</span>"</span>) &#125;</span><br><span class="line">    .collect()</span><br></pre></td></tr></table></figure></li></ul><h2 id="æµå–æ¶ˆ"><a href="#æµå–æ¶ˆ" class="headerlink" title="æµå–æ¶ˆ"></a>æµå–æ¶ˆ</h2><ul><li><code>flow { ... }</code> åˆ›å»ºçš„æµçš„ç¹å¿™å¾ªç¯é»˜è®¤å¯ä»¥å–æ¶ˆ</li><li>å…¶ä»–æµå¦‚æœéœ€è¦å–æ¶ˆï¼Œå¯ä»¥æ·»åŠ  <code>.onEach { currentCoroutineContext().ensureActive() }</code> æˆ–è€…<code>.cancellable()</code></li></ul><h2 id="æµå®Œæˆ"><a href="#æµå®Œæˆ" class="headerlink" title="æµå®Œæˆ"></a>æµå®Œæˆ</h2><ul><li><p>å‘½ä»¤å¼</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">       simple().collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       println(<span class="string">"Done"</span>) <span class="comment">//ç›‘å¬æµå®Œæˆ</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li><li><p>å£°æ˜å¼</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">simple()</span><br><span class="line">    .onCompletion &#123; println(<span class="string">"Done"</span>) &#125; <span class="comment">//ç›‘å¬æµå®Œæˆï¼Œåœ¨collectæ‰§è¡Œç»“æŸåæ‰æ‰§è¡Œ</span></span><br><span class="line">    .collect &#123; value -&gt; println(value) &#125;</span><br></pre></td></tr></table></figure><p><code>onCompletion</code>çš„å¯ç©ºå‚æ•° <code>Throwable</code> å¯ä»¥ç”¨äºç¡®å®šæµæ”¶é›†æ˜¯æ­£å¸¸å®Œæˆï¼ˆä¸º<code>null</code>ï¼‰è¿˜æ˜¯æœ‰å¼‚å¸¸å‘ç”Ÿã€‚ä»–ä¸ä¼šå¤„ç†å¼‚å¸¸ã€‚</p></li></ul><h2 id="å…¶ä½™æ“ä½œ"><a href="#å…¶ä½™æ“ä½œ" class="headerlink" title="å…¶ä½™æ“ä½œ"></a>å…¶ä½™æ“ä½œ</h2><ul><li><p><code>buffer()</code> ç¼“å†²å‘å°„é¡¹ï¼Œæ”¶é›†å®Œæˆåå†ä¼ ç»™ä¸‹ä¸€æ­¥</p></li><li><p><code>conflate()</code> åˆå¹¶å‘å°„é¡¹ï¼Œä¼šä¸¢å¼ƒæ¥ä¸åŠå¤„ç†çš„ä¸­é—´å€¼ï¼Œåªè·å–å¹¶å¤„ç†æœ€æ–°çš„å€¼</p></li><li><p><code>zip()</code> åˆå¹¶ä¸¤ä¸ªæµçš„å€¼,ä¸¤ä¸ªæµä¸­çš„å€¼ä¸€ä¸€å¯¹åº”</p><p>ä¾‹å¦‚<code>(1,2,3) 3så‘å°„ä¸€æ¬¡,(a,b,c) 4så‘å°„ä¸€æ¬¡</code>ç›´æ¥æ‹¼æ¥ï¼Œåˆå¹¶ä¹‹åä¸º <code>(1a,2b,3c)</code></p></li><li><p><code>combine()</code> ç»“åˆä¸¤ä¸ªæµçš„å€¼ï¼Œä»»æ„ä¸€ä¸ªæµä¸­çš„å€¼å‘ç”Ÿå˜åŒ–éƒ½ä¼šè§¦å‘æ‰§è¡Œè®¡ç®—</p><p>ä¾‹å¦‚<code>(1,2,3) 3så‘å°„ä¸€æ¬¡,(a,b,c) 4så‘å°„ä¸€æ¬¡</code>ç›´æ¥æ‹¼æ¥ï¼Œåˆå¹¶ä¹‹åä¸º <code>(1a,2a,2b,3b,3c)</code></p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://www.kotlincn.net/docs/reference/coroutines/flow.html" target="_blank" rel="noopener">Kotlin Flow ä¸­æ–‡æ–‡æ¡£</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidä»Šæ—¥å¤´æ¡å±å¹•é€‚é…æ–¹æ¡ˆçš„åŸç†æ¢³ç†</title>
      <link href="/blog/posts/76d69fc6/"/>
      <url>/blog/posts/76d69fc6/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘åœ¨é¡¹ç›®é‡Œé¢é‡åˆ°äº†å±å¹•é€‚é…çš„é—®é¢˜ï¼ŒUIè¦æ±‚APPåœ¨ä¸åŒæ‰‹æœºä¸Šå±•ç¤ºæ•ˆæœå’Œè®¾è®¡ç¨¿ä¿æŒâ€œåƒç´ çº§â€åŒæ­¥ï¼Œåœ¨å¯¹æ¯”äº†å‡ ç§å±å¹•é€‚é…æ–¹æ¡ˆä¹‹åï¼Œé€‰æ‹©äº†åŸºäºä»Šæ—¥å¤´æ¡çš„<a href="https://github.com/JessYanCoding/AndroidAutoSize" target="_blank" rel="noopener">AndroidAutoSize</a>é€‚é…æ–¹æ¡ˆã€‚</p><p>æœ¬æ–‡ä¸»è¦ç®€å•åˆ†æå…¶é€‚é…åŸç†ï¼Œä»¥åŠåœ¨å®é™…ä½¿ç”¨ä¸­é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦æ›´æ·±å…¥äº†è§£åŸç†å¯ä»¥é˜…è¯»æ–‡æœ«å‚è€ƒæ–‡çŒ®ã€‚</p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p>UIç»™çš„è®¾è®¡ç¨¿ä¸€èˆ¬éƒ½æ˜¯ä»¥åƒç´ pxä¸ºå•ä½ï¼Œè€Œåœ¨Androidå¼€å‘ä¸­å®˜æ–¹æ¨èçš„ä½¿ç”¨çš„å•ä½æ˜¯dpã€‚</p><blockquote><p>dp æ˜¯ä¸€ä¸ªè™šæ‹Ÿåƒç´ å•ä½ï¼Œ1 dp çº¦ç­‰äºä¸­å¯†åº¦å±å¹•ï¼ˆ160dpiï¼›â€œåŸºå‡†â€å¯†åº¦ï¼‰ä¸Šçš„ 1 åƒç´ ã€‚å¯¹äºå…¶ä»–æ¯ä¸ªå¯†åº¦ï¼ŒAndroid ä¼šå°†æ­¤å€¼è½¬æ¢ä¸ºç›¸åº”çš„å®é™…åƒç´ æ•°ã€‚</p><p>â€”â€” Android Developer</p></blockquote><p>æ ¹æ®Androidå®˜æ–¹çš„å®šä¹‰ï¼Œdpåœ¨å±å¹•ä¸Šå®é™…å¯¹åº”çš„åƒç´ pxè®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">px = dp * (dpi / <span class="number">160</span>)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ dpiè¡¨ç¤ºï¼š<strong>å±å¹•æ¯å¹³æ–¹è‹±å¯¸æœ‰å¤šå°‘åƒç´ </strong>ï¼Œå¯ä»¥é€šè¿‡å±å¹•å¯¹è§’çº¿çš„åƒç´ æ•°px/å±å¹•å°ºå¯¸inchè®¡ç®—ã€‚</p><p>è€Œ<code>DisplayMetrics.density</code> å­—æ®µè¡¨ç¤ºæ ¹æ®å½“å‰åƒç´ å¯†åº¦æŒ‡å®šå°† <code>dp</code> å•ä½è½¬æ¢ä¸ºåƒç´ æ—¶æ‰€å¿…é¡»ä½¿ç”¨çš„ç¼©æ”¾ç³»æ•°ï¼Œå³ä¸Šè¿°æ–¹ç¨‹ç­‰ä»·äºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">px = dp * (dpi / <span class="number">160</span>)</span><br><span class="line">   = dp * getResources().getDisplayMetrics().density</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œåœ¨dpiä¸º160çš„å±å¹•ä¸Š1dpå 1pxï¼Œåœ¨dpiä¸º320çš„å±å¹•ä¸Šå 2pxï¼Œé‚£ä¹ˆå°±èƒ½ä¿è¯åŒä¸€dpçš„åœ¨ä¸åŒdpiä¸Šå å¾—åƒç´ æ˜¯ç­‰æ¯”ä¾‹å˜åŒ–çš„ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨ç°å®ç”Ÿæ´»ä¸­é¢å¯¹åƒå˜ä¸‡åŒ–çš„Androidå±å¹•ï¼Œæ ¹æ®Jessyançš„æ–‡ç« å¯çŸ¥ç”±äºæ¯ç§å±å¹•å®½/é«˜å¯¹åº”çš„æ€»dpæ•°ä¸ä¸€å®šéƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å³ä½¿ä½¿ç”¨äº†dpä½œä¸ºå•ä½ï¼Œè¿˜æ˜¯ä¼šå‡ºç°åŒä¸€dpåœ¨æœ‰äº›å±å¹•ä¸Šåˆšå¥½å æ»¡å…¨å±ï¼Œåœ¨æœ‰çš„å±å¹•ä¸Šä¼šæ— æ³•å æ»¡å…¨å±æˆ–è¶…å‡ºå±å¹•èŒƒå›´ã€‚</p><blockquote><p><strong>density</strong> åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šéƒ½æ˜¯å›ºå®šçš„ï¼Œ<strong>DPI / 160 = density</strong>ï¼Œ<strong>å±å¹•çš„æ€» px å®½åº¦ / density = å±å¹•çš„æ€» dp å®½åº¦</strong></p><ul><li>è®¾å¤‡ 1ï¼Œå±å¹•å®½åº¦ä¸º <strong>1080px</strong>ï¼Œ<strong>480DPI</strong>ï¼Œå±å¹•æ€» <strong>dp</strong> å®½åº¦ä¸º <strong>1080 / (480 / 160) = 360dp</strong></li><li>è®¾å¤‡ 2ï¼Œå±å¹•å®½åº¦ä¸º <strong>1440px</strong>ï¼Œ<strong>560DPI</strong>ï¼Œå±å¹•æ€» <strong>dp</strong> å®½åº¦ä¸º <strong>1440 / (560 / 160) = 411dp</strong></li></ul><p>â€”â€”Jessyan</p></blockquote><p>é‚£ä¹ˆè¯¥æ€ä¹ˆé€‚é…å‘¢ï¼Œå†çœ‹ä¸€çœ¼ä¸Šè¿°çš„å…¬å¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å±å¹•çš„æ€» px å®½åº¦ / density = å±å¹•çš„æ€» dp å®½åº¦</span><br></pre></td></tr></table></figure><p>ä»¥é€‚é…<strong>å±å¹•å®½åº¦</strong>ä¸ºä¾‹ï¼Œè¦ä½¿å¾—dpåœ¨ä¸åŒå±å¹•ä¸Šå¯¹åº”çš„åƒç´ ç­‰æ¯”ä¾‹å˜åŒ–ï¼Œå°±è¦<strong>ä¿è¯å±å¹•çš„æ€»dpå®½åº¦ä¸€è‡´</strong>ï¼Œè€Œå±å¹•çš„æ€» px å®½åº¦æ˜¯ç‰©ç†æ¡ä»¶æ— æ³•æ›´æ”¹ï¼Œé‚£ä¹ˆå°±åªèƒ½<strong>æ›´æ”¹density</strong>ã€‚</p><p>ä»¥æˆ‘ä»¬ä½¿ç”¨çš„è®¾è®¡ç¨¿å®½åº¦ä¸º375dpä¸ºä¾‹ï¼š</p><p>åœ¨åˆ†è¾¨ç‡ä¸º2160*1080 ã€å°ºå¯¸ä¸º5.99è‹±å¯¸çš„å±å¹•ä¸Šï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">density = <span class="number">1080</span>px / <span class="number">375</span>dp = <span class="number">2.88</span></span><br></pre></td></tr></table></figure><p> è€Œåœ¨åˆ†è¾¨ç‡ä¸º2400*1176ã€å°ºå¯¸ä¸º6.53è‹±å¯¸çš„å±å¹•ä¸Šï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">density = <span class="number">1176</span>px / <span class="number">375</span>dp = <span class="number">3.136</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±ä¿è¯äº†ï¼Œä¸ç®¡åœ¨ä»€ä¹ˆæ ·çš„å±å¹•ä¸Šï¼Œ375dpå§‹ç»ˆéƒ½èƒ½å¤Ÿå æ»¡å±å¹•å®½åº¦ï¼Œä¿è¯äº†å¸ƒå±€åœ¨ä¸åŒå¤§å°çš„å±å¹•ä¸Šï¼Œåœ¨å±å¹•å®½åº¦ä¸Šçš„æ¯”ä¾‹ä¸€è‡´æ€§ï¼Œä¹Ÿå°±è§£å†³å±å¹•é€‚é…çš„é—®é¢˜ã€‚</p><h1 id="è·å–çŠ¶æ€æ é«˜åº¦çš„é—®é¢˜"><a href="#è·å–çŠ¶æ€æ é«˜åº¦çš„é—®é¢˜" class="headerlink" title="è·å–çŠ¶æ€æ é«˜åº¦çš„é—®é¢˜"></a>è·å–çŠ¶æ€æ é«˜åº¦çš„é—®é¢˜</h1><p>ä¸Šè¿°çš„å±å¹•é€‚é…æ–¹æ¡ˆä½¿ç”¨ç®€å•ï¼Œä¸”ä¾µå…¥å°ï¼Œåœ¨ä½¿ç”¨åˆ°é¡¹ç›®ä¸­ä¹‹åï¼Œé™¤äº†éƒ¨åˆ†å­—ä½“ç­‰æ˜¾ç¤ºéœ€è¦å¾®è°ƒå¤–ï¼Œå…¶ä½™å†…å®¹åŸºæœ¬ä¸Šéƒ½å®Œç¾è¿˜åŸäº†è®¾è®¡ç¨¿çš„å†…å®¹ã€‚</p><p>ä½†æ˜¯åœ¨åç»­ä½¿ç”¨åˆ°çŠ¶æ€æ ç›¸å…³ä»£ç çš„æ—¶å€™å‘ç°<strong>è·å–åˆ°çš„çŠ¶æ€æ é«˜åº¦å’Œå®é™…é«˜åº¦ä¸ä¸€è‡´</strong>ï¼Œå¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸ï¼Œè€Œä½¿ç”¨<a href="http://blankj.com" target="_blank" rel="noopener">Blankj</a>çš„å·¥å…·ç±» <code>BarUtils.getStatusBarHeight()</code>å´å¯ä»¥è·å–åˆ°æ­£ç¡®çš„é«˜åº¦ã€‚</p><p>å¯¹æ¯”ä¸¤ç§ä»£ç å‘ç°è·å–çŠ¶æ€æ é«˜åº¦çš„ä»£ç é€»è¾‘å‡ ä¹ä¸€æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getStatusBarHeight</span><span class="params">(Resources resources)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> resourceId = resources.getIdentifier(<span class="string">"status_bar_height"</span>, <span class="string">"dimen"</span>, <span class="string">"android"</span>);</span><br><span class="line">    <span class="keyword">return</span> resources.getDimensionPixelSize(resourceId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„æ˜¯ï¼Œä¸¤ç§æ–¹æ³•ä½¿ç”¨åˆ°çš„resourcesä¸€ä¸ªæ˜¯APPçš„ï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿçš„</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æˆ‘ä½¿ç”¨åˆ°çš„resourcesï¼Œä»å½“å‰activityè·å–</span></span><br><span class="line">resources.displayMetrics.density</span><br><span class="line"><span class="comment">// 2. Blankjä½¿ç”¨çš„resourcesï¼Œä»ç³»ç»Ÿè·å–</span></span><br><span class="line">Resources.getSystem().displayMetrics.density</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†åˆ«æ‰“å°è¿™ä¸¤ç§resourceså¯ä»¥å‘ç°ï¼ŒäºŒè€…çš„densityå€¼ä¸ä¸€æ ·ï¼ˆä»¥2160*1080 ã€å°ºå¯¸ä¸º5.99è‹±å¯¸çš„å±å¹•ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">context.resources.DisplayMetrics: DisplayMetrics&#123;density=<span class="number">2.88</span>, width=<span class="number">1080</span>, height=<span class="number">2033</span>, scaledDensity=<span class="number">2.88</span>, xdpi=<span class="number">403.411</span>, ydpi=<span class="number">403.411</span>&#125;</span><br><span class="line"></span><br><span class="line">Resources.getSystem().DisplayMetrics: DisplayMetrics&#123;density=<span class="number">2.7</span>, width=<span class="number">1080</span>, height=<span class="number">2033</span>, scaledDensity=<span class="number">2.7</span>, xdpi=<span class="number">403.411</span>, ydpi=<span class="number">403.411</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç”±äºä½¿ç”¨äº†<a href="https://github.com/JessYanCoding/AndroidAutoSize" target="_blank" rel="noopener">AndroidAutoSize</a>é€‚é…æ–¹æ¡ˆåï¼ŒAPPå†…éƒ¨çš„densityå·²ç»è¢«æ”¹æˆäº†2.88ï¼Œè€Œç³»ç»Ÿå®é™…çš„densityæ˜¯2.7ã€‚</p><p>åˆçŸ¥é“androidä¸­å°†åƒç´ å’Œdpç­‰å•ä½è½¬åŒ–çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.util.TypedValue</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">applyDimension</span><span class="params">(<span class="keyword">int</span> unit, <span class="keyword">float</span> value,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       DisplayMetrics metrics)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (unit) &#123;</span><br><span class="line">        <span class="keyword">case</span> COMPLEX_UNIT_PX:</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        <span class="keyword">case</span> COMPLEX_UNIT_DIP:</span><br><span class="line">            <span class="keyword">return</span> value * metrics.density;</span><br><span class="line">        <span class="keyword">case</span> COMPLEX_UNIT_SP:</span><br><span class="line">            <span class="keyword">return</span> value * metrics.scaledDensity;</span><br><span class="line">        <span class="keyword">case</span> COMPLEX_UNIT_PT:</span><br><span class="line">            <span class="keyword">return</span> value * metrics.xdpi * (<span class="number">1.0f</span>/<span class="number">72</span>);</span><br><span class="line">        <span class="keyword">case</span> COMPLEX_UNIT_IN:</span><br><span class="line">            <span class="keyword">return</span> value * metrics.xdpi;</span><br><span class="line">        <span class="keyword">case</span> COMPLEX_UNIT_MM:</span><br><span class="line">            <span class="keyword">return</span> value * metrics.xdpi * (<span class="number">1.0f</span>/<span class="number">25.4f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åˆ†æå¯çŸ¥ï¼Œé€šè¿‡getStatusBarHeight()è·å–åˆ°çš„çŠ¶æ€æ æ˜¯ç³»ç»Ÿçš„çŠ¶æ€æ 69pxï¼ˆå³25dpï¼‰ï¼Œä½†å½“ä½¿ç”¨APPå†…éƒ¨çš„density=2.88è®¡ç®—æ—¶å°±ä¼šåªæœ‰24dpï¼Œå’Œå®é™…çš„çŠ¶æ€æ é«˜åº¦ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ä½¿ç”¨çŠ¶æ€æ é«˜åº¦æ¥æ§åˆ¶å¸ƒå±€çš„æ—¶å€™å°±ä¼šå±•ç¤ºå¼‚å¸¸ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="http://jessyan.me/autosize-introduce/" target="_blank" rel="noopener">éªšå¹´ä½ çš„å±å¹•é€‚é…æ–¹å¼è¯¥å‡çº§äº†!-ä»Šæ—¥å¤´æ¡é€‚é…æ–¹æ¡ˆâ€”â€”jessyan</a></p><p><a href="https://mp.weixin.qq.com/s/d9QCoBP6kV9VSWvVldVVwA" target="_blank" rel="noopener">ä¸€ç§æä½æˆæœ¬çš„Androidå±å¹•é€‚é…æ–¹å¼â€”â€”å­—èŠ‚è·³åŠ¨</a></p><p><a href="https://developer.android.google.cn/training/multiscreen/screendensities#top_of_page" target="_blank" rel="noopener">æ”¯æŒä¸åŒçš„åƒç´ å¯†åº¦â€”â€”Android Developers</a></p><p><a href="https://mp.weixin.qq.com/s/X-aL2vb4uEhqnLzU5wjc4Q" target="_blank" rel="noopener">Android ç›®å‰ç¨³å®šé«˜æ•ˆçš„UIé€‚é…æ–¹æ¡ˆâ€”â€”æ‹‰ä¸å´</a></p><p><a href="https://github.com/JessYanCoding/AndroidAutoSize" target="_blank" rel="noopener">AndroidAutoSize</a></p><p><a href="https://github.com/gyf-dev/ImmersionBar/issues/298" target="_blank" rel="noopener">è¯·é—®ä¸¤ç§è·å–å±å¹•å¯†åº¦çš„æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæœ›è§£ç­”å¤šè°¢</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidç¬”è®°ä¹‹Xfermode</title>
      <link href="/blog/posts/104c9058/"/>
      <url>/blog/posts/104c9058/</url>
      
        <content type="html"><![CDATA[<p><code>Xfermode</code>æ˜¯Androidä¸­ç”¨æ¥æŒ‡ç¤º<code>Paint</code>ç»˜åˆ¶çš„å†…å®¹ä¸Viewä¸­å·²æœ‰å†…å®¹çš„æ··åˆè®¡ç®—æ–¹å¼,ä¹Ÿå°±æ˜¯ç”¨æ¥ç¡®å®šå›¾å½¢ç»˜åˆ¶åˆ°ç›®æ ‡å›¾å½¢çš„æ—¶å€™ï¼Œå¦‚ä½•å¤„ç†ä¸¤ä¸ªå›¾å½¢é‡åˆéƒ¨åˆ†çš„é¢œè‰²å˜åŒ–ã€‚å…±18ä¸ªï¼Œåˆ†ä¸ºAlphaåˆæˆå’Œæ··åˆä¸¤ç§ã€‚</p><p>è®¾è¦ç»˜åˆ¶çš„å›¾å½¢ä¸º<code>src</code>ï¼Œå·²ç»ç»˜åˆ¶å¥½çš„å›¾å½¢ä¸º<code>dst</code>ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›å›¾ç‰‡é™¤äº†è¦ç»˜åˆ¶çš„å›¾å½¢æœ‰ç€è‰²ä¹‹å¤–ï¼Œå…¶ä»–éƒ¨åˆ†è¦ä¸ºé€æ˜ï¼Œå¹¶ä¸”<strong>åŒ…æ‹¬é€æ˜åŒºåŸŸåœ¨å†…çš„å›¾ç‰‡å¤§å°ï¼ˆå®½é«˜ï¼‰è¦èƒ½å®Œå…¨è¦†ç›–å¦å¤–ä¸€å¼ å›¾ç‰‡çš„å›¾å½¢åŒºåŸŸ</strong>ï¼Œå¦åˆ™ç»˜åˆ¶å‡ºçš„å›¾å½¢å¯èƒ½ä¸é¢„è®¾çš„æ•ˆæœä¸ä¸€è‡´</p></blockquote><p>æŒ‰ç…§å®˜æ–¹çš„å®šä¹‰ï¼Œä¸åŒ<code>Xfermode</code>ç»˜åˆ¶ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200415211144.png" alt></p><h1 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h1><p>è¦å®ç°å¦‚ä¸Šæ•ˆæœï¼Œéœ€è¦æ³¨æ„ï¼š</p><ul><li><p><code>src</code>å’Œ<code>dst</code>ç¬¦åˆè¦æ±‚ï¼ˆè¦æœ‰åˆé€‚çš„é€æ˜åŒºåŸŸï¼‰</p><p>è¿™æ˜¯å› ä¸º<code>xfermode</code>çš„æ•ˆæœï¼Œä½¿ç”¨é€æ˜éƒ¨åˆ†çš„åƒç´ ä¸å·²æœ‰å›¾å½¢å¯¹åº”ä½ç½®äº¤å‰ä½œç”¨ï¼Œå¾—å‡ºæ‰€éœ€è¦çš„æ•ˆæœï¼Œå¦‚æœé€æ˜åŒºåŸŸè¿‡å°ï¼Œåˆ™æ— æ³•ä½œç”¨åˆ°å¯¹åº”çš„å›¾å½¢ã€‚ä¸‹é¢è¿™ä¸ªæ¥è‡ªHencoder.comçš„å›¾å¯ä»¥å¾ˆå½¢è±¡çš„è§£é‡Šï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200416213802.jpg" alt></p></li><li><p>åœ¨æ–°çš„å›¾å±‚ç»˜åˆ¶ï¼ˆåœ¨æ–°çš„å›¾å±‚æŒ‰ç…§<code>xfermode</code>è§„åˆ™ç»˜åˆ¶ï¼Œç„¶åå†å°†å…¶ç»˜åˆ¶åˆ°åŸæœ‰å›¾å±‚ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ–°å»ºå›¾å±‚   </span></span><br><span class="line"><span class="keyword">val</span> saveCount = canvas.saveLayer(<span class="number">0F</span>,<span class="number">0F</span>,width.toFloat(),height.toFloat(),<span class="literal">null</span>,Canvas.ALL_SAVE_FLAG)</span><br><span class="line"></span><br><span class="line"><span class="comment">//dst  å·²ç»ç»˜åˆ¶çš„å›¾å½¢  ;  src æˆ‘ä»¬è¦ç»˜åˆ¶çš„å›¾å½¢</span></span><br><span class="line">canvas.drawBitmap(dst,<span class="number">0F</span>, <span class="number">0F</span>, dstPaint)</span><br><span class="line"></span><br><span class="line">srcPaint.xfermode = PorterDuffXfermode(PorterDuff.Mode.SRC_OUT)</span><br><span class="line">canvas.drawBitmap(src,<span class="number">0F</span>, <span class="number">0F</span>, srcPaint)</span><br><span class="line">srcPaint.xfermode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æ–°å›¾å±‚ç»˜åˆ¶åˆ°åŸæœ‰å›¾å±‚ä¸Š</span></span><br><span class="line">canvas.restoreToCount(saveCount)</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>å…³é—­ç¡¬ä»¶åŠ é€Ÿï¼ˆå¯é€‰ï¼‰</p><p>ç¡¬ä»¶åŠ é€Ÿçš„æœ¬è´¨æ˜¯æŠŠä¸€éƒ¨åˆ†CPUè®¡ç®—çš„å·¥ä½œé‡äº¤ç»™GPUå®Œæˆï¼Œå¯ä»¥åŠ é€Ÿç»˜åˆ¶é€Ÿåº¦ã€‚</p><p>ä½†æ˜¯ç”±äºç¡¬ä»¶åŠ é€Ÿä¸æ”¯æŒ<code>canvas.drawXXX()</code>çš„éƒ¨åˆ†æ–¹æ³•ï¼Œä¸ºäº†é¿å…åœ¨æŸäº›æœºå‹ä¸Šé¢æ— æ³•ä½¿ç”¨è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥å…³é—­ç¡¬ä»¶åŠ é€Ÿï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.setLayerType(LAYER_TYPE_SOFTWARE, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><p>å…³äºç¡¬ä»¶åŠ é€Ÿæ›´è¯¦ç»†çš„è¯´æ˜å¯ä»¥å‚è€ƒè¿™é‡Œï¼š<a href="https://hencoder.com/ui-1-8/" target="_blank" rel="noopener">HenCoder Android è‡ªå®šä¹‰ View 1-8 ç¡¬ä»¶åŠ é€Ÿ</a></p></li></ul><h1 id="Xfermodeåˆ†ç±»"><a href="#Xfermodeåˆ†ç±»" class="headerlink" title="Xfermodeåˆ†ç±»"></a>Xfermodeåˆ†ç±»</h1><p><a href="https://hencoder.com/ui-1-2/" target="_blank" rel="noopener">HenCoder.com</a>å…³äº<code>PorterDuff.Mode.DST_IN</code>çš„åŠ¨ç”»è§£é‡Šï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200416214402.gif" alt></p><p>å¯ä»¥çœ‹å‡ºï¼Œ<code>Xfermode</code>çš„æœ¬è´¨æ˜¯å¤„ç†<code>dst</code>ä¸<code>src</code><strong>é‡åˆä¸æœªé‡åˆéƒ¨åˆ†</strong>çš„å±•ç¤ºä¸å¦ï¼Œä»¥åŠé¢œè‰²å˜åŒ–ã€‚</p><blockquote><p>è¿™é‡Œçš„â€œé‡åˆéƒ¨åˆ†â€ä¸â€œæœªé‡åˆéƒ¨åˆ†â€ï¼Œå…¶å®ä¹ŸåŒ…æ‹¬äº†å„ä¸ªå›¾å½¢çš„é€æ˜éƒ¨åˆ†ï¼Œå°†<code>dst</code>ä¸<code>src</code>çš„é€æ˜ä¸ä¸é€æ˜é¢œè‰²ç›¸äº’ä½œç”¨ï¼Œæ‰ä¼šå‡ºç°ä¸‹è¿°æ•ˆæœã€‚</p></blockquote><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>CLEAR</code></td><td>æ¸…é™¤æ‰€æœ‰å†…å®¹</td></tr><tr><td><code>DST</code></td><td>åªç»˜åˆ¶<code>DST</code></td></tr><tr><td><code>DST_ATOP</code></td><td>å…ˆç»˜åˆ¶<code>SRC</code>ï¼Œå†åœ¨é¡¶éƒ¨ç»˜åˆ¶<code>DST</code>ä¸<code>SRC</code>é‡åˆçš„éƒ¨åˆ†</td></tr><tr><td><code>DST_IN</code></td><td>åªç»˜åˆ¶<code>DST</code>ä¸<code>SRC</code>é‡åˆéƒ¨åˆ†</td></tr><tr><td><code>DST_OUT</code></td><td>åªç»˜åˆ¶<code>DST</code>ä¸<code>SRC</code>æœªé‡åˆéƒ¨åˆ†</td></tr><tr><td><code>DST_OVER</code></td><td>å°†<code>DST</code>ç»˜åˆ¶åœ¨<code>SRC</code>ä¸Šé¢</td></tr><tr><td><code>SRC</code></td><td>åªç»˜åˆ¶<code>SRC</code></td></tr><tr><td><code>SRC_ATOP</code></td><td>å…ˆç»˜åˆ¶<code>DST</code>ï¼Œå†åœ¨é¡¶éƒ¨ç»˜åˆ¶<code>SRC</code>ä¸<code>DST</code>é‡åˆçš„éƒ¨åˆ†</td></tr><tr><td><code>SRC_IN</code></td><td>åªç»˜åˆ¶<code>SRC</code>ä¸<code>DST</code>é‡åˆéƒ¨åˆ†</td></tr><tr><td><code>SRC_OUT</code></td><td>åªç»˜åˆ¶<code>SRC</code>ä¸<code>DST</code>æœªé‡åˆéƒ¨åˆ†</td></tr><tr><td><code>SRC_OVER</code></td><td>å°†<code>SRC</code>ç»˜åˆ¶åœ¨<code>DST</code>ä¸Šé¢</td></tr><tr><td></td><td></td></tr><tr><td><code>XOR</code></td><td></td></tr><tr><td><code>ADD</code></td><td></td></tr><tr><td><code>DARKEN</code></td><td></td></tr><tr><td><code>LIGHTEN</code></td><td></td></tr><tr><td><code>MULTIPLY</code></td><td></td></tr><tr><td><code>OVERLAY</code></td><td></td></tr><tr><td><code>SCREEN</code></td></tr></tbody></table><p>å„ä¸ªæ•ˆæœå¦‚ä¸‹(æºç åŠä½¿ç”¨è§<a href="https://github.com/jixiaoyong/library/commit/71864b6546460acfaae6299890a0cf76da76b7d7" target="_blank" rel="noopener">github</a>)ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200415211144.png" alt></p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://hencoder.com/ui-1-2/" target="_blank" rel="noopener">HenCoder Android å¼€å‘è¿›é˜¶: è‡ªå®šä¹‰ View 1-2 Paint è¯¦è§£</a></p><p><a href="https://hencoder.com/ui-1-8/" target="_blank" rel="noopener">HenCoder Android è‡ªå®šä¹‰ View 1-8 ç¡¬ä»¶åŠ é€Ÿ</a></p><p><a href="https://developer.android.google.cn/reference/android/graphics/PorterDuff.Mode.html" target="_blank" rel="noopener">PorterDuff.Mode</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidç¬”è®°ä¹‹è´å¡å°”æ›²çº¿çš„åº”ç”¨</title>
      <link href="/blog/posts/5c023044/"/>
      <url>/blog/posts/5c023044/</url>
      
        <content type="html"><![CDATA[<p><a href="https://baike.baidu.com/item/è´å¡å°”æ›²çº¿" target="_blank" rel="noopener">è´å¡å°”æ›²çº¿</a>æ˜¯ç”¨èŠ‚ç‚¹å’Œæ§åˆ¶ç‚¹ç»˜åˆ¶çš„é«˜ç²¾åº¦æ›²çº¿ï¼ŒAndroidä¸­å¸¸ç”¨çš„æœ‰äºŒé˜¶ã€ä¸‰é˜¶è´å¡å°”æ›²çº¿ã€‚æœ¬æ–‡ä»‹ç»ä½¿ç”¨è´å¡å°”æ›²çº¿ç»˜åˆ¶æŠ˜çº¿å›¾ï¼Œå¹¶å®ç°åŠ¨ç”»æ•ˆæœã€‚</p><p><img src="https://jixiaoyong.github.io/images/20200413215502.jpg" alt></p><p>æœ¬æ–‡ä»£ç é“¾æ¥ï¼š<a href="https://github.com/jixiaoyong/library/blob/master/library/src/main/java/cf/android666/applibrary/view/BezierViewAnim.kt" target="_blank" rel="noopener">https://github.com/jixiaoyong/library/blob/master/library/src/main/java/cf/android666/applibrary/view/BezierViewAnim.kt</a></p><h1 id="è´å¡å°”æ›²çº¿ä»‹ç»"><a href="#è´å¡å°”æ›²çº¿ä»‹ç»" class="headerlink" title="è´å¡å°”æ›²çº¿ä»‹ç»"></a>è´å¡å°”æ›²çº¿ä»‹ç»</h1><p>ä¸‹å›¾æ˜¯äºŒé˜¶è´å¡å°”æ›²çº¿ç»˜åˆ¶æ–¹æ³•ä»‹ç»ï¼Œåªè¦å„ä¸ªç‚¹æ»¡è¶³æ¡ä»¶ï¼šAD/AB = BE/BC = DF/DEï¼Œé‚£ä¹ˆå½“æ²¿ç€å½“å‰çº¿æ®µç§»åŠ¨Dã€Eç‚¹æ—¶ï¼ŒFç‚¹çš„è¿åŠ¨è½¨è¿¹å°±æ˜¯ä¸€ä¸ªè´å¡å°”æ›²çº¿ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200413215622.png" alt="å›¾ç‰‡æ¥è‡ª: https://www.cnblogs.com/wjtaigwh/p/6647114.html"></p><p>åŠ¨å›¾ç¤ºæ„å¦‚ä¸‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200413222352.webp" alt></p><p>å¯ä»¥åœ¨ä¸‹é¢çš„ä¸¤ä¸ªç½‘ç«™åœ¨çº¿ä½“éªŒè´å¡å°”æ›²çº¿ï¼š</p><p><a href="https://aaaaaaaty.github.io/bezierMaker.js/playground/playground.html" target="_blank" rel="noopener">https://aaaaaaaty.github.io/bezierMaker.js/playground/playground.html</a></p><p><a href="https://bezier.method.ac/" target="_blank" rel="noopener">https://bezier.method.ac/</a></p><h1 id="è®¡ç®—æ§åˆ¶ç‚¹åæ ‡"><a href="#è®¡ç®—æ§åˆ¶ç‚¹åæ ‡" class="headerlink" title="è®¡ç®—æ§åˆ¶ç‚¹åæ ‡"></a>è®¡ç®—æ§åˆ¶ç‚¹åæ ‡</h1><p>åœ¨ç»˜åˆ¶æŠ˜çº¿å›¾æ—¶ï¼Œæˆ‘ä»¬è·å–çš„æ•°æ®å¯ä»¥å½“åšè´å¡å°”æ›²çº¿çš„ç«¯ç‚¹ï¼ŒAndroidä¸ºæˆ‘ä»¬æä¾›äº†ç»˜åˆ¶äºŒé˜¶å’Œä¸‰é˜¶è´å¡å°”æ›²çº¿çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Path.quadTo(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, <span class="keyword">float</span> x2, <span class="keyword">float</span> y2)<span class="comment">//äºŒé˜¶è´å¡å°”æ›²çº¿ï¼šåˆ†åˆ«æ˜¯æ§åˆ¶ç‚¹çš„xã€yåæ ‡å’Œç»“æŸçš„çš„xã€yåæ ‡</span></span><br><span class="line">Path.cubicTo(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, <span class="keyword">float</span> x2, <span class="keyword">float</span> y2, <span class="keyword">float</span> x3, <span class="keyword">float</span> y3)<span class="comment">//ä¸‰é˜¶è´å¡å°”æ›²çº¿ï¼šåˆ†åˆ«æ˜¯æ§åˆ¶ç‚¹1ã€2çš„xã€yåæ ‡å’Œç»“æŸçš„çš„xã€yåæ ‡</span></span><br></pre></td></tr></table></figure><p>ä»¥<code>Path.cubicTo()</code>æ–¹æ³•ä¸ºä¾‹ï¼Œåœ¨ç»˜åˆ¶ä¸‰é˜¶è´å¡å°”æ›²çº¿æ—¶ï¼Œèµ·ç‚¹å’Œç»ˆç‚¹å·²çŸ¥ï¼Œå‰©ä¸‹å·¥ä½œå°±æ˜¯è®¡ç®—ä¸¤ä¸ªæ§åˆ¶ç‚¹çš„åæ ‡ã€‚</p><h2 id="æ–¹æ³•1"><a href="#æ–¹æ³•1" class="headerlink" title="æ–¹æ³•1"></a>æ–¹æ³•1</h2><p>æŒ‰ç…§è´å¡å°”æ›²çº¿çš„å®šä¹‰ï¼Œè®¡ç®—å„ä¸ªç‚¹å¯¹åº”æ§åˆ¶ç‚¹çš„åæ ‡ï¼Œå…·ä½“çš„è®¡ç®—åŸç†æˆ‘ä»¬å¯ä»¥å‚è€ƒ<a href="https://wenku.baidu.com/view/c790f8d46bec0975f565e211.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p><p>å‡è®¾èµ·ç‚¹ã€ç»ˆç‚¹åˆ†åˆ«ä¸º<code>startPoint</code>ï¼Œ<code>endPoint</code>ï¼Œèµ·ç‚¹å‰ä¸€ä¸ªç‚¹ä¸º<code>beforePointF</code>ï¼Œç»ˆç‚¹åä¸€ä¸ªç‚¹ä¸º<code>afterPoint</code>ï¼Œé‚£ä¹ˆç»ˆæ­¢ç‚¹1ã€2ï¼ˆ<code>controlPoint1</code>ã€<code>controlPoint2</code>ï¼‰çš„åæ ‡æ»¡è¶³ï¼ˆå…¶ä¸­a,bä¸ºä»»æ„æ­£æ•°ï¼Œæ¯”å¦‚1/6ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> controlPoint1X = startPoint.x + (endPoint.x - beforePointF.x) * a</span><br><span class="line"><span class="keyword">val</span> controlPoint1Y = startPoint.y + (endPoint.y - beforePointF.y) * a</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> controlPoint2X = endPoint.x - (afterPoint.x - startPoint.x) * b</span><br><span class="line"><span class="keyword">val</span> controlPoint2Y = endPoint.y - (afterPoint.y - startPoint.y) * b</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦å¤„ç†ç‰¹æ®Šæƒ…å†µï¼šç¬¬ä¸€ä¸ªç‚¹P~0~çš„å‰ä¸€ä¸ªä»ç„¶ä¸ºP~0~ï¼Œæœ€åä¸€ä¸ªç‚¹P~n~çš„åä¸€ä¸ªç‚¹ä»ä¸ºP~n~</p></blockquote><p>ä½†è¿™ç§æƒ…å†µç»˜åˆ¶å‡ºæ¥çš„è´å¡å°”æ›²çº¿å¦‚ä¸‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20200413220840.jpg" alt></p><p>å¯ä»¥çœ‹åˆ°é™¤äº†P~0~å’ŒP~n~å¤–ï¼Œå…¶ä»–ç‚¹çš„æ›²çº¿åæ ‡å’Œå¯¹åº”çš„ç‚¹åæ ‡ä¸ä¸€è‡´ã€‚</p><h2 id="æ–¹æ³•2"><a href="#æ–¹æ³•2" class="headerlink" title="æ–¹æ³•2"></a>æ–¹æ³•2</h2><p>ä¸ºäº†è§£å†³æ–¹æ³•1å­˜åœ¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬äººä¸ºçš„åœ¨ä¸¤ä¸ªç‚¹ä¹‹é—´åŠ å…¥ä¸¤ä¸ªæ§åˆ¶ç‚¹ï¼Œè¿™æ ·åœ¨<code>startPoint</code>ï¼Œ<code>endPoint</code>ä¹‹é—´çš„è´å¡å°”æ›²çº¿é¦–å°¾ç‚¹çš„åæ ‡å¿…å®šè½åœ¨èµ·ç‚¹å’Œç»ˆç‚¹ä¸Šï¼ˆæ€è·¯æ¥è‡ª<a href="https://blog.csdn.net/laizuling/article/details/51162011" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œä¸¤ä¸ªæ§åˆ¶ç‚¹çš„åæ ‡ä¸ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> controlPoint1X = (startPoint.x + endPoint.x) / <span class="number">2</span></span><br><span class="line"><span class="keyword">val</span> controlPoint1Y = startPoint.y</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> controlPoint2X = (startPoint.x + endPoint.x) / <span class="number">2</span></span><br><span class="line"><span class="keyword">val</span> controlPoint2Y = endPoint.y</span><br></pre></td></tr></table></figure><p>è¿™æ ·ç»˜åˆ¶å‡ºæ¥çš„æ›²çº¿æ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚</p><p>æ‰€ä»¥ï¼Œæœ€ç»ˆè´å¡å°”æ›²çº¿pathè®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bezierPath = Path()</span><br><span class="line">bezierPath.moveTo(pointList.first().x, -pointList.first().y)</span><br><span class="line">pointList.forEachIndexed &#123; index, startPoint -&gt;</span><br><span class="line">    <span class="keyword">when</span> (index) &#123;</span><br><span class="line">        pointList.lastIndex -&gt; &#123;</span><br><span class="line">            <span class="comment">//åœ¨ç»˜åˆ¶P(n-1) ~ P(n)ç‚¹çš„è´å¡å°”æ›²çº¿æ—¶ï¼Œå·²ç»ç»˜åˆ¶åˆ°äº†P(n)ç‚¹ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ç”¨å†ç»˜åˆ¶</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            <span class="keyword">val</span> endPoint = pointList[index + <span class="number">1</span>]</span><br><span class="line">            bezierPath.cubicTo(</span><br><span class="line">                (startPoint.x + endPoint.x) / <span class="number">2</span>,</span><br><span class="line">                -startPoint.y, <span class="comment">//ä¸ºäº†è§£å†³viewåæ ‡åŸç‚¹åœ¨å·¦ä¸Šè§’è€Œåšçš„ç‰¹æ®Šå¤„ç†ï¼Œä¸‹åŒ</span></span><br><span class="line">                (startPoint.x + endPoint.x) / <span class="number">2</span>,</span><br><span class="line">                -endPoint.y,</span><br><span class="line">                endPoint.x,</span><br><span class="line">                -endPoint.y</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç»™Pathæ·»åŠ æ¸å˜èƒŒæ™¯"><a href="#ç»™Pathæ·»åŠ æ¸å˜èƒŒæ™¯" class="headerlink" title="ç»™Pathæ·»åŠ æ¸å˜èƒŒæ™¯"></a>ç»™Pathæ·»åŠ æ¸å˜èƒŒæ™¯</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Paint.setShader(Shader shader)</code>æ–¹æ³•ï¼Œåœ¨ç»˜åˆ¶Pathçš„æ—¶å€™ç»˜åˆ¶æ¸å˜èƒŒæ™¯ã€‚</p><p>æ¸å˜èƒŒæ™¯ä½¿ç”¨Shaderå®ç°ã€‚</p><p>ä¸ºäº†ç¡®ä¿ç»˜åˆ¶æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦åœ¨Pathè®¡ç®—å®Œæˆåï¼Œå°†å…¶é—­åˆï¼Œä»¥ç¡®ä¿ç»˜åˆ¶çš„èƒŒæ™¯åœ¨æˆ‘ä»¬éœ€è¦çš„èŒƒå›´å†…ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> shadowPaint = Paint(Paint.ANTI_ALIAS_FLAG)</span><br><span class="line">shadowPaint.style = Paint.Style.FILL</span><br><span class="line"><span class="keyword">val</span> shader =</span><br><span class="line">    LinearGradient(<span class="number">0F</span>, <span class="number">0F</span>, <span class="number">0F</span>, <span class="number">500F</span>, Color.GREEN, Color.TRANSPARENT, Shader.TileMode.CLAMP)</span><br><span class="line"></span><br><span class="line">shadowPaint.shader = shader</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> shadowPath = Path(path)</span><br><span class="line">shadowPath.lineTo(endPoint.x, <span class="number">800F</span>)</span><br><span class="line">shadowPath.lineTo(startPoint.x, <span class="number">800F</span>)</span><br><span class="line">shadowPath.lineTo(startPoint.x, startPoint.y)</span><br><span class="line">shadowPath.close()</span><br><span class="line">canvas.drawPath(shadowPath, shadowPaint)</span><br></pre></td></tr></table></figure><h1 id="ç»™Pathæ·»åŠ åŠ¨ç”»"><a href="#ç»™Pathæ·»åŠ åŠ¨ç”»" class="headerlink" title="ç»™Pathæ·»åŠ åŠ¨ç”»"></a>ç»™Pathæ·»åŠ åŠ¨ç”»</h1><p>ä¸ºäº†è®©Pathçœ‹èµ·æ¥æ˜¯ä»èµ·ç‚¹æ…¢æ…¢ç»˜åˆ¶åˆ°ç»ˆç‚¹å»çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè®¡ç®—pathçš„æ€»é•¿åº¦ï¼Œç„¶åç»“åˆ<code>ValueAnimator</code>å®æ—¶è·å¾—å¯¹åº”é•¿åº¦çš„pathå¹¶ç»˜åˆ¶ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mValueAnimator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>)</span><br><span class="line">mValueAnimator.duration = <span class="number">10000</span></span><br><span class="line">mValueAnimator.repeatCount = ValueAnimator.INFINITE</span><br><span class="line">mValueAnimator.interpolator = AccelerateDecelerateInterpolator()</span><br><span class="line">mValueAnimator.addUpdateListener &#123; animation -&gt; <span class="comment">//è·å–ä»0-1çš„å˜åŒ–å€¼</span></span><br><span class="line">    progress = animation.animatedValue <span class="keyword">as</span> <span class="built_in">Float</span></span><br><span class="line">    <span class="comment">//ä¸æ–­åˆ·æ–°ç»˜å›¾ï¼Œå®ç°è·¯å¾„ç»˜åˆ¶</span></span><br><span class="line">    invalidate()</span><br><span class="line">&#125;</span><br><span class="line">mValueAnimator.start()</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>onDraw()</code>æ–¹æ³•ä¸­ç»˜åˆ¶å¯¹åº”çš„pathï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mPathMeasure: PathMeasure = PathMeasure(bezierPath, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">val</span> totalPathLength = mPathMeasure.length <span class="comment">//è·å–pathæ€»é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‰ç…§è¿›åº¦ç»˜åˆ¶è´å¡å°”æ›²çº¿</span></span><br><span class="line"><span class="keyword">val</span> stopD = progress * totalPathLength</span><br><span class="line">mPathMeasure.getSegment(<span class="number">0F</span>, stopD, dstPath, <span class="literal">true</span>) <span class="comment">//æŒ‰ç…§é•¿åº¦æ¯”ä¾‹æˆªå–å¯¹åº”çš„pathå¹¶èµ‹å€¼ç»™dstPath</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//bezier anim</span></span><br><span class="line">canvas.drawPath(dstPath, bezierPaint) <span class="comment">//ç»˜åˆ¶å¯¹åº”çš„path</span></span><br></pre></td></tr></table></figure><p><img src="https://jixiaoyong.github.io/images/20200413222302.jpg" alt></p><h1 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h1><ul><li><p>ä½¿ç”¨canvasç»˜åˆ¶åæ ‡æ—¶ï¼Œéœ€è¦æ³¨æ„androidçš„åæ ‡åŸç‚¹ä½äºå±å¹•å·¦ä¸Šè§’ã€‚æ‰€ä»¥åœ¨ç»˜åˆ¶æ›²çº¿å›¾æ—¶å¯ä»¥å…ˆå°†åæ ‡åŸç‚¹å‘ä¸‹å¹³ç§»ä¸€æ®µè·ç¦»ï¼Œå†ç»˜åˆ¶å¯¹åº”åæ ‡ï¼ˆå¯ä»¥ç»˜åˆ¶å®é™…çš„yåæ ‡è´Ÿå€¼ï¼‰</p></li><li><p>åœ¨æ‹¼æ¥è´å¡å°”æ›²çº¿çš„pathæ—¶å€™æ³¨æ„ï¼Œ<code>path.moveTo()</code>æ–¹æ³•ä¼šå°†pathåˆ‡æ–­</p></li></ul><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://wenku.baidu.com/view/c790f8d46bec0975f565e211.html" target="_blank" rel="noopener">https://wenku.baidu.com/view/c790f8d46bec0975f565e211.html</a><br><a href="https://blog.csdn.net/laizuling/article/details/51162011" target="_blank" rel="noopener">https://blog.csdn.net/laizuling/article/details/51162011</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android paintç»˜åˆ¶text</title>
      <link href="/blog/posts/e5860bb5/"/>
      <url>/blog/posts/e5860bb5/</url>
      
        <content type="html"><![CDATA[<p>Androidä¸­ç»˜åˆ¶æ–‡å­—çš„æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Draw the text, with origin at (x,y), using the specified paint. The origin is interpreted</span></span><br><span class="line"><span class="comment"> * based on the Align setting in the paint.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text The text to be drawn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x The x-coordinate of the origin of the text being drawn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y The y-coordinate of the baseline of the text being drawn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paint The paint used for the text (e.g. color, size, style)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawText</span><span class="params">(@NonNull String text, <span class="keyword">float</span> x, <span class="keyword">float</span> y, @NonNull Paint paint)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.drawText(text, x, y, paint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­<code>y</code>æ˜¯<strong>æ–‡å­—baselineçš„yåæ ‡</strong>ã€‚</p><p>ä¸‹å›¾è¡¨ç¤º<code>Paint.FontMetrics</code>ä¸­å­˜å‚¨çš„æ–‡å­—çš„å„ç§ä¿¡æ¯ï¼ˆæ¥æºï¼š<a href="https://www.jianshu.com/p/c1575636741e" target="_blank" rel="noopener">ç®€ä¹¦</a>ï¼‰ï¼š<br><img src="https://jixiaoyong.github.io/images/20200407220410.png" alt></p><p>æˆ‘ä»¬æ²¡æ³•ç›´æ¥è·å–åˆ°<code>baselineçš„åæ ‡</code>ï¼Œæ‰€ä»¥åªèƒ½ä»å¦å¤–ä¸€ä¸ªè§’åº¦è€ƒè™‘ï¼š<br>å› ä¸ºåœ¨ç»˜åˆ¶æ–‡å­—æ—¶ï¼Œæ–‡å­—çš„ä¸Šä¸‹ä¸­å¿ƒï¼ˆå³ä¸Šå›¾ä¸­çš„<code>center</code>ï¼‰æ˜¯ç¡®å®šçš„ï¼Œæˆ‘ä»¬åªè¦è®¡ç®—å‡º<code>center</code>åˆ°<code>baseline</code>ä¹‹é—´çš„åç§»é‡ï¼Œå°±å¯ä»¥è®¡ç®—å‡º<code>baselineçš„yåæ ‡</code>ã€‚</p><p>åˆæ ¹æ®è¿™ä¸ª<a href="http://www.imooc.com/article/277490?block_id=tuijian_wz" target="_blank" rel="noopener">æ–‡ç« </a>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åŸºçº¿åˆ°ä¸­çº¿çš„è·ç¦» = (descent + ascent) / 2 - descent = (ascent - descent) / 2</span><br></pre></td></tr></table></figure></p><blockquote><p><code>(descent + ascent) / 2</code>æ˜¯ä¸­çº¿centerçš„å€¼ï¼Œè€Œæ ¹æ®ä¸Šå›¾å¯çŸ¥<code>(descent + ascent) / 2 - descent</code>çš„å€¼å°±æ˜¯baselineåˆ°centerçš„è·ç¦»ã€‚</p></blockquote><p>æ‰€ä»¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">baselineçš„yåæ ‡ = æ–‡å­—çš„ä¸Šä¸‹é«˜åº¦ä¸­å¿ƒ + baselineçš„ç«–åæ ‡å’Œæ–‡å­—ä¸Šä¸‹å®é™…ä¸­å¿ƒçš„åç§»é‡</span><br><span class="line">                = center.y + åŸºçº¿åˆ°ä¸­çº¿çš„è·ç¦»</span><br><span class="line">                = center.y + (ascent - descent) / 2</span><br></pre></td></tr></table></figure></p><blockquote><p>è¿™ä¸ª<code>center.y</code>æ ¹æ®åœºæ™¯ä¸åŒå¯ä»¥æ˜¯ä¸€è¡Œçš„è¡Œä¸­å¿ƒï¼ˆæ–‡å­—åœ¨ä¸€è¡Œå±…ä¸­æ˜¾ç¤ºï¼‰ï¼Œæˆ–è€…æ§ä»¶çš„ä¸Šä¸‹ä¸­å¿ƒï¼ˆæ–‡å­—åœ¨æ§ä»¶ä¸Šä¸‹å±…ä¸­ï¼‰</p></blockquote><p>å¾—å‡ºç»“è®ºï¼š</p><p>ç”±äºandroidç»˜åˆ¶æ–‡å­—æ—¶ï¼Œ<strong>å¹¶ä¸æ˜¯ä»æ–‡å­—é«˜åº¦çš„ä¸­é—´å¼€å§‹ç»˜åˆ¶ï¼Œè€Œæ˜¯ä»baselineå¼€å§‹ç»˜åˆ¶</strong>ã€‚æ‰€ä»¥åœ¨ç»˜åˆ¶æ–‡å­—æ—¶ï¼Œä¸ºäº†ä½¿æ–‡å­—é«˜åº¦å±…ä¸­ï¼ˆåœ¨æ‰€æŒ‡å®šçš„ç©ºé—´å†…å±…ä¸­ï¼Œæ¯”å¦‚æŸä¸€è¡Œï¼Œå°±åœ¨è¯¥è¡Œé™å®šçš„é«˜åº¦å†…å±…ä¸­æ˜¾ç¤ºï¼›æŸä¸€æ§ä»¶ï¼Œåˆ™æ•´ä¸ªæ§ä»¶çš„ä¸Šä¸‹ä¸­é—´æ˜¾ç¤ºï¼‰ï¼Œéœ€è¦åœ¨è®¡ç®—å‡ºæ¥çš„<strong>æ–‡å­—ä¸Šä¸‹ä¸­å¿ƒçš„yåæ ‡åŸºç¡€ä¸ŠåŠ ä¸Šbaselineåˆ°æ–‡å­—ä¸­çº¿çš„åç§»é‡</strong>ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç±»æ¯”å¾—åˆ°ï¼š<code>baseline.y = center.y + (bottom.y - top.y) / 2 - bottom.y</code></p><blockquote><p>åŸºçº¿ï¼ˆbaeselineï¼‰ï¼Œå¡é¡¶ï¼ˆascenterï¼‰,å¡åº•ï¼ˆdescenterï¼‰</p><p>ä¸Šå¡åº¦ï¼ˆascentï¼‰ï¼Œä¸‹å¡åº¦ï¼ˆdescentï¼‰</p><p>è¡Œé—´è·ï¼ˆleadingï¼‰ï¼šå¡åº•åˆ°ä¸‹ä¸€è¡Œå¡é¡¶çš„è·ç¦»</p><p>å­—ä½“çš„é«˜åº¦ï¼ä¸Šå¡åº¦ï¼‹ä¸‹å¡åº¦ï¼‹è¡Œé—´è·</p><p><a href="https://blog.csdn.net/hanyongbai/article/details/84418369" target="_blank" rel="noopener">https://blog.csdn.net/hanyongbai/article/details/84418369</a></p></blockquote><p>å‚è€ƒæ–‡ç« ï¼š<br><a href="https://www.jianshu.com/p/c1575636741e" target="_blank" rel="noopener">https://www.jianshu.com/p/c1575636741e</a><br><a href="https://blog.csdn.net/hanyongbai/article/details/84418369" target="_blank" rel="noopener">https://blog.csdn.net/hanyongbai/article/details/84418369</a><br><a href="http://www.imooc.com/article/277490?block_id=tuijian_wz" target="_blank" rel="noopener">http://www.imooc.com/article/277490?block_id=tuijian_wz</a><br><a href="https://blog.csdn.net/xuxingxing002/article/details/50971606" target="_blank" rel="noopener">https://blog.csdn.net/xuxingxing002/article/details/50971606</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LeetCodeç¬”è®°--é‡å»ºäºŒå‰æ ‘</title>
      <link href="/blog/posts/a64dc0bc/"/>
      <url>/blog/posts/a64dc0bc/</url>
      
        <content type="html"><![CDATA[<p>äºŒå‰æ ‘çš„éå†æ ¹æ®æ ¹èŠ‚ç‚¹ä¸å·¦å³å­èŠ‚ç‚¹çš„éå†é¡ºåºçš„ä¸åŒåˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li><p>å‰åºéå†</p><p>æ ¹å·¦å³ï¼šå…ˆéå†æ ¹èŠ‚ç‚¹ï¼Œå†å·¦å­æ ‘ï¼Œå†å³å­æ ‘ï¼ˆå…ˆä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œè®°å½•å·¦èŠ‚ç‚¹ç›´åˆ°æ²¡æœ‰ï¼‰</p><p>ç¬¬ä¸€ä¸ªä¸ºæ ¹èŠ‚ç‚¹</p></li><li><p>ä¸­åºéå†</p><p>å·¦æ ¹å³ï¼šå…ˆå·¦å­æ ‘ï¼Œå†æ ¹å­æ ‘ï¼Œå†å³å­æ ‘ï¼ˆä»æ ‘çš„æœ€å·¦è¾¹çš„èŠ‚ç‚¹å¼€å§‹éå†ï¼‰</p></li><li><p>ååºéå†</p><p>å·¦å³æ ¹ï¼šå…ˆå·¦å­æ ‘ï¼Œåå³å­æ ‘ï¼Œå†æ ¹èŠ‚ç‚¹</p><p>æœ€åä¸€ä¸ªä¸ºæ ¹èŠ‚ç‚¹</p></li></ul><p>åœ¨éå†çš„æ—¶å€™ï¼Œå½“çˆ¶èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹æ—¶ï¼Œä¾ç„¶è¦éµå¾ªä»¥ä¸Šä¸‰ç§éå†çš„å…ˆåé¡ºåºï¼ˆæ²¡æœ‰è¯¥å­èŠ‚ç‚¹åˆ™ä¸å†™å†…å®¹ï¼‰ï¼Œä»¥ä¿è¯æŸä¸€ä¾§çš„å­æ ‘ï¼ˆâ€œå·¦è¾¹çš„å­æ ‘â€æˆ–â€œå³è¾¹çš„å­æ ‘â€ï¼‰æ‰€æœ‰èŠ‚ç‚¹éƒ½è¢«å®Œå…¨éå†ï¼Œä¹‹åæ‰å¯ä»¥æ ¹æ®éå†çš„è§„åˆ™åˆ‡æ¢åˆ°ä¸‹ä¸€å­æ ‘ã€‚</p><p>å¦‚å¦‚ä¸‹å­æ ‘ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      G</span><br><span class="line">   /     \</span><br><span class="line">  D       M</span><br><span class="line"> / \     / \</span><br><span class="line">A   F   H   Z</span><br><span class="line">   /</span><br><span class="line">  E</span><br></pre></td></tr></table></figure><p>å‰åºéå†ï¼šGDAFEMHZ</p><p>ä¸­åºéå†ï¼šADEFGHMZ</p><p>åç»­éå†ï¼šAEFDHZMG</p><h1 id="å¸¸è§åº”ç”¨"><a href="#å¸¸è§åº”ç”¨" class="headerlink" title="å¸¸è§åº”ç”¨"></a>å¸¸è§åº”ç”¨</h1><p>ä¸€èˆ¬éƒ½æ˜¯ç»™å®šä¸­åºæ’åºï¼Œå†åŠ ä¸Šä¸€ä¸ªå‰åºæ’åºã€åç»­æ’åºæ¥é€†å‘ç”ŸæˆäºŒå‰æ ‘ã€‚</p><p>æ ¹æ®ä¹‹å‰çš„çŸ¥è¯†ï¼Œæ­¤ç±»é¢˜çš„è§£ç­”æ€è·¯ä¸€èˆ¬ä¸ºï¼š</p><p>å…ˆæ ¹æ®å‰åºæ’åºã€åç»­æ’åºçš„ç‰¹ç‚¹ï¼Œæ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œä¹‹åå†æ ¹æ®æ‰¾åˆ°çš„æ ¹èŠ‚ç‚¹å°†ä¸­åºæ’åºåˆ†ä¸ºå·¦ã€å³å­æ ‘ä¸¤ä¸ªéƒ¨åˆ†ã€‚è¿™æ ·å¾ªç¯ç›´åˆ°æ•´ä¸ªæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¢«éå†å®Œæ¯•ï¼Œå®Œæ•´çš„äºŒå‰æ ‘ä¹Ÿä¼šè¢«å»ºç«‹èµ·æ¥ã€‚</p><p>æˆ‘ä»¬ä»¥ä¸‹é¢è¿™ä¸ªäºŒå‰æ ‘ä¸ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1</span><br><span class="line"> / \</span><br><span class="line">2   3</span><br><span class="line">   / \</span><br><span class="line">  4   5</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> preorder = intArrayOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)<span class="comment">//å‰åºéå†</span></span><br><span class="line">    <span class="keyword">val</span> inorder  = intArrayOf(<span class="number">2</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>)<span class="comment">//ä¸­åºéå†</span></span><br><span class="line">    <span class="keyword">val</span> tree = buildTree(preorder, inorder)</span><br><span class="line">    print(tree)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">buildTree</span><span class="params">(preorder: <span class="type">IntArray</span>, inorder: <span class="type">IntArray</span>)</span></span>: TreeNode? &#123;</span><br><span class="line">    <span class="keyword">var</span> tree : TreeNode? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (preorder.isNotEmpty()) &#123;</span><br><span class="line">        <span class="keyword">val</span> root = preorder[<span class="number">0</span>]<span class="comment">//è·å–æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">val</span> indexOfRoot = inorder.indexOf(root)<span class="comment">//è·å–ä¸­åºæ’åºä¸­æ ¹èŠ‚ç‚¹çš„åæ ‡</span></span><br><span class="line">        tree = TreeNode(root)</span><br><span class="line">        <span class="comment">//æ ¹æ®æ ¹èŠ‚ç‚¹åæ ‡ï¼Œå°†äºŒå‰æ ‘åˆ†ä¸ºå·¦ã€å³ä¸¤ä¸ªå­æ ‘</span></span><br><span class="line">        <span class="keyword">val</span> leftTree = inorder.copyOfRange(<span class="number">0</span>, indexOfRoot)</span><br><span class="line">        <span class="keyword">val</span> rightTree = inorder.copyOfRange(indexOfRoot + <span class="number">1</span>, inorder.size)</span><br><span class="line">        <span class="comment">//å°†å‰åºæ’åºä¹Ÿåˆ†ä¸ºå·¦å³ä¸¤ä¸ªå­æ ‘çš„å‰åºæ’åº</span></span><br><span class="line">        <span class="keyword">val</span> leftPreOrder = preorder.copyOfRange(<span class="number">1</span>, preorder.size).filter &#123; leftTree.contains(it) &#125;.toIntArray()</span><br><span class="line">        <span class="keyword">val</span> rightPreOrder = preorder.copyOfRange(<span class="number">1</span>, preorder.size).filter &#123; rightTree.contains(it) &#125;.toIntArray()</span><br><span class="line">        <span class="comment">//å†æ¬¡åˆ†åˆ«å¾ªç¯åˆ†æå·¦å³ä¸¤ä¸ªå­æ ‘çš„ç»“æ„</span></span><br><span class="line">        tree.left = buildTree(leftPreOrder, leftTree)</span><br><span class="line">        tree.right = buildTree(rightPreOrder, rightTree)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span></span>(<span class="keyword">var</span> `<span class="keyword">val</span>`: <span class="built_in">Int</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> left: TreeNode? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> right: TreeNode? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.jianshu.com/p/9e8922486154" target="_blank" rel="noopener">https://www.jianshu.com/p/9e8922486154</a></p><p><a href="https://charlesliuyx.github.io/2018/10/22/[ç›´è§‚ç®—æ³•]æ ‘çš„åŸºæœ¬æ“ä½œ/" target="_blank" rel="noopener">ã€ç›´è§‚ç®—æ³•ã€‘äºŒå‰æ ‘éå†ç®—æ³•æ€»ç»“</a></p><p><a href="https://jingyan.baidu.com/album/cdddd41cb8d79753ca00e144.html?picindex=1" target="_blank" rel="noopener">çŸ¥é“ä¸­åºå’Œååºéå†ï¼Œç”»äºŒå‰æ ‘å’Œå†™å‡ºå‰åºéå† </a></p><p><a href="https://leetcode-cn.com/problems/zhong-jian-er-cha-shu-lcof/" target="_blank" rel="noopener">leetcode-é‡å»ºäºŒå‰æ ‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ä¸ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç¬”è®°ä¹‹YYYYæ ¼å¼åŒ–æ—¥æœŸ</title>
      <link href="/blog/posts/87a89a43/"/>
      <url>/blog/posts/87a89a43/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘çœ‹åˆ°ä¸€ä¸ª<a href="https://v2ex.com/t/633650?p=1" target="_blank" rel="noopener">å¸–å­</a>ï¼Œè¡¨ç¤ºæœ‰äººä»¥<code>&quot;YYYY-MM-dd&quot;</code>æ ¼å¼åŒ–æ—¥æœŸæ—¶ï¼Œåœ¨<code>2019-12-30</code>æ—¶å‡ºç°<code>2020-12-30</code>çš„BUGã€‚</p><p>æœ¬æ–‡æ¥ç®€å•åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªæƒ…å†µã€‚</p><p>æ ¹æ®<a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#year" target="_blank" rel="noopener">JDKæ–‡æ¡£å…³äºæ—¥æœŸçš„å®šä¹‰</a>ï¼Œ<code>y</code>è¡¨ç¤ºçš„æ˜¯æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„å¹´ä»½ï¼Œè€Œ<code>Y</code>è¡¨ç¤ºçš„æ˜¯<code>Week year</code>ã€‚</p><p>å…ˆäº†è§£å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š</p><h1 id="Week-year"><a href="#Week-year" class="headerlink" title="Week year"></a>Week year</h1><p><code>Week year</code>è¡¨ç¤ºçš„æ˜¯<strong>è¿™ä¸ªå‘¨æ‰€å±çš„å¹´ä»½</strong>ã€‚</p><blockquote><p>A <em>week year</em> is in sync with a <code>WEEK_OF_YEAR</code> cycle. All weeks between the first and last weeks (inclusive) have the same <em>week year</em> value. Therefore, the first and last days of a week year may have different calendar year values.</p><p>æ¥æºï¼š<a href="https://docs.oracle.com/javase/7/docs/api/java/util/GregorianCalendar.html#week_year" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/api/java/util/GregorianCalendar.html#week_year</a></p></blockquote><h1 id="WEAK-OF-YEAR"><a href="#WEAK-OF-YEAR" class="headerlink" title="WEAK_OF_YEAR"></a>WEAK_OF_YEAR</h1><p>æŒ‡çš„æ˜¯è¿™ä¸€å¹´æ‰€æœ‰çš„å‘¨ï¼Œä»ç¬¬01å‘¨å¼€å§‹åˆ°è¯¥å¹´æœ€åä¸€å‘¨ã€‚</p><p>è¦æ³¨æ„è¿™ä¸ªå‘¨ä¸ä¸€å®šæ˜¯è‡ªç„¶å‘¨ï¼Œæ‰€åŒ…å«çš„æ—¥æœŸä¹Ÿä¸ä¸€å®šå…¨éƒ¨éƒ½æ˜¯å½“å¹´çš„æ—¥æœŸã€‚</p><blockquote><p>Values calculated for the <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Calendar.html#WEEK_OF_YEAR" target="_blank" rel="noopener"><code>WEEK_OF_YEAR</code></a> field range from 1 to 53. The first week of a calendar year is the earliest seven day period starting on <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Calendar.html#getFirstDayOfWeek(" target="_blank" rel="noopener"><code>getFirstDayOfWeek()</code></a>) that contains at least <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Calendar.html#getMinimalDaysInFirstWeek(" target="_blank" rel="noopener"><code>getMinimalDaysInFirstWeek()</code></a>) days from that year.</p></blockquote><h1 id="ç¬¬01å‘¨"><a href="#ç¬¬01å‘¨" class="headerlink" title="ç¬¬01å‘¨"></a>ç¬¬01å‘¨</h1><p>æ ¹æ®è¿™ä»½<a href="https://docs.oracle.com/javase/7/docs/api/java/util/GregorianCalendar.html#week_year" target="_blank" rel="noopener">JDKæ–‡æ¡£</a>ï¼Œå½“ <code>getFirstDayOfWeek()</code> is <code>MONDAY</code>ï¼ˆ2ï¼‰ and <code>getMinimalDaysInFirstWeek()</code> is 4æ—¶ï¼ŒJAVAåˆ¤æ–­å‘¨æ—¥æœŸçš„æ ‡å‡†ä¸<a href="https://en.wikipedia.org/wiki/ISO_8601" target="_blank" rel="noopener">ISO_8601</a>å…¼å®¹ï¼š</p><blockquote><p>ç¬¬01å‘¨æœ‰å‡ ä¸ªç›¸äº’ç­‰æ•ˆä¸”å…¼å®¹çš„æè¿°ï¼š</p><p>ä¸€å¹´ä¸­ç¬¬ä¸€ä¸ªæ˜ŸæœŸå››çš„æ˜ŸæœŸï¼ˆæ­£å¼çš„ISOå®šä¹‰ï¼‰ï¼Œ</p><p>1æœˆ4æ—¥è¿™ä¸€å‘¨ï¼Œ</p><p>èµ·å§‹å¹´ä»½ä¸­å¤§éƒ¨åˆ†ï¼ˆå››å¤©æˆ–ä»¥ä¸Šï¼‰çš„ç¬¬ä¸€å‘¨ï¼Œä»¥åŠ</p><p>ä»12æœˆ29æ—¥è‡³1æœˆ4æ—¥çš„æ˜ŸæœŸä¸€å¼€å§‹çš„ä¸€å‘¨ã€‚</p><p>æ¥æºï¼š<a href="https://en.wikipedia.org/wiki/ISO_8601" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/ISO_8601</a></p></blockquote><p>æŒ‰ç…§JAVAæ–‡æ¡£ä¸­çš„å®šä¹‰ï¼Œæ¯å¹´æœ€å¼€å§‹çš„å‡ å¤©å’Œæœ€åçš„å‡ å¤©çš„<code>Week year</code>ä¸ä¸€å®šæ˜¯å½“å¹´çš„å¹´ä»½å€¼ï¼Œè€Œæ˜¯å—åˆ°æ¯å¹´çš„<em>ç¬¬01å‘¨/æœ€åä¸€å‘¨</em>çš„å½±å“ã€‚</p><p>JAVAä¸­åˆ¤æ–­å‘¨ä¸»è¦å—åˆ°<code>Calendar</code>å¯¹è±¡çš„<code>getFirstDayOfWeek()</code>å’Œ<code>getMinimalDaysInFirstWeek()</code>è¿™ä¸¤ä¸ªæœ¬åœ°å€¼çš„å½±å“ã€‚</p><p>å…¶ä¸­ï¼š</p><ul><li><code>getFirstDayOfWeek()</code>æŒ‡å®šä¸€å‘¨çš„ç¬¬ä¸€å¤©ï¼Œæ¯”å¦‚, ç¾å›½ä¸€å‘¨ä»<code>SUNDAY</code> å¼€å§‹,æ³•å›½åˆ™æ˜¯<code>MONDAY</code> ã€‚</li><li><code>getMinimalDaysInFirstWeek()</code> ä¸€å¹´ç¬¬ä¸€å‘¨æ‰€éœ€æœ€å°çš„å¤©æ•°ã€‚æ¯”å¦‚1è¡¨ç¤ºåªè¦åŒ…å«ç¬¬ä¸€å¤©å°±ç®—è¯¥å¹´çš„ç¬¬ä¸€å‘¨ï¼Œè€Œ7è¡¨ç¤ºåªæœ‰å®Œæ•´çš„ä¸€å‘¨éƒ½åœ¨è¯¥å¹´æ‰ç®—è¯¥å¹´çš„ç¬¬ä¸€å‘¨ã€‚</li></ul><p><strong>æ³¨æ„</strong>ï¼šçœŸæ­£å½±å“æˆ‘ä»¬æ ¼å¼åŒ–æ—¥æœŸç»“æœçš„æ˜¯<code>SimpleDateFormat</code>ä¸­çš„<code>calendar</code>å¯¹è±¡å¯¹åº”çš„å€¼ã€‚</p><p>è€Œé€šè¿‡æ‰“å°è¿™ä¸ª<code>simpleDateFormat.calendar</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JDK1.7</span></span><br><span class="line">minimalDaysInFirstWeek:<span class="number">1</span></span><br><span class="line">firstDayOfWeek:<span class="number">1</span> <span class="comment">//SUNDAY</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥å¾—å‡ºç»“è®ºï¼ŒJAVA<strong>é»˜è®¤åªè¦æ¬¡å¹´çš„1æœˆ1æ—¥åœ¨åœ¨è¿™ä¸ªè·¨å¹´å‘¨ï¼Œé‚£ä¹ˆæœ¬å‘¨æ‰€æœ‰æ—¥æœŸçš„<code>Week year</code>éƒ½æ˜¯æ¬¡å¹´çš„</strong>ï¼ˆ<code>JDK1.7</code>ï¼‰ã€‚</p><h1 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h1><p>æœ‰äº†ä»¥ä¸ŠçŸ¥è¯†ï¼Œæˆ‘ä»¬å†çœ‹çœ‹<code>2019-12-30</code>ä»¥<code>YYYY</code>æ ¼å¼åŒ–ä¸ºä»€ä¹ˆä¼šå‡ºç°é—®é¢˜ï¼š</p><p>å…ˆçœ‹ä¸€ä¸‹è¿™äº›æ—¥æœŸå¯¹åº”çš„æ˜ŸæœŸï¼š</p><table><thead><tr><th>å‘¨æ—¥</th><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th></tr></thead><tbody><tr><td>29</td><td>30</td><td>31</td><td><strong>1</strong></td><td>2</td><td>3</td><td>4</td></tr></tbody></table><p>é¦–å…ˆæ ¹æ®JDKé»˜è®¤çš„<code>ç¬¬01å‘¨</code>çš„å®šä¹‰ï¼Œ<code>2020-01-01</code>æ‰€åœ¨çš„å‘¨ä¸º<code>2020çš„ç¬¬ä¸€å‘¨</code>ï¼Œæ‰€ä»¥<code>2019-12-29åˆ°2020-01-04</code>éƒ½å±äºæ˜¯<code>2020å¹´çš„ç¬¬01å‘¨</code>ã€‚</p><p>å†æ ¹æ®<code>YYYY</code>è¡¨ç¤ºçš„æ˜¯<code>Week year</code>çš„ç»“è®ºï¼Œå¯ä»¥çŸ¥é“ï¼Œå½“ä½¿ç”¨<code>YYYY</code>æ ¼å¼åŒ–æ—¶ï¼Œ<code>2019-12-29åˆ°2020-01-04</code>éƒ½ä¼šå¾—åˆ°<code>2020</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> calendar = Calendar.getInstance()</span><br><span class="line"><span class="keyword">val</span> simpleDateFormat = SimpleDateFormat(<span class="string">"YYYY yyyy MM dd"</span>)</span><br><span class="line">calendar.<span class="keyword">set</span>(<span class="number">2019</span>, <span class="number">12</span>-<span class="number">1</span>, <span class="number">29</span>)</span><br><span class="line">println(simpleDateFormat.format(calendar.time))</span><br><span class="line"></span><br><span class="line"><span class="comment">//output</span></span><br><span class="line">DATE:<span class="number">2019</span> <span class="number">12</span> <span class="number">29</span></span><br><span class="line">minimalDaysInFirstWeek:<span class="number">1</span></span><br><span class="line">firstDayOfWeek:<span class="number">1</span></span><br><span class="line">YYYY yyyy MM dd</span><br><span class="line"><span class="number">2020</span> <span class="number">2019</span> <span class="number">12</span> <span class="number">29</span></span><br></pre></td></tr></table></figure><p>è€Œå¦‚æœæˆ‘ä»¬æŠŠç¬¬ä¸€å‘¨æœ€å°å¤©æ•°<code>minimalDaysInFirstWeek</code>æ”¹ä¸º<code>5</code>å¤©ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾è¿™ä¸€å‘¨å±äº<code>2020</code>å¹´çš„å¤©æ•°ï¼ˆä»å‘¨æ—¥åˆ°å‘¨ä¸€ï¼Œåªæœ‰1å·åˆ°4å·4å¤©ï¼‰ä¸å¤Ÿ5å¤©ï¼Œæ‰€ä»¥è¿™ä¸€å‘¨è¢«åˆ’å½’ä¸º<code>2019</code>å¹´çš„ç¬¬<code>53å‘¨</code>ï¼Œ<code>2019-12-29åˆ°2020-01-04</code>çš„<code>week year</code>éƒ½æ˜¯å±äº<code>2019</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> calendar = Calendar.getInstance()</span><br><span class="line"><span class="keyword">val</span> simpleDateFormat = SimpleDateFormat(<span class="string">"YYYY yyyy MM dd"</span>)</span><br><span class="line">calendar.<span class="keyword">set</span>(<span class="number">2019</span>, <span class="number">12</span>-<span class="number">1</span>, <span class="number">29</span>)</span><br><span class="line">simpleDateFormat.calendar.minimalDaysInFirstWeek = <span class="number">5</span></span><br><span class="line">println(simpleDateFormat.format(calendar.time))</span><br><span class="line"></span><br><span class="line"><span class="comment">//output</span></span><br><span class="line">DATE:<span class="number">2019</span> <span class="number">12</span> <span class="number">29</span></span><br><span class="line">minimalDaysInFirstWeek:<span class="number">5</span></span><br><span class="line">firstDayOfWeek:<span class="number">1</span></span><br><span class="line">YYYY yyyy MM dd</span><br><span class="line"><span class="number">2019</span> <span class="number">2019</span> <span class="number">12</span> <span class="number">29</span></span><br></pre></td></tr></table></figure><p>å†æ¯”å¦‚ä¸‹é¢è¿™ä¸ª<a href="https://blog.csdn.net/bewilderment/article/details/48391717" target="_blank" rel="noopener">ç¤ºä¾‹</a>ä¸­çš„<code>2010-12-26</code>ã€‚</p><p><img src="https://img-blog.csdn.net/20150912103324519?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt></p><p>æŒ‰ç…§<code>JDK1.7</code>é»˜è®¤ç®—æ³•ï¼Œä¸€å‘¨ä»å‘¨æ—¥ï¼ˆ<code>2010-12-26</code>ï¼‰å¼€å§‹ï¼Œå¹¶ä¸”å½“å¹´çš„1æœˆ1æ—¥ï¼ˆ<code>2011-01-01</code>ï¼‰æ‰€åœ¨å‘¨ä¸ºè¯¥å¹´ç¬¬ä¸€å‘¨ï¼Œæ‰€ä»¥<code>2010-12-26åˆ°2011-01-01</code>éƒ½è¢«åˆ’åˆ°äº†<code>2011</code>å¹´çš„ç¬¬ä¸€å‘¨ã€‚</p><p>ä½†å¦‚æœæŒ‰ç…§<a href="https://en.wikipedia.org/wiki/ISO_8601" target="_blank" rel="noopener">ISO_8601</a>çš„æ ‡å‡†ï¼Œä¸€å‘¨ä»å‘¨ä¸€å¼€å§‹ï¼Œå¹¶ä¸”èµ·å§‹å¹´ä»½åŒ…å«çš„å¤©æ•°è‡³å°‘è¦æœ‰<code>4</code>å¤©ï¼š</p><p>åˆ™å¾ˆæ˜æ˜¾<code>2010-12-26</code>å±äº<code>2010</code>å¹´çš„<code>51å‘¨</code>ï¼Œè€Œ<code>2010-12-27åˆ°2011-01-02</code>éƒ½å±äº<code>2010</code>å¹´çš„ç¬¬<code>52å‘¨</code>ï¼ˆå±äº2020å¹´çš„åªæœ‰2å¤©ï¼Œä¸æ»¡è¶³ç¬¬ä¸€å‘¨çš„æ¡ä»¶ï¼‰ã€‚</p><table><thead><tr><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th></tr></thead><tbody><tr><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td><td>26</td></tr><tr><td>27</td><td>28</td><td>29</td><td>30</td><td>31</td><td>1</td><td>2</td></tr></tbody></table><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç»“åˆä»¥ä¸Šç»“è®ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨JAVAä¸­ï¼ˆ<code>JDK1.7</code>ï¼‰ï¼š</p><ul><li><p><code>â€œYYYYâ€</code>è¡¨ç¤º<code>Week year</code></p></li><li><p>æ¯å¹´æœ€å¼€å§‹çš„å‡ å¤©å’Œæœ€åçš„å‡ å¤©çš„<code>Week year</code>ä¸ä¸€å®šæ˜¯å½“å¹´çš„å€¼ï¼Œè€Œæ˜¯å—åˆ°å½“å¹´çš„ç¬¬ä¸€å‘¨/æœ€åä¸€å‘¨çš„å½±å“ã€‚</p></li><li><p>JAVAå‘¨çš„åˆ¤æ–­ä¸<code>simpleDateFormat.calendar.minimalDaysInFirstWeek</code>å’Œ<code>simpleDateFormat.calendar.firstDayOfWeek</code>æœ‰å…³ã€‚</p><p>è€Œè¿™ä¸¤ä¸ªå€¼éƒ½å±äºæœ¬åœ°åŒ–å€¼ï¼Œ<strong>åœ¨å›½å†…å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€å¹´1æœˆ1æ—¥æ‰€åœ¨çš„å‘¨å°±æ˜¯å½“å¹´çš„ç¬¬ä¸€å‘¨ã€‚</strong></p></li><li><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹<code>minimalDaysInFirstWeek</code>å’Œ<code>firstDayOfWeek</code>æ¥æ›´æ”¹<code>YYYY</code>æ ¼å¼åŒ–çš„å€¼ã€‚</p></li></ul><h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><p>JDKä¸­æ—¥æœŸæ ¼å¼åŒ–çš„å‚æ•°åŠå«ä¹‰ï¼ˆæ¥è‡ª<a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#monthï¼‰ï¼š" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#monthï¼‰ï¼š</a></p><table><thead><tr><th>Letter</th><th>Date or Time Component</th><th>Presentation</th><th>Examples</th></tr></thead><tbody><tr><td><code>G</code></td><td>Era designator</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#text" target="_blank" rel="noopener">Text</a></td><td><code>AD</code></td></tr><tr><td><code>y</code></td><td>Year</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#year" target="_blank" rel="noopener">Year</a></td><td><code>1996</code>; <code>96</code></td></tr><tr><td><code>Y</code></td><td>Week year</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#year" target="_blank" rel="noopener">Year</a></td><td><code>2009</code>; <code>09</code></td></tr><tr><td><code>M</code></td><td>Month in year</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#month" target="_blank" rel="noopener">Month</a></td><td><code>July</code>; <code>Jul</code>; <code>07</code></td></tr><tr><td><code>w</code></td><td>Week in year</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>27</code></td></tr><tr><td><code>W</code></td><td>Week in month</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>2</code></td></tr><tr><td><code>D</code></td><td>Day in year</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>189</code></td></tr><tr><td><code>d</code></td><td>Day in month</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>10</code></td></tr><tr><td><code>F</code></td><td>Day of week in month</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>2</code></td></tr><tr><td><code>E</code></td><td>Day name in week</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#text" target="_blank" rel="noopener">Text</a></td><td><code>Tuesday</code>; <code>Tue</code></td></tr><tr><td><code>u</code></td><td>Day number of week (1 = Monday, â€¦, 7 = Sunday)</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>1</code></td></tr><tr><td><code>a</code></td><td>Am/pm marker</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#text" target="_blank" rel="noopener">Text</a></td><td><code>PM</code></td></tr><tr><td><code>H</code></td><td>Hour in day (0-23)</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>0</code></td></tr><tr><td><code>k</code></td><td>Hour in day (1-24)</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>24</code></td></tr><tr><td><code>K</code></td><td>Hour in am/pm (0-11)</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>0</code></td></tr><tr><td><code>h</code></td><td>Hour in am/pm (1-12)</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>12</code></td></tr><tr><td><code>m</code></td><td>Minute in hour</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>30</code></td></tr><tr><td><code>s</code></td><td>Second in minute</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>55</code></td></tr><tr><td><code>S</code></td><td>Millisecond</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#number" target="_blank" rel="noopener">Number</a></td><td><code>978</code></td></tr><tr><td><code>z</code></td><td>Time zone</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#timezone" target="_blank" rel="noopener">General time zone</a></td><td><code>Pacific Standard Time</code>; <code>PST</code>; <code>GMT-08:00</code></td></tr><tr><td><code>Z</code></td><td>Time zone</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#rfc822timezone" target="_blank" rel="noopener">RFC 822 time zone</a></td><td><code>-0800</code></td></tr><tr><td><code>X</code></td><td>Time zone</td><td><a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html#iso8601timezone" target="_blank" rel="noopener">ISO 8601 time zone</a></td><td><code>-08</code>; <code>-0800</code>; <code>-08:00</code></td></tr></tbody></table><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>æ„Ÿè°¢è¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘æ¨ç¿»äº†ä¸Šä¸€æ¬¡çš„ç»“è®ºï¼Œå‘ç°äº†çœŸæ­£çš„åŸå› ï¼š<a href="https://blog.csdn.net/bewilderment/article/details/48391717" target="_blank" rel="noopener">JAVAä¸­çš„SimpleDateFormat yyyyå’ŒYYYYçš„åŒºåˆ«</a></p><p><a href="https://docs.oracle.com/javase/7/docs/api/java/util/GregorianCalendar.html#week_year" target="_blank" rel="noopener">GregorianCalenda jdk1.7</a></p><p>åœ¨çº¿æ˜¾ç¤ºæœ¬å‘¨æ˜¯ä¸€å¹´ç¬¬å‡ å‘¨çš„ç½‘ç«™ï¼š<a href="https://www.epochconverter.com/weeknumbers" target="_blank" rel="noopener">Whatâ€™s the Current Week Number?</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Androidç¬”è®°ä¹‹è·¨è¿›ç¨‹é€šä¿¡</title>
      <link href="/blog/posts/7e97a976/"/>
      <url>/blog/posts/7e97a976/</url>
      
        <content type="html"><![CDATA[<p>Androidä¸­çš„è·¨è¿›ç¨‹é€šä¿¡IPCä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ul><li>BroadcastReceiver</li><li>ContentProvider</li><li>AIDL</li><li>Messenger</li><li>Socket</li><li>æ–‡ä»¶</li></ul><p>Linux å·²ç»æä¾›äº†ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜å’Œ Socket ç­‰ IPC æœºåˆ¶</p><p><strong>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚</strong></p><h1 id="ä¸€äº›åŸºç¡€çŸ¥è¯†"><a href="#ä¸€äº›åŸºç¡€çŸ¥è¯†" class="headerlink" title="ä¸€äº›åŸºç¡€çŸ¥è¯†"></a>ä¸€äº›åŸºç¡€çŸ¥è¯†</h1><p> ä»¥ä¸‹å†…å®¹æ¥è‡ªï¼š</p><p>ä½œè€…ï¼šSylvanasSun<br>é“¾æ¥ï¼š<a href="https://juejin.im/post/59f8691b51882534af254317" target="_blank" rel="noopener">https://juejin.im/post/59f8691b51882534af254317</a><br>æ¥æºï¼šæ˜é‡‘<br>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>Linuxä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªå•ç‹¬çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚<strong>è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºå†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´</strong>ï¼Œç”¨æˆ·ç©ºé—´åŒ…æ‹¬ä»£ç ã€æ•°æ®ã€å †ã€å…±äº«åº“ä»¥åŠæ ˆï¼Œå†…æ ¸ç©ºé—´åŒ…æ‹¬å†…æ ¸ä¸­çš„ä»£ç å’Œæ•°æ®ç»“æ„ï¼Œå†…æ ¸ç©ºé—´çš„æŸäº›åŒºåŸŸè¢«æ˜ å°„åˆ°æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ç‰©ç†é¡µé¢ã€‚Linuxä¹Ÿå°†ä¸€ç»„è¿ç»­çš„è™šæ‹Ÿé¡µé¢ï¼ˆå¤§å°ç­‰äºå†…å­˜æ€»é‡ï¼‰æ˜ å°„åˆ°ç›¸åº”çš„ä¸€ç»„è¿ç»­çš„ç‰©ç†é¡µé¢ï¼Œè¿™ç§åšæ³•ä¸ºå†…æ ¸æä¾›äº†ä¸€ç§ä¾¿åˆ©çš„æ–¹æ³•æ¥è®¿é—®ç‰©ç†å†…å­˜ä¸­ä»»ä½•ç‰¹å®šçš„ä½ç½®ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20200422114446.png" alt="ç¤ºæ„å›¾æ¥è‡ªhttps://juejin.im/post/59f8691b51882534af254317"></p><p>Linuxé€šè¿‡å°†ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸä¸ä¸€ä¸ªç¡¬ç›˜ä¸Šçš„æ–‡ä»¶å…³è”èµ·æ¥ï¼Œä»¥åˆå§‹åŒ–è¿™ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„å†…å®¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>å†…å­˜æ˜ å°„</strong>ï¼ˆmemory mappingï¼‰ã€‚è¿™ç§å°†è™šæ‹Ÿå†…å­˜ç³»ç»Ÿé›†æˆåˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ–¹æ³•å¯ä»¥ç®€å•è€Œé«˜æ•ˆåœ°æŠŠç¨‹åºå’Œæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><p><strong>æ™®é€šæ–‡ä»¶æ˜ å°„å°±æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶ä¸ä¸€å—å†…å­˜å»ºç«‹èµ·æ˜ å°„å…³ç³»ï¼Œå¯¹è¯¥æ–‡ä»¶è¿›è¡ŒIOæ“ä½œå¯ä»¥ç»•è¿‡å†…æ ¸ç›´æ¥åœ¨ç”¨æˆ·æ€å®Œæˆï¼ˆç”¨æˆ·æ€åœ¨è¯¥è™šæ‹Ÿåœ°å€åŒºåŸŸè¯»å†™å°±ç›¸å½“äºè¯»å†™è¿™ä¸ªæ–‡ä»¶ï¼‰</strong>ã€‚åŒ¿åæ–‡ä»¶æ˜ å°„ä¸€èˆ¬åœ¨ç”¨æˆ·ç©ºé—´éœ€è¦åˆ†é…ä¸€æ®µå†…å­˜æ¥å­˜æ”¾æ•°æ®æ—¶ï¼Œç”±å†…æ ¸åˆ›å»ºåŒ¿åæ–‡ä»¶å¹¶ä¸å†…å­˜è¿›è¡Œæ˜ å°„ï¼Œä¹‹åç”¨æˆ·æ€å°±å¯ä»¥é€šè¿‡æ“ä½œè¿™æ®µè™šæ‹Ÿåœ°å€æ¥æ“ä½œå†…å­˜äº†ã€‚åŒ¿åæ–‡ä»¶æ˜ å°„æœ€ç†Ÿæ‚‰çš„åº”ç”¨åœºæ™¯å°±æ˜¯åŠ¨æ€å†…å­˜åˆ†é…ï¼ˆmalloc()å‡½æ•°ï¼‰ã€‚</p><p><strong>å†…å­˜æ˜ å°„æä¾›äº†å…±äº«å¯¹è±¡çš„æœºåˆ¶ï¼Œæ¥é¿å…å†…å­˜èµ„æºçš„æµªè´¹ã€‚ä¸€ä¸ªå¯¹è±¡è¢«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜çš„ä¸€ä¸ªåŒºåŸŸï¼Œè¦ä¹ˆæ˜¯ä½œä¸ºå…±äº«å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ä½œä¸ºç§æœ‰å¯¹è±¡çš„ã€‚</strong> è¿›ç¨‹å¯¹å…±äº«å¯¹è±¡çš„å†™æ“ä½œå¯¹äºå…¶ä»–ä¹Ÿä½¿ç”¨åˆ°è¯¥å…±äº«å¯¹è±¡çš„è¿›ç¨‹æ˜¯å¯è§çš„ã€‚</p><p>CPUè·å–åˆ°è™šæ‹Ÿåœ°å€ï¼Œç„¶åé€šè¿‡MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰å°†å…¶ç¿»è¯‘ä¸ºç‰©ç†åœ°å€ã€‚</p><h1 id="linux-IPC"><a href="#linux-IPC" class="headerlink" title="linux IPC"></a>linux IPC</h1><p>ä¼˜ç¼ºç‚¹å‚è€ƒï¼š</p><blockquote><ol><li>ç®¡é“ï¼šåœ¨åˆ›å»ºæ—¶åˆ†é…ä¸€ä¸ªpageå¤§å°çš„å†…å­˜ï¼Œç¼“å­˜åŒºå¤§å°æ¯”è¾ƒæœ‰é™ï¼›</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¿¡æ¯å¤åˆ¶ä¸¤æ¬¡ï¼Œé¢å¤–çš„CPUæ¶ˆè€—ï¼›ä¸åˆé€‚é¢‘ç¹æˆ–ä¿¡æ¯é‡å¤§çš„é€šä¿¡ï¼›</li><li>å…±äº«å†…å­˜ï¼šæ— é¡»å¤åˆ¶ï¼Œå…±äº«ç¼“å†²åŒºç›´æ¥ä»˜é™„åŠ åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œé€Ÿåº¦å¿«ï¼›ä½†è¿›ç¨‹é—´çš„åŒæ­¥é—®é¢˜æ“ä½œç³»ç»Ÿæ— æ³•å®ç°ï¼Œå¿…é¡»å„è¿›ç¨‹åˆ©ç”¨åŒæ­¥å·¥å…·è§£å†³ï¼›</li><li>å¥—æ¥å­—ï¼šä½œä¸ºæ›´é€šç”¨çš„æ¥å£ï¼Œä¼ è¾“æ•ˆç‡ä½ï¼Œä¸»è¦ç”¨äºä¸é€šæœºå™¨æˆ–è·¨ç½‘ç»œçš„é€šä¿¡ï¼›</li><li>ä¿¡å·é‡ï¼šå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚</li><li>ä¿¡å·: ä¸é€‚ç”¨äºä¿¡æ¯äº¤æ¢ï¼Œæ›´é€‚ç”¨äºè¿›ç¨‹ä¸­æ–­æ§åˆ¶ï¼Œæ¯”å¦‚éæ³•å†…å­˜è®¿é—®ï¼Œæ€æ­»æŸä¸ªè¿›ç¨‹ç­‰ï¼›</li></ol><p>ä½œè€…ï¼šGityuan<br>é“¾æ¥ï¼š<a href="https://www.zhihu.com/question/39440766/answer/89210950" target="_blank" rel="noopener">https://www.zhihu.com/question/39440766/answer/89210950</a></p></blockquote><ul><li>ç®¡é“Pipe</li></ul><p><a href="https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(Unix" target="_blank" rel="noopener">ç®¡é“</a>) æ˜¯å°†æ ‡å‡†è¾“å…¥è¾“å‡ºè¿æ¥èµ·æ¥çš„è¿›ç¨‹ã€‚ <strong>æ•°æ®å¤åˆ¶2æ¬¡ï¼Œæœ‰é•¿åº¦é™åˆ¶</strong></p><p><img src="https://jixiaoyong.github.io/images/20200422114721.jpg" alt="ç¤ºæ„å›¾æ¥è‡ªhttps://pic002.cnblogs.com/images/2012/426620/2012110216160766.jpg"></p><p>å¦‚å›¾ï¼Œè¿›ç¨‹1å°†æ•°æ®<strong>å†™å…¥</strong>åˆ°ç®¡é“ï¼ˆå†…å­˜ç¼“å­˜åŒºï¼‰ï¼Œè¿›ç¨‹2ä»ç®¡é“ä¸­<strong>è¯»å–</strong>æ•°æ®ã€‚æ•°æ®ä»å†™ç«¯æµå…¥ç®¡é“ï¼Œä»è¯»ç«¯æµå‡ºï¼Œè¿™æ ·å°±å®ç°äº†è¿›ç¨‹é—´é€šä¿¡</p><p>æ¯ä¸ªè¿›ç¨‹çš„è¾“å‡ºè¢«å½“åšä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¾“å…¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -l | less //å°†ls -l çš„ç»“æœè¾“å…¥åˆ°lessä¸­ï¼Œå®ç°åˆ†é¡µ</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/biyeymyhjob/archive/2012/11/03/2751593.html" target="_blank" rel="noopener">Linuxè¿›ç¨‹é—´é€šä¿¡ä¹‹ç®¡é“(pipe)ã€å‘½åç®¡é“(FIFO)ä¸ä¿¡å·(Signal)</a><br><a href="https://blog.csdn.net/skyroben/article/details/71513385" target="_blank" rel="noopener">https://blog.csdn.net/skyroben/article/details/71513385</a></p><ul><li>æ¶ˆæ¯é˜Ÿåˆ—Message</li></ul><p>æ˜¯ä¸€ä¸²å¯ä»¥æœ‰ä¸åŒç±»å‹çš„æ¶ˆæ¯å—çš„é“¾è¡¨ï¼Œå¯ä»¥é¿å…é˜»å¡ã€‚<strong>æ•°æ®å¤åˆ¶2æ¬¡ï¼Œæœ‰é•¿åº¦é™åˆ¶</strong>ï¼Œç¼“å†²å°ã€‚</p><p><a href="https://www.ibm.com/developerworks/cn/linux/l-ipc/part3/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-ipc/part3/index.html</a></p><ul><li>å…±äº«å†…å­˜</li></ul><p>å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®ä¸€ä¸ªå…¬ç”¨çš„å†…å­˜ç©ºé—´ã€‚æ•ˆç‡æœ€é«˜çš„IPCã€‚<strong>æ•°æ®å†…å­˜å¤åˆ¶0æ¬¡,ä½†æ˜¯æ²¡æœ‰åŒæ­¥äº’æ–¥æœºåˆ¶</strong></p><ul><li>å¥—æ¥å­—Socket</li></ul><p>ä¼ è¾“æ•ˆç‡ä½ï¼Œ<strong>æ•°æ®å¤åˆ¶2æ¬¡</strong></p><ul><li>ä¿¡å·é‡ semaphore</li></ul><p>ä¸ç®¡é“ä¸åŒï¼Œä¿¡å·é‡æ˜¯ä¸ºäº†ä¿æŠ¤è¿›ç¨‹å…±äº«èµ„æºåœ¨åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹è®¿é—®ã€‚è§£å†³åŒæ­¥å’Œäº’æ–¥é—®é¢˜ã€‚</p><p>svï¼šä¿¡å·å˜é‡</p><p>å¯¹ä¿¡å·é‡çš„æ“ä½œåªæœ‰ä¸€ä¸‹P(sv)å’ŒV(sv)ä¸¤ä¸ªåŸå­æ“ä½œ:<br>1)  è¿›ç¨‹1è®¿é—®èµ„æºæ—¶å¯¹ä¿¡å·é‡è¿›è¡Œç­‰å¾…æ“ä½œP(sv)ï¼ˆå¦‚æœsv&gt;0åˆ™æ“ä½œèµ„æºå¹¶å°†ä¿¡å·é‡-1ï¼Œå¦åˆ™æŒ‚èµ·è¿›ç¨‹ç­‰å¾…ï¼‰ï¼›<br>2) å½“è¯¥è¿›ç¨‹1å¯¹èµ„æºæ‰§è¡Œå®Œæ“ä½œåï¼Œå¯¹ä¿¡å·é‡è¿›è¡Œå‘é€æ“ä½œV(sv)ï¼ˆæ­¤æ—¶å¦‚æœæœ‰è¿›ç¨‹2ç­‰å¾…svè€ŒæŒ‚èµ·ï¼Œåˆ™æ¢å¤è¿›ç¨‹2ï¼Œå¦åˆ™å°±ç»™sv+1ï¼‰</p><p><a href="https://blog.csdn.net/skyroben/article/details/72513985" target="_blank" rel="noopener">https://blog.csdn.net/skyroben/article/details/72513985</a></p><ul><li>ä¿¡å· Signal</li></ul><p>ä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡ä¸­å”¯ä¸€çš„å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œé€šçŸ¥æ¥æ”¶ä¿¡å·çš„è¿›ç¨‹å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚è€Œè¿›ç¨‹æ¥å—åˆ°ä¿¡å·åå¯ä»¥å¿½ç•¥ï¼Œæ•è·å¤„ç†ï¼Œæˆ–è€…ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æ“ä½œã€‚</p><p><a href="https://www.ibm.com/developerworks/cn/linux/l-ipc/part2/index1.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-ipc/part2/index1.html</a></p><p>åªèƒ½æ‰¿è½½å¾ˆå°çš„ä¿¡æ¯é‡ï¼Œä¸»è¦ç”¨åœ¨è¿›ç¨‹çš„ä¸­æ–­æ§åˆ¶</p><h1 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h1><p>æ•°æ®æ‹·è´1æ¬¡ï¼Œæœ‰æƒé™æ ¡éªŒï¼ˆä¸ºå‘é€æ–¹æ·»åŠ äº†UID/PIDèº«ä»½ï¼‰</p><p><img src="https://jixiaoyong.github.io/images/20200422115508.gif" alt="å‚ä¸Binderé€šä¿¡çš„æ‰€æœ‰è§’è‰² å›¾ç‰‡æ¥è‡ªhttps://blog.csdn.net/universus/article/details/6211589"></p><p>æ—¶åºå›¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">title:  Binderäº¤äº’æ—¶åºå›¾ </span><br><span class="line"></span><br><span class="line">participant Client</span><br><span class="line">participant ServerManager</span><br><span class="line">participant Binderé©±åŠ¨</span><br><span class="line">participant Server</span><br><span class="line"></span><br><span class="line">note over Server: æœåŠ¡åˆ›å»ºBinder</span><br><span class="line">Server-&gt; Binderé©±åŠ¨: Binderå¯¹è±¡åŠåå­—</span><br><span class="line">note over Binderé©±åŠ¨: Binderé©±åŠ¨åœ¨å†…æ ¸åˆ›å»ºBinderå¯¹åº”å®ä½“èŠ‚ç‚¹åŠå¼•ç”¨</span><br><span class="line">Binderé©±åŠ¨-&gt; ServerManager: å†…æ ¸ä¸­çš„Binderå¯¹è±¡å¼•ç”¨åŠåå­—</span><br><span class="line">note over ServerManager: æ³¨å†ŒBinderï¼ˆå°†åå­—å’Œåº”ç”¨å¡«å…¥æŸ¥æ‰¾è¡¨ï¼‰</span><br><span class="line">Client -&gt; ServerManager: å®¢æˆ·ç«¯éœ€è¦çš„Binderå¯¹è±¡åå­—</span><br><span class="line">note over ServerManager: æŸ¥æ‰¾ä¿å­˜çš„å†…æ ¸Binderå¯¹è±¡åº”ç”¨</span><br><span class="line">ServerManager -&gt; Client: å®¢æˆ·ç«¯éœ€è¦çš„Binderå¯¹è±¡å¼•ç”¨</span><br><span class="line">note over Client: æ“ä½œå†…æ ¸Binder</span><br><span class="line">Client --&gt;&gt; Server:ç›¸å½“äºæ“ä½œServer</span><br></pre></td></tr></table></figure><p><img src="https://jixiaoyong.github.io/images/20200422115253.png" alt="20200422115253"></p><p>ç†è®ºä¸Šçš„Binderé€»è¾‘ï¼š</p><blockquote><p>SMgræä¾›çš„Binderæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ²¡æœ‰åå­—ä¹Ÿä¸éœ€è¦æ³¨å†Œï¼Œå½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨BINDER_SET_CONTEXT_MGRå‘½ä»¤å°†è‡ªå·±æ³¨å†ŒæˆSMgræ—¶Binderé©±åŠ¨ä¼šè‡ªåŠ¨ä¸ºå®ƒåˆ›å»ºBinderå®ä½“ï¼ˆè¿™å°±æ˜¯é‚£åªé¢„å…ˆé€ å¥½çš„é¸¡ï¼‰ã€‚å…¶æ¬¡è¿™ä¸ªBinderçš„å¼•ç”¨åœ¨æ‰€æœ‰Clientä¸­éƒ½å›ºå®šä¸º0è€Œæ— é¡»é€šè¿‡å…¶å®ƒæ‰‹æ®µè·å¾—ã€‚</p><p>åœ¨æ•°æ®ä»å‘é€æ–¹å‘æ¥æ”¶æ–¹æ‹·è´æ—¶ï¼Œé©±åŠ¨ä¼šæ ¹æ®å‘é€æ•°æ®åŒ…çš„å¤§å°ï¼Œä½¿ç”¨æœ€ä½³åŒ¹é…ç®—æ³•ä»ç¼“å­˜æ± ä¸­æ‰¾åˆ°ä¸€å—å¤§å°åˆé€‚çš„ç©ºé—´ï¼Œ<strong>å°†æ•°æ®ä»å‘é€ç¼“å­˜åŒºå¤åˆ¶è¿‡æ¥</strong>ã€‚</p><p>ä¸ºäº†å®ç°ç”¨æˆ·ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´ï¼ŒBinderé©±åŠ¨çš„mmap()åˆ†é…çš„å†…å­˜é™¤äº†æ˜ å°„è¿›äº†æ¥æ”¶æ–¹è¿›ç¨‹é‡Œï¼Œè¿˜æ˜ å°„è¿›äº†å†…æ ¸ç©ºé—´ã€‚æ‰€ä»¥è°ƒç”¨copy_from_user()å°†æ•°æ®æ‹·è´è¿›å†…æ ¸ç©ºé—´ä¹Ÿç›¸å½“äºæ‹·è´è¿›äº†æ¥æ”¶æ–¹çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™å°±æ˜¯Binderåªéœ€ä¸€æ¬¡æ‹·è´çš„â€˜ç§˜å¯†â€™ã€‚</p><p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œuniversusã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ª CC 4.0 BY-SA </p><p>ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">https://blog.csdn.net/universus/article/details/6211589</a></p></blockquote><p>ä¸»è¦å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">https://blog.csdn.net/universus/article/details/6211589</a></p><p><a href="https://blog.csdn.net/freekiteyu/article/details/70082302" target="_blank" rel="noopener">https://blog.csdn.net/freekiteyu/article/details/70082302</a></p><p>Binderé€šä¿¡ä¸»è¦æ¶‰åŠä¸€ä¸‹å¯¹è±¡ï¼š</p><ul><li>Server</li><li>Client</li><li>ServerManager</li><li>Binderé©±åŠ¨</li></ul><p>é¦–å…ˆè¦çŸ¥é“ï¼ŒServerï¼ŒClientä»¥åŠServerManagerä¸€èˆ¬éƒ½åœ¨ä¸åŒçš„è¿›ç¨‹ä¹‹ä¸­ï¼Œé‚£ä¹ˆServerï¼ŒClientå¦‚ä½•ä¸ServerManageré€šä¿¡å¹¶æ³¨å†Œ/æŸ¥è¯¢æ‰€éœ€çš„æœåŠ¡å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦ç”¨åˆ°<strong>0å·å¼•ç”¨Binder</strong>ã€‚</p><p><strong>0å·å¼•ç”¨Binder</strong> æ˜¯ServerManagerå†…éƒ¨åˆ›å»ºåŒ¿åBinderï¼Œæ‰€æœ‰çš„Clientï¼ˆç›¸å¯¹äºServerManageræ¥è¯´å…¶ä»–å’Œä»–äº¤äº’çš„éƒ½æ˜¯Clientï¼‰éƒ½é»˜è®¤æŒæœ‰è¿™ä¸ªBinderçš„å¼•ç”¨ã€‚</p><p>æ‰€ä»¥ä¸€ä¸ªå®Œæ•´çš„AIDLé€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Serveråˆ›å»ºä¸€ä¸ªBinderå’Œå¯¹åº”åå­—</li><li>Serveré€šè¿‡æŒæœ‰çš„0å·å¼•ç”¨Binderå’ŒServerManageré€šä¿¡ã€‚<br>å°†ç”Ÿæˆçš„Binderå’Œå¯¹åº”åå­—å‘é€åˆ°Binderé©±åŠ¨ï¼ŒBinderé©±åŠ¨ä¼šä¸ºè¿™ä¸ªBinderåœ¨å†…æ ¸ç©ºé—´åˆ›å»ºå¯¹åº”å®ä½“èŠ‚ç‚¹åŠå…¶å¼•ç”¨ï¼ˆ<strong>å¤åˆ¶äº†ä¸€æ¬¡</strong>ï¼‰ï¼Œå¹¶é€šè¿‡0å·å¼•ç”¨å°†å…¶å‘ç»™ServerManagerã€‚</li><li>ServerManageræ”¶åˆ°å†…æ ¸ä¸­çš„Binderå¯¹è±¡å¼•ç”¨åŠåå­—åå°†å…¶ä¿å­˜åˆ°æŸ¥æ‰¾è¡¨ä¸­ã€‚</li><li>Clienté€šè¿‡0å·å¼•ç”¨Binderå’ŒServerManageré€šä¿¡ã€‚<br>Clientå°†éœ€è¦çš„Binderçš„åå­—å‘ç»™ServerManagerï¼ŒServerManageræŸ¥è¯¢åˆ°å·²ç»æ³¨å†Œçš„å†…æ ¸Binderå¼•ç”¨å¹¶å°†å…¶å‘ç»™Clientã€‚</li><li>Clientè·å–åˆ°å†…æ ¸Binderçš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚</li></ol><p>å†æ¥çœ‹çœ‹ä¸€ä¸ªå®Œæ•´çš„æµç¨‹ï¼š</p><p>åœ¨Serviceä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆåˆ›å»ºä¸€ä¸ªmIBinderå¯¹è±¡å¹¶ä¸”åœ¨<code>public IBinder onBind(Intent intent)</code>æ–¹æ³•è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IBinder mIBinder = <span class="keyword">new</span> AidlBinderInterface.Stub() &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">//è¿™é‡Œå®ç°æˆ‘ä»¬æœåŠ¡èƒ½å¤Ÿæä¾›çš„æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿½è¸ªonBindæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šå‘ç°<code>mIBinder</code>çš„å¯¹è±¡ä¼šåœ¨ActivityThreadä¸­çš„<code>private void handleBindService(BindServiceData data)</code>æ–¹æ³•ä¸­è¢«ä¼ å…¥åˆ°IActivityManagerçš„publishServiceæ–¹æ³•ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    IBinder binder = s.onBind(data.intent);</span><br><span class="line">    ActivityManager.getService().publishService(</span><br><span class="line">                                data.token, data.intent, binder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ActivityManager.getService()æ–¹æ³•æ˜¯é€šè¿‡IPCè·å–åˆ°ActivityManagerçš„å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IActivityManagerSingleton.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">        <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">                <span class="keyword">final</span> IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br><span class="line">                <span class="keyword">return</span> am;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>è€Œæ ¹æ®<a href="https://www.jianshu.com/p/91c97710976a" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¿™ä¸ªbinderæœ€ç»ˆä¼šè¢«ä¼ è¾“åˆ°ç»‘å®šè¿™ä¸ªæœåŠ¡æ—¶æ‰€ç”¨çš„ServiceConnectionå¯¹è±¡çš„<code>onServiceConnected</code>æ–¹æ³•ä¸­ï¼ˆ<strong>å³mIBinderé€šè¿‡ServerManagerä»Serviceä¼ é€’åˆ°äº†Client</strong>ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">            mServiceInterface = AidlBinderInterface.Stub.asInterface(service);</span><br><span class="line">            <span class="comment">//æˆ‘ä»¬é€šè¿‡å¾—åˆ°çš„è¿™ä¸ªmServiceInterfaceå¯ä»¥åœ¨å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ‰€å®ç°çš„æ–¹æ³•</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>æ ¹æ®<a href="https://blog.csdn.net/zhangyongfeiyong/article/details/51953300" target="_blank" rel="noopener">AndroidæœåŠ¡ä¹‹bindServiceæºç åˆ†æ</a>mConnectionä¼šé€šè¿‡<code>context.bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</code>æœ€ç»ˆåœ¨ActivityManagerServiceé€šè¿‡Binderé©±åŠ¨ç¨‹åºè°ƒç”¨ActivityThreadç±»ä¸­çš„scheduleBindServiceæ–¹æ³•ä¼ é€’åˆ°Serviceæ‰€åœ¨è¿›ç¨‹ä¸­ï¼Œå¹¶æ ¹æ®Serviceçš„çŠ¶æ€ä¸åŒè€Œè¢«è°ƒç”¨å¯¹åº”æ–¹æ³•ï¼ˆ<strong>å³mConnectioné€šè¿‡ServerManagerä»Clientä¼ é€’åˆ°äº†Service</strong>ï¼‰ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20200422115031.jpg" alt="å›¾ç‰‡æ¥è‡ªhttps://img-blog.csdn.net/20160719100800917?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"></p><p>åœ¨è¿™å…¶ä¸­æˆ‘ä»¬ç”¨åˆ°äº†ä¸¤ä¸ªæ¶‰åŠåˆ°AIDLæ–‡ä»¶ï¼š</p><ul><li>private IBinder mIBinder = new AidlBinderInterface.Stub() {}</li><li>mServiceInterface = AidlBinderInterface.Stub.asInterface(service);</li></ul><p>å†æ¥çœ‹çœ‹æˆ‘ä»¬å†™çš„å¯¹åº”çš„AIDLæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface AidlBinderInterface &#123;</span><br><span class="line"> //åœ¨è¿™é‡Œå®šä¹‰æœåŠ¡éœ€è¦æä¾›çš„æ–¹æ³•</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ–¹æ³•ï¼Œç³»ç»Ÿè‡ªåŠ¨å¸®æˆ‘ä»¬å®ç°äº†æ›´è¯¦ç»†çš„å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aidl;</span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AidlBinderInterface</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Local-side IPC implementation stub class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">aidl</span>.<span class="title">AidlBinderInterface</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.example.aidl.AidlBinderInterface"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Construct the stub at attach it to the interface.</span></span><br><span class="line"><span class="comment">         * å°†DESCRIPTORå’Œè¿™ä¸ªæ¥å£ç»‘å®šåˆ°ä¸€èµ·</span></span><br><span class="line"><span class="comment">         * æœ¬æ–¹æ³•ä¼šåœ¨æœåŠ¡åˆ›å»ºIBinderå¯¹è±¡çš„æ—¶å€™è°ƒç”¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Cast an IBinder object into an com.example.aidl.AidlBinderInterface interface,</span></span><br><span class="line"><span class="comment">         * generating a proxy if needed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.example.aidl.<span class="function">AidlBinderInterface <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢æœ¬åœ°æ˜¯å¦æœ‰ç¬¦åˆè¯¥æè¿°ï¼ˆDESCRIPTORï¼‰æ¥å£çš„Binderå¯¹è±¡</span></span><br><span class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="comment">// æœ‰çš„è¯ç›´æ¥è¿”å›æœ¬åœ°å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> com.example.aidl.AidlBinderInterface))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((com.example.aidl.AidlBinderInterface) iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰çš„è¯ï¼Œåˆ›å»ºä»£ç†ç±»ï¼Œè¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> com.example.aidl.AidlBinderInterface.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨é€šä¿¡æ—¶ï¼Œå¦‚æœasInterfaceè¿”å›æœ¬åœ°å¯¹è±¡ï¼Œåˆ™ä¼šæ‰§è¡Œæœ¬åœ°å¯¹æ¥å£ï¼ˆDESCRIPTORï¼‰çš„å®ç°æ–¹æ³•ï¼Œ</span></span><br><span class="line">        <span class="comment">// å¦åˆ™å°±ä¼šè°ƒç”¨ä»£ç†ç±»com.example.aidl.AidlBinderInterface.Stub.Proxyä¸­å¯¹åº”çš„æ–¹æ³•è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">            java.lang.String descriptor = DESCRIPTOR;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                    reply.writeString(descriptor);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_getAvailablePointTags: &#123;</span><br><span class="line">                    data.enforceInterface(descriptor);</span><br><span class="line">                    java.util.List&lt;String&gt; _result = <span class="keyword">this</span>.getAllStringTags();</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    reply.writeTypedList(_result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">               ...</span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä»£ç†ç±»</span></span><br><span class="line"><span class="comment">         * é€šè¿‡Binderå¯¹è±¡mRemoteæ‰§è¡ŒAidlBinderInterfaceæ¥å£çš„å…·ä½“æ–¹æ³•</span></span><br><span class="line"><span class="comment">         * å…·ä½“åˆ™åœ¨mRemote.transact()å®ç°äº†è·¨è¿›ç¨‹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">aidl</span>.<span class="title">AidlBinderInterface</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">            Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ç³»ç»Ÿå¯¹æˆ‘ä»¬åœ¨AIDLä¸­å®šä¹‰çš„æ–¹æ³•çš„å…·ä½“å®ç°</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> java.util.<span class="function">List&lt;StringTag&gt; <span class="title">getAllStringTags</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                java.util.List&lt;StringTags&gt; _result;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                     <span class="comment">// mRemote.transact()æ–¹æ³•ä¼šï¼š1.ç»™æœåŠ¡ç«¯å‘æ¶ˆæ¯ 2.æŒ‚èµ·å½“å‰çº¿ç¨‹ 3.æ”¶åˆ°æœåŠ¡ç«¯è¿”å›åå”¤é†’å½“å‰çº¿ç¨‹</span></span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_getAllStringTags, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                    _result = _reply.createTypedArrayList(StringTag.CREATOR);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç³»ç»Ÿå¯¹æ¯ä¸ªæ¥å£æ–¹æ³•çš„ç¼–å·</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getAllStringTags = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä¸‹é¢è¿™äº›æ˜¯ç³»ç»Ÿæ ¹æ®æˆ‘ä»¬åœ¨aidlä¸­å®šä¹‰çš„æ–¹æ³•å†™çš„æ¥å£</span></span><br><span class="line">        <span class="keyword">public</span> java.util.<span class="function">List&lt;StringTag&gt; <span class="title">getAllStringTags</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯çŸ¥<code>mRemote</code>ä¾¿æ˜¯æŒ‡å‘AMSæœåŠ¡çš„<code>BinderProxy</code>å¯¹è±¡ <a href="https://www.diycode.cc/topics/384" target="_blank" rel="noopener">https://www.diycode.cc/topics/384</a></p><p><a href="https://www.cnblogs.com/a284628487/p/3187320.html" target="_blank" rel="noopener">https://www.cnblogs.com/a284628487/p/3187320.html</a></p><p><img src="https://jixiaoyong.github.io/images/20200422114923.jpg" alt="å›¾ç‰‡æ¥è‡ªhttps://images0.cnblogs.com/blog/391137/201307/12211553-49c477a875e84b2aae764c67f38f26b2.jpg"></p><h2 id="others"><a href="#others" class="headerlink" title="others"></a>others</h2><p>å¦‚æœåœ¨BroadcastReceiver çš„onReceiveæ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå½“è¯¥æ–¹æ³•è¿”å›æ—¶ï¼ŒAndroidç³»ç»Ÿå°±ä¼šè®¤ä¸ºè¯¥BroadcastReceiverå·²ç»å®Œæˆä»»åŠ¡äº†ï¼Œä»è€Œä¼šåœ¨éœ€è¦å›æ”¶å†…å­˜æ—¶æ€æ­»è¿›ç¨‹ä»¥åŠå…¶ä¸­çš„Threadã€‚åˆ›å»ºä¸€ä¸ª<a href="https://developer.android.google.cn/reference/android/app/job/JobService.html?hl=zh-cn" target="_blank" rel="noopener">JobService</a>å¯ä»¥é¿å…è¿™ä¸ªæƒ…å†µã€‚</p><blockquote><p>So, the system may kill the process at any time to reclaim memory, and in doing so, it terminates the spawned thread running in the process.</p><p><a href="https://developer.android.google.cn/guide/components/activities/process-lifecycle?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.google.cn/guide/components/activities/process-lifecycle?hl=zh-cn</a></p></blockquote><p><a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">https://blog.csdn.net/universus/article/details/6211589</a></p><p><a href="https://www.jianshu.com/p/429a1ff3560c" target="_blank" rel="noopener">https://www.jianshu.com/p/429a1ff3560c</a></p><p><a href="https://www.cnblogs.com/a284628487/p/3187320.html" target="_blank" rel="noopener">https://www.cnblogs.com/a284628487/p/3187320.html</a></p><p><a href="http://hoyouly.fun/2019/07/17/Android-AIDL/" target="_blank" rel="noopener">http://hoyouly.fun/2019/07/17/Android-AIDL/</a></p><p><a href="https://juejin.im/entry/59c9cd59f265da065754e6f1" target="_blank" rel="noopener">https://juejin.im/entry/59c9cd59f265da065754e6f1</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç¬”è®°ä¹‹åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼šSerializableã€Externalizableå’ŒParcelable</title>
      <link href="/blog/posts/9d9183ec/"/>
      <url>/blog/posts/9d9183ec/</url>
      
        <content type="html"><![CDATA[<p><img src="https://images.pexels.com/photos/2881229/pexels-photo-2881229.jpeg?cs=srgb&dl=white-and-blue-cables-2881229.jpg&fm=jpg" class="full-image"><br>Photo by <strong><a href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank" rel="noopener">Pixabay </a></strong>from <strong><a href="https://www.pexels.com/photo/close-up-of-telephone-booth-257736/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank" rel="noopener">Pexels</a></strong></p><p><strong>åºåˆ—åŒ–</strong>ï¼šæŒ‡å°†<code>Javaå¯¹è±¡</code>è½¬åŒ–ä¸º<code>å­—èŠ‚æµ</code>ä»¥ä¾¿åœ¨ç½‘ç»œã€æ–‡ä»¶ä¸­ä¿å­˜ã€ä¼ è¾“ã€‚</p><p><strong>ååºåˆ—åŒ–</strong>ï¼šæŒ‡çš„æ˜¯ä»å­—èŠ‚æµä¸­æ¢å¤Javaå¯¹è±¡ã€‚</p><p>æœ¬æ–‡ä¸»è¦è®¨è®ºAndroidå’ŒJavaä¸­å®ç°åºåˆ—åŒ–çš„4ç§æ–¹å¼ï¼Œå¹¶æ¢è®¨ä¸€ä¸‹å…¶å®ç°åŸç†ã€‚</p><p>Android &amp; Javaä¸­å®ç°åºåˆ—åŒ–çš„æ–¹å¼æœ‰ï¼š</p><ul><li><code>android.os.Parcelable</code> Androidå¹³å°ç‰¹æœ‰ï¼Œéœ€è¦è‡ªå·±å®ç°å…·ä½“ç»†èŠ‚ï¼Œæ€§èƒ½æ¶ˆè€—å°ï¼Œåªèƒ½åœ¨å†…å­˜ä¸­å­˜åœ¨</li><li><code>java.io.Serializable</code> å®ç°ç®€å•ï¼Œåªéœ€è¦å®ç°<code>Serializable</code>æ¥å£å³å¯ï¼Œå¯ä»¥è¾“å‡ºåˆ°æ–‡ä»¶ã€ç½‘ç»œç­‰</li><li><code>java.io.Externalizable</code> éœ€è¦è‡ªå·±å®ç°å…·ä½“ç»†èŠ‚</li><li><a href="https://github.com/twitter/Serial/blob/master/README-CHINESE.rst/" target="_blank" rel="noopener"><code>Twitter Serial</code></a> Twitterå‡ºå“çš„é«˜æ€§èƒ½åºåˆ—åŒ–æ–¹æ¡ˆï¼Œå®ƒåŠ›æ±‚å¸®åŠ©å¼€å‘è€…å®ç°é«˜æ€§èƒ½å’Œé«˜å¯æ§çš„åºåˆ—åŒ–è¿‡ç¨‹ã€‚ï¼ˆæœ¬æ–‡ä¸è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<a href="https://www.jianshu.com/p/1b42608478c0" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼‰</li></ul><h1 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h1><p><code>Serializable</code>æ¥å£æ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼Œåªæ˜¯ä¸€ä¸ªæ ‡è®°â€”â€”è¡¨ç¤ºè¿™ä¸ªç±»å¯ä»¥ç”¨æ¥<code>åºåˆ—åŒ–/ååºåˆ—åŒ–</code>ï¼ˆç”±<code>ObjectOutputStream/ObjectInputStream</code>å®ç°å…·ä½“ç»†èŠ‚ï¼‰ã€‚</p><p>ä¸€ä¸ªç±»æ²¡æœ‰å®ç°<code>Serializableæ¥å£</code>ï¼Œæˆ–è€…åŒ…å«æ²¡æœ‰<code>å®ç°Serializableæ¥å£çš„å˜é‡</code>ï¼Œåˆ™ä¼šåºåˆ—åŒ–å¤±è´¥<code>NotSerializableException</code>ã€‚</p><h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>ä½¿ç”¨<code>serialVersionUID</code>æ ‡è®°å½“å‰<code>Serializable</code>çš„ç‰ˆæœ¬ã€‚</p><p>å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”¨å¯¹è±¡çš„<code>hashCode()</code>æŒ‡å®š<code>serialVersionUID</code>ï¼Œè¯¥å€¼ä¼šåœ¨ç±»å‘ç”Ÿæ”¹å˜æ—¶å˜åŒ–ï¼Œä»è€Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ã€‚</p><p>è€Œå¦‚æœ<code>serialVersionUID</code>ä¸€è‡´ï¼Œå³ä½¿ç±»ç»“æ„æœ‰å˜åŒ–ï¼Œä¹Ÿä¼šååºåˆ—åŒ–ï¼ˆç»™æ–°å¢çš„å˜é‡é»˜è®¤å€¼ï¼‰ï¼Œæ‰€ä»¥æœ€å¥½èµ‹äºˆä¸€ä¸ªé»˜è®¤çš„å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯ä»¥æ‰‹åŠ¨æŒ‡å®šï¼Œä¹Ÿå¯ä»¥éšæœºæ•°ï¼Œåªè¦ä¿æŒä¸€è‡´å³å¯ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™ä¼šä½¿ååºåˆ—åŒ–å¤±è´¥</span></span><br><span class="line">ANY-ACCESS-MODIFIER <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br></pre></td></tr></table></figure><h2 id="readResolve"><a href="#readResolve" class="headerlink" title="readResolve()"></a>readResolve()</h2><p>å¦‚æœ<code>class</code>å®ç°äº†<code>readResolve()</code>æ–¹æ³•ï¼Œä¼šåœ¨ååºåˆ—åŒ–æ—¶ç”¨åˆ°å¹¶è¿”å›è¿™é‡Œæä¾›çš„å¯¹è±¡ï¼ˆååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡ä¼šè¢«ä¸¢å¼ƒï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ååºåˆ—åŒ–</span></span><br><span class="line">SerializableClass serializableClass = (SerializableClass) objectInputStream.readObject();</span><br><span class="line"><span class="comment">// 2.readObject()å†…éƒ¨è°ƒç”¨äº†readObject0(false):</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readObject0</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">       </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡ŒåŒ¹é…äº†TC_NULL,TC_REFERENCE,TC_CLASS,TC_CLASSDESC,</span></span><br><span class="line">                <span class="comment">// TC_PROXYCLASSDESC,TC_STRING,TC_LONGSTRING,TC_ARRAY,TC_ENUM</span></span><br><span class="line">                <span class="comment">// TC_EXCEPTION,TC_BLOCKDATA,TC_BLOCKDATALONG,TC_ENDBLOCKDATAç­‰ç­‰ç±»å‹</span></span><br><span class="line">               </span><br><span class="line">                <span class="keyword">case</span> TC_OBJECT:<span class="comment">//å¦‚æœæ˜¯OBECJTç±»å‹ï¼Œå°±è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ğŸ‘‡</span></span><br><span class="line">                    <span class="keyword">return</span> checkResolve(readOrdinaryObject(unshared));</span><br><span class="line">                <span class="comment">// ... </span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                        String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            depth--;</span><br><span class="line">            bin.setBlockDataMode(oldMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 3. åœ¨è¿™é‡Œä¼šæ£€æµ‹æ˜¯å¦å­˜åœ¨readResolve()æ–¹æ³•ï¼Œæœ‰çš„è¯å°±è¿”å›ä»readResolve()è·å–çš„å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readOrdinaryObject</span><span class="params">(<span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Object obj;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// çœ‹è¿™é‡Œï¼Œå¦‚æœhasReadResolveMethod()ä¸ºçœŸåˆ™æ‰§è¡ŒinvokeReadResolve()å¹¶è¿”å›å…¶ç»“æœ</span></span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            handles.lookupException(passHandle) == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            desc.hasReadResolveMethod())</span><br><span class="line">        &#123;</span><br><span class="line">            Object rep = desc.invokeReadResolve(obj);</span><br><span class="line">            <span class="keyword">if</span> (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">                rep = cloneArray(rep);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">                <span class="comment">// Filter the replacement object</span></span><br><span class="line">                <span class="keyword">if</span> (rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (rep.getClass().isArray()) &#123;</span><br><span class="line">                        filterCheck(rep.getClass(), Array.getLength(rep));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        filterCheck(rep.getClass(), -<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                handles.setObject(passHandle, obj = rep);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// Invokes the readResolve method of the represented serializable class and returns the result.</span></span><br><span class="line">    <span class="function">Object <span class="title">invokeReadResolve</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException, UnsupportedOperationException</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ªç‰¹æ€§æˆ‘ä»¬å¯ä»¥ç¡®ä¿åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¹Ÿèƒ½å®ç°<strong>å•ä¾‹</strong>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private Object readResolve() throws ObjectStreamException &#123;</span><br><span class="line">    return this;//è¿”å›å•ä¾‹æœ¬èº«ï¼Œè€Œéæ–°å»ºçš„å¯¹è±¡</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ ¹æ®ä¸‹é¢çš„è¯´æ³•ï¼Œè¦å®ç°å¯ä»¥åºåˆ—åŒ–çš„å•ä¾‹æœ€ç®€å•å®‰å…¨çš„ï¼Œè¿˜æ˜¯ä½¿ç”¨æšä¸¾ï¼š</p><blockquote><p><strong>äº‹å®ä¸Šï¼Œå¦‚æœä¾èµ–readResolveè¿›è¡Œå®ä¾‹æ§åˆ¶ï¼Œå¸¦æœ‰å¯¹è±¡å¼•ç”¨ç±»å‹çš„æ‰€æœ‰å®ä¾‹åŸŸåˆ™éƒ½å¿…é¡»å£°æ˜ä¸ºtransientçš„</strong>ã€‚å¦åˆ™ï¼Œåˆ©ç”¨<code>readResolve()</code>æ–¹æ³•å®ç°çš„å•ä¾‹ä¹Ÿä¼šé­å—åˆ°æ”»å‡»ã€‚</p><p>å®ç°å¯åºåˆ—åŒ–æœ€ç®€å•å®‰å…¨çš„æ–¹å¼æ˜¯é‡‡ç”¨æšä¸¾çš„å½¢å¼ï¼Œåº”è¯¥å°½å¯èƒ½é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚å¦‚æœé‡‡ç”¨<code>readResolve</code>å®ç°çš„è¯ï¼Œè¦ç¡®ä¿è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹åŸŸéƒ½ä¸º<code>åŸºæœ¬ç±»å‹</code>ï¼Œæˆ–è€…æ˜¯<code>transient</code>çš„ã€‚</p><p><a href="https://cl0610.github.io/effective-java-learning/ç¬¬åç«  åºåˆ—åŒ–/77.å•ä¾‹æ¨¡å¼ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve.html" target="_blank" rel="noopener">77.å•ä¾‹æ¨¡å¼ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve</a></p></blockquote><h2 id="è‡ªå®šä¹‰åºåˆ—åŒ–è¿‡ç¨‹"><a href="#è‡ªå®šä¹‰åºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="è‡ªå®šä¹‰åºåˆ—åŒ–è¿‡ç¨‹"></a>è‡ªå®šä¹‰åºåˆ—åŒ–è¿‡ç¨‹</h2><p>å¦‚æœæƒ³è¦è‡ªå·±å¤„ç†åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå¯ä»¥å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObjectNoData</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•å®ç°<code>è¯»/å†™</code><strong>è¯¥ç±»è‡ªèº«çš„å±æ€§</strong>ï¼ˆ<code>All non-static and non-transient fields of the current class, include private</code>ï¼‰ï¼Œç„¶ååœ¨è°ƒç”¨è¯¸å¦‚<code>out.writeObject(string);</code>ç­‰æ–¹æ³•<strong>ä¿å­˜å…¶ä»–å˜é‡</strong>ã€‚</p><blockquote><p>The method does not need to concern itself with the state belonging to its superclasses or subclasses.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in.defaultReadObject();</span><br><span class="line">out.defaultWriteObject();</span><br></pre></td></tr></table></figure><p><code>readObjectNoData</code>æ–¹æ³•ä¸»è¦ç”¨åœ¨åºåˆ—åŒ–æµå’Œæˆ‘ä»¬è¦ååºåˆ—åŒ–çš„ç±»ä¸ä¸€è‡´æ—¶åˆå§‹åŒ–ä¸€äº›å¿…è¦çš„çŠ¶æ€ã€‚</p><blockquote><p>è¿™ç§æƒ…å†µå¯èƒ½å‡ºç°åœ¨æ¥æ”¶æ–¹ä½¿ç”¨äº†ä¸€ä¸ªä¸å‘é€æ–¹ä¸åŒç‰ˆæœ¬çš„ç±»ã€‚æ¥æ”¶æ–¹çš„ç‰ˆæœ¬å¤šæ‰©å±•äº†ä¸€äº›å­—æ®µï¼Œè€Œå‘é€æ–¹çš„ç‰ˆæœ¬æ²¡æœ‰è¿™äº›å­—æ®µã€‚è¿˜æœ‰ä¸€ç§å¯èƒ½å°±æ˜¯åºåˆ—åŒ–æµè¢«ç¯¡æ”¹äº†ã€‚è¿™æ—¶ï¼Œæ— è®ºæ˜¯æ¶æ„çš„æµè¿˜æ˜¯ä¸å®Œæ•´çš„æµï¼Œéƒ½å¯ä»¥ç”¨ <code>readObjectNoData</code> æ–¹æ³•æ¥å°†åºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡åˆå§‹åŒ–åˆ°æ­£ç¡®çš„çŠ¶æ€ã€‚<br>ä½œè€…ï¼šç¦å°”é©¬æ—<br>é“¾æ¥ï¼š<a href="https://juejin.im/post/5d7206c5f265da03ab427181" target="_blank" rel="noopener">https://juejin.im/post/5d7206c5f265da03ab427181</a></p></blockquote><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>ObjectOutputStream</code>çš„<code>putFields()</code>å’Œ<code>ObjectInputStream</code>çš„<code>readFields()</code>å†™å…¥/è¯»å–å˜é‡ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•å¯ä»¥<em>åŠ å¯†/è§£å¯†</em>éƒ¨åˆ†å˜é‡ï¼Œæˆ–è€…åœ¨åºåˆ—åŒ–çš„æ—¶å€™<em>åªå¤„ç†éƒ¨åˆ†å˜é‡</em>ã€‚</p><p>å…·ä½“ä½¿ç”¨æ–¹æ³•è§å¦‚ä¸‹ï¼š</p><blockquote><p><strong>æ³¨æ„</strong>ï¼š<code>putFields()/readFields()</code>æ–¹æ³•åˆ†åˆ«ä¸èƒ½ä¸<code>defaultWriteObject/defaultReadObject</code>ä¸€èµ·ä½¿ç”¨ï¼›</p><p><code>putFields.put()</code>ä¹‹åå¿…é¡»è°ƒç”¨<code>out.writeFields()</code>æ–¹æ³•</p><p>å¹¶ä¸”ï¼Œæ²¡æœ‰åœ¨<code>putFields()</code>ä¸­åŠ å…¥çš„æ•°æ®ï¼Œåœ¨<code>readObject</code>ä¸­åªèƒ½è·å–åˆ°è¯¥ç±»å‹çš„é»˜è®¤å€¼</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™æ®µç¤ºä¾‹ä»£ç æ¥è‡ª https://www.ibm.com/developerworks/cn/java/j-lo-serial/index.html</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           PutField putFields = out.putFields();</span><br><span class="line">           System.out.println(<span class="string">"åŸå¯†ç ï¼š"</span> + password);</span><br><span class="line">           password = <span class="string">"encryption"</span>;<span class="comment">//æ¨¡æ‹ŸåŠ å¯†</span></span><br><span class="line">           putFields.put(<span class="string">"password"</span>, password);</span><br><span class="line">           System.out.println(<span class="string">"åŠ å¯†åçš„å¯†ç ï¼š"</span> + password);</span><br><span class="line">           out.writeFields();<span class="comment">// putFields.put()ä¹‹åå¿…é¡»è°ƒç”¨æœ¬æ–¹æ³•</span></span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           GetField readFields = in.readFields();</span><br><span class="line">           Object object = readFields.get(<span class="string">"password"</span>, <span class="string">""</span>);</span><br><span class="line">           System.out.println(<span class="string">"è¦è§£å¯†çš„å­—ç¬¦ä¸²ï¼š"</span> + object.toString());</span><br><span class="line">           password = <span class="string">"pass"</span>;<span class="comment">//æ¨¡æ‹Ÿè§£å¯†,éœ€è¦è·å¾—æœ¬åœ°çš„å¯†é’¥</span></span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// æ‰§è¡Œååºåˆ—åŒ–ç»“æœï¼š</span></span><br><span class="line"><span class="comment">// åŸå¯†ç ï¼špass</span></span><br><span class="line"><span class="comment">// åŠ å¯†åçš„å¯†ç ï¼šencryption</span></span><br><span class="line"><span class="comment">// è¦è§£å¯†çš„å­—ç¬¦ä¸²ï¼šencryption</span></span><br><span class="line"><span class="comment">// æœ€åååºåˆ—åŒ–åçš„passwordä¸ºpass</span></span><br></pre></td></tr></table></figure><h2 id="çˆ¶ç±»æœªç»§æ‰¿Serializableçš„ç±»çš„åºåˆ—åŒ–"><a href="#çˆ¶ç±»æœªç»§æ‰¿Serializableçš„ç±»çš„åºåˆ—åŒ–" class="headerlink" title="çˆ¶ç±»æœªç»§æ‰¿Serializableçš„ç±»çš„åºåˆ—åŒ–"></a>çˆ¶ç±»æœªç»§æ‰¿Serializableçš„ç±»çš„åºåˆ—åŒ–</h2><p>å¦‚æœä¸€ä¸ªç±»å®ç°äº†åºåˆ—åŒ–ï¼Œä½†ä»–çš„çˆ¶ç±»æ²¡æœ‰å®ç°åºåˆ—åŒ–ï¼Œé‚£ä¹ˆçˆ¶ç±»<strong>å¿…é¡»è¦æœ‰ä¸€ä¸ªå…¬å¼€çš„æ— å‚æ„é€ å‡½æ•°</strong>ï¼Œå¦åˆ™ååºåˆ—åŒ–æ—¶ä¼šå‡ºé”™ã€‚</p><p>æ­¤æ—¶ååºåˆ—åŒ–æ—¶ï¼Œçˆ¶ç±»çš„å˜é‡å€¼ï¼ˆ<code>public, protected, and (if accessible) package fields</code>ï¼‰éƒ½ä¼šæ˜¯<strong>é»˜è®¤çš„å€¼</strong>æˆ–è€…æ˜¯åœ¨<strong>çˆ¶ç±»æ— å‚æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„å€¼</strong>ï¼ˆå³ä½¿è¿™äº›å€¼åœ¨å­ç±»å¯¹è±¡ä¸­å·²ç»è¢«ä¿®æ”¹äº†ï¼‰ã€‚</p><p>è¦æƒ³ä½¿å¾—è¿™äº›å€¼ä¹Ÿå¯ä»¥æ”¯æŒåºåˆ—åŒ–ï¼Œå¯ä»¥é€šè¿‡<code>writeObject/readObject</code>è‡ªå·±å¤„ç†è¿™äº›å€¼çš„åºåˆ—åŒ–ã€‚</p><p>åä¹‹ï¼Œå¦‚æœä¸€ä¸ªç±»å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œé‚£ä¹ˆä»–çš„å­ç±»ä¹Ÿè‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>ä¸‹é¢æ˜¯ä½¿ç”¨<code>Serializable</code>å®ç°åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ç®€å•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: jixiaoyong</span></span><br><span class="line"><span class="comment"> * email: jixiaoyong1995@gmail.com</span></span><br><span class="line"><span class="comment"> * website: https://jixiaoyong.github.io</span></span><br><span class="line"><span class="comment"> * date: 12/24/19</span></span><br><span class="line"><span class="comment"> * description: æ¼”ç¤ºåºåˆ—åŒ–åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializableClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> anInt = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> aLong = <span class="number">100L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> String aTransient = <span class="string">"transient filed cannot be serialized"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String A_STATIC_FILED = <span class="string">"static filed belong to class not object, cannot be serialized"</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SerializableClass clazz = <span class="keyword">new</span> SerializableClass();</span><br><span class="line"></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"ObjectOutputFile"</span>);</span><br><span class="line">        <span class="keyword">try</span> (ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">             ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//write object to byte sequences</span></span><br><span class="line">            objectOutputStream.writeObject(clazz);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//chang the object filed</span></span><br><span class="line">            clazz.aLong = <span class="number">666L</span>;</span><br><span class="line">            <span class="comment">// A_STATIC_FILED belong to the class, so you can see it has the value read form</span></span><br><span class="line">            <span class="comment">// the JVM rather the object you serialized before when you deserializes it.</span></span><br><span class="line">            SerializableClass.A_STATIC_FILED = <span class="string">"Change the static filed!"</span>;</span><br><span class="line"></span><br><span class="line">            SerializableClass serializableClass = (SerializableClass) objectInputStream.readObject();</span><br><span class="line">            System.out.println(serializableClass);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SerializableClass&#123;"</span> +</span><br><span class="line">                <span class="string">"anInt="</span> + anInt +</span><br><span class="line">                <span class="string">", aLong="</span> + aLong +</span><br><span class="line">                <span class="string">", aTransient='"</span> + aTransient + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", A_STATIC_FILED='"</span> + A_STATIC_FILED + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// output: </span></span><br><span class="line"><span class="comment">// SerializableClass&#123;anInt=10, aLong=100, aTransient='null', A_STATIC_FILED='Change the static filed!'&#125;</span></span><br></pre></td></tr></table></figure><h2 id="å¤šæ¬¡åºåˆ—åŒ–åŒä¸€ä¸ªå¯¹è±¡"><a href="#å¤šæ¬¡åºåˆ—åŒ–åŒä¸€ä¸ªå¯¹è±¡" class="headerlink" title="å¤šæ¬¡åºåˆ—åŒ–åŒä¸€ä¸ªå¯¹è±¡"></a>å¤šæ¬¡åºåˆ—åŒ–åŒä¸€ä¸ªå¯¹è±¡</h2><p>è¿”åºåˆ—åŒ–è¯»å–çš„è¿‡ç¨‹åœ¨<code>readResolve()</code>æ–¹æ³•ä¸€èŠ‚å·²ç»æ¶‰åŠåˆ°äº†ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹ä¿å­˜çš„éƒ¨åˆ†ï¼Œè¿™é‡Œä¼šæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„ç°è±¡ï¼š</p><blockquote><p>Java åºåˆ—åŒ–æœºåˆ¶ä¸ºäº†èŠ‚çœç£ç›˜ç©ºé—´ï¼Œå…·æœ‰ç‰¹å®šçš„å­˜å‚¨è§„åˆ™ï¼Œå½“å†™å…¥æ–‡ä»¶çš„ä¸ºåŒä¸€å¯¹è±¡æ—¶ï¼Œå¹¶ä¸ä¼šå†å°†å¯¹è±¡çš„å†…å®¹è¿›è¡Œå­˜å‚¨ï¼Œè€Œåªæ˜¯å†æ¬¡å­˜å‚¨ä¸€ä»½å¼•ç”¨ã€‚</p><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-serial/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-lo-serial/index.html</a></p></blockquote><p>è¿™ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå½“ä½¿ç”¨åŒä¸€ä¸ª<code>ObjectOutputStreamå¯¹è±¡</code>åºåˆ—åŒ–<code>åŒä¸€ä¸ªåºåˆ—åŒ–å¯¹è±¡</code>æ—¶ï¼Œå³ä½¿åœ¨ç¬¬ä¸€æ¬¡åºåˆ—åŒ–å¹¶ä¿å­˜åä¿®æ”¹äº†è¿™ä¸ªå¯¹è±¡çš„éƒ¨åˆ†å±æ€§ï¼Œå½“å†æ¬¡åºåˆ—åŒ–æ—¶ä¿å­˜çš„<strong>åªæ˜¯å‰ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨</strong>â€”â€”ä¹Ÿå°±æ˜¯è¯´å°†å®Œå…¨ç›¸åŒä¸€ä¸ªå¯¹è±¡ä¿å­˜äº†ä¸¤æ¬¡ï¼Œ<strong>ç¬¬äºŒæ¬¡åšçš„ä¿®æ”¹åœ¨åºåˆ—åŒ–çš„æ—¶å€™å¹¶æ²¡æœ‰ä¿å­˜</strong>ã€‚</p><p>æˆ‘ä»¬å†™ä¸ªç®€å•çš„DEMOéªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readAndwriteObject2</span><span class="params">(SerializableClass clazz)</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"ObjectOutputFile"</span> + System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">                ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file))</span><br><span class="line">        ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡åºåˆ—åŒ–</span></span><br><span class="line">            objectOutputStream.writeObject(clazz);</span><br><span class="line">            objectOutputStream.flush();</span><br><span class="line"></span><br><span class="line">            clazz.aLong = <span class="number">9344L</span>;<span class="comment">//åœ¨è¿™é‡Œä¿®æ”¹äº†éƒ¨åˆ†å±æ€§</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç¬¬äºŒæ¬¡åºåˆ—åŒ–</span></span><br><span class="line">            objectOutputStream.writeObject(clazz);</span><br><span class="line">            objectOutputStream.flush();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// ååºåˆ—åŒ–ï¼Œè¯»å–ä¹‹å‰åºåˆ—åŒ–çš„ä¸¤ä¸ªå¯¹è±¡</span></span><br><span class="line">            SerializableClass serializableClass = (SerializableClass) objectInputStream.readObject();</span><br><span class="line">            System.out.println(serializableClass);</span><br><span class="line">            SerializableClass serializableClass1 = (SerializableClass) objectInputStream.readObject();</span><br><span class="line">            System.out.println(serializableClass1);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"serializableClass == serializableClass1: "</span> + (serializableClass == serializableClass1));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// output </span></span><br><span class="line"><span class="comment">// SerializableClass&#123;anInt=10, aLong=100, aaLong=100, aTransient='null', A_STATIC_FILED='static filed belong to class not object, cannot be serialized'&#125;</span></span><br><span class="line"><span class="comment">// SerializableClass&#123;anInt=10, aLong=100, aaLong=100, aTransient='null', A_STATIC_FILED='static filed belong to class not object, cannot be serialized'&#125;</span></span><br><span class="line"><span class="comment">// serializableClass == serializableClass1: true //å¯ä»¥çœ‹åˆ°ä¸¤æ¬¡è·å–çš„æ˜¯å®Œå…¨ç›¸åŒçš„å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æºç ä¸­çœ‹åˆ°åŸå› ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ObjectOutputStreamçš„writeObjectæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (enableOverride) &#123;</span><br><span class="line">            writeObjectOverride(obj);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            writeObject0(obj, <span class="keyword">false</span>);<span class="comment">//æ³¨æ„è¿™é‡Œï¼Œç¬¬äºŒä¸ªå‚æ•°unsharedæ˜¯false</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">                writeFatalException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** obj -&gt; wire handle map */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HandleTable handles;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject0</span><span class="params">(Object obj, <span class="keyword">boolean</span> unshared)</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">// ... </span></span><br><span class="line">            <span class="keyword">if</span> ((obj = subs.lookup(obj)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                writeNull();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (h = handles.lookup(obj)) != -<span class="number">1</span>) &#123;</span><br><span class="line">              <span class="comment">// å¯ä»¥çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœunsharedä¸ºfalseçš„è¯ï¼Œ</span></span><br><span class="line">              <span class="comment">// å°±ä¼šå»æ‰¾è¿™ä¸ªå¯¹è±¡æ˜¯å¦å·²ç»è¢«åºåˆ—åŒ–è¿‡äº†ï¼Œæ˜¯çš„è¯å°±ç›´æ¥å†™å…¥å¼•ç”¨,</span></span><br><span class="line">              <span class="comment">// è€Œä¸æ˜¯å†æ¬¡åºåˆ—åŒ–</span></span><br><span class="line">                writeHandle(h);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">                writeClass((Class) obj, unshared);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectStreamClass) &#123;</span><br><span class="line">                writeClassDesc((ObjectStreamClass) obj, unshared);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Writes given object handle to stream.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeHandle</span><span class="params">(<span class="keyword">int</span> handle)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        bout.writeByte(TC_REFERENCE);</span><br><span class="line">        bout.writeInt(baseWireHandle + handle);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œåœ¨ä¿å­˜åŒä¸€ä¸ªå¯¹è±¡æ—¶è¦æ³¨æ„ä½¿ç”¨ä¸åŒçš„<code>ObjectOutputStream</code>å¯¹è±¡ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨<code>writeUnshared</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Writes an "unshared" object to the ObjectOutputStream.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeUnshared</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        writeObject0(obj, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">            writeFatalException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h2><ul><li>ç®€å•ï¼Œåªéœ€è¦å®ç°æ¥å£</li><li>åºåˆ—åŒ–çš„å­—èŠ‚æµå¯ä»¥åœ¨æ–‡ä»¶ã€ç½‘ç»œä¸­ä¼ é€’ï¼Œå¯ä»¥æŒä¹…åŒ–ä¿å­˜</li><li>æ€§èƒ½å·®ï¼Œåºåˆ—åŒ–è¿‡ç¨‹å¤§é‡ä½¿ç”¨åå°„å’Œä¸´æ—¶å˜é‡</li></ul><h1 id="Externalizable"><a href="#Externalizable" class="headerlink" title="Externalizable"></a>Externalizable</h1><p><code>Externalizable</code>ç»§æ‰¿è‡ª<code>Serializable</code>ã€‚</p><p>ç”¨æˆ·éœ€è¦é€šè¿‡<code>writeExternal(ObjectOutput out)</code>å’Œ<code>readExternal(ObjectInput in)</code>å®ç°åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ç»†èŠ‚ï¼Œå¹¶ä¸”éœ€è¦ä¸€ä¸ªæ˜ç¡®å®ç°çš„<strong><code>public no-arg constructor</code></strong></p><h2 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewClass</span> <span class="keyword">implements</span> <span class="title">Externalizable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> anInt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> String string = <span class="string">"string"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long aLong = <span class="number">10L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> <span class="keyword">float</span> aFloat = <span class="number">10F</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewClass</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.writeInt(anInt);</span><br><span class="line">        out.writeObject(string);</span><br><span class="line">        out.writeLong(aLong);</span><br><span class="line">        out.writeFloat(aFloat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        anInt = in.readInt();</span><br><span class="line">        string = (String) in.readObject();</span><br><span class="line">        aLong = in.readLong();</span><br><span class="line">        aFloat = in.readFloat();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"NewClass&#123;"</span> +</span><br><span class="line">                <span class="string">"anInt="</span> + anInt +</span><br><span class="line">                <span class="string">", string='"</span> + string + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", aFloat="</span> + aFloat +</span><br><span class="line">                <span class="string">", aLong="</span> + aLong +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>çœ‹æºç å¯ä»¥çŸ¥é“ï¼Œå¦‚æœæ£€æµ‹åˆ°å½“å‰å¯¹è±¡æ˜¯<code>Externalizable</code>æ—¶ï¼Œå°±ä¼šå»è°ƒç”¨è¯¥å¯¹è±¡çš„<code>writeExternalæ–¹æ³•</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Externalizable</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">// <span class="title">writeObject0</span> æ–¹æ³•ä¸­ï¼š</span></span><br><span class="line"><span class="class">            <span class="title">if</span> (<span class="title">obj</span> <span class="title">instanceof</span> <span class="title">String</span>) </span>&#123;</span><br><span class="line">                writeString((String) obj, unshared);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isArray()) &#123;</span><br><span class="line">                writeArray(obj, desc, unshared);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Enum) &#123;</span><br><span class="line">                writeEnum((Enum&lt;?&gt;) obj, desc, unshared);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Serializable) &#123;</span><br><span class="line">                writeOrdinaryObject(obj, desc, unshared);<span class="comment">//å¦‚æœæ˜¯Serializableå°±æ‰§è¡Œè¿™ä¸ª</span></span><br><span class="line">            &#125; </span><br><span class="line"><span class="comment">// writeOrdinaryObjectæ–¹æ³•ä¸­ï¼š</span></span><br><span class="line">            <span class="keyword">if</span> (desc.isExternalizable() &amp;&amp; !desc.isProxy()) &#123;</span><br><span class="line">                writeExternalData((Externalizable) obj);<span class="comment">//å¦‚æœæ˜¯Externalizableå°±æ‰§è¡Œè¿™ä¸ª</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeSerialData(obj, desc);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// writeExternalDataæ–¹æ³•ä¸­</span></span><br><span class="line"><span class="comment">// Writes externalizable data of given object by invoking its writeExternal() method.</span></span><br><span class="line">            <span class="keyword">if</span> (protocol == PROTOCOL_VERSION_1) &#123;</span><br><span class="line">                obj.writeExternal(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bout.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">                obj.writeExternal(<span class="keyword">this</span>);</span><br><span class="line">                bout.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">                bout.writeByte(TC_ENDBLOCKDATA);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h2 id="ä¼˜ç¼ºç‚¹-1"><a href="#ä¼˜ç¼ºç‚¹-1" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h2><ul><li>æ¯”<code>Serializable</code>éº»çƒ¦ï¼Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–éƒ½éœ€è¦ç”¨æˆ·è‡ªå·±å®ç°</li><li>çµæ´»ï¼Œå¯ä»¥è‡ªå®šä¹‰è¦å‚ä¸åˆ°åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å˜é‡</li></ul><h1 id="Parcelable"><a href="#Parcelable" class="headerlink" title="Parcelable"></a>Parcelable</h1><p><code>Parcelable</code>æ˜¯Androidä¸ºäº†è§£å†³<code>Serializable</code>æ€§èƒ½é—®é¢˜è€Œæ¨å‡ºçš„,ä¸»è¦ç”¨åœ¨Androidçš„<code>Intent</code>æˆ–<code>çº¿ç¨‹é—´é€šä¿¡</code>ä¸­ã€‚</p><p><code>Parcelable</code>é€šè¿‡<code>Parcel</code>ä¼ è¾“åˆ°<code>IBinder</code>ä¸­ï¼Œä»è€Œå®ç°è·¨è¿›ç¨‹ä¼ è¾“ã€‚</p><blockquote><p>å¯¹äº<code>kotlin</code>è¯­è¨€æ¥è¯´ï¼ŒAndroid Studioè‡ªåŠ¨ç”Ÿæˆçš„<code>Parcelable</code>ä»£ç ä¸ä¼šå¤„ç†valå˜é‡ï¼ˆå› ä¸ºè¿™äº›å˜é‡ä¸ä¼šå˜åŒ–ï¼‰</p><p>æ­¤å¤–ï¼Œ<code>Parcelable</code>åœ¨ååºåˆ—åŒ–æ—¶ï¼Œè°ƒç”¨<code>parcel.readParcelable(classLoader)</code>ä¼ å…¥çš„æ˜¯<code>ClassLoader</code>ã€‚</p></blockquote><h2 id="å®ç°-2"><a href="#å®ç°-2" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ª<code>Parcelable</code>çš„å®ç°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AParcelable</span></span>() : Parcelable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»Parcelä¸­æ¢å¤æ•°æ®ï¼Œå¿…é¡»æŒ‰ç…§å†™å…¥çš„é¡ºåºè¯»å–</span></span><br><span class="line">    <span class="keyword">constructor</span>(parcel: Parcel) : <span class="keyword">this</span>() &#123;</span><br><span class="line">        i = parcel.readInt()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å˜é‡å†™å…¥åˆ°Parcelä¸­ï¼Œå¿…é¡»ä¸è¯»å–çš„é¡ºåºå¯¹åº”</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeToParcel</span><span class="params">(parcel: <span class="type">Parcel</span>, flags: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        parcel.writeInt(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶æè¿°ï¼Œä¸€èˆ¬é»˜è®¤ä¸º0</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿™ä¸ªå¯¹è±¡çš„writeToParcelæ–¹æ³•çš„è¾“å‡ºä¸­æœ‰ç‰¹æ®Šçš„å¯¹è±¡åˆ™ä¼ é€’å¯¹åº”çš„æè¿°ä»£ç </span></span><br><span class="line">    <span class="comment">// å¦‚ï¼šå¦‚æœåŒ…å«ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦FileDescriptorï¼Œå°±è¦è¿”å›CONTENTS_FILE_DESCRIPTOR</span></span><br><span class="line">    <span class="comment">//  https://developer.android.google.cn/reference/android/os/Parcelable.html#CONTENTS_FILE_DESCRIPTOR</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">describeContents</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿…é¡»æœ‰è¿™ä¸ªå˜é‡ï¼Œç”¨æ¥ä»Parcelä¸­åˆ›å»ºParcelableç±»</span></span><br><span class="line">    <span class="comment">// åœ¨JAVAä¸­æ˜¯public static final Creator&lt;Book&gt; CREATOR = new Creator&lt;Book&gt;() &#123;...&#125;</span></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> CREATOR : Parcelable.Creator&lt;AParcelable&gt; &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFromParcel</span><span class="params">(parcel: <span class="type">Parcel</span>)</span></span>: AParcelable &#123;</span><br><span class="line">            <span class="keyword">return</span> AParcelable(parcel)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a new array of the Parcelable class.</span></span><br><span class="line">        <span class="comment">// Returns an array of the Parcelable class, with every entry</span></span><br><span class="line">        <span class="comment">// initialized to null.</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newArray</span><span class="params">(size: <span class="type">Int</span>)</span></span>: Array&lt;AParcelable?&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> arrayOfNulls(size)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åŸç†å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://www.kancloud.cn/xcy396/android_tech/1296524" target="_blank" rel="noopener">Parcelableæºç åˆ†æ</a></p><h2 id="ä¼˜ç¼ºç‚¹-2"><a href="#ä¼˜ç¼ºç‚¹-2" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h2><ul><li>æ€§èƒ½å¥½ï¼Œ<code>Parcelable</code>æ¥å£æ¯”<code>Serializable</code>æ¥å£æ•ˆç‡æ›´é«˜ï¼Œæ€§èƒ½æ–¹é¢é«˜å‡º10å¤šå€ <a href="https://www.kancloud.cn/xcy396/android_tech/1296524" target="_blank" rel="noopener">^Parcelableæºç åˆ†æ</a>:</li><li>è¾ƒå¤æ‚ï¼Œéœ€è¦è‡ªå·±å®ç°å¯¹è±¡çš„åºåˆ—åŒ–å†…å®¹</li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸€èˆ¬éœ€è¦æŒä¹…åŒ–ä¿å­˜æ•°æ®æˆ–åœ¨ç½‘ç»œé—´ä¼ è¾“æ—¶æ¨èä½¿ç”¨<code>Serializable</code>æˆ–è€…<code>Externalizable</code>ã€‚</p><p>åœ¨Androidä¸­<code>Activity</code>ä¹‹é—´ç­‰ä¼ é€’å¯¹è±¡ï¼Œä»¥åŠè·¨è¿›ç¨‹ä¼ é€’å¯¹è±¡ç­‰æ—¶ä½¿ç”¨<code>Parcelable</code>ä»¥èŠ‚çœæ€§èƒ½ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="http://darryrzhong.xyz/2019/09/15/Androidä¹‹åºåˆ—åŒ–è¯¦è§£/" target="_blank" rel="noopener">Androidä¹‹åºåˆ—åŒ–è¯¦è§£</a></p><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-serial/index.html" target="_blank" rel="noopener">Java åºåˆ—åŒ–çš„é«˜çº§è®¤è¯†</a></p><p><a href="https://juejin.im/post/5d7206c5f265da03ab427181#heading-0" target="_blank" rel="noopener">https://juejin.im/post/5d7206c5f265da03ab427181#heading-0</a></p><p><a href="https://www.javacodegeeks.com/2019/08/serialization-everything-java-serialization-explained.htmlhttps://juejin.im/post/5ce3cdc8e51d45777b1a3cdf#heading-0" target="_blank" rel="noopener">https://www.javacodegeeks.com/2019/08/serialization-everything-java-serialization-explained.htmlhttps://juejin.im/post/5ce3cdc8e51d45777b1a3cdf#heading-0</a></p><p><a href="https://blog.csdn.net/qq_16628781/article/details/70049623" target="_blank" rel="noopener">https://blog.csdn.net/qq_16628781/article/details/70049623</a></p><p><a href="https://cl0610.github.io/effective-java-learning/ç¬¬åç«  åºåˆ—åŒ–/77.å•ä¾‹æ¨¡å¼ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve.html" target="_blank" rel="noopener">77.å•ä¾‹æ¨¡å¼ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve</a></p><p>Pareclableå®ç°åŸç†ï¼š<a href="https://juejin.im/post/5a3b24ab6fb9a04515440bd7" target="_blank" rel="noopener">Parcelableæœ€å¼ºè§£æ</a></p><p>Parcelableä½¿ç”¨ï¼š<a href="https://www.jianshu.com/p/32a2ec8f35ae" target="_blank" rel="noopener">è¯¦ç»†ä»‹ç»Androidä¸­Parcelableçš„åŸç†å’Œä½¿ç”¨æ–¹æ³•</a></p><p><a href="https://www.kancloud.cn/xcy396/android_tech/1296524" target="_blank" rel="noopener">Parcelableæºç åˆ†æ</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidä¸­çš„SpareArrayå’ŒArrayMapå®ç°åˆ†æ</title>
      <link href="/blog/posts/c2f123c/"/>
      <url>/blog/posts/c2f123c/</url>
      
        <content type="html"><![CDATA[<p>æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¸¸ç”¨çš„å­˜å‚¨é”®å€¼å¯¹çš„æ•°æ®ç»“æ„æ˜¯<code>HashMap</code>ï¼Œæ ¹æ®<a href="https://xiaoyong.ml/blog/posts/ff927bd4/" target="_blank" rel="noopener">Javaç¬”è®°ä¹‹HashMapä¿å­˜æ•°æ®</a>å’Œ<a href="https://xiaoyong.ml/blog/posts/b0793c74/" target="_blank" rel="noopener">Javaç¬”è®°ä¹‹è®¡ç®—Javaå¯¹è±¡çš„å¤§å°åŠå…¶åº”ç”¨</a>å¯ä»¥çŸ¥é“ï¼Œ<code>HashMap</code>å­˜å‚¨<strong>é”®å€¼å¯¹</strong>ä¼šå ç”¨æ¯”è¾ƒå¤šçš„å†…å­˜æ§ä»¶ï¼Œè€Œå¯¹äºå†…å­˜é™åˆ¶è¾ƒå¤§çš„Androidå¹³å°æ¥è¯´ï¼Œä¸ºäº†é¿å…è¿™ç§æµªè´¹ï¼Œå®˜æ–¹æ¨èæˆ‘ä»¬ä½¿ç”¨<code>SpareArray</code>å’Œ<code>ArrayMap</code>ï¼Œæœ¬æ–‡å¯¹è¿™ä¸¤ä¸ªç±»çš„å®ç°è¿›è¡Œåˆ†ææ¯”è¾ƒã€‚</p><p><strong><code>SpareArray</code>ä»¥åŠä»–çš„è¡ç”Ÿç±»</strong>éƒ½æ˜¯ä»¥<strong>åŸºæœ¬ç±»å‹</strong>ä¸º<code>key</code>ï¼Œå› ä¸ºé¿å…äº†<em>è‡ªåŠ¨è£…ç®±</em>ï¼Œå¹¶ä¸”<strong>ç”¨æ•°ç»„ç›´æ¥ä¿å­˜keyã€value</strong>ï¼ˆè€Œéåƒ<code>HashMap</code>é‚£æ ·å°†å…¶å°è£…ä¸º<code>Node</code>å¯¹è±¡åå†ä¿å­˜ï¼‰ï¼Œå› è€ŒèŠ‚çœäº†å†…å­˜ã€‚</p><p><strong><code>ArrayMap</code></strong>åˆ™æ”¯æŒ<strong>æ‰€æœ‰ç±»å‹çš„key</strong>ï¼Œä»–æ˜¯<strong>å°†<code>key</code>å’Œ<code>value</code>å…¨éƒ¨ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­</strong>ï¼ˆ<code>n</code>ä½ä¸º<code>key</code>ï¼Œ<code>n+1</code>ä½ä¸º<code>value</code>ï¼‰ï¼Œé¿å…äº†å°†å…¶å°è£…ä¸º<code>Node</code>å¯¹è±¡å¸¦æ¥çš„å†…å­˜æ¶ˆè€—ã€‚</p><p><strong>å½“è¦ä¿å­˜çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼ˆå°äºå‡ åƒä¸ªï¼‰çš„æ—¶å€™ï¼Œå¦‚æœKEYæ˜¯åŸºæœ¬ç±»å‹ï¼Œæ¨èä½¿ç”¨<code>SparseArray</code>åŠå…¶è¡ç”Ÿç±»ä»¥èŠ‚çœå†…å­˜ï¼Œå¦‚æœKEYæ˜¯å…¶ä»–ç±»å‹åˆ™ä½¿ç”¨<code>ArrayMap</code>;å¦åˆ™ä½¿ç”¨<code>HashMap</code>æ›´åŠ é«˜æ•ˆ</strong>ã€‚</p><h1 id="SpareArray"><a href="#SpareArray" class="headerlink" title="SpareArray"></a>SpareArray</h1><p><code>SpareArray</code>ä»¥åŠä»–çš„è¡ç”Ÿç±»ä¸»è¦ç”¨äº<strong>ä»¥<code>åŸºæœ¬ç±»å‹</code>ä¸º<code>key</code>ä¿å­˜éå¤§é‡æ•°æ®çš„åœºæ™¯</strong>ã€‚</p><p>ç›¸æ¯”<code>HashMap</code>è€Œè¨€ï¼Œä»–çš„ä¼˜ç‚¹ä¸»è¦åœ¨äº<strong>æ²¡æœ‰å¯¹ä¿å­˜çš„æ•°æ®äºŒæ¬¡å°è£…</strong>ï¼Œæ²¡æœ‰å¯¹åŸºæœ¬ç±»å‹çš„æ•°æ®<strong>è‡ªåŠ¨è£…ç®±</strong>ï¼Œå­˜å‚¨å•ä¸ªæ•°æ®çš„æˆæœ¬å°ï¼Œä¹Ÿæ²¡æœ‰<code>hash</code>è®¡ç®—ã€‚</p><p>ä½†ä»–åœ¨æ·»åŠ æ•°æ®æ—¶éœ€è¦æ‰©å±•æ•°ç»„(æ¶‰åŠåˆ°æ–°å»ºã€å¤åˆ¶æ•°ç»„ï¼Œ<code>gc()</code>ç­‰)ï¼Œ<del>åœ¨åˆ é™¤æ•°æ®æ—¶éœ€è¦ç¼©å‡æ•°ç»„</del> (æŸ¥çœ‹<code>gc()</code>ç­‰æºç å‘ç°ä»–çš„æ•°ç»„åªä¼šå¢åŠ ï¼Œä¸ä¼šç¼©å‡)ï¼Œä»¥åŠé€šè¿‡äºŒåˆ†æ³•æŸ¥æ‰¾ç´¢å¼•éƒ½ä¼šæ¶ˆè€—æ€§èƒ½ã€‚</p><blockquote><p>ä¸ºäº†é¿å…æ¯æ¬¡åˆ é™¤æ—¶éƒ½éœ€è¦ç¼©å‡æ•°ç»„ï¼Œ<code>SpareArray</code>åœ¨åˆ é™¤æ•°ç»„æ—¶åªä¼šå°†å…¶èµ‹å€¼ä¸º<code>DELETED</code>ï¼Œåœ¨ä¸‹æ¬¡è°ƒç”¨å…¶<code>private void gc()</code>æ–¹æ³•æ—¶ä¸¢å¼ƒæ‰è¿™äº›æ•°æ®</p></blockquote><p>å…ˆçœ‹ä¸€ä¸‹<code>SpareArray</code>çš„ç»“æ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SparseArray</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mGarbage = <span class="keyword">false</span>; <span class="comment">//æ˜¯å¦è°ƒç”¨gc()æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] mKeys;<span class="comment">//æ‰€æœ‰çš„key</span></span><br><span class="line">    <span class="keyword">private</span> Object[] mValues;<span class="comment">//æ‰€æœ‰çš„value</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSize;<span class="comment">//æ‰€ä¿å­˜çš„æ•°æ®ä¸ªæ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="void-put-int-key-E-value"><a href="#void-put-int-key-E-value" class="headerlink" title="void put(int key, E value)"></a>void put(int key, E value)</h2><p>æ·»åŠ æ–¹æ³•å…ˆç”¨<strong>äºŒåˆ†æ³•</strong>æŸ¥æ‰¾<code>key</code>å¯¹åº”çš„ä½ç½®ï¼š</p><ul><li>å¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¦†ç›–</li><li>å¦‚æœæ²¡æœ‰ï¼Œåˆ™<strong>å–å</strong>å¾—åˆ°åº”è¯¥<code>æ’å…¥çš„ä½ç½®</code>ï¼Œå¹¶åˆ†åˆ«æ’å…¥<code>key</code>å’Œ<code>value</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, E value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆç”¨äºŒåˆ†æ³•æŸ¥æ‰¾keyå¯¹åº”çš„ç´¢å¼•,æ‰¾åˆ°çš„è¯è¿”å›å¯¹åº”ç´¢å¼•ï¼Œ</span></span><br><span class="line">  <span class="comment">// å¦åˆ™è¿”å›keyåº”è¯¥æ’å…¥çš„ä½ç½®çš„å–åå€¼</span></span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå·²å­˜åœ¨å€¼åˆ™ç›´æ¥è¦†ç›–</span></span><br><span class="line">        mValues[i] = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¯¹äºŒåˆ†æ³•æŸ¥æ‰¾åˆ°çš„å€¼å†å–åï¼Œå¾—åˆ°keyåº”è¯¥æ’å…¥çš„ä½ç½®</span></span><br><span class="line">        i = ~i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</span><br><span class="line">            mKeys[i] = key;</span><br><span class="line">            mValues[i] = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123;</span><br><span class="line">            gc();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Search again because indices may have changed.</span></span><br><span class="line">            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// public static &lt;T&gt; T[] insert(T[] array, int currentSize, int index, T element)</span></span><br><span class="line">      <span class="comment">// Inserts an element into the array at the specified index,</span></span><br><span class="line">      <span class="comment">// growing the array if there is no more room.</span></span><br><span class="line">        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);</span><br><span class="line">        mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);</span><br><span class="line">        mSize++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="E-get-int-key"><a href="#E-get-int-key" class="headerlink" title="E get(int key)"></a>E get(int key)</h2><p>è·å–æ•°æ®ï¼Œå…ˆç”¨<strong>äºŒåˆ†æ³•</strong>æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°å°±è¿”å›<code>å¯¹åº”çš„å€¼</code>ï¼Œå¦åˆ™è¿”å›<code>null</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(key, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> key, E valueIfKeyNotFound)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || mValues[i] == DELETED) &#123;</span><br><span class="line">        <span class="keyword">return</span> valueIfKeyNotFound;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (E) mValues[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="void-remove-int-key"><a href="#void-remove-int-key" class="headerlink" title="void remove(int key)"></a>void remove(int key)</h2><p>åˆ é™¤<code>key</code>ä»¥åŠ<code>å¯¹åº”çš„æ•°æ®</code>ã€‚</p><p>åŒæ ·å…ˆç”¨<strong>äºŒåˆ†æ³•</strong>æŸ¥æ‰¾<code>å¯¹åº”ä½ç½®</code>ï¼Œæœ‰çš„è¯åˆ™æ ‡è®°ä¸º<code>DELETED</code>ï¼Œ<strong>ç­‰å¾…ä¸‹æ¬¡<code>gc()</code>æ—¶ä¸¢å¼ƒ</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        delete(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mValues[i] != DELETED) &#123;</span><br><span class="line">            mValues[i] = DELETED;</span><br><span class="line">            mGarbage = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gc"><a href="#gc" class="headerlink" title="gc()"></a>gc()</h2><p>åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œåˆ é™¤æ•°æ®æ—¶ï¼Œ<code>mGarbage</code>è¢«æ ‡è®°ä¸º<code>true</code>ï¼Œè¿™æ ·å½“ä¸‹ä¸€æ¬¡è¿›è¡Œ<code>put/valueAt/append/size</code>ç­‰æ¶‰åŠåˆ°æ•°ç»„å¤§å°æŸ¥è¯¢ã€æ”¹åŠ¨ç­‰æ—¶ï¼Œå°±å‡ºè§¦å‘<code>gc()</code>ä»¥ä¾¿æ•´ç†æ•°ç»„ç»“æ„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Log.e("SparseArray", "gc start with " + mSize);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> n = mSize;</span><br><span class="line">    <span class="keyword">int</span> o = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[] keys = mKeys;</span><br><span class="line">    Object[] values = mValues;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        Object val = values[i];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è¿™é‡Œçš„æ“ä½œåªæ˜¯å°†æ²¡æœ‰è¢«åˆ é™¤çš„æ•°æ®ç§»åŠ¨åˆ°äº†æ•°ç»„çš„å‰é¢</span></span><br><span class="line">      <span class="comment">// è€Œä¿è¯äº†æ•°ç»„åé¢éƒ½æ˜¯DELETEDæˆ–nullï¼Œæ–¹ä¾¿åç»­æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (val != DELETED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != o) &#123;</span><br><span class="line">                keys[o] = keys[i];</span><br><span class="line">                values[o] = val;</span><br><span class="line">                values[i] = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            o++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mGarbage = <span class="keyword">false</span>;</span><br><span class="line">    mSize = o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HashMapä¸SpareArrayåŠå…¶è¡ç”Ÿç±»å¯¹åº”å…³ç³»"><a href="#HashMapä¸SpareArrayåŠå…¶è¡ç”Ÿç±»å¯¹åº”å…³ç³»" class="headerlink" title="HashMapä¸SpareArrayåŠå…¶è¡ç”Ÿç±»å¯¹åº”å…³ç³»"></a>HashMapä¸SpareArrayåŠå…¶è¡ç”Ÿç±»å¯¹åº”å…³ç³»</h2><p>å‚è€ƒ<a href="https://android.jlelse.eu/app-optimization-with-arraymap-sparsearray-in-android-c0b7de22541a" target="_blank" rel="noopener">ä¸‹å›¾</a></p><p><img src="https://jixiaoyong.github.io/images/20191222131219.png" alt></p><h1 id="ArrayMap"><a href="#ArrayMap" class="headerlink" title="ArrayMap"></a>ArrayMap</h1><p><code>ArrayMap</code>å®ç°äº†<code>Map&lt;K, V&gt;</code>æ¥å£ï¼Œä»–çš„APIå’Œ<code>HashMap</code>ç›¸å·®æ— å‡ ï¼Œä½†æ˜¯ç”±äº<strong>æ²¡æœ‰å¯¹æ•°æ®å†åŒ…è£…</strong>ï¼Œ<strong>åŠ¨æ€è°ƒæ•´æ•°ç»„çš„å¤§å°</strong>ï¼Œä¸€å®šèŒƒå›´å†…ä»–æ¯”<code>HashMap</code>å†…å­˜æ•ˆç‡é«˜ã€‚</p><p>ä½†æ˜¯å¦‚æœä¿å­˜å¤§é‡æ•°æ®ï¼ˆè¶…è¿‡åƒä½ï¼‰æ—¶ï¼Œç”±äºä»–éœ€è¦<strong>äºŒåˆ†æ³•æŸ¥æ‰¾</strong>çš„å½±å“ä¼šæ¯”<code>HashMap</code>æ…¢å¾ˆå¤šã€‚</p><blockquote><p><strong><code>ArrayMap</code>ç‰¹æ®Šä¹‹å¤„åœ¨äºå°†<code>key</code>ï¼Œ<code>value</code>ä¿å­˜åˆ°äº†åŒä¸€ä¸ªæ•°ç»„mArrayä¸­ï¼ˆnä½ä¿å­˜keyï¼Œn+1ä½ä¿å­˜value</strong>ï¼‰ã€‚</p></blockquote><p>å…ˆçœ‹ä¸€ä¸‹<code>ArrayMap</code>çš„ç»“æ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Object[] mBaseCache;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> mBaseCacheSize;</span><br><span class="line"><span class="keyword">static</span> Object[] mTwiceBaseCache;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> mTwiceBaseCacheSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> mIdentityHashCode;<span class="comment">//æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨System.identityHashCode(key)è·å–keyçš„HashCode</span></span><br><span class="line"><span class="comment">//System.identityHashCode(key)æ–¹æ³•æ— è®ºç±»æ˜¯å¦é‡å†™äº†hashCode()æ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">//éƒ½ä¼šè°ƒç”¨Object.identityHashCode(key)æ¥è·å–å¯¹è±¡çš„hashCode</span></span><br><span class="line"><span class="keyword">int</span>[] mHashes;<span class="comment">//å­˜å‚¨æ‰€æœ‰keyçš„hashå€¼</span></span><br><span class="line">Object[] mArray;<span class="comment">//å­˜å‚¨keyå’Œvalueï¼Œå¤§å°æ˜¯mHashesçš„ä¸¤å€</span></span><br><span class="line"><span class="comment">//nä½ä¿å­˜keyï¼Œn+1ä½ä¿å­˜value</span></span><br><span class="line"><span class="keyword">int</span> mSize;</span><br><span class="line">MapCollections&lt;K, V&gt; mCollections;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨æ—¶ï¼š</p><ol><li><p>è®¡ç®—<code>key</code>çš„<code>hashå€¼</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash = mIdentityHashCode ? System.identityHashCode(key) : key.hashCode();</span><br></pre></td></tr></table></figure></li><li><p>ç„¶åä½¿ç”¨<code>indexOf()</code>åœ¨<code>mHashes</code>ä¸­è¿›è¡ŒäºŒåˆ†æ³•æŸ¥æ‰¾å¯¹åº”çš„<code>index</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = indexOf(key, hash);</span><br></pre></td></tr></table></figure><p><code>indexOf()</code>æ–¹æ³•ä¼šå…ˆç”¨<strong>äºŒåˆ†æ³•</strong>æŸ¥æ‰¾<code>hash</code>å¯¹åº”çš„<code>index</code>,å¦‚æœ<code>index&lt;0</code>åˆ™è¿”å›<code>index</code>ï¼›å¦åˆ™åœ¨å¯¹æ¯”<code>mArray</code>ä¸­å¯¹åº”ä½ç½®<code>mArray[index&lt;&lt;1]</code>çš„<code>key</code>ä¸è¦<code>æŸ¥è¯¢çš„key</code>ï¼š</p><ul><li>ä¸¤è€…ä¸€è‡´ï¼šè¿”å›<code>index</code></li><li>ä¸¤è€…ä¸ä¸€è‡´ï¼šä»<code>index</code>å¼€å§‹ï¼Œ<strong>å…ˆå‘åï¼Œå†å‘å‰</strong>æŸ¥è¯¢æ˜¯å¦æœ‰ç›¸åŒçš„<code>key</code>,å¦‚æœæœ‰è¿”å›<code>å¯¹åº”index</code></li><li>ä»¥ä¸Šéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼š<strong>å¯¹<code>mHashes</code>ä¸­<code>æœ€åä¸€ä¸ªä¸keyçš„hashä¸€è‡´çš„åä¸€ä½index</code>å–å</strong>ï¼Œå¹¶è¿”å›</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(Object key, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Important fast case: if nothing is in here, nothing to look for.</span></span><br><span class="line">    <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> index = binarySearchHashes(mHashes, N, hash);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the hash code wasn't found, then we have no entry for this key.</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the key at the returned index matches, that's what we want.</span></span><br><span class="line">    <span class="keyword">if</span> (key.equals(mArray[index&lt;&lt;<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Search for a matching key after the index.</span></span><br><span class="line">    <span class="keyword">int</span> end;</span><br><span class="line">    <span class="keyword">for</span> (end = index + <span class="number">1</span>; end &lt; N &amp;&amp; mHashes[end] == hash; end++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.equals(mArray[end &lt;&lt; <span class="number">1</span>])) <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Search for a matching key before the index.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; mHashes[i] == hash; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.equals(mArray[i &lt;&lt; <span class="number">1</span>])) <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Key not found -- return negative value indicating where a</span></span><br><span class="line">    <span class="comment">// new entry for this key should go.  We use the end of the</span></span><br><span class="line">    <span class="comment">// hash chain to reduce the number of array entries that will</span></span><br><span class="line">    <span class="comment">// need to be copied when inserting.</span></span><br><span class="line">    <span class="keyword">return</span> ~end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="V-put-K-key-V-value"><a href="#V-put-K-key-V-value" class="headerlink" title="V put(K key, V value)"></a>V put(K key, V value)</h2><p>å½“æ·»åŠ <code>item</code>æ—¶ï¼ŒæŒ‰ç…§å‰è¿°è§„åˆ™ï¼Œå…ˆåœ¨<code>mArray</code>ä¸­æŸ¥æ‰¾<code>key</code>å¯¹åº”çš„<code>ç´¢å¼•index</code>ï¼š</p><ul><li><p><code>index &gt;= 0</code> ï¼šå·²ç»æœ‰é”®ä¸º<code>key</code>çš„æ•°æ®ï¼Œç›´æ¥è¦†ç›–æ—§å€¼å¹¶è¿”å›</p></li><li><p><code>index &lt; 0</code>ï¼šæ²¡æœ‰é”®ä¸º<code>key</code>çš„æ•°æ®ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œå¹¶ä¿å­˜å¯¹åº”æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">index = ~index;<span class="comment">//ä¸Šæ–‡indexOf()ä¸­è®¡ç®—å¾—å‡ºçš„keyåº”è¯¥æ·»åŠ çš„ä½ç½®</span></span><br><span class="line">mHashes[index] = hash;</span><br><span class="line">mArray[index&lt;&lt;<span class="number">1</span>] = key;</span><br><span class="line">mArray[(index&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>] = value;</span><br></pre></td></tr></table></figure></li></ul><h2 id="V-get-Object-key"><a href="#V-get-Object-key" class="headerlink" title="V get(Object key)"></a>V get(Object key)</h2><p><code>get()</code>æ–¹æ³•å°±æ¯”è¾ƒç®€å•äº†ï¼Œå…ˆæŸ¥æ‰¾<code>key</code>çš„ç´¢å¼•ï¼Œç„¶åå–å‡º<code>å¯¹åº”çš„æ•°æ®value</code>å¹¶è¿”å›å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> index = indexOfKey(key);</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> ? (V)mArray[(index&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>] : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="V-remove-Object-key"><a href="#V-remove-Object-key" class="headerlink" title="V remove(Object key)"></a>V remove(Object key)</h2><p><code>remove()</code>æ–¹æ³•ä¹Ÿä¼šå…ˆä½¿ç”¨<code>indexOfKey()</code>è®¡ç®—<code>keyçš„index</code>ï¼Œç„¶ååˆ é™¤<code>å¯¹åº”ä½ç½®çš„æ•°æ®</code>ã€‚</p><p>æ­¤å¤–ï¼Œå¦‚æœ<code>mHashes.length &gt; (BASE_SIZE*2) &amp;&amp; mSize &lt; mHashes.length/3</code>çš„è¯ï¼Œè¿˜ä¼šç¼©å‡<code>æ•°ç»„çš„å¤§å°</code>ä¸º<code>osize &gt; (BASE_SIZE*2) ? (osize + (osize&gt;&gt;1)) : (BASE_SIZE*2)</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">removeAt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...å…¶ä»–ä»£ç </span></span><br><span class="line">  <span class="keyword">if</span>(mHashes.length &gt; (BASE_SIZE*<span class="number">2</span>) &amp;&amp; mSize &lt; mHashes.length/<span class="number">3</span>)&#123;</span><br><span class="line">    <span class="comment">//...å…¶ä»–ä»£ç </span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> n = osize &gt; (BASE_SIZE*<span class="number">2</span>) ? (osize + (osize&gt;&gt;<span class="number">1</span>)) : (BASE_SIZE*<span class="number">2</span>);</span><br><span class="line">    allocArrays(n);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...å…¶ä»–ä»£ç </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocArrays</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//...å…¶ä»–ä»£ç </span></span><br><span class="line">   mHashes = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">   mArray = <span class="keyword">new</span> Object[size&lt;&lt;<span class="number">1</span>];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://android.googlesource.com/platform/frameworks/base.git/+/master/core/java/com/android/internal/util/GrowingArrayUtils.java" target="_blank" rel="noopener">GrowingArrayUtils.java æºç </a></p><p><a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/util/SparseArray.java" target="_blank" rel="noopener">SparseArray.java æºç </a></p><p><a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/util/ArrayMap.java" target="_blank" rel="noopener">ArrayMap.java æºç </a></p><p><a href="https://android.jlelse.eu/app-optimization-with-arraymap-sparsearray-in-android-c0b7de22541a" target="_blank" rel="noopener">App optimization with ArrayMap &amp; SparseArray in Android</a></p><p><a href="https://xiaoyong.ml/blog/posts/ff927bd4/" target="_blank" rel="noopener">Javaç¬”è®°ä¹‹HashMapä¿å­˜æ•°æ®</a></p><p><a href="https://xiaoyong.ml/blog/posts/b0793c74/" target="_blank" rel="noopener">Javaç¬”è®°ä¹‹è®¡ç®—Javaå¯¹è±¡çš„å¤§å°åŠå…¶åº”ç”¨</a></p><p><a href="https://extremej.itscoder.com/sparsearray_source_analyse/" target="_blank" rel="noopener">SparseArray çš„ä½¿ç”¨åŠå®ç°åŸç†</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç¬”è®°ä¹‹è®¡ç®—Javaå¯¹è±¡çš„å¤§å°åŠå…¶åº”ç”¨</title>
      <link href="/blog/posts/b0793c74/"/>
      <url>/blog/posts/b0793c74/</url>
      
        <content type="html"><![CDATA[<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p><strong>æ³¨æ„ é™¤éç‰¹æ®Šè¯´æ˜ï¼Œä»¥ä¸‹æ‰€è¯´çš„è®¡ç®—Javaå¯¹è±¡å¤§å°ï¼Œä¸æ¶‰åŠè¯¥å¯¹è±¡æ‰€æŒæœ‰çš„å¯¹è±¡æœ¬èº«çš„å¤§å°ï¼Œåªè®¡ç®—è¯¥Javaå¯¹è±¡æœ¬èº«çš„å¤§å°ï¼ˆå…¶ä¸­å¼•ç”¨ç±»å‹å¯¹è±¡å¤§å°åªè®¡ç®—ä¸º4 bytesï¼‰ï¼Œå¦‚æœè¦éå†è®¡ç®—Javaå¯¹è±¡å¤§å°ï¼ˆåŒ…å«å…¶æŒæœ‰å¯¹è±¡çš„å¤§å°ï¼‰å¯ä»¥å‚è€ƒ<a href="https://www.javaworld.com/article/2077408/sizeof-for-java.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç«  Sizeof for Java</a></strong></p><p>ä¸€ä¸ªJavaå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¤§å°åŒ…æ‹¬ä»¥ä¸‹(ä»¥64ä½JVMå¯ç”¨å‹ç¼©ä¸ºä¾‹ï¼Œç»¼åˆ<a href="https://blog.csdn.net/ITer_ZC/article/details/41822719" target="_blank" rel="noopener">è¿™é‡Œ</a>å’Œ<a href="https://blog.csdn.net/u013380694/article/details/102739636" target="_blank" rel="noopener">è¿™é‡Œ</a>çš„ä¿¡æ¯æ•´ç†)ï¼š</p><table><thead><tr><th>åˆ†ç±»</th><th>å¤§å°ï¼ˆbyteï¼‰</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>å¯¹è±¡å¤´</td><td>8</td><td>ä¿å­˜å¯¹è±¡çš„ class ä¿¡æ¯ã€IDã€åœ¨è™šæ‹Ÿæœºä¸­çš„çŠ¶æ€</td></tr><tr><td>OopæŒ‡é’ˆ</td><td>4</td><td></td></tr><tr><td>æ•°æ®åŒº</td><td></td><td>å¯¹è±¡å®é™…åŒ…å«çš„æ•°æ®,å¼•ç”¨ç±»å‹å¤§å°ä¸º4 bytes</td></tr><tr><td>æ•°ç»„é•¿åº¦</td><td>4</td><td>åªæœ‰æ•°ç»„å¯¹è±¡æ‰æœ‰</td></tr><tr><td>8æ¯”ç‰¹å¯¹é½</td><td></td><td>å°†å¯¹è±¡æ€»å¤§å°å¯¹é½åˆ°8å­—èŠ‚æ‰€éœ€çš„å¡«å……</td></tr></tbody></table><blockquote><p>æ­¤å¤–ï¼Œå¦‚æœæ˜¯ï¼ˆéé™æ€ï¼‰å†…éƒ¨ç±»çš„è¯ï¼Œç”±äºä»–é»˜è®¤æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œæ‰€ä»¥ä¼šæ¯”æ™®é€šç±»çš„å¯¹è±¡å¤š4ä¸ªbyteã€‚</p><p><a href="https://stackoverflow.com/a/12193259/8389461" target="_blank" rel="noopener">https://stackoverflow.com/a/12193259/8389461</a></p></blockquote><p>å¯ä»¥å‚ç…§<a href="https://www.jianshu.com/p/9d729c9c94c4" target="_blank" rel="noopener">è¿™å¼ å›¾</a></p><p><img src="https://jixiaoyong.github.io/images/20191221191518.webp" alt="å›¾ç‰‡æ¥è‡ªhttps://www.jianshu.com/p/9d729c9c94c4"></p><p>å…¶ä¸­ï¼Œæ•°æ®åŒºå ç”¨çš„å¤§å°å¦‚ä¸‹ï¼š</p><p>ï¼ˆå›¾ç‰‡æ¥è‡ªäº<a href="https://speakerdeck.com/romainguy/android-memories?slide=29" target="_blank" rel="noopener">android-memories</a>ï¼‰</p><p><img src="https://jixiaoyong.github.io/images/20191221104050.png" alt="Size of data from speakerdeck.com"></p><p>#ç¤ºä¾‹</p><p>æ ¹æ®<a href="https://speakerdeck.com/romainguy" target="_blank" rel="noopener">Romain Guy</a>åœ¨<a href="https://speakerdeck.com/romainguy/android-memories?slide=34" target="_blank" rel="noopener">SpeakerDeck</a>ä¸­çš„è¯´æ³•ï¼š</p><blockquote><p>ä¸€ä¸ªç©ºçš„classå ç”¨äº†4+8=12ä¸ªbyteçš„å†…å­˜ï¼Œå†åŠ ä¸Š8æ¯”ç‰¹å¯¹é½ï¼Œå®é™…å ç”¨å¤§å°ä¸º16æ¯”ç‰¹ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Empty</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å ç”¨å¤§å°ï¼š</p><table><thead><tr><th>Allocation</th><th>Size in bytes</th></tr></thead><tbody><tr><td>dlmalloc å¼•ç”¨</td><td>4</td></tr><tr><td>Object overheadï¼ˆå¯¹è±¡å¤´ï¼‰</td><td>8</td></tr></tbody></table><p>Total  = 4 + 8 =12 bytes</p><p>ç»è¿‡<em>8-byte aligned</em>åï¼š total = 16 bytes</p><p><a href="https://speakerdeck.com/romainguy/android-memories?slide=34" target="_blank" rel="noopener">https://speakerdeck.com/romainguy/android-memories?slide=34</a></p></blockquote><p>æ­¤å¤–è¿˜æœ‰<strong>åŒ…å«äº†æ•°æ®çš„å¯¹è±¡</strong>å¤§å°è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20191221171816.png" alt="å›¾ç‰‡æ¥è‡ªhttps://speakerdeck.com/romainguy/android-memories?slide=42"></p><p>å¯¹äºæ•°ç»„çš„å¤§å°è®¡ç®—ï¼ˆå‚è€ƒ<a href="https://www.cnblogs.com/zhanjindong/p/3757767.html" target="_blank" rel="noopener">ä¸€ä¸ªJavaå¯¹è±¡åˆ°åº•å ç”¨å¤šå¤§å†…å­˜ï¼Ÿ</a>å’Œ<a href="https://speakerdeck.com/romainguy/android-memories?slide=54" target="_blank" rel="noopener">romainguy/android-memories</a>ï¼Œåè€…å…³äºæ•°ç»„å¤§å°çš„è®¡ç®—ä¸­<code>width&amp;padding = 8</code>çš„æ„ä¹‰å­˜ç–‘ï¼‰:</p><p>æŒ‰ç…§å¼€å¤´çš„å…¬å¼ï¼š<code>æ•°ç»„å¤§å° = 8 å¯¹è±¡å¤´ + 4 OopæŒ‡é’ˆ + 4 æ•°ç»„å¤§å°æ ‡è®°length + æ•°ç»„æ•°æ®å ç”¨å¤§å° + 8æ¯”ç‰¹å¯¹é½</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arr0å¤§å° = 8 + 4 + 4 + 0 + 8æ¯”ç‰¹å¯¹é½(0) = 16 bytes</span></span><br><span class="line"><span class="keyword">int</span> arr0 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// arr1å¤§å° = 8 + 4 + 4 + 4*1 + 8æ¯”ç‰¹å¯¹é½(4) = 16 + 4 = 20 + 8æ¯”ç‰¹å¯¹é½(4) = 24 bytes</span></span><br><span class="line"><span class="keyword">int</span> arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line"><span class="comment">// arr1å¤§å° = 8 + 4 + 4 + 4*10 + 8æ¯”ç‰¹å¯¹é½(0) = 16 + 40 = 56 + 8æ¯”ç‰¹å¯¹é½(0) = 56 bytes</span></span><br><span class="line"><span class="keyword">int</span> arra10 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><h1 id="è®¡ç®—å¯¹è±¡å¤§å°çš„å·¥å…·"><a href="#è®¡ç®—å¯¹è±¡å¤§å°çš„å·¥å…·" class="headerlink" title="è®¡ç®—å¯¹è±¡å¤§å°çš„å·¥å…·"></a>è®¡ç®—å¯¹è±¡å¤§å°çš„å·¥å…·</h1><p>å…·ä½“çš„å¦‚ä½•è®¡ç®—Javaä¸­Objectå¤§å°ï¼Œå¯ä»¥å‚è€ƒ<a href="https://stackoverflow.com/a/52682/8389461" target="_blank" rel="noopener">stackoverflowçš„è¿™ä¸ªå›ç­”</a>ï¼ˆ<a href="https://github.com/cirosantilli/java-cheat/tree/a907ad2243dce2109c54d27323f9387065b5ca5c/instrument" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰ä¸€ä»½Githubä¸Šé¢çš„å®ç°æºç ï¼‰</p><p>å¯ä»¥å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://blog.csdn.net/ITer_ZC/article/details/41822719" target="_blank" rel="noopener">èŠèŠJVMï¼ˆä¸‰ï¼‰ä¸¤ç§è®¡ç®—Javaå¯¹è±¡å¤§å°çš„æ–¹æ³•</a></p><p><a href="https://www.iteye.com/blog/brandnewuser-2113828" target="_blank" rel="noopener">å‡†ç¡®è®¡ç®—Javaä¸­å¯¹è±¡çš„å¤§å°</a></p><p><a href="https://www.cnblogs.com/zhanjindong/p/3757767.html" target="_blank" rel="noopener">ä¸€ä¸ªJavaå¯¹è±¡åˆ°åº•å ç”¨å¤šå¤§å†…å­˜ï¼Ÿ</a></p><p>è¿™é‡Œæä¾›ä¸€ä¸ªå®ä¾‹ï¼ˆ<a href="https://github.com/cirosantilli/java-cheat/tree/a907ad2243dce2109c54d27323f9387065b5ca5c/instrument" target="_blank" rel="noopener">å‚è€ƒè‡ªè¿™é‡Œ</a>ï¼‰ï¼š</p><p><code>Sizeof.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sizeof</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Instrumentation instrumentation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String args, Instrumentation inst)</span> </span>&#123;</span><br><span class="line">        instrumentation = inst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">sizeof</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instrumentation.getObjectSize(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Makefile</code></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//Makefileæ–‡ä»¶</span><br><span class="line"><span class="section">.POSIX:</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: all clean</span></span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">javac *.java</span><br><span class="line">jar -cfm Sizeof.jar META-INF/MANIFEST.MF Sizeof.class</span><br><span class="line">java -ea -javaagent:Sizeof.jar Main</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f *.class *.jar</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨æ—¶å…ˆæ–°å»ºä¸€ä¸ªJavaç±»ï¼Œåœ¨å…¶ä¸­è°ƒç”¨<code>sizeof()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(Sizeof.sizeof(<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>]));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac *.java //ç¼–è¯‘å½“å‰ç›®å½•ä¸‹çš„javaæ–‡ä»¶</span><br><span class="line">jar -cfm Sizeof.jar META-INF/MANIFEST.MF Sizeof.class //å°†Sizeof.classæ‰“åŒ…ä¸ºSizeof.jar</span><br><span class="line">java -ea -javaagent:Sizeof.jar Main //è¾“å‡ºsizeOfè®¡ç®—ç»“æœ</span><br></pre></td></tr></table></figure><h1 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h1><h2 id="Stringæœ€é•¿ä¸º65534"><a href="#Stringæœ€é•¿ä¸º65534" class="headerlink" title="Stringæœ€é•¿ä¸º65534"></a><code>String</code>æœ€é•¿ä¸º65534</h2><p><code>String s = â€œâ€;</code>ä¸­ï¼Œåœ¨ç¼–è¯‘æœŸæœ€å¤šå¯ä»¥æœ‰65534ä¸ªå­—ç¬¦</p><blockquote><p><del>åŸå› æ˜¯ï¼ŒJavaä¸­çš„UTF-8ç¼–ç çš„Unicodeå­—ç¬¦ä¸²åœ¨å¸¸é‡æ± ä¸­ä»¥<code>CONSTANT_Utf8</code>ç±»å‹è¡¨ç¤ºï¼Œå¸¸é‡æ± ä¸­çš„æ‰€æœ‰å­—é¢é‡å‡ ä¹éƒ½æ˜¯é€šè¿‡<code>CONSTANT_Utf8_info</code>æè¿°çš„ã€‚</del></p><p><del>è¿™é‡Œé¢çš„<code>u2 length</code>è¡¨æ˜äº†è¯¥ç±»å‹å­˜å‚¨æ•°æ®çš„é•¿åº¦ï¼Œè€Œ<code>u2</code>æ˜¯æ— ç¬¦å·çš„16ä½æ•´æ•°ï¼Œå› æ­¤ç†è®ºä¸Šå…è®¸çš„çš„æœ€å¤§é•¿åº¦æ˜¯<code>2^16=65536</code>ã€‚è€Œ Java class æ–‡ä»¶æ˜¯ä½¿ç”¨ä¸€ç§å˜ä½“<code>UTF-8</code>æ ¼å¼æ¥å­˜æ”¾å­—ç¬¦çš„ï¼Œ<code>null</code> å€¼ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œå› æ­¤åªå‰©ä¸‹<code>65536ï¼ 2 ï¼ 65534</code>ä¸ªå­—èŠ‚ã€‚</del></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;CONSTANT_Utf8_info &#123;</span><br><span class="line">&gt;u1 tag;</span><br><span class="line">&gt;u2 length;</span><br><span class="line">&gt;u1 bytes[length];</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p><strong>æ‰€ä»¥ï¼Œåœ¨Javaä¸­ï¼Œæ‰€æœ‰éœ€è¦ä¿å­˜åœ¨å¸¸é‡æ± ä¸­çš„æ•°æ®ï¼Œé•¿åº¦æœ€å¤§ä¸èƒ½è¶…è¿‡65535ï¼Œè¿™å½“ç„¶ä¹ŸåŒ…æ‹¬å­—ç¬¦ä¸²çš„å®šä¹‰</strong></p><p>ä¸Šé¢æåˆ°çš„è¿™ç§Stringé•¿åº¦çš„é™åˆ¶æ˜¯<em>ç¼–è¯‘æœŸçš„é™åˆ¶</em>ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨<code>String s= â€œâ€;</code>è¿™ç§å­—é¢å€¼æ–¹å¼å®šä¹‰çš„æ—¶å€™æ‰ä¼šæœ‰çš„é™åˆ¶ã€‚</p><p>Stringåœ¨<em>è¿è¡ŒæœŸ</em>æœ‰æ²¡æœ‰é™åˆ¶å‘¢ï¼Œç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå°±æ˜¯æˆ‘ä»¬å‰æ–‡æåˆ°çš„é‚£ä¸ª<code>Integer.MAX_VALUE</code>ï¼Œè¿™ä¸ªå€¼çº¦ç­‰äº4Gï¼Œåœ¨è¿è¡ŒæœŸï¼Œå¦‚æœStringçš„é•¿åº¦è¶…è¿‡è¿™ä¸ªèŒƒå›´ï¼Œå°±å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚(åœ¨jdk 1.9ä¹‹å‰ï¼‰</p><p><a href="https://blog.csdn.net/u013380694/article/details/102739636" target="_blank" rel="noopener">https://blog.csdn.net/u013380694/article/details/102739636</a></p></blockquote><p><strong>ä¸€ä¸ªStringå¯¹è±¡,å ç”¨å¤§å°ï¼ˆJDK1.8ï¼‰ä¸º24 bytes</strong>ï¼ˆä¸è®¡ç®—æŒæœ‰çš„charæ•°ç»„å ç”¨çš„å¤§å°ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** The value is used for character storage. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span> value[];  <span class="comment">//ä¸€ä¸ªæ•°ç»„å¯¹è±¡çš„å¼•ç”¨ï¼Œå ç”¨4 bytes</span></span><br><span class="line"><span class="comment">/** Cache the hash code for the string */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> hash; <span class="comment">// Default to 0   //ä¸€ä¸ªintç±»å‹ï¼Œå ç”¨4 bytes</span></span><br></pre></td></tr></table></figure><p>å†åŠ ä¸Šåœ¨64ä½JVMä¸­ï¼Œä¸€ä¸ªå¯¹è±¡å…·æœ‰12 bytesçš„<code>å¯¹è±¡å¤´+å¼•ç”¨</code>ï¼Œè¦æ±‚å¯¹é½åˆ°8çš„å€æ•°(æ¥æº<a href="https://www.baeldung.com/java-size-of-object#1-objects-references-and-wrapper-classes" target="_blank" rel="noopener">2.1. Objects, References and Wrapper Classes</a>)ï¼Œæ‰€ä»¥ä¸€ä¸ªStringå¯¹è±¡çš„å¤§å°æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size = ( 12 å¯¹è±¡å¤´ + 4 value + 4 hash ) + 4 8byteå¯¹é½ = 24 bytes</span><br></pre></td></tr></table></figure><h2 id="æšä¸¾ç±»enum"><a href="#æšä¸¾ç±»enum" class="headerlink" title="æšä¸¾ç±»enum"></a>æšä¸¾ç±»enum</h2><h3 id="æšä¸¾ç±»å¤§å°çš„è®¡ç®—"><a href="#æšä¸¾ç±»å¤§å°çš„è®¡ç®—" class="headerlink" title="æšä¸¾ç±»å¤§å°çš„è®¡ç®—"></a>æšä¸¾ç±»å¤§å°çš„è®¡ç®—</h3><p>æšä¸¾ç±»ä¸­çš„æ¯ä¸ªæšä¸¾éƒ½æ˜¯è¯¥æšä¸¾ç±»çš„ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> EnumClazz&#123;</span><br><span class="line">    Day,Hour,Minute,Second</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ç”¨<code>javap</code>æŸ¥çœ‹å…¶ç¼–è¯‘åçš„å­—èŠ‚ç å¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//javac EnumClazz.java</span></span><br><span class="line"><span class="comment">//javap EnumClazz.class</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumClazz</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span>&lt;<span class="title">EnumClazz</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumClazz Day;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumClazz Hour;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumClazz Minute;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumClazz Second;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> EnumClazz[] values();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EnumClazz <span class="title">valueOf</span><span class="params">(java.lang.String)</span></span>;</span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•è®¡ç®—ä¸€ä¸‹è¿™ä¸ª<code>EnumClazz</code>çš„å¤§å°ï¼ˆä¸å«å¼•ç”¨å¯¹è±¡çš„å¤§å°ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enumClassSize = <span class="number">8</span> + <span class="number">4</span> + <span class="number">4</span>*<span class="number">4</span> + <span class="number">4</span> = <span class="number">32</span> bytes</span><br><span class="line">       å¯¹è±¡å¤´ +  å¼•ç”¨ + æšä¸¾ç±»å€¼çš„å¼•ç”¨ç±»å‹ * <span class="number">4</span>ä¸ª + <span class="number">4</span> æ•°ç»„å¼•ç”¨ç±»å‹</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹æ¯ä¸ªæšä¸¾ç±»çš„å€¼ï¼ˆä»¥<code>EnumClazz.Day</code>ä¸ºä¾‹ï¼‰çš„å¤§å°ï¼š</p><p><code>enum</code>ç±»çš„æ¯ä¸ªå€¼å®é™…ä¸Šéƒ½ç»§æ‰¿è‡ª<code>java.lang.Enum</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Enum</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">E</span>&gt;&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">E</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æšä¸¾å€¼åç§°</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="comment">//æšä¸¾å€¼æ¬¡åºï¼Œä»0å¼€å§‹</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ordinal;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—<code>EnumClazz.Day</code>çš„å¤§å°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">daySize = <span class="number">8</span> + <span class="number">4</span> + <span class="number">4</span> + <span class="number">4</span> + <span class="number">8</span>æ¯”ç‰¹å¯¹é½(<span class="number">4</span>) = <span class="number">20</span> + <span class="number">4</span> = <span class="number">24</span> bytes</span><br><span class="line">     å¯¹è±¡å¤´ + Oopå¼•ç”¨ + name + ordinal + <span class="number">8</span>æ¯”ç‰¹å¯¹é½</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬ä¾‹ä¸­<strong>æ¯ä¸€ä¸ªæšä¸¾ç±»å€¼å ç”¨24 bytes</strong>ï¼Œç”±æ­¤å¯ä»¥è®¡ç®—å‡º<code>EnumClazz</code>å®é™…å ç”¨çš„å¤§å°åº”è¯¥æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realSize = enumClassSize + daySize * <span class="number">4</span>  = <span class="number">128</span> bytes</span><br></pre></td></tr></table></figure><h3 id="Androidä¸­æ˜¯å¦åº”è¯¥ä½¿ç”¨æšä¸¾"><a href="#Androidä¸­æ˜¯å¦åº”è¯¥ä½¿ç”¨æšä¸¾" class="headerlink" title="Androidä¸­æ˜¯å¦åº”è¯¥ä½¿ç”¨æšä¸¾"></a>Androidä¸­æ˜¯å¦åº”è¯¥ä½¿ç”¨æšä¸¾</h3><p>å…³äºAndroidä¸­ä½¿ç”¨æšä¸¾å’Œå¸¸é‡æ‰€å ç”¨çš„å¤§å°å¯¹æ¯”<em>RomainGuy</em>æœ‰<a href="https://speakerdeck.com/romainguy/android-memories?slide=67" target="_blank" rel="noopener">ä¸‹å›¾</a>çš„å¯¹æ¯”ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20191221172243.png" alt="https://speakerdeck.com/romainguy/android-memories?slide=67"></p><p>å…³äºæ˜¯å¦åº”è¯¥åœ¨Androidä¸­ä½¿ç”¨æšä¸¾ç±»ï¼Œå¯ä»¥å‚è€ƒä¸‹æ–‡ï¼š</p><p><a href="https://www.liaohuqiu.net/cn/posts/android-enum-memory-usage/" target="_blank" rel="noopener">https://www.liaohuqiu.net/cn/posts/android-enum-memory-usage/</a></p><p><a href="https://stackoverflow.com/a/29972028/8389461" target="_blank" rel="noopener">https://stackoverflow.com/a/29972028/8389461</a></p><p>æ€»ç»“èµ·æ¥å…¶ç»“è®ºå°±æ˜¯ï¼š</p><p><strong>å½“éœ€è¦ç”¨åˆ°æšä¸¾ç±»çš„ç‰¹æ€§æ—¶ï¼Œæ¯”å¦‚éè¿ç»­åˆ¤æ–­ï¼Œæ–¹æ³•é‡è½½ç­‰æ—¶å°±ä½¿ç”¨æšä¸¾ï¼Œå¦åˆ™å°±ä½¿ç”¨å ç”¨å†…å­˜æ›´å°çš„å¸¸é‡ç±»ã€‚</strong></p><h2 id="SparseArray-amp-ArrayMap-VS-HashMap"><a href="#SparseArray-amp-ArrayMap-VS-HashMap" class="headerlink" title="SparseArray&amp;ArrayMap VS HashMap"></a>SparseArray&amp;ArrayMap VS HashMap</h2><p><code>HashMap</code>çš„æ•°æ®æ˜¯ç»è¿‡åŒ…è£…åä¿å­˜åœ¨<code>HashMap.Node&lt;K,V&gt;</code>æ•°ç»„ä¸­ã€‚</p><p>ä¸‹é¢æ˜¯<code>HashMap</code>çš„ç»“æ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">transient</span> Node&lt;K,V&gt;[] table; <span class="comment">//4+ bytesï¼Œä¿å­˜HashMapçš„é”®å€¼å¯¹ç­‰ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet; <span class="comment">//4+ bytes</span></span><br><span class="line">  <span class="keyword">transient</span> <span class="keyword">int</span> size; <span class="comment">//4 bytes</span></span><br><span class="line">  <span class="keyword">transient</span> <span class="keyword">int</span> modCount; <span class="comment">//4 bytes</span></span><br><span class="line">  <span class="keyword">int</span> threshold; <span class="comment">//4 bytes</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> loadFactor; <span class="comment">//4 bytes</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ç»§æ‰¿è‡ªAbstractMap</span></span><br><span class="line">  <span class="keyword">transient</span> Set&lt;K&gt;        keySet; <span class="comment">//4+ bytes</span></span><br><span class="line">  <span class="keyword">transient</span> Collection&lt;V&gt; values; <span class="comment">//4+ bytes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹Androidæä¾›çš„<code>android.util.SparseArray</code>ç±»(å…·ä½“åˆ†æå¯å‚è€ƒï¼š<a href="https://juejin.im/entry/57c3e8c48ac24700634bd3cf" target="_blank" rel="noopener">SparseArray çš„ä½¿ç”¨åŠå®ç°åŸç†</a>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SparseArray</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mGarbage = <span class="keyword">false</span>; <span class="comment">//4 bytes</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] mKeys; <span class="comment">//4+ bytes</span></span><br><span class="line">    <span class="keyword">private</span> Object[] mValues; <span class="comment">//4+ bytes</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSize; <span class="comment">//4 bytes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ç»“åˆ<a href="https://developer.android.google.cn/reference/android/util/SparseArray" target="_blank" rel="noopener">å®˜æ–¹çš„æè¿°</a>ï¼Œ<code>SparseArray</code>ç±»å¾ˆæ˜æ˜¾è¦æ¯”<code>HashMap</code>å ç”¨æ›´å°‘çš„å†…å­˜ï¼š</p><ul><li>å°†<code>KEY</code>å’Œ<code>VALUE</code>ç›´æ¥ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œé¿å…äº†å°†å…¶åŒ…è£…ä¸ºä¸€ä¸ª<code>Node</code>å¯¹è±¡çš„å¼€é”€</li><li>ç”±äº<code>SparseArray</code>ç±»çš„keyæ˜¯<code>int</code>ç±»å‹è€Œéè¢«è‡ªåŠ¨è£…ç®±åçš„<code>Integer</code>å¯¹è±¡ï¼Œæ‰€ä»¥å½“åŒæ ·ä½¿ç”¨<code>int</code>ç±»å‹çš„<code>key</code>ä¿å­˜æ•°æ®æ—¶ï¼Œ<code>SparseArray</code>ç±»çš„<code>key</code>è¦å ç”¨æ›´å°‘çš„å†…å­˜ã€‚</li></ul><blockquote><p><code>SparseArray</code> is intended to be more memory-efficient than a <a href="https://developer.android.google.cn/reference/java/util/HashMap" target="_blank" rel="noopener"><code>HashMap</code></a>, because it <strong>avoids auto-boxing keys</strong> and its data structure <strong>doesnâ€™t rely on an extra entry</strong> object for each mapping.</p><p><a href="https://developer.android.google.cn/reference/android/util/SparseArray" target="_blank" rel="noopener">https://developer.android.google.cn/reference/android/util/SparseArray</a></p></blockquote><p>ä½†æ˜¯ï¼Œ<code>SparseArray</code>æœ‰ä»¥ä¸‹å±€é™æ€§ï¼š</p><ul><li><p>åœ¨æ¯æ¬¡<code>put/get/remove</code>çš„æ—¶å€™éƒ½éœ€è¦ä½¿ç”¨äºŒåˆ†æ³•(<code>ContainerHelpers.binarySearch(mKeys, mSize, key)</code>)æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨<code>KEY</code>å¯¹åº”çš„å€¼ï¼ˆæœ‰çš„è¯æŸ¥æ‰¾å…¶ä½ç½®ï¼‰</p></li><li><p>åœ¨æ·»åŠ å’Œåˆ é™¤itemçš„æ—¶å€™éƒ½éœ€è¦åœ¨æ•°ç»„ä¸­å¢åˆ æ¡ç›®ï¼ˆè€—æ—¶ï¼Œå°½ç®¡ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œ<code>SparseArray</code>åœ¨åˆ é™¤æ—¶åªæ˜¯å°†å¯¹äºçš„å€¼æ ‡è®°ä¸º<code>DELETED</code>ï¼Œåœ¨ä¸‹æ¬¡æ›´æ–°è¯¥<code>KEY</code>å¯¹äºçš„å€¼æ—¶ç›´æ¥è¦†ç›–ï¼Œæˆ–è€…åœ¨<code>GC</code>æ—¶åˆ é™¤ï¼‰ã€‚</p><p><code>private static final Object DELETED = new Object();</code></p><p>HashMapçš„åˆ é™¤æ¶‰åŠåˆ°æ•°ç»„ã€é“¾è¡¨å’Œçº¢é»‘æ ‘ï¼ˆJDK1.8ï¼‰</p></li><li><p><strong>åœ¨å®¹çº³æ•°ç™¾ä¸ªé¡¹ç›®æ—¶æ€§èƒ½ä¼šæ¯”HashMapå°å¤§çº¦50%</strong>ã€‚</p></li></ul><blockquote><p>æ¯å½“éœ€è¦<strong>å¢é•¿æ•°ç»„</strong>æˆ–<strong>è·å–æ•°ç»„å¤§å°</strong>æˆ–<strong>è·å–æ¡ç›®å€¼</strong>æ—¶ï¼Œéƒ½å¿…é¡»æ‰§è¡Œåƒåœ¾å›æ”¶GCã€‚</p></blockquote><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹å¯ä»¥æ›¿æ¢HashMapçš„(æ•°æ®æ¥è‡ª<a href="https://stackoverflow.com/a/31413003/8389461" target="_blank" rel="noopener">è¿™é‡Œ</a>)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SparseArray          &lt;Integer, Object&gt;</span><br><span class="line">SparseBooleanArray   &lt;Integer, Boolean&gt;</span><br><span class="line">SparseIntArray       &lt;Integer, Integer&gt;</span><br><span class="line">SparseLongArray      &lt;Integer, Long&gt;</span><br><span class="line">LongSparseArray      &lt;Long, Object&gt;</span><br><span class="line">LongSparseLongArray  &lt;Long, Long&gt;   <span class="comment">//this is not a public class                                 </span></span><br><span class="line">                                    <span class="comment">//but can be copied from  Android source code</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œè¿˜æœ‰<code>android.util.ArrayMap</code>å…¶ç‰¹æ€§ä¸<code>SparseArray</code>ç±»ä¼¼ï¼ˆ<strong>ä¸¤è€…å ç”¨å†…å­˜å°ï¼Œä½†æ˜¯æ…¢å¹¶ä¸”æœ€å¥½ä¸è¦ç”¨æ¥å­˜å‚¨å¤§å®¹é‡çš„æ•°æ®</strong>ï¼‰ï¼Œåªä¸è¿‡å®ƒæ”¯æŒkeyå€¼ä¸ºå…¶ä»–ç±»å‹ï¼Œå ç”¨å†…å­˜å¤§å°åœ¨<code>SparseArray</code>å’Œ<code>HashMap</code>ä¹‹é—´(å‚è€ƒ<a href="https://blog.csdn.net/u010687392/article/details/47809295" target="_blank" rel="noopener">è¿™é‡Œ</a>)ï¼Œæ­¤å¤–<code>ArrayMap</code>çš„APIå’Œ<code>HashMap</code>ç±»ä¼¼ã€‚</p><blockquote><p>æ ¹æ®<a href="https://speakerdeck.com/romainguy" target="_blank" rel="noopener">Romain Guy</a>çš„<a href="https://speakerdeck.com/romainguy/android-memories?slide=94" target="_blank" rel="noopener">è®¡ç®—</a>ï¼š</p><p>ä¿å­˜1000ä¸ªintå¯¹è±¡çš„<code>SparseArray</code>                       å ç”¨å¤§å°ä¸ºï¼š8072 bytes</p><p>ä¿å­˜1000ä¸ªå¯¹è±¡çš„<code>HashMap&lt;Integer,Integer&gt;</code>    å ç”¨å¤§å°ä¸ºï¼š64136 bytes</p><p>å‡ ä¹ç›¸å·®8å€ï¼</p></blockquote><p>ç»¼ä¸Šï¼Œ<strong>å½“è¦ä¿å­˜çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼ˆå°äºå‡ åƒä¸ªï¼‰çš„æ—¶å€™ï¼Œå¦‚æœKEYæ˜¯åŸºæœ¬ç±»å‹ï¼Œæ¨èä½¿ç”¨<code>SparseArray</code>åŠå…¶è¡ç”Ÿç±»ä»¥èŠ‚çœå†…å­˜ï¼Œå¦‚æœKEYæ˜¯å…¶ä»–ç±»å‹åˆ™ä½¿ç”¨<code>ArrayMap</code>;å¦åˆ™ä½¿ç”¨<code>HashMap</code>æ›´åŠ é«˜æ•ˆ</strong>ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>é™¤æ–‡ç« ä¸­ç½—åˆ—çš„é“¾æ¥å¤–ï¼š</p><p><a href="https://blog.csdn.net/u013380694/article/details/102739636" target="_blank" rel="noopener">https://blog.csdn.net/u013380694/article/details/102739636</a></p><p><a href="https://www.javaworld.com/article/2077408/sizeof-for-java.html" target="_blank" rel="noopener">Sizeof for Java â€“ javaworld.com</a></p><p><a href="https://speakerdeck.com/romainguy/android-memories" target="_blank" rel="noopener">RomainGuy-Android Memories</a>ï¼ˆæ¨èï¼‰</p><p><a href="https://stackoverflow.com/a/31413003/8389461" target="_blank" rel="noopener">SparseArray vs HashMap</a></p><p><a href="https://blog.csdn.net/u010687392/article/details/47809295" target="_blank" rel="noopener">Androidå†…å­˜ä¼˜åŒ–ï¼ˆä½¿ç”¨SparseArrayå’ŒArrayMapä»£æ›¿HashMapï¼‰</a></p><p><a href="https://juejin.im/entry/57c3e8c48ac24700634bd3cf" target="_blank" rel="noopener">SparseArray çš„ä½¿ç”¨åŠå®ç°åŸç†</a></p><p><a href="https://developer.android.google.cn/reference/android/util/SparseArray" target="_blank" rel="noopener">SparseArray â€“ developer.android.google.cn</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç¬”è®°ä¹‹åŒ¿åå†…éƒ¨ç±»å’Œfinal</title>
      <link href="/blog/posts/875283bd/"/>
      <url>/blog/posts/875283bd/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆåŒ¿åå†…éƒ¨ç±»ä½¿ç”¨å±€éƒ¨å¼•ç”¨è¦ç”¨finalï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆåŒ¿åå†…éƒ¨ç±»ä½¿ç”¨å±€éƒ¨å¼•ç”¨è¦ç”¨finalï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆåŒ¿åå†…éƒ¨ç±»ä½¿ç”¨å±€éƒ¨å¼•ç”¨è¦ç”¨finalï¼Ÿ"></a>ä¸ºä»€ä¹ˆ<code>åŒ¿åå†…éƒ¨ç±»</code>ä½¿ç”¨<code>å±€éƒ¨å¼•ç”¨</code>è¦ç”¨<code>final</code>ï¼Ÿ</h1><p>å…ˆè¯´ç»“è®ºï¼š</p><p>ç”±äºJAVAåŒ¿åå†…éƒ¨ç±»çš„å®ç°å¹¶ä¸æ˜¯çœŸæ­£çš„é—­åŒ…ï¼Œè€Œæ˜¯åœ¨ç”Ÿæˆå†…éƒ¨ç±»çš„æ—¶å€™<strong>å°†å±€éƒ¨å˜é‡çš„å¼•ç”¨æ‹·è´äº†ä¸€ä»½åˆ°å†…éƒ¨ç±»ä¸­</strong>ã€‚å¦‚æœä¸å°†è¿™ä¸ªå¤–éƒ¨ç±»è®¾ç½®ä¸º<code>final</code>çš„è¯ï¼Œå¤–éƒ¨ç±»æˆ–è€…å†…éƒ¨ç±»ä¿®æ”¹è¿™ä¸ªå±€éƒ¨å˜é‡åï¼Œå¦å¤–ä¸€å¤„ä½¿ç”¨çš„ä»ç„¶æ˜¯ä¿®æ”¹å‰çš„å€¼ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿé—®é¢˜ï¼Œè€Œå¦‚æœå°†å…¶ä¿®æ”¹ä¸º<code>final</code>åˆ™ä¿è¯äº†å±€éƒ¨å˜é‡ä¸å†…éƒ¨ç±»ä½¿ç”¨çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p><h1 id="JDK1-8-åå±€éƒ¨å˜é‡ä¸è¦æ±‚ç”¨finaläº†ï¼Ÿ"><a href="#JDK1-8-åå±€éƒ¨å˜é‡ä¸è¦æ±‚ç”¨finaläº†ï¼Ÿ" class="headerlink" title="JDK1.8 åå±€éƒ¨å˜é‡ä¸è¦æ±‚ç”¨finaläº†ï¼Ÿ"></a>JDK1.8 åå±€éƒ¨å˜é‡ä¸è¦æ±‚ç”¨<code>final</code>äº†ï¼Ÿ</h1><p>ä¸å¯¹ï¼Œä»ç„¶æ˜¯è¦æ±‚<code>final</code>çš„ã€‚</p><p>åªä¸è¿‡ç¼–è¯‘å™¨åˆ¤æ–­è¯¥å±€éƒ¨å˜é‡ä¸ä¼šå†è¢«ä¿®æ”¹æ—¶ï¼ˆ<em>effectively final</em> äº‹å®ä¸Šçš„<code>final</code>ï¼‰ï¼Œå¯ä»¥çœç•¥ã€‚</p><blockquote><p>Any local variable, formal parameter, or exception parameter used but not declared in an inner class <strong>must either be declared final or be effectively final</strong> (Â§4.12.4), or a compile-time error occurs where the use is attempted.</p><p>Any local variable used but not declared in an inner class must be definitely assigned (Â§16 (Definite Assignment)) before the body of the inner class, or a compile-time error occurs.</p><p><a href="https://docs.oracle.com/javase/specs/jls/se13/html/jls-8.html#jls-8.1.3" target="_blank" rel="noopener">https://docs.oracle.com/javase/specs/jls/se13/html/jls-8.html#jls-8.1.3</a></p></blockquote><h1 id="ä¸ºä»€ä¹ˆå¤–éƒ¨ç±»çš„å…¨å±€å˜é‡ä¸éœ€è¦finalï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå¤–éƒ¨ç±»çš„å…¨å±€å˜é‡ä¸éœ€è¦finalï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå¤–éƒ¨ç±»çš„å…¨å±€å˜é‡ä¸éœ€è¦finalï¼Ÿ"></a>ä¸ºä»€ä¹ˆå¤–éƒ¨ç±»çš„å…¨å±€å˜é‡ä¸éœ€è¦<code>final</code>ï¼Ÿ</h1><p>å› ä¸ºå…¨å±€å˜é‡æ˜¯é€šè¿‡ä¼ å…¥å†…éƒ¨ç±»çš„<strong>å¤–éƒ¨ç±»å¼•ç”¨<code>this$0</code></strong>æ¥å¼•ç”¨çš„(è€Œéç›´æ¥å¤åˆ¶å…¨å±€å˜é‡çš„å€¼)ï¼Œè¿™æ ·å†…éƒ¨ç±»å’Œå¤–éƒ¨ç±»æŒæœ‰çš„æ˜¯åŒä¸€ä¸ªå…¨éƒ¨å˜é‡ï¼Œè‡ªç„¶ä¸ä¼šå­˜åœ¨ä¸¤å¤„æ›´æ–°ä¸åŒæ­¥çš„é—®é¢˜ã€‚</p><h1 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        OutClass outClass = <span class="keyword">new</span> OutClass();</span><br><span class="line">        outClass.outMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤–éƒ¨ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> AnObj anObj = <span class="keyword">new</span> AnObj(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å±€éƒ¨å˜é‡</span></span><br><span class="line">        <span class="keyword">final</span> AnObj anObj1 = <span class="keyword">new</span> AnObj(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŒ¿åå†…éƒ¨ç±»</span></span><br><span class="line">        Inner o = <span class="keyword">new</span> Inner() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//å†…éƒ¨ç±»è®¿é—®å¤–éƒ¨ç±»çš„å…¨éƒ¨å˜é‡å’Œå±€éƒ¨å˜é‡</span></span><br><span class="line">                <span class="keyword">int</span> value = anObj1.getI() + anObj.getI();</span><br><span class="line">                System.out.println(<span class="string">"inner:"</span> + value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        o.doSth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢è¿™ä¸¤ä¸ªç±»æ— éœ€å…³æ³¨</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSth</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnObj</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnObj</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.i = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘åå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//OutClass.class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> AnObj anObj = <span class="keyword">new</span> AnObj(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    OutClass() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¼–è¯‘ä¹‹åï¼Œå°†å¤–éƒ¨ç±»çš„å¼•ç”¨å’Œå±€éƒ¨å˜é‡ä½œä¸ºå†…éƒ¨ç±»çš„å‚æ•°ä¼ å…¥åˆ°å†…éƒ¨ç±»ä¸­</span></span><br><span class="line">        <span class="keyword">new</span> <span class="number">1</span>(<span class="keyword">this</span>, <span class="keyword">new</span> AnObj(<span class="number">6</span>)).doSth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹å†…éƒ¨ç±»<code>OutClass$1</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//OutClass$1.class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutClass</span>$1 <span class="keyword">implements</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="comment">/* synthetic */</span> OutClass <span class="keyword">this</span>$<span class="number">0</span>;<span class="comment">//è¿™ä¸ªæ˜¯å¤–éƒ¨ç±»çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">final</span> <span class="comment">/* synthetic */</span> AnObj val$anObj1;<span class="comment">//è¿™ä¸ªå¼•ç”¨æŒ‡å‘å±€éƒ¨å˜é‡å¼•ç”¨æŒ‡å‘çš„å†…å­˜ç©ºé—´</span></span><br><span class="line"></span><br><span class="line">    OutClass$<span class="number">1</span>(OutClass <span class="keyword">this</span>$<span class="number">0</span>, AnObj anObj) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">this</span>$<span class="number">0</span> = <span class="keyword">this</span>$<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.val$anObj1 = anObj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå†…éƒ¨ç±»é€šè¿‡å±€éƒ¨å˜é‡çš„å¤‡ä»½å¼•ç”¨è®¿é—®çš„this.val$anObj1.getI()ï¼Œ</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥å¦‚æœå†…éƒ¨ç±»æ‰€å¤„çš„æ–¹æ³•ï¼Œä¿®æ”¹äº†è¿™ä¸ªå±€éƒ¨å˜é‡ï¼ˆå‡è®¾å°†è¿™ä¸ªå¼•ç”¨æŒ‡å‘äº†å¦å¤–ä¸€ä¸ªAnObjå¯¹è±¡ï¼‰ï¼Œ</span></span><br><span class="line">        <span class="comment">//ä½†è¿™é‡Œçš„this.val$anObj1æŒ‡å‘çš„ä»ç„¶æ˜¯æ—§çš„AnObjå¯¹è±¡ï¼Œä»è€Œå‡ºç°äº†å¯¹â€œåŒä¸€ä¸ªå±€éƒ¨å˜é‡â€åœ¨å†…éƒ¨ç±»å’Œå†…éƒ¨ç±»å¤–éƒ¨åˆ†åˆ«æœ‰ä¸åŒå€¼çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦finalæ¥é™åˆ¶å¯¹å±€éƒ¨å˜é‡çš„æ›´æ”¹</span></span><br><span class="line">        System.out.println(<span class="string">"inner:"</span> + (<span class="keyword">this</span>.val$anObj1.getI() + </span><br><span class="line">                                       <span class="keyword">this</span>.<span class="keyword">this</span>$<span class="number">0</span>.anObj.getI()));</span><br><span class="line">        <span class="comment">//ä½†æ˜¯å†çœ‹å¤–éƒ¨ç±»çš„å…¨å±€å˜é‡ï¼Œåœ¨å†…éƒ¨ç±»ä¸­ä»ç„¶æ˜¯é€šè¿‡å¤–éƒ¨ç±»çš„å¼•ç”¨this.this$0æ¥å¼•ç”¨anObjçš„ï¼Œæ‰€ä»¥æ— è®ºä½•æ—¶ï¼Œå†…éƒ¨ç±»ä¸­çš„å¤–éƒ¨ç±»å…¨å±€å˜é‡éƒ½æ˜¯æœ€æ–°çš„ï¼Œæ‰€åšçš„æ›´æ”¹ä¹Ÿä¼šå®æ—¶æ›´æ–°åˆ°å¤–éƒ¨ç±»ä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦final</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.runoob.com/w3cnote/inner-lambda-final.html" target="_blank" rel="noopener">https://www.runoob.com/w3cnote/inner-lambda-final.html</a></p><p><a href="https://stackoverflow.com/questions/4732544/why-are-only-final-variables-accessible-in-anonymous-class/4732617#4732617" target="_blank" rel="noopener">Why are only final variables accessible in anonymous class?â€“stackoverflow</a></p><p><a href="https://www.zhihu.com/question/21395848/answer/110829597" target="_blank" rel="noopener">javaä¸ºä»€ä¹ˆåŒ¿åå†…éƒ¨ç±»çš„å‚æ•°å¼•ç”¨æ—¶finalï¼Ÿ - èƒ–å›çš„å›ç­” - çŸ¥ä¹</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç¬”è®°ä¹‹ThreadLocal</title>
      <link href="/blog/posts/9a8e41a8/"/>
      <url>/blog/posts/9a8e41a8/</url>
      
        <content type="html"><![CDATA[<p><code>ThreadLocal</code>æ˜¯<code>Thread</code>ä¸­ç”¨æ¥ä¿å­˜<strong>çº¿ç¨‹ç§æœ‰å˜é‡</strong>çš„æ•°æ®ç»“æ„ã€‚</p><p>ä¸€ä¸ª<code>ThreadLocal</code>åªèƒ½ä¿å­˜ä¸€ä¸ªå€¼ï¼Œæœ‰<code>set/get/remove</code>æ–¹æ³•ã€‚</p><p>åœ¨<code>Thread</code>æœ‰ä¸€ä¸ª<code>threadLocals</code>ï¼ˆ<code>ThreadLocal.ThreadLocalMap</code>ï¼‰å˜é‡ï¼Œè¯¥å˜é‡æ˜¯ä¸€ä¸ªå®šåˆ¶çš„Hash Mapï¼Œç”¨æ¥ä¿å­˜çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼ˆç±»å‹ä¸º<code>ThreadLocal&lt;?&gt; Key, Object Value</code>ï¼‰ã€‚</p><h1 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h1><ol><li><p>ä¸€ä¸ª<code>Thread</code>å¯ä»¥æœ‰å¤šä¸ª<code>ThreadLocal</code>å˜é‡</p></li><li><p><strong>ä¸åŒ<code>Thread</code>å¯ä»¥é€šè¿‡ä¸€ä¸ª<code>ThreadLocal</code>å˜é‡åˆ†åˆ«ä¿å­˜ä¸åŒçš„å˜é‡è€Œäº’ä¸å½±å“</strong>ã€‚</p></li><li><p>å¦‚æœä¸åŒçš„<code>Thread</code>ä½¿ç”¨çš„<code>ThreadLocal</code>å˜é‡ä¿å­˜çš„æ˜¯<strong>åŒä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å¯¹è±¡</strong>ï¼ˆå‡è®¾ä¸º<code>obj</code>ï¼‰ï¼Œæ— è®ºè¿™äº›<code>Thread</code>ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª<code>ThreadLocal</code>å¯¹è±¡è¿˜æ˜¯å®Œå…¨ä¸åŒçš„<code>ThreadLocal</code>å¯¹è±¡ï¼Œåªè¦<code>obj</code>æŒ‡å‘çš„å¯¹è±¡æ”¹å˜ï¼Œå…¶ä½™çº¿ç¨‹ä¸­çš„<code>ThreadLocal</code>å¯¹è±¡ä¹Ÿä¼šè®¿é—®åˆ°<code>obj</code>çš„æœ€æ–°å€¼ã€‚</p></li></ol><h1 id="ä½¿ç”¨ä¸è§£æ"><a href="#ä½¿ç”¨ä¸è§£æ" class="headerlink" title="ä½¿ç”¨ä¸è§£æ"></a>ä½¿ç”¨ä¸è§£æ</h1><p>å½“æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>ThreadLocal</code>å¹¶ä¸ºä¹‹èµ‹å€¼æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹å¼1.</span></span><br><span class="line">ThreadLocal threadLocal = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">threadLocal.set(<span class="string">"value"</span>);</span><br><span class="line"><span class="comment">//æ–¹å¼2.</span></span><br><span class="line">ThreadLocal threadLocal2 = <span class="keyword">new</span> ThreadLocal()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> Object <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"initial value"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å°±ä¼šè°ƒç”¨<code>set()</code>æ–¹æ³•ï¼ˆæ–¹å¼1ï¼‰æˆ–è€…<code>setInitialValue()</code>æ–¹æ³•ï¼ˆæ–¹å¼2ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);<span class="comment">//æ³¨æ„è¿™é‡Œè·å–åˆ°æ˜¯çº¿ç¨‹æœ¬èº«çš„threadLocalså¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);<span class="comment">//ThreadLocalå¯¹è±¡åªæ˜¯åœ¨Threadæ‰€å±çš„threadLocalsä¸­å……å½“ä¸€ä¸ªkeyï¼Œ</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥å³ä½¿åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡ŒthreadLocal.set(value);</span></span><br><span class="line">        <span class="comment">//ä¹Ÿåªæ˜¯æ›´æ–°è¯¥çº¿ç¨‹æœ¬èº«çš„threadLocalå¯¹åº”çš„valueï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹åˆ†æ¯«ï¼ï¼ï¼ï¼ˆå¥½ç²¾å·§çš„è®¾è®¡ï¼‰</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T value = initialValue();</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•åˆ°æœ€åéƒ½ç›¸å½“äºè°ƒç”¨äº†<code>Thread</code>å¯¹è±¡çš„<code>threadLocals</code>çš„<code>set(ThreadLocal&lt;?&gt; key, Object value)</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆä»¥<code>ThreadLocal</code>å¯¹è±¡ä¸ºKEYï¼Œå°†æ•°æ®ä¿å­˜åˆ°äº†<code>Thread</code>å¯¹è±¡è‡ªå·±çš„<code>threadLocals</code>ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="comment">//å…¶ä»–é€»è¾‘...</span></span><br><span class="line">    tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å³ä½¿æ˜¯<strong>åŒä¸€ä¸ª<code>ThreadLocal</code>å¯¹è±¡ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿›è¡Œ<code>set/get/remove</code>éƒ½åªæ˜¯æ›´æ–°äº†æœ¬çº¿ç¨‹ä¸­<code>ThreadLocal</code>å¯¹è±¡å¯¹åº”çš„å€¼</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//MainThread</span></span><br><span class="line">    <span class="keyword">final</span> ThreadLocal threadLocal = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">    threadLocal.set(<span class="string">"THREAD-Main-"</span>+Thread.currentThread().getName());</span><br><span class="line">    System.out.println(<span class="string">"THREAD-Main-BEFOREï¼š"</span>+threadLocal.get());<span class="comment">//THREAD-Main-BEFOREï¼šTHREAD-Main-main</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            threadLocal.set(<span class="string">"THREAD-1-"</span>+Thread.currentThread().getName());</span><br><span class="line">            System.out.println(<span class="string">"THREAD-1ï¼š"</span>+threadLocal.get());<span class="comment">//THREAD-1ï¼šTHREAD-1-Thread-0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"THREAD-2ï¼š"</span>+threadLocal.get());<span class="comment">//THREAD-2ï¼šnull</span></span><br><span class="line">            <span class="comment">//æœ¬çº¿ç¨‹ä¸­threadLocalæ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ä¸ºnull</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//MainThread</span></span><br><span class="line">    System.out.println(<span class="string">"THREAD-Main-AFTERï¼š"</span>+threadLocal.get());<span class="comment">//THREAD-Main-AFTERï¼šTHREAD-Main-main </span></span><br><span class="line">    <span class="comment">//å…¶ä»–çº¿ç¨‹å¯¹threadLocalå¯¹è±¡çš„æ“ä½œä¸ä¼šå½±å“æœ¬çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">//ä½†æ˜¯å¦‚æœthreadLocalä¿å­˜çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡åœ¨å…¶ä»–çº¿ç¨‹è¢«æ›´æ”¹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹è·å–åˆ°çš„ä¹Ÿä¼šæ˜¯å˜æ›´åçš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h1><p>åœ¨<code>ThreadLocal.ThreadLocalMap</code>ä¸­ï¼Œæœ€ç»ˆç”¨æ¥ä¿å­˜<code>ThreadLocal</code>ä»¥åŠå¯¹åº”å€¼çš„æ˜¯ä¸€ä¸ª<code>Entry</code>æ•°ç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">            <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">            Object value;</span><br><span class="line"></span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">                <span class="keyword">super</span>(k);<span class="comment">//å¯¹ThreadLocalå¯¹è±¡çš„å¼±å¼•ç”¨</span></span><br><span class="line">                value = v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ<code>Entry</code>å¯¹<code>ThreadLocal</code>æ˜¯<strong>å¼±å¼•ç”¨</strong>ï¼ŒæŒ‰ç…§â€œå¼ºè½¯å¼±è™šâ€å¼•ç”¨çš„ç­‰çº§æ¥åˆ’åˆ†ï¼Œæ¯æ¬¡GCçš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ª<code>ThreadLocal</code>å¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨ï¼Œå°±ä¼šè¢«å›æ”¶æ‰ï¼Œè¿™æ—¶å¦‚æœè¯¥<code>Thread</code>è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆ<code>threadLocals</code>ä¸­ä¿å­˜çš„<code>ThreadLocal&lt;?&gt; k</code>å·²ç»è¢«å›æ”¶äº†ï¼Œä½†æ˜¯<code>Object v</code>å¯¹è±¡ä»ç„¶ä¿å­˜åœ¨<code>threadLocals</code>ä¸­ä½†æ˜¯æ²¡æœ‰åŠæ³•å†è®¿é—®åˆ°ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p><p>è§£å†³æ–¹æ³•å‚è€ƒï¼š</p><blockquote><p>ä½¿ç”¨<code>ThreadLocal</code>æ—¶ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼çš„å‰ææ¡ä»¶ï¼š</p><p>â‘ <code>ThreadLocal</code>å¼•ç”¨è¢«è®¾ç½®ä¸º<code>null</code>ï¼Œä¸”åé¢æ²¡æœ‰<code>setï¼Œget,remove</code>æ“ä½œã€‚</p><p>â‘¡çº¿ç¨‹ä¸€ç›´è¿è¡Œï¼Œä¸åœæ­¢ã€‚ï¼ˆçº¿ç¨‹æ± ï¼‰</p><p>â‘¢è§¦å‘äº†åƒåœ¾å›æ”¶ã€‚ï¼ˆMinor GCæˆ–Full GCï¼‰</p><p>æˆ‘ä»¬çœ‹åˆ°<code>ThreadLocal</code>å‡ºç°å†…å­˜æ³„æ¼æ¡ä»¶è¿˜æ˜¯å¾ˆè‹›åˆ»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦ç ´åå…¶ä¸­ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥é¿å…å†…å­˜æ³„æ¼ï¼Œå•ä½†ä¸ºäº†æ›´å¥½çš„é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿæˆ‘ä»¬ä½¿ç”¨<code>ThreadLocal</code>æ—¶éµå®ˆä»¥ä¸‹ä¸¤ä¸ªå°åŸåˆ™:</p><p>â‘ <code>ThreadLocal</code>ç”³æ˜ä¸º<code>private static final</code>ã€‚ <code>Private</code>ä¸<code>final</code>å°½å¯èƒ½ä¸è®©ä»–äººä¿®æ”¹å˜æ›´å¼•ç”¨ï¼Œ <code>Static</code>è¡¨ç¤ºä¸ºç±»å±æ€§ï¼Œåªæœ‰åœ¨ç¨‹åºç»“æŸæ‰ä¼šè¢«å›æ”¶ã€‚</p><p>â‘¡<code>ThreadLocal</code>ä½¿ç”¨ååŠ¡å¿…è°ƒç”¨<code>remove</code>æ–¹æ³•ã€‚ æœ€ç®€å•æœ‰æ•ˆçš„æ–¹æ³•æ˜¯ä½¿ç”¨åå°†å…¶ç§»é™¤ã€‚</p><p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œpony-ziã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ª CC 4.0 BY-SA ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚ åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/zzg1229059735/article/details/82715741" target="_blank" rel="noopener">https://blog.csdn.net/zzg1229059735/article/details/82715741</a></p></blockquote><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ï¼Œæ‰€è°“çš„<em>é€šè¿‡<code>ThreadLocal</code>å®ç°çº¿ç¨‹æœ¬åœ°å˜é‡ä¸å…¶ä»–çº¿ç¨‹éš”ç¦»</em>ï¼Œæ˜¯åœ¨åˆ›å»º<code>ThreadLocal</code>çš„æ—¶å€™ï¼Œ<strong>ä¿å­˜çš„å°±æ˜¯å±äºå½“å‰çº¿ç¨‹çš„ç‹¬ç«‹çš„å˜é‡ï¼Œå¹¶ä¸”ä¹‹åçš„ä¿®æ”¹ä¹Ÿä¸ä¼šï¼ˆæ— æ³•ï¼‰ä¿®æ”¹åˆ°å…¶ä»–çº¿ç¨‹ä¸­å¯¹åº”çš„å€¼</strong>ï¼Œä½†å¦‚æœ<code>ThreadLocal</code>æœ¬èº«ä¿å­˜çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™è¿™ä¸ªå¯¹è±¡åœ¨æ‰€æœ‰çš„çº¿ç¨‹ä¸­è¿˜æ˜¯å…±äº«çš„ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.cnblogs.com/whoislcj/p/5811989.html" target="_blank" rel="noopener">Androidçº¿ç¨‹ç®¡ç†ä¹‹ThreadLocalç†è§£åŠåº”ç”¨åœºæ™¯</a></p><p><a href="https://blog.csdn.net/shenyo/article/details/80391818" target="_blank" rel="noopener">ThreadLocalæ·±å…¥åˆ†æï¼ˆJdk 1.8ï¼‰</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç¬”è®°ä¹‹HashMapä¿å­˜æ•°æ®</title>
      <link href="/blog/posts/ff927bd4/"/>
      <url>/blog/posts/ff927bd4/</url>
      
        <content type="html"><![CDATA[<p><img src="https://images.pexels.com/photos/159644/art-supplies-brushes-rulers-scissors-159644.jpeg?cs=srgb&dl=art-supplies-arts-and-crafts-ballpens-159644.jpg&fm=jpg" class="full-image"></p><p>Photo by <strong><a href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank" rel="noopener">Pixabay </a></strong>from <strong><a href="https://www.pexels.com/photo/pencils-in-stainless-steel-bucket-159644/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank" rel="noopener">Pexels</a></strong></p><p><code>HashMap</code>ä½¿ç”¨ç”±<code>Node&lt;K,V&gt;</code>ï¼ˆç»§æ‰¿è‡ª<code>Map.Entry&lt;K,V&gt;</code>ï¼‰ç»„æˆçš„<strong>æ•°ç»„</strong><code>table</code>ä¿å­˜æ•°æ®ã€‚</p><p>åœ¨<code>table</code>ä¸­ä¿å­˜æ•°æ®æ—¶æ ¹æ®<code>key</code>çš„<code>hashCode</code>è®¡ç®—åˆ°ä¸€ä¸ª<strong>éšæœºä¿å­˜ä½ç½®ï¼ˆä½†éƒ½åœ¨<code>table</code>æ•°ç»„çš„å¤§å°èŒƒå›´å†…ï¼‰</strong>ï¼Œå½“å­˜å‚¨çš„<strong>æ•°æ®æ€»é‡</strong>è¶…è¿‡åŠ è½½ç³»æ•°<code>loadFactor</code>è§„å®šçš„<strong>é˜ˆå€¼</strong>æ—¶åˆ™å¯¹<code>table</code>è¿›è¡Œ<strong>æ‰©å®¹</strong>ã€‚</p><h1 id="HashMapæœ‰ä»¥ä¸‹å…¨å±€å˜é‡"><a href="#HashMapæœ‰ä»¥ä¸‹å…¨å±€å˜é‡" class="headerlink" title="HashMapæœ‰ä»¥ä¸‹å…¨å±€å˜é‡"></a>HashMapæœ‰ä»¥ä¸‹å…¨å±€å˜é‡</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;<span class="comment">//å®é™…ä¿å­˜é”®å€¼å¯¹çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;<span class="comment">//Holds cached entrySet().ç”¨æ¥éå†HashMap</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;<span class="comment">//æœ¬HashMapå®é™…ä¿å­˜çš„é”®å€¼å¯¹ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;<span class="comment">//HashMapä¿®æ”¹çš„æ¬¡æ•°ï¼Œæ¯æ¬¡ä¿®æ”¹HashMapéƒ½ä¼šå åŠ ï¼Œ</span></span><br><span class="line"><span class="comment">//ç”¨æ¥åœ¨éå†çš„è¿‡ç¨‹ä¸­æ£€æŸ¥HashMapæ˜¯å¦è¢«æ”¹åŠ¨è¿‡æ¥ï¼Œå¦‚æœæœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ConcurrentModificationException</span></span><br><span class="line"><span class="keyword">int</span> threshold;<span class="comment">//æ˜¯å¦æ‰©å®¹çš„é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;<span class="comment">//åŠ è½½ç³»æ•°,é»˜è®¤0.75f</span></span><br></pre></td></tr></table></figure><blockquote><p><code>loadFactor</code>ï¼šé»˜è®¤çš„è´Ÿè½½å› å­<strong>0.75</strong>æ˜¯å¯¹ç©ºé—´å’Œæ—¶é—´æ•ˆç‡çš„ä¸€ä¸ªå¹³è¡¡é€‰æ‹©ï¼Œå»ºè®®å¤§å®¶ä¸è¦ä¿®æ”¹ï¼Œé™¤éåœ¨æ—¶é—´å’Œç©ºé—´æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼š</p><p>å¦‚æœå†…å­˜ç©ºé—´å¾ˆå¤šè€Œåˆå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚å¾ˆé«˜ï¼Œå¯ä»¥é™ä½è´Ÿè½½å› å­Load factorçš„å€¼ï¼›</p><p>ç›¸åï¼Œå¦‚æœå†…å­˜ç©ºé—´ç´§å¼ è€Œå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥å¢åŠ è´Ÿè½½å› å­<code>loadFactor</code>çš„å€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥å¤§äº1ã€‚</p><p><a href="https://tech.meituan.com/2016/06/24/java-hashmap.html" target="_blank" rel="noopener">https://tech.meituan.com/2016/06/24/java-hashmap.html</a></p></blockquote><p>æ¯ä¸ª<code>Node</code>åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt;&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œ<code>hashMap.put(&quot;k&quot;, &quot;v&quot;);</code>æ—¶ï¼Œä¼šå…ˆè®¡ç®—<code>key</code>çš„<code>hash</code>å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">  <span class="comment">//è¿™é‡ŒåŸå§‹hashå€¼(32ä½)çš„é«˜ä½å’Œåœ°ä½è¿›è¡ŒæŒ‰ä½å¼‚æˆ–ï¼ˆä¸åŒä¸ºï¼Œç›¸åŒä¸º0ï¼‰ï¼Œ</span></span><br><span class="line">  <span class="comment">//å¢åŠ äº†éšæœºæ€§ï¼Œé¿å…å› ä¸ºhashCodeè®¡ç®—å¾—åˆ°çš„hashå€¼ï¼ˆä½ä½ç›¸åŒæ¦‚ç‡é«˜ï¼‰</span></span><br><span class="line">  <span class="comment">//è®¡ç®—ç´¢å¼•æ—¶ï¼ˆè§ä¸‹æ–‡â†“ï¼‰ä¸€ç›´å–ä½ä½å€¼è€Œå¯èƒ½å¯¼è‡´çš„ç´¢å¼•ä¸€ç›´çš„é‡å¤é—®é¢˜ã€‚</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="V-put-K-key-V-value"><a href="#V-put-K-key-V-value" class="headerlink" title="V put(K key, V value)"></a><code>V put(K key, V value)</code></h1><p>ä½¿ç”¨<code>HashMap</code>ä¿å­˜æ•°æ®æ—¶ï¼š</p><ol><li><p>ä½¿ç”¨<code>hash(Object key)</code>è®¡ç®—<code>key</code>çš„<code>hash</code>å€¼</p></li><li><p>é€šè¿‡<code>hash</code>å€¼è®¡ç®—<code>value</code>åº”è¯¥ä¿å­˜çš„ä½ç½®<code>i</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i = (table.length - <span class="number">1</span>) &amp; hash</span><br><span class="line"><span class="comment">//ç”±äºtable.lengthé™å®šä¸º2çš„næ¬¡æ–¹ï¼Œæ‰€ä»¥ä¸Šé¢çš„ç­‰å¼ç›¸å½“äºç»™table.lengthå–ä½™æ•°</span></span><br><span class="line"><span class="comment">//å³iæ°¸è¿œ&lt;=table.length</span></span><br></pre></td></tr></table></figure><p>åœ¨æ­¤æ—¶ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹(<strong>åªæœ‰<code>table</code>ä¸ºç©ºï¼Œæˆ–è€…å½“å‰å­˜å‚¨çš„æ•°æ®æ€»æ•°<code>size</code>å¤§äºé˜ˆå€¼<code>threshold</code>æ—¶æ‰ä¼šæ‰©å®¹</strong><code>resize()</code>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">threshold = capacity * loadFactor</span><br><span class="line">é˜ˆå€¼ = å®¹é‡ * è´Ÿè½½ç³»æ•°ï¼ˆé»˜è®¤ä¸º<span class="number">0.75</span>ï¼‰</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥ä¼šæ’å…¥æ•°æ®</p><ul><li>æŒ‡å®šä½ç½®ä¸ºç©ºï¼ˆæ²¡æœ‰<em>hashå†²çª</em>ï¼‰ï¼Œæˆ–å·²æœ‰<code>key</code>ç›¸åŒçš„å€¼ï¼šåˆ™ç›´æ¥æ’å…¥<code>value</code></li><li>å·²ç»å­˜åœ¨å€¼å¹¶ä¸”æ•°é‡å¤§äº8ï¼šåˆ™å°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼ˆJDK1.8ï¼‰ï¼Œå¦åˆ™ä»¥é“¾è¡¨å½¢å¼ä¿å­˜æ•°æ®</li><li>åœ¨ç§»é™¤æ•°æ®æ—¶ï¼Œå¦‚æœçº¢é»‘æ ‘æ•°é‡å°äº6ï¼šåˆ™å°†çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨</li></ul></li></ol><blockquote><p>åœ¨JDK1.7ä¸­ï¼Œæ•°æ®ä»¥æ•°ç»„æˆ–é“¾è¡¨å½¢å¼ä¿å­˜ï¼ŒJDK1.8ä¸­åˆ™æ–°å¢äº†çº¢é»‘æ ‘ã€‚</p><p>å‘ç”Ÿhashå†²çªæ—¶ï¼ŒJDK1.7é‡‡ç”¨é‡‡ç”¨å¤´æ’æ³•ï¼Œå¯èƒ½ä¼šäº§ç”Ÿé€†åºå’Œç¯å½¢é“¾è¡¨ï¼›JDK1.8é‡‡ç”¨å°¾æ’æ³•ï¼Œç›´æ¥æ’å…¥é“¾è¡¨æˆ–çº¢é»‘æ ‘å°¾éƒ¨ã€‚</p><p>å…·ä½“JDK1.7ä¸1.8å¯¹æ¯”æŸ¥çœ‹<a href="https://blog.csdn.net/qq_36520235/article/details/82417949" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><h1 id="V-get-Object-key"><a href="#V-get-Object-key" class="headerlink" title="V get(Object key)"></a><code>V get(Object key)</code></h1><p>ä½¿ç”¨<code>HashMap</code>è·å–æ•°æ®æ—¶:</p><ol><li><p>è®¡ç®—keyçš„<code>hashå€¼</code></p></li><li><p>æŸ¥æ‰¾å¯¹åº”ä½ç½®çš„<code>node</code></p><ul><li><p><code>null</code>ï¼šè¿”å›<code>null</code></p></li><li><p><code>node</code>ä¸ä¸ºç©ºä¸”<code>key</code>ä¸€è‡´ï¼šè¿”å›è¯¥<code>node</code></p></li><li><p><code>node</code>ä¸ä¸ºç©ºä¸”<code>key</code>ä¸ä¸€è‡´ï¼š</p><p>å¦‚æœæ˜¯<em>é“¾è¡¨</em>ï¼šéå†é“¾è¡¨æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ä¸<code>key</code>ä¸€è‡´çš„<code>node</code></p><p>å¦‚æœæ˜¯<em>æ ‘</em>ï¼šéå†æ ‘æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ä¸<code>key</code>ä¸€è‡´çš„<code>node</code></p></li></ul></li></ol><h1 id="V-remove-Object-key"><a href="#V-remove-Object-key" class="headerlink" title="V remove(Object key)"></a><code>V remove(Object key)</code></h1><p>ä½¿ç”¨<code>HashMap</code>ç§»é™¤æ•°æ®æ—¶:</p><p>å…¶å¤§ä½“è¿‡ç¨‹ä¸<code>get(Object key)</code>ç±»ä¼¼ï¼Œéå†æ‰¾åˆ°å¯¹åº”çš„<code>node</code>å¹¶åˆ é™¤ã€‚</p><h1 id="è®¡ç®—ç´¢å¼•"><a href="#è®¡ç®—ç´¢å¼•" class="headerlink" title="è®¡ç®—ç´¢å¼•"></a>è®¡ç®—ç´¢å¼•</h1><p>ä¸€ä¸ª<code>key</code>å¯¹åº”çš„ç´¢å¼•<code>index</code>æ˜¯ç”±è¿™ä¸ª<code>key</code>çš„<code>hash()</code>å€¼å¯¹<code>HashMap</code>çš„æ•°ç»„é•¿åº¦<code>length</code>çš„ä½™æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = hash % length;</span><br></pre></td></tr></table></figure><p>åˆæœ‰<strong>åœ¨<code>Length</code>ä¸º2^n^</strong>æ—¶ï¼š</p><p>hash % 2^n^ =  hash &amp; ( 2^n^ - 1)</p><blockquote><p>hash % 2^n^ = hash - (hash / 2^n^) <em> 2^n^<br>= hash - (hash&gt;&gt;n) </em> 2^n^<br>= hash &amp; ( 2^n^ - 1)</p></blockquote><p>è€Œ<code>HashMap</code>çš„é•¿åº¦<code>Length</code>åˆåªèƒ½æ˜¯2^n^ï¼Œæ‰€ä»¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = (length - <span class="number">1</span>) &amp; hash;</span><br></pre></td></tr></table></figure><h1 id="ä¿å­˜å€¼"><a href="#ä¿å­˜å€¼" class="headerlink" title="ä¿å­˜å€¼"></a>ä¿å­˜å€¼</h1><ul><li><p>å½“<code>table</code>ä¸ºç©ºæˆ–è€…é•¿åº¦è¶…è¿‡åŠ è½½å› å­<code>DEFAULT_LOAD_FACTOR</code>è§„å®šçš„å®¹é‡(é»˜è®¤å®¹é‡ä¸º16ï¼ŒåŠ è½½å› å­ä¸º0.75)æ—¶ä¼šè‡ªåŠ¨æ‰©å®¹ã€‚</p></li><li><p>å½“<code>table[index]</code>ä¸ºç©ºæ—¶ï¼Œç›´æ¥æ–°å»º<code>Node</code>å¹¶ä¿å­˜åˆ°<code>table[index]</code>ä¸­ã€‚</p></li><li><p>å½“<code>table[index]</code>ä¸ä¸ºç©ºæ—¶ï¼š</p><ul><li>å¦‚æœæ˜¯åŒä¸€ä¸ª<code>key</code>åˆ™è¦†ç›–æ—§çš„å€¼</li><li>å¦‚æœæ˜¯ä¸åŒçš„<code>key</code>åˆ™å…ˆå°è¯•ä»¥é“¾è¡¨ä¿å­˜æ•°æ®</li><li>å¦‚æœæ˜¯ä¸åŒçš„<code>key</code>ï¼Œå¹¶ä¸”é“¾è¡¨é•¿åº¦è¶…è¿‡<code>MIN_TREEIFY_CAPACITY</code>è§„å®šçš„é•¿åº¦ï¼ˆé»˜è®¤64ï¼‰ï¼Œåˆ™å°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘(JDK1.8æ–°å¢)</li></ul></li></ul><h1 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h1><p>åœ¨<a href="#HashMapæœ‰ä»¥ä¸‹å…¨å±€å˜é‡">ç¬¬ä¸€èŠ‚</a>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>HashMap</code>çš„å¾ˆå¤šå˜é‡éƒ½è¢«æ ‡è®°ä¸º<code>transient</code>ï¼Œè¿™è¡¨ç¤ºåœ¨<code>Serializable</code>åºåˆ—åŒ–æ—¶ä¸ä¸»åŠ¨å»åºåˆ—åŒ–è¿™äº›å€¼ï¼Œé‚£è¿™æ ·å²‚ä¸æ˜¯æ²¡æ³•ååºåˆ—åŒ–è¿™äº›æ•°æ®äº†ï¼Ÿ</p><p>å…¶å®åœ¨åé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<strong><code>HashMap</code>åœ¨<code>writeObject()</code>æ–¹æ³•ä¸­ä¸»åŠ¨ä¿å­˜äº†éƒ¨åˆ†æ•°æ®</strong>ï¼ˆåŸå› æ˜¯é»˜è®¤çš„<code>Serializable</code>ç”±äºä¸åŒJVMå®ç°å¯¹åŒä¸€å¯¹è±¡å¦‚<code>String</code>çš„<code>HashCode</code>ä¸ä¸€å®šä¸€è‡´ï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜â€”â€”<code>HashMap</code>åŸºäº<code>hash</code>å€¼ä¿å­˜æ•°æ®ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buckets = capacity();<span class="comment">//å®¹é‡</span></span><br><span class="line">    <span class="comment">// Write out the threshold, loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line">    s.writeInt(buckets);</span><br><span class="line">    s.writeInt(size);<span class="comment">//ä¿å­˜size</span></span><br><span class="line">    internalWriteEntries(s);<span class="comment">//ä¿å­˜tableæ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* tableä¸ä¸ºç©ºåˆ™è¿”å›tableé•¿åº¦</span></span><br><span class="line"><span class="comment">* å¦åˆ™thresholdä¸ä¸ºç©ºåˆ™è¿”å›threshold</span></span><br><span class="line"><span class="comment">* å¦åˆ™è¿”å›é»˜è®¤çš„DEFAULT_INITIAL_CAPACITY</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (table != <span class="keyword">null</span>) ? table.length :</span><br><span class="line">            (threshold &gt; <span class="number">0</span>) ? threshold :</span><br><span class="line">            DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶åœ¨<code>readObject()</code>æ¢å¤äº†è¿™äº›å€¼ã€‚</p><h1 id="ä½è¿ç®—"><a href="#ä½è¿ç®—" class="headerlink" title="ä½è¿ç®—"></a>ä½è¿ç®—</h1><table><thead><tr><th>ä½è¿ç®—</th><th>ç¬¦å·</th><th>è®¡ç®—</th></tr></thead><tbody><tr><td>æŒ‰ä½ä¸</td><td>&amp;</td><td>ç›¸åŒä¸º1ï¼Œä¸åŒä¸º0</td></tr><tr><td>æŒ‰ä½æˆ–</td><td>&#124;</td><td>æœ‰1åˆ™1</td></tr><tr><td>æŒ‰ä½å¼‚æˆ–</td><td>^</td><td>ç›¸åŒä¸º0ï¼Œä¸åŒä½1</td></tr><tr><td>æŒ‰ä½å–å</td><td>~</td><td></td></tr><tr><td>å·¦ç§»</td><td>&lt;&lt;</td><td>ç›¸å½“äºä¹˜ä»¥2^n^</td></tr><tr><td>å³ç§»</td><td><code>&gt;&gt;</code></td><td>ç›¸å½“äºé™¤ä»¥2^n^</td></tr><tr><td>æ— ç¬¦å·å³ç§»</td><td><code>&gt;&gt;&gt;</code></td></tr></tbody></table><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.zhihu.com/question/28562088/answer/111668116" target="_blank" rel="noopener">HashCodeè®¡ç®—æ‰°åŠ¨åˆ†æ-å…³äºhashMapçš„ä¸€äº›æŒ‰ä½ä¸è®¡ç®—çš„é—®é¢˜ï¼Ÿ - èƒ–å›çš„å›ç­” - çŸ¥ä¹ </a></p><p><a href="http://baijiahao.baidu.com/s?id=1646023968436883100&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener">ä¸€æ–‡è¯»æ‡‚Javaä¹‹HashMapç´¢å¼•ä½ç½®è®¡ç®—</a></p><p><a href="https://blog.csdn.net/changhangshi/article/details/82114727" target="_blank" rel="noopener">hashMapåœ¨jdk1.7ä¸jdk1.8ä¸­çš„åŸç†åŠä¸åŒ</a></p><p><a href="https://blog.csdn.net/qq_36520235/article/details/82417949" target="_blank" rel="noopener">çœŸå®é¢è¯•é¢˜ä¹‹ï¼šHashmapçš„ç»“æ„ï¼Œ1.7å’Œ1.8æœ‰å“ªäº›åŒºåˆ«</a></p><p><a href="https://tech.meituan.com/2016/06/24/java-hashmap.html" target="_blank" rel="noopener">Java 8ç³»åˆ—ä¹‹é‡æ–°è®¤è¯†HashMap</a></p><p><a href="http://www.blogjava.net/killme2008/archive/2009/04/15/265721.html" target="_blank" rel="noopener">java.util.HashMapæºç è¦ç‚¹æµ…æ</a></p><p><a href="https://coderanch.com/t/469720/java/HashMap-Entry-transient" target="_blank" rel="noopener">Why HashMap.Entry is transient?</a></p><p><a href="https://segmentfault.com/q/1010000000630486" target="_blank" rel="noopener">Javaä¸­HashMapå…³é”®å­—transientçš„ç–‘æƒ‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android AlarmManagerè®¾ç½®é‡å¤ä»»åŠ¡</title>
      <link href="/blog/posts/5754fcd2/"/>
      <url>/blog/posts/5754fcd2/</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸæœ‰ä¸€ä¸ªå®ç°å®šæ—¶å¯åŠ¨APPæé†’ç”¨æˆ·çš„éœ€æ±‚ï¼Œä¸€ç•ªæ¯”è¾ƒä¹‹åè§‰å¾—ç”¨é—¹é’Ÿ<code>AlarmManager</code>å®ç°æ¯”è¾ƒåˆé€‚ï¼Œæœ¬æ–‡æ˜¯å¯¹æ­¤è¿‡ç¨‹çš„æ¢³ç†ï¼Œå±äºæ¯”è¾ƒåŸºç¡€æ€§çš„å†…å®¹ã€‚</p><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>éœ€æ±‚éœ€è¦å®ç°</p><blockquote><p>â€œæ¯å¤©åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…,å¾ªç¯æç¤ºç”¨æˆ·ç›´åˆ°æ»¡è¶³æŒ‡å®šçš„æ¡ä»¶â€</p></blockquote><p>æ‹†åˆ†éœ€æ±‚ï¼š</p><ol><li>æ¯å¤©éƒ½è¦æé†’</li><li>åœ¨æ—¶é—´èŒƒå›´å†…ä¸€ç›´å¾ªç¯</li><li>æ»¡è¶³æ¡ä»¶åç»“æŸå½“å¤©å¾ªç¯</li></ol><h1 id="æ–¹æ¡ˆé€‰æ‹©"><a href="#æ–¹æ¡ˆé€‰æ‹©" class="headerlink" title="æ–¹æ¡ˆé€‰æ‹©"></a>æ–¹æ¡ˆé€‰æ‹©</h1><p>Androidä¸­å¯ä»¥ç”¨åˆ°çš„å¾ªç¯ä»»åŠ¡å®ç°æœ‰<code>Handler</code>ã€<code>Timer</code>ã€<code>ScheduledExecutorService</code>ï¼ˆè¿™ä¸‰ä¸ªå¯ä»¥çœ‹<a href="https://blog.csdn.net/qq_27489007/article/details/79220609" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼‰ï¼Œè¿˜æœ‰æœ€è¿‘çš„<a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager" target="_blank" rel="noopener"><code>WorkManager</code></a>å’Œæˆ‘ä»¬è¦ç”¨åˆ°çš„<a href="https://developer.android.google.cn/training/scheduling/alarms" target="_blank" rel="noopener"><code>AlarmManager</code></a>ã€‚</p><blockquote><p> WorkManager offers a backwards compatible (API level 14+) API leveraging <a href="https://developer.android.google.cn/reference/android/app/job/JobScheduler" target="_blank" rel="noopener"><code>JobScheduler</code></a> API (API level 23+) and above to help optimize battery life and batch jobs and a combination of <a href="https://developer.android.google.cn/reference/android/app/AlarmManager" target="_blank" rel="noopener"><code>AlarmManager</code></a> &amp; <a href="https://developer.android.google.cn/reference/android/app/BroadcastReceiver" target="_blank" rel="noopener"><code>BroadcastReceiver</code></a> on lower devices. </p></blockquote><p>è¿™å‡ ä¸ªæ–¹æ¡ˆä¸­ï¼Œå‰ä¸‰è€…éƒ½éœ€è¦APPåœ¨å‰å°è¿è¡Œï¼Œ<code>WorkManager</code>å’Œ<code>AlarmManager</code>åˆ™åœ¨APPé€€å‡ºä¹‹åä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œç”šè‡³åœ¨ä½ç‰ˆæœ¬ä¸Š<code>WorkManager</code>åº•å±‚ä¹Ÿæ˜¯é€šè¿‡<code>AlarmManager</code>å®ç°çš„ã€‚</p><p><code>WorkManager</code>ä¸»è¦å€¾å‘äºä¿è¯ä»»åŠ¡åœ¨APPé€€å‡ºï¼Œç”šè‡³è®¾å¤‡å…³æœºé‡å¯ç­‰æƒ…å†µä¸‹ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè™½ç„¶ä¹Ÿæä¾›å¾ªç¯ä»»åŠ¡çš„ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿åœ¨ç²¾ç¡®çš„æ—¶é—´å¾—åˆ°æ‰§è¡Œï¼Œä¸”æœ€å°é—´éš”15minã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>AlarmManager</code>å¯ä»¥ç¡®ä¿ä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´ï¼ˆç²¾ç¡®çš„æ—¶é—´ï¼‰å¾—åˆ°æ‰§è¡Œï¼Œå¹¶ä¸”å¯¹äºå¾ªç¯çš„é—´éš”ä¹Ÿæ›´åŠ çµæ´»ã€‚</p><p><img src="https://developer.android.google.cn/images/guide/background/bg-job-choose.svg" alt="Androidæ¨èé€‰æ‹©æ–¹æ¡ˆ"></p><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>æ®Androidå®˜ç½‘ä»‹ç»ï¼Œé—¹é’Ÿä¸»è¦ç”¨äºåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸä¹‹å¤–è¿›è¡Œå®šæ—¶æ“ä½œã€‚</p><p>é—¹é’Ÿå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p><blockquote><ul><li>å®ƒä»¬å¯è®©æ‚¨æŒ‰è®¾å®šçš„æ—¶é—´å’Œ/æˆ–é—´éš”è§¦å‘ intentã€‚</li><li>æ‚¨å¯ä»¥å°†å®ƒä»¬ä¸å¹¿æ’­æ¥æ”¶å™¨ç»“åˆä½¿ç”¨ï¼Œä»¥å¯åŠ¨æœåŠ¡ä»¥åŠæ‰§è¡Œå…¶ä»–æ“ä½œã€‚</li><li>å®ƒä»¬åœ¨åº”ç”¨å¤–éƒ¨è¿è¡Œï¼Œå› æ­¤å³ä½¿åº”ç”¨æœªè¿è¡Œï¼Œæˆ–è®¾å¤‡æœ¬èº«å¤„äºä¼‘çœ çŠ¶æ€ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥è§¦å‘äº‹ä»¶æˆ–æ“ä½œã€‚</li><li>å®ƒä»¬å¯ä»¥å¸®åŠ©æ‚¨æœ€å¤§é™åº¦åœ°é™ä½åº”ç”¨çš„èµ„æºè¦æ±‚ã€‚æ‚¨å¯ä»¥å®‰æ’å®šæœŸæ‰§è¡Œæ“ä½œï¼Œè€Œæ— éœ€ä¾èµ–å®šæ—¶å™¨æˆ–æŒç»­è¿è¡Œåå°æœåŠ¡ã€‚</li></ul></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAndroidä¸ºäº†é¿å…é‡å¤é—¹é’Ÿå¯èƒ½å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œæ¨èä½¿ç”¨ä¸æ˜¯å¾ˆç²¾ç¡®çš„<code>setInexactRepeating()</code>ï¼Œ è€Œä¸æ˜¯ç²¾ç¡®çš„<code>setRepeating()</code>ï¼Œå¹¶ä¸”åœ¨<code>API19+</code>ä¹‹åçš„æ‰€æœ‰çš„é‡å¤é—¹é’Ÿéƒ½ä¸æ˜¯ç²¾ç¡®çš„ï¼Œå¦‚æœéœ€è¦ç²¾ç¡®é—¹é’Ÿéœ€è¦ä½¿ç”¨ <code>setWindow(int, long, long, android.app.PendingIntent)</code> æˆ–<code>setExact(int, long, android.app.PendingIntent)</code>ã€‚ é‡å¤é—¹é’Ÿå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p><blockquote><ul><li>é—¹é’Ÿç±»å‹ã€‚è¦äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/training/scheduling/alarms#type" target="_blank" rel="noopener">é€‰æ‹©é—¹é’Ÿç±»å‹</a>ã€‚</li><li>è§¦å‘æ—¶é—´ã€‚å¦‚æœæ‚¨æŒ‡å®šçš„è§¦å‘æ—¶é—´ä¸ºè¿‡å»çš„æ—¶é—´ï¼Œåˆ™é—¹é’Ÿä¼šç«‹å³è§¦å‘ã€‚</li><li>é—¹é’Ÿçš„é—´éš”ã€‚ä¾‹å¦‚ï¼Œæ¯å¤©ä¸€æ¬¡ã€æ¯å°æ—¶ä¸€æ¬¡ã€æ¯ 5 åˆ†é’Ÿä¸€æ¬¡ï¼Œç­‰ç­‰ã€‚</li><li>é—¹é’Ÿè§¦å‘çš„å¾…å®š intentã€‚å½“æ‚¨è®¾ç½®äº†ä½¿ç”¨åŒä¸€å¾…å®š intent çš„ç¬¬äºŒä¸ªé—¹é’Ÿæ—¶ï¼Œå®ƒä¼šæ›¿æ¢åŸå§‹é—¹é’Ÿã€‚</li></ul></blockquote><h2 id="é—¹é’Ÿç±»å‹"><a href="#é—¹é’Ÿç±»å‹" class="headerlink" title="é—¹é’Ÿç±»å‹"></a>é—¹é’Ÿç±»å‹</h2><p>é—¹é’Ÿæœ‰ä¸¤ä¸ªç±»å‹ï¼š</p><ol><li><p>è·ç¦»ç³»ç»Ÿå¯åŠ¨åçš„æ—¶é—´ï¼Œä¸»è¦ç”¨äºâ€œé—´éš”å¤šä¹…é‡å¤ä¸€æ¬¡â€è¿™æ ·çš„éœ€æ±‚</p><p><code>ELAPSED_REALTIME</code> è·ç¦»å¼€æœºæ—¶é—´å¤šä¹…åå¯ç”¨é—¹é’Ÿï¼Œå¦‚æœç³»ç»Ÿåœ¨ä¼‘çœ ä¸­åˆ™ä¸ä¼šå”¤é†’</p><p><code>ELAPSED_REALTIME_WAKEUP</code> åœ¨ç³»ç»Ÿä¼‘çœ æ—¶ä¹Ÿä¼šå”¤é†’ç³»ç»Ÿ</p></li><li><p>ç²¾ç¡®çš„æ—¶é—´UTCï¼Œä¸»è¦ç”¨äºâ€œåœ¨å½“å¤©ä¸‹åˆ8ç‚¹æ•´å¼€å§‹â€ç­‰è¿™æ ·çš„éœ€æ±‚</p><p><code>RTC</code> åœ¨æŒ‡å®šçš„æ—¶é—´è§¦å‘é—¹é’Ÿï¼Œä¸ä¼šå”¤é†’æœºå™¨</p><p><code>RTC_WAKEUP</code> åœ¨æŒ‡å®šæ—¶é—´è§¦å‘é—¹é’Ÿï¼Œå¹¶ä¸”å”¤é†’è®¾å¤‡</p></li></ol><h2 id="è§¦å‘æ—¶é—´"><a href="#è§¦å‘æ—¶é—´" class="headerlink" title="è§¦å‘æ—¶é—´"></a>è§¦å‘æ—¶é—´</h2><p>é—¹é’Ÿè§¦å‘çš„æ—¶é—´ï¼Œåˆ†ä¸ºä»è®¾å¤‡ä¸Šæ¬¡å¯åŠ¨æ—¶é—´å’Œç²¾å‡†æ—¶é—´ä¸¤ç§ã€‚</p><p>å¦‚æœè§¦å‘çš„æ—¶é—´æ—©äºå½“å‰ç³»ç»Ÿæ—¶é—´çš„è¯ï¼Œç³»ç»Ÿä¼šæ ¹æ®è¿‡å»çš„æ—¶é—´å’Œé‡å¤é—´éš”é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ—¶é—´æ¥è§¦å‘ï¼ˆæœ‰å‡ åˆ†é’Ÿå†…çš„è¯¯å·®ï¼‰ã€‚</p><p>ä»å®é™…è¿è¡Œæ¥çœ‹ï¼Œä½¿ç”¨<code>ELAPSED_*</code>çš„åŸºæœ¬ä¸Šä¼šç«‹å³ï¼ˆå‡ ç§’é’Ÿï¼‰è§¦å‘è¯¥é—¹é’Ÿï¼Œå¹¶ä¸”æ¯æ¬¡å¾ªç¯é—´éš”æœ‰å‡ æ¯«ç§’çš„è¯¯å·®ã€‚</p><p>ä½¿ç”¨<code>RTC_*</code>åˆ™ä¼šåœ¨åˆšå¼€å§‹çš„ä¸¤ä¸‰æ¬¡å‡ºç°é—´éš”æ—¶é—´å°äºæŒ‡å®šæ—¶é—´çš„æƒ…å†µï¼ŒåæœŸç¨³å®šï¼š</p><p>è®¾ç½®çš„é—¹é’Ÿé—´éš”ä¸º10åˆ†é’Ÿï¼Œé—¹é’Ÿå¼€å§‹æ—¶é—´æ—©äºå½“å‰æ—¶é—´ï¼Œå”¤é†’ç»“æœå¦‚ä¸‹<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">alarmMgr.setRepeating(AlarmManager.RTC_WAKEUP,</span><br><span class="line">            calendar.timeInMillis,</span><br><span class="line">            <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">            alarmIntent</span><br><span class="line">        )</span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">06</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">46.696</span> </span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">06</span> <span class="number">14</span>:<span class="number">16</span>:<span class="number">26.634</span> </span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">06</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">26.765</span> </span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">06</span> <span class="number">14</span>:<span class="number">34</span>:<span class="number">26.579</span> </span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">06</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">46.785</span></span><br></pre></td></tr></table></figure></p><h2 id="é—´éš”æ—¶é—´"><a href="#é—´éš”æ—¶é—´" class="headerlink" title="é—´éš”æ—¶é—´"></a>é—´éš”æ—¶é—´</h2><p>é—´éš”æ—¶é—´æœ‰ä¸¤ç§ï¼š</p><ol><li><code>AlarmManager interval</code> å¦‚æœè®¾ç½®çš„æ˜¯<code>setInexactRepeating()</code>ï¼Œåˆ™éœ€è¦è®¾ç½®<code>AlarmManager</code>æŒ‡å®šçš„å‡ ç§é—´éš”æ—¶é—´ã€‚</li><li>ä»»æ„æ—¶é—´ <code>setRepeating()</code>æ–¹æ³•å¯ä»¥ä½¿ç”¨ä»»æ„æ—¶é—´</li></ol><h2 id="å¾…å®šçš„intent"><a href="#å¾…å®šçš„intent" class="headerlink" title="å¾…å®šçš„intent"></a>å¾…å®šçš„intent</h2><blockquote><p>å½“æ‚¨è®¾ç½®äº†ä½¿ç”¨åŒä¸€å¾…å®š intent çš„ç¬¬äºŒä¸ªé—¹é’Ÿæ—¶ï¼Œå®ƒä¼šæ›¿æ¢åŸå§‹é—¹é’Ÿ </p></blockquote><p>å¾…å®šçš„<code>Intent</code>æ˜¯ä¸€ä¸ª<code>PendingIntent</code>ï¼Œå¯ä»¥ç”¨æ¥æ‰“å¼€<code>Service</code>ï¼Œ<code>Activity</code>ï¼Œ<code>Broadcast</code>ç­‰ç­‰ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPendingIntent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        context: <span class="type">Context</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        action: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        requestCode: <span class="type">Int</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: PendingIntent &#123;</span><br><span class="line">        <span class="keyword">return</span> PendingIntent.getBroadcast(context, requestCode, Intent(action), <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„<code>requestCode</code>ï¼Œå½“ä¸éœ€è¦è¯¥é—¹é’Ÿæ—¶å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥å–æ¶ˆã€‚</p><h2 id="å–æ¶ˆé—¹é’Ÿ"><a href="#å–æ¶ˆé—¹é’Ÿ" class="headerlink" title="å–æ¶ˆé—¹é’Ÿ"></a>å–æ¶ˆé—¹é’Ÿ</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alarmManager.cancel(getPendingIntent(context,ACTION,RequestCode))</span><br></pre></td></tr></table></figure><h2 id="åœ¨é‡å¯æ—¶æ¢å¤é—¹é’Ÿ"><a href="#åœ¨é‡å¯æ—¶æ¢å¤é—¹é’Ÿ" class="headerlink" title="åœ¨é‡å¯æ—¶æ¢å¤é—¹é’Ÿ"></a>åœ¨é‡å¯æ—¶æ¢å¤é—¹é’Ÿ</h2><p>ç”±äºé—¹é’Ÿä¼šåœ¨è®¾å¤‡å…³æœºçš„æ—¶å€™è¢«å–æ¶ˆï¼Œæ‰€ä»¥éœ€è¦ç›‘å¬è®¾å¤‡å¼€æœºå¹¿æ’­ï¼ˆ<code>android.intent.action.BOOT_COMPLETED</code>ï¼‰ï¼Œå¹¶ä¸”æ¢å¤é—¹é’Ÿã€‚</p><h1 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h1><h2 id="è®¾ç½®ä¸€ä¸ªæ¯å¤©æŒ‡å®šæ—¶é—´å¾ªç¯çš„é—¹é’Ÿ"><a href="#è®¾ç½®ä¸€ä¸ªæ¯å¤©æŒ‡å®šæ—¶é—´å¾ªç¯çš„é—¹é’Ÿ" class="headerlink" title="è®¾ç½®ä¸€ä¸ªæ¯å¤©æŒ‡å®šæ—¶é—´å¾ªç¯çš„é—¹é’Ÿ"></a>è®¾ç½®ä¸€ä¸ªæ¯å¤©æŒ‡å®šæ—¶é—´å¾ªç¯çš„é—¹é’Ÿ</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupDailyAlarmClock</span><span class="params">( context: <span class="type">Context</span>,startTime: <span class="type">Pair</span>&lt;<span class="type">Int</span>, <span class="built_in">Int</span>&gt;)</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">val</span> alarmMgr = context.getSystemService(Context.ALARM_SERVICE) <span class="keyword">as</span> AlarmManager</span><br><span class="line">        <span class="keyword">val</span> alarmIntent = getPendingIntent(</span><br><span class="line">            context,</span><br><span class="line">            BROADCAST_ACTION_REPEAT,</span><br><span class="line">            RequestCode.START_REPEAT_INVENTORY</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// Set the alarm to start at xx:xx</span></span><br><span class="line">        <span class="keyword">val</span> calendar: Calendar = Calendar.getInstance().apply &#123;</span><br><span class="line">            timeInMillis = System.currentTimeMillis()</span><br><span class="line">            <span class="keyword">set</span>(Calendar.HOUR_OF_DAY, startTime.first)</span><br><span class="line">            <span class="keyword">set</span>(Calendar.MINUTE, startTime.second)</span><br><span class="line">            <span class="keyword">set</span>(Calendar.SECOND, <span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1 day</span></span><br><span class="line">        alarmMgr.setRepeating(</span><br><span class="line">            AlarmManager.RTC_WAKEUP,</span><br><span class="line">            calendar.timeInMillis,</span><br><span class="line">            AlarmManager.INTERVAL_DAY,</span><br><span class="line">            alarmIntent</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¯å¤©æŒ‡å®šæ—¶é—´åˆ°äº†ä¹‹åï¼Œå¼€å§‹è®¾ç½®ä¸€ä¸ªé—´éš”10åˆ†é’Ÿå”¤é†’ä¸€æ¬¡çš„é—¹é’Ÿï¼Œç›´åˆ°è¶…æ—¶æˆ–è€…æ»¡è¶³æŒ‡å®šçš„æ¡ä»¶åå–æ¶ˆè¯¥é—¹é’Ÿã€‚</p><h2 id="ç›‘å¬æ¯æ—¥å¾ªç¯çš„é—¹é’Ÿ"><a href="#ç›‘å¬æ¯æ—¥å¾ªç¯çš„é—¹é’Ÿ" class="headerlink" title="ç›‘å¬æ¯æ—¥å¾ªç¯çš„é—¹é’Ÿ"></a>ç›‘å¬æ¯æ—¥å¾ªç¯çš„é—¹é’Ÿ</h2><p>ç›‘å¬å…¶å‘é€çš„å¹¿æ’­<code>BROADCAST_ACTION_REPEAT</code>ã€‚</p><p>å¯ç”¨å½“æ—¥å¾ªç¯é—¹é’Ÿï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setupRepeatAlarmClock</span><span class="params">(context: <span class="type">Context</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> startTime = SharePreferencesUtils.sharedPreferences</span><br><span class="line">        .getString(KEY_STARTT_TIME,DEF_INVENTORY_TIME)?.toFormatTime() ?: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> alarmMgr = context.getSystemService(Context.ALARM_SERVICE) <span class="keyword">as</span> AlarmManager</span><br><span class="line">    <span class="keyword">val</span> alarmIntent = getPendingIntent(</span><br><span class="line">        context,</span><br><span class="line">        BROADCAST_ACTION_START,</span><br><span class="line">        RequestCode.START_INVENTORY</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tenMinutes = DEF_INVENTORY_DURATION * <span class="number">60</span> * <span class="number">1000</span></span><br><span class="line">    alarmMgr.setRepeating(</span><br><span class="line">        AlarmManager.ELAPSED_REALTIME_WAKEUP,<span class="comment">//ä»å¼€æœºåå¤šä¹…</span></span><br><span class="line">        SystemClock.elapsedRealtime(),<span class="comment">//å½“å‰è‡ªå¼€æœºå®Œåçš„æ—¶é—´</span></span><br><span class="line">        tenMinutes,<span class="comment">//æ¯ååˆ†é’Ÿå¾ªç¯ä¸€æ¬¡</span></span><br><span class="line">        alarmIntent</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¹¿æ’­æ¥æ”¶å™¨ä¸­æ”¶å¬åˆ°<code>BROADCAST_ACTION_START</code>åå»å¼€å¯ä»»åŠ¡</p><h2 id="æ¡ä»¶æ»¡è¶³åå…³é—­å½“æ—¥å¾ªç¯é—¹é’Ÿ"><a href="#æ¡ä»¶æ»¡è¶³åå…³é—­å½“æ—¥å¾ªç¯é—¹é’Ÿ" class="headerlink" title="æ¡ä»¶æ»¡è¶³åå…³é—­å½“æ—¥å¾ªç¯é—¹é’Ÿ"></a>æ¡ä»¶æ»¡è¶³åå…³é—­å½“æ—¥å¾ªç¯é—¹é’Ÿ</h2><p>åœ¨æ”¶åˆ°<code>BROADCAST_ACTION_START</code>åæ£€æµ‹åˆ°å·²ç»è¶…æ—¶æˆ–å…¶ä»–æ»¡è¶³å–æ¶ˆæ¡ä»¶çš„æƒ…å†µï¼Œåˆ™å–æ¶ˆä»»åŠ¡ã€‚</p><p>æˆ–è€…å¯ä»¥å†è®¢ä¸€ä¸ªç»“æŸæ—¶é—´çš„é—¹é’Ÿï¼Œåˆ°æ—¶é—´åå–æ¶ˆå½“æ—¥å¾ªç¯é—¹é’Ÿã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> alarmManager = getSystemService(Context.ALARM_SERVICE) <span class="keyword">as</span> AlarmManager</span><br><span class="line">alarmManager.cancel(pIntent)</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„<code>pIntent</code>éœ€è¦ä¸è®¾ç½®é—¹é’Ÿæ—¶çš„<code>PendingIntent</code>ä¸€è‡´(æ»¡è¶³<code>Intent.filterEquals()</code>çš„æ¡ä»¶)ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://blog.csdn.net/qq_27489007/article/details/79220609" target="_blank" rel="noopener">Androidå®šæ—¶ä»»åŠ¡åŠå¾ªç¯ä»»åŠ¡åŸºç¡€å¤§é›†åˆ</a></p><p><a href="https://developer.android.google.cn/training/scheduling/alarms" target="_blank" rel="noopener">å®‰æ’é‡å¤é—¹é’Ÿ Androidå®˜ç½‘</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kotlinå­¦ä¹ ç¬”è®°3</title>
      <link href="/blog/posts/fd5546ac/"/>
      <url>/blog/posts/fd5546ac/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä¸ºç¬”è®°æ€§è´¨ï¼Œå°šæœªæˆæ–‡ï¼Œå¾…æ•´ç†</p></blockquote><h1 id="å¼‚æ­¥æµ"><a href="#å¼‚æ­¥æµ" class="headerlink" title="å¼‚æ­¥æµ"></a>å¼‚æ­¥æµ</h1><ol><li><p>lazyæ–¹å¼åˆ›å»ºä¸€ä¸ªåºåˆ—ï¼Œåªæœ‰åœ¨è®¿é—®çš„æ—¶å€™æ‰ç”Ÿäº§å¯¹åº”çš„é¡¹ç›®</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Sequence&lt;<span class="built_in">Int</span>&gt; = sequence&#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>)<span class="comment">//ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹</span></span><br><span class="line">        yield(i)<span class="comment">//ç”Ÿäº§ä¸€ä¸ªé¡¹ç›®</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨Flowæµåœ¨ä¸é˜»å¡ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå»¶è¿Ÿç”Ÿäº§å¤šä¸ªå€¼å¹¶è¿”å›</p><p> å½“æµåœ¨ä¸€ä¸ªå¯å–æ¶ˆçš„æŒ‚èµ·å‡½æ•°ï¼ˆä¾‹å¦‚ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/delay.html" target="_blank" rel="noopener">delay</a>ï¼‰ä¸­æŒ‚èµ·çš„æ—¶å€™å–æ¶ˆï¼Œå¦åˆ™ä¸èƒ½å–æ¶ˆã€‚ </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//flow æ„å»ºå™¨ä¸­çš„ä»£ç ç›´åˆ°æµè¢«æ”¶é›†çš„æ—¶å€™æ‰è¿è¡Œï¼Œå¹¶ä¸”æ¯æ¬¡collectéƒ½ä¼šè¢«å¯åŠ¨</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123; <span class="comment">// æµæ„å»ºå™¨</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// å‡è£…æˆ‘ä»¬åœ¨è¿™é‡Œåšäº†ä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ï¼Œè¿™é‡Œå¯ä»¥è¢«å–æ¶ˆ</span></span><br><span class="line">        emit(i) <span class="comment">// å‘é€ä¸‹ä¸€ä¸ªå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// å¯åŠ¨å¹¶å‘çš„åç¨‹ä»¥éªŒè¯ä¸»çº¿ç¨‹å¹¶æœªé˜»å¡</span></span><br><span class="line">    launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (k <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">            println(<span class="string">"I'm not blocked <span class="variable">$k</span>"</span>)</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ”¶é›†è¿™ä¸ªæµ</span></span><br><span class="line">    foo().collect &#123; value -&gt; println(value) &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/flow-of.html" target="_blank" rel="noopener">flowOf</a> æ„å»ºå™¨å®šä¹‰äº†ä¸€ä¸ªå‘å°„å›ºå®šå€¼é›†çš„æµã€‚</p><p>ä½¿ç”¨ <code>.asFlow()</code> æ‰©å±•å‡½æ•°ï¼Œå¯ä»¥å°†å„ç§é›†åˆä¸åºåˆ—è½¬æ¢ä¸ºæµã€‚</p><p> å¯ä»¥ä½¿ç”¨æ“ä½œç¬¦è½¬æ¢æµï¼Œå°±åƒä½¿ç”¨é›†åˆä¸åºåˆ—ä¸€æ ·ã€‚ è¿‡æ¸¡æ“ä½œç¬¦åº”ç”¨äºä¸Šæ¸¸æµï¼Œå¹¶è¿”å›ä¸‹æ¸¸æµã€‚ è¿™äº›æ“ä½œç¬¦ä¹Ÿæ˜¯å†·æ“ä½œç¬¦ï¼Œå°±åƒæµä¸€æ ·ã€‚è¿™ç±»æ“ä½œç¬¦ï¼ˆ<code>map</code>ã€<code>fliter</code>â€¦ï¼‰æœ¬èº«ä¸æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œä½†æ˜¯å¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°<code>suspend</code>ã€‚å®ƒè¿è¡Œçš„é€Ÿåº¦å¾ˆå¿«ï¼Œè¿”å›æ–°çš„è½¬æ¢æµçš„å®šä¹‰ã€‚ </p><p> åœ¨æµè½¬æ¢æ“ä½œç¬¦ä¸­ï¼Œæœ€é€šç”¨çš„ä¸€ç§ç§°ä¸º <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/transform.html" target="_blank" rel="noopener">transform</a>ã€‚å®ƒå¯ä»¥ç”¨æ¥æ¨¡ä»¿ç®€å•çš„è½¬æ¢ï¼Œä¾‹å¦‚ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/map.html" target="_blank" rel="noopener">map</a> ä¸ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/filter.html" target="_blank" rel="noopener">filter</a>ï¼Œä»¥åŠå®æ–½æ›´å¤æ‚çš„è½¬æ¢ã€‚ ä½¿ç”¨ <code>transform</code> æ“ä½œç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow-collector/emit.html" target="_blank" rel="noopener">å‘å°„</a> ä»»æ„å€¼ä»»æ„æ¬¡ </p><p> é™é•¿è¿‡æ¸¡æ“ä½œç¬¦ï¼ˆä¾‹å¦‚ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/take.html" target="_blank" rel="noopener">take</a>ï¼‰åœ¨æµè§¦åŠç›¸åº”é™åˆ¶çš„æ—¶å€™ä¼šå°†å®ƒçš„æ‰§è¡Œå–æ¶ˆã€‚ </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">numbers</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;                          </span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">        emit(<span class="number">2</span>) </span><br><span class="line">        println(<span class="string">"This line will not execute"</span>)</span><br><span class="line">        emit(<span class="number">3</span>)    </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">"Finally in numbers"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    numbers() </span><br><span class="line">        .take(<span class="number">2</span>) <span class="comment">// åªè·å–å‰ä¸¤ä¸ª</span></span><br><span class="line">        .collect &#123; value -&gt; println(value) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµæ„é€ å™¨ä¸­çš„åç¨‹ä¸Šä¸‹æ–‡é»˜è®¤å’Œcollectçš„åç¨‹ä¸Šä¸‹æ–‡ä¸€è‡´ï¼Œå¦‚æœå¼ºè¡Œè½¬æ¢ä¸Šä¸‹æ–‡ä¼šå‡ºé”™ã€‚</p><p>è€Œä½¿ç”¨<code>flowOn()</code>åˆ™å¯ä»¥æŒ‡å®šæµåˆ›å»ºçš„åç¨‹ä¸Šä¸‹æ–‡ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>) <span class="comment">// å‡è£…æˆ‘ä»¬ä»¥æ¶ˆè€— CPU çš„æ–¹å¼è¿›è¡Œè®¡ç®—</span></span><br><span class="line">        log(<span class="string">"Emitting <span class="variable">$i</span>"</span>)</span><br><span class="line">        emit(i) <span class="comment">// å‘å°„ä¸‹ä¸€ä¸ªå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;.flowOn(Dispatchers.Default) <span class="comment">// åœ¨æµæ„å»ºå™¨ä¸­æ”¹å˜æ¶ˆè€— CPU ä»£ç ä¸Šä¸‹æ–‡çš„æ­£ç¡®æ–¹å¼</span></span><br></pre></td></tr></table></figure><p>å¦‚æœflowçš„ç”Ÿäº§å’Œæ”¶é›†å¾ˆæ¶ˆè€—æ—¶é—´æ—¶ï¼Œå¯ä»¥ç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/buffer.html" target="_blank" rel="noopener"><code>buffer()</code></a>å‡½æ•°å°†<code>buffer()</code>ä¹‹å‰çš„ä»£ç åœ¨ä¸€ä¸ªå•ç‹¬çš„åç¨‹è¿è¡Œï¼Œcollectåˆ™åœ¨è°ƒç”¨åç¨‹è¿è¡Œï¼Œè¿™æ ·å°†flowçš„æ„å»ºã€æ”¶é›†ç”±ä¸²è¡Œè½¬åŒ–ä¸ºå¹¶è¡Œå¯ä»¥èŠ‚çº¦æ—¶é—´ï¼ˆå¦‚æœæ„å»ºè¿è¡Œçš„å¿«ï¼Œåˆ™ä¼šæŒ‚èµ·ç›´åˆ°collectèµ¶ä¸Šæ¥ï¼‰ã€‚</p><blockquote><p> It will use two coroutines for execution of the code. A coroutine <code>Q</code> that calls this code is going to execute <code>collect</code>, and the code before <code>buffer</code> will be executed in a separate new coroutine <code>P</code> concurrently with <code>Q</code></p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">foo()</span><br><span class="line">       .buffer() <span class="comment">// buffer emissions, don't wait</span></span><br><span class="line">       .collect &#123; value -&gt; </span><br><span class="line">               delay(<span class="number">300</span>) <span class="comment">// pretend we are processing it for 300 ms</span></span><br><span class="line">           println(value) </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><h1 id="åˆå¹¶conflate"><a href="#åˆå¹¶conflate" class="headerlink" title="åˆå¹¶conflate"></a>åˆå¹¶conflate</h1><p> <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/conflate.html" target="_blank" rel="noopener">conflate</a> operator can be used to skip intermediate values when a collector is too slow to process them. </p><p>å½“collectæ¯”æ„å»ºæ…¢çš„æ—¶å€™ï¼Œå°±åªä¼šè¯·æ±‚æœ€æ–°çš„å€¼ï¼Œè€Œè·³è¿‡ä¸­é—´ç”Ÿäº§çš„è¿™äº›å€¼ã€‚</p><p>æ¯”å¦‚ï¼Œæ„å»ºå™¨ç”Ÿäº§äº†1ï¼Œ2ï¼Œâ€¦ ,100è¿™äº›æ•°ï¼Œè€Œcollectè¯»å–çš„æ…¢ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™æ˜¯1ï¼Œç­‰å¤„ç†å®Œå†è¯»å–çš„æ—¶å€™æ„å»ºå™¨ç”Ÿäº§çš„æ˜¯5ï¼Œé‚£ä¹ˆcollectå°±è¯»å–5ï¼Œä¸­é—´çš„2ï¼Œ3ï¼Œ4éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚</p><p> Conflation is one way to speed up processing when both the emitter and collector are slow ã€‚ The other way is to cancel a slow collector and restart it every time a new value is emitted.  </p><p><code>collectLatest</code>å¯ä»¥ä¿è¯æ¯æ¬¡éƒ½è·å–æœ€æ–°çš„å€¼ï¼Œå¦‚æœcollectæ¯”ç”Ÿäº§æ…¢ï¼Œé‚£ä¹ˆå½“æ–°çš„å€¼ç”Ÿäº§å‡ºæ¥æ—¶ï¼Œcollectä¼šè¢«å–æ¶ˆï¼Œå¹¶ä¸”å»å¤„ç†æœ€æ–°çš„å€¼ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// pretend we are asynchronously waiting 100 ms</span></span><br><span class="line">        emit(i) <span class="comment">// emit next value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        foo()</span><br><span class="line">            .collectLatest &#123; value -&gt; <span class="comment">// cancel &amp; restart on the latest value</span></span><br><span class="line">                    println(<span class="string">"Collecting <span class="variable">$value</span>"</span>) </span><br><span class="line">                delay(<span class="number">300</span>) <span class="comment">// pretend we are processing it for 300 ms</span></span><br><span class="line">                println(<span class="string">"Done <span class="variable">$value</span>"</span>) </span><br><span class="line">            &#125; </span><br><span class="line">    &#125;   </span><br><span class="line">    println(<span class="string">"Collected in <span class="variable">$time</span> ms"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//output</span></span><br><span class="line">Collecting <span class="number">1</span></span><br><span class="line">Collecting <span class="number">2</span></span><br><span class="line">Collecting <span class="number">3</span></span><br><span class="line">Done <span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">694</span> ms</span><br></pre></td></tr></table></figure><h1 id="ç»„åˆå¤šä¸ªæµ"><a href="#ç»„åˆå¤šä¸ªæµ" class="headerlink" title="ç»„åˆå¤šä¸ªæµ"></a>ç»„åˆå¤šä¸ªæµ</h1><p><code>zip</code>å°†ä¸¤ä¸ªæµâ€œå‹ç¼©â€ä¸ºä¸€ä¸ªæµï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">val</span> number = (<span class="number">1</span>..<span class="number">3</span>).asFlow()</span><br><span class="line">    <span class="keyword">val</span> strs = flowOf(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>)</span><br><span class="line">    number.zip(strs) &#123; a, b -&gt;</span><br><span class="line">        <span class="string">"<span class="variable">$a</span> -&gt; <span class="variable">$b</span>"</span></span><br><span class="line">    &#125;.collect&#123;</span><br><span class="line">        println(<span class="string">"<span class="variable">$it</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="number">1</span> -&gt; one</span><br><span class="line"><span class="number">2</span> -&gt; two</span><br><span class="line"><span class="number">3</span> -&gt; three</span><br></pre></td></tr></table></figure><p> å½“ flow è¡¨ç¤ºå˜é‡æˆ–æ“ä½œçš„æœ€æ–°å€¼æ—¶(å‚è§å…³äºåˆå¹¶çš„ç›¸å…³ç« èŠ‚) ï¼Œå¯èƒ½éœ€è¦æ‰§è¡Œä¾èµ–äºç›¸åº”æµçš„æœ€æ–°å€¼çš„è®¡ç®—ï¼Œå¹¶åœ¨ä»»ä½•ä¸Šæ¸¸æµå‘å‡ºå€¼æ—¶é‡æ–°è®¡ç®—å®ƒã€‚ ç›¸åº”çš„æ“ä½œç¬¦æ—ç§°ä¸ºè”åˆæ“ä½œç¬¦ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/combine.html" target="_blank" rel="noopener"><code>combine</code></a>ã€‚å³æ¯ä¸ªæ„å»ºå€¼å‘ç”Ÿå˜åŒ–æ—¶éƒ½ä¼šè§¦å‘collectã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> nums = (<span class="number">1</span>..<span class="number">3</span>).asFlow().onEach &#123; delay(<span class="number">300</span>) &#125; <span class="comment">// numbers 1..3 every 300 ms</span></span><br><span class="line"><span class="keyword">val</span> strs = flowOf(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>).onEach &#123; delay(<span class="number">400</span>) &#125; <span class="comment">// strings every 400 ms          </span></span><br><span class="line"><span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// remember the start time </span></span><br><span class="line">nums.combine(strs) &#123; a, b -&gt; <span class="string">"<span class="variable">$a</span> -&gt; <span class="variable">$b</span>"</span> &#125; <span class="comment">// compose a single string with "combine"</span></span><br><span class="line">    .collect &#123; value -&gt; <span class="comment">// collect and print </span></span><br><span class="line">            println(<span class="string">"<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start"</span>) </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//output    </span></span><br><span class="line"><span class="number">1</span> -&gt; one at <span class="number">452</span> ms from start</span><br><span class="line"><span class="number">2</span> -&gt; one at <span class="number">651</span> ms from start</span><br><span class="line"><span class="number">2</span> -&gt; two at <span class="number">854</span> ms from start</span><br><span class="line"><span class="number">3</span> -&gt; two at <span class="number">952</span> ms from start</span><br><span class="line"><span class="number">3</span> -&gt; three at <span class="number">1256</span> ms from start</span><br></pre></td></tr></table></figure><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/flat-map-concat.html" target="_blank" rel="noopener"><code>flatMapConcat</code></a> å¯ä»¥å°†flowçš„å†…å®¹â€œæŠ¹å¹³â€ï¼ˆå³å‡è®¾åŸå…ˆä¸º<code>Array&lt;Array&lt;Int&gt;&gt;</code>ï¼Œåˆ™æŠ¼å¹³åä¸ºï¼š<code>Array&lt;Int&gt;</code>ï¼‰ã€‚ä¸²è¡Œæ‰§è¡Œï¼Œå³å…ˆæ‰§è¡Œä»£ç å—ï¼Œç„¶åå¯¹å…¶<code>flatMapConcat</code>ï¼Œç„¶åcollectï¼Œä¹‹åå†æ‰§è¡Œä¸‹ä¸€è½®çš„Flowé¡¹ç›®ã€‚</p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/flat-map-merge.html" target="_blank" rel="noopener"><code>flatMapMerge</code></a> æŒ‰é¡ºåºè°ƒç”¨å®ƒçš„ä»£ç å— ï¼Œä½†æ˜¯åŒæ—¶æ”¶é›†ç»“æœæµï¼Œè¿™ç›¸å½“äºé¦–å…ˆæ‰§è¡Œä¸€ä¸ªé¡ºåºæ˜ å°„ ï¼Œç„¶åå¯¹ç»“æœè°ƒç”¨ flattonmergeã€‚å¹¶è¡Œæ‰§è¡Œï¼Œå…ˆä¾æ¬¡å¯¹Flowé¡¹ç›®è°ƒç”¨ä»£ç å—ï¼Œç„¶åå“ªä¸ªå€¼å…ˆå‡ºæ¥ï¼Œå°±å…ˆå¯¹å…¶è°ƒç”¨ <code>flatMapMerge</code>ï¼Œç„¶åcollectã€‚</p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/flat-map-latest.html" target="_blank" rel="noopener"><code>flatMapLatest</code></a> ç±»ä¼¼ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/collect-latest.html" target="_blank" rel="noopener"><code>collectLatest</code></a> ï¼Œæ¯æ¬¡æ–°å€¼å‡ºæ¥å°±ä¼šå–æ¶ˆè¿˜æ²¡æœ‰å¤„ç†ç»“æŸçš„æ—§æµçš„æ“ä½œã€‚</p><h1 id="æµå¼‚å¸¸"><a href="#æµå¼‚å¸¸" class="headerlink" title="æµå¼‚å¸¸"></a>æµå¼‚å¸¸</h1><p>æµçš„å¼‚å¸¸æœ‰å¦‚ä¸‹æ•è·æ–¹å¼ï¼š</p><ol><li><p><a href="https://kotlinlang.org/docs/reference/exceptions.html" target="_blank" rel="noopener"><code>try/catch</code></a> block </p></li><li><p>é€æ˜æ•è·  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/catch.html" target="_blank" rel="noopener">catch</a>  ï¼Œåªä¼šæ•è·å‘é€åœ¨ä»–ä¹‹å‰çš„å¼‚å¸¸</p></li><li><h4 id="å£°æ˜å¼æ•è·-å°†collectçš„ä¸»è¦é€»è¾‘æ”¾åˆ°onEachä¸­ï¼Œä¿è¯onEachåœ¨catchä¹‹å‰"><a href="#å£°æ˜å¼æ•è·-å°†collectçš„ä¸»è¦é€»è¾‘æ”¾åˆ°onEachä¸­ï¼Œä¿è¯onEachåœ¨catchä¹‹å‰" class="headerlink" title="å£°æ˜å¼æ•è· å°†collectçš„ä¸»è¦é€»è¾‘æ”¾åˆ°onEachä¸­ï¼Œä¿è¯onEachåœ¨catchä¹‹å‰"></a>å£°æ˜å¼æ•è· å°†collectçš„ä¸»è¦é€»è¾‘æ”¾åˆ°onEachä¸­ï¼Œä¿è¯onEachåœ¨catchä¹‹å‰</h4></li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">foo()</span><br><span class="line">    .onEach &#123; value -&gt;</span><br><span class="line">            check(value &lt;= <span class="number">1</span>) &#123; <span class="string">"Collected value"</span> &#125;                 </span><br><span class="line">        println(value) </span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="keyword">catch</span> &#123; e -&gt; println(<span class="string">"Caught e"</span>) &#125;</span><br><span class="line">    .collect()</span><br></pre></td></tr></table></figure><h1 id="æµå®Œæˆ"><a href="#æµå®Œæˆ" class="headerlink" title="æµå®Œæˆ"></a>æµå®Œæˆ</h1><ol><li><p><code>try</code>/<code>finally</code> </p></li><li><p><code>onCompletion()</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foo()</span><br><span class="line">    .onCompletion &#123; println(<span class="string">"Done"</span>) &#125;</span><br><span class="line">    .collect &#123; value -&gt; println(value) &#125;</span><br></pre></td></tr></table></figure><p>è€Œä¸”ä»–è¿˜å¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚å¸¸é€€å‡ºã€‚ä½†æ˜¯åªæ˜¯åˆ¤æ–­ï¼Œå¹¶ä¸ä¼šå¤„ç†ã€æ‹¦æˆªå¼‚å¸¸ï¼Œå¹¶ä¸”åªèƒ½å¤„ç†ä¸Šæ¸¸çš„å¼‚å¸¸ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">foo()</span><br><span class="line">    .onCompletion &#123; cause -&gt; <span class="keyword">if</span> (cause != <span class="literal">null</span>) println(<span class="string">"Flow completed exceptionally"</span>) &#125;</span><br><span class="line">    .<span class="keyword">catch</span> &#123; cause -&gt; println(<span class="string">"Caught exception"</span>) &#125;</span><br><span class="line">    .collect &#123; value -&gt; println(value) &#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="launchIn-this-ä¸collect"><a href="#launchIn-this-ä¸collect" class="headerlink" title="launchIn(this) ä¸collect"></a>launchIn(this) ä¸collect</h1><p><code>collect</code>åçš„ä»£ç åªæœ‰åœ¨collectæ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œï¼Œè€Œ<code>launchIn</code>å¯ä»¥æŒ‡å®šå…¶åœ¨å•ç‹¬çš„åç¨‹ç¨‹åºä¸­å¯åŠ¨æµçš„é›†åˆï¼Œä»è€Œä¸ä¼šé˜»å¡å½“å‰åç¨‹ã€‚</p><h1 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h1><p> <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-channel/index.html" target="_blank" rel="noopener">Channel</a>  ç±»ä¼¼äºBlockingQueueã€‚ä½†ä»–çš„æ“ä½œæ˜¯æŒ‚èµ·çš„ã€‚<br> Channelæä¾›äº†åœ¨åç¨‹ä¹‹é—´ä¼ é€’å¤šä¸ªå€¼çš„æ–¹æ³• </p><p><code>send</code> å‘é€ ç¼“å­˜åŒºå·²æ»¡æˆ–ä¸å­˜åœ¨æ—¶è°ƒç”¨æ–¹ä¼šè¢«æŒ‚èµ·</p><p><code>channel.receive()</code> æ¥æ”¶</p><p><code>channel.close()</code> å…³é—­é€šé“ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šçš„å…ƒç´ è¿›å…¥é€šé“</p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/produce.html" target="_blank" rel="noopener"><code>CoroutineScope.produce</code></a>  Launches new coroutine to produce a stream of values by sending them to a channel and returns a reference to the coroutine as a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-receive-channel/index.html" target="_blank" rel="noopener">ReceiveChannel</a>. This resulting object can be used to <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-receive-channel/receive.html" target="_blank" rel="noopener">receive</a> elements produced by this coroutine. åœ¨æ–°çš„åç¨‹ä¸­ç”Ÿäº§å¹¶è¿”å›äº†ä¸€ä¸ª<code>ReceiveChannel&lt;T&gt;</code>å¯¹è±¡ã€‚</p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/consume-each.html" target="_blank" rel="noopener"><code>ReceiveChannel&lt;E&gt;.consumeEach</code></a> éå†ReceiveChannelçš„itemæ‰§è¡ŒæŒ‡å®šactionï¼Œå¹¶åœ¨å—æ‰§è¡Œå®Œæ¯•åæ¶ˆè€—æ‰è¿™ä¸ªReceiveChannelï¼ˆè°ƒç”¨cancel()ï¼‰ã€‚</p><p> <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-receive-channel/index.html" target="_blank" rel="noopener">ReceiveChannel</a>.<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-receive-channel/cancel.html" target="_blank" rel="noopener">cancel()</a> å–æ¶ˆæ¥æ”¶æ¥è‡ªè¿™ä¸ªé€šé“çš„å‰©ä½™å…ƒç´ ï¼Œå…³é—­é€šé“å¹¶ä»ä¸­åˆ é™¤æ‰€æœ‰ç¼“å­˜çš„å…ƒç´ ã€‚</p><p><code>tickerChannel</code> å®šæ—¶è¿”å›<code>Unit</code>çš„<code>channel</code>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tickerChannel = ticker(delayMillis = <span class="number">1000</span>, initialDelayMillis = <span class="number">0</span>) <span class="comment">// åˆ›å»ºè®¡æ—¶å™¨é€šé“</span></span><br><span class="line"></span><br><span class="line">repeat(<span class="number">10</span>) &#123;</span><br><span class="line">    println(tickerChannel.receive())<span class="comment">// æ¯éš”1sä¼šæ‰“å°ä¸€ä¸ªkotlin.Unit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tickerChannel.cancel() <span class="comment">// è¡¨æ˜ä¸å†éœ€è¦æ›´å¤šçš„å…ƒç´ </span></span><br></pre></td></tr></table></figure><h1 id="Flow-Channel-Sequenceçš„åŒºåˆ«"><a href="#Flow-Channel-Sequenceçš„åŒºåˆ«" class="headerlink" title="Flow/Channel/Sequenceçš„åŒºåˆ«"></a>Flow/Channel/Sequenceçš„åŒºåˆ«</h1><p><code>Flow</code>æ˜¯ç”¨æ¥å¼‚æ­¥è¿”å›å¤šä¸ªå€¼ï¼Œå…¶å†…éƒ¨æ“ä½œå¯ä»¥æŒ‚èµ·</p><p><code>Channel</code> ç”¨æ¥åœ¨åç¨‹ä¹‹é—´ä¼ é€’å¤šä¸ªå€¼ï¼ˆtransfer a stream of valuesï¼‰</p><p><code>Sequence</code> ç”¨æ¥é€ä¸ªåœ¨itemä¸­å»¶è¿Ÿæ‰§è¡Œå®Œæ•´æ“ä½œï¼Œç›¸æ¯”äº<code>list</code>ç­‰æ•´ä½“æ‰§è¡Œå®Œæ¯•æ‰è¿›è¡Œä¸‹ä¸€çº§æ“ä½œçš„â€œå¼“â€å­—å‹ï¼Œ<code>Sequence</code>å¤šçº§æ“ä½œæ˜¯é€ä¸ªitemä¾æ¬¡å®Œæ•´æ‰§è¡Œå¤šçº§æ“ä½œçš„â€œå‡ â€å­—å‹ã€‚</p><h1 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h1><p>ç®¡é“æŒ‡ï¼š1.ä¸€ä¸ªåç¨‹åœ¨æµä¸­å¼€å§‹ç”Ÿäº§æ— ç©·å¤šä¸ªå…ƒç´  2.å¦ä¸€ä¸ªæˆ–å¤šä¸ªåç¨‹æ¶ˆè´¹è¿™äº›æµ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.channels.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> numbers = produceNumbers() <span class="comment">// ä» 1 å¼€å§‹ç”Ÿäº§æ•´æ•°</span></span><br><span class="line">    <span class="keyword">val</span> squares = square(numbers) <span class="comment">// å¯¹æ•´æ•°åšå¹³æ–¹</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span>) println(squares.receive()) <span class="comment">// æ‰“å°å‰ 5 ä¸ªæ•°å­—</span></span><br><span class="line">    println(<span class="string">"Done!"</span>) <span class="comment">// æˆ‘ä»¬çš„æ“ä½œå·²ç»ç»“æŸäº†</span></span><br><span class="line">    coroutineContext.cancelChildren() <span class="comment">// å–æ¶ˆå­åç¨‹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">produceNumbers</span><span class="params">()</span></span> = produce&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) send(x++) <span class="comment">// ä» 1 å¼€å§‹çš„æ— é™çš„æ•´æ•°æµ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">square</span><span class="params">(numbers: <span class="type">ReceiveChannel</span>&lt;<span class="type">Int</span>&gt;)</span></span>: ReceiveChannel&lt;<span class="built_in">Int</span>&gt; = produce &#123;</span><br><span class="line">    <span class="keyword">for</span> (x <span class="keyword">in</span> numbers) send(x * x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ç¼“å†²çš„é€šé“ï¼š å¦‚æœå‘é€å…ˆè¢«è°ƒç”¨ï¼Œåˆ™å®ƒå°†è¢«æŒ‚èµ·ç›´åˆ°æ¥æ”¶è¢«è°ƒç”¨ï¼Œ å¦‚æœæ¥æ”¶å…ˆè¢«è°ƒç”¨ï¼Œå®ƒå°†è¢«æŒ‚èµ·ç›´åˆ°å‘é€è¢«è°ƒç”¨ã€‚ </p><p>å¸¦ç¼“å†²çš„é€šé“ï¼š <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-channel.html" target="_blank" rel="noopener">Channel()</a> å·¥å‚å‡½æ•°ä¸ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/produce.html" target="_blank" rel="noopener">produce</a> å»ºé€ å™¨é€šè¿‡ä¸€ä¸ªå¯é€‰çš„å‚æ•° <code>capacity</code> æ¥æŒ‡å®š <em>ç¼“å†²åŒºå¤§å°</em> ã€‚ç¼“å†²å…è®¸å‘é€è€…åœ¨è¢«æŒ‚èµ·å‰å‘é€å¤šä¸ªå…ƒç´ ï¼Œ å°±åƒ <code>BlockingQueue</code> æœ‰æŒ‡å®šçš„å®¹é‡ä¸€æ ·ï¼Œå½“ç¼“å†²åŒºè¢«å æ»¡çš„æ—¶å€™å°†ä¼šå¼•èµ·é˜»å¡ã€‚ </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> channel = Channel&lt;<span class="built_in">Int</span>&gt;(<span class="number">4</span>) <span class="comment">// å¯åŠ¨å¸¦ç¼“å†²çš„é€šé“</span></span><br></pre></td></tr></table></figure><p> å‘é€å’Œæ¥æ”¶æ“ä½œæ˜¯ <em>å…¬å¹³çš„</em> å¹¶ä¸”å°Šé‡è°ƒç”¨å®ƒä»¬çš„å¤šä¸ªåç¨‹ã€‚å®ƒä»¬éµå®ˆå…ˆè¿›å…ˆå‡ºåŸåˆ™ã€‚</p><p> è®¡æ—¶å™¨é€šé“æ˜¯ä¸€ç§ç‰¹åˆ«çš„ä¼šåˆé€šé“ï¼Œæ¯æ¬¡ç»è¿‡ç‰¹å®šçš„å»¶è¿Ÿéƒ½ä¼šä»è¯¥é€šé“è¿›è¡Œæ¶ˆè´¹å¹¶äº§ç”Ÿ <code>Unit</code> ã€‚å¦‚æœåœ¨é—´éš”è¿˜æ²¡åˆ°çš„æ—¶å€™è°ƒç”¨<code>tickerChannel.receive()</code>åˆ™ä¼šè¿”å›<code>null</code>ã€‚äº§ç”Ÿçš„é—´éš”ç”±<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-ticker-mode/index.html" target="_blank" rel="noopener"><code>TickerModel</code></a>æ§åˆ¶</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tickerChannel =  ticker(delayMillis = <span class="number">100</span>, initialDelayMillis = <span class="number">0</span>,mode = TickerMode.FIXED_PERIOD) <span class="comment">//åˆ›å»ºè®¡æ—¶å™¨é€šé“ modeé»˜è®¤ä¸ºTickerMode.FIXED_PERIOD</span></span><br><span class="line"> tickerChannel.receive() <span class="comment">//ç¬¬ä¸€æ¬¡è°ƒç”¨ç«‹é©¬è¿”å›Unit</span></span><br></pre></td></tr></table></figure><p><code>coroutineContext.cancelChildren()</code> // å–æ¶ˆæ‰€æœ‰çš„å­åç¨‹æ¥è®©ä¸»åç¨‹ç»“æŸ</p><h1 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h1><h2 id="å¼‚å¸¸çš„ä¼ æ’­"><a href="#å¼‚å¸¸çš„ä¼ æ’­" class="headerlink" title="å¼‚å¸¸çš„ä¼ æ’­"></a>å¼‚å¸¸çš„ä¼ æ’­</h2><p> åç¨‹æ„å»ºå™¨æœ‰ä¸¤ç§é£æ ¼ï¼šè‡ªåŠ¨çš„ä¼ æ’­å¼‚å¸¸ï¼ˆ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html" target="_blank" rel="noopener">launch</a> ä»¥åŠ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/actor.html" target="_blank" rel="noopener">actor</a>ï¼‰ æˆ–è€…å°†å®ƒä»¬æš´éœ²ç»™ç”¨æˆ·ï¼ˆ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html" target="_blank" rel="noopener">async</a> ä»¥åŠ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/produce.html" target="_blank" rel="noopener">produce</a>ï¼‰ã€‚ å‰è€…å¯¹å¾…å¼‚å¸¸æ˜¯ä¸å¤„ç†çš„ï¼Œç±»ä¼¼äº Java çš„ <code>Thread.uncaughtExceptionHandler</code>ï¼Œ è€Œåè€…ä¾èµ–ç”¨æˆ·æ¥æœ€ç»ˆæ¶ˆè€—å¼‚å¸¸ï¼Œæ¯”å¦‚è¯´ï¼Œé€šè¿‡ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/await.html" target="_blank" rel="noopener">await</a> æˆ– <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-receive-channel/receive.html" target="_blank" rel="noopener">receive</a>  </p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-exception-handler/index.html" target="_blank" rel="noopener">CoroutineExceptionHandler</a> ä»…åœ¨é¢„è®¡ä¸ä¼šç”±ç”¨æˆ·å¤„ç†çš„å¼‚å¸¸ä¸Šè°ƒç”¨ï¼Œ æ‰€ä»¥åœ¨ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html" target="_blank" rel="noopener">async</a> æ„å»ºå™¨ä¸­æ³¨å†Œå®ƒæ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</p><p> åç¨‹å†…éƒ¨ä½¿ç”¨ <code>CancellationException</code> æ¥è¿›è¡Œå–æ¶ˆï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šè¢«æ‰€æœ‰çš„å¤„ç†è€…å¿½ç•¥ï¼Œæ‰€ä»¥é‚£äº›å¯ä»¥è¢« <code>catch</code> ä»£ç å—æ•è·çš„å¼‚å¸¸ä»…ä»…åº”è¯¥è¢«ç”¨æ¥ä½œä¸ºé¢å¤–è°ƒè¯•ä¿¡æ¯çš„èµ„æºã€‚ </p><p> å¦‚æœåç¨‹é‡åˆ°é™¤ <code>CancellationException</code> ä»¥å¤–çš„å¼‚å¸¸ï¼Œå®ƒå°†å–æ¶ˆå…·æœ‰è¯¥å¼‚å¸¸çš„çˆ¶åç¨‹ã€‚ è¿™ç§è¡Œä¸ºä¸èƒ½è¢«è¦†ç›–ï¼Œä¸”å®ƒè¢«ç”¨æ¥æä¾›ä¸€ä¸ªç¨³å®šçš„åç¨‹å±‚æ¬¡ç»“æ„æ¥è¿›è¡Œ<a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/docs/composing-suspending-functions.md#structured-concurrency-with-async" target="_blank" rel="noopener">ç»“æ„åŒ–å¹¶å‘</a>è€Œæ— éœ€ä¾èµ– <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-exception-handler/index.html" target="_blank" rel="noopener">CoroutineExceptionHandler</a> çš„å®ç°ã€‚ ä¸”å½“æ‰€æœ‰çš„å­åç¨‹è¢«ç»ˆæ­¢çš„æ—¶å€™ï¼ŒåŸæœ¬çš„å¼‚å¸¸è¢«çˆ¶åç¨‹æ‰€å¤„ç†ã€‚ </p><p>åº”è¯¥å°†<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-exception-handler/index.html" target="_blank" rel="noopener">CoroutineExceptionHandler</a> æ€»æ˜¯è¢«è®¾ç½®åœ¨ç”± <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-global-scope/index.html" target="_blank" rel="noopener">GlobalScope</a> å¯åŠ¨çš„åç¨‹ä¸­ã€‚å°†å¼‚å¸¸å¤„ç†è€…è®¾ç½®åœ¨ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html" target="_blank" rel="noopener">runBlocking</a> ä¸»ä½œç”¨åŸŸå†…å¯åŠ¨çš„åç¨‹ä¸­æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå°½ç®¡å­åç¨‹å·²ç»è®¾ç½®äº†å¼‚å¸¸å¤„ç†è€…ï¼Œ ä½†æ˜¯ä¸»åç¨‹ä¹Ÿæ€»æ˜¯ä¼šè¢«å–æ¶ˆçš„ã€‚ </p><p>å¼‚å¸¸è¢«æŠ›å‡ºåï¼Œæ‰€æœ‰åŒçº§çš„å­åç¨‹éƒ½ä¼šè¢«å…³é—­ï¼Œç„¶åå¼‚å¸¸ä¼ é€’ç»™çˆ¶åç¨‹ï¼Œç›´åˆ°å¼‚å¸¸è¢«å¤„ç†ã€‚</p><p> ä¸€ä¸ªåç¨‹çš„å¤šä¸ªå­åç¨‹æŠ›å‡ºå¼‚å¸¸å°†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ é€šå¸¸çš„è§„åˆ™æ˜¯â€œç¬¬ä¸€ä¸ªå¼‚å¸¸èµ¢å¾—äº†èƒœåˆ©â€œã€‚</p><h2 id="ç›‘ç£"><a href="#ç›‘ç£" class="headerlink" title="ç›‘ç£"></a>ç›‘ç£</h2><p>æ™®é€šçš„å–æ¶ˆ æ˜¯ä¸€ç§åŒå‘æœºåˆ¶ï¼Œåœ¨åç¨‹çš„æ•´ä¸ªå±‚æ¬¡ç»“æ„ä¹‹é—´ä¼ æ’­ã€‚ </p><p> SupervisorJob  å®ƒç±»ä¼¼äºå¸¸è§„çš„ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job.html" target="_blank" rel="noopener">Job</a>ï¼Œ ä½†ä»–çš„å–æ¶ˆåªä¼šå‘ä¸‹ä¼ æ’­ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val supervisor = SupervisorJob()with(CoroutineScope(coroutineContext + supervisor)) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">supervisorå–æ¶ˆçš„è¯ï¼Œä¼šå–æ¶ˆæ‰æ‰€æœ‰å­åç¨‹</span><br></pre></td></tr></table></figure><h4 id="ç›‘ç£ä½œä¸š"><a href="#ç›‘ç£ä½œä¸š" class="headerlink" title="ç›‘ç£ä½œä¸š"></a>ç›‘ç£ä½œä¸š</h4><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-supervisor-job.html" target="_blank" rel="noopener">SupervisorJob</a> å¯ä»¥è¢«ç”¨äºè¿™äº›ç›®çš„ã€‚å®ƒç±»ä¼¼äºå¸¸è§„çš„ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job.html" target="_blank" rel="noopener">Job</a>ï¼Œå”¯ä¸€çš„ä¸åŒæ˜¯ï¼šSupervisorJob çš„å–æ¶ˆåªä¼šå‘ä¸‹ä¼ æ’­ã€‚è¿™æ˜¯éå¸¸å®¹æ˜“ä»ç¤ºä¾‹ä¸­è§‚å¯Ÿåˆ°çš„ï¼š</p><h4 id="ç›‘ç£ä½œç”¨åŸŸ"><a href="#ç›‘ç£ä½œç”¨åŸŸ" class="headerlink" title="ç›‘ç£ä½œç”¨åŸŸ"></a>ç›‘ç£ä½œç”¨åŸŸ</h4><p>å¯¹äº<em>ä½œç”¨åŸŸ</em>çš„å¹¶å‘ï¼Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/supervisor-scope.html" target="_blank" rel="noopener">supervisorScope</a> å¯ä»¥è¢«ç”¨æ¥æ›¿ä»£ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html" target="_blank" rel="noopener">coroutineScope</a> æ¥å®ç°ç›¸åŒçš„ç›®çš„ã€‚å®ƒåªä¼šå•å‘çš„ä¼ æ’­å¹¶ä¸”å½“å­ä½œä¸šè‡ªèº«æ‰§è¡Œå¤±è´¥çš„æ—¶å€™å°†å®ƒä»¬å…¨éƒ¨å–æ¶ˆã€‚å®ƒä¹Ÿä¼šåœ¨æ‰€æœ‰çš„å­ä½œä¸šæ‰§è¡Œç»“æŸå‰ç­‰å¾…ï¼Œ å°±åƒ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html" target="_blank" rel="noopener">coroutineScope</a> æ‰€åšçš„é‚£æ ·ã€‚</p><h4 id="ç›‘ç£åç¨‹ä¸­çš„å¼‚å¸¸"><a href="#ç›‘ç£åç¨‹ä¸­çš„å¼‚å¸¸" class="headerlink" title="ç›‘ç£åç¨‹ä¸­çš„å¼‚å¸¸"></a>ç›‘ç£åç¨‹ä¸­çš„å¼‚å¸¸</h4><p>å¸¸è§„çš„ä½œä¸šå’Œç›‘ç£ä½œä¸šä¹‹é—´çš„å¦ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯å¼‚å¸¸å¤„ç†ã€‚ æ¯ä¸€ä¸ªå­ä½œä¸šåº”è¯¥é€šè¿‡å¼‚å¸¸å¤„ç†æœºåˆ¶å¤„ç†è‡ªèº«çš„å¼‚å¸¸ã€‚ è¿™ç§å·®å¼‚æ¥è‡ªäºå­ä½œä¸šçš„æ‰§è¡Œå¤±è´¥ä¸ä¼šä¼ æ’­ç»™å®ƒçš„çˆ¶ä½œä¸šçš„äº‹å®ã€‚</p><h2 id="åç¨‹çš„çº¿ç¨‹å®‰å…¨"><a href="#åç¨‹çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="åç¨‹çš„çº¿ç¨‹å®‰å…¨"></a>åç¨‹çš„çº¿ç¨‹å®‰å…¨</h2><ol><li>ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„</li></ol>   <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> counter = AtomicInteger()</span><br><span class="line"> withContext(Dispatchers.Default) &#123;</span><br><span class="line">        counter.incrementAndGet()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>ä»¥ç»†ç²’åº¦é™åˆ¶çº¿ç¨‹</p></li><li><p>ä»¥ç²—ç²’åº¦é™åˆ¶çº¿ç¨‹</p><p>2ã€3éƒ½æ˜¯ä¿è¯å°†å¯¹å…±äº«å˜é‡çš„æ“ä½œé™åˆ¶åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p></li><li><p>äº’æ–¥</p><p>ç±»ä¼¼äºçº¿ç¨‹çš„é”ï¼Œåç¨‹çš„ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.sync/-mutex/index.html" target="_blank" rel="noopener">Mutex</a> çš„lockå’Œunlockæ–¹æ³•å¯ä»¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåç¨‹è®¿é—®æŒ‡å®šä»£ç ã€‚Mutexä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚</p></li><li><p>Actors</p><p> ä¸€ä¸ª <a href="https://en.wikipedia.org/wiki/Actor_model" target="_blank" rel="noopener">actor</a> æ˜¯ç”±åç¨‹ã€ è¢«é™åˆ¶å¹¶å°è£…åˆ°è¯¥åç¨‹ä¸­çš„çŠ¶æ€ä»¥åŠä¸€ä¸ªä¸å…¶å®ƒåç¨‹é€šä¿¡çš„ <em>é€šé“</em> ç»„åˆè€Œæˆçš„ä¸€ä¸ªå®ä½“ã€‚ </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°å¯åŠ¨ä¸€ä¸ªæ–°çš„è®¡æ•°å™¨ actor</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">counterActor</span><span class="params">()</span></span> = actor&lt;CounterMsg&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> counter = <span class="number">0</span> <span class="comment">// actor çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">for</span> (msg <span class="keyword">in</span> channel) &#123; <span class="comment">// å³å°†åˆ°æ¥æ¶ˆæ¯çš„è¿­ä»£å™¨</span></span><br><span class="line">        <span class="keyword">when</span> (msg) &#123;</span><br><span class="line">            <span class="keyword">is</span> IncCounter -&gt; counter++</span><br><span class="line">            <span class="keyword">is</span> GetCounter -&gt; msg.response.complete(counter)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//1.è¦é€’å¢çŠ¶æ€æ—¶</span></span><br><span class="line">counter.send(IncCounter)</span><br><span class="line"><span class="comment">//2.è¦è·å–å½“å‰çŠ¶æ€æ—¶</span></span><br><span class="line"><span class="comment">// å‘é€ä¸€æ¡æ¶ˆæ¯ä»¥ç”¨æ¥ä»ä¸€ä¸ª actor ä¸­è·å–è®¡æ•°å€¼</span></span><br><span class="line"><span class="keyword">val</span> response = CompletableDeferred&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">counter.send(GetCounter(response))</span><br><span class="line">println(<span class="string">"Counter = <span class="subst">$&#123;response.await()&#125;</span>"</span>)</span><br></pre></td></tr></table></figure><p>  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-completable-deferred/index.html" target="_blank" rel="noopener">CompletableDeferred</a> é€šä¿¡åŸè¯­è¡¨ç¤ºæœªæ¥å¯çŸ¥ï¼ˆå¯ä¼ è¾¾ï¼‰çš„å•ä¸ªå€¼ ã€‚</p><p>åœ¨ä½¿ç”¨æ—¶ï¼Œç”±äºactor æ˜¯ä¸€ä¸ªåç¨‹ï¼Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-send-channel/send.html" target="_blank" rel="noopener"><code>SendChannel .send()</code></a> æ–¹æ³•ä¼šåœ¨é€šé“ç¼“å­˜æ»¡çš„æ—¶å€™æŒ‚èµ·è°ƒç”¨æ–¹ï¼Œä»è€Œæœ€ç»ˆä¿è¯äº†<code>counter++</code>æ–¹æ³•æ˜¯ä¾æ¬¡æ‰§è¡Œçš„ï¼Œä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜ã€‚</p><p>actor åœ¨é«˜è´Ÿè½½ä¸‹æ¯”é”æ›´æœ‰æ•ˆï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹å®ƒæ€»æ˜¯æœ‰å·¥ä½œè¦åšï¼Œè€Œä¸”æ ¹æœ¬ä¸éœ€è¦åˆ‡æ¢åˆ°ä¸åŒçš„ä¸Šä¸‹æ–‡ã€‚ </p></li></ol><blockquote><p> æ³¨æ„ï¼Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/actor.html" target="_blank" rel="noopener">actor</a> åç¨‹æ„å»ºå™¨æ˜¯ä¸€ä¸ªåŒé‡çš„ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/produce.html" target="_blank" rel="noopener">produce</a> åç¨‹æ„å»ºå™¨ã€‚ä¸€ä¸ª actor ä¸å®ƒæ¥æ”¶æ¶ˆæ¯çš„é€šé“ç›¸å…³è”ï¼Œè€Œä¸€ä¸ª producer ä¸å®ƒå‘é€å…ƒç´ çš„é€šé“ç›¸å…³è”ã€‚ </p></blockquote><h1 id="Selectè¡¨è¾¾å¼"><a href="#Selectè¡¨è¾¾å¼" class="headerlink" title="Selectè¡¨è¾¾å¼"></a>Selectè¡¨è¾¾å¼</h1><p>  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.selects/select.html" target="_blank" rel="noopener">select</a> è¡¨è¾¾å¼å…è®¸æˆ‘ä»¬ä½¿ç”¨å…¶ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-receive-channel/on-receive.html" target="_blank" rel="noopener">onReceive</a> å­å¥ <em>åŒæ—¶</em> ä»ä¸¤ä¸ªç”Ÿäº§è€…æ¥æ”¶æ•°æ®ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">selectFizzBuzz</span><span class="params">(fizz: <span class="type">ReceiveChannel</span>&lt;<span class="type">String</span>&gt;, buzz: <span class="type">ReceiveChannel</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    select&lt;<span class="built_in">Unit</span>&gt; &#123; <span class="comment">// &lt;Unit&gt; æ„å‘³ç€è¯¥ select è¡¨è¾¾å¼ä¸è¿”å›ä»»ä½•ç»“æœ</span></span><br><span class="line">        fizz.onReceive &#123; value -&gt;  <span class="comment">// è¿™æ˜¯ç¬¬ä¸€ä¸ª select å­å¥</span></span><br><span class="line">            println(<span class="string">"fizz -&gt; '<span class="variable">$value</span>'"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        buzz.onReceive &#123; value -&gt;  <span class="comment">// è¿™æ˜¯ç¬¬äºŒä¸ª select å­å¥</span></span><br><span class="line">            println(<span class="string">"buzz -&gt; '<span class="variable">$value</span>'"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/on-receive-or-null.html" target="_blank" rel="noopener">onReceiveOrNull</a>  å¯ä»¥å…è®¸ä¸ºç©ºï¼Œè¿™æ ·å¯ä»¥åœ¨å…³é—­é€šé“æ—¶æ‰§è¡Œç‰¹å®šæ“ä½œ </p><p> <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-send-channel/on-send.html" target="_blank" rel="noopener">onSend</a> å­å¥ å‘é€æ¶ˆæ¯</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">produceNumbers</span><span class="params">(side: <span class="type">SendChannel</span>&lt;<span class="type">Int</span>&gt;)</span></span> = produce&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (num <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span>) &#123; <span class="comment">// ç”Ÿäº§ä» 1 åˆ° 10 çš„ 10 ä¸ªæ•°å€¼</span></span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// å»¶è¿Ÿ 100 æ¯«ç§’</span></span><br><span class="line">        select&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">            onSend(num) &#123;&#125; <span class="comment">// å‘é€åˆ°ä¸»é€šé“</span></span><br><span class="line">            side.onSend(num) &#123;&#125; <span class="comment">// æˆ–è€…å‘é€åˆ° side é€šé“</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> Selectå»¶è¿Ÿå€¼å¯ä»¥ä½¿ç”¨ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/on-await.html" target="_blank" rel="noopener">onAwait</a> å­å¥æŸ¥è¯¢ </p><iframe width="853" height="480" src="https://embed.coggle.it/diagram/Xb_CZoumpCamgUAj/1235701ea5f157867e045f0f5ac28f886effdb5fa1e27b72afa5266e6e3e8891" frameborder="0" allowfullscreen></iframe><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://blog.csdn.net/u013064109/article/details/83507076" target="_blank" rel="noopener">Kotlinçš„ç‹¬é—¨ç§˜ç±Reifiedå®åŒ–ç±»å‹å‚æ•°(ä¸‹ç¯‡)</a></p><p><a href="https://www.kotlincn.net/docs/reference/coroutines/flow.html" target="_blank" rel="noopener">Kotlin åç¨‹ ä¸­æ–‡å®˜ç½‘â€“å¼‚æ­¥æµ</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå¹¶å‘ç¼–ç¨‹ç¬”è®°</title>
      <link href="/blog/posts/b4abf652/"/>
      <url>/blog/posts/b4abf652/</url>
      
        <content type="html"><![CDATA[<h1 id="Thread-join"><a href="#Thread-join" class="headerlink" title="Thread.join()"></a>Thread.join()</h1><p><code>cThread.join()</code>æ–¹æ³•ä½¿å½“å‰çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°å­çº¿ç¨‹<code>cThread</code>æ‰§è¡Œå®Œæ¯•åï¼Œå½“å‰çº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œã€‚</p><p>å®ç°åŸç†ï¼š</p><ol><li><p><code>join()</code>æ–¹æ³•è°ƒç”¨äº†<code>join(0)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    join(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>join(long millis)</code>æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œæœ€åä¼šé€šè¿‡è°ƒç”¨<code>wait()</code>æ–¹æ³•æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆå³<code>è°ƒç”¨çº¿ç¨‹</code>ï¼‰ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨å­çº¿ç¨‹<code>cThread</code>çš„<code>notify()</code>æˆ–è€…<code>notifyAll()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> base = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">long</span> now = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            <span class="keyword">long</span> delay = millis - now;</span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            wait(delay);</span><br><span class="line">            now = System.currentTimeMillis() - base;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å­çº¿ç¨‹<code>run()</code>æ‰§è¡Œå®Œæ¯•åï¼Œç³»ç»Ÿåœ¨å…³é—­è¯¥å­çº¿ç¨‹å‰ï¼Œä¼šè°ƒç”¨å…¶<code>exit()</code>æ–¹æ³•ï¼Œç»§è€Œåœ¨<code>ThreadGroup.threadTerminated(Thread t)</code>ä¸­å”¤é†’è¢«é˜»å¡çš„è°ƒç”¨çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method is called by the system to give a Thread</span></span><br><span class="line"><span class="comment"> * a chance to clean up before it actually exits.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        group.threadTerminated(<span class="keyword">this</span>);<span class="comment">//æå¿ƒThreadGroupå½“å‰çº¿ç¨‹å·²ç»è¢«ç»ˆæ­¢</span></span><br><span class="line">        group = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å…¶ä»–ä»£ç  â€¦â€¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ThreadGroup</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadTerminated</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        remove(t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nthreads == <span class="number">0</span>) &#123;<span class="comment">//çº¿ç¨‹ç»„çº¿ç¨‹æ•°ä¸º0æ—¶</span></span><br><span class="line">            notifyAll();<span class="comment">//å”¤é†’æ‰€æœ‰ç­‰å¾…ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (daemon &amp;&amp; (nthreads == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">            (nUnstartedThreads == <span class="number">0</span>) &amp;&amp; (ngroups == <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="notify-å’ŒnotifyAll-çš„åŒºåˆ«"><a href="#notify-å’ŒnotifyAll-çš„åŒºåˆ«" class="headerlink" title="notify()å’ŒnotifyAll()çš„åŒºåˆ«"></a>notify()å’ŒnotifyAll()çš„åŒºåˆ«</h1><p>å…ˆäº†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š</p><p><strong>é”æ± </strong>ï¼šæŸä¸ª<code>Thread</code>è°ƒç”¨æŸä¸ªå¯¹è±¡çš„åŒæ­¥æ–¹æ³•ï¼ˆ<code>synchronized</code>ï¼‰ï¼Œä½†è¿˜æ²¡è·å–åˆ°è¯¥å¯¹è±¡çš„é”æ—¶ï¼Œä¼šè¿›å…¥é”æ± å’Œå…¶ä»–ç±»ä¼¼çš„çº¿ç¨‹ä¸€èµ·ç«äº‰è¯¥å¯¹è±¡çš„é”ã€‚</p><p><strong>ç­‰å¾…æ± </strong>ï¼šå½“æŸä¸ª<code>Thread</code>è°ƒç”¨æŸä¸ªå¯¹è±¡çš„<code>wait()</code>æ–¹æ³•é‡Šæ”¾æ‰è¯¥å¯¹è±¡çš„é”è¿›å…¥é˜»å¡åï¼ˆwaiting on this objectâ€™s monitorï¼‰ï¼Œä¼šè¿›å…¥ç­‰å¾…æ± ã€‚ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹ä¸ä¼šç«äº‰è¯¥å¯¹è±¡çš„é”ã€‚</p><p><code>notify()</code>æ–¹æ³•ä¼šä»ç­‰å¾…æ± ä¸­å”¤é†’ä¸€ä¸ªæŒ‡å®šçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹å¯ä»¥å†æ¬¡å›åˆ°é”æ± ç«äº‰è¯¥å¯¹è±¡çš„é”ï¼Œ<strong>ä½†å¯èƒ½ä¼šå¯¼è‡´æ­»é”</strong>ï¼ˆå¦‚æœå”¯ä¸€å”¤é†’çš„çº¿ç¨‹é˜»å¡äº†å¹¶ä¾èµ–å…¶ä»–çº¿ç¨‹å”¤é†’ï¼Œä½†å…¶ä»–çº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ± æ— æ³•ç«äº‰é”ï¼Œå¯¼è‡´æ­»é”ï¼‰ã€‚</p><p><code>notifyAll()</code>æ–¹æ³•åˆ™ä¼šå”¤é†’æ‰€æœ‰åœ¨ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹ï¼Œä¹‹åä»–ä»¬éƒ½å¯ä»¥å›åˆ°é”æ± ç«äº‰è¯¥å¯¹è±¡çš„é”ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://juejin.im/post/5b3054c66fb9a00e4d53ef75#heading-2" target="_blank" rel="noopener">Java Threadçš„join() ä¹‹åˆ¨æ ¹é—®åº•</a></p><p><a href="https://www.zhihu.com/question/37601861/answer/145545371" target="_blank" rel="noopener">javaä¸­çš„notifyå’ŒnotifyAllæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ - å¤§ç‹å«æˆ‘æ¥å·¡å±±çš„å›ç­” - çŸ¥ä¹</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 5.xä»¥ä¸‹åŠ è½½MultiDexç™½å±çš„å¤„ç†ä¼˜åŒ–</title>
      <link href="/blog/posts/caa169b7/"/>
      <url>/blog/posts/caa169b7/</url>
      
        <content type="html"><![CDATA[<p>å½“APPçš„minSdkVersionä½äºAndroid 5æ—¶ï¼Œåœ¨æ–¹æ³•æ•°å¤§äº65536æ—¶ï¼Œéœ€è¦å°†APPæ‰“åŒ…ä¸ºå¤šä¸ªDEXæ–‡ä»¶ï¼Œæ­¤æ—¶éœ€è¦æ·»åŠ MultiDexä¾èµ–ã€‚</p><p>å®˜æ–¹æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>1.<code>build.gradle</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        minSdkVersion <span class="number">15</span> </span><br><span class="line">        targetSdkVersion <span class="number">28</span></span><br><span class="line">        multiDexEnabled <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  compile <span class="string">'com.android.support:multidex:1.0.3'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.<code>MyApplication</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æ–¹å¼â¶ï¼š</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">æ–¹å¼â·ï¼š</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">SomeOtherApplication</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">     MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œä¸ºäº†é¿å…ä¸€äº›å¯åŠ¨æœŸé—´éœ€è¦çš„ä»»ä½•ç±»æœªåœ¨ä¸» DEX æ–‡ä»¶ä¸­æä¾›è€Œå¯¼è‡´<code>java.lang.NoClassDefFoundError</code>ï¼Œè¿˜éœ€è¦å‘Šè¯‰ASå°†è¿™äº›ç±»æ·»åŠ åˆ°ä¸»DEXæ–‡ä»¶ä¸­ï¼š</p><p>3.<code>build.gradle</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            â¶ multiDexKeepFile file(<span class="string">'multidex-config.txt'</span>)</span><br><span class="line">            â· multiDexKeepProguard(<span class="string">'multidex-config.pro'</span>)</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//multidex-config.txt</span></span><br><span class="line">com<span class="regexp">/example/</span>MyClass<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class"><span class="title">com</span>/<span class="title">example</span>/<span class="title">MyOtherClass</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">//<span class="title">multidex</span>-<span class="title">config</span>.<span class="title">pro</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">class</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">MyClass</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">class</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">MyClassToo</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">class</span> <span class="title">com</span>.<span class="title">example</span>.** &#123;</span> *; &#125; <span class="comment">// All classes in the com.example package</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨å®é™…è¿è¡Œä¸­ï¼ŒAndroid 4.xçš„ç³»ç»Ÿä¼šåœ¨APPå®‰è£…åç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œåœ¨<code>MultiDex.install(this)</code>æ–¹æ³•ä¸­è¿›è¡ŒDEXæ–‡ä»¶åˆå¹¶ä¼˜åŒ–ç­‰è€—æ—¶æ“ä½œï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œå¾€å¾€ä¼šæŒç»­æ•°åç§’ä»¥ä¸Šï¼Œä»è€Œå¯¼è‡´APPç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶é•¿æ—¶é—´ç™½å±ï¼Œååˆ†å½±å“ä½“éªŒã€‚</p><p>æŸ¥é˜…ç›¸åº”çš„èµ„æ–™åå¤§ä½“æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆ</p><ol><li><p>è®¾ç½®ä¸»Activityçš„èƒŒæ™¯ä¸ºé€æ˜è‰²</p><p>è¿™æ ·å½“ç”¨æˆ·ç‚¹å‡»APPå›¾æ ‡å¯åŠ¨APPæ—¶ï¼Œåœ¨ä¸»Activityå¯åŠ¨ä¹‹å‰çœ‹åˆ°çš„ä¸€ç›´æ˜¯æ¡Œé¢çš„æ ·å­è€Œéç™½å±ï¼Œä½†è¿™åªæ˜¯ä¸€ç§éšœçœ¼æ³•ï¼Œç”¨æˆ·å¯èƒ½ä¼šä»¥ä¸ºç³»ç»Ÿå¡é¡¿ï¼Œä½“éªŒå¹¶ä¸å¥½ã€‚</p></li><li><p>åœ¨Applicationä¸­æ£€æµ‹åˆ°æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨çš„è¯ï¼Œæ–°å¼€ä¸€ä¸ªè¿›ç¨‹å¹¶åœ¨å…¶ä¸­è¿›è¡Œ<code>MultiDex.install(this)</code></p><p>è¿™ç§æ–¹æ³•åœ¨ä¸»è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œæ£€æµ‹åˆ°å°šæœªè¿›è¡ŒMultidexOptï¼Œåˆ™é˜»å¡å½“å‰è¿›ç¨‹ï¼Œæ–°å¼€ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨å…¶ä¸­åŠ è½½ä¸€ä¸ªActivityï¼Œå¹¶åœ¨åå°è¿›ç¨‹è¿è¡Œ<code>MultiDex.install(this)</code>ï¼Œå½“MultidexOptå®Œæˆåå†å…³é—­å½“å‰è¿›ç¨‹ï¼Œè¿”å›ä¸»è¿›ç¨‹ç»§ç»­æ­£å¸¸å¼€å¯APPã€‚</p><p>ç”±äºä¸»è¿›ç¨‹è¢«é˜»å¡çš„åŒæ—¶æˆä¸ºäº†åå°è¿›ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šè§¦å‘ANRï¼Œæ­¤å¤–å­è¿›ç¨‹ä¸­çš„è¿‡æ¸¡Activityä¹Ÿåªç”¨åˆ°äº†åŸºæœ¬çš„ç±»ï¼Œæ‰€ä»¥åŸºæœ¬ä¸ç”¨æ‹…å¿ƒä¼šè§¦å‘<code>java.lang.NoClassDefFoundError</code>ï¼Œè€Œä¸”è¿‡æ¸¡Activityå¯ä»¥å±•ç¤ºè¿›åº¦ã€æç¤ºç­‰ç”¨æˆ·å‹å¥½çš„é¡µé¢ï¼Œç›¸å¯¹æ¥è¯´ä½“éªŒä¹Ÿå¥½äº†å¾ˆå¤šã€‚</p><p>ä½†æ˜¯è¿™ç§æ–¹æ³•ä»å­è¿›ç¨‹è¿”å›ä¸»è¿›ç¨‹æ¶‰åŠåˆ°è¿›ç¨‹é—´é€šä¿¡ï¼Œä»¥åŠä¸»è¿›ç¨‹çš„ä¸»Activityå¯åŠ¨æ—¶ç”Ÿå‘½å‘¨æœŸä¼šå‡ºç°å¼‚å¸¸(<code>onCreate()</code> -&gt; <code>onStart()</code> -&gt; <code>onResume()</code> -&gt; <code>onPause()</code>-&gt;<code>onResume()</code>)ï¼Œä»ç„¶ä¸æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ³•ã€‚</p></li></ol><p>ç»“åˆä¸Šè¿°çš„åˆ†æåï¼Œå¯ä»¥çœ‹åˆ°è¿™ç§é—®é¢˜çš„ä¼˜åŒ–æ€è·¯ä¸»è¦åœ¨äºå¦‚ä½•åœ¨é¿å…<code>java.lang.NoClassDefFoundError</code>çš„åŒæ—¶ï¼Œåœ¨åå°å¯é çš„é€šè¿‡<code>MultiDex.install(this)</code>æ‰§è¡ŒMultidexOptæ“ä½œã€‚</p><p>é€šè¿‡ä»¥ä¸Šæ–¹æ¡ˆ1å’Œ2çš„ç»“åˆï¼Œå¯ä»¥æœ‰ä¸€ä¸ªæ¯”è¾ƒå®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼š</p><ol><li>æ–¹æ¡ˆ2ä¸­åœ¨è¿‡æ¸¡Activityçš„åå°çº¿ç¨‹è¿›è¡ŒMultidexOptæ“ä½œæ€è·¯æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯ä¸éœ€è¦å†å•ç‹¬å¼€ä¸€ä¸ªè¿›ç¨‹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å°†å…¶å½“åšä¸»è¿›ç¨‹çš„ç¬¬ä¸€ä¸ªActivityï¼Œç­‰å¾…MultidexOptæ“ä½œå®Œæˆåå†è·³è½¬åˆ°ä¸»Activityå¹¶finishæ‰æœ¬Activityï¼Œè¿™æ ·ä¸»Activityçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿä¸ä¼šå—å½±å“ã€‚</li><li>è¿™ç§æƒ…å†µä¸‹åœ¨éƒ¨åˆ†ä½ç«¯æœºä¸Šï¼Œè¿‡æ¸¡Activityåˆ°ä¸»Activityè·³è½¬æ—¶ä¼šå‡ºç°çŸ­æš‚é»‘å±ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿‡æ¸¡é¡µé¢å°†Activityåˆ‡æ¢åŠ¨ç”»è®¾ç½®ä¸ºæ¸å˜æ•ˆæœï¼Œå¹¶å°†ä¸»ActivityèƒŒæ™¯è®¾ç½®ä¸ºé€æ˜ï¼Œå¾…ä¸»Activityå®Œå…¨åŠ è½½å¥½åå†å°†èƒŒæ™¯åˆ‡æ¢ä¸ºæ™®é€šæ¨¡å¼ã€‚</li></ol><p>ç»¼ä¸Šå¤„ç†ï¼Œæˆ‘ä»¬çš„Applicationæ— éœ€æ”¹åŠ¨ï¼Œç”šè‡³ä¸»Activityä¹Ÿå¯ä»¥ä¸åšæ”¹åŠ¨ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªè¿‡æ¸¡é¡µé¢ä¸ºå¯åŠ¨Activityï¼Œåœ¨å…¶ä¸­åå°è¿›è¡ŒMultidexOptï¼Œç­‰DEXæ–‡ä»¶å¤„ç†å®Œæ¯•åå†åŠ è½½ä¸»Activityã€‚å¯¹é¡¹ç›®æ”¹åŠ¨å°‘å¹¶ä¸”é€»è¾‘è¾ƒä¸ºç®€å•ã€‚</p><p>æ³¨ï¼š</p><ol><li>MultiDexOptå³æ‰§è¡Œ<code>MultiDex.install(getApplication());</code>æ–¹æ³•ï¼›</li><li>éœ€è¦æ³¨æ„è¿‡æ¸¡Activityå°½é‡å°‘çš„ä½¿ç”¨ç±»ï¼Œå¹¶ä¸”è¦ç¡®ä¿è¿‡æ¸¡Activityå¯èƒ½ä¼šè°ƒç”¨åˆ°çš„ç±»åŠ è½½åˆ°äº†ä¸»dexæ–‡ä»¶ä¸­ã€‚</li></ol><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a href="https://developer.android.google.cn/studio/build/multidex.html?hl=zh-CN" target="_blank" rel="noopener">é…ç½®æ–¹æ³•æ•°è¶…è¿‡ 64K çš„åº”ç”¨</a></p><p><a href="https://www.jianshu.com/p/c2d7b76ff063" target="_blank" rel="noopener">Android MultiDexåˆæ¬¡å¯åŠ¨APPä¼˜åŒ–æ–¹æ¡ˆä¼˜é›…çš„å®ç°</a></p><p><a href="https://www.zybuluo.com/946898963/note/1219741" target="_blank" rel="noopener">MultiDexæ·±å…¥å­¦ä¹ </a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidä¸­Viewç›¸å…³çŸ¥è¯†</title>
      <link href="/blog/posts/1b0362b/"/>
      <url>/blog/posts/1b0362b/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸ºç¬”è®°æ€§è´¨ï¼Œå°šæœªæˆæ–‡ã€‚</p><h1 id="Viewçš„åæ ‡"><a href="#Viewçš„åæ ‡" class="headerlink" title="Viewçš„åæ ‡"></a>Viewçš„åæ ‡</h1><p>Androidä¸­çš„åæ ‡ï¼Œä»¥å±å¹•å·¦ä¸Šè§’é¡¶ç‚¹ä¸ºåŸç‚¹(0,0)ï¼Œä»¥æ¨ªè½´ä¸ºxè½´ï¼Œç«–è½´ä¸ºyè½´ï¼Œæ•°å€¼ä¾æ¬¡é€’å¢ã€‚</p><p>Viewçš„åæ ‡ä¿¡æ¯æœ‰ä»¥ä¸‹å‡ ç§ï¼Œå…¶åæ ‡éƒ½æ˜¯ä»¥çˆ¶Viewçš„å·¦ä¸Šè§’é¡¶ç‚¹ä¸ºåŸç‚¹ï¼š</p><ul><li><p>xï¼Œy æ˜¯Viewçš„å·¦ä¸Šè§’åæ ‡ã€‚</p></li><li><p>translationXï¼ŒtranslationYæ˜¯Viewå·¦ä¸Šè§’é¡¶ç‚¹ä¸çˆ¶å®¹å™¨å·¦ä¸Šè§’é¡¶ç‚¹çš„åç§»é‡ï¼Œé»˜è®¤ä¸º0ã€‚</p></li><li><p>leftï¼Œtop æ˜¯åˆ†åˆ«æ˜¯Viewå·¦ä¸Šè§’é¡¶ç‚¹çš„xè½´ï¼Œyè½´åæ ‡ã€‚</p><p>rightï¼Œbottomåˆ†åˆ«æ˜¯Viewå³ä¸‹è§’é¡¶ç‚¹çš„xè½´ï¼Œyè½´åæ ‡ã€‚</p></li></ul><blockquote><p>æ³¨æ„</p></blockquote><p>x = translationX + leftï¼›</p><p>y = translationY + topï¼›</p><p>æ”¹å˜translationX/Yçš„å€¼ä¾¿å¯ä»¥æ›´æ”¹<strong>Viewçš„ä½ç½®</strong>ã€‚å½“Viewå¹³ç§»çš„æ—¶å€™ï¼Œä»£è¡¨åŸå§‹ä½ç½®ä¿¡æ¯çš„leftï¼Œrightï¼Œtopï¼Œbottomçš„å€¼å¹¶ä¸ä¼šå˜åŒ–ã€‚</p><p>åœ¨OnTouchäº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»eventå¾—åˆ°ä¸¤ç§å€¼ï¼š</p><p>event.rawX,event.rawY ä»£è¡¨ ç›¸å¯¹äºæ‰‹æœºå±å¹•åŸç‚¹çš„åæ ‡</p><p>event.X,event.Y ä»£è¡¨ ç›¸å¯¹äºå½“å‰Viewå·¦ä¸Šè§’çš„åæ ‡</p><p>TouchSlopåˆ™ä»£è¡¨è®¤ä¸ºæ»‘åŠ¨å¼€å§‹çš„æœ€å°è·ç¦»</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ViewConfiguration.<span class="keyword">get</span>(<span class="keyword">this</span>).scaledTouchSlop</span><br></pre></td></tr></table></figure><h1 id="æ»‘åŠ¨"><a href="#æ»‘åŠ¨" class="headerlink" title="æ»‘åŠ¨"></a>æ»‘åŠ¨</h1><p>mScroller.startScroll()æ–¹æ³•å¯ä»¥å®ç°å¹³æ»‘çš„æ»‘åŠ¨</p><p>scrollX,scrollYè¡¨ç¤ºçš„æ˜¯<em>viewçš„Xï¼ŒYåæ ‡å‡å»viewå†…å®¹çš„Xï¼ŒYåæ ‡</em>ã€‚</p><p>æ‰€ä»¥scrollX&gt;0ï¼Œåˆ™è¡¨ç¤ºviewå†…å®¹å‘å·¦ç§»åŠ¨ï¼ŒscrollX&lt;0è¡¨ç¤ºviewå†…å®¹å‘å³ç§»åŠ¨ã€‚ç±»ä¼¼äºçª—æˆ·(view)ä½ç½®ä¸å˜ï¼Œæ™¯è‰²(viewå†…å®¹)çš„scrollX&gt;0å³æ™¯è‰²å‘å³ç§»åŠ¨ï¼Œåˆ™åœ¨çª—æˆ·ä¸­çœ‹åˆ°çš„æ•ˆæœæ˜¯æ™¯è‰²å‘çª—æˆ·å·¦è¾¹ç§»åŠ¨ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> mScroller = Scroller(context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">smoothScrollBy</span><span class="params">(destX: <span class="type">Int</span>, destY: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    mScroller.startScroll(scrollX, scrollY, destX, destY, <span class="number">1000</span>)<span class="comment">//destX, destYçš„å€¼å¦‚æœæ˜¯æ­£çš„è¯ï¼Œä¼šå‘å·¦ï¼Œä¸Šæ–¹ç§»åŠ¨</span></span><br><span class="line">    invalidate()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">computeScroll</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class="line">        scrollTo(mScroller.currX, mScroller.currY)</span><br><span class="line">        postInvalidate()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Scrollerä¸èƒ½ä½¿Viewæ»‘åŠ¨ï¼Œè€Œåªèƒ½é…åˆViewçš„computeScroll()æ–¹æ³•å®ç°æ˜¯<strong>Viewçš„å†…å®¹æ»‘åŠ¨</strong>çš„æ•ˆæœã€‚</p><ul><li>mScroller.startScroll()è®°å½•ä¸‹è¦æ»‘åŠ¨çš„æ•°æ®ï¼Œè€Œinvalidate()é€šçŸ¥Viewé‡ç»˜ï¼›</li><li>æ¯æ¬¡é‡ç»˜éƒ½ä¼šè°ƒç”¨computeScroll()æ–¹æ³•ï¼Œåˆ©ç”¨mScrollerè®¡ç®—å‡ºæ¥ä¸‹æ¥è¦scrollTo()çš„å…·ä½“å€¼å¹¶æ‰§è¡Œï¼Œå†æ¬¡postInvalidate()é€šçŸ¥Viewé‡ç»˜ï¼›</li><li>å¦‚æ­¤åå¤ç›´åˆ°ç»˜åˆ¶æ»‘åŠ¨å®Œæ¯•ã€‚</li></ul><p>ä¸Šè¿°æ— è®ºæ˜¯translationXè¿˜æ˜¯scrollXç­‰å¼•èµ·çš„viewå˜åŒ–ï¼Œéƒ½ä¸èƒ½æ”¹å˜Viewçš„å®šä½ï¼ˆleftï¼Œrightï¼Œtopï¼Œbottomå€¼ï¼‰ï¼Œè€Œå¦‚æœ<strong>æ›´æ”¹marginçš„å€¼ï¼Œåˆ™å¯ä»¥æ›´æ”¹Viewçš„å®šä½</strong>ã€‚</p><h1 id="Windowå’ŒWindowManager"><a href="#Windowå’ŒWindowManager" class="headerlink" title="Windowå’ŒWindowManager"></a>Windowå’ŒWindowManager</h1><p>WindowManager.LayoutParams.flagsæœ‰ä¸‰ä¸ªå¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li>WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL // åªå¤„ç†WindowåŒºåŸŸå†…çš„ç‚¹å‡»äº‹ä»¶ï¼Œä¹‹å¤–çš„äº¤ç»™å…¶ä»–Windowå¤„ç†</li><li>WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE // ä¸æ¥å—è¾“å…¥äº‹ä»¶ï¼Œä¸è·å–ç„¦ç‚¹ï¼ŒåŒæ—¶ä¼šå¼€å¯FLAG_NOT_TOUCH_MODALï¼Œæœ€ç»ˆäº‹ä»¶ä¼šä¼ é€’ç»™ä¸‹å±‚å…·æœ‰ç„¦ç‚¹çš„Window</li><li>WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED  // è®©Windowæ˜¾ç¤ºåœ¨é”å±ç•Œé¢ä¸Š</li></ul><p>WindowManager.LayoutParams.typeä»£è¡¨Windowçš„ç±»å‹(ä¸‰ä¸ª)ï¼š</p><ul><li>åº”ç”¨Window å¯¹åº”ä¸€ä¸ªActivityã€‚<code>z-ordered</code>:1~99</li><li>å­Window ä¸èƒ½å•ç‹¬å­˜åœ¨ï¼Œé™„å±åœ¨ç‰¹å®šçš„çˆ¶Windowä¸­ï¼Œå¦‚Dialogã€‚<code>z-ordered</code>:1000~1999</li><li>ç³»ç»ŸWindow éœ€è¦ç³»ç»Ÿæƒé™ï¼Œå¦‚Toastï¼ŒçŠ¶æ€æ ç­‰ã€‚<code>z-ordered</code>:2000~2999</li></ul><p><code>z-ordered</code>å€¼å¤§çš„Windowä¼šè¦†ç›–æ‰ä½å€¼çš„Windowã€‚</p><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><p>recycleviewæ»‘åŠ¨<br>ItemTouchHelperæºç åˆ†æ <a href="https://www.jianshu.com/p/130fdd755471" target="_blank" rel="noopener">https://www.jianshu.com/p/130fdd755471</a><br>åµŒå¥—æ»‘åŠ¨ <a href="https://blog.csdn.net/qq_15807167/article/details/51637678" target="_blank" rel="noopener">https://blog.csdn.net/qq_15807167/article/details/51637678</a><br><a href="https://www.cnblogs.com/dasusu/p/9159904.html" target="_blank" rel="noopener">https://www.cnblogs.com/dasusu/p/9159904.html</a><br><del>æ»‘åŠ¨å±•ç¤ºåˆ é™¤æŒ‰é’®</del> <a href="https://www.jianshu.com/p/9bfed6e127cc" target="_blank" rel="noopener">https://www.jianshu.com/p/9bfed6e127cc</a> &gt;&gt; å¯¹åº”çš„demoï¼š<a href="https://github.com/jixiaoyong/DiyWidget/blob/master/diy-widget/src/main/java/cf/android666/applibrary/SwipeRecyclerView.kt" target="_blank" rel="noopener">https://github.com/jixiaoyong/DiyWidget/blob/master/diy-widget/src/main/java/cf/android666/applibrary/SwipeRecyclerView.kt</a></p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://blog.csdn.net/Holmofy/article/details/53959511" target="_blank" rel="noopener">Viewæ»‘åŠ¨æ•ˆæœå¸¸ç”¨å±æ€§è¯¦è§£ï¼šscrollã€translationã€LayoutParams</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Androidä¸­çš„Messengeræºç è¯¦è§£</title>
      <link href="/blog/posts/b0dc2559/"/>
      <url>/blog/posts/b0dc2559/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Messengeræ˜¯Androidä¸­ç”¨äºIPCçš„æ–¹å¼ä¹‹ä¸€ï¼Œä½¿ç”¨Handlerå‘é€æœ‰åºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåº•å±‚æ˜¯é€šè¿‡AIDLè°ƒç”¨Binderå®ç°ã€‚</p><p>Messengeråªç”¨äºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸²è¡Œçš„ä¼ é€’æ¶ˆæ¯ï¼Œå¦‚æœå¤§é‡å¹¶å‘æˆ–è€…è·¨è¿›ç¨‹è°ƒç”¨æœåŠ¡ç«¯çš„æ–¹æ³•ï¼Œå°±éœ€è¦è€ƒè™‘AIDLè€ŒéMessengerã€‚</p><p>Messengerçš„ä½¿ç”¨å¯ä»¥å‚è€ƒ<a href="https://jixiaoyong.github.io/blog/posts/ad4c562c/">è¿™ç¯‡æ–‡ç« </a>,æœ¬æ–‡ä¸»è¦æ¢ç´¢ä¸€ä¸‹Messengeræºç å®ç°ã€‚</p><p>ä¸»è¦ä½¿ç”¨åˆ°çš„æ–‡ä»¶ï¼š</p><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/IMessenger.aidl" target="_blank" rel="noopener">IMessenger.aidl</a></p><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/Messenger.java" target="_blank" rel="noopener">Messenger.java</a></p><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/Handler.java" target="_blank" rel="noopener">Handler.java</a></p><h1 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h1><p>ä¸€ä¸ªå…¸å‹çš„MessengeræœåŠ¡å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessengerService</span> : <span class="type">Service</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messenger = Messenger(MessengerHandler())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBind</span><span class="params">(intent: <span class="type">Intent</span>?)</span></span>: IBinder? &#123;</span><br><span class="line">        <span class="keyword">return</span> messenger.binder</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯ä»¥ä»å®¢æˆ·ç«¯çš„å¾—åˆ°çš„Messengerä¸­å–å‡ºè¯¥Handlerï¼Œå¹¶å®ç°å®¢æˆ·ç«¯-&gt;æœåŠ¡ç«¯é€šä¿¡</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MessengerHandler</span> : <span class="type">Handler</span></span>() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg)</span><br><span class="line">            <span class="comment">//å®¢æˆ·ç«¯çš„Messengerï¼Œç”¨äºæœåŠ¡ç«¯-&gt;å®¢æˆ·ç«¯é€šä¿¡,å¯é€‰</span></span><br><span class="line">            <span class="keyword">val</span> client = msg?.replyTo</span><br><span class="line">            client?.send(Message.obtain(<span class="literal">null</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨Handleråˆ›å»ºä¸€ä¸ªMessengerï¼Œè¿›å…¥åˆ°æºç çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IMessenger mTarget;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Messenger</span><span class="params">(Handler target)</span> </span>&#123;</span><br><span class="line">    mTarget = target.getIMessenger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ä¸ç»™å®šçš„Handlerç»‘å®šåœ¨ä¸€èµ·çš„Messengerï¼Œå†çœ‹çœ‹<code>getIMessenger()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> IMessenger <span class="title">getIMessenger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mQueue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mMessenger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mMessenger;</span><br><span class="line">        &#125;</span><br><span class="line">        mMessenger = <span class="keyword">new</span> MessengerImpl();</span><br><span class="line">        <span class="keyword">return</span> mMessenger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerImpl</span> <span class="keyword">extends</span> <span class="title">IMessenger</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        msg.sendingUid = Binder.getCallingUid();</span><br><span class="line">        Handler.<span class="keyword">this</span>.sendMessage(msg);<span class="comment">//ä½¿ç”¨Handlerå‘é€æ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>getIMessenger()</code>æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªMessengerImplå¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡</p><p>å®ç°äº†<code>send()</code>æ–¹æ³•ï¼Œä¹Ÿè¯å®äº†æˆ‘ä»¬ä¹‹å‰çš„ä¸€ä¸ªè§‚ç‚¹â€”â€”Messengeråº•å±‚æ˜¯ä½¿ç”¨Handlerå‘é€æ¶ˆæ¯ã€‚</p><p>åŒæ—¶ï¼Œçœ‹åˆ°MessengerImplç»§æ‰¿çš„IMessenger.Stubç±»æˆ‘ä»¬å¯ä»¥è”æƒ³åˆ°è¿™é‡Œåº”è¯¥æœ‰ä¸€ä¸ªAIDLå®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /frameworks/base/core/java/android/os/IMessenger.aidl</span></span><br><span class="line"><span class="keyword">package</span> android.os;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Message;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">oneway <span class="class"><span class="keyword">interface</span> <span class="title">IMessenger</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(in Message msg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>oneway</code> å…³é”®å­—ç”¨äºä¿®æ”¹è¿œç¨‹è°ƒç”¨çš„è¡Œä¸ºã€‚ä½¿ç”¨è¯¥å…³é”®å­—æ—¶ï¼Œè¿œç¨‹è°ƒç”¨ä¸ä¼šé˜»å¡ï¼›å®ƒåªæ˜¯å‘é€äº‹åŠ¡æ•°æ®å¹¶ç«‹å³è¿”å›ã€‚æ¥å£çš„å®ç°æœ€ç»ˆæ¥æ”¶æ­¤è°ƒç”¨æ—¶ï¼Œæ˜¯ä»¥æ­£å¸¸è¿œç¨‹è°ƒç”¨å½¢å¼å°†å…¶ä½œä¸ºæ¥è‡ª <code>Binder</code> çº¿ç¨‹æ± çš„å¸¸è§„è°ƒç”¨è¿›è¡Œæ¥æ”¶ã€‚ å¦‚æœ <code>oneway</code> ç”¨äºæœ¬åœ°è°ƒç”¨ï¼Œåˆ™ä¸ä¼šæœ‰ä»»ä½•å½±å“ï¼Œè°ƒç”¨ä»æ˜¯åŒæ­¥è°ƒç”¨</p><p><a href="https://developer.android.google.cn/guide/components/aidl?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.google.cn/guide/components/aidl?hl=zh-cn</a></p></blockquote><p>è¿™ä¹Ÿå°±è§£é‡Šäº†åœ¨æœåŠ¡çš„<code>onBind(intent: Intent?)</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨<code>messenger.binder</code>è·å–åˆ°Binderå¯¹è±¡çš„åŸå› ã€‚</p><p>å†çœ‹çœ‹Messengerå®¢æˆ·ç«¯çš„å®ç°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> messenger: Messenger<span class="comment">//æœåŠ¡ç«¯çš„Messenger</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> replyMessenger: Messenger = Messenger(ReplyHandler())<span class="comment">//å®¢æˆ·ç«¯çš„Messengerï¼Œç”¨äºæœåŠ¡ç«¯-&gt;å®¢æˆ·ç«¯é€šä¿¡ï¼Œå¯é€‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> mServiceConnection = <span class="keyword">object</span> : ServiceConnection &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onServiceDisconnected</span><span class="params">(name: <span class="type">ComponentName</span>?)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onServiceConnected</span><span class="params">(name: <span class="type">ComponentName</span>?, service: <span class="type">IBinder</span>?)</span></span> &#123;</span><br><span class="line">        messenger = Messenger(service)<span class="comment">//æ³¨æ„è¿™é‡Œçš„æ„é€ æ–¹æ³•ä¼ å…¥çš„æ˜¯IBinderå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">val</span> message = Message.obtain(<span class="literal">null</span>, <span class="number">1</span>)</span><br><span class="line">        message.replyTo = replyMessenger</span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">data</span> = Bundle()</span><br><span class="line">        <span class="keyword">data</span>.putString(<span class="string">"msg"</span>, <span class="string">"Hello World"</span>)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            messenger.send(message)<span class="comment">//ä½¿ç”¨æœåŠ¡ç«¯çš„Messengerå‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°åœ¨å®¢æˆ·ç«¯é€šè¿‡<code>Messenger(IBinder target)</code>å–å¾—æœåŠ¡ç«¯çš„Messengerï¼Œè€Œè¿™é‡Œçš„IBinderå¯¹è±¡åˆ™æ˜¯é€šè¿‡æœåŠ¡ç«¯çš„Messengerçš„<code>getBinder()</code>è·å–çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Messenger</span><span class="params">(IBinder target)</span> </span>&#123;</span><br><span class="line">    mTarget = IMessenger.Stub.asInterface(target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Stub.asInterface()</code>æ–¹æ³•æˆ‘ä»¬åœ¨<a href="http://jixiaoyong.github.io/blog/posts/88d0bcd1/">ä¹‹å‰çš„æ–‡ç« </a>ä¸­ä»‹ç»è¿‡ï¼Œä»–ä¼šæ ¹æ®å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯å¦åœ¨åŒä¸€è¿›ç¨‹è€Œå†³å®šè¿”å›Stubå®ä¾‹è¿˜æ˜¯Proxyç±»å®ä¾‹ä»¥å®ç°è·¨è¿›ç¨‹é€šä¿¡ã€‚</p><p>è€Œé€šè¿‡æ¯”è¾ƒ <code>Messenger(IBinder target)</code>å’Œ<code>Messenger(Handler target)</code>ä¸¤ä¸ªæ„é€ æ–¹æ³•æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œä¸¤ä¸ªæ–¹æ³•éƒ½åªæ˜¯ç”¨æ¥åˆå§‹åŒ–äº†<code>IMessenger mTarget</code>å¯¹è±¡ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸¤ä¸ªä¸åŒçš„æ„é€ æ–¹æ³•è·å–åˆ°æœ‰åŒæ ·åŠŸèƒ½çš„Messengerã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹</p><p><a href="https://developer.android.google.cn/guide/components/aidl?hl=zh-cn" target="_blank" rel="noopener">Android æ¥å£å®šä¹‰è¯­è¨€ (AIDL)</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Androidä¸­AIDLç›¸å…³çŸ¥è¯†</title>
      <link href="/blog/posts/2270057c/"/>
      <url>/blog/posts/2270057c/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><code>AIDL</code>æ˜¯Androidä¸­ç”¨äºIPCçš„è¯­è¨€ï¼Œå…·ä½“ä½¿ç”¨å¯ä»¥å‚è§<a href="https://jixiaoyong.github.io/blog/posts/f931e8ae/">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æƒ³æ€»ç»“ä¸€ä¸‹<code>AIDL</code>å…·ä½“ä¸ºæˆ‘ä»¬åšäº†ä»€ä¹ˆå·¥ä½œï¼Œä¸»è¦å‚è€ƒä¹¦ç›®ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹ã€‚</p><p>åœ¨Androidä¸­ï¼Œé™¤äº†<code>Socket</code>ã€<code>Intent</code>ä¸­ä½¿ç”¨<code>Bundle</code>ã€æœ¬åœ°æ–‡ä»¶å…±äº«ï¼Œ<code>ContentProvider</code>ç­‰ç­‰ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‹¬æœ‰çš„IPCæ–¹å¼å³<code>Binder</code>ã€‚åœ¨æ—¥å¸¸ç¼–ç¨‹ä¸­ä½¿ç”¨<code>Binder</code>çš„ä¸»è¦æœ‰<code>AIDL</code>å’Œ<code>Messenger</code>ä¸¤ç§æ–¹å¼ï¼Œè€Œ<code>Messenger</code>ä¹Ÿæ˜¯ç”¨<code>AIDL</code>æ¥å®ç°çš„ã€‚</p><h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><ol><li>æ–°å»ºä¸€ä¸ªAIDLæ–‡ä»¶</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IBookManager.aidl</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getSth</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ç”¨AndroidStudioè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªBinderç±»</li></ol><p>ä½¿ç”¨<code>Build</code>-&gt;<code>Make Project</code>ï¼Œä¼šåœ¨<code>app/build/generated/aidl_source_output_dir/debug/compileDebugAidl/out</code>ç›®å½•ä¸‹ç”Ÿæˆ<code>IBookManager.java</code>ã€‚</p><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>AIDLä»å®¢æˆ·ç«¯(Client)å‘èµ·è¯·æ±‚è‡³æœåŠ¡ç«¯(Server)ç›¸åº”çš„å·¥ä½œæµç¨‹æ¦‚è§ˆï¼Œå›¾ç‰‡æ¥æº(<a href="https://blog.csdn.net/qian520ao/article/details/78074983" target="_blank" rel="noopener">https://blog.csdn.net/qian520ao/article/details/78074983</a>)</p><p><img src="https://jixiaoyong.github.io/images/20190320205619.png" alt="AIDLä»å®¢æˆ·ç«¯(Client)å‘èµ·è¯·æ±‚è‡³æœåŠ¡ç«¯(Server)çš„æµç¨‹"></p><p>ä¸‹é¢æˆ‘ä»¬å¯¹<code>IBookManager.java</code>è¿™ä¸ªæ–‡ä»¶ç®€å•åˆ†æä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file is auto-generated.  DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> * Original file: app/src/main/aidl/cf/android666/myapplication/IBookManager.aidl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">  <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span>//<span class="title">IInterface</span>æ¥å£ï¼Œæ‰€æœ‰å¯ä»¥åœ¨<span class="title">Binder</span>ä¸­ä¼ è¾“çš„æ¥å£éƒ½è¦ç»§æ‰¿è‡ªè¯¥æ¥å£</span></span><br><span class="line"><span class="class">  </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Local-side IPC implementation stub class.</span></span><br><span class="line"><span class="comment">     * æŒæœ‰Binderå¯¹è±¡</span></span><br><span class="line"><span class="comment">     * è·å–å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„æ•°æ®ï¼Œæ ¹æ®æ–¹æ³• ID æ‰§è¡Œç›¸åº”æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">     * å°†ä¼ è¿‡æ¥çš„æ•°æ®å–å‡ºæ¥ï¼Œè°ƒç”¨æœ¬åœ°å†™å¥½çš„å¯¹åº”æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * å°†éœ€è¦å›ä¼ çš„æ•°æ®å†™å…¥ reply æµï¼Œä¼ å›å®¢æˆ·ç«¯ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">cf</span>.<span class="title">android666</span>.<span class="title">myapplication</span>.<span class="title">IBookManager</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"cf.android666.myapplication.IBookManager"</span>;<span class="comment">//æ˜¯Binderçš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬ä¸ºå½“å‰Binderçš„ç±»ç›®</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Construct the stub at attach it to the interface.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);<span class="comment">//å°†Binderå’ŒæŒ‡å®šçš„æ¥å£ç»‘å®šï¼Œè¿™æ ·å½“queryLocalInterfaceæ—¶ä¼šè¿”å›ä¸DESCRIPTORä¸€è‡´çš„IInterface</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Cast an IBinder object into an cf.android666.myapplication.IBookManager interface,</span></span><br><span class="line"><span class="comment">         * generating a proxy if needed.</span></span><br><span class="line"><span class="comment">         * å°†æœåŠ¡ç«¯çš„Binderè½¬åŒ–ä¸ºå®¢æˆ·ç«¯éœ€è¦çš„IInterface</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ˜¯ç›¸åŒçš„è¿›ç¨‹ï¼Œåˆ™ç›´æ¥è¿”å›æœåŠ¡ç«¯çš„Stubå¯¹è±¡æœ¬èº«ï¼ˆæ²¡æœ‰è·¨è¿›ç¨‹ï¼‰ï¼›</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ˜¯ä¸åŒçš„è¿›ç¨‹ï¼Œåˆ™è¿”å›çš„æ˜¯Stub.Proxyä»£ç†ç±»å¯¹è±¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> cf.android666.myapplication.<span class="function">IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> cf.android666.myapplication.IBookManager))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((cf.android666.myapplication.IBookManager) iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> cf.android666.myapplication.IBookManager.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å®¢æˆ·ç«¯è¿œç¨‹è¯·æ±‚ç»è¿‡ç³»ç»Ÿå°è£…åè°ƒç”¨è¯¥æ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">        * ç”Ÿæˆ _data å’Œ _reply æ•°æ®æµï¼Œå¹¶å‘ _data ä¸­å­˜å…¥å®¢æˆ·ç«¯çš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">        * é€šè¿‡ transact() æ–¹æ³•å°†å®ƒä»¬ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œå¹¶è¯·æ±‚æœåŠ¡ç«¯è°ƒç”¨æŒ‡å®šæ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">        * æ¥æ”¶ _reply æ•°æ®æµï¼Œå¹¶ä»ä¸­å–å‡ºæœåŠ¡ç«¯ä¼ å›æ¥çš„æ•°æ®</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">            java.lang.String descriptor = DESCRIPTOR;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                    reply.writeString(descriptor);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_getSth: &#123;</span><br><span class="line">                    data.enforceInterface(descriptor);<span class="comment">//ä»dataä¸­å¯ä»¥è¯»å–å‚æ•°</span></span><br><span class="line">                    <span class="keyword">this</span>.getSth();<span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯IBookManagerçš„getSth()ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æˆ‘ä»¬åœ¨ä½¿ç”¨è¯¥Binderæ—¶å®ç°çš„æ–¹æ³•</span></span><br><span class="line">                    reply.writeNoException();<span class="comment">//å¯ä»¥å¾€replyä¸­å†™å…¥ç»“æœ</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Proxyç±»æŒæœ‰IBinderçš„å¼•ç”¨</span></span><br><span class="line"><span class="comment">        * </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">cf</span>.<span class="title">android666</span>.<span class="title">myapplication</span>.<span class="title">IBookManager</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">            Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSth</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_getSth, _data, _reply, <span class="number">0</span>);<span class="comment">//è¿™é‡Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†è¿œç¨‹çš„IBinderçš„transact()æ–¹æ³•</span></span><br><span class="line">                    _reply.readException();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getSth = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);<span class="comment">//è¿™ä¸ªæ˜¯æˆ‘ä»¬åœ¨AIDLä¸­å®šä¹‰çš„getSth()æ–¹æ³•çš„æ ‡å¿—ï¼Œç”¨äºåœ¨onTransactä¸­åŒºåˆ†è°ƒç”¨çš„æ˜¯å“ªä¸ªæ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSth</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException</span>;<span class="comment">//è¿™ä¸ªæ˜¯æˆ‘ä»¬åœ¨AIDLä¸­å®šä¹‰çš„æ–¹æ³•,éœ€è¦åœ¨æœåŠ¡ç«¯å®ç°ï¼Œå¹¶ä¸”ä¼šåœ¨å®¢æˆ·ç«¯è¢«è°ƒç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://blog.csdn.net/qian520ao/article/details/78074983" target="_blank" rel="noopener">Android æ·±å…¥æµ…å‡ºAIDLï¼ˆäºŒï¼‰</a></p><p><a href="https://blog.csdn.net/qian520ao/article/details/78089877" target="_blank" rel="noopener">Android Binderä¹‹åº”ç”¨å±‚æ€»ç»“ä¸åˆ†æ</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OKHttpUtilsåˆ†æ</title>
      <link href="/blog/posts/6ff87ae7/"/>
      <url>/blog/posts/6ff87ae7/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡æ˜¯å¯¹å¼ é¸¿æ´‹çš„OKHttpè¾…åŠ©ç±»<a href="https://github.com/hongyangAndroid/okhttputils" target="_blank" rel="noopener"><strong>okhttputils</strong></a>ç®€è¦åˆ†æï¼Œä»¥ä¾¿å­¦ä¹ å¦‚ä½•å°è£…å¸¸è§å·¥å…·çš„æ€æƒ³ï¼Œå»ºè®®é…åˆæºç é£Ÿç”¨ã€‚</p><p>ä¸»è¦æ¶‰åŠç±»ï¼š</p><ul><li>OkHttpUtils</li><li>OkHttpRequestBuilder</li><li>OkHttpRequest</li><li>RequestCall</li><li>Callback</li></ul><h1 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h1><p><a href="https://github.com/square/okhttp" target="_blank" rel="noopener">OkHttp</a>æ˜¯å¯ä»¥ç”¨äºAndroidå’ŒJavaçš„Httpæ¡†æ¶ï¼Œç»å…¸çš„ä½¿ç”¨åˆ†ä¸º3æ­¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. åˆ›å»ºä¸€ä¸ªOkHttpClientå®¢æˆ·ç«¯ï¼Œåœ¨è¿™é‡Œé…ç½®ç½‘ç»œè¶…æ—¶ç­‰å…¨å±€é…ç½®</span></span><br><span class="line">OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. åˆ›å»ºä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæ¯ä¸ªHttpè®¿é—®å¯¹åº”ä¸€ä¸ªRequestï¼Œè¯¦ç»†é…ç½®äº†è®¿é—®çš„URLï¼Œç±»å‹ï¼Œå‚æ•°ç­‰ä¿¡æ¯</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request</span><br><span class="line">        .Builder()</span><br><span class="line">        .url(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. ä½¿ç”¨OkHttpClientå®¢æˆ·ç«¯åˆ›å»ºCallå¹¶æ‰§è¡Œè¯¥ç½‘ç»œè¯·æ±‚ï¼Œåˆ†ä¸ºé˜»å¡å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ï¼Œå¼‚æ­¥ä¼šæœ‰å¯¹åº”å›è°ƒ</span></span><br><span class="line">okHttpClient.newCall(request)</span><br><span class="line">        .enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>è™½ç„¶æ•´ä½“çš„é€»è¾‘å·²ç»å¾ˆç®€å•äº†ï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œä¸å¯èƒ½å¯¹æ¯ä¸ªç½‘ç»œè¯·æ±‚éƒ½å†™ä¸€æ¬¡ä¸Šè¿°ä»£ç ï¼Œæ‰€ä»¥å°±éœ€è¦å¯¹é½è¿›è¡Œå¿…è¦çš„å°è£…ä»¥ç®€åŒ–ç½‘ç»œè¯·æ±‚æµç¨‹ã€‚</p><p>okhttputilså°±åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”å°†ä¸Šè¿°ç¬¬äºŒæ­¥å¸¸è§ç½‘ç»œè¯·æ±‚çš„è¿‡ç¨‹ä¹ŸåŠ å…¥é“¾å¼è°ƒç”¨ä¸­ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ è¿è´¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. å…¨å±€é…ç½®å”¯ä¸€çš„OkHttpClient</span></span><br><span class="line">OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">        .connectTimeout(<span class="number">10000L</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">        .readTimeout(<span class="number">10000L</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">        .build();</span><br><span class="line">OkHttpUtils.initClient(okHttpClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.åœ¨éœ€è¦ç½‘ç»œè¯·æ±‚çš„æ—¶å€™ï¼Œæ‰§è¡Œå¯¹åº”ä»£ç </span></span><br><span class="line">OkHttpUtils.get()</span><br><span class="line">                .url(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">                .build()</span><br><span class="line">                .execute(<span class="keyword">new</span> com.zhy.http.okhttp.callback.Callback() &#123;</span><br><span class="line">                  <span class="comment">//å›è°ƒæ–¹æ³•</span></span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>9~10</code>è¡Œç›¸å½“äºOKHttpæ­¥éª¤2åˆ›å»ºç½‘ç»œè¯·æ±‚ï¼Œ<code>11~14</code>åˆ™å°±æ˜¯æ­¥éª¤3æ‰§è¡Œç½‘ç»œè¯·æ±‚çš„è¿‡ç¨‹ã€‚</p><p>æ¯æ¬¡ä½¿ç”¨ç½‘ç»œè¯·æ±‚æ—¶åªéœ€è¦é€‰æ‹©<code>get</code>ã€<code>post</code>ç­‰æ–¹æ³•è·å–å¹¶é…ç½®ç›¸åº”<code>builder</code>ï¼Œç„¶åé€‰æ‹©<code>execute</code>æ‰§è¡Œå³å¯ã€‚</p><h1 id="å®ç°åˆ†æ"><a href="#å®ç°åˆ†æ" class="headerlink" title="å®ç°åˆ†æ"></a>å®ç°åˆ†æ</h1><p>é‚£ä¹ˆokhttputilsæ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç‚¹çš„å‘¢ï¼Ÿ</p><p>é¦–å…ˆçœ‹çœ‹<code>OkHttpUtils</code>çš„ç»“æ„ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20190317141417.png" alt></p><p>å¯ä»¥çœ‹åˆ°å¤§ä½“ä¸Šå¯ä»¥å°†å…¶åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>OkHttpClientç›¸å…³</li><li>ç½‘ç»œè¯·æ±‚ç›¸å…³ä¿¡æ¯</li><li>ä¸å…·ä½“æ‰§è¡Œç½‘ç»œè¯·æ±‚æœ‰å…³çš„æ–¹æ³•</li></ol><h2 id="OkHttpClientç›¸å…³"><a href="#OkHttpClientç›¸å…³" class="headerlink" title="OkHttpClientç›¸å…³"></a>OkHttpClientç›¸å…³</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€éƒ¨åˆ†ï¼ŒOkHttpUtilsæœ¬è´¨ä¸Šåªæ˜¯å¯¹OkHttpClientçš„æ–¹æ³•è¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œæ‰€ä»¥å…¶è‚¯å®šè¦æŒæœ‰OkHttpClientå¯¹è±¡ï¼Œä¸€èˆ¬æ¥è¯´ä¸€ä¸ªAPPåªéœ€è¦ä¸€ä¸ªOkHttpClientå¯¹è±¡å³å¯ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°OkHttpUtilsåšäº†åŒé‡é”å®šçš„å•ä¾‹å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OkHttpUtils <span class="title">initClient</span><span class="params">(OkHttpClient okHttpClient)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (OkHttpUtils<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> OkHttpUtils(okHttpClient);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨<code>OkHttpUtils</code>çš„æ—¶å€™åˆå§‹åŒ–çš„<code>OkHttpClient</code>ä¾¿ä¼šè¢«ä¿å­˜åˆ°è¿™é‡Œï¼Œä¹‹åçš„ä½¿ç”¨ä¸­å°±ä¸éœ€è¦å†å»åå¤åˆ›å»ºäº†ã€‚</p><p>æ­¤å¤–åœ¨<code>OkHttpUtils</code>çš„ç»“æ„ä¸­å¯ä»¥æ³¨æ„åˆ°æœ‰ä¸€ä¸ª<code>mPlatform</code>çš„å˜é‡ï¼Œä»–ä¼šæ ¹æ®å½“å‰æ˜¯Androidè¿˜æ˜¯å…¶ä»–å¹³å°çš„ä¸åŒè¢«åˆå§‹åŒ–ä¸ºAndroidä¸»çº¿ç¨‹æˆ–è€…æ™®é€šçº¿ç¨‹æ± ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨åé¢å›è°ƒç½‘ç»œè¯·æ±‚çŠ¶æ€çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Platform mPlatform = findPlatform();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Platform <span class="title">findPlatform</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            Class.forName(<span class="string">"android.os.Build"</span>);</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Android();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Platform();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œè¯·æ±‚ç›¸å…³ä¿¡æ¯"><a href="#ç½‘ç»œè¯·æ±‚ç›¸å…³ä¿¡æ¯" class="headerlink" title="ç½‘ç»œè¯·æ±‚ç›¸å…³ä¿¡æ¯"></a>ç½‘ç»œè¯·æ±‚ç›¸å…³ä¿¡æ¯</h2><p>æœ‰äº†<code>OkHttpClient</code>å¯¹è±¡ä¹‹åï¼Œä¸‹ä¸€æ­¥ä¾¿æ˜¯åˆ›å»ºä¸€ä¸ªé€‚å½“çš„ç½‘ç»œè¯·æ±‚ã€‚</p><p>åœ¨<code>OkHttpUtils</code>ä¸­ä½¿ç”¨çš„æ˜¯<code>OkHttpRequestBuilder &lt;T extends OkHttpRequestBuilder&gt;</code>çš„å­ç±»æ¥æ”¶é›†ã€é…ç½®ç›¸å…³çš„ä¸€äº›å±æ€§ã€‚</p><p>åœ¨è¯¥ç±»ä¸­ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—ç½‘ç»œè¯·æ±‚åŸºæœ¬çš„å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> String url;</span><br><span class="line"><span class="keyword">protected</span> Object tag;</span><br><span class="line"><span class="keyword">protected</span> Map&lt;String, String&gt; headers;</span><br><span class="line"><span class="keyword">protected</span> Map&lt;String, String&gt; params;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> id;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºæ‰§è¡Œç½‘ç»œè¯·æ±‚çš„<code>RequestCall</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> RequestCall <span class="title">build</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•åœ¨å…¶å­ç±»ä¸­çš„å®ç°ä¸€èˆ¬æ˜¯è°ƒç”¨<code>OkHttpRequest</code>å­ç±»çš„<code>build</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°<code>OkHttpRequestBuilder</code>åªæ˜¯å°†ç½‘ç»œè¯·æ±‚çš„ç›¸å…³å‚æ•°ä¼ é€’åˆ°<code>OkHttpRequest</code>ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.zhy.http.okhttp.builder.GetBuilder</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestCall <span class="title">build</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (params != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        url = appendParams(url, params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GetRequest(url, tag, params, headers,id).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>OkHttpRequest</code>ä¸­ï¼Œåˆ©ç”¨ä¸Šè¿°çš„å‚æ•°å¯ä»¥å¹¶é€šè¿‡<code>generateRequest(Callback callback)</code>æ–¹æ³•åˆ›å»º<code>Request</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.zhy.http.okhttp.request.OkHttpRequest</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">OkHttpRequest</span><span class="params">(String url, Object tag,</span></span></span><br><span class="line"><span class="function"><span class="params">                   Map&lt;String, String&gt; params, Map&lt;String, String&gt; headers,<span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.tag = tag;</span><br><span class="line">        <span class="keyword">this</span>.params = params;</span><br><span class="line">        <span class="keyword">this</span>.headers = headers;</span><br><span class="line">        <span class="keyword">this</span>.id = id ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Exceptions.illegalArgument(<span class="string">"url can not be null."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        initBuilder();<span class="comment">//åˆå§‹åŒ–okhttp3.Request.Builderç”¨äºç”ŸæˆRequest</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Request <span class="title">generateRequest</span><span class="params">(Callback callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RequestBody requestBody = buildRequestBody();</span><br><span class="line">    RequestBody wrappedRequestBody = wrapRequestBody(requestBody, callback);<span class="comment">//ç”¨äºæ›´æ–°ä¸‹è½½è¿›åº¦ç­‰ï¼Œä¸ºokhttp3.Callbackå¢åŠ æ›´å¤šåŠŸèƒ½</span></span><br><span class="line">    Request request = buildRequest(wrappedRequestBody);<span class="comment">//åœ¨å­ç±»ä¸­ä½¿ç”¨okhttp3.Request.Builderå¯¹è±¡ç”Ÿæˆå¯¹åº”çš„Request</span></span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æŠ½è±¡æ–¹æ³•<code>wrapRequestBody()</code>ï¼Œ<code>buildRequest()</code>çš„å®ç°ï¼Œä¹Ÿæ˜¯<code>OkHttpRequest</code>å„ä¸ªå­ç±»ä¸»è¦çš„ä¸åŒç‚¹ã€‚</p><blockquote><p><code>Callback</code>æ˜¯åœ¨<code>okhttp3.Callback</code>çš„åŸºç¡€ä¸Šå¢åŠ äº†beforeï¼Œprogresså’Œå¯¹è¯·æ±‚ç»“æœçš„å¤„ç†ç­‰çš„å›è°ƒã€‚</p></blockquote><p><code>OkHttpRequest</code>ç±»çš„<code>build</code>æ–¹æ³•åˆ™åªæ˜¯å°†å…¶è‡ªèº«ä¼ é€’ç»™<code>okhttp3.Call</code>çš„å°è£…ç±»<code>RequestCall</code>ï¼Œåˆ›å»ºå¹¶è¿”å›è¯¥ç±»çš„å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.zhy.http.okhttp.request.OkHttpRequest</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestCall <span class="title">build</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestCall(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‰§è¡Œç½‘ç»œè¯·æ±‚"><a href="#æ‰§è¡Œç½‘ç»œè¯·æ±‚" class="headerlink" title="æ‰§è¡Œç½‘ç»œè¯·æ±‚"></a>æ‰§è¡Œç½‘ç»œè¯·æ±‚</h2><p><code>RequestCall</code>ç±»åˆ™æ˜¯å¯¹<code>okhttp3.Call</code>ç±»çš„è¿›ä¸€æ­¥å°è£…ï¼Œå¯¹å¤–æä¾›æ›´å¤šçš„æ¥å£ï¼šå¼€å§‹ã€å–æ¶ˆç½‘ç»œè¯·æ±‚<code>cancel()</code>,<code>readTimeOut()</code>â€¦ç­‰æ¥å£ã€‚</p><p>å½“æ‰§è¡Œ<code>RequestCall</code>çš„<code>execute</code>æ–¹æ³•æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.zhy.http.okhttp.request.RequestCall</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Callback callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buildCall(callback);<span class="comment">//åˆ›å»ºokhttp3.Callå¯¹è±¡ï¼Œå…¶æ‰€ç”¨çš„Requestå¯¹è±¡æ¥è‡ªäºokHttpRequest.generateRequest(callback)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        callback.onBefore(request, getOkHttpRequest().getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    OkHttpUtils.getInstance().execute(<span class="keyword">this</span>, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å…¶æœ€ååªæ˜¯å°†<code>RequestCall</code>å’Œ<code>callback</code>ä¼ é€’ç»™äº†<code>OkHttpUtils</code>ç±»çš„<code>execute</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†<code>okhttp3.Call</code>çš„<code>enqueue()</code>æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ‰§è¡Œäº†çœŸæ­£çš„ç½‘ç»œè¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.zhy.http.okhttp.OkHttpUtils</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> RequestCall requestCall, Callback callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>)</span><br><span class="line">        callback = Callback.CALLBACK_DEFAULT;</span><br><span class="line">    <span class="keyword">final</span> Callback finalCallback = callback;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> id = requestCall.getOkHttpRequest().getId();</span><br><span class="line"></span><br><span class="line">    requestCall.getCall().enqueue(<span class="keyword">new</span> okhttp3.Callback()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, <span class="keyword">final</span> IOException e)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            sendFailResultCallback(call, e, finalCallback, id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(<span class="keyword">final</span> Call call, <span class="keyword">final</span> Response response)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (call.isCanceled())</span><br><span class="line">                &#123;</span><br><span class="line">                    sendFailResultCallback(call, <span class="keyword">new</span> IOException(<span class="string">"Canceled!"</span>), finalCallback, id);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!finalCallback.validateReponse(response, id))</span><br><span class="line">                &#123;</span><br><span class="line">                    sendFailResultCallback(call, <span class="keyword">new</span> IOException(<span class="string">"request failed , reponse's code is : "</span> + response.code()), finalCallback, id);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object o = finalCallback.parseNetworkResponse(response, id);</span><br><span class="line">                sendSuccessResultCallback(o, finalCallback, id);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                sendFailResultCallback(call, e, finalCallback, id);</span><br><span class="line">            &#125; <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (response.body() != <span class="keyword">null</span>)</span><br><span class="line">                    response.body().close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œç½‘ç»œè¯·æ±‚çš„å›è°ƒï¼Œåˆ™æ˜¯åœ¨æœ¬æ–‡æœ€å¼€å§‹çš„<code>mPlatform</code>æä¾›çš„çº¿ç¨‹ä¸­è¿›è¡Œã€‚è¿™æ ·ä¿è¯äº†åœ¨Androidä¸­ï¼Œ<code>onBefore</code>ã€<code>onAfter</code>ã€<code>inProgress</code>ç­‰å›è°ƒèƒ½å¤Ÿåœ¨UIçº¿ç¨‹è¿›è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSuccessResultCallback</span><span class="params">(<span class="keyword">final</span> Object object, <span class="keyword">final</span> Callback callback, <span class="keyword">final</span> <span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    mPlatform.execute(<span class="keyword">new</span> Runnable()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            callback.onResponse(object, id);</span><br><span class="line">            callback.onAfter(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨æœ¬æ–‡ä¸­ï¼Œ<code>okhttputils</code>å°†åˆå§‹åŒ–<code>OkHttpClient</code>çš„åŠ¨ä½œæå–å‡ºæ¥ï¼Œè¿™æ ·åŒä¸€ä¸ªåº”ç”¨åªéœ€è¦åœ¨æœ€å¼€å§‹çš„æ—¶å€™é…ç½®ä¸€ä¸‹è¯¸å¦‚ç½‘ç»œè¶…æ—¶ã€cookieç­‰æ—¢å¯ã€‚</p><p>åœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œé€šè¿‡<code>OkHttpRequestBuilder</code>æ”¶é›†ç½‘ç»œè¯·æ±‚çš„å±æ€§å¹¶ä¼ é€’ç»™<code>OkHttpRequest</code>ï¼Œåœ¨å…¶å­ç±»ä¸­æŒ‰ç…§ä¸åŒçš„éœ€è¦å®ç°ç”Ÿæˆ<code>Request</code>çš„æ–¹æ³•ã€‚</p><p><code>OkHttpRequestBuilder</code>çš„<code>build()</code>æ–¹æ³•ä¼šç”Ÿæˆ<code>RequestCall</code>å¯¹è±¡ï¼Œ<code>RequestCall</code>å¯¹è±¡çš„<code>execute()</code>æ–¹æ³•ä¼šè°ƒç”¨<code>OkHttpRequestBuilder</code>å¯¹è±¡çš„<code>generateRequest()</code>æ–¹æ³•äº§ç”Ÿ<code>Request</code>ï¼Œå¹¶æ®æ­¤äº§ç”Ÿ<code>Call</code>å¯¹è±¡ï¼Œæœ€åé€šè¿‡è¯¥<code>Call</code>å¯¹è±¡çš„enqueueæ–¹æ³•æ‰§è¡Œç½‘ç»œè¯·æ±‚ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dagger 2 â¤ï¸ Android</title>
      <link href="/blog/posts/c04fdc6c/"/>
      <url>/blog/posts/c04fdc6c/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><a href="http://jixiaoyong.github.io/blog/posts/2822c354/">ä¸Šç¯‡æ–‡ç« </a>ä»‹ç»äº†<code>Dagger 2</code> çš„åŸºæœ¬ä½¿ç”¨ï¼Œæœ¬æ–‡è·Ÿéš<a href="https://google.github.io/dagger/android" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>å®è·µä¸€ä¸‹<code>Dagger 2</code>åœ¨<code>Android</code>ä¸­çš„ä½¿ç”¨ï¼Œå¯ä»¥çœ‹åšæ˜¯å®˜æ–¹æ–‡æ¡£çš„ä¸å®Œå…¨ç¿»è¯‘ã€‚</p><p>æœ¬æ–‡æœ‰å…³<code>Dagger 2</code>çš„ä½¿ç”¨åˆ†ä¸º<code>Activity</code>å’Œ<code>Fragment</code>ä¸¤éƒ¨åˆ†ï¼ŒäºŒè€…çš„ä½¿ç”¨å‡ ä¹æ²¡æœ‰å·®åˆ«ï¼Œæœ€åä»‹ç»ä¸€ä¸‹åœ¨Googleå®˜æ–¹Demoä¸­å­¦åˆ°çš„ä¸€ä¸ªå°æŠ€å·§ï¼Œå¯ä»¥å°†å‡ ä¹æ‰€æœ‰çš„å’Œ<code>Dagger 2</code>çš„é€»è¾‘æ”¾åˆ°ä¸€ä»½ä»£ç é‡Œé¢ï¼Œå¯¹<code>Android</code>å·¥ç¨‹çš„å½±å“æå°ã€‚</p><p>é¦–å…ˆè¦æ·»åŠ ç›¸å…³ä¾èµ–ï¼ˆKotlinç¯å¢ƒï¼‰ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'kotlin-kapt'</span><span class="comment">//å¼•ç”¨è¯¥æ’ä»¶</span></span><br><span class="line">implementation <span class="string">"com.google.dagger:dagger:$rootProject.dagger2Version"</span></span><br><span class="line">implementation <span class="string">"com.google.dagger:dagger-android-support:$rootProject.dagger2Version"</span><span class="comment">//Androidç‰¹éœ€</span></span><br><span class="line">kapt <span class="string">"com.google.dagger:dagger-compiler:$rootProject.dagger2Version"</span><span class="comment">//æ³¨æ„å¦‚æœæ˜¯kotlinè¯­è¨€ï¼Œè¿™é‡Œéœ€è¦æ—¶#kapt#</span></span><br></pre></td></tr></table></figure><h1 id="åœ¨Activityä¸­çš„ä½¿ç”¨"><a href="#åœ¨Activityä¸­çš„ä½¿ç”¨" class="headerlink" title="åœ¨Activityä¸­çš„ä½¿ç”¨"></a>åœ¨Activityä¸­çš„ä½¿ç”¨</h1><h2 id="ApplicationèŒƒå›´å†…çš„-Component"><a href="#ApplicationèŒƒå›´å†…çš„-Component" class="headerlink" title="ApplicationèŒƒå›´å†…çš„@Component"></a>ApplicationèŒƒå›´å†…çš„@Component</h2><p>é¦–å…ˆåˆ›å»ºæ•´ä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨çš„<code>@Component</code>ï¼Œå¹¶å°†<code>AndroidInjectionModule</code>åŠ å…¥å…¶ä¸­ï¼Œå®ç°<code>Inject</code>æ³¨å…¥å…¥å£ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(modules = [AndroidInjectionModule::class, MainActivityModule::class])</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(application: <span class="type">MainApplication</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AppComponent</code>çš„èŒƒå›´æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰æ•ˆã€‚</p><h2 id="åˆ›å»ºå•ä¸ªActivityçš„-Subcomponent"><a href="#åˆ›å»ºå•ä¸ªActivityçš„-Subcomponent" class="headerlink" title="åˆ›å»ºå•ä¸ªActivityçš„@Subcomponent"></a>åˆ›å»ºå•ä¸ªActivityçš„@Subcomponent</h2><p>åˆ›å»ºæŸä¸ª<code>Activity</code>ä¸“å±çš„<code>@Subcomponent</code>ï¼Œç”¨äºæä¾›<code>AndroidInjector.Builder</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subcomponent</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MainActivitySubComponent</span> : <span class="type">AndroidInjector</span>&lt;<span class="type">MainActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> : <span class="type">AndroidInjector.Builder</span>&lt;<span class="type">MainActivity</span>&gt;</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºå•ä¸ªActivityçš„-Module"><a href="#åˆ›å»ºå•ä¸ªActivityçš„-Module" class="headerlink" title="åˆ›å»ºå•ä¸ªActivityçš„@Module"></a>åˆ›å»ºå•ä¸ªActivityçš„@Module</h2><p>åˆ›å»ºå±äºæ•´ä¸ª<code>Activity</code>çš„<code>@Module</code>ï¼Œæ³¨æ„è¿™é‡Œè¦æŒ‡æ˜<code>@subcomponents</code>ä¸ºåˆšåˆšåˆ›å»ºçš„<code>MainActivitySubComponent</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module(includes = [MainActivityModule.InnerModule::class], subcomponents = [MainActivitySubComponent::class])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivityModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bindWaitForInjectClass</span><span class="params">()</span></span> = WaitForInjectClass()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Module</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerModule</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Binds</span></span><br><span class="line">        <span class="meta">@IntoMap</span></span><br><span class="line">        <span class="meta">@ClassKey(MainActivity::class)</span></span><br><span class="line">        <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindInjectorFactory</span><span class="params">(builder: <span class="type">MainActivitySubComponent</span>.<span class="type">Builder</span>)</span></span>: AndroidInjector.Factory&lt;*&gt;<span class="comment">//æ³¨æ„è¿™é‡Œæ˜¯ Factory&lt;*&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WaitForInjectClass</span> //ä¸€ä¸ªä¾›ä¾èµ–æ³¨å…¥çš„ç±»</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨<code>MainActivityModule</code>ä¸­æä¾›äº†ä¸€ä¸ªæ–¹æ³•åˆ©ç”¨åˆšåˆš<code>MainActivitySubComponent</code>ä¸­æä¾›çš„<code>MainActivitySubComponent.Builder</code>å®ä¾‹ç”Ÿæˆäº†ä¸€ä¸ª<code>AndroidInjector.Factory</code>ï¼Œè€Œè¿™ä¸ª<code>Factory</code>å°±æ˜¯æˆ‘ä»¬åé¢è¦å°†<code>MainActivityModule</code>ä¸­çš„ä¾èµ–å®ä¾‹é€šè¿‡<code>AppComponent</code>ä¼ é€’ç»™<code>MainActivity</code>å®ä¾‹çš„å…³é”®ã€‚</p><blockquote><p>æ­¤å¤–è¿˜å¯ä»¥çœ‹åˆ°æä¾›è¯¥Factoryçš„æ–¹æ³•æ˜¯æ”¾åˆ°äº†å¦å¤–ä¸€ä¸ªæŠ½è±¡ç±»é‡Œé¢ç„¶åå†å¯¼å…¥MainActivityModuleä¸­çš„ï¼Œè¿™æ˜¯å› ä¸ºè¯¥æ–¹æ³•çš„æ³¨è§£@Bindsè¦æ±‚æ–¹æ³•æ˜¯æŠ½è±¡çš„ï¼Œè€ŒMainActivityModuleè¦æ˜¯éœ€è¦ç»™Activityæä¾›ä¾èµ–å®ä¾‹æ‰€å¿…é¡»çš„@Providesåˆè¦æ±‚ç±»ä¸èƒ½æ˜¯æŠ½è±¡çš„ï¼Œå¦åˆ™å°±è¦æ±‚è¯¥æ–¹æ³•æ˜¯é™æ€çš„ã€‚æƒè¡¡ä¹‹ä¸‹æˆ‘è§‰å¾—è¿™ç§æ–¹å¼æ˜¯æ¯”è¾ƒèƒ½æ¥å—çš„ï¼Œå½“ç„¶ä¹Ÿä¸æ’é™¤æœ‰å…¶ä»–æ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œæ¬¢è¿æ<a href="https://github.com/jixiaoyong/jixiaoyong.github.io/issues" target="_blank" rel="noopener">Issue</a>å‘ŠçŸ¥ã€‚</p></blockquote><p>ç„¶åï¼Œå°†<code>MainActivityModule</code>åŠ å…¥åˆ°åº”ç”¨ç¨‹åºçš„<code>@Component</code>â€”â€”<code>AppComponent</code>ä¸­ã€‚</p><h2 id="ä½¿Applicationç»§æ‰¿è‡ª-HasActivityInjector"><a href="#ä½¿Applicationç»§æ‰¿è‡ª-HasActivityInjector" class="headerlink" title="ä½¿Applicationç»§æ‰¿è‡ª HasActivityInjector"></a>ä½¿Applicationç»§æ‰¿è‡ª <a href="https://google.github.io/dagger/api/latest/dagger/android/HasActivityInjector.html" target="_blank" rel="noopener"><code>HasActivityInjector</code></a></h2><p>ä½¿å½“å‰<code>MainApplication</code>ç»§æ‰¿è‡ª<code>HasActivityInjector</code>ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Returns an &#123;<span class="doctag">@link</span> AndroidInjector&#125; of &#123;<span class="doctag">@link</span> Activity&#125;s. */</span></span><br><span class="line">AndroidInjector&lt;Activity&gt; activityInjector();</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»æ˜¯ç”¨æ¥ä¸ºç›¸åº”çš„<code>Activity</code>æä¾›ä¸€ä¸ª<code>AndroidInjector</code>ã€‚ç”±äºæˆ‘ä»¬å·²ç»åœ¨<code>AppComponent</code>ä¸­åŒ…æ‹¬äº†<code>AndroidInjectionModule</code>ï¼Œæ‰€ä»¥<code>Dagger 2</code>å·²ç»å¯ä»¥è‡ªåŠ¨ä¸ºæˆ‘ä»¬æ³¨å…¥<code>DispatchingAndroidInjector</code>ä¾èµ–ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> : <span class="type">HasActivityInjector</span>, <span class="type">Application</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        DaggerAppComponent.create().inject(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> dispatchActivityInjector: DispatchingAndroidInjector&lt;Activity&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">activityInjector</span><span class="params">()</span></span> = dispatchActivityInjector<span class="comment">//è¿”å›Dagger 2ä¸ºæˆ‘ä»¬æ³¨å…¥çš„dispatchActivityInjectorå¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>onCreate()</code>æ–¹æ³•ä¸­ä¼ å…¥å½“å‰<code>Application</code>çš„ä¾èµ–ã€‚</p><h2 id="åœ¨Activityä¸­ä½¿ç”¨è‡ªåŠ¨æ³¨å…¥ä¾èµ–"><a href="#åœ¨Activityä¸­ä½¿ç”¨è‡ªåŠ¨æ³¨å…¥ä¾èµ–" class="headerlink" title="åœ¨Activityä¸­ä½¿ç”¨è‡ªåŠ¨æ³¨å…¥ä¾èµ–"></a>åœ¨Activityä¸­ä½¿ç”¨è‡ªåŠ¨æ³¨å…¥ä¾èµ–</h2><p>åšå®Œäº†ä»¥ä¸Šæ‰€æœ‰å†…å®¹ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>Activity</code>ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç å°±å¯ä»¥å®ç°è‡ªåŠ¨æ³¨å…¥ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> waitForInjectClass: WaitForInjectClass</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        AndroidInjection.inject(<span class="keyword">this</span>)<span class="comment">//æ³¨æ„è¿™é‡Œï¼Œåœ¨super()ä¹‹å‰è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_dagger2_x_android_main)</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">"TAG"</span>, <span class="string">"The Class is <span class="variable">$waitForInjectClass</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ‰€æœ‰ä»£ç å¦‚ä¸‹ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥<a href="https://gist.github.com/jixiaoyong/db7e5f18b7106ce9cb36b61bf7134340" target="_blank" rel="noopener">åœ¨è¿™é‡Œæ‰¾åˆ°</a>ï¼š</p><script src="https://gist.github.com/jixiaoyong/db7e5f18b7106ce9cb36b61bf7134340.js"></script><h2 id="è¿™ä¸€åˆ‡æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"><a href="#è¿™ä¸€åˆ‡æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="è¿™ä¸€åˆ‡æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"></a>è¿™ä¸€åˆ‡æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</h2><p>åœ¨<code>Android</code>ç¨‹åºè¿è¡Œæ—¶ï¼Œ<code>AndroidInjection.inject()</code>ä»<code>Application</code>ä¸­çš„<code>activityInjector()</code>æ–¹æ³•è·å–åˆ° <code>DispatchingAndroidInjector&lt;Activity&gt;</code> ï¼Œç„¶åå°†<code>Activity</code>ä¼ å…¥<code>inject(Activity)</code>ã€‚</p><p><code>DispatchingAndroidInjector</code> é€šè¿‡<code>AppComponent</code>æ‰¾åˆ°æˆ‘ä»¬åœ¨<code>MainActivityModule</code>æä¾›çš„å¯¹åº”çš„<code>AndroidInjector.Factory</code>ï¼Œç„¶ååˆ›å»ºäº† <code>AndroidInjector</code> â€”â€”è¿™å°±æ˜¯æˆ‘ä»¬å½“å‰<code>Activity</code>å¯¹åº”çš„<code>MainActivitySubComponent</code>ã€‚</p><p>æ¥ä¸‹æ¥ä¾¿æŒ‰ç…§ä¹‹å‰çš„é€»è¾‘ï¼Œä»<code>MainActivitySubComponent</code>ä¸­æŸ¥æ‰¾æä¾›<code>waitForInjectClass</code>çš„å®ä¾‹æ–¹æ³•å®Œæˆæ³¨å…¥ã€‚</p><h1 id="åœ¨Fragmentä¸­çš„ä½¿ç”¨"><a href="#åœ¨Fragmentä¸­çš„ä½¿ç”¨" class="headerlink" title="åœ¨Fragmentä¸­çš„ä½¿ç”¨"></a>åœ¨Fragmentä¸­çš„ä½¿ç”¨</h1><p><code>Dagger 2</code>åœ¨<code>Fragment</code>çš„ä½¿ç”¨å’Œåœ¨<code>Activity</code>ä¸­çš„ä½¿ç”¨ååˆ†ç›¸ä¼¼ã€‚</p><p>é€šè¿‡ä¹‹å‰çš„ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå…¶åŸºæœ¬çš„åŸç†ä¾æ—§æ˜¯åˆ©ç”¨<code>@Component</code>å’Œ<code>@subcomponent</code>ï¼Œ<code>@Module</code>ä¹‹é—´çš„å…³è”å…³ç³»å°†<code>Application</code>å’Œ<code>Activity</code>ç­‰çš„ä¾èµ–æ³¨å…¥é€šè¿‡<code>AndroidInjector</code>å…³è”èµ·æ¥çš„ï¼š</p><p><code>MainActivitySubComponent</code>é€šè¿‡å°†<code>MainActivityModule</code>åŠ å…¥åˆ°<code>AppComponent</code>ä¹‹ä¸­ï¼Œç„¶åå½“<code>MainActivity</code>ä¹‹ä¸­éœ€è¦ä½¿ç”¨åˆ°<code>MainActivitySubComponent</code>æ—¶ï¼Œåˆé€šè¿‡<code>AndroidInjector</code>ä»<code>AppComponent</code>ä¸­æ‹¿åˆ°<code>MainActivityModule</code>ä¸­çš„<code>AndroidInjector.Factory</code>ï¼Œé€šè¿‡è¯¥<code>Factory</code>å’Œ<code>MainActivitySubComponent</code>ä¸­çš„<code>Builder</code>äº§ç”Ÿå…³è”ï¼Œä»è€Œè·å–åˆ°äº†<code>MainActivitySubComponent</code>çš„å®ä¾‹ä¾›<code>Activity</code>ä½¿ç”¨ã€‚</p><p>åœ¨<code>Fragment</code>ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·å¤„ç†ï¼Œåªä¸è¿‡ç”±äº<code>Fragment</code>çš„ç‰¹æ€§ï¼Œä»–çš„<code>@Module</code>ä¸ä»…å¯ä»¥äº¤ç»™<code>Application</code>çš„<code>@Component</code>ï¼Œä¹Ÿå¯ä»¥äº¤ç»™å…¶ä»–<code>Fragment</code>æˆ–è€…<code>Activity</code>çš„<code>@Component</code>ï¼Œè®©å…¶å®ç°<code>HasFragmentInjector</code>å³å¯ï¼Œè¿™å–å†³äºæˆ‘ä»¬æƒ³è¦ç»™<code>Fragment</code>ç»‘å®šçš„ä¾èµ–ã€‚</p><p>å…·ä½“çš„å®ç°ä¸€èˆ¬åˆ†ä¸ºä¸‹é¢å‡ æ­¥ï¼š</p><ul><li><p>åˆ›å»º<code>Application</code>çš„<code>@Component</code>å¹¶æ·»åŠ <code>AndroidInjectionModule</code></p></li><li><p>åˆ›å»ºå®ç°äº†<code>AndroidInjector&lt;MainFragment&gt;</code>çš„<code>MainFragmentSubComponent</code>ï¼Œå…¶å†…éƒ¨æœ‰æ–¹æ³•æä¾›<code>AndroidInjector.Builder&lt;MainFragment&gt;</code></p></li><li><p>åˆ›å»ºåŒ…å«äº†æä¾›<code>AndroidInjector.Factory&lt;*&gt;</code>çš„æŠ½è±¡æ–¹æ³•çš„<code>MainFragmentModule</code>ï¼ŒæŒ‡å®šå…¶<code>subcomponents</code>ä¸º<code>MainFragmentSubComponent</code>ï¼›</p></li><li><p>å°†<code>MainFragmentSubComponent</code>åŠ å…¥åˆ°æƒ³è¦åŠ å…¥çš„ç±»çš„<code>@Component</code>ä¸­ï¼Œæ¯”å¦‚<code>AppComponent</code>ç±»</p></li><li><p>åœ¨<code>Application</code>ï¼ˆå¦‚æœä¸Šä¸€æ­¥æ˜¯<code>Activity</code>ï¼Œåˆ™æœ¬æ­¥ä¹Ÿæ˜¯<code>Activity</code>ç­‰ï¼‰ä¸­å‚ç…§åœ¨<code>Activity</code>å®ç°çš„æ­¥éª¤å®ç°<code>HasFragmentInjector</code></p><p>ä¸Šè¿°å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥<a href="https://gist.github.com/jixiaoyong/a24e76ca29f4c8062bf5c6a98529d252" target="_blank" rel="noopener">åœ¨è¿™é‡Œæ‰¾åˆ°</a>ï¼š</p><script src="https://gist.github.com/jixiaoyong/a24e76ca29f4c8062bf5c6a98529d252.js"></script></li></ul><p>å…³äº<code>Fragment</code>åŠ å…¥åˆ°<code>Activity</code>çš„Demoåœ¨å®˜æ–¹æ–‡æ¡£æœ‰ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œå…¶å®åªè¦æŒæ¡åŸç†ï¼Œå…¶ä»–ç”¨æ³•çš„å®Œå…¨å¯ä»¥è§¦ç±»æ—é€šã€‚</p><h1 id="ä¸€ä¸ªå°æŠ€å·§"><a href="#ä¸€ä¸ªå°æŠ€å·§" class="headerlink" title="ä¸€ä¸ªå°æŠ€å·§"></a>ä¸€ä¸ªå°æŠ€å·§</h1><p>é€šè¿‡è§‚å¯Ÿä¸Šé¢çš„ä¸¤ä»½ä»£ç ï¼Œæˆ‘ä»¬å‘ç°è™½ç„¶è¿™<code>Dagger 2</code>å·²ç»æ›¿æˆ‘ä»¬åšäº†å¥½å¤šäº‹æƒ…ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨éœ€è¦ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„ç±»ä¸­ä½¿ç”¨è¯¸å¦‚<code>AndroidInjection.inject(this)</code>è¿™æ ·çš„ä»£ç å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¦‚æœ<code>Activity</code>ã€<code>Fragment</code>ç±»è¿‡å¤šçš„æ—¶å€™ï¼Œè¿™æ ·çš„é‡å¤æ€§å·¥ä½œä»ç„¶æ˜¯ä¸ªä¸å°çš„å·¥ä½œé‡ï¼Œä¸‡ä¸€æœ‰æŸå¤„é—å¿˜äº†ä¾¿ä¼šå¯¼è‡´å‡ºé”™ã€‚</p><p>è¿™æ—¶å°±å¯ä»¥ç”¨åˆ°æˆ‘åœ¨<a href="https://github.com/googlesamples/android-architecture-components/tree/master/GithubBrowserSample" target="_blank" rel="noopener">Googleå®˜æ–¹ç¤ºä¾‹ä»£ç </a>ä¸­å­¦åˆ°çš„ä¸€ä¸ªå°æŠ€å·§äº†(é’ˆå¯¹æœ¬æ–‡ä¸­çš„ä¾‹å­åšäº†ä¸€äº›ä¿®æ”¹)ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥<a href="https://gist.github.com/jixiaoyong/9260c3ae2a70555e14f40c4b95364715" target="_blank" rel="noopener">åˆ°è¿™é‡ŒæŸ¥çœ‹æºç </a>ï¼š</p><script src="https://gist.github.com/jixiaoyong/9260c3ae2a70555e14f40c4b95364715.js"></script><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://google.github.io/dagger/android" target="_blank" rel="noopener">Dagger 2 å®˜æ–¹æ–‡æ¡£ Androidç¯‡</a></p><p><a href="https://github.com/googlesamples/android-architecture-components/tree/master/GithubBrowserSample" target="_blank" rel="noopener">Googleå®˜æ–¹ç¤ºä¾‹ä»£ç â€”â€”GithubBrowserSample</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> dagger2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dagger 2 ä»0åˆ°1ä¹‹æ—…</title>
      <link href="/blog/posts/2822c354/"/>
      <url>/blog/posts/2822c354/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><code>Dagger 2</code>æ˜¯Googleç»´æŠ¤çš„ä¸€æ¬¾å¯ç”¨äº<code>Java</code>å’Œ<code>Android</code>çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ã€‚</p><p>æœ¬æ–‡ä¸»è¦æ˜¯ç®€å•æ¢³ç†<code>Dagger 2</code>ä¸­å„ä¸ªæ³¨è§£çš„ä½œç”¨ï¼Œä»¥åŠå…¶ç®€å•ç”¨æ³•ï¼Œä¸æ¶‰åŠå…·ä½“é¡¹ç›®åº”ç”¨ã€‚</p><p>å…ˆè§£é‡Šå‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li><p><strong><code>ä¾èµ–æ³¨å…¥</code></strong>ï¼šæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆæˆ–é™æ€æ–¹æ³•ï¼‰ç»™å¦ä¸€ä¸ªå¯¹è±¡æä¾›ä¾èµ–çš„æŠ€æœ¯ã€‚</p></li><li><p><strong><code>ä¾èµ–</code></strong>æ˜¯å¯ä»¥ä½¿ç”¨çš„å¯¹è±¡ï¼ˆ<code>Service</code>ï¼‰ï¼Œè€ŒæŠŠä¾èµ–æä¾›ç»™ä½¿ç”¨è¯¥ä¾èµ–çš„å¯¹è±¡ï¼ˆ<code>Client</code>ï¼‰çš„è¿‡ç¨‹å«åš<code>æ³¨å…¥</code>ã€‚</p></li></ul><p>ä¾‹å¦‚ï¼Œä¸‹é¢è¿™æ®µä»£ç ä¸­<code>Service</code>å°±æ˜¯<code>Client</code>çš„ä¾èµ–ã€‚ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>()&#123;</span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> service = Service()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœæ¯ä¸ªä¾èµ–éƒ½è¿™æ ·å†™çš„è¯ï¼Œå¦‚æœ<code>Service</code>ç±»çš„æ„é€ æ–¹æ³•æœ‰å˜æ›´ï¼Œå°±éœ€è¦åŒæ—¶ä¹Ÿæ›´æ”¹<code>Client</code>å¯¹åº”çš„æ–¹æ³•ï¼Œè¿™æ ·æ·±è€¦åˆçš„ä»£ç æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚</p><p><code>Dagger 2</code>å°±æ˜¯ä¸ºäº†å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä½¿ç”¨å®ƒä¹‹åï¼Œ<code>Client</code>ç±»çš„ä»£ç åªéœ€è¦è¿™æ ·å†™æˆç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼ˆç¤ºä¾‹ä»£ç ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> service: Service</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">//TODO æŸä¸ªå°†Serviceä¾èµ–æ³¨å…¥çš„æ–¹æ³• magicFun()</span></span><br><span class="line">        <span class="keyword">val</span> newService = service<span class="comment">//ä½¿ç”¨Serviceçš„å®ä¾‹service</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶<code>Service</code>çš„å®ä¾‹åŒ–è¿‡ç¨‹è¢«ç§»åˆ°äº†<code>Client</code>çš„å¤–éƒ¨æŸå¤„ï¼Œè¿™æ ·å¦‚æœ<code>Service</code>æ„é€ æ–¹æ³•æœ‰æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç»Ÿä¸€å»ä¿®æ”¹<code>magicFun()</code>ä¸­å¯¹åº”çš„ä»£ç å³å¯ã€‚</p><p>é‚£ä¹ˆè¿™ä¸€åˆ‡<code>Dagger 2</code>åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><h1 id="Dagger-2-å…·ä½“å®ç°"><a href="#Dagger-2-å…·ä½“å®ç°" class="headerlink" title="Dagger 2 å…·ä½“å®ç°"></a>Dagger 2 å…·ä½“å®ç°</h1><h2 id="Inject"><a href="#Inject" class="headerlink" title="@Inject"></a>@Inject</h2><p>é¦–å…ˆéœ€è¦è¯·å‡ºç¬¬ä¸€ä¸ªä¸»è§’â€”â€”<strong><code>@Inject</code></strong>ã€‚</p><p>åœ¨<code>Dagger 2</code>ä¸­ï¼Œ<code>@Inject</code>ä¸»è¦åšä¸¤ä»¶äº‹â¶æ ‡è®°ä¾èµ–ç±»çš„æ„é€ æ–¹æ³•ï¼›â·æ ‡è®°éœ€è¦æ¡†æ¶è‡ªåŠ¨å®ä¾‹åŒ–çš„å¯¹è±¡ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()<span class="comment">//â¶æ ‡è®°ä¾èµ–ç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> service: Service<span class="comment">//â·æ ‡è®°éœ€è¦æ¡†æ¶è‡ªåŠ¨å®ä¾‹åŒ–çš„å¯¹è±¡</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·<code>Dagger 2</code>å°±çŸ¥é“äº†æœ‰ä¸ªå¯¹è±¡éœ€è¦å®ƒæ¥å¸®åŠ©æˆ‘ä»¬æ³¨å…¥ï¼ŒåŒæ—¶ä¹ŸçŸ¥é“äº†æœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–<code>Service</code>å¯¹è±¡ã€‚ä½†è¿™æ—¶å¦‚ä½•å°†äºŒè€…è”ç³»èµ·æ¥å‘¢ï¼Ÿ</p><h2 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h2><p>è¿™å°±è¦æåˆ°ç¬¬äºŒä¸ªä¸»è§’â€”â€”<strong><code>@Component</code></strong>ã€‚</p><p><code>@Component</code>æ ‡è®°çš„ç±»æ˜¯å°†ä¸€ä¸ªç±»å’Œä»–çš„ä¾èµ–è”ç³»åœ¨ä¸€èµ·çš„æ¡¥æ¢ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª<strong>æŠ½è±¡ç±»æˆ–è€…æ¥å£</strong>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClientComponent</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(client: <span class="type">Client</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>Client</code>å’Œ<code>Service</code>é€šè¿‡<code>ClientComponent</code>è”ç³»åœ¨ä¸€èµ·ï¼Œåœ¨ä½¿ç”¨æ—¶åªéœ€è¦å°†<code>Client</code>çš„å¼•ç”¨ä¼ å…¥å³å¯ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">    <span class="comment">//æ–¹å¼â¶ DaggerClientComponent.create().inject(this)</span></span><br><span class="line">    <span class="comment">//æ–¹å¼â· DaggerClientComponent.builder().build().inject(this)</span></span><br><span class="line">    <span class="keyword">val</span> newService = service</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå®Œæ•´çš„ä»£ç å¯ä»¥å‚è€ƒè¿™é‡Œ,<a href="https://gist.github.com/jixiaoyong/8abd44901a2816e2b6722566bb8f08d8#file-dagger2_basic_guide_line_part1-kt" target="_blank" rel="noopener">è‹¥æ— æ³•æ˜¾ç¤ºå¯ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹</a>ï¼š</p><script src="https://gist.github.com/jixiaoyong/8abd44901a2816e2b6722566bb8f08d8.js"></script><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¯¹äºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ç±»ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨<code>@Inject</code>æ ‡è®°å…¶æ„é€ æ–¹æ³•ï¼Œç„¶åå†åœ¨ä½¿ç”¨è¯¥ç±»çš„æ—¶å€™ä½¿ç”¨<code>@Inject</code>æ ‡è®°è¯¥å¯¹è±¡ï¼Œåœ¨éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡çš„åœ°æ–¹é€šè¿‡<code>@Component</code>ç±»ä¼ å…¥ä½¿ç”¨è¯¥ä¾èµ–çš„ç±»çš„å¼•ç”¨å³å¯ã€‚</p><center> <img style="border-radius: 0.3125em; box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="https://jixiaoyong.github.io/images/20190126184230.png"> <br> <div style="color:orange; border-bottom: 1px solid #d9d9d9; display: inline-block; color: #999; padding: 2px;">@Componentè‡ªåŠ¨å®ç°ä¾èµ–æ³¨å…¥çš„ç¤ºæ„å›¾</div> </center><p>ä½†æ˜¯å¾ˆæ˜¾ç„¶å®é™…å¼€å‘ä¸­ï¼Œä¸æ˜¯æ‰€æœ‰çš„<code>Service</code>ç±»éƒ½å¯ä»¥è¢«æˆ‘ä»¬éšæ„ä¿®æ”¹ï¼Œå¦‚æœ<code>Service</code>ç±»æ˜¯ç¬¬ä¸‰æ–¹æä¾›çš„ç±»ï¼Œæ˜¾ç„¶æˆ‘ä»¬æ˜¯æ— æ³•ç”¨<code>@Inject</code>ä¿®é¥°å…¶æ„é€ å‡½æ•°çš„ã€‚</p><h2 id="Moduleå’Œ-Provides"><a href="#Moduleå’Œ-Provides" class="headerlink" title="@Moduleå’Œ@Provides"></a>@Moduleå’Œ@Provides</h2><p>ä¸ºäº†è§£å†³ç¬¬ä¸‰æ–¹ä¾èµ–çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¦å¼•å…¥å¦å¤–ä¸¤ä¸ªä¸»è§’â€”â€”<strong><code>@Module</code></strong>å’Œ<strong><code>@Provides</code></strong>ã€‚</p><p><code>@Provides</code>ç”¨æ¥æä¾›ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶å†…éƒ¨å®ä¾‹åŒ–å¹¶è¿”å›<code>Service</code>ç±»ï¼Œè¿™æ ·å­å½“ç”¨åˆ°<code>Service</code>çš„æ—¶å€™ï¼Œ<code>@Component</code>ç±»åªéœ€è¦æ‰¾åˆ°<code>@Provides</code>æä¾›çš„è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶è·å–åˆ°ä»–å®ä¾‹åŒ–å¥½çš„<code>Service</code>å¯¹è±¡æ³¨å…¥åˆ°<code>Client</code>ä¸­å°±å¯ä»¥äº†ã€‚</p><p><code>@Module</code>åˆ™æ˜¯æä¾›ä¸€ä¸ª<strong>ç±»</strong>ï¼ˆæ³¨æ„æ˜¯ç±»ï¼Œè€Œéæ¥å£ï¼‰ï¼Œåƒä¸€ä¸ªè¢‹å­ä¸€æ ·æŠŠ<code>@Provides</code>æä¾›çš„æ–¹æ³•â€œè£…â€åˆ°ä¸€èµ·ï¼Œæ‰“åŒ…æä¾›ç»™<code>@Component</code>ç±»ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientModule</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getService</span><span class="params">()</span></span> = Service()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(modules = [ClientModule::class])</span><span class="comment">//Componentå¯ä»¥æœ‰å¤šä¸ªModuleç±»</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClientComponent</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(client: <span class="type">Client</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­çš„<code>@Component(modules = [ClientModule::class])</code>å°†è£…æœ‰å¯ä»¥äº§ç”Ÿä¾èµ–çš„<code>@Provides</code>æ–¹æ³•çš„â€œå¤§è¢‹å­â€<code>@Module</code>å’Œâ€œæ¡¥æ¢â€<code>@Component</code>å…³è”åˆ°äº†ä¸€èµ·ã€‚</p><p><code>@Component</code>åœ¨äº§ç”Ÿä¾èµ–çš„æ—¶å€™ä¼šå…ˆåˆ°<code>@Module</code>ç±»ä¸­çš„<code>@Provides</code>æ–¹æ³•ä¸­æŸ¥æ‰¾ï¼›å¦‚æœæ‰¾ä¸åˆ°æ‰ä¼šå†åˆ°<code>@Inject</code>ä¸­æŸ¥æ‰¾ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶<code>Service</code>ç±»çš„<code>@Inject</code>æ„é€ æ–¹æ³•å…¶å®æ˜¯å¤±æ•ˆäº†çš„ï¼Œå®Œå…¨å¯ä»¥æ²¡æœ‰<code>@Inject</code>æ³¨è§£â€”â€”ç¬¬ä¸‰æ–¹ç±»å³æ˜¯å¦‚æ­¤ï¼‰ã€‚</p><p>ä¸Šè¿°å®Œæ•´ä»£ç å¦‚ä¸‹,<a href="https://gist.github.com/jixiaoyong/35714a6287617260d8578c1b716427cb" target="_blank" rel="noopener">è‹¥æ— æ³•æ˜¾ç¤ºå¯ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹</a>ï¼š</p><script src="https://gist.github.com/jixiaoyong/35714a6287617260d8578c1b716427cb.js"></script><p>è§£å†³äº†ç¬¬ä¸‰æ–¹ä¾èµ–å¼•ç”¨çš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜â€”â€”æˆ‘ä»¬ä½¿ç”¨çš„ç»å¤§å¤šæ•°ç±»è‚¯å®šä¸æ­¢ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆå‡è®¾ä¾èµ–ç±»<code>Service</code>ç°åœ¨æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µåˆè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>(<span class="keyword">var</span> string: String = <span class="string">"default"</span>)</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œè¿™æ—¶å€™<code>@Inject</code>æ³¨è§£å·²ç»æ²¡ç”¨äº†ï¼Œä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•è¢«<code>@Inject</code>ä¿®é¥°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š<code>é”™è¯¯: Types may only contain one @Inject constructor</code>ã€‚</p><p>å»æ‰<code>@Inject</code>å<code>Service</code>ç±»å˜æˆå¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>(<span class="keyword">var</span> string: String = <span class="string">"default"</span>)</span><br></pre></td></tr></table></figure><p>å°è¯•åœ¨<code>@Module</code>ä¸­æ·»åŠ å¦å¤–ä¸€ä¸ª<code>@Provides</code>æ–¹æ³•ä½¿ç”¨å¦å¤–ä¸€ä¸ªå¸¦å‚æ„é€ å‡½æ•°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientModule</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getService</span><span class="params">()</span></span> = Service()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span> </span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getServiceWithArgs</span><span class="params">()</span></span> = Service(<span class="string">"Args"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ—¶å‘ç°ä¼šå‡ºé”™ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥æä¾›<code>Service</code>ï¼Œ<code>@Component</code>äº§ç”Ÿäº†è¿·å¤±ï¼Œä¸çŸ¥é“ç”¨å“ªä¸€ä¸ªå¥½ï¼Œå¯¼è‡´é”™è¯¯ã€‚</p><h2 id="Namedå’Œ-Qualifier"><a href="#Namedå’Œ-Qualifier" class="headerlink" title="@Namedå’Œ@Qualifier"></a>@Namedå’Œ@Qualifier</h2><p>ä¸ºäº†è§£å†³å¤šä¸ªæ„é€ å‡½æ•°å¯¼è‡´çš„é—®é¢˜ï¼Œè¿™æ—¶å°±éœ€è¦ç¬¬äº”ä¸ªä¸»è§’<strong><code>@Named</code></strong>ä»¥åŠå¹•åè‹±é›„<strong><code>@Qualifier</code></strong></p><p>é¦–å…ˆï¼Œä¸Šè¿°é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å¦å¤–ä¸€ä¸ªæ–¹æ³•ä¸ŠåŠ ä¸€ä¸ªæ³¨è§£<code>@Named</code>ï¼Œè¡¨ç¤ºä»–æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span> <span class="meta">@Named(<span class="meta-string">"Args"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getServiceWithArgs</span><span class="params">()</span></span> = Service(<span class="string">"Args"</span>)</span><br></pre></td></tr></table></figure><p>å½“åœ¨<code>Client</code>ä¸­æƒ³ä½¿ç”¨è¿™ä¸ªæ–¹æ³•çš„ä¾èµ–æ—¶ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@field:æ˜¯kotlinä¸­æ³¨è§£å­—æ®µç‰¹åˆ«éœ€è¦çš„ï¼Œåœ¨Javaä¸­å¯ä»¥ç›´æ¥å†™æˆ@Named("Args")</span></span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="meta">@field:Named</span>(<span class="string">"Args"</span>)</span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> service: Service</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>@Named</code>æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Named &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The name. */</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°<code>@Qualifier</code>æ‰æ˜¯ä»–å®ç°æ ‡è¯†é™å®šç¬¦æ³¨è§£ï¼ˆIdentifies qualifier annotationsï¼‰çš„åŠ›é‡ä¹‹æºã€‚æŸ¥çœ‹<code>@Qualifier</code>æ³¨è§£å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰åŸºäº<code>@Qualifier</code>çš„æ³¨è§£æ¥å®ç°å’Œ<code>@Named</code>å®Œå…¨ä¸€è‡´çš„åŠŸèƒ½ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@MustBeDocumented</span></span><br><span class="line"><span class="meta">@kotlin</span>.<span class="keyword">annotation</span>.Retention(AnnotationRetention.RUNTIME)</span><br><span class="line"><span class="keyword">annotation</span> <span class="class"><span class="keyword">class</span> <span class="title">YourQualifierName</span></span>(<span class="comment">//YourQualifierNameå¯ä»¥æ˜¯ä»»æ„ä½ å–œæ¬¢çš„åå­—</span></span><br><span class="line">    <span class="comment">/** The name.  */</span></span><br><span class="line">    <span class="keyword">val</span> value: String = <span class="string">""</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>@YourQualifierName</code>æ›¿ä»£<code>@Named</code>å®ç°æ ‡è¯†ä¸åŒæ³¨è§£çš„ä½œç”¨ï¼Œä»è€Œæ”¯æŒæœ‰å¤šä¸ªæ„é€ å‡½æ•°çš„<code>Service</code>ç±»çš„åˆå§‹åŒ–ã€‚</p><p>ä¸Šè¿°å®Œæ•´ä»£ç å¦‚ä¸‹,<a href="https://gist.github.com/jixiaoyong/fec4426183328346b955f62eb6e9c91a" target="_blank" rel="noopener">è‹¥æ— æ³•æ˜¾ç¤ºå¯ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹</a>ï¼šï¼š</p><script src="https://gist.github.com/jixiaoyong/fec4426183328346b955f62eb6e9c91a.js"></script><p><code>@Component</code>å¯ä»¥æœ‰å¤šä¸ª<code>@Module</code>ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š</p><center> <img style="border-radius: 0.3125em; box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="https://jixiaoyong.github.io/images/20190126201436.png"> <br> <div style="color:orange; border-bottom: 1px solid #d9d9d9; display: inline-block; color: #999; padding: 2px;">@Component ä¼šå…ˆåˆ°ä»–æ‹¥æœ‰çš„å¤šä¸ª@Moduleä¸­å»æŸ¥æ‰¾Serviceç±»</div> </center><h2 id="Singletonå’Œ-Scope"><a href="#Singletonå’Œ-Scope" class="headerlink" title="@Singletonå’Œ@Scope"></a>@Singletonå’Œ@Scope</h2><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æœ‰çš„ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä»è€Œåœ¨ä¸åŒçš„åœ°æ–¹å…±äº«ä¸€äº›æ•°æ®â€”â€”å³å•ä¾‹ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦å¦å¤–ä¸€ä¸ªè§’è‰²<code>@Singleton</code>å’Œä»–çš„å¹•åè‹±é›„<code>@Scope</code>ã€‚</p><p>@Singletonæ˜¯ç”¨æ¥æ ‡è®°ç±»åœ¨å…¶èŒƒå›´å†…åªèƒ½è¢«å®ä¾‹åŒ–ä¸€æ¬¡ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Singleton &#123;&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥çœ‹å…¶æºç å¯ä»¥çŸ¥é“å…¶èƒŒåæ˜¯<code>@Scope</code>åœ¨èµ·ä½œç”¨ï¼Œ<code>@Scope</code>çš„ä½œç”¨æ˜¯é™å®šå…¶ä¿®é¥°çš„ç±»çš„èŒƒå›´ï¼Œé€‚ç”¨äºæœ‰å¯æ³¨å…¥çš„æ„é€ å‡½æ•°å¹¶ä¸”åŒ…å«æ§åˆ¶ç±»å‹å®ä¾‹å¦‚ä½•é‡ç”¨çš„ç±»ã€‚æ²¡æœ‰<code>@Scope</code>ä¿®é¥°çš„å®ä¾‹åœ¨æ„é€ å®Œæ¯•åå°±ä¼šå¤±å»æ§åˆ¶ï¼Œä¸å†å…³å¿ƒåç»­çš„å‘å±•ï¼ˆ<em>then forgets it</em>ï¼‰ï¼Œè€Œ<code>@Scope</code>ä¿®é¥°çš„ç±»ä¼šåœ¨å®ä¾‹æ„é€ å®Œæ¯•åï¼Œç»§ç»­ä¿ç•™ä¸€éä¸‹ä¸€æ¬¡å¯èƒ½çš„å¤ç”¨ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¯¥å®ä¾‹æ—¶ï¼Œä»–çš„å®ç°åº”è¯¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆ<em>itâ€˜s implementation should be thread safe</em>ï¼‰ã€‚</p><p>æ­¤å¤–<code>@Component</code>åº”è¯¥å’Œä»–æ‰€åŒ…å«çš„<code>@Module</code>çš„<code>@Provides</code>çš„<code>@Scope</code>èŒƒå›´ä¸€è‡´ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component(modules = [ClientModule::class])</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClientComponent</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(client: <span class="type">Client</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientModule</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getService</span><span class="params">()</span></span> = Service()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="meta">@Provides</span> <span class="meta">@Choose(<span class="meta-string">"Args"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getServiceWithArgs</span><span class="params">()</span></span> = Service(<span class="string">"Args"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ä¸¤ä¸ªå…³ç³»ä¸º<strong><code>dependencies</code></strong>çš„<code>@Component</code>å¯ä»¥åˆ†åˆ«æ‹¥æœ‰ç›¸åŒåç§°çš„<code>@Inject</code>ã€<code>@Module</code>ã€<code>@Provides</code>è€Œä¸ä¼šè¢«<em>merge</em>ï¼Œä¸¤è€…å¯ä»¥ç›¸äº’è®¿é—®ã€‚</p><p>è€Œ<strong><code>subcomponents</code></strong>åˆ™ä¸èƒ½å’Œ<code>@Component</code>æœ‰ä»¥ä¸Šç›¸åŒçš„é¡¹ã€‚</p><blockquote><p><code>Subcomponent</code>ä»å®ƒçš„çˆ¶ç±»è®¿é—®æ‰€æœ‰ä¾èµ–</p><p><code>@Component</code>åªèƒ½è®¿é—®åœ¨åŸºç±»<code>@Component</code>æ¥å£æš´éœ²çš„å…¬å…±æ€§çš„ä¾èµ–</p><p>â€”â€”<a href="https://sinyuk.me/2016/04/11/Subcomponents%E5%92%8CComponent-Dependencies/" target="_blank" rel="noopener">Subcomponentså’ŒComponent Dependenciesâ€”â€”Sinyuk Blog</a></p></blockquote><p>ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºä¸‹å›¾ï¼š</p><center> <img style="border-radius: 0.3125em; box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="https://jixiaoyong.github.io/images/20190127204658.png"> <br> <div style="color:orange; border-bottom: 1px solid #d9d9d9; display: inline-block; color: #999; padding: 2px;">@Subcomponent,@Componentä¹‹é—´çš„å…³ç³»</div> </center><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://github.com/android-cn/blog/tree/master/java/dependency-injection" target="_blank" rel="noopener">android-cnï¼šä¾èµ–æ³¨å…¥â€”â€” Github</a></p><p><a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="noopener">Dependency Injection â€”â€”wikipedia</a></p><p><a href="https://medium.com/@elye.project" target="_blank" rel="noopener">Elyeçš„Dagger 2 ç³»åˆ—</a></p><p><a href="https://google.github.io/dagger/users-guide" target="_blank" rel="noopener">Dagger 2 å®˜æ–¹æ‰‹å†Œ</a></p><p><a href="https://www.jianshu.com/p/2cd491f0da01" target="_blank" rel="noopener">Android - Dagger2ä½¿ç”¨è¯¦è§£â€”â€”ç®€ä¹¦</a></p><p><a href="https://sinyuk.me/2016/04/11/Subcomponents%E5%92%8CComponent-Dependencies/" target="_blank" rel="noopener">Subcomponentså’ŒComponent Dependenciesâ€”â€”Sinyuk Blog</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> dagger2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»Sunflowerå¼€å§‹å­¦ä¹ ä¼˜é›…çš„Jetpackæ¶æ„</title>
      <link href="/blog/posts/27065732/"/>
      <url>/blog/posts/27065732/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Googleå¤§æ³•NBï¼ï¼ï¼(ç ´éŸ³)</p></blockquote><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><a href="https://developer.android.google.cn/jetpack/" target="_blank" rel="noopener">Jetpack</a>æ˜¯Googleæ¨å‡ºçš„ä¸€ç³»åˆ—Androidè½¯ä»¶é›†åˆï¼Œ<em>â€œä½¿æ‚¨å¯ä»¥æ›´è½»æ¾åœ°å¼€å‘å‡ºè‰²çš„ Android åº”ç”¨ã€‚è¿™äº›ç»„ä»¶å¯å¸®åŠ©æ‚¨éµå¾ªæœ€ä½³åšæ³•ã€è®©æ‚¨æ‘†è„±ç¼–å†™æ ·æ¿ä»£ç çš„å·¥ä½œå¹¶ç®€åŒ–å¤æ‚ä»»åŠ¡ï¼Œä»¥ä¾¿æ‚¨å°†ç²¾åŠ›é›†ä¸­æ”¾åœ¨æ‰€éœ€çš„ä»£ç ä¸Šâ€</em>ã€‚</p><p><a href="https://github.com/googlesamples/android-sunflower" target="_blank" rel="noopener">Sunflower</a>åˆ™æ˜¯Googleç”¨æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨Jetpackè¿›è¡ŒAndroidå¼€å‘çš„Demoï¼Œæœ‰ç€éå¸¸ä¼˜é›…çš„æ¶æ„ä¸ååˆ†ç®€æ´çš„ä»£ç ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾ˆå¥½åœ°å­¦ä¹ Jetpackä»¥åŠMVVMæ€æƒ³ã€‚</p><p>æœ¬æ–‡ä¸»è¦æ˜¯ç»“åˆSunflowerä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œåˆ†æJetpackæ¶æ„ä¸­å„éƒ¨åˆ†çš„ä½œç”¨ï¼Œä»¥åŠä»–ä»¬å¦‚ä½•å·§å¦™çš„æ­é…ä½¿ç”¨ï¼Œæ–¹ä¾¿æŒ‡å¯¼æ—¥åå¯¹Jetpackçš„ä½¿ç”¨ã€‚</p><blockquote><p>æœ¬æ–‡ä¸­çš„å¤§éƒ¨åˆ†ä»£ç ã€ç¤ºæ„å›¾é™¤éç‰¹æ®Šæ³¨æ˜å¤–ï¼Œçš†æ¥è‡ªGoogleçš„<a href="https://github.com/googlesamples/android-sunflower" target="_blank" rel="noopener">Sunflowerå·¥ç¨‹</a>æˆ–å…¶ä»–äº’è”ç½‘èµ„æºï¼Œæ ¹æ®ç¯‡å¹…éœ€è¦åšäº†éƒ¨åˆ†ç²¾ç®€ï¼Œæ‰€æœ‰æƒç›Šå½’åŸä½œè€…æ‰€æœ‰ã€‚</p></blockquote><p>ä¸‹å›¾æ˜¯<a href="https://developer.android.google.cn/jetpack/" target="_blank" rel="noopener">Google Jetpackå®˜ç½‘</a>å¯¹Jetpackçš„ä»‹ç»å›¾ï¼š</p><p><center>     <img style="border-radius: 0.3125em;     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="https://jixiaoyong.github.io/images/jetpack_donut.png">     <br>     <div style="color:orange; border-bottom: 1px solid #d9d9d9;     display: inline-block;     color: #999;     padding: 2px;">Jetpackç¤ºæ„å›¾ <font style="color: #BEBEBE">æ¥è‡ªGoogleJetpackå®˜ç½‘</font></div> </center></p><h1 id="å¯¹Sunflowerçš„æ•´ä½“åˆ†æ"><a href="#å¯¹Sunflowerçš„æ•´ä½“åˆ†æ" class="headerlink" title="å¯¹Sunflowerçš„æ•´ä½“åˆ†æ"></a>å¯¹Sunflowerçš„æ•´ä½“åˆ†æ</h1><p>ä¸‹å›¾æ˜¯Sunfloweræ¶æ„çš„ç®€å•ç¤ºæ„å›¾ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20190124212220.png" alt></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒAPPçš„ç•Œé¢æœ‰<code>æˆ‘çš„èŠ±å›­</code>ã€<code>æ¤ç‰©ç›®å½•</code>å’Œ<code>æ¤ç‰©ä»‹ç»</code>ä¸‰éƒ¨åˆ†ï¼Œè¿™ä¸‰è€…çš„åˆ‡æ¢é€»è¾‘é€šè¿‡<font color="#0288d1" size="4"><strong><code>Navigation</code></strong></font>å®ç°ã€‚</p><p>æ¯ä¸ªç•Œé¢çš„<strong><code>XML</code></strong>ä¸­çš„å¸ƒå±€ä¿¡æ¯ï¼ˆåŒ…æ‹¬<code>æ•°æ®ã€äº‹ä»¶ï¼ˆclickListenerç­‰ï¼‰ï¼ŒRecycleViewçš„LayoutManagerï¼ŒAdapterç­‰ç­‰</code>ï¼‰é€šè¿‡<font color="#0288d1" size="4"><strong><code>DataBinding</code></strong></font>ä¸<font color="#0288d1" size="4"><strong><code>ViewModel</code></strong></font>ä¸­çš„å¯è§‚å¯Ÿæ•°æ®<font color="#0288d1" size="4"><strong><code>LiveData</code></strong></font>ç»‘å®šåœ¨ä¸€èµ·ï¼Œåªè¦æ•°æ®åº“ä¸­çš„<code>æ•°æ®</code>æœ‰æ›´æ–°ï¼Œå°±ä¼šé€šè¿‡<code>LiveData</code>ä¸»åŠ¨é€šçŸ¥å¸ƒå±€æ›´æ–°ç•Œé¢ï¼›åŒæ—¶<code>DataBinding</code>è¿˜é€šè¿‡ä¸<code>Adapter</code>ï¼ˆè¿™äº›ç»§æ‰¿è‡ª<strong><code>ListAdapter</code></strong>çš„Adapterå®ç°äº†<font color="#0288d1" size="4"><strong><code>Paging</code></strong></font>çš„ä½œç”¨ï¼‰å°†<code>ItemView</code>çš„<code>ViewModel</code>ä¸å¸ƒå±€<code>XML</code>ä¸­ç»‘å®šåœ¨ä¸€èµ·ï¼Œé€šè¿‡<code>BindingAdapter</code>å¯¹<code>XML</code>ä¸­çš„æ•°æ®åšé¢„å¤„ç†ï¼ˆåŠ è½½imgUrlä¸­çš„å›¾ç‰‡åˆ°ImageViewç­‰ç­‰ï¼‰ã€‚</p><p>åœ¨<font color="black" size="5"><strong><code>View</code></strong></font>ä¸­æŒ‡å®šè¿™äº›<code>DataBinding</code>ä¸<font color="black" size="5"><strong><code>ViewModel</code></strong></font>ä¹‹é—´ä»¥åŠ<code>ViewModel</code>ä¸<font color="black" size="5"><strong><code>Model</code></strong></font><code>æ•°æ®åº“</code>ä¹‹é—´çš„é€»è¾‘å…³ç³»ï¼Œè¿™äº›æ•°æ®ä¸æ“ä½œéƒ½å—ç€<font color="#0288d1" size="4"><strong><code>Lifecycle</code></strong></font>çš„å½±å“ã€‚</p><p><code>ViewModel</code>çš„æ•°æ®æ¥æºâ€”â€”<code>Model</code>åœ¨è¿™é‡Œçš„å®ç°æ˜¯ä¸€ä¸ª<code>æ•°æ®åº“</code>ã€‚æ¯ä¸ª<code>ViewModel</code>æœ‰ä¸€ä¸ª<code>XXXViewModelFactory</code>ç±»ï¼Œç”¨æ¥ä½¿ç”¨æ•°æ®ç±»<code>XXXRepository</code>ç±»çš„å®ä¾‹åˆ›å»ºå¯¹åº”çš„<code>ViewModel</code>ã€‚<code>XXXViewModelFactory</code>å‘<code>Activity</code>ç­‰å±è”½äº†<code>ViewModel</code>çš„å…·ä½“å®ç°ã€‚</p><p><code>XXXRepository</code>ç±»çš„å‡ºç°æ—¶ä¸ºäº†å°†<code>ViewModel</code>ä¸æ•°æ®çš„å…·ä½“å®ç°è§£è€¦åˆï¼Œè¿™æ ·<code>ViewModel</code>åªéœ€è¦å…³å¿ƒä»–è¦çš„æ“ä½œè€Œä¸å¿…å…³ç³»æ•°æ®æ¥æºçš„å…·ä½“å®ç°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ<code>XXXRepository</code>ç±»å¯¹åº”å°è£…äº†è¿™æ•°æ®åº“<code>AppDatabase</code>ä¸­å¯¹ä¸¤ä¸ªè¡¨çš„æ“ä½œã€‚</p><p>æ•°æ®åº“ä½¿ç”¨<font color="#0288d1" size="4"><strong><code>Room</code></strong></font>å®ç°ï¼Œä»åº•å±‚å¼€å§‹ä¾æ¬¡åˆ†ä¸º<code>è¡¨Entity</code>ï¼Œ<code>æ•°æ®è®¿é—®å¯¹è±¡DAO</code>å’Œ<code>æ•°æ®åº“DataBase</code>ä¸‰ä¸ªå±‚æ¬¡ã€‚æ¯ä¸ªDAOå¯¹åº”ä¸€ä¸ªåŒ…è£…ç±»<code>XXXRepository</code>ç±»ä¾›<code>ViewModel</code>ä½¿ç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Entity    GardenPlanting    //è¡¨ï¼Œå®šä¹‰äº†å­˜å‚¨çš„æ•°æ®é¡¹åŠå…¶æ ¼å¼</span><br><span class="line">@Dao    GardenPlantingDao    //æ•°æ®è®¿é—®å¯¹è±¡ï¼Œå®šä¹‰äº†ä¾‹å¦‚æ’å…¥æ•°æ®ã€æŸ¥è¯¢æ•°æ®ç­‰æ“ä½œ</span><br><span class="line"> GardenPlantingRepository    //å¯¹DAOçš„å°è£…ï¼Œå°†æ•°æ®çš„çš„å…·ä½“å®ç°ä¸ViewModelå¯¹æ•°æ®çš„æ“ä½œè§£è€¦</span><br><span class="line">@Database     AppDatabase    //æ•°æ®åº“ï¼ŒåŒ…æ‹¬è¡¨å’Œå¯¹è¡¨çš„æ“ä½œ</span><br></pre></td></tr></table></figure><p><font color="#0288d1" size="4"><strong><code>WorkManager</code></strong></font>åˆ™ç®¡ç†ç€ä¸€ä¸ªä»Jsonè¯»å–æ•°æ®å¹¶åŠ è½½åˆ°æ•°æ®åº“ä¸­çš„åå°ä»»åŠ¡<code>SeedDatabaseWorker</code>ã€‚</p><h1 id="å…·ä½“å®ç°åˆ†æ"><a href="#å…·ä½“å®ç°åˆ†æ" class="headerlink" title="å…·ä½“å®ç°åˆ†æ"></a>å…·ä½“å®ç°åˆ†æ</h1><p>é¦–å…ˆçœ‹ä¸€ä¸‹<strong><code>View</code></strong>éƒ¨åˆ†ï¼ŒSunfloweråªæœ‰ç®€å•çš„3ä¸ªé¡µé¢ï¼Œå…¨éƒ½æ˜¯ç”¨<code>Fragment</code>å®ç°ï¼Œç”±<code>Activity</code>é€šè¿‡<code>Navigation</code>æ§åˆ¶åˆ‡æ¢ï¼š</p><ul><li><code>GardenActivity</code> ä¸»é¡µé¢ï¼Œå”¯ä¸€çš„ä¸€ä¸ªActivity</li><li><code>GardenFragment</code> æˆ‘çš„èŠ±å›­ ç•Œé¢ï¼Œä¼šæ˜¾ç¤ºç”¨æˆ·åœ¨æ¤ç‰©ç›®å½•ä¸­é€‰æ‹©å¹¶ç§æ¤çš„æ¤ç‰©ä¿¡æ¯</li><li><code>PlantListFragment</code> æ¤ç‰©ç›®å½• ç•Œé¢ï¼Œæ‰€æœ‰çš„æ¤ç‰©ä¿¡æ¯åˆ—è¡¨</li><li><code>PlantDetailFragment</code> æ¤ç‰©ä»‹ç» ç•Œé¢ï¼Œå½“åœ¨â€œæˆ‘çš„èŠ±å›­â€æˆ–â€œæ¤ç‰©åˆ—è¡¨â€é€‰æ‹©äº†æŸä¸ªæ¤ç‰©åï¼Œä¼šè¿›å…¥è¯¥ç•Œé¢æ˜¾ç¤ºæ¤ç‰©è¯¦ç»†ä»‹ç»</li></ul><h2 id="Navigationæ§åˆ¶ç•Œé¢åˆ‡æ¢"><a href="#Navigationæ§åˆ¶ç•Œé¢åˆ‡æ¢" class="headerlink" title="Navigationæ§åˆ¶ç•Œé¢åˆ‡æ¢"></a>Navigationæ§åˆ¶ç•Œé¢åˆ‡æ¢</h2><p>å…ˆçœ‹ä¸€ä¸‹<a href="https://developer.android.google.cn/topic/libraries/architecture/navigation/" target="_blank" rel="noopener">Navigation</a>çš„å®šä¹‰ï¼š</p><blockquote><p>Navigationæ˜¯APPè®¾è®¡ä¸­çš„å…³é”®éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰ç”¨æˆ·ä»ä¸åŒçš„ç•Œé¢åˆ‡æ¢ã€è¿›å…¥å’Œæ¨å‡ºçš„äº¤äº’é€»è¾‘ã€‚</p></blockquote><p>å’Œå¸ƒå±€æ–‡ä»¶ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘å™¨çš„å¯è§†åŒ–ç•Œé¢ä¸­ï¼Œç›´æ¥é¢„è§ˆã€è®¾è®¡ä¸åŒç•Œé¢åˆ‡æ¢æ•ˆæœã€‚ä»–å¯ä»¥è´Ÿè´£<code>Fragment</code>ã€<code>Activity</code>ã€<code>Navigation graphs</code> ä¸ <code>subgraphs</code> ä»¥åŠ<code>Custom destination types</code>ï¼Œä»–ä»¬ä¹‹é—´é€šè¿‡ä¸åŒçš„<code>action</code>è¿æ¥èµ·æ¥ã€‚</p><p>é€šè¿‡å®˜æ–¹æ–‡æ¡£å¯çŸ¥ï¼Œ<code>Navigation</code>å¯ä»¥å’Œ<code>AppBar</code>ï¼Œ<code>ToolBar</code>ç­‰ç»„åˆèµ·æ¥æ§åˆ¶Fragmentæ˜¾ç¤ºï¼Œæ­¤å¤–å¯ä»¥é€šè¿‡<code>ViewModel</code>åœ¨ç»‘å®šåˆ°åŒä¸€ä¸ª<code>Activity</code>çš„<code>Fragment</code>ä¹‹é—´å…±äº«æ•°æ®ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é€šè¿‡<a href="https://developer.android.google.cn/topic/libraries/architecture/navigation/navigation-pass-data" target="_blank" rel="noopener"><code>Bundle</code>æˆ–<code>Safe Args</code></a>åœ¨ä¸¤ä¸ª<code>Fragment</code>ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨<code>Sunflower</code>ä¸­<code>Navigation</code>æ˜¯æ€ä¹ˆæ§åˆ¶ç•Œé¢åˆ‡æ¢çš„å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œåœ¨<code>res/navigation/</code>ç›®å½•ä¸‹é¢æ–°å»ºä¸€ä¸ª<code>åµŒå¥—å¯¼èˆªå›¾(Nested navigation graphs)</code>,å®šä¹‰å„ä¸ªç•Œé¢ä¹‹å‰çš„åˆ‡æ¢å…³ç³»ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">navigation</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:startDestination</span>=<span class="string">"@+id/garden_fragment"</span>&gt;</span></span><br><span class="line">//app:startDestinationå®šä¹‰äº†åœ¨è¿™ä¸ªå¯¼èˆªå›¾ä¸­é¦–æ¬¡å¯åŠ¨å±•ç¤ºçš„ç•Œé¢</span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/garden_fragment"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">"com.google.samples.apps.sunflower.GardenFragment"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/my_garden_title"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">"@layout/fragment_garden"</span>&gt;</span></span><br><span class="line">//actionå®šä¹‰äº†åœ¨å„ä¸ªç•Œé¢çš„åˆ‡æ¢å…³ç³»</span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/action_garden_fragment_to_plant_detail_fragment"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:destination</span>=<span class="string">"@id/plant_detail_fragment"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:enterAnim</span>=<span class="string">"@anim/slide_in_right"</span>//<span class="attr">enterAnim</span>ç­‰æŒ‡å®šæ‰§è¡Œ<span class="attr">action</span>æ—¶çš„åŠ¨ç”»</span></span><br><span class="line"><span class="tag">          <span class="attr">...</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span>&gt;</span></span><br><span class="line">//argumentå®šä¹‰äº†åœ¨åˆ‡æ¢ç•Œé¢æ—¶éœ€è¦å¸¦çš„å‚æ•°ï¼Œéœ€è¦androidx.navigation.safeargsçš„æ”¯æŒ,å…·ä½“è§å‚è€ƒèµ„æ–™-Android Jetpack-Navigation ä½¿ç”¨ä¸­å‚æ•°çš„ä¼ é€’</span><br><span class="line">        <span class="tag">&lt;<span class="name">argument</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"plantId"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:argType</span>=<span class="string">"string"</span> /&gt;</span>//å‚æ•°ç±»å‹å°å†™</span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨Activityå¯¹åº”çš„XMLä¸­æ’å…¥è¯¥å¯¼èˆªï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/garden_nav_fragment"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">"androidx.navigation.fragment.NavHostFragment"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:defaultNavHost</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:navGraph</span>=<span class="string">"@navigation/nav_garden"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥åœ¨Activityæˆ–è€…Fragmentä¸­è·å–è¯¥å¯¼èˆªçš„å®åŠ›ï¼Œç”¨æ¥åˆ‡æ¢ç•Œé¢äº†ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//activity</span></span><br><span class="line"><span class="keyword">val</span> navController = Navigation.findNavController(<span class="keyword">this</span>, R.id.garden_nav_fragment)</span><br><span class="line"><span class="comment">//fragmentæˆ–å…¶ä»–åœ°æ–¹</span></span><br><span class="line"><span class="keyword">val</span> direction = GardenFragmentDirections<span class="comment">//åµŒå¥—å¯¼èˆªå›¾ä¸­Fragmentè‡ªåŠ¨ç”Ÿæˆçš„ç±»</span></span><br><span class="line">.ActionGardenFragmentToPlantDetailFragment(plantId)</span><br><span class="line">it.findNavController().navigate(direction)</span><br></pre></td></tr></table></figure><h2 id="DataBindingç»‘å®šå¸ƒå±€å’Œæ•°æ®"><a href="#DataBindingç»‘å®šå¸ƒå±€å’Œæ•°æ®" class="headerlink" title="DataBindingç»‘å®šå¸ƒå±€å’Œæ•°æ®"></a>DataBindingç»‘å®šå¸ƒå±€å’Œæ•°æ®</h2><p>Navigationè§£å†³äº†ä¸åŒçš„å¸ƒå±€é—´äº¤äº’çš„é€»è¾‘ï¼ŒDataBindingåˆ™å……å½“å¸ƒå±€Viewå’Œæ•°æ®ï¼ˆViewModelã€LiveDataï¼‰ä¹‹é—´çš„æ¡¥æ¢ï¼Œå°†äºŒè€…è”ç³»èµ·æ¥ã€‚</p><p>ä»<a href="https://developer.android.google.cn/topic/libraries/data-binding/" target="_blank" rel="noopener">å®˜ç½‘</a>çš„è¡¨è¿°ä¸­æˆ‘ä»¬çŸ¥é“ï¼ŒDataBindingä½¿ç”¨åœ¨XMLä¸­å£°æ˜çš„æ–¹å¼ï¼ˆè€Œéç¼–ç¨‹çš„æ–¹å¼ï¼‰ï¼Œå°†å¸ƒå±€ä¸­çš„ç»„ä»¶æ†ç»‘åˆ°APPä¸­ä½¿ç”¨åˆ°çš„æ•°æ®ä¸Šï¼Œè¿™æ ·å½“æ•°æ®æ›´æ–°æ—¶ï¼Œå¸ƒå±€ä¹Ÿä¼šéšä¹‹è‡ªåŠ¨æ›´æ–°ã€‚</p><p>DataBindingåœ¨XMLä¸­çš„å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">"viewmodel"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">"com.myapp.data.ViewModel"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ConstraintLayout...</span> /&gt;</span> <span class="comment">&lt;!-- UI layout's root element --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯åŸå…ˆçš„é¡µé¢å¸ƒå±€ä¿¡æ¯<code>&lt;ConstraintLayout... /&gt;</code>åŒ…è£¹åœ¨<code>&lt;layout... /&gt;</code>ä¸­ï¼ŒåŒæ—¶å¤šäº†ä¸€ä¸ªæ•°æ®åŸŸ<code>&lt;data... /&gt;</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å®šä¹‰ä¸€äº›å˜é‡<code>&lt;variable... /&gt;</code>ï¼Œå¹¶åœ¨å¸ƒå±€ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"@&#123;viewmodel.userName&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>é™¤äº†å¸¸è§çš„<code>android:text</code>ï¼Œ<code>android:onClick</code>ç­‰é€šç”¨çš„å±æ€§å¯ä»¥ç›´æ¥ç»‘å®šå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è‡ªå®šä¹‰<a href="https://developer.android.google.cn/topic/libraries/data-binding/binding-adapters.html" target="_blank" rel="noopener"><strong>Binding adapters</strong></a>æ”¯æŒæ›´å¤šå½¢å¼çš„å±æ€§ç»‘å®šï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"app:goneUnless"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">goneUnless</span><span class="params">(view: <span class="type">View</span>, visible: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">    view.visibility = <span class="keyword">if</span> (visible) View.VISIBLE <span class="keyword">else</span> View.GONE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å°±æ”¯æŒäº†<code>app:goneUnless</code>çš„è§£æï¼Œæˆ‘ä»¬åªè¦åœ¨XMLä¸­ä¸ºç»„ä»¶åŠ ä¸Šè¿™ä¸ªå±æ€§å°±å¯ä»¥å®ç°ç›¸åº”çš„æ•ˆæœï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:text</span>=<span class="string">"@&#123;viewmodel.userName&#125;"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:goneUnless</span>=<span class="string">"@&#123;viewmodel.isGone&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯¹åº”çš„Activityæˆ–Fragmentä¸­ï¼Œç”¨å¦‚ä¸‹ä»£ç å°†å¸ƒå±€ä¸é¡µé¢ç»‘å®šåˆ°ä¸€èµ·ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setContentView(R.layout.activity_main)</span></span><br><span class="line"><span class="keyword">val</span> binding: ActivityMainBinding = DataBindingUtil.setContentView(</span><br><span class="line">            <span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line">binding.viewmodel = ...</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>ActivityMainBinding</code>ç±»æ˜¯<code>DataBinding</code>æ ¹æ®XMLæ–‡ä»¶çš„åå­—è‡ªåŠ¨æ›¿æˆ‘ä»¬ç”Ÿæˆçš„ï¼Œè§„å¾‹æ˜¯<code>XMLæ–‡ä»¶å+Binding</code>çš„é©¼å³°å‘½åã€‚</p><p>åœ¨Sunflowerä¸­æœ‰ç±»ä¼¼çš„åº”ç”¨æœ‰å¾ˆå¤šå¤„ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  ~ Copyright 2018 Google LLC ...</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">                <span class="attr">name</span>=<span class="string">"hasPlantings"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">type</span>=<span class="string">"boolean"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.recyclerview.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/garden_list"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:isGone</span>=<span class="string">"@&#123;!hasPlantings&#125;"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layoutManager</span>=<span class="string">"androidx.recyclerview.widget.LinearLayoutManager"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">tools:listitem</span>=<span class="string">"@layout/list_item_garden_planting"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ViewModelç®¡ç†æ•°æ®ä¸é¡µé¢çš„äº¤äº’"><a href="#ViewModelç®¡ç†æ•°æ®ä¸é¡µé¢çš„äº¤äº’" class="headerlink" title="ViewModelç®¡ç†æ•°æ®ä¸é¡µé¢çš„äº¤äº’"></a>ViewModelç®¡ç†æ•°æ®ä¸é¡µé¢çš„äº¤äº’</h2><p><code>DataBinding</code>é€šè¿‡æ ‡è®°çš„å½¢å¼å°†æ•°æ®å’Œç»„ä»¶ç»‘å®šï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä»–ä½¿ç”¨çš„æ•°æ®åˆ™æ˜¯æ¥è‡ªäº<code>ViewModel</code>çš„ã€‚åœ¨é¡µé¢<code>Activity</code>(æˆ–<code>Fragment</code>)ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤„ç†è¿™ä¸¤è€…ä¹‹é—´çš„å…³ç³»ã€‚</p><p><code>ViewModel</code>æ˜¯è®¾è®¡ç”¨æ¥ä»¥ä¸€ç§å¯ä»¥æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸï¼ˆ<code>lifecycle</code>ï¼‰çš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ä¸UIç›¸å…³çš„æ•°æ®ï¼Œå®ƒå¯ä»¥å…è®¸æ•°æ®åœ¨è¯¸å¦‚å±å¹•æ—‹è½¬çš„å˜åŒ–ä¸­å­˜æ´»ä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´<code>VideModule</code>çš„æ•°æ®ç”Ÿå‘½å‘¨æœŸå¯èƒ½è¦æ¯”ä»–é™„ç€çš„<code>Activity</code>æˆ–<code>Fragment</code>çš„ç”Ÿå‘½å‘¨æœŸé•¿ã€‚</p><p>åŒæ—¶ï¼Œ<code>UI controller</code>å¯ä»¥åœ¨<code>Activity</code>ç­‰ä¸å†éœ€è¦æ•°æ®æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨<code>ViewModel</code>çš„<code>onCleared()</code>æ–¹æ³•æ¸…é™¤è¿™äº›æ•°æ®ä»¥é¿å…å†…å­˜æ³„æ¼ã€‚</p><p>ä¸‹å›¾æ˜¯<code>ViewModel</code>å’Œ<code>Activity</code>çš„ç”Ÿå‘½å‘¨æœŸå¯¹æ¯”ï¼š</p><p><center>     <img style="border-radius: 0.3125em;     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="https://jixiaoyong.github.io/images/20190202161443.png">     <br>     <div style="color:orange; border-bottom: 1px solid #d9d9d9;     display: inline-block;     color: #999;     padding: 2px;">ViewModelå’ŒActivityçš„ç”Ÿå‘½å‘¨æœŸå¯¹æ¯”å›¾ï¼šå·¦å›¾Activityå…ˆç»å†äº†ä¸€æ¬¡æ—‹è½¬ï¼Œç„¶åfinishï¼Œå³è¾¹æ˜¯ä¸æ­¤ç›¸å…³çš„ViewModelçš„ç”Ÿå‘½å‘¨æœŸ<br><font style="color: #BEBEBE">æ¥è‡ªGoogleJetpackå®˜ç½‘</font></div> </center><br>æ­¤å¤–ï¼Œç”±äºé»˜è®¤çš„è·å–ViewModelçš„æ–¹æ³•åªèƒ½è°ƒå–æ— å‚æ„é€ å‡½æ•°ï¼Œå½“éœ€è¦å‘ViewModelä¼ é€’å‚æ•°æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ°Factoryå·¥å‚æ¨¡å¼æ¥åˆ›å»ºViewModelï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewModel = ViewModelProviders.of(<span class="keyword">this</span>, factory).<span class="keyword">get</span>(GardenPlantingListViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlantDetailViewModelFactory</span></span>(args:Any) : ViewModelProvider.NewInstanceFactory() &#123;...&#125;</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å°†<code>ViewModel</code>äº<code>LiveData</code>ç»“åˆï¼Œè¿™æ ·åœ¨<code>Activity</code>ç­‰åœ°æ–¹å¯¹<code>LiveData</code>è¿›è¡Œè®¢é˜…åï¼Œå½“<code>LiveData</code>çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶<code>Activity</code>ç­‰å¯ä»¥åŠæ—¶å¾—åˆ°é€šçŸ¥ï¼Œè€Œåšå‡ºç›¸åº”å˜åŒ–ã€‚æ­¤å¤–<code>ViewModel</code>ä¸<code>lifecycle</code>çš„ç»“åˆå¯ä»¥ä¿è¯åœ¨<code>Activity</code>ç­‰ç”Ÿå‘½å‘¨æœŸç»“æŸåæ•°æ®å¾—åˆ°åŠæ—¶çš„æ¸…ç†ã€‚</p><h2 id="Roomä¿å­˜æ•°æ®"><a href="#Roomä¿å­˜æ•°æ®" class="headerlink" title="Roomä¿å­˜æ•°æ®"></a>Roomä¿å­˜æ•°æ®</h2><blockquote><p>RoomæŒä¹…æ€§åº“åœ¨SQLiteä¸Šæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä»¥ä¾¿åœ¨å……åˆ†åˆ©ç”¨SQLiteå¼ºå¤§åŠŸèƒ½çš„åŒæ—¶ï¼Œèƒ½å¤Ÿæµç•…çš„è®¿é—®æ•°æ®åº“ã€‚â€”â€”Android Developers</p></blockquote><p><code>Room</code>éœ€è¦3ä¸ªå…ƒç´ ï¼š</p><ul><li><code>Database</code> æ•°æ®åº“ï¼Œå¯ä»¥æä¾›å¯¹è¡¨æ ¼çš„æ“ä½œæ–¹æ³•<code>@DAO</code>ã€‚æ˜¯ä¸€ä¸ªç»§æ‰¿è‡ª<code>RoomDatabase</code>çš„æŠ½è±¡ç±»ã€‚</li><li><code>Entity</code> è¡¨æ ¼ï¼Œè§„å®šäº†æ¯ä¸ªè¡¨æ ¼å¯ä»¥ä¿å­˜çš„æ•°æ®æ ¼å¼ã€‚æ˜¯ä¸€ä¸ªæ™®é€šç±»ã€‚</li><li><code>Dao</code> æ•°æ®è®¿é—®ç»“æ„ï¼ˆ<code>Data Access Object</code>ï¼‰ï¼Œå®šä¹‰äº†å¯¹è¡¨æ ¼<code>@Entity</code>ä¸­çš„æ•°æ®çš„æ“ä½œã€‚æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…æŠ½è±¡ç±»ã€‚</li></ul><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥å¯¹<code>@DAO</code>è¿›è¡Œè¿›ä¸€æ­¥çš„å°è£…å¾—åˆ°ä¸€ä¸ª<code>XXXRepository</code>ç±»ï¼Œ<code>ViewModel</code>é€šè¿‡è¿™ä¸ª<code>XXXRepository</code>ç±»æ¥æ“ä½œæ•°æ®ï¼Œä»è€Œå°†å…¶ä¸æ•°æ®çš„å…·ä½“å®ç°è§£è€¦ã€‚</p><h2 id="WorkManagerç®¡ç†ä»»åŠ¡"><a href="#WorkManagerç®¡ç†ä»»åŠ¡" class="headerlink" title="WorkManagerç®¡ç†ä»»åŠ¡"></a>WorkManagerç®¡ç†ä»»åŠ¡</h2><p><code>WorkManager</code>ç”¨æ¥ç®¡ç†å³æ—¶æˆ–å®šæ—¶ä»»åŠ¡ï¼Œå®˜æ–¹å®šä¹‰æ˜¯åœ¨æŒ‡å®šçº¦æŸæ¡ä»¶æˆç†Ÿæ—¶å¯é çš„åœ¨åå°æ‰§è¡Œå¯¹åº”çš„ä»»åŠ¡ã€‚</p><p>å…·ä½“ä½¿ç”¨å¯ä»¥å‚è€ƒè¿™ä¸ª<a href="https://gist.github.com/jixiaoyong/041d8b0775e392302b4cd57a98b4f6fa" target="_blank" rel="noopener">GIST</a>ã€‚</p><p>å’Œä»–ç›¸å…³çš„æœ‰ä¸‹é¢å‡ ä¸ªå…³é”®ç±»ï¼š</p><ul><li><code>Worker</code> å®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡å†…å®¹</li><li><code>WorkRequest</code> ä»£è¡¨ä¸€é¡¹å•ç‹¬çš„ä»»åŠ¡ï¼Œæ˜ç¡®å…·ä½“è¦æ‰§è¡Œçš„ä»»åŠ¡å†…å®¹ï¼ˆWorkerï¼‰ã€ä»»åŠ¡çš„ç±»å‹ï¼ˆWorkRequest.Builderçš„å­ç±»ï¼Œå†³å®šä»»åŠ¡ä¸€æ¬¡æ€§è¿˜æ˜¯é‡å¤çš„ï¼‰ä»¥åŠä»»åŠ¡æ‰§è¡Œçš„æ¡ä»¶ï¼ˆConstraintsï¼Œå¦‚è”ç½‘ã€ç”µæ± ç”µé‡ç­‰ç­‰ï¼‰</li><li>WorkManager æ‰§è¡Œç®¡ç†WorkRequestï¼Œå®‰æ’æ‰§è¡ŒWorkerä¸­çš„å·¥ä½œå†…å®¹ã€‚</li></ul><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://developer.android.google.cn/jetpack/" target="_blank" rel="noopener">Android Jetpackå®˜ç½‘</a></p><p><a href="https://blog.csdn.net/weixin_42215792/article/details/80395379" target="_blank" rel="noopener">Android Jetpack-Navigation ä½¿ç”¨ä¸­å‚æ•°çš„ä¼ é€’</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå¸¸ç”¨å‘½ä»¤</title>
      <link href="/blog/posts/d0edc1ed/"/>
      <url>/blog/posts/d0edc1ed/</url>
      
        <content type="html"><![CDATA[<h1 id="å¤åˆ¶ï¼Œåˆ é™¤ï¼Œç§»åŠ¨"><a href="#å¤åˆ¶ï¼Œåˆ é™¤ï¼Œç§»åŠ¨" class="headerlink" title="å¤åˆ¶ï¼Œåˆ é™¤ï¼Œç§»åŠ¨"></a>å¤åˆ¶ï¼Œåˆ é™¤ï¼Œç§»åŠ¨</h1><p><code>cp</code>æ‹·è´ï¼Œ<code>rm</code>åˆ é™¤ï¼Œ<code>mv</code>ç§»åŠ¨ã€‚</p><p><code>-r</code>è¡¨ç¤ºé€’å½’ <code>-f</code>å¼ºåˆ¶ï¼Œæ— æç¤º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp [-r] fromFilePath toFilePath</span><br><span class="line">rm [-r] fromFilePath toFilePath</span><br><span class="line">mv [-r] fromFilePath toFilePath</span><br></pre></td></tr></table></figure><h1 id="åˆ‡æ¢ç›®å½•"><a href="#åˆ‡æ¢ç›®å½•" class="headerlink" title="åˆ‡æ¢ç›®å½•"></a>åˆ‡æ¢ç›®å½•</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> - è¿”å›ä¸Šæ¬¡æ‰€åœ¨ç›®å½•</span><br><span class="line"><span class="built_in">cd</span> ~ åˆ‡æ¢åˆ°å½“å‰ç”¨æˆ·homeè·¯å¾„ä¸‹</span><br><span class="line"><span class="built_in">cd</span> . å½“å‰è·¯å¾„</span><br><span class="line"><span class="built_in">cd</span> .. ä¸Šå±‚è·¯å¾„</span><br><span class="line"><span class="built_in">cd</span> ../linux åˆ‡æ¢åˆ°åŒä¸€çº§çš„linuxç›®å½•</span><br></pre></td></tr></table></figure><h1 id="æ–°å»ºæ–‡ä»¶ã€æ–‡ä»¶å¤¹"><a href="#æ–°å»ºæ–‡ä»¶ã€æ–‡ä»¶å¤¹" class="headerlink" title="æ–°å»ºæ–‡ä»¶ã€æ–‡ä»¶å¤¹"></a>æ–°å»ºæ–‡ä»¶ã€æ–‡ä»¶å¤¹</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir dirName åˆ›å»ºæ–‡ä»¶å¤¹</span><br><span class="line">touch fileName åˆ›å»ºæ–‡ä»¶</span><br></pre></td></tr></table></figure><p>Linuxæ–‡ä»¶å’Œç›®å½•åå­—é™¤äº†â€œ/â€éƒ½åˆæ³•ï¼Œä½†æ˜¯å°½é‡ä¸è¦ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¹‹ç±»çš„ç¬¦å·ï¼Œå› ä¸ºæœ‰å¯èƒ½ä¼šåœ¨è¿›è¡Œæ­£åˆ™åŒ¹é…æ—¶é€ æˆè¯¯åˆ ç­‰é—®é¢˜</p><p>å‡è®¾å½“å‰ç›®å½•æœ‰æ–‡ä»¶<code>f1,f2,f3</code>å’Œ<code>f[123]</code><br>æ‰§è¡Œï¼š<code>rm f[123]</code>æœ¬æ¥æ˜¯å¸Œæœ›åˆ é™¤<code>f[123]</code>,ä½†æ˜¯ç”±äºæ­£åˆ™åŒ¹é…ï¼Œä¼šå…ˆåˆ é™¤<code>f1,f2,f3</code>è¿™ä¸‰ä¸ªæ–‡ä»¶ã€‚</p><h1 id="æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯"><a href="#æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯"></a>æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file fileName æŸ¥çœ‹æ–‡ä»¶æ ¼å¼ä¿¡æ¯</span><br><span class="line">cat fileName ä»¥æ–‡æœ¬æ ¼å¼æŸ¥çœ‹æ–‡ä»¶å…¨éƒ¨å†…å®¹</span><br><span class="line">less fileName ä»¥åˆ†é¡µå½¢å¼æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼ŒQé”®é€€å‡º</span><br></pre></td></tr></table></figure><h1 id="å¸¸ç”¨ç›®å½•"><a href="#å¸¸ç”¨ç›®å½•" class="headerlink" title="å¸¸ç”¨ç›®å½•"></a>å¸¸ç”¨ç›®å½•</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/home å½“å‰ç”¨æˆ·ä¸»ç›®å½•ï¼Œrootç”¨æˆ·ä¸º/root</span><br><span class="line">/binã€/usr/bin å¸¸ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œrootç”¨æˆ·ä¸º/sbin</span><br><span class="line">/mediaã€/mnt ç”¨æˆ·ç¡¬ä»¶æŒ‚è½½ç‚¹</span><br><span class="line">/etc ç³»ç»Ÿçš„é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§ï¼Œrootç”¨æˆ·å¯ä»¥æ›´æ”¹</span><br><span class="line">/boot ç³»ç»Ÿå†…æ ¸ï¼Œå¼€æœºå¿…å¤‡æ–‡ä»¶</span><br><span class="line">/dev ç³»ç»Ÿçš„æ‰€æœ‰è®¾å¤‡æ–‡ä»¶ï¼Œå¦‚ç¡¬ç›˜ã€å…‰é©±ç­‰</span><br><span class="line">/varå’Œ/srv ç³»ç»Ÿè¿è¡Œæ—¶çš„ç”¨æˆ·æ•°æ®</span><br><span class="line">/proc å†…å­˜ä¸­çš„çŠ¶æ€ä¿¡æ¯</span><br><span class="line">/libã€/usr/libã€/usr/<span class="built_in">local</span>/lib åº“æ–‡ä»¶</span><br><span class="line">/temp ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§</span><br><span class="line">/usr ç¨‹åºç›¸å…³æ–‡ä»¶unix system resource</span><br></pre></td></tr></table></figure><h1 id="æ–‡ä»¶ç›¸å…³"><a href="#æ–‡ä»¶ç›¸å…³" class="headerlink" title="æ–‡ä»¶ç›¸å…³"></a>æ–‡ä»¶ç›¸å…³</h1><h2 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h2><p><strong><code>ls</code></strong>  å±•ç¤ºå½“å‰ç›®å½•ä¸‹æ–‡ä»¶ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls [-alhd] l</span><br></pre></td></tr></table></figure><p><code>l</code>å±•ç¤ºç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨ï¼Œ<code>a</code>å±•ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰ï¼Œ<code>h</code> å±•ç¤ºå¸¦å•ä½çš„æ–‡ä»¶å¤§å°ï¼Œ <code>d</code>å±•ç¤ºå½“å‰ç›®å½•æœ¬èº«ä¿¡æ¯</p><h2 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h2><p><strong><code>chmod</code></strong>  æ›´æ”¹æƒé™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod [-R] mode fileName</span><br></pre></td></tr></table></figure><p><code>mode</code>ç»„æˆå¦‚ä¸‹ï¼š<code>[èŒƒå›´] [æ“ä½œ] [æƒé™]</code></p><p><code>èŒƒå›´</code>ï¼š<code>u</code>ç”¨æˆ·ã€<code>g</code>ç¾¤ç»„ã€<code>o</code>å…¶ä»–ã€<code>a</code>ä»¥ä¸Šæ‰€æœ‰ï¼ˆugoï¼‰</p><p><code>æ“ä½œ</code>ï¼š<code>+</code> å¢åŠ ã€<code>-</code> å‡å»ã€<code>=</code> ç­‰äº</p><p><code>æƒé™</code>ï¼š<code>r</code> è¯»æƒé™<code>4</code>ã€<code>w</code> å†™æƒé™<code>2</code>ã€ <code>x</code> æ‰§è¡Œæƒé™<code>1</code> ã€æ— æƒé™  <code>0</code></p><p><strong>æƒé™éªŒè¯</strong> ï¼š rootç”¨æˆ·å¯ä»¥è®¿é—®ä»»ä½•ç”¨æˆ·æ–‡ä»¶ï¼Œä¸å—æƒé™é™åˆ¶ï¼›æ™®é€šç”¨æˆ·éœ€è¦éªŒè¯æƒé™</p><p><em>è¦è¯»å–æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ï¼Œä¹Ÿéœ€è¦æ‰§è¡Œæƒé™<code>x</code></em></p><h2 id="æ–‡ä»¶æƒé™ä¸umask"><a href="#æ–‡ä»¶æƒé™ä¸umask" class="headerlink" title="æ–‡ä»¶æƒé™ä¸umask"></a>æ–‡ä»¶æƒé™ä¸umask</h2><p>Linuxåˆ›å»ºæ–°é¡¹ç›®æ—¶é»˜è®¤çš„æƒé™åˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ–‡ä»¶å¤¹ 777</span><br><span class="line">æ–‡ä»¶ 666</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œç»è¿‡umaskï¼ˆæ­¤å¤„ä¸º0022ï¼‰é®ç›–åï¼Œå˜æˆäº†755 ï¼Œ644ï¼Œè¿™æ‰æ˜¯çœŸæ­£åˆ›å»ºåçš„ç»“æœ</p><p>å¯ä»¥é€šè¿‡<code>umaskæŸ¥çœ‹</code>umaskçš„å€¼ï¼Œä¸€èˆ¬åªå»å…¶<strong>å3ä½</strong>ï¼Œé®ç›–çš„åŸåˆ™æ˜¯ä»åŸå…ˆçš„æƒé™ä¸­<strong>å‡å»</strong>umaskä¸­çš„æƒé™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹æƒé™  ï¼š r w x      7</span><br><span class="line">umaskï¼š -  w x      3</span><br><span class="line">ç»“   æœ  ï¼š r - -      4</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹ã€ç®¡ç†å½“å‰ç”¨æˆ·ä¿¡æ¯"><a href="#æŸ¥çœ‹ã€ç®¡ç†å½“å‰ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ã€ç®¡ç†å½“å‰ç”¨æˆ·ä¿¡æ¯"></a>æŸ¥çœ‹ã€ç®¡ç†å½“å‰ç”¨æˆ·ä¿¡æ¯</h2><p><code>users</code> å’Œ<code>whoami</code>è¾“å‡ºå½“å‰ç”¨æˆ·å</p><p>å¢ã€åˆ ã€æ”¹ç”¨æˆ·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd / userdel / usermod username</span><br><span class="line">groupç¾¤ç»„ç®¡ç†ä¹Ÿç±»ä¼¼</span><br><span class="line">groupadd / groupmod ...</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>userdel -r username</code>åœ¨åˆ é™¤ç”¨æˆ·æ—¶ï¼Œä¹Ÿä¼šåˆ é™¤ç”¨æˆ·å¯¹åº”çš„ä¸»ç›®å½•<code>home</code></p><p><code>groups</code> æŸ¥çœ‹ç”¨æˆ·æ‰€åœ¨ç¾¤ç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæ˜¯ä¸»è¦ç¾¤ç»„ï¼Œå…¶ä½™æ˜¯æ¬¡è¦ç¾¤ç»„ã€‚</p><p><em>ä¸»è¦ç¾¤ç»„</em> åœ¨ç”¨æˆ·åˆ›å»ºæ–°çš„æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ç¾¤ç»„æƒé™ä¸€é¡¹é»˜è®¤ä¸ºè¯¥ç¾¤ç»„</p><p><code>who</code> ã€<code>w</code>å¯ä»¥æŸ¥çœ‹ç”¨æˆ·ç›¸å…³ä¿¡æ¯</p><p><code>id</code> æŸ¥çœ‹æŸäººæˆ–è€…è‡ªå·±ç›¸å…³çš„<code>UIDã€GID</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">finger [-s] username</span><br><span class="line">æŸ¥çœ‹ç”¨æˆ·ç›¸å…³ä¿¡æ¯</span><br><span class="line">-s ä»…æ˜¾ç¤ºç”¨æˆ·è´¦å·ã€å…¨åã€ç™»å½•æ—¶é—´</span><br></pre></td></tr></table></figure><p><code>GID</code> ç³»ç»Ÿ <500 ï¼Œç”¨æˆ·>500</500></p><h2 id="æ”¹å¯†ç "><a href="#æ”¹å¯†ç " class="headerlink" title="æ”¹å¯†ç "></a>æ”¹å¯†ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd username</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶æ‰“åŒ…ã€å‹ç¼©å’Œè§£å‹ç¼©"><a href="#æ–‡ä»¶æ‰“åŒ…ã€å‹ç¼©å’Œè§£å‹ç¼©" class="headerlink" title="æ–‡ä»¶æ‰“åŒ…ã€å‹ç¼©å’Œè§£å‹ç¼©"></a>æ–‡ä»¶æ‰“åŒ…ã€å‹ç¼©å’Œè§£å‹ç¼©</h2><p><code>.gz</code> å‹ç¼©åæ ¼å¼ï¼Œ<code>.tar</code>æ‰“åŒ…åæ ¼å¼ï¼Œ<code>tar.gz</code>å…ˆæ‰“åŒ…åå‹ç¼©çš„æ ¼å¼ï¼ˆå¸¸ç”¨ï¼‰</p><h3 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h3><p>gzipå‹ç¼©ä¼šåˆ é™¤æºæ–‡ä»¶,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip [-cdtv#] filename</span><br></pre></td></tr></table></figure><p><code>#</code> å‹ç¼©ç­‰çº§</p><p><code>v</code> æ˜¾ç¤ºå‹ç¼©å‰åå‹ç¼©æ¯”</p><p><code>t</code> æ ¡éªŒæ˜¯å¦æ˜¯gzipå‹ç¼©çš„æ–‡ä»¶</p><p><code>c</code> å‹ç¼©æ–‡ä»¶å¹¶è¾“å‡ºåˆ°å±å¹•</p><p><code>d</code> è§£å‹æ–‡ä»¶</p><p>ä½¿ç”¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gizp file å°†fileå‹ç¼©æˆfile.gzï¼Œä¼šåˆ é™¤file</span><br><span class="line">gzip -c file &gt; file.gz å‹ç¼©æ–‡ä»¶fileå¹¶è¾“å‡ºåˆ°file.gz</span><br></pre></td></tr></table></figure><h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><p>æ‰“åŒ…ï¼Œåœ¨å‹ç¼©æ–‡ä»¶å¤¹æ—¶ï¼Œä¸€èˆ¬ä¸ºäº†æ•ˆç‡éƒ½ä¼šå…ˆæ‰“åŒ…ï¼Œåœ¨å‹ç¼©ï¼Œç”±æ­¤å½¢æˆçš„æ ¼å¼ä¸€èˆ¬æ˜¯ç±»ä¼¼<code>*.tar.gz*</code>çš„åç¼€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ‰“åŒ…</span><br><span class="line">tar [-jcv] -f outFileName.tar inDirPath</span><br><span class="line">è§£åŒ…</span><br><span class="line">tar [-jxv] -f inFileName.tar -C outputPath</span><br></pre></td></tr></table></figure><p><code>c</code> å»ºç«‹æ‰“åŒ…æ–‡æ¡£</p><p><code>x</code> è§£åŒ…<code>-C</code> è¾“å‡ºç›®å½•</p><p><code>t</code> æŸ¥çœ‹æ‰“åŒ…æ–‡ä»¶çš„å†…å®¹</p><p><code>j</code> / <code>z</code> ä½¿ç”¨<code>bz2</code> / <code>gzip</code> å‹ç¼©ã€è§£å‹</p><p><code>v</code> è¾“å‡ºä¿¡æ¯</p><p><code>f</code> åé¢ç´§è·Ÿè¦æ“ä½œçš„æ–‡ä»¶</p><h1 id="bash-shell"><a href="#bash-shell" class="headerlink" title="bash shell"></a>bash shell</h1><p>bashæ˜¯ç”¨æˆ·å’Œå†…å®¹äº¤äº’çš„æ¡¥æ¢ <code>ç”¨æˆ· â†” bash â†” Unixå†…æ ¸</code></p><p><code>env</code> æŸ¥çœ‹ç¯å¢ƒå˜é‡</p><p><code>type</code> æŸ¥çœ‹ç±»å‹</p><p><code>which</code> æŸ¥çœ‹æŒ‡ä»¤çš„ä½ç½®</p><p><code>clear</code> ã€ <code>cls</code> æ¸…å±</p><p><strong>bash shell è®¾ç½®</strong></p><h2 id="è‡ªå®šä¹‰å˜é‡"><a href="#è‡ªå®šä¹‰å˜é‡" class="headerlink" title="è‡ªå®šä¹‰å˜é‡"></a>è‡ªå®šä¹‰å˜é‡</h2><p><code>key=value</code> å¢åŠ ä¸€ä¸ªå€¼ä¸º<code>value</code>çš„å˜é‡<code>key</code></p><p>å…¶ä¸­ï¼Œå¦‚æœvalueæœ‰ç©ºæ ¼çš„è¯éœ€è¦ç”¨å¼•å·åŒ…ä½ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŒå¼•å· å¯ä»¥ç”¨$KEY å¼•ç”¨å…¶ä»–KEYçš„å€¼</span><br><span class="line">å•å¼•å· å†…å®¹æ˜¯çº¯æ–‡æœ¬</span><br></pre></td></tr></table></figure><p><code>echo $KEYâ€‹</code>å¯ä»¥è¾“å‡º<code>KEY</code>çš„å€¼</p><p><code>set</code> æŸ¥çœ‹æ‰€æœ‰å˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set | grep HIST æŸ¥çœ‹shellå‘½ä»¤å†å²</span><br><span class="line">set | grep PSI æç¤ºç¬¦å‰é¢çš„å†…å®¹ï¼Œusername-MBP:dirpath username$</span><br></pre></td></tr></table></figure><h2 id="åˆ«åé…ç½®"><a href="#åˆ«åé…ç½®" class="headerlink" title="åˆ«åé…ç½®"></a>åˆ«åé…ç½®</h2><p><code>alias</code> æŸ¥çœ‹æ‰€æœ‰åˆ«å</p><p><code>alias newCmd=oldCmd</code>ä½¿ç”¨<code>newCmd</code>è¡¨ç¤º<code>oldCmd</code></p><p><code>unalias newCmd</code> åˆ é™¤åˆ«å</p><p>å¦‚:<code>alias cls=clear</code>,æ‰§è¡Œ<code>cls</code>å°±ç­‰äºæ‰§è¡Œ<code>clear</code></p><h2 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h2><p><code>export KEY=VALUE</code> å°†å€¼ä¸º<code>VALUE</code>çš„<code>KEY</code>æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ï¼ˆæœ¬æ¬¡shellæœ‰æ•ˆï¼‰</p><p>æ­¤å¤–è¿˜å¯ä»¥å†™åˆ°ä¸€äº›æ–‡ä»¶ä¸­ï¼Œåœ¨å¼€æœºã€ç™»å½•ã€æ³¨é”€ç™»å½•æ—¶è°ƒç”¨æ‰§è¡Œâ€”â€”è‡ªåŠ¨æ‰§è¡Œè„šæœ¬<strong><code>shell startup scripts</code></strong></p><h2 id="shell-startup-scripts"><a href="#shell-startup-scripts" class="headerlink" title="shell startup scripts"></a>shell startup scripts</h2><p>å¼€æœºæ—¶æ‰§è¡Œï¼š</p><ul><li><code>/etc/profile</code></li><li><p><code>/ect/profile.d/*.sh</code></p></li><li><p><code>~/.bash_profile , ~/.bash_login , ~/.profile</code>è¿™ä¸‰ä¸ªåªè¦å…¶ä¸­ä¸€ä¸ªæˆåŠŸæ‰§è¡Œäº†ï¼Œåé¢çš„å°±ä¸ä¼šæ‰§è¡Œï¼Œ<code>~/.bash_profile</code>ä¼šæ‰§è¡Œ<code>~/.bashrc</code></p></li><li><p><code>/etc/.bashrc</code></p></li></ul><p>æœªç™»å½•æ—¶ä¼šæ‰§è¡Œï¼š</p><ul><li><code>~/.bashrc</code></li><li><code>/etc/bashrc</code></li><li><code>/etc/profile.d/*.sh</code></li></ul><p>æ³¨é”€æ—¶æ‰§è¡Œ<code>~/bash_logout</code></p><p><strong>åœ¨ä¿®æ”¹äº†ä»¥ä¸Šæ–‡ä»¶åï¼Œå¯ä»¥ä½¿ç”¨<code>source path_to_file</code>æˆ–è€…é‡æ–°ç™»å½•ä½¿å…¶ç«‹å³ç”Ÿæ•ˆ</strong></p><h1 id="æ ‡å‡†è¾“å…¥è¾“å‡ºç­‰"><a href="#æ ‡å‡†è¾“å…¥è¾“å‡ºç­‰" class="headerlink" title="æ ‡å‡†è¾“å…¥è¾“å‡ºç­‰"></a>æ ‡å‡†è¾“å…¥è¾“å‡ºç­‰</h1><table><thead><tr><th>ä»£ç ç¼–å·</th><th>åç§°</th><th>ä»£ç </th><th>ä½œç”¨å¯¹è±¡</th></tr></thead><tbody><tr><td>0</td><td>æ ‡å‡†è¾“å…¥</td><td>stdin</td><td>é”®ç›˜ç­‰</td></tr><tr><td>1</td><td>æ ‡å‡†è¾“å‡º</td><td>stdout</td><td>å±å¹•ç­‰</td></tr><tr><td>2</td><td>æ ‡å‡†é”™è¯¯</td><td>stderr</td><td>å±å¹•ç­‰</td></tr></tbody></table><p>å®šå‘</p><ul><li><code>&lt;</code>å’Œ<code>&lt;&lt;</code> è¾“å…¥å’Œ è¿½åŠ è¾“å…¥</li><li><code>&gt;</code> å’Œ<code>&gt;&gt;</code> è¾“å‡º å’Œè¿½åŠ è¾“å‡º</li></ul><p>ä½¿ç”¨ï¼š<code>ls -al | &gt;&gt; result.txt</code>å°†<code>ls</code>çš„å†…å®¹è¿½åŠ è¾“å‡ºåˆ°<code>result.txt</code>æ–‡ä»¶ä¸­ã€‚</p><p><code>|</code>å«åšç®¡é“ï¼Œå¯ä»¥å°†å‰è€…çš„<strong>æ ‡å‡†è¾“å‡º</strong>å½“åšåè€…çš„è¾“å…¥ã€‚</p><p> <code>cmd0 &amp;&amp; cmd1</code> å‰è€…æ‰§è¡ŒæˆåŠŸæ‰ä¼šæ‰§è¡Œåè€…ï¼›</p><p><code>cmd0 || cmd1</code> å‰è€…æ‰§è¡Œå¤±è´¥æ‰ä¼šæ‰§è¡Œåè€…ã€‚</p><h1 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h1><p>æŸ¥è¯¢å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep [-cinv] 'key' filename</span><br></pre></td></tr></table></figure><p><code>c</code> è®¡ç®—æ¬¡æ•°</p><p><code>i</code> å¿½ç•¥å¤§å°å†™</p><p><code>n</code> è¡Œå·</p><p><code>v</code> æ˜¾ç¤ºæ²¡æœ‰è¯¥å­—ç¬¦çš„è¡Œå·</p><p><code>&#39;key&#39;</code>å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼</p><p><code>--color=auto</code> å¯¹æŸ¥æ‰¾åˆ°çš„æ–‡æœ¬æ˜¾ç¤ºé¢œè‰²</p><h1 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h1><p>æ’åºï¼Œé»˜è®¤ä»¥ç¬¬ä¸€åˆ—æ’åº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort [-fbknrtu] filename</span><br></pre></td></tr></table></figure><p><code>f</code> å¿½ç•¥å¤§å°å†™</p><p><code>b</code>å¿½ç•¥æœ€å‰é¢çš„ç©ºæ ¼ï¼ˆè¦æ˜¯æ’åºä¸ç”Ÿæ•ˆæ—¶å¯ä»¥è¯•ä¸€ä¸‹ï¼Œæ¨èï¼‰</p><p><code>k</code> ä»¥ç¬¬å‡ åˆ—ä¸ºæ ‡å‡†æ’åºï¼Œé»˜è®¤ç¬¬ä¸€åˆ—</p><p><code>n</code> ä»¥æ•°ç»„æ’åº</p><p><code>r</code> é€†åº</p><p><code>t</code> å¾…æ’åºçš„æ–‡ä»¶çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤æ˜¯tab</p><p><code>M</code> ä»¥è‹±æ–‡æœˆä»½æ’åº</p><h1 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h1><p>ç»Ÿè®¡å­—ç¬¦æ•°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wc [lwm] filename</span><br></pre></td></tr></table></figure><p><code>l</code> è¡Œ</p><p><code>w</code> è¯</p><p><code>m</code> å­—ç¬¦</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaçº¿ç¨‹å®‰å…¨ä¸volatileå’Œsynchronize</title>
      <link href="/blog/posts/24967ad4/"/>
      <url>/blog/posts/24967ad4/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Javaå¤šçº¿ç¨‹ç¼–ç ä¸­ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨çš„å®è´¨æ˜¯ä¿è¯å¯¹æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„æ“ä½œèƒ½å¤ŸåŠæ—¶çš„æ›´æ–°åˆ°å…¶ä»–ä½¿ç”¨è¯¥æ•°æ®çš„çº¿ç¨‹ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å¤šä¸ªçº¿ç¨‹å› ä¸ºæ“ä½œçš„æ•°æ®å€¼ä¸ä¸€è‡´è€Œäº§ç”Ÿé”™è¯¯ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20190112144856.png" alt="çº¿ç¨‹ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸‰è€…äº¤äº’å…³ç³»â€”â€”æ·±å…¥ç†è§£JAVAè™šæ‹Ÿæœº"></p><p>ç”±äºJavaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰è§„å®šï¼Œæ‰€æœ‰çº¿ç¨‹å…¬ç”¨çš„æ•°æ®ä¿å­˜åœ¨ä¸»å†…å­˜ä¸­ï¼Œè€Œçº¿ç¨‹åœ¨ä½¿ç”¨æ—¶å…ˆä»ä¸»å†…å­˜ä¸­å–åˆ°çº¿ç¨‹ç§æœ‰çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä¹‹åå†åœ¨ä½¿ç”¨å®Œæ¯•ååŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¹Ÿç”¨åˆ°äº†è¯¥æ•°æ®åˆ™å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨çº¿ç¨‹æ“ä½œæ•°æ®æ—¶éœ€è¦è€ƒè™‘çº¿ç¨‹å¹¶å‘æ—¶æ“ä½œæ•°æ®çš„åŒæ­¥é—®é¢˜ã€‚</p><p><code>volatile</code>å’Œ<code>synchronize</code>å› æ­¤è€Œç”Ÿã€‚</p><h1 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h1><p><code>volatile</code>ä¿®é¥°çš„å˜é‡æœ‰ä¸¤ä¸ªç‰¹æ€§ï¼š</p><ul><li>å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§  æ™®é€šå˜é‡åˆ™éœ€è¦ç­‰çº¿ç¨‹æ“ä½œå®Œæ¯•ï¼Œå°†ç»“æœä»å·¥ä½œå†…å­˜å†™å…¥åˆ°ä¸»å†…å­˜ä¸­æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹å¯è§ï¼Œvolatileä¿®é¥°çš„å˜é‡ä¼šåœ¨ä¿®æ”¹åé€šçŸ¥å…¶ä»–çº¿ç¨‹è¯¥å˜é‡å·²ç»è¢«æ›´æ”¹ï¼Œä»è€Œè®©å…¶ä»–çº¿ç¨‹å†å»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„å€¼</li><li>ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ–</li></ul><p><code>volatile</code>ä¿®é¥°çš„å˜é‡æ‰§è¡Œæ•ˆç‡å’Œæ™®é€šå˜é‡å·®åˆ«ä¸å¤§ï¼Œå…¶å†™æ“ä½œå› ä¸ºè¦æ’å…¥å†…å­˜å±éšœï¼Œæ‰€ä»¥ä¼šç¨å¾®æ…¢ä¸€äº›</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li><p>ç”±äºJavaè¿ç®—çš„å…·ä½“å®ç°å¹¶éåŸå­æ€§çš„ï¼Œæ•…è€Œè™½ç„¶<code>volatile</code>ä¿®é¥°çš„å˜é‡åœ¨æ‰€æœ‰çº¿ç¨‹å¯è§ï¼Œä½†æ˜¯å¹¶å‘ä¸‹å¹¶ä¸çº¿ç¨‹å®‰å…¨ã€‚</p><blockquote><p>Javaä»£ç ç¼–è¯‘æˆclassæ–‡ä»¶åå¯ä»¥çœ‹åˆ°ï¼Œç±»ä¼¼<code>c = c + 1</code>è¿™æ ·çš„è¯­å¥ï¼Œä¼šè¢«åˆ†ä¸ºï¼šè¯»å–<code>c</code>çš„å€¼ï¼›è®¡ç®—<code>c+1</code>çš„å€¼ï¼›å°†ç»“æœèµ‹äºˆ<code>c</code>è¿™å‡ æ­¥æ¥å®Œæˆã€‚æ‰€ä»¥åœ¨æ­¤æœŸé—´å¦‚æœæœ‰å…¶ä»–çš„çº¿ç¨‹è®¿é—®è¿™æ®µä»£ç ï¼Œå°±ä¼šå‘ç”Ÿå†²çªã€‚</p></blockquote></li><li><p>Javaä¼šé€šè¿‡<strong>æŒ‡ä»¤é‡æ’</strong>æ¥ä¼˜åŒ–ä»£ç </p><blockquote><p>æŒ‡ä»¤é‡æ’ æŒ‡å¯¹äºå˜é‡çš„èµ‹å€¼ä¼šåœ¨å®šä¹‰è¯¥å˜é‡å’Œä½¿ç”¨è¯¥å˜é‡çš„å€¼ä¹‹é—´çš„ä»»æ„ä½ç½®æ‰§è¡Œï¼Œä¸ä¸€å®šå’Œä»£ç ä¸­çš„é¡ºåºä¸€è‡´</p></blockquote><p><code>volatile</code>ä¿®é¥°çš„å˜é‡åˆ™ä¼šæ’å…¥<em>å†…å­˜å±éšœ</em>ï¼Œä»è€Œå®ç°å±è”½æŒ‡ä»¤é‡æ’çš„æ•ˆæœ</p></li></ul><h1 id="synchronize"><a href="#synchronize" class="headerlink" title="synchronize"></a>synchronize</h1><p><code>synchronize</code>å®ç°çš„åŸç†æ˜¯<strong>é”å®šæŒ‡å®šçš„å¯¹è±¡</strong>ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™é”å®šå¯¹åº”çš„ç±»å¯¹è±¡æˆ–classå¯¹è±¡ï¼‰ï¼Œç„¶åé˜»å¡å…¶ä»–çº¿ç¨‹è¿›å…¥ï¼ˆè·å–åˆ°è¯¥é”çš„çº¿ç¨‹å¯ä»¥å¤šæ¬¡é‡å…¥ï¼‰ã€‚</p><p>ç”±äºJavaçš„çº¿ç¨‹å®ç°æ˜¯æ˜ å°„åˆ°ç³»ç»Ÿçº¿ç¨‹çš„ï¼Œé˜»å¡å’Œå”¤é†’éœ€è¦ç”±ç³»ç»Ÿå†…æ ¸å®Œæˆï¼Œä¼šæ¶ˆè€—å¤§é‡çš„æ—¶é—´ï¼Œå› æ­¤<code>synchronize</code>æ˜¯<strong>é‡é‡çº§æ“ä½œ</strong>ã€‚</p><h1 id="JMMä¸ä¸‰ä¸ªç‰¹å¾"><a href="#JMMä¸ä¸‰ä¸ªç‰¹å¾" class="headerlink" title="JMMä¸ä¸‰ä¸ªç‰¹å¾"></a>JMMä¸ä¸‰ä¸ªç‰¹å¾</h1><p>JMMçš„è®¾è®¡æ˜¯å›´ç»•ç€<strong>åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§</strong>ä¸‰ä¸ªç‰¹å¾è¿›è¡Œçš„ã€‚</p><ul><li><p><strong>åŸå­æ€§</strong> JVMä¸­çš„<code>read,load,assign,use,store,write</code>æ“ä½œå’Œ<code>synchronize</code></p></li><li><p><strong>å¯è§æ€§</strong> ä¸€ä¸ªçº¿ç¨‹æ›´æ”¹äº†å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œå…¶ä½™çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªæ›´æ”¹ã€‚é€šè¿‡<code>synchronize</code>ï¼Œ<code>final</code>å’Œ<code>volatile</code>ä¿è¯ã€‚</p><p><code>final</code>è¦ä¿è¯å¯è§æ€§çš„å‰ææ˜¯è¦è¢«<strong>å®‰å…¨çš„æ„å»ºå‡ºæ¥</strong>ï¼Œé¿å…<strong>â€œthiså¼•ç”¨é€ƒé€¸â€</strong></p><blockquote><p><strong>thiså¼•ç”¨é€ƒé€¸</strong> å¯¹è±¡è¿˜æ²¡æœ‰è¢«æ„é€ å®Œæˆï¼Œä»–çš„<code>thiså¼•ç”¨</code>å°±å·²ç»è¢«å‘å¸ƒå‡ºå»äº†ã€‚</p><p>åœ¨æ„é€ å‡½æ•°ä¸­ç”Ÿæˆå†…éƒ¨ç±»ï¼Œç”±äºå†…éƒ¨ç±»è‡ªåŠ¨æŒæœ‰å¤–éƒ¨ç±»çš„<code>thiså¼•ç”¨</code>ï¼Œå¦‚æœæœ‰å¯¹è±¡åœ¨å†…éƒ¨ç±»è¯­å¥ä¹‹åæ„é€ ï¼Œåˆ™å°±æœ‰å¯èƒ½å‘ç”Ÿâ€œå†…éƒ¨ç±»è®¿é—®è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡è¿˜æ²¡æœ‰æ„é€ å®Œæ¯•â€çš„æƒ…å†µã€‚</p></blockquote></li><li><p><strong>æœ‰åºæ€§</strong> é€šè¿‡<code>synchronize</code>,<code>volatile</code>ä¿è¯ã€‚</p></li></ul><p>çº¿ç¨‹ä»å†…éƒ¨è§‚å¯Ÿæ—¶æœ‰åºï¼ˆçº¿ç¨‹å†…æ˜¯ä¸²è¡Œçš„è¯­ä¹‰ï¼‰ï¼Œçº¿ç¨‹å¤–éƒ¨è§‚å¯Ÿæ˜¯æ— åºï¼ˆç”±æŒ‡ä»¤é‡æ’ã€å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿå¯¼è‡´ï¼‰</p><h1 id="å®ç°çº¿ç¨‹å®‰å…¨"><a href="#å®ç°çº¿ç¨‹å®‰å…¨" class="headerlink" title="å®ç°çº¿ç¨‹å®‰å…¨"></a>å®ç°çº¿ç¨‹å®‰å…¨</h1><p>å®ç°çº¿ç¨‹å®‰å…¨æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p><h2 id="äº’æ–¥åŒæ­¥ï¼ˆé˜»å¡åŒæ­¥ï¼‰"><a href="#äº’æ–¥åŒæ­¥ï¼ˆé˜»å¡åŒæ­¥ï¼‰" class="headerlink" title="äº’æ–¥åŒæ­¥ï¼ˆé˜»å¡åŒæ­¥ï¼‰"></a>äº’æ–¥åŒæ­¥ï¼ˆé˜»å¡åŒæ­¥ï¼‰</h2><p>äº’æ–¥åŒæ­¥çš„æ€æƒ³æ˜¯ï¼šå¤šä¸ªçº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ªå…±äº«æ•°æ®æ—¶ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨</p><p>æœ‰ä¸¤ç§é€”å¾„ï¼š</p><ul><li><code>synchronize</code> ï¼ˆåŸç”Ÿè¯­æ³•å±‚ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨</li><li><code>ReentrantLock</code> é‡å…¥é”ï¼ˆAPIå±‚ï¼‰ï¼ŒåŠŸèƒ½æœ‰ï¼š1.ç­‰å¾…å¯ä¸­æ–­ï¼ˆå¯ä»¥æ”¾å¼ƒç­‰å¾…ï¼‰2.å…¬å¹³é” å¤šä¸ªçº¿ç¨‹ç”³è¯·é”æ—¶å¿…é¡»æŒ‰ç…§ç”³è¯·æ—¶é—´é¡ºåºè·å¾—é” 3.é”ç»‘å®šå¤šä¸ªæ¡ä»¶</li></ul><h2 id="éé˜»å¡åŒæ­¥"><a href="#éé˜»å¡åŒæ­¥" class="headerlink" title="éé˜»å¡åŒæ­¥"></a>éé˜»å¡åŒæ­¥</h2><p>å‡å°‘äº†é˜»å¡/å”¤é†’çš„è€—æ—¶ï¼Œåœ¨æ“ä½œæ—¶è¿›è¡ŒCASï¼ˆæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰ï¼Œåœ¨å†²çªå‘ç”Ÿçš„æ—¶å€™ä¸æ–­å°è¯•æ‰§è¡Œæ‰€éœ€æ“ä½œï¼Œç›´åˆ°æ‰§è¡ŒæˆåŠŸã€‚</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªé€»è¾‘æ¼æ´ï¼šå¦‚æœåœ¨ç¬¬ä¸€æ¬¡æ“ä½œå¤±è´¥åˆ°ç¬¬äºŒæ¬¡å†æ¬¡å°è¯•æ“ä½œä¹‹é—´ï¼Œ<em>å…¶ä»–çº¿ç¨‹å¯¹é½è¿›è¡Œäº†æ“ä½œä½†æ˜¯è¯¥æ•°æ®æœ€ç»ˆæ²¡æœ‰è¢«å˜åŒ–</em>ï¼Œå½“ç¬¬äºŒæ¬¡å†æ¬¡å°è¯•æ—¶ï¼Œå…¶å®å·²ç»è¢«å…¶ä»–çº¿ç¨‹è®¿é—®è¿‡äº†ã€‚</p><h2 id="æ— åŒæ­¥æ–¹æ¡ˆ"><a href="#æ— åŒæ­¥æ–¹æ¡ˆ" class="headerlink" title="æ— åŒæ­¥æ–¹æ¡ˆ"></a>æ— åŒæ­¥æ–¹æ¡ˆ</h2><p>ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸ä¸€å®šéœ€è¦åŒæ­¥ï¼Œå½“çº¿ç¨‹æ“ä½œçš„æ•°æ®ä¸æ˜¯å…±äº«æ•°æ®æ—¶ï¼Œå³ä½¿ä¸åŒæ­¥ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><ul><li><strong>å¯é‡å…¥ä»£ç </strong> æŒ‡åœ¨ä»£ç æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸­æ–­å…¶è¿è¡Œå¹¶è¿è¡Œå…¶ä»–çš„çº¿ç¨‹ï¼Œå½“å†æ¬¡è¿”å›ç»§ç»­æ‰§è¡Œè¯¥ä»£ç æ—¶ä¸ä¼šå½±å“åˆ°å…¶æ‰§è¡Œç»“æœçš„ä»£ç ã€‚è¿™ç§ä»£ç ä¸€èˆ¬æ²¡æœ‰ç”¨åˆ°å †ä¸­çš„å…¬ç”¨èµ„æºã€‚</li><li><strong>çº¿ç¨‹æœ¬åœ°å­˜å‚¨</strong> å…±äº«æ•°æ®å€¼å­˜åœ¨äºåŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¦‚æ¯ä¸ªçº¿ç¨‹çš„ThreadLocalå¯¹è±¡</li></ul><h1 id="é”ä¼˜åŒ–"><a href="#é”ä¼˜åŒ–" class="headerlink" title="é”ä¼˜åŒ–"></a>é”ä¼˜åŒ–</h1><p>JDK1.6ä»¥åï¼Œåœ¨HotSpotè™šæ‹Ÿæœºä¸Šå®ç°äº†è®¸å¤šé”ä¼˜åŒ–æŠ€æœ¯ï¼š</p><ul><li><p>è‡ªæ—‹é”</p><p>å®ç°é˜»å¡åŒæ­¥æ—¶ï¼Œé˜»å¡å’Œå”¤é†’ä¼šå¾ˆè€—æ—¶ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥å…ˆå¯¹å…¶è¿›è¡Œ<em>å¿™å¾ªç¯</em>ï¼Œå¦‚æœè¿˜ä¸è¡Œå†å»æ‰§è¡Œé˜»å¡æ“ä½œ</p><p><em>è‡ªé€‚åº”è‡ªæ—‹</em> ç”±JVMæ™ºèƒ½å†³å®šè‡ªæ—‹æ¬¡æ•°</p></li><li><p>é”æ¶ˆé™¤</p><p>JVMä¼šè‡ªåŠ¨å–å‡ºä¸å¿…è¦çš„é”</p></li><li><p>é”ç²—åŒ–</p><p>å¦‚æœä¸€æ®µä»£ç ä¸­æœ‰è¿ç»­çš„é”ï¼Œåˆ™JVMä¼šå°†è¿™äº›é”åˆå¹¶ä¸ºä¸€ä¸ªå¤§é”</p></li><li><p>è½»é‡çº§é”</p><p>è½»é‡çº§é”æ¶ˆè€—æ¯”ä¼ ç»Ÿé”æœºåˆ¶å°ï¼Œä¼šä¼˜å…ˆå°è¯•ä½¿ç”¨è½»é‡çº§é”ï¼Œå¦‚æœä¸è¡Œï¼Œåœ¨å‡çº§ä¸ºäº’æ–¥é”</p><p>å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šå‡å°‘æ¶ˆè€—ï¼Œä½†å¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œåˆ™é™¤äº†äº’æ–¥é”çš„å¼€é”€å¤–ï¼Œè¿˜æœ‰è½»é‡çº§é”çš„å¼€é”€</p></li><li><p>åå‘é”</p><p>åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹æ¶ˆé™¤åŒæ­¥</p></li><li><p>ä¹è§‚é”</p><p>è¯»å–æ•°æ®æ—¶é»˜è®¤è¯¥å¯¹è±¡ä¸ä¼šè¢«å…¶ä»–å¯¹è±¡æ›´æ”¹è€Œä¸åŠ é”ï¼Œæ¯æ¬¡å†™æ•°æ®æ—¶å¯¹æ¯”å½“å‰å€¼ä¸æŒæœ‰å€¼æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´æ—¶æ‰å»æ›´æ–°æ•°æ®</p></li></ul><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºâ€”â€”JVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹ å‘¨å¿—æ˜</p><p><a href="https://blog.csdn.net/u010571316/article/details/77993309" target="_blank" rel="noopener">thiså¼•ç”¨é€ƒé€¸â€”â€”èœ¡ç¬”å°å‹‹</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_æ€»ç»“</title>
      <link href="/blog/posts/851be5ef/"/>
      <url>/blog/posts/851be5ef/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡æ±‡æ€»äº†æ•°æ®ç»“æ„çš„ä¼˜ç¼ºç‚¹åŠåº”ç”¨åœºæ™¯ã€‚</p><p>é€šç”¨æ•°æ®ç»“æ„ï¼šæ•°ç»„ã€é“¾è¡¨ã€æ ‘ã€å“ˆå¸Œè¡¨</p><p>ä¸“ç”¨æ•°æ®ç»“æ„ï¼šæ ˆã€é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—</p><p>æ’åºï¼šå†’æ³¡æ’åºã€é€‰æ‹©æ’åºã€æ’å…¥æ’åºï¼Œå¸Œå°”æ’åºã€å¿«é€Ÿæ’åºã€å½’å¹¶æ’åºã€å †æ’åº</p><p>å›¾ï¼šé‚»æ¥çŸ©é˜µã€é‚»æ¥è¡¨</p><h1 id="é€šç”¨æ•°æ®ç»“æ„"><a href="#é€šç”¨æ•°æ®ç»“æ„" class="headerlink" title="é€šç”¨æ•°æ®ç»“æ„"></a>é€šç”¨æ•°æ®ç»“æ„</h1><p>è¿™äº›æ•°æ®ç»“æ„ä½¿ç”¨å…³é”®å­—çš„å€¼å­˜å‚¨ã€æŸ¥æ‰¾æ•°æ®</p><p>å…¶é€Ÿåº¦å¦‚ä¸‹ï¼š</p><p><code>å“ˆå¸Œè¡¨ &gt; æ ‘ &gt; é“¾è¡¨ &gt; æ•°ç»„</code></p><p>æ•°ç»„ï¼šæ•°æ®é‡å°ï¼Œå¤§å°å¯ä»¥é¢„æµ‹æ—¶ä½¿ç”¨</p><p>é“¾è¡¨ï¼šæ•°æ®å¤§å°ä¸å¯é¢„çŸ¥ï¼Œæˆ–éœ€è¦é¢‘ç¹æ’å…¥åˆ é™¤å…ƒç´ æ—¶ä½¿ç”¨</p><p>äºŒå‰æœç´¢æ ‘ï¼šå¦‚æœæ•°ç»„å’Œé“¾è¡¨éƒ½å¾ˆæ…¢æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘äºŒå‰æ ‘</p><p>å¹³è¡¡æ ‘ï¼šäºŒå‰æœç´¢æ ‘å¾ˆå¿«ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°æ•°æ®æ˜¯é€†åºçš„æ—¶å€™ï¼Œå°±ä¼šå¾ˆè€—æ€§èƒ½ï¼Œè€Œå¹³è¡¡æ ‘åˆ™ä¸ä¼š</p><p>å“ˆå¸Œè¡¨ï¼šåœ¨æ•°æ®å­˜å‚¨ç»“æ„ä¸­æœ€å¿«ï¼Œä½†æ˜¯éœ€è¦æœ‰é¢å¤–çš„ç©ºé—´</p><p>ä¸‹é¢æ˜¯ä»¥ä¸Šæ•°æ®ç»“æ„çš„é€Ÿåº¦ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20190105140704.png" alt="é€šç”¨æ•°æ®ç»“æ„é€Ÿåº¦ç»Ÿè®¡"></p><h1 id="ä¸“ç”¨æ•°æ®ç»“æ„"><a href="#ä¸“ç”¨æ•°æ®ç»“æ„" class="headerlink" title="ä¸“ç”¨æ•°æ®ç»“æ„"></a>ä¸“ç”¨æ•°æ®ç»“æ„</h1><p>åŒ…æ‹¬æ ˆã€é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆå †ï¼‰ï¼Œéƒ½æ˜¯æŠ½è±¡æ•°æ®ç»“æ„(ADT)ï¼Œç”±æ›´åŠ åŸºç¡€çš„<code>é€šç”¨æ•°æ®ç»“æ„</code>ç»„æˆã€‚</p><p>ä¸èƒ½æŸ¥æ‰¾æˆ–è€…éå†ï¼Œåªèƒ½è®¿é—®æŒ‡å®šå…ƒç´ ï¼ˆå¤´éƒ¨ï¼Œé˜Ÿåˆ—ä¹Ÿå¯ä»¥è®¿é—®å°¾éƒ¨ï¼‰ã€‚</p><h2 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h2><p>å…ˆè¿›åå‡º(FILO)ï¼Œæœ€åæ’å…¥çš„æ•°æ®åœ¨æ ˆé¡¶ï¼Œæ¯æ¬¡åªèƒ½è®¿é—®æ ˆé¡¶å…ƒç´ ã€‚</p><h2 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h2><p>å…ˆè¿›å…ˆå‡º(FIFO)ï¼Œæœ€åæ’å…¥çš„æ•°æ®åœ¨é˜Ÿå°¾ï¼Œæœ€å…ˆæ’å…¥çš„åœ¨é˜Ÿé¦–ï¼Œæ¯æ¬¡å…ˆå¼¹å‡ºé˜Ÿé¦–çš„å…ƒç´ ã€‚</p><h2 id="ä¼˜å…ˆçº§é˜Ÿåˆ—"><a href="#ä¼˜å…ˆçº§é˜Ÿåˆ—" class="headerlink" title="ä¼˜å…ˆçº§é˜Ÿåˆ—"></a>ä¼˜å…ˆçº§é˜Ÿåˆ—</h2><p>æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œä¸åŒçš„æ˜¯ä¼˜å…ˆçº§é«˜çš„åœ¨é˜Ÿé¦–ï¼Œä¼˜å…ˆçº§ä½çš„åœ¨é˜Ÿå°¾ï¼Œæ¯æ¬¡å¼¹å‡ºä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ ï¼ˆè¿™æ„å‘³ç€æ¯æ¬¡æ’å…¥æˆ–å¼¹å‡ºæ—¶è¦è¿›è¡Œæ’åºï¼‰ã€‚</p><h2 id="æ•ˆç‡"><a href="#æ•ˆç‡" class="headerlink" title="æ•ˆç‡"></a>æ•ˆç‡</h2><p><img src="https://jixiaoyong.github.io/images/20190105141727.png" alt="ä¸“ç”¨æ•°æ®ç»“æ„æ•ˆç‡æ¯”è¾ƒ"></p><h1 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h1><p>æ’åºåŒ…æ‹¬å†’æ³¡æ’åºã€é€‰æ‹©æ’åºã€æ’å…¥æ’åºï¼Œå¸Œå°”æ’åºã€å¿«é€Ÿæ’åºã€å½’å¹¶æ’åºã€å †æ’åºã€‚</p><p>ä¸€èˆ¬ä½¿ç”¨æ’åºä¼˜å…ˆçº§ï¼š</p><p><code>æ’å…¥æ’åº &gt; å¸Œå°”æ’åº &gt; å¿«é€Ÿæ’åº &gt; å½’å¹¶æ’åº &gt; å †æ’åº</code></p><p>å½’å¹¶æ’åºï¼šéœ€è¦è¾…åŠ©å­˜å‚¨ç©ºé—´</p><p>å †æ’åºï¼šéœ€è¦ä¸€ä¸ªå †çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¿«é€Ÿæ’åºæ›´é€‚äºééšæœºæ•°æ®</p><p>å¿«é€Ÿæ’åºï¼šå¤„ç†ééšæœºæ•°æ®æ—¶ä¼šæ…¢åˆ°$O(N^2)â€‹$</p><p>ä¸‹é¢æ˜¯æ’åºç®—æ³•æ¯”è¾ƒï¼š</p><p><img src="https://jixiaoyong.github.io/images/20190105142406.png" alt="æ’åºç®—æ³•æ¯”è¾ƒ"></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_äºŒå‰æ ‘</title>
      <link href="/blog/posts/101c73f/"/>
      <url>/blog/posts/101c73f/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡ä»‹ç»äº†äºŒå‰æ ‘ï¼ŒåŠå…¶åº”ç”¨ã€‚</p><p>æ ‘ï¼Œæ—¢èƒ½åƒé“¾è¡¨é‚£æ ·å¿«é€Ÿæ’å…¥å’Œåˆ é™¤ï¼Œåˆå¯ä»¥åƒæ•°ç»„é‚£æ ·å¿«é€ŸæŸ¥æ‰¾ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20190103200423.png" alt="æ ‘"></p><p>æ¯æ£µæ ‘æœ‰ä¸”åªæœ‰ä¸€ä¸ª<strong>æ ¹</strong>ï¼Œä»æ ¹åˆ°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹<strong>æœ‰ä¸”åªæœ‰ä¸€æ¡è·¯å¾„</strong>ï¼›æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥æœ‰0ä¸ªæˆ–è€…å¤šä¸ª<strong>å­èŠ‚ç‚¹</strong>ï¼Œæ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹å«åš<strong>å¶å­èŠ‚ç‚¹</strong>ã€‚</p><p><strong>å±‚</strong>æ˜¯æŒ‡ä»æ ¹èŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„â€œä»£â€æ ‘ï¼Œæ ¹èŠ‚ç‚¹çš„åœ¨<strong>0å±‚</strong>ã€‚</p><h1 id="äºŒå‰æœç´¢æ ‘"><a href="#äºŒå‰æœç´¢æ ‘" class="headerlink" title="äºŒå‰æœç´¢æ ‘"></a>äºŒå‰æœç´¢æ ‘</h1><p>ä¸€ä¸ªèŠ‚ç‚¹åªèƒ½æœ‰0~2ä¸ªå­èŠ‚ç‚¹çš„æ ‘å«åš<strong>äºŒå‰æ ‘</strong>ï¼›</p><p>å¦‚æœäºŒå‰æ ‘çš„å·¦å­èŠ‚ç‚¹çš„å…³é”®å­—å°äºè¯¥èŠ‚ç‚¹ï¼Œå³å­èŠ‚ç‚¹çš„å…³é”®å­—å¤§äºè¯¥èŠ‚ç‚¹ï¼Œåˆ™è¯¥äºŒå‰æ ‘ç§°ä¸º<strong>äºŒå‰æœç´¢æ ‘</strong>ã€‚</p><p>å¦‚ä¸‹ï¼Œæ˜¯ä¸€ä¸ªäºŒå‰æ ‘çš„èŠ‚ç‚¹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryNode</span></span>(<span class="keyword">val</span> iId: <span class="built_in">Int</span>, <span class="keyword">val</span> dData: <span class="built_in">Double</span>, <span class="keyword">var</span> left: BinaryNode? = <span class="literal">null</span>, <span class="keyword">var</span> right: BinaryNode? = <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;<span class="variable">$iId</span>,<span class="variable">$dData</span>&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="éå†"><a href="#éå†" class="headerlink" title="éå†"></a>éå†</h2><p>éå†æ ‘æŒ‡å®‰è£…ä¸€å®šçš„é¡ºåºè®¿é—®æ•°çš„æ¯ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‰ç…§è®¿é—®èŠ‚ç‚¹çš„é¡ºåºä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li>å‰åºéå†</li><li>ä¸­åºéå†</li><li>ååºéå†</li></ul><p>ä»¥ä¸­åºéå†ä¸ºä¾‹ï¼Œå…¶è®¿é—®èŠ‚ç‚¹çš„é¡ºåºå¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨è‡ªèº«éå†è¯¥èŠ‚ç‚¹çš„å·¦å­æ ‘ï¼›</li><li>è®¿é—®è¿™ä¸ªèŠ‚ç‚¹ï¼›</li><li>è°ƒç”¨è‡ªèº«éå†è¯¥èŠ‚ç‚¹çš„å³å­æ ‘ã€‚</li></ol><p>å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸­åºéå†æ³•</span></span><br><span class="line"><span class="comment"> * ä½¿æ‰€æœ‰èŠ‚ç‚¹çš„å…³é”®å€¼æŒ‰ç…§å‡åºè¢«è®¿é—®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">inTraversing</span><span class="params">(node: <span class="type">BinaryNode</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    inTraversing(node.left)</span><br><span class="line">    print(<span class="string">"<span class="variable">$node</span>,"</span>)</span><br><span class="line">    inTraversing(node.right)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€å¤§å€¼å’Œæœ€å°å€¼"><a href="#æœ€å¤§å€¼å’Œæœ€å°å€¼" class="headerlink" title="æœ€å¤§å€¼å’Œæœ€å°å€¼"></a>æœ€å¤§å€¼å’Œæœ€å°å€¼</h2><p>äºŒå‰æœç´¢æ ‘çš„æœ€å¤§å€¼æ˜¯å³å­æ ‘ä¸­æœ€å³ç«¯æ²¡æœ‰å­èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼›</p><p>äºŒå‰æœç´¢æ ‘çš„æœ€å°å€¼æ˜¯å·¦å­æ ‘ä¸­æœ€å·¦ç«¯æ²¡æœ‰å­èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ã€‚</p><h2 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h2><p>äºŒå‰æœç´¢æ ‘å› ä¸ºèŠ‚ç‚¹è¦æ»¡è¶³<code>å·¦å­èŠ‚ç‚¹ &lt; èŠ‚ç‚¹ &lt; å³å­èŠ‚ç‚¹</code>è¿™ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥åˆ é™¤éœ€è¦åˆ†ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><p>æŒ‰ç…§è¦åˆ é™¤çš„èŠ‚ç‚¹å­èŠ‚ç‚¹æ•°ç›®çš„ä¸åŒï¼Œåˆ†ä¸º3ç§æƒ…å†µ</p><ul><li><p>è¦åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶èŠ‚ç‚¹ å°†å…¶çˆ¶èŠ‚ç‚¹çš„æŒ‡å‘è®¾ä¸ºnullå³å¯</p></li><li><p>è¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸”åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ å°†å…¶çˆ¶èŠ‚ç‚¹æŒ‡å‘å…¶å­èŠ‚ç‚¹</p></li><li><p>è¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ è¿™æ—¶å€™å¯ä»¥æ‰¾è¯¥å­èŠ‚ç‚¹çš„å³å­æ ‘ä¸­æœ€å°çš„ï¼ˆæˆ–è€…å·¦å­æ ‘ä¸­æœ€å¤§çš„ï¼‰èŠ‚ç‚¹å¹¶æ›¿æ¢æ‰è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œ</p><p>ä¸æ­¤åŒæ—¶å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æœ‰å³å­èŠ‚ç‚¹ï¼ˆæˆ–å¯¹åº”çš„å·¦å­èŠ‚ç‚¹ï¼‰åˆ™æŒ‰ç…§2/3çš„è§„åˆ™å¤„ç†ï¼Œè¿™æ ·å°±èƒ½ä¿è¯è¿™ä¸ªæ ‘çš„ç»“æ„ä¸ä¼šå‡ºé”™</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">delete</span><span class="params">(iId: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾iIdå¯¹åº”çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">var</span> current = root</span><br><span class="line">        <span class="keyword">var</span> parent = root</span><br><span class="line">        <span class="keyword">while</span> (current?.iId != iId) &#123;</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            parent = current</span><br><span class="line">            current = <span class="keyword">if</span> (iId &gt; current.iId) &#123;</span><br><span class="line">                current.right</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                current.left</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æŒ‰ç…§è¦åˆ é™¤çš„èŠ‚ç‚¹å­èŠ‚ç‚¹æ•°ç›®çš„ä¸åŒï¼Œåˆ†ä¸º3ç§æƒ…å†µ</span></span><br><span class="line"><span class="comment">         * 1/3 è¦åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶èŠ‚ç‚¹ å°†å…¶çˆ¶èŠ‚ç‚¹çš„æŒ‡å‘è®¾ä¸ºnullå³å¯</span></span><br><span class="line"><span class="comment">         * 2/3 è¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸”åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ å°†å…¶çˆ¶èŠ‚ç‚¹æŒ‡å‘å…¶å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * 3/3 è¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ è¿™æ—¶å€™å¯ä»¥æ‰¾è¯¥å­èŠ‚ç‚¹çš„å³å­æ ‘ä¸­æœ€å°çš„ï¼ˆæˆ–è€…å·¦å­æ ‘ä¸­æœ€å¤§çš„ï¼‰èŠ‚ç‚¹å¹¶æ›¿æ¢æ‰è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line"><span class="comment">         *     ä¸æ­¤åŒæ—¶å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æœ‰å³å­èŠ‚ç‚¹ï¼ˆæˆ–å¯¹åº”çš„å·¦å­èŠ‚ç‚¹ï¼‰åˆ™æŒ‰ç…§2/3çš„è§„åˆ™å¤„ç†ï¼Œè¿™æ ·å°±èƒ½ä¿è¯è¿™ä¸ªæ ‘çš„ç»“æ„ä¸ä¼šå‡ºé”™</span></span><br><span class="line"><span class="comment">         *     ä¸‹é¢é‡‡ç”¨çš„æ˜¯æ‰¾è¯¥èŠ‚ç‚¹çš„å³å­æ ‘æœ€å°å€¼ï¼Œå³å³å­èŠ‚ç‚¹æˆ–è€…å³å­èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªå·¦å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         *     æ‰¾åˆ°åç”¨è¯¥å­èŠ‚ç‚¹çš„å€¼æ›¿æ¢æ‰è¦åˆ é™¤çš„èŠ‚ç‚¹å€¼ï¼Œå¦‚æœè¯¥å­èŠ‚ç‚¹è¿˜æœ‰å³å­èŠ‚ç‚¹ï¼Œå°†è¯¥å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡å‘å…¶å³å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (current.left != <span class="literal">null</span> &amp;&amp; current.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//åŒå­èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰ç‚¹å³å­èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸ºnull</span></span><br><span class="line">            <span class="keyword">if</span> (current.right!!.left == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current.iId &gt; parent.iId) &#123;</span><br><span class="line">                    parent.right = current.right</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    parent.left = current.right</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//TODO æ˜¯å¦éœ€è¦å°†å³èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æŒ‡å‘å½“å‰ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> cChildNode = current.right</span><br><span class="line">            <span class="keyword">var</span> cParentNode = current!!</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (cChildNode?.left != <span class="literal">null</span>) &#123;</span><br><span class="line">                cParentNode = cChildNode</span><br><span class="line">                cChildNode = cChildNode.left</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//åç»§èŠ‚ç‚¹</span></span><br><span class="line">            cParentNode.left = cChildNode!!.right</span><br><span class="line">            cChildNode!!.right = current.right</span><br><span class="line">            cChildNode!!.left = current.left</span><br><span class="line">            <span class="keyword">if</span> (current.iId &gt; parent.iId) &#123;</span><br><span class="line">                parent.right = cChildNode</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent.left = cChildNode</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current.left == <span class="literal">null</span> &amp;&amp; current.right == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¶å­èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (current.iId &gt; parent.iId) &#123;</span><br><span class="line">                parent.right = <span class="literal">null</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent.left = <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current.left == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (current.iId &gt; parent.iId) &#123;</span><br><span class="line">                parent.right = current.right</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent.left = current.right</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current.right == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (current.iId &gt; parent.iId) &#123;</span><br><span class="line">                parent.right = current.left</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent.left = current.left</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="å“ˆå¤«æ›¼ç¼–ç "><a href="#å“ˆå¤«æ›¼ç¼–ç " class="headerlink" title="å“ˆå¤«æ›¼ç¼–ç "></a>å“ˆå¤«æ›¼ç¼–ç </h1><p>å“ˆå¤«æ›¼ç¼–ç ç”¨æ¥å¯¹ä¸€æ®µæ–‡æœ¬è¿›è¡Œå‹ç¼©ï¼Œè§£å‹ã€‚</p><blockquote><p>å‹ç¼©ï¼šç”¨å­—ç¬¦çš„ç¼–ç æ›¿ä»£å­—ç¬¦</p><p>è§£å‹ï¼šç”¨å­—ç¬¦ä»£æ›¿å¯¹åº”çš„ç¼–ç </p></blockquote><p>å®ç°æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>å°†å­—ç¬¦æŒ‰ç…§å‡ºç°çš„é¢‘æ¬¡ç”Ÿæˆä¼˜å…ˆçº§é˜Ÿåˆ—ï¼›</li><li>ä¾æ¬¡<strong>å–å‡º</strong>ä¸¤ä¸ªæœ€å°çš„å­—ç¬¦ï¼Œä¸ºä»–ä»¬ç”Ÿæˆä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹é¢‘æ¬¡ä¸ºä¸¤ä¸ªå­èŠ‚ç‚¹ä¹‹å’Œï¼‰ï¼›</li><li>å¹¶å°†æ’å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡å¾ªç¯ç›´åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹â€”â€”å“ˆå¤«æ›¼æ ‘çš„æ ¹èŠ‚ç‚¹ï¼›</li><li>ä»å“ˆå¤«æ›¼æ ‘çš„æ ¹å¼€å§‹ï¼Œä»¥å‘å·¦ä¸º0ï¼Œå‘å³ä¸º1å¯¹å…¶å¶å­èŠ‚ç‚¹ä¸Šçš„å­—ç¬¦èµ‹äºˆç¼–ç ã€‚</li></ul><p>å…¶è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://jixiaoyong.github.io/images/20190103203447.png" alt="å“ˆå¤«æ›¼ç¼–ç ç¤ºæ„å›¾"></p><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/tree/BinaryTree.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹<code>äºŒå‰æ ‘</code>æºç </p><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/tree/HuffmanCodeUtils.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹<code>å“ˆå¤«æ›¼ç¼–ç </code>æºç </p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_é«˜çº§æ’åº</title>
      <link href="/blog/posts/2041f2cb/"/>
      <url>/blog/posts/2041f2cb/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡ä»‹ç»ä¸¤ç§é«˜çº§æ’åºï¼šå¸Œå°”æ’åºå’Œå¿«é€Ÿæ’åºã€‚</p><p>å¸Œå°”æ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯$O(N*(LogN)^2)$ï¼Œç®€å•æ˜“å®ç°ï¼Œåœ¨æ‰€æœ‰æ’åºä¸­å¯ä»¥ä¼˜å…ˆä½¿ç”¨ã€‚</p><p>å¿«é€Ÿæ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯$O(N*LogN)$ï¼Œæ˜¯æ‰€æœ‰é€šç”¨æ’åºä¸­æœ€å¿«çš„ã€‚</p><p>æ’åºæ–¹å‘ï¼š<code>å° â†’ å¤§</code>ã€‚</p><h1 id="å¸Œå°”æ’åº"><a href="#å¸Œå°”æ’åº" class="headerlink" title="å¸Œå°”æ’åº"></a>å¸Œå°”æ’åº</h1><p>å¸Œå°”æ’åºåŸºäºæ’å…¥æ’åºï¼ˆå°†å·¦è¾¹æ— é¡»çš„å…ƒç´ ä¾æ¬¡æ’å…¥åˆ°å³è¾¹æœ‰åºæ•°ç»„ä¸­ï¼‰ï¼Œä¸åŒçš„æ˜¯å¸Œå°”æ’åºçš„å¢é‡é€æ¸å‡å°åˆ°1ï¼Œè€Œæ’å…¥æ’åºçš„å¢é‡ä¸€ç›´æ˜¯1ã€‚</p><blockquote><p>å¢é‡ æ’åºçš„æ—¶å€™è¿›è¡Œæ¯”è¾ƒçš„ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„é—´éš”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>å¯¹äºæ•°ç»„<code>arr</code>ä¸­çš„å…ƒç´ æ¥è¯´ï¼Œ<code>1</code>å’Œ <code>2</code>ä¹‹é—´çš„å¢é‡æ˜¯1ï¼Œè€Œ <code>1</code>å’Œ <code>3</code>ä¹‹é—´çš„å¢é‡æ˜¯2ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></blockquote><p>ç”±äºæ’å…¥æ’åºåœ¨æ’åºè¿›è¡Œåˆ°åæœŸï¼Œå³è¾¹æœ‰åºæ•°ç»„çš„å¤§å°å˜å¤§ï¼Œå¯¼è‡´æ’å…¥å’Œç§»åŠ¨çš„æ¬¡æ•°è¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”å¦‚æœæ•°ç»„æ°å¥½æ˜¯ååºçš„ï¼Œä¼šå¾ˆè€—æ—¶ã€‚</p><p>è€Œå¸Œå°”æ’åºåœ¨åˆšå¼€å§‹æ’åºæ—¶ï¼Œå…ˆå–ä¸€ä¸ªé€‚å½“çš„å¢é‡<code>n</code>ï¼ŒæŒ‰ç…§è¿™ä¸ªå¢é‡å¯¹æ•°ç»„<code>arr</code>è¿›è¡Œæ’å…¥æ’åºï¼Œå¾—åˆ°ä¸€ä¸ª<em>åŸºæœ¬æœ‰åº</em>çš„æ•°ç»„ï¼Œä»–å†…éƒ¨æœ‰<code>n</code>ä¸ªæœ‰åºçš„å­æ•°ç»„ï¼›å†å°†å¢é‡<code>n</code>å‡ä¸€ï¼Œåœ¨æ­¤è¿›è¡Œæ’å…¥æ’åºï¼›å¦‚æ­¤åå¤ç›´åˆ°nä¸º1ï¼Œæ’åºå®Œæ¯•çš„æ•°æ®å³ä¸ºæœ‰åºæ•°ç»„ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20190103191850.png" alt="å¸Œå°”æ’åºâ€”â€”4å¢é‡æ’åºç¤ºæ„å›¾"></p><h2 id="å¢é‡çš„é€‰æ‹©"><a href="#å¢é‡çš„é€‰æ‹©" class="headerlink" title="å¢é‡çš„é€‰æ‹©"></a>å¢é‡çš„é€‰æ‹©</h2><p>å¯ä»¥æƒ³è±¡ï¼Œå¢é‡çš„è®¡ç®—å¯¹å¸Œå°”æ’åºæ•ˆç‡æœ‰å¾ˆå¤§å½±å“ã€‚</p><p>è¿™äº›å¢é‡çš„é›†åˆç§°ä¸º<strong>é—´éš”åºåˆ—</strong>ï¼Œä¸€èˆ¬è¦æ±‚è¿™äº›å¢é‡ä¹‹é—´äº’è´¨ï¼Œè¿™æ ·å°±ä¸ä¼šå¯¹å·²ç»æ’åºçš„æ•°ç»„å†æ¬¡æ’åºã€‚</p><p>ä¸€ä¸ªå¸¸ç”¨çš„é—´éš”åºåˆ—è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">h=<span class="number">3</span>h+<span class="number">1</span></span><br><span class="line">è®¡ç®—çš„hå€¼ä¸€èˆ¬ä¸ºï¼š<span class="number">1</span>,<span class="number">13</span>,<span class="number">40</span>,<span class="number">21</span>...</span><br></pre></td></tr></table></figure><p>å¢é‡<code>h</code>è¦å°äºæ•°ç»„å¤§å°ã€‚</p><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¸Œå°”æ’åº</span></span><br><span class="line"><span class="comment"> * æ€è·¯:</span></span><br><span class="line"><span class="comment"> * 1/3 å°†å¾…æ’åºæ•°ç»„åˆ†ä¸ºhä¸ªé—´éš”ä¸ºhçš„å°æ•°ç»„ï¼Œ</span></span><br><span class="line"><span class="comment"> * 2/3 å¯¹è¿™äº›å°æ•°ç»„è¿›è¡Œæ’å…¥æ’åº,å°†æ’åºç»“æœå†™å…¥åŸå¾…æ’åºæ•°ç»„</span></span><br><span class="line"><span class="comment"> * 3/3 æŒ‰ç…§ h=3*h+1 çš„ç®—æ³•å‡å°håœ¨æ­¤è¿›è¡Œå¸Œå°”æ’åºï¼Œç›´è‡³hä¸º1</span></span><br><span class="line"><span class="comment"> * --å°†å¤§æ•°ç»„åˆ†ä¸ºè¾ƒå°çš„æ•°ç»„ï¼Œæ‹å®Œåºåå†å¯¹è¿™äº›"æœ‰åº"çš„å°æ•°ç»„è¿›è¡Œæ’åº</span></span><br><span class="line"><span class="comment"> * å° - &gt; å¤§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">shellSort</span><span class="params">(intArray: <span class="type">IntArray</span>, h: <span class="type">Int</span>)</span></span>: IntArray &#123;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> insertSort(intArray)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//é—´éš”æ’åº</span></span><br><span class="line">        <span class="keyword">for</span> (x <span class="keyword">in</span> <span class="number">0</span> until h) &#123;<span class="comment">//ä¾æ¬¡éå†x,x+1,x+2 ... x+(h-1);å½¢æˆhä¸ªæœ‰åºå­æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> list = arrayListOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">            intArray.forEachIndexed &#123; index, i -&gt;</span><br><span class="line">                <span class="keyword">if</span> ((index + x) % h == <span class="number">0</span>) &#123;</span><br><span class="line">                    list.add(i)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> partSortArr = insertSort(list.toIntArray())</span><br><span class="line">            <span class="keyword">var</span> listIndex = <span class="number">0</span></span><br><span class="line">            intArray.forEachIndexed &#123; index, i -&gt;</span><br><span class="line">                <span class="keyword">if</span> ((index + x) % h == <span class="number">0</span>) &#123;</span><br><span class="line">                    intArray[index] = partSortArr[listIndex++]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†å¢é‡å‡å°ï¼Œå†æ¬¡å‡å°æ’åºï¼Œç›´åˆ°h==1</span></span><br><span class="line">        <span class="keyword">return</span> shellSort(intArray, (h - <span class="number">1</span>) / <span class="number">3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å¸Œå°”æ’åºé—´éš”</span></span><br><span class="line"><span class="comment"> * å¯¹æ’åºé€Ÿåº¦å½±å“è¾ƒå¤§ï¼Œè¦æ±‚äº’è´¨ï¼Œè®¡ç®—æ–¹å¼ä¸å”¯ä¸€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getShellSortH</span><span class="params">(range: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (range &lt; <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> h = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (h &lt; range) &#123;</span><br><span class="line">        h = <span class="number">3</span> * h + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (h - <span class="number">1</span>) / <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ’å…¥æ’åº</span></span><br><span class="line"><span class="comment"> * æ€è·¯ï¼š</span></span><br><span class="line"><span class="comment"> * 1/2 å…ˆå‡è®¾ç¬¬ä¸€ä¸ªæ•°æ˜¯å·²ç»æ’å¥½åºçš„</span></span><br><span class="line"><span class="comment"> * 2/2 å°†åé¢çš„æ•°å­—ä¾æ¬¡ä¸å…¶æ¯”è¾ƒï¼Œå¹¶æ’å…¥åˆ°å¯¹åº”ä½ç½®</span></span><br><span class="line"><span class="comment"> * small -&gt; big</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">insertSort</span><span class="params">(intArray: <span class="type">IntArray</span>)</span></span>: IntArray &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until intArray.size) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j <span class="keyword">in</span> <span class="number">0</span> until i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (intArray[i] &lt; intArray[j]) &#123;</span><br><span class="line">                <span class="keyword">val</span> temp = intArray[i]</span><br><span class="line">                <span class="keyword">for</span> (x <span class="keyword">in</span> i downTo j) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (x - <span class="number">1</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    intArray[x] = intArray[x - <span class="number">1</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                intArray[j] = temp</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> intArray</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h1><p>å¿«é€Ÿæ’åºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯æœ€å¿«çš„ã€‚</p><h2 id="åˆ’åˆ†"><a href="#åˆ’åˆ†" class="headerlink" title="åˆ’åˆ†"></a>åˆ’åˆ†</h2><p>åˆ’åˆ†æŒ‡åœ¨ä¸€ç»„æ•°æ®ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ªå€¼<code>C</code>,æ‰€æœ‰å°äº<code>C</code>çš„ç§»åŠ¨åˆ°å·¦è¾¹ï¼Œæ‰€æœ‰å¤§äº<code>C</code>çš„ç§»åŠ¨åˆ°å³è¾¹ã€‚</p><p>é€‰å‡ºæ¥çš„è¿™ä¸ªå€¼<code>C</code>ï¼Œå«åš<strong>æ¢çº½</strong>ã€‚</p><h3 id="åˆ’åˆ†ç®—æ³•"><a href="#åˆ’åˆ†ç®—æ³•" class="headerlink" title="åˆ’åˆ†ç®—æ³•"></a>åˆ’åˆ†ç®—æ³•</h3><ul><li>åœ¨æ•°æ®å·¦å³ä¸¤ç«¯å„æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å½“å‰å…ƒç´ ï¼š<code>left</code>ï¼Œ<code>right</code>ï¼›</li><li><code>left</code>æŒ‡é’ˆå‘å³ç§»åŠ¨æŸ¥æ‰¾æ¯”<code>C</code>å¤§çš„å€¼ï¼Œ<code>right</code>æŒ‡é’ˆå‘å·¦ç§»åŠ¨æŸ¥æ‰¾æ¯”<code>C</code>å°çš„å€¼ï¼Œå½“é‡åˆ°æ»¡è¶³æ¡ä»¶çš„å…ƒç´ åˆ™é€€å‡ºï¼›</li><li>å½“ä¸¤ä¸ªæŒ‡é’ˆéƒ½é€€å‡ºæ—¶ï¼Œå°†å…¶æŒ‡å‘çš„å…ƒç´ äº¤æ¢ä½ç½®ï¼Œç„¶åå†åˆ†åˆ«ç§»åŠ¨æŒ‡é’ˆï¼Œç›´åˆ°ä¸¤ä¸ªæŒ‡é’ˆç›¸é‡ï¼Œåˆ’åˆ†ç»“æŸã€‚</li></ul><h2 id="å¿«é€Ÿæ’åºçš„æ€è·¯"><a href="#å¿«é€Ÿæ’åºçš„æ€è·¯" class="headerlink" title="å¿«é€Ÿæ’åºçš„æ€è·¯"></a>å¿«é€Ÿæ’åºçš„æ€è·¯</h2><p>å¿«é€Ÿæ’åºï¼Œé€‰å–ä¸€ä¸ªæ¢çº½ï¼Œå°†æ•°ç»„<strong>åˆ’åˆ†</strong>ä¸ºä¸¤ä¸ªå­æ•°ç»„ï¼Œè¿™æ ·åœ¨æ¢çº½<code>C</code>ä¸¤è¾¹çš„æ•°ç»„æ»¡è¶³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[å·¦è¾¹å­æ•°ç»„æ‰€æœ‰å…ƒç´ ] &lt; n &lt; [å³è¾¹å­æ•°ç»„æ‰€æœ‰å…ƒç´ ]</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°†å¾—åˆ°çš„æ¯ä¸ªå­æ•°ç»„éƒ½åˆ’åˆ†ä¸ºä¸¤ä¸ªå­æ•°ç»„ï¼Œç›´åˆ°å­æ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ‰åºçš„ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªå¿«é€Ÿæ’åºã€‚</p><h2 id="æ¢çº½çš„é€‰æ‹©"><a href="#æ¢çº½çš„é€‰æ‹©" class="headerlink" title="æ¢çº½çš„é€‰æ‹©"></a>æ¢çº½çš„é€‰æ‹©</h2><p>æ¢çº½é€‰æ‹©å½±å“ç€å¿«é€Ÿæ’åºçš„æ•ˆç‡ï¼š</p><ul><li>æœ€ç®€å•çš„ï¼Œå¯ä»¥é€‰å–æ•°ç»„ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªå…ƒç´ </li><li>â€œä¸‰æ•°æ®é¡¹å–ä¸­â€æ³•ï¼Œåœ¨æ•°ç»„é¦–ã€å°¾ã€ä¸­å–æ•°æ’åºï¼Œé€‰ä¸­é—´çš„æ•°ä½œä¸ºæ¢çº½ã€‚è¿™æ ·æ’åºæ•°ç»„å¤§å°è¦&gt;3ã€‚</li></ul><h2 id="å…·ä½“å®ç°-1"><a href="#å…·ä½“å®ç°-1" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¿«é€Ÿæ’åºæ‰€ç”¨çš„æ•°ç»„ï¼Œä½¿ç”¨å‰å…ˆåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> quickArray: IntArray</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¿«é€Ÿæ’åºç®—æ³•</span></span><br><span class="line"><span class="comment"> * #1 é€‰æ‹©æ•°ç»„æœ€å³ç«¯å…ƒç´ ä½œä¸ºæ¢çº½</span></span><br><span class="line"><span class="comment"> * æ€æƒ³æ˜¯</span></span><br><span class="line"><span class="comment"> * 1/2 é€‰å‡ºä¸€ä¸ªæ¢çº½ï¼Œå…ˆå°†å…¶æŒ‰å¤§å°åˆ’åˆ†ä¸ºå·¦å³ä¸¤éƒ¨åˆ†</span></span><br><span class="line"><span class="comment"> * 2/2 åœ¨åˆ’åˆ†å¥½çš„ä¸¤ä¸ªæ•°ç»„ä¸­ï¼Œåˆ†åˆ«å†æ‰¾ä¸€ä¸ªæ¢çº½ï¼Œé‡å¤æ­¥éª¤1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">quickSort1</span><span class="params">(left: <span class="type">Int</span>, right: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (right - left &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * n è¿™ä¸ªæ¢çº½çš„å–æ³•å¾ˆå…³é”®ï¼Œå†³å®šäº†ç®—æ³•çš„é€Ÿåº¦</span></span><br><span class="line"><span class="comment">     * é™¤è¿‡è¿™é‡Œç”¨åˆ°çš„å–æ³•ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æœ‰"ä¸‰æ•°æ®é¡¹å–ä¸­"æ³•ï¼Œåœ¨æ•°ç»„é¦–ã€å°¾ã€ä¸­å–æ•°æ’åºï¼Œé€‰ä¸­é—´çš„æ•°ä½œä¸ºæ¢çº½ã€‚è¿™æ ·æ’åºæ•°ç»„è¦&gt;3</span></span><br><span class="line"><span class="comment">     * å¯¹äºè¿™äº›å°äº3çš„æ•°ç»„å¯ä»¥ç”¨æ’å…¥æ’åºæ³•è¿›è¡Œæ’åº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> n = quickArray[right]</span><br><span class="line">    <span class="keyword">val</span> nIndex = devideArrayByN1(left, right, n)</span><br><span class="line">    <span class="keyword">if</span> (nIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        quickSort1(left, nIndex - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    quickSort1(nIndex + <span class="number">1</span>, right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ’åˆ†ç®—æ³•å†³å®šäº†æ’åºçš„å‡†ç¡®æ€§</span></span><br><span class="line"><span class="comment"> * æå‡ºä¸€ä¸ªé˜ˆå€¼ï¼Œå¹¶ä»¥æ­¤å°†æ•°ç»„åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†</span></span><br><span class="line"><span class="comment"> * å·¦è¾¹éƒ½å°äºæ¢çº½ï¼Œå³è¾¹éƒ½å¤§äºæ¢çº½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">devideArrayByN1</span><span class="params">(left: <span class="type">Int</span>, right: <span class="type">Int</span>, n: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> leftIndex = left - <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> rightIndex = right</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (leftIndex &lt; rightIndex) &#123;</span><br><span class="line">        <span class="keyword">while</span> (leftIndex &lt; rightIndex &amp;&amp; quickArray[++leftIndex] &lt; n) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (leftIndex &lt; rightIndex &amp;&amp; quickArray[--rightIndex] &gt; n) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> temp = quickArray[leftIndex]</span><br><span class="line">        quickArray[leftIndex] = quickArray[rightIndex]</span><br><span class="line">        quickArray[rightIndex] = temp</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> right downTo rightIndex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        quickArray[i] = quickArray[i - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    quickArray[rightIndex] = n</span><br><span class="line">    <span class="keyword">return</span> rightIndex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¸Œå°”æ’åºã€å¿«é€Ÿæ’åºçš„æ€è·¯ï¼Œéƒ½æ˜¯å°†ä¸€ä¸ªå¤§çš„å¾…æ’åºæ•°ç»„ï¼Œé€šè¿‡ä¸åŒçš„æ–¹æ³•æ‹†åˆ†æˆå°çš„å­æ•°ç»„ï¼Œè¿™æ ·æ¯”è¾ƒã€ç§»åŠ¨çš„æ¬¡æ•°è¦å°å¾ˆå¤šã€‚</p><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/sort/SortUtils.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹æºç </p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_é€’å½’å’Œæ±‰è¯ºå¡”é—®é¢˜</title>
      <link href="/blog/posts/466fbe25/"/>
      <url>/blog/posts/466fbe25/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡ä»‹ç»äº†é€’å½’ï¼Œå½’å¹¶æ’åºï¼Œè¿˜æœ‰é€’å½’åœ¨æ±‰è¯ºå¡”é—®é¢˜ä¸Šçš„åº”ç”¨ã€‚</p><p>æ’åºé¡ºåºä¸º <code>å° â†’ å¤§</code></p><h1 id="é€’å½’"><a href="#é€’å½’" class="headerlink" title="é€’å½’"></a>é€’å½’</h1><p>é€’å½’æ˜¯ä¸€ç§åœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨è‡ªå·±çš„å‡½æ•°ã€‚åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶åå¯ä»¥é€€å‡ºé€’å½’ã€‚</p><p>æ¯”å¦‚ä¸‰è§’æ•°ç»„å°±æ˜¯ä¸€ä¸ªç®€å•çš„é€’å½’ï¼š</p><blockquote><p>æœ‰ä¸€ç»„æ•°æ®ï¼Œæ»¡è¶³è¿™æ ·çš„æ¡ä»¶<code>ç¬¬né¡¹</code> = <code>ç¬¬n-1é¡¹</code> + <code>n</code>ï¼Œå°±ç§°ä¸ºä¸‰è§’æ•°ç»„ï¼Œå¦‚ï¼š</p><p><code>1,2,6,10,15,21...</code></p></blockquote><p>è¿™é‡Œé¢ï¼Œ<strong><code>ç¬¬né¡¹</code> = <code>ç¬¬n-1é¡¹</code> + <code>n</code></strong>,å°±æ˜¯ä¸€ä¸ªé€’å½’ï¼Œæ¯ä¸€é¡¹çš„è®¡ç®—ç»“æ„éƒ½ä¾èµ–äºå‰ä¸€é¡¹çš„è®¡ç®—ï¼Œç›´åˆ°ç¬¬1é¡¹çš„è®¡ç®—ç»“æœä¸ºç¡®å®šçš„1ï¼Œä¸å†ç»§ç»­é€’å½’ã€‚</p><p>å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‰è§’æ•°</span></span><br><span class="line"><span class="comment"> * ç¬¬nä¸ªæ•° == ç¬¬n-1ä¸ªæ•° + n</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">triangleNum</span><span class="params">(num: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> num</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> num + triangleNum(num - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ±‰è¯ºå¡”é—®é¢˜"><a href="#æ±‰è¯ºå¡”é—®é¢˜" class="headerlink" title="æ±‰è¯ºå¡”é—®é¢˜"></a>æ±‰è¯ºå¡”é—®é¢˜</h1><p>æ±‰è¯ºå¡”æ˜¯ä¸€ç§æ¸¸æˆï¼Œæœ‰ä¸‰ä¸ªæŸ±å­ï¼Œå…¶ä¸­ä¸€æ£µæŸ±å­ä¸Šé¢æœ‰è‹¥å¹²ä¸ªåŠå¾„ä¾æ¬¡é€’å‡çš„ç©ºå¿ƒåœ†ç›˜ï¼Œæ¯æ¬¡åªèƒ½ç§»åŠ¨æœ€é¡¶ç«¯çš„åœ†ç›˜ï¼Œå¹¶ä¸”ä¸‹é¢çš„åœ†ç›˜è¦æ¯”ä¸Šé¢çš„åœ†ç›˜ç›´å¾„å¤§ã€‚æ¸¸æˆçš„ç›®çš„å°±æ˜¯åœ¨æ»¡è¶³è¿™äº›æ¡ä»¶çš„å‰æä¸‹ï¼Œå°†æ‰€æœ‰åœ†ç›˜ä¾æ¬¡è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªåœ†ç›˜ä¸Šé¢ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20190102201005.png" alt="æ±‰è¯ºå¡”é—®é¢˜åˆ†æ"></p><p>å¦‚å›¾ï¼Œå®ç°çš„æ€è·¯å°±æ˜¯é€’å½’ï¼š</p><ol><li><p>å°†é™¤æœ€åº•éƒ¨çš„åœ†ç›˜<code>bottom</code>ä¹‹å¤–çš„æ‰€æœ‰åœ†ç›˜å½“åšä¸€ä¸ªæ•´ä½“<code>other</code>ï¼Œé‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†å¦‚ä½•å°†<code>bottom</code>å’Œ<code>other</code>è¿™â€œä¸¤â€ä¸ªåœ†ç›˜é€šè¿‡<code>æŸ±å­B</code>ï¼Œç§»åŠ¨åˆ°<code>æŸ±å­C</code>ï¼Œè¿™ä¸ªé—®é¢˜æ˜¾ç„¶å¾ˆå¥½è§£å†³ï¼Œåªéœ€è¦å°†<code>other</code>ç§»åŠ¨åˆ°<code>æŸ±å­B</code>ï¼Œå†å°†<code>bottom</code>ç§»åŠ¨åˆ°<code>æŸ±å­C</code>å³å¯ã€‚</p></li><li><p>é‚£ä¹ˆå‰©ä¸‹çš„é—®é¢˜å°±æˆäº†å¦‚ä½•å°†<code>other</code>ä»<code>æŸ±å­A</code>ç§»åŠ¨åˆ°<code>æŸ±å­B</code>ï¼Œå¾ˆæ˜¾ç„¶å¯ä»¥å‚ç…§<code>æ­¥éª¤1</code>ã€‚</p></li><li>è¿™æ ·å­è¿™ä¸ªé—®é¢˜å°±æˆäº†å¦‚ä½•å°†ä¸€ä¸ª<code>bottom</code>ä»ä¸€ä¸ªæŸ±å­ï¼Œç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªæŸ±å­çš„é—®é¢˜ï¼Œè€Œæ¯ä¸ªè¿™æ ·çš„é—®é¢˜çš„è§£å†³éƒ½ä¾èµ–äº<code>other</code>çš„è§£å†³ï¼Œè€Œè¿™å°±æ˜¯é€’å½’ã€‚</li></ol><p>å…·ä½“å®ç°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ±‰è¯ºå¡”é—®é¢˜</span></span><br><span class="line"><span class="comment"> * å°†æ±‰è¯ºå¡”é—®é¢˜ç®€åŒ–ä¸º3æ­¥ï¼š</span></span><br><span class="line"><span class="comment"> * 1/3 å°†æœ€ä¸Šå±‚n-1é¡¹ç§»åŠ¨åˆ°è¿‡æ¸¡å±‚</span></span><br><span class="line"><span class="comment"> * 2/3 å°†æœ€åº•å±‚nç§»åŠ¨åˆ°ç›®æ ‡å±‚</span></span><br><span class="line"><span class="comment"> * 3/3 å°†n-1é¡¹ç§»åŠ¨åˆ°ç›®æ ‡å±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> num è¦ç§»åŠ¨çš„å±‚æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> from æ‰€åœ¨å±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inter è¿‡æ¸¡å±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> to ç›®æ ‡å±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> hanioStepNum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">hanioTower</span><span class="params">(num: <span class="type">Int</span>, from: <span class="type">String</span>, inter: <span class="type">String</span>, to: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">1</span>) &#123;</span><br><span class="line">        println(<span class="string">"move 1 to <span class="variable">$to</span>"</span>)</span><br><span class="line">        hanioStepNum++</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hanioTower(num - <span class="number">1</span>, from, to, inter)<span class="comment">//æŠŠ`other`ç§»åŠ¨åˆ°ä¸­é—´æŸ±å­</span></span><br><span class="line">        println(<span class="string">"move <span class="variable">$num</span> to <span class="variable">$to</span>"</span>)<span class="comment">//æŠŠ`bottom`ç§»åŠ¨åˆ°ç›®æ ‡æŸ±å­</span></span><br><span class="line">        hanioStepNum++</span><br><span class="line">        hanioTower(num - <span class="number">1</span>, inter, from, to)<span class="comment">//æŠŠ`other`ç§»åŠ¨åˆ°ç›®æ ‡æŸ±å­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å½’å¹¶æ’åº"><a href="#å½’å¹¶æ’åº" class="headerlink" title="å½’å¹¶æ’åº"></a>å½’å¹¶æ’åº</h1><p>å½’å¹¶æ’åº<code>merge</code>ï¼Œå°†ä¸€ä¸ªæ•°ç»„ï¼Œåˆ†æˆä¸¤ä¸ªå­æ•°ç»„åˆ†åˆ«æ’åºï¼Œä¹‹åå†å°†æ‹å¥½åºçš„æ•°ç»„åˆå¹¶ï¼Œè¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªæœ‰åºæ•°ç»„ã€‚æ—¶é—´å¤æ‚åº¦æ˜¯$O(N*Log(N))$ã€‚</p><p>å…¶æ€è·¯æ˜¯ï¼Œå°†æ•°ç»„æ— é™çš„åˆ†æˆä¸¤ä»½åˆ†åˆ«è¿›è¡Œæ’åºï¼Œç„¶åå†å°†æ’å¥½åºçš„ä¸¤ä¸ªæ•°ç»„å½’å¹¶åœ¨ä¸€èµ·å¾—åˆ°æœ‰åºæ•°ç»„ã€‚æ¯ä¸ªå­æ•°ç»„çš„æœ‰åºéƒ½ä¾èµ–äºå…¶å­æ•°ç»„çš„æœ‰åºï¼Œç›´åˆ°æ¯ä¸ªå­æ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ ·çš„æ•°ç»„æœ¬èº«å°±æ˜¯æœ‰åºçš„ã€‚</p><p>åŸç†å¦‚ä¸‹ï¼ˆå‡è®¾åºåˆ—å…±æœ‰nä¸ªå…ƒç´ ï¼‰ï¼š</p><ol><li>å°†åºåˆ—æ¯ç›¸é‚»ä¸¤ä¸ªæ•°å­—è¿›è¡Œ<strong>å½’å¹¶æ“ä½œ</strong>ï¼Œå½¢æˆä¸¤ä¸ª<code>n/2</code>åºåˆ—ï¼Œæ’åºåæ¯ä¸ªåºåˆ—åŒ…å«1/2å…ƒç´ </li><li>è‹¥æ­¤æ—¶åºåˆ—æ•°ä¸æ˜¯1ä¸ªï¼Œåˆ™å°†ä¸Šè¿°åºåˆ—å†æ¬¡å½’å¹¶ï¼Œåˆ†åˆ«å½¢æˆä¸¤ä¸ª<code>n/4</code>åºåˆ—ï¼Œæ¯ä¸ªåºåˆ—åŒ…å«1/4ä¸ªå…ƒç´ </li><li>é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ æ’åºå®Œæ¯•ï¼Œå³åºåˆ—æ•°ä¸º1</li></ol><p><img src="https://zh.wikipedia.org/wiki/File:Merge-sort-example-300px.gif" alt="å½’å¹¶æ’åºåŠ¨æ€æ¼”ç¤º"></p><p><strong>åˆå¹¶ä¸¤ä¸ªæœ‰åºçš„æ•°ç»„(<code>a</code>,<code>b</code>)æ€æƒ³</strong>ï¼š</p><p>å°†<code>b</code>ä¸­æ¯”<code>a</code>ä¸­å°çš„å…ƒç´ éƒ½å¤åˆ¶åˆ°<code>a</code>ä¸­å¯¹åº”ä½ç½®ï¼Œç„¶åå°†å‰©ä¸‹çš„å…ƒç´ å…¨éƒ¨ä¾æ¬¡å¤åˆ¶åˆ°<code>a</code>çš„æœ«å°¾ã€‚</p><p>å½’å¹¶æ’åºå…·ä½“å®ç°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½’å¹¶æ’åº</span></span><br><span class="line"><span class="comment"> * å½’å¹¶æ’åºå ç©ºé—´ï¼ˆå¤šå ä¸€ä¸ªæ’åºæ•°ç»„çš„å¤§å°ï¼‰ï¼Œæ’åºå¿«ï¼ˆN*LogNï¼‰</span></span><br><span class="line"><span class="comment"> * æ€æƒ³æ˜¯:</span></span><br><span class="line"><span class="comment"> * 1/2 å°†æ•°ç»„æ— é™åˆ†æˆä¸¤ä»½ï¼Œç›´åˆ°ä¸¤ä»½æ•°ç»„éƒ½æ˜¯æœ‰åºçš„ï¼ˆæ¯ä¸ªæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰</span></span><br><span class="line"><span class="comment"> * 2/2 å†å¯¹å…¶è¿›è¡Œå½’å¹¶</span></span><br><span class="line"><span class="comment"> * å° -&gt; å¤§</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intArr å¾…æ’åºçš„æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">mergeSort</span><span class="params">(intArr: <span class="type">IntArray</span>)</span></span>: IntArray &#123;</span><br><span class="line">    <span class="keyword">var</span> size = intArr.size</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> intArr</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> half = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (size % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            half = size / <span class="number">2</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            half = (size + <span class="number">1</span>) / <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> arr1 = intArr.copyOfRange(<span class="number">0</span>, half)</span><br><span class="line">        <span class="keyword">val</span> arr2 = intArr.copyOfRange(half, intArr.size)</span><br><span class="line">        <span class="keyword">return</span> merge(mergeSort(arr1), mergeSort(arr2))<span class="comment">//å°†åˆå¹¶å¥½çš„ä¸¤ä¸ªæœ‰åºå­æ•°ç»„åˆå¹¶</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½’å¹¶</span></span><br><span class="line"><span class="comment"> * åˆå¹¶ä¸¤ä¸ªæœ‰åºçš„æ•°ç»„ä¸ºæ–°çš„æœ‰åºæ•°ç»„</span></span><br><span class="line"><span class="comment"> * æ€æƒ³ï¼š</span></span><br><span class="line"><span class="comment"> * 1/2 ç›¸äº’æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„æ¯é¡¹å¤§å°ï¼Œå¹¶å°†å°çš„å¤åˆ¶åˆ°æ–°æ•°ç»„</span></span><br><span class="line"><span class="comment"> * 2/2 å°†å‰©ä½™çš„æ•°ç»„å…¨éƒ¨å¤åˆ¶åˆ°æ–°æ•°ç»„</span></span><br><span class="line"><span class="comment"> * å° -&gt; å¤§</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intArrA æœ‰åºæ•°ç»„1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intArrB æœ‰åºæ•°ç»„2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">merge</span><span class="params">(intArrA: <span class="type">IntArray</span>, intArrB: <span class="type">IntArray</span>)</span></span>: IntArray &#123;</span><br><span class="line">    <span class="keyword">var</span> resultArr = IntArray(intArrA.size + intArrB.size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> indexA = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> indexB = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> indexC = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (indexA &lt; intArrA.size &amp;&amp; indexB &lt; intArrB.size) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intArrA[indexA] &lt; intArrB[indexB]) &#123;</span><br><span class="line">            resultArr[indexC++] = intArrA[indexA++]</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultArr[indexC++] = intArrB[indexB++]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (indexA &lt; intArrA.size) &#123;</span><br><span class="line">        resultArr[indexC++] = intArrA[indexA++]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (indexB &lt; intArrB.size) &#123;</span><br><span class="line">        resultArr[indexC++] = intArrB[indexB++]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultArr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p>ğŸ‘‰<a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/link/Triangle.kt" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹<code>æ±‰è¯ºå¡”</code>å’Œ<code>é€’å½’æ’åº</code>æºç </p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://zh.wikipedia.org/wiki/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener">å½’å¹¶æ’åºâ€”â€”ç»´åŸºç™¾ç§‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_æ ˆå’Œé˜Ÿåˆ—</title>
      <link href="/blog/posts/8d059318/"/>
      <url>/blog/posts/8d059318/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡ä»‹ç»æ ˆã€é˜Ÿåˆ—ä¸¤ç§æŠ½è±¡æ•°æ®ç±»å‹ã€‚</p><h1 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h1><p>æ ˆ<code>stack</code>ï¼Œåˆç§°å †æ ˆï¼Œæ˜¯ä¸€ç§æŠ½è±¡æ•°æ®ç±»å‹ï¼Œæ¯æ¬¡åªèƒ½è®¿é—®æ ˆé¡¶å…ƒç´ <code>top</code>ï¼Œå¯ä»¥è¿›è¡Œå‹å…¥<code>push</code>å’Œæ¨å‡º<code>pop</code>æ“ä½œã€‚å…¶å…ƒç´ <strong>å…ˆè¿›åå‡º(FILO)</strong>ã€‚</p><h1 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h1><p>é˜Ÿåˆ—<code>queue</code>,æ˜¯å’Œæ ˆç›¸å¯¹çš„ä¸€ç§æŠ½è±¡æ•°æ®ç±»å‹ï¼Œæ¯æ¬¡ä»åç«¯<code>rear</code>æ’å…¥ï¼Œä»å‰ç«¯<code>front</code>åˆ é™¤ã€‚å…¶å…ƒç´ <strong>å…ˆè¿›å…ˆå‡º(FIFO)</strong>ã€‚</p><p>ç”¨é“¾è¡¨å®ç°çš„é˜Ÿåˆ—å¯ä»¥è‡ªç”±æ‰©å……ï¼Œä¸å­˜åœ¨ä¼ªæº¢å‡ºé—®é¢˜ï¼Œä½†æ˜¯æ’å…¥å’Œè¯»å–æ¯”è¾ƒè€—æ—¶ï¼›</p><p>ç”¨æ•°ç»„å®ç°çš„é˜Ÿåˆ—å¤§å°å›ºå®šï¼Œå¯ä»¥ä½¿ç”¨<strong>å¾ªç¯é˜Ÿåˆ—</strong>è§£å†³ä¼ªæº¢å‡ºé—®é¢˜ï¼Œå³å½“å°¾ç«¯ï¼ˆå‰ç«¯ä¹Ÿç±»ä¼¼ï¼‰æŒ‡é’ˆæŒ‡å‘è¶…å‡ºæ•°ç»„å¤§å°æ—¶ï¼Œå¯ä»¥æŒ‡å‘æ•°ç»„å¼€å§‹ä½ç½®ï¼Œå› ä¸ºæ­¤æ—¶å¤§å°ä¸è¶…è¿‡æ•°ç»„çš„é˜Ÿåˆ—å‰ç«¯å·²ç»æŒ‡å‘0ä¹‹åçš„ä½ç½®äº†ï¼Œæ‰€ä»¥ä¸ä¼šå†²çªã€‚</p><h2 id="ä¼˜å…ˆçº§é˜Ÿåˆ—"><a href="#ä¼˜å…ˆçº§é˜Ÿåˆ—" class="headerlink" title="ä¼˜å…ˆçº§é˜Ÿåˆ—"></a>ä¼˜å…ˆçº§é˜Ÿåˆ—</h2><p>å’Œé˜Ÿåˆ—å®šä¹‰ä¸€è‡´ï¼Œåªæ˜¯åœ¨æ¯æ¬¡æ’å…¥çš„æ—¶å€™éƒ½è¿›è¡Œæ’åºï¼Œä»¥æ»¡è¶³æ’åºè§„åˆ™ï¼ˆå¦‚<code>å°¾ç«¯â†’å‰ç«¯</code> <code>å°â†’å¤§</code>ï¼‰ã€‚</p><h1 id="ä¸­ç¼€è¡¨è¾¾å¼ä¸åç¼€è¡¨è¾¾å¼"><a href="#ä¸­ç¼€è¡¨è¾¾å¼ä¸åç¼€è¡¨è¾¾å¼" class="headerlink" title="ä¸­ç¼€è¡¨è¾¾å¼ä¸åç¼€è¡¨è¾¾å¼"></a>ä¸­ç¼€è¡¨è¾¾å¼ä¸åç¼€è¡¨è¾¾å¼</h1><p>ä¸­ç¼€è¡¨è¾¾å¼ï¼ŒæŒ‡è¿ç®—ç¬¦åœ¨æ“ä½œæ•°ä¸­é—´çš„ï¼Œå¦‚<code>1 + 2</code>ã€‚</p><p>åç¼€è¡¨è¾¾å¼ï¼ŒæŒ‡è¿ç®—ç¬¦åœ¨æ“ä½œæ•°åé¢çš„ï¼Œå¦‚<code>1 2 +</code>ã€‚</p><p>ä¸­ç¼€è¡¨è¾¾å¼ â†” åç¼€è¡¨è¾¾å¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸­ç¼€è¡¨è¾¾å¼ï¼š<span class="number">1</span> + <span class="number">2</span> * ( <span class="number">3</span> + <span class="number">5</span> ) - <span class="number">2</span> * <span class="number">3</span> - <span class="number">9</span> / <span class="number">2</span></span><br><span class="line">åç¼€è¡¨è¾¾å¼ï¼š<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">5</span> + * + <span class="number">2</span> <span class="number">3</span> * - <span class="number">9</span> <span class="number">2</span> / -</span><br></pre></td></tr></table></figure><p>è½¬æ¢è§„åˆ™ï¼š</p><p>è®¾ä¸€ä¸ªæ ˆç”¨äºä¿å­˜è¿ç®—ç¬¦ï¼Œä»å·¦åˆ°å³ä¾æ¬¡éå†ä¸­ç¼€è¡¨è¾¾å¼ï¼Œå‡è®¾è¯»å–åˆ°çš„æ˜¯<code>x</code></p><ol><li><p>å¦‚æœæ˜¯æ“ä½œæ•°ï¼Œåˆ™ç›´æ¥æ‰“å°</p></li><li><p>å¦‚æœæ˜¯è¿ç®—ç¬¦<code>(</code>ï¼Œåˆ™å‹å…¥æ ˆä¸­</p></li><li><p>å¦‚æœæ˜¯è¿ç®—ç¬¦<code>)</code>ï¼Œåˆ™æ¨å‡ºæ ˆä¸­çš„å…ƒç´ ï¼Œç›´åˆ°é‡åˆ°<code>(</code>,æ¨å‡º<code>(</code>ï¼Œç»§ç»­è¯»å–ä¸‹ä¸€ä¸ª</p></li><li><p>å¦åˆ™ï¼Œè¯»å–æ ˆé¡¶å…ƒç´ <code>top</code>ï¼Œå¦‚æœæ˜¯<code>(</code>ï¼Œå°†<code>x</code>å‹å…¥æ ˆä¸­ï¼›</p><p>å¦‚æœ<code>x</code>ä¼˜å…ˆäº<code>top</code>ï¼Œå°†<code>x</code>å‹å…¥æ ˆä¸­ï¼›</p><p>å¦åˆ™ï¼Œå°†<code>top</code>æ¨å‡ºï¼Œåœ¨æ­¤å’Œæ–°çš„<code>top</code>æ¯”è¾ƒï¼Œç›´åˆ°é‡åˆ°<code>top</code>æ˜¯<code>(</code>æˆ–è€…ä¼˜å…ˆçº§æ¯”<code>x</code>é«˜ï¼Œæˆ–è€…æ ˆå·²ç»ç©ºäº†ï¼Œå°†<code>x</code>æ’å…¥æ ˆä¸­ã€‚</p></li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸­ç¼€è¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> infix ä¸­ç¼€è¡¨è¾¾å¼ 1+2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åç¼€è¡¨è¾¾å¼ 1 2 +</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> static String[] covertInfixToPostfix(String <span class="keyword">infix</span>) &#123;</span><br><span class="line">    StringBuilder stringBuilder = new StringBuilder();</span><br><span class="line">    OperatorStack operatorStack = new OperatorStack();</span><br><span class="line">    <span class="keyword">for</span> (char item : <span class="keyword">infix</span>.toCharArray()) &#123;</span><br><span class="line">        <span class="comment">// æ•°å­—</span></span><br><span class="line">        <span class="keyword">if</span> (item &gt;= <span class="string">'0'</span> &amp;&amp; item &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">            stringBuilder.append(item + <span class="string">","</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item == <span class="string">'('</span>) &#123;</span><br><span class="line">            operatorStack.insert(item);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item == <span class="string">')'</span>) &#123;</span><br><span class="line">            int size = operatorStack.size();</span><br><span class="line">            <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    char pop = operatorStack.pop();</span><br><span class="line">                    <span class="keyword">if</span> (pop == <span class="string">'('</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        stringBuilder.append(pop + <span class="string">","</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.<span class="keyword">out</span>.println(<span class="string">"æ ˆä¸ºç©º"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                char peek = operatorStack.peek();</span><br><span class="line">                <span class="keyword">if</span> (peek == <span class="string">'('</span>) &#123;</span><br><span class="line">                    operatorStack.insert(item);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPre(item, peek) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    operatorStack.insert(item);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    int size = operatorStack.size();</span><br><span class="line">                    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            char pop = operatorStack.peek();</span><br><span class="line">                            <span class="keyword">if</span> (pop == <span class="string">'('</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPre(item, peek) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                stringBuilder.append(pop + <span class="string">","</span>);</span><br><span class="line">                                operatorStack.pop();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    operatorStack.insert(item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.err.println(<span class="string">"æ ˆä¸ºç©º"</span>);</span><br><span class="line">                operatorStack.insert(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int size = operatorStack.size();</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stringBuilder.append(operatorStack.pop() + <span class="string">","</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">"æ ˆä¸ºç©º"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String result = stringBuilder.toString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.split(<span class="string">","</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p>ğŸ‘‰<a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/InfixAndPostfix/CovertInfixToPostfix.java" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a>æŸ¥çœ‹<code>ä¸­ç¼€è¡¨è¾¾å¼ â†’ åç¼€è¡¨è¾¾å¼</code>æºç </p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://zh.wikipedia.org/wiki/%E5%A0%86%E6%A0%88" target="_blank" rel="noopener">å †æ ˆâ€”â€”ç»´åŸºç™¾ç§‘</a></p><p><a href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%88%97" target="_blank" rel="noopener">é˜Ÿåˆ—â€”â€”ç»´åŸºç™¾ç§‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_æ•°ç»„ï¼Œé“¾è¡¨</title>
      <link href="/blog/posts/9a784fe0/"/>
      <url>/blog/posts/9a784fe0/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡ä»‹ç»äº†æ•°ç»„ã€é“¾è¡¨ç­‰æ•°æ®ç»“æ„ã€‚</p><p>è®¾å®šæ‰€æœ‰æ’åºï¼šå°â†’å¤§ã€‚</p><h1 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h1><p>æ•°ç»„ï¼ˆarrayï¼‰æ˜¯ä¸€ç»„å…·æœ‰ç›¸åŒç±»å‹å…ƒç´ çš„é›†åˆï¼Œç”¨ä¸€æ®µè¿ç»­çš„å†…å­˜æ¥ä¿å­˜ã€‚ä½¿ç”¨ä¸‹æ ‡æ¥è®¿é—®ä¿å­˜çš„å…ƒç´ ï¼Œå¦‚<code>a[0]</code>ã€‚</p><p>æ•°ç»„æ˜¯ä¸€ç§æ•°æ®å­˜å‚¨ç»“æ„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><p>æ•°ç»„å¤§å°å›ºå®šï¼Œå¯¹æŒ‡å®šä¸‹æ ‡å…ƒç´ è¯»å†™å¿«O(1)ï¼Œä½†æ˜¯æŸ¥æ‰¾æ…¢O(N)ï¼Œåˆ é™¤å…ƒç´ æ…¢O(N)ã€‚</p><h2 id="æœ‰åºæ•°ç»„"><a href="#æœ‰åºæ•°ç»„" class="headerlink" title="æœ‰åºæ•°ç»„"></a>æœ‰åºæ•°ç»„</h2><p>åœ¨æ¯æ¬¡æ’å…¥çš„æ—¶å€™å¯¹å…ƒç´ è¿›è¡Œæ’åºï¼Œå°±å¾—åˆ°æœ‰åºæ•°ç»„ã€‚</p><p>æœ‰åºæ•°ç»„æŸ¥æ‰¾å¿«O(LogN)ï¼Œä½†æ’å…¥æ…¢O(N)ï¼Œåˆ é™¤å…ƒç´ æ…¢O(N)ã€‚</p><p><strong>æœ‰åºæ•°ç»„æ’å…¥</strong>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">insertSort</span><span class="params">(key: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (size &gt;= sortArr.size) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        sortArr[size++] = key</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> insertIndex = ++size - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (key &lt; sortArr[insertIndex - <span class="number">1</span>]) &#123;</span><br><span class="line">        sortArr[insertIndex] = sortArr[insertIndex - <span class="number">1</span>]</span><br><span class="line">        insertIndex--</span><br><span class="line">        <span class="keyword">if</span> (insertIndex == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortArr[insertIndex] = key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æœ‰åºæ•°ç»„è¦æ‰¾åˆ°æŸä¸ªå…ƒç´ tå¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œå…¶æ€æƒ³æ˜¯ï¼š</p><ol><li>é€‰å–ä¸€ä¸ªä¸­é—´å€¼nå°†å½“å‰æ•°ç»„ä¸€åˆ†ä¸ºäºŒã€‚</li><li>å¦‚æœ<code>t==n</code>é‚£ä¹ˆæŸ¥æ‰¾ç»“æŸï¼Œå¦‚æœ<code>t&lt;n</code>,é‚£ä¹ˆåœ¨å³åŠéƒ¨åˆ†æ•°ç»„æŸ¥æ‰¾ï¼Œå¦åˆ™åœ¨å·¦åŠéƒ¨åˆ†æ•°ç»„æŸ¥æ‰¾ã€‚</li><li>é‡å¤æ­¥éª¤<code>1</code>,<code>2</code>ï¼Œç›´åˆ°æ‰¾åˆ°næˆ–è€…æ•°ç»„å·²ç»ä¸å¯å†åˆ†ï¼ˆä¸å­˜åœ¨nï¼‰ï¼Œç»“æŸæŸ¥æ‰¾ã€‚</li></ol><p><strong>äºŒåˆ†æ³•æŸ¥æ‰¾</strong>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">dichotomy</span><span class="params">(array: <span class="type">IntArray</span>, key: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (array.size &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> centerIndex = array.size / <span class="number">2</span></span><br><span class="line">    <span class="keyword">var</span> centerKey = array[centerIndex]</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">        key == centerKey -&gt; centerIndex</span><br><span class="line">        key &lt; centerKey -&gt; dichotomy(array.copyOfRange(<span class="number">0</span>, centerIndex), key)</span><br><span class="line">        <span class="keyword">else</span> -&gt; dichotomy(array.copyOfRange(centerIndex - <span class="number">1</span>, array.size), key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h1><p>é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹é™¤äº†ä¿å­˜çš„æ•°æ®å¤–ï¼Œè¿˜ä¿å­˜ç€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨<code>next</code>ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸­è¯¥å¼•ç”¨ä¸º<code>null</code>ã€‚</p><p>é“¾è¡¨çš„å¤§å°ä¸å›ºå®šï¼ŒæŸ¥æ‰¾ï¼Œåˆ é™¤ï¼Œæ’å…¥æŒ‡å®šèŠ‚ç‚¹éƒ½éœ€è¦O(N)</p><p>é“¾è¡¨æœ‰ä»¥ä¸‹åˆ†ç±»ï¼š</p><ul><li><p>å•é“¾è¡¨ æ¯ä¸ªèŠ‚ç‚¹åªæœ‰æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œé“¾è¡¨åªä¿ç•™ç¬¬ä¸€ä¸ªé“¾èŠ‚ç‚¹çš„å¼•ç”¨<code>first</code></p><p><img src="https://jixiaoyong.github.io/images/20190101132535.png" alt="å•é“¾è¡¨"></p></li><li><p>åŒå‘é“¾è¡¨ æ¯ä¸ªèŠ‚ç‚¹ä¿å­˜æœ‰çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹çš„å¼•ç”¨ã€‚åŒå‘é“¾è¡¨ä¹Ÿå¯ä»¥æ˜¯åŒç«¯é“¾è¡¨ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20190101132614.png" alt="åŒå‘é“¾è¡¨"></p></li></ul><p><strong>åŒç«¯é“¾è¡¨</strong> åŒç«¯é“¾è¡¨ä¿å­˜ç¬¬ä¸€ä¸ªé“¾èŠ‚ç‚¹<code>farst</code>å’Œæœ€åä¸€ä¸ªé“¾èŠ‚ç‚¹<code>last</code>çš„å¼•ç”¨ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20190101132649.png" alt="åŒç«¯é“¾è¡¨"></p><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/tree/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/link" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹<code>é“¾è¡¨</code>æºç </p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E7%BB%84" target="_blank" rel="noopener">æ•°ç»„â€“ç»´åŸºç™¾ç§‘</a></p><p><a href="https://book.douban.com/subject/1144007/" target="_blank" rel="noopener">Javaæ•°æ®ç»“æ„å’Œç®—æ³•ï¼ˆç¬¬äºŒç‰ˆï¼‰Robert Laforce è®¡æ™“äº‘ç­‰è¯‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_ç®€å•æ’åº</title>
      <link href="/blog/posts/125c8a12/"/>
      <url>/blog/posts/125c8a12/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€å•æ’åº"><a href="#ç®€å•æ’åº" class="headerlink" title="ç®€å•æ’åº"></a>ç®€å•æ’åº</h1><p>æ‰€æœ‰æ’åºé¡ºåºä¸º <code>å° â†’ å¤§</code>ã€‚</p><p>æ—¶é—´è´Ÿè´£åº¦éƒ½æ˜¯O(N^2^)ã€‚</p><p>æ’åºé€Ÿåº¦ï¼š<code>æ’å…¥æ’åº&gt;é€‰æ‹©æ’åº&gt;å†’æ³¡æ’åº</code></p><h2 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h2><p>æ—¶é—´å¤æ‚åº¦ï¼šO(N^2^) </p><p>æœ€æ…¢çš„æ’åºï¼Œä½†æ˜¯ç®€å•</p><p>è§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>ä»å·¦åˆ°å³ï¼Œæ¯”è¾ƒaå’Œbï¼Œå¦‚æœ<code>a&gt;b</code>ï¼Œå°±äº¤æ¢aå’Œbçš„ä½ç½®</li><li>å†å°†aï¼Œbä¸­è¾ƒå¤§çš„é‚£ä¸ªä¸cæŒ‰ç…§2çš„è§„åˆ™æ¯”è¾ƒï¼Œç›´åˆ°æœ€åä¸€ä½</li><li>é‡å¤1ï¼Œ2ç›´åˆ°æ²¡æœ‰å¾…æ’åºçš„é¡¹ç›®</li></ol><p>å…¶æ€æƒ³æ˜¯ï¼šæ¯æ¬¡é€‰å‡ºå½“å‰æœªæ’åºçš„å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ å¹¶æ”¾åˆ°é˜Ÿå°¾ï¼ˆæ¯æ¬¡æ¯”è¾ƒæœ€å¤§å…ƒç´ éƒ½ä¼šâ€œå†’æ³¡â€åˆ°é˜Ÿå°¾ï¼‰ï¼Œè¿™æ ·å½“è¿ç»­éå†næ¬¡åï¼Œæ¯ä¸ªå…ƒç´ éƒ½ä¼šæ’å¥½åºã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†’æ³¡æ’åº</span></span><br><span class="line"><span class="comment">     * 1. æ¯æ¬¡æ¯”è¾ƒå‰1~ï¼ˆn-iï¼‰ä¸ªå…ƒç´ ï¼ˆiæ˜¯æ’åºæ¬¡æ•°ï¼‰ï¼Œæ¯æ¬¡æœ‰å¤§çš„å°±ã€ç§»åŠ¨ã€‘ï¼Œ</span></span><br><span class="line"><span class="comment">     * è¿™æ ·å­ä¸€è½®æ¯”èµ›å®Œæ¯•æœ€å¤§çš„å°±åœ¨åé¢äº†</span></span><br><span class="line"><span class="comment">     * 2. è¿™æ ·å­æ¯”è¾ƒnæ¬¡å°±å¯ä»¥å®Œæˆæ’åº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bubbleSort</span><span class="params">(intArray: <span class="type">IntArray</span>)</span></span>: IntArray &#123;</span><br><span class="line">        <span class="keyword">var</span> result = intArray</span><br><span class="line">        <span class="keyword">var</span> size = result.size</span><br><span class="line">        <span class="keyword">for</span> (index <span class="keyword">in</span> <span class="number">0</span> until size) &#123;</span><br><span class="line">            <span class="keyword">for</span> (x <span class="keyword">in</span> <span class="number">0</span> until size - index - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (result[x] &gt; result[x + <span class="number">1</span>]) &#123;<span class="comment">//ã€æ³¨æ„ã€‘å†’æ³¡æ’åºï¼Œæ¯æ¬¡æ¯”è¾ƒæ»¡è¶³æ¡ä»¶å°±ä¼šäº¤æ¢</span></span><br><span class="line">                    <span class="keyword">var</span> temp = result[x]</span><br><span class="line">                    result[x] = result[x + <span class="number">1</span>]</span><br><span class="line">                    result[x + <span class="number">1</span>] = temp</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="é€‰æ‹©æ’åº"><a href="#é€‰æ‹©æ’åº" class="headerlink" title="é€‰æ‹©æ’åº"></a>é€‰æ‹©æ’åº</h2><p>æ—¶é—´å¤æ‚åº¦ï¼šO(N^2^) </p><p>å› ä¸ºäº¤æ¢æ¬¡æ•°å°‘ï¼Œæ‰€ä»¥æ¯”å†’æ³¡å¿«</p><p>è§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>å‡è®¾ç¬¬ä¸€é¡¹å€¼æœ€å¤§ï¼Œè®¾å…¶åæ ‡ä¸º<code>max</code>ï¼Œä»å·¦åˆ°å³ä¾æ¬¡æ¯”è¾ƒ<code>max</code>å’Œå…¶ä»–å…ƒç´ ï¼Œå¦‚æœé‡åˆ°æ¯”<code>max</code>å¤§çš„ï¼Œå°†maxåæ ‡æŒ‡å‘è¯¥å€¼</li><li>æ¯è½®ç»“æŸå<code>max</code>å°±è¡¨ç¤ºè¿™è½®æ¯”è¾ƒæœ€å¤§çš„å€¼åæ ‡ï¼Œå°†å…¶ä¸å½“å‰æœªæ’åºçš„æœ€åä¸€é¡¹äº¤æ¢</li><li>è¿™æ ·é‡å¤æ­¥éª¤1ï¼Œ2ï¼Œ <code>næ¬¡</code>å°±å¯ä»¥æ’åºå®Œæˆ</li></ol><p>å…¶æ€æƒ³æ˜¯ï¼šæ¯æ¬¡æ¯”è¾ƒå½“å‰æœ€å¤§çš„å€¼ï¼Œè®°å½•ä¸‹å…¶åæ ‡ï¼Œç­‰å½“å‰æ¯”è¾ƒå®Œæˆå°±å’Œ<code>æœªæ¯”è¾ƒçš„æœ€åä¸€ä½</code>äº¤æ¢ï¼Œï¼ˆè¿™æ ·å­é¿å…æ¯æ¬¡æ¯”è¾ƒéƒ½è¦äº¤æ¢ï¼‰ã€‚åŒæ ·è¿™æ ·å­æ¯”è¾ƒnæ¬¡å°±å¯ä»¥å®Œæˆæ’åºã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€‰æ‹©æ’åº</span></span><br><span class="line"><span class="comment"> * 1. æ¯æ¬¡æ¯”è¾ƒå‰1~ï¼ˆn-iï¼‰ä¸ªå…ƒç´ ï¼ˆiæ˜¯æ’åºæ¬¡æ•°ï¼‰ï¼Œå¦‚æœæœ‰å¤§çš„å°±è®°å½•ä¸‹ä½ç½®ï¼Œä¸€è½®æ¯”è¾ƒå®Œæ¯•åäº¤æ¢ä»–å’Œæœ€åä¸€ä½çš„ä½ç½®</span></span><br><span class="line"><span class="comment"> * 2. è¿™æ ·å­æ¯”è¾ƒnæ¬¡å°±å¯ä»¥å®Œæˆæ’åº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">selectSort</span><span class="params">(intArray: <span class="type">IntArray</span>)</span></span>: IntArray &#123;</span><br><span class="line">    <span class="keyword">var</span> result = intArray</span><br><span class="line">    <span class="keyword">var</span> size = result.size</span><br><span class="line">    <span class="keyword">for</span> (index <span class="keyword">in</span> <span class="number">0</span> until size) &#123;</span><br><span class="line">        <span class="keyword">var</span> max = <span class="number">0</span><span class="comment">//å‡è®¾arr[0]æœ€å¤§</span></span><br><span class="line">        <span class="keyword">for</span> (x <span class="keyword">in</span> <span class="number">0</span> until size - index - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result[max] &lt; result[x + <span class="number">1</span>]) &#123;<span class="comment">//å°†maxä¸æ¯ä¸€é¡¹æ¯”è¾ƒï¼Œæ³¨æ„è¿™é‡Œå‚ä¸æ¯”è¾ƒçš„æ˜¯max</span></span><br><span class="line">                max = x + <span class="number">1</span><span class="comment">//é‡åˆ°æ¯”maxå¤§çš„åˆ™è®°å½•ä¸‹å…¶ä½ç½® ã€æ³¨æ„ã€‘è¿™é‡Œå¹¶æ²¡æœ‰äº¤æ¢</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åœ¨æ¯è½®æ¯”è¾ƒå®Œæ¯•åmaxå°±æ˜¯è¿™è½®æ¯”è¾ƒå‡ºæ¥çš„æœ€å¤§å€¼ä½ç½®ï¼Œå°†å…¶æ”¾åˆ°å¯¹åº”ä½ç½®</span></span><br><span class="line">        <span class="keyword">var</span> temp = result[size - index - <span class="number">1</span>]</span><br><span class="line">        result[size - index - <span class="number">1</span>] = result[max]</span><br><span class="line">        result[max] = temp</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ’å…¥æ’åº"><a href="#æ’å…¥æ’åº" class="headerlink" title="æ’å…¥æ’åº"></a>æ’å…¥æ’åº</h2><p>æ—¶é—´å¤æ‚åº¦ï¼šO(N^2^) </p><p>æ¯”å†’æ³¡å¿«ä¸€å€ï¼Œæ¯”é€‰æ‹©æ’åºå¿«ä¸€äº›</p><p>æ€æƒ³ï¼šå‡è®¾ä¸€ä¸ªæ ‡è®°å…ƒç´ çš„å·¦è¾¹å…¨éƒ¨æ˜¯æœ‰åºæ•°ç»„ï¼Œå³è¾¹å…¨æ˜¯æ— åºæ•°ç»„ï¼Œé‚£ä¹ˆåªéœ€è¦å°†å³è¾¹çš„å…ƒç´ ä¾æ¬¡æ‹¿å‡ºæ¥æ’å…¥åˆ°å·¦è¾¹çš„æœ‰åºæ•°ç»„ä¸­å³å¯ã€‚åˆšå¼€å§‹è¿™ä¸ªæ ‡è®°å…ƒç´ å¯ä»¥ä¸º0æˆ–è€…1ï¼ˆå‡è®¾ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ‰åºçš„ï¼‰ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ’å…¥æ’åº</span></span><br><span class="line"><span class="comment"> * å‡è®¾å³ç«¯æ•°ç»„æ˜¯æœ‰åºçš„ï¼Œä¾æ¬¡ä»å·¦ç«¯æ•°ç»„å–å‡ºå…ƒç´ æ¯”è¾ƒï¼Œæ’å…¥åˆ°å³è¾¹çš„æœ‰åºæ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">insertSort</span><span class="params">(intArray: <span class="type">IntArray</span>)</span></span>: IntArray &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = intArray</span><br><span class="line">    <span class="keyword">var</span> size = result.size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (insertIndex <span class="keyword">in</span> <span class="number">1</span> until size ) &#123;<span class="comment">//å‡è®¾arr[0]å·²ç»æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥ä»1å¼€å§‹</span></span><br><span class="line">        <span class="keyword">var</span> insertPoint = result[insertIndex]</span><br><span class="line">        <span class="keyword">for</span> (index <span class="keyword">in</span> insertIndex - <span class="number">1</span> downTo  <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (insertPoint &lt; result[index]) &#123;</span><br><span class="line">                <span class="comment">//é»˜è®¤è¦æ’å…¥çš„ç‚¹æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæœ‰æ¯”æ’å…¥ç‚¹å¤§çš„ï¼Œåˆ™å°†è¯¥ç‚¹å’Œæ’å…¥ç‚¹äº¤æ¢</span></span><br><span class="line">                result[index + <span class="number">1</span>] = result[index]</span><br><span class="line">                result[index] = insertPoint</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å› ä¸ºå·¦è¾¹çš„æ•°ç»„æ˜¯æœ‰åºçš„ï¼Œåªè¦æœ‰æ¯”æ’å…¥ç‚¹å°çš„å…ƒç´ ï¼Œåˆ™å‰©ä¸‹çš„è‚¯å®šéƒ½å°äºè¯¥å…ƒç´ ï¼Œä¸ç”¨å†æ¯”è¾ƒäº†</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/sort/BasicSort.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a>æŸ¥çœ‹æºç </p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_å›¾</title>
      <link href="/blog/posts/a71f2ecc/"/>
      <url>/blog/posts/a71f2ecc/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><strong>å›¾</strong>ï¼Œæ˜¯ç”±å¯ä»¥æœ‰å¤šä¸ªè¾¹çš„é¡¶ç‚¹ç»„æˆçš„ç»“æ„ã€‚</p><p>ä¸¤ä¸ªé¡¶ç‚¹ä¹‹é—´æœ‰è¾¹è¿æ¥ï¼Œåˆ™ç§°è¿™ä¸¤ä¸ªé¡¶ç‚¹æ˜¯<strong>é‚»æ¥</strong>çš„ã€‚</p><p>å‡ ä¸ªç›¸äº’é‚»æ¥çš„é¡¶ç‚¹ç»„æˆçš„çº¿å«åš<strong>è·¯å¾„</strong>,è‡³å°‘æœ‰ä¸€æ¡è·¯å¾„å¯ä»¥åˆ°è¾¾æ‰€æœ‰é¡¶ç‚¹çš„å›¾å«åš<strong>è¿é€šå›¾</strong>ã€‚</p><p>å¦‚æœå›¾çš„é¡¶ç‚¹åªèƒ½ä»Aâ†’Bï¼Œä¸èƒ½ä»Bâ†’Aï¼Œå°±ç§°å›¾æ˜¯<strong>æœ‰å‘å›¾</strong>ã€‚</p><p>å¦‚æœè¾¹è¢«èµ‹äºˆä¸€å®šçš„æƒå€¼ï¼ˆæ•°å­—ï¼‰ï¼Œå°±ç§°å›¾ä¸º<strong>å¸¦æƒå›¾</strong></p><p><img width="30%" height="30%" src="https://jixiaoyong.github.io/images/20181227232301.png"></p><h1 id="å­˜å‚¨æ–¹å¼"><a href="#å­˜å‚¨æ–¹å¼" class="headerlink" title="å­˜å‚¨æ–¹å¼"></a>å­˜å‚¨æ–¹å¼</h1><p>å›¾ä¸€èˆ¬æœ‰ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼š</p><ul><li><p>é‚»æ¥çŸ©é˜µ ç”¨N*Nçš„æ•°ç»„ä¿å­˜å›¾ä¸­æ‰€æœ‰çš„é¡¶ç‚¹,<code>Arr[m][n]</code>å³è¡¨ç¤ºmã€né¡¶ç‚¹æ˜¯å¦é‚»æ¥ï¼ˆY:1,N:0ï¼‰ã€‚</p><p>æ¯”è¾ƒå åœ°æ–¹ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20181227233341.png" alt="é‚»æ¥çŸ©é˜µ"></p></li><li><p>é‚»æ¥è¡¨ ç”¨ä¸€ä¸ªNå¤§å°çš„æ•°ç»„ä¿å­˜ï¼Œæ•°ç»„å…ƒç´ æ˜¯ä¿å­˜ç€é¡¶ç‚¹å’Œä»–æ‰€æœ‰çš„é‚»æ¥ç‚¹çš„é“¾è¡¨ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20181227233435.png" alt="é‚»æ¥è¡¨"></p></li></ul><h1 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h1><p>å›¾çš„æ“ä½œæœ‰æ’å…¥ï¼ˆé¡¶ç‚¹ï¼‰ï¼Œæœç´¢ç­‰ç­‰ã€‚</p><p>ä»¥ä¸‹æ“ä½œä»¥é‚»æ¥è¡¨æ–¹å¼ä¸ºä¾‹ã€‚</p><h2 id="æ’å…¥"><a href="#æ’å…¥" class="headerlink" title="æ’å…¥"></a>æ’å…¥</h2><p>æ’å…¥åˆ†ä¸ºæ’å…¥é¡¶ç‚¹å’Œæ’å…¥è¾¹ã€‚</p><p>æ’å…¥è¾¹çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œè¦åŒæ—¶æ›´æ–°startå’Œendä¸¤ä¸ªé¡¶ç‚¹å¯¹åº”çš„é“¾è¡¨ã€‚</p><h2 id="ç§»é™¤"><a href="#ç§»é™¤" class="headerlink" title="ç§»é™¤"></a>ç§»é™¤</h2><p>åŸç†åŒæ’å…¥è¾¹ã€‚</p><h2 id="æœç´¢"><a href="#æœç´¢" class="headerlink" title="æœç´¢"></a>æœç´¢</h2><p>æœç´¢è¦æ±‚ä»æŸä¸ªç‰¹å®šé¡¶ç‚¹å¼€å§‹ï¼Œæ²¿ç€è¾¹ç§»åŠ¨åˆ°å…¶ä»–é¡¶ç‚¹ï¼Œç§»åŠ¨å®Œæ¯•åè¦ä¿è¯è®¿é—®äº†æ¯ä¸ªé¡¶ç‚¹ã€‚</p><p>æœç´¢åˆåˆ†ä¸ºDFSï¼ˆæ·±åº¦ä¼˜å…ˆæœç´¢ï¼‰ã€BFSï¼ˆå¹¿åº¦ä¼˜å…ˆæœç´¢ï¼‰ã€‚</p><h3 id="DFS"><a href="#DFS" class="headerlink" title="DFS"></a>DFS</h3><p>DFSçš„æ€æƒ³æ˜¯ï¼Œä¾æ¬¡æ²¿ç€é¡¶ç‚¹æŸä¸€ä¸ªé‚»æ¥ç‚¹ï¼Œçºµæ·±è®¿é—®ï¼Œå°†è¯¥é‚»æ¥ç‚¹å½“åšæ–°çš„é¡¶ç‚¹å‹å…¥æ ˆä¸­ï¼Œç»§ç»­çºµæ·±è®¿é—®ï¼Œç›´åˆ°æœ‰é¡¶ç‚¹æ²¡æœ‰å¯ä»¥è®¿é—®çš„é‚»æ¥é¡¶ç‚¹ï¼Œå°†å…¶æ‰“å°å‡ºæ¥ï¼ˆä»æ ˆä¸­æ¨å‡ºï¼‰ï¼›ç„¶åå†è¿”å›ä¸Šä¸€å±‚çš„é‚»æ¥é¡¶ç‚¹ä¸­è¿˜å¯ä»¥è®¿é—®çš„é¡¶ç‚¹ï¼ˆæŸ¥æ‰¾å½“å‰æ ˆé¡¶å…ƒç´ æœªè®¿é—®çš„é‚»æ¥ç‚¹ï¼‰ï¼Œç›´åˆ°æ²¡æœ‰å¯ä»¥è®¿é—®çš„é¡¶ç‚¹ã€‚</p><p>ç”¨æ ˆå®ç°ï¼Œä¼šå…ˆå¾€æ·±å¤„éå†å®Œä¸€æ¡è·¯å¾„ï¼Œå†éå†ä¸‹ä¸€æ¡ã€‚æ¯ä¸ªé¡¶ç‚¹åªè®¿é—®ä¸€æ¬¡</p><p>è§„åˆ™ï¼š</p><ul><li>1/3 è®¿é—®ä¸€ä¸ªé‚»æ¥çš„æœªè®¿é—®é¡¶ç‚¹ï¼Œè®¿é—®å¹¶æ ‡è®°ï¼Œå°†å…¶å‹å…¥æ ˆä¸­ï¼›</li><li>2/3 å½“è§„åˆ™1ä¸èƒ½æ»¡è¶³æ—¶ï¼Œå¦‚æœæ ˆä¸ä¸ºç©ºï¼Œä»æ ˆä¸­å¼¹å‡ºä¸€ä¸ªé¡¶ç‚¹ï¼›</li><li>3/3 1,2éƒ½æ— æ³•æ»¡è¶³æ—¶ï¼Œæœç´¢ç»“æŸã€‚</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">dfs</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> stacks = DfsStacks(hashMap.size)</span><br><span class="line">    <span class="keyword">var</span> keyArr = hashMap.keys.toIntArray()</span><br><span class="line">    stacks.push(keyArr[<span class="number">0</span>])</span><br><span class="line">    hashMap[keyArr[<span class="number">0</span>]]?.isVisited = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> index = hashMap[keyArr[<span class="number">0</span>]]</span><br><span class="line">    <span class="keyword">while</span> (stacks.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> availableKey = getAvailableNode(index!!.<span class="keyword">data</span>)</span><br><span class="line">        <span class="keyword">if</span> (availableKey != -<span class="number">1</span>) &#123;</span><br><span class="line">            index = hashMap[availableKey]<span class="comment">//æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œä¼šå…ˆé¡ºç€ä¸€ä¸ªé‚»æ¥ç‚¹ä¸€ç›´èµ°åˆ°å¤´</span></span><br><span class="line">            index!!.isVisited = <span class="literal">true</span></span><br><span class="line">            stacks.push(availableKey)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> pop = stacks.pop()</span><br><span class="line">            print(<span class="string">"<span class="variable">$pop</span> "</span>)</span><br><span class="line">            index = hashMap[stacks.peek()]<span class="comment">//å¦‚æœä¸€ä¸ªé‚»æ¥ç‚¹å†æ²¡æœ‰æœªè®¿é—®çš„é‚»æ¥ç‚¹ï¼Œé‚£ä¹ˆå»è®¿é—®ä¸‹ä¸€ä¸ªæœªè®¿é—®çš„é‚»æ¥ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BFS"><a href="#BFS" class="headerlink" title="BFS"></a>BFS</h3><p>BFSçš„æ€æƒ³æ˜¯ï¼Œå‘å°†å½“å‰é¡¶ç‚¹çš„æ‰€æœ‰å¯ä»¥è®¿é—®çš„é‚»æ¥ç‚¹è®¿é—®å®Œæ¯•ï¼›ä¹‹åå°†è¯¥é¡¶ç‚¹æ‰“å°ï¼ˆæ¨å‡ºï¼‰ï¼Œå†å»è®¿é—®å…¶é‚»æ¥ç‚¹çš„æ‰€æœ‰å¯ä»¥è®¿é—®é‚»æ¥ç‚¹ï¼ˆä»é˜Ÿåˆ—å¤´å–å‡ºä¸€ä¸ªé¡¶ç‚¹ï¼ŒæŸ¥æ‰¾å…¶æœªè®¿é—®çš„é‚»æ¥ç‚¹ï¼‰ã€‚</p><p>ç”¨é˜Ÿåˆ—å®ç°ï¼Œä¼šå…ˆéå†å®Œæœ¬å±‚æ‰€æœ‰çš„é¡¶ç‚¹ï¼Œç„¶åå†ç§»å‘ä¸‹ä¸€å±‚</p><p>è§„åˆ™ï¼š</p><ul><li>1/3 å…ˆè®¿é—®å½“å‰é¡¶ç‚¹çš„æ‰€æœ‰é‚»æ¥é¡¶ç‚¹ï¼Œæ ‡è®°ï¼Œå¹¶æ’å…¥åˆ°é˜Ÿåˆ—ï¼›</li><li>2/3 å¦‚æœæ²¡æœ‰å¯ä»¥è®¿é—®çš„é‚»æ¥ç‚¹ï¼Œä¸”é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä»é˜Ÿåˆ—å¤´å–å‡ºä¸€ä¸ªé¡¶ç‚¹[æ­¤å¤„åˆç”¨åˆ°äº†ä¸€æ¬¡è¯¥ç‚¹]ï¼Œä½¿å…¶æˆä¸ºå½“å‰é¡¶ç‚¹ï¼Œé‡å¤1ï¼›</li><li>3/3 å¦‚æœ2ä¸èƒ½æ»¡è¶³ï¼Œæœç´¢ç»“æŸã€‚</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">bfs</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> queue = BfsQueue()</span><br><span class="line">    <span class="keyword">var</span> keyArr = hashMap.keys.toIntArray()</span><br><span class="line">    queue.push(keyArr[<span class="number">0</span>])</span><br><span class="line">    hashMap[keyArr[<span class="number">0</span>]]!!.isVisited = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> index = hashMap[keyArr[<span class="number">0</span>]]</span><br><span class="line">    <span class="keyword">while</span> (queue.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> availableKey = getAvailableNode(index!!.<span class="keyword">data</span>)</span><br><span class="line">        <span class="keyword">if</span> (availableKey != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> current = hashMap[availableKey]!!<span class="comment">//å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Œä¼˜å…ˆå°†ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰é‚»æ¥ç‚¹ä¾æ¬¡è®¿é—®</span></span><br><span class="line">            current.isVisited = <span class="literal">true</span></span><br><span class="line">            queue.push(current.<span class="keyword">data</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> pop = queue.pop()</span><br><span class="line">            print(<span class="string">"<span class="variable">$pop</span> "</span>)</span><br><span class="line">            <span class="keyword">if</span> (queue.peek() == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            index = hashMap[queue.peek()]<span class="comment">//å¦‚æœè¯¥ç‚¹æ²¡æœ‰æœªè®¿é—®çš„é‚»æ¥ç‚¹ï¼Œå°±é€‰æ‹©å»è®¿é—®è¯¥ç‚¹é‚»æ¥ç‚¹çš„é‚»æ¥ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æœ€å°ç”Ÿæˆæ ‘MST"><a href="#æœ€å°ç”Ÿæˆæ ‘MST" class="headerlink" title="æœ€å°ç”Ÿæˆæ ‘MST"></a>æœ€å°ç”Ÿæˆæ ‘MST</h1><blockquote><p>ç”Ÿæˆæ ‘ï¼ˆTemplate:Lang-en-shortï¼‰æ˜¯å…·æœ‰å›¾Gçš„å…¨éƒ¨é¡¶ç‚¹ï¼Œä½†è¾¹æ•°æœ€å°‘çš„è¿é€šå­å›¾.</p><p>â€”â€”ç»´åŸºç™¾ç§‘</p></blockquote><p>å¸¦æƒå›¾çš„ç”Ÿæˆæ ‘ä¸­ï¼Œæ€»æƒé‡æœ€å°çš„ç§°ä¸ºæœ€å°ç”Ÿæˆæ ‘ã€‚</p><p>æœ€å°ç”Ÿæˆæ ‘è¾¹æ¯”é¡¶ç‚¹æ•°å°1ã€‚</p><ul><li><p>å½“å›¾çš„æ¯ä¸€æ¡è¾¹çš„æƒå€¼éƒ½ç›¸åŒæ—¶ï¼Œè¯¥å›¾çš„æ‰€æœ‰ç”Ÿæˆæ ‘éƒ½æ˜¯æœ€å°ç”Ÿæˆæ ‘ã€‚</p></li><li><p>å¦‚æœå›¾çš„æ¯ä¸€æ¡è¾¹çš„æƒå€¼éƒ½äº’ä¸ç›¸åŒï¼Œé‚£ä¹ˆæœ€å°ç”Ÿæˆæ ‘å°†åªæœ‰ä¸€ä¸ªã€‚</p></li></ul><p>æ— å‘ä¸å¸¦æƒå›¾ä¸­ï¼Œåªéœ€è¦æ‰¾å‡ºæœ€å°æ•°é‡çš„è¾¹å³å¯ã€‚ç”¨DFSæ¯”è¾ƒå¥½å®ç°ï¼Œå› ä¸ºä»–å¯¹æ¯ä¸ªé¡¶ç‚¹åªè®¿é—®ä¸€æ¬¡ã€‚</p><h1 id="æ‹“æ‰‘æ’åº"><a href="#æ‹“æ‰‘æ’åº" class="headerlink" title="æ‹“æ‰‘æ’åº"></a>æ‹“æ‰‘æ’åº</h1><p>æ‹“æ‰‘æ’åºæ˜¯æŒ‡<strong>æœ‰å‘å›¾</strong>çš„é¡¶ç‚¹æ’åºï¼Œæ»¡è¶³ä»¥ä¸‹æ¡ä»¶<a href="#å‚è€ƒèµ„æ–™">*</a>ï¼š</p><ol><li>æ¯ä¸ªé¡¶ç‚¹å‡ºç°ä¸”åªå‡ºç°ä¸€æ¬¡ï¼›</li><li>è‹¥Aåœ¨åºåˆ—ä¸­æ’åœ¨Bçš„å‰é¢ï¼Œåˆ™åœ¨å›¾ä¸­ä¸å­˜åœ¨ä»Båˆ°Açš„<a href="https://zh.wikipedia.org/wiki/%E8%B7%AF%E5%BE%84_(%E5%9B%BE%E8%AE%BA" target="_blank" rel="noopener">è·¯å¾„</a>)ã€‚</li></ol><p>å®ç°æ€è·¯æ˜¯ï¼š</p><ul><li><p>ä¾æ¬¡æ¨å‡ºæœ‰å‘å›¾ä¸­æ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹ä½œä¸ºæ’åºçš„æœ€åé¡¹ï¼Œè¿™æ˜¯å› ä¸ºæŒ‰ç…§æ‹“æ‰‘æ’åº<code>æ¡ä»¶2</code>æ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹å¿…ç„¶æ’åœ¨åé¢ï¼›</p></li><li><p>å½“å»æ‰æ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹ååˆä¼šäº§ç”Ÿæ–°çš„æ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹ï¼Œè¿™æ ·ä¾æ¬¡å¾ªç¯ï¼Œå½“å›¾ä¸­æ²¡æœ‰é¡¶ç‚¹çš„æ—¶å€™ï¼Œå°±å¯ä»¥åœ¨æœ‰å‘æ— ç¯å›¾ä¸­å®Œæˆæ‹“æ‰‘æ’åºã€‚</p></li></ul><p>å¯¹äºæœ‰ç¯å­˜åœ¨ï¼ˆå³å­˜åœ¨ç±»ä¼¼Aâ†’Bï¼ŒBâ†’Cï¼ŒCâ†’Açš„æƒ…å†µï¼‰çš„æœ‰å‘å›¾ï¼Œä¼šå‡ºç°æ‰¾ä¸åˆ°<code>æ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹</code>ï¼Œä½†åŒæ—¶<code>å›¾ä¸­é¡¶ç‚¹æ•°ä¸ä¸º0</code>çš„æƒ…å†µï¼Œé‡åˆ°è¿™ç§æƒ…å†µé€€å‡ºå¾ªç¯ï¼Œå¹¶è¯´æ˜æœ‰ç¯å­˜åœ¨å³å¯ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‹“æ‰‘æ’åº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">topologicalSort</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashMap.size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> displayList = ArrayList&lt;T?&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (hashMap.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> successorKey = getSuccessorNode()</span><br><span class="line">        <span class="keyword">if</span> (successorKey == <span class="literal">null</span>) &#123;<span class="comment">//å›¾ä¸­è¿˜æœ‰é¡¶ç‚¹ï¼Œä½†å´æ‰¾ä¸åˆ°â€œæ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹â€ï¼Œè¯´æ˜æœ‰ç¯</span></span><br><span class="line">            println(<span class="string">"å›¾ä¸­æœ‰ç¯"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            hashMap.remove(successorKey)<span class="comment">//å¦‚æœæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é¡¶ç‚¹ï¼Œä»å›¾ä¸­åˆ é™¤å¹¶ä¿å­˜çš„æ’åºç»“æœä¸­</span></span><br><span class="line">            displayList.add(successorKey)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    print(<span class="string">"\n <span class="subst">$&#123;displayList.reversed()&#125;</span> \n"</span>)<span class="comment">//ä»¥æ­£ç¡®çš„é¡ºåºè¾“å‡ºæ’åºç»“æœ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éå†å›¾ï¼ŒæŸ¥æ‰¾æ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> -1è¡¨ç¤ºæ²¡æœ‰è¿™æ ·çš„ç‚¹ å¦åˆ™è¿”å›è¯¥ç‚¹key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getSuccessorNode</span><span class="params">()</span></span>: T? &#123;</span><br><span class="line">    <span class="keyword">val</span> result: T? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> ketSet = hashMap.keys</span><br><span class="line"></span><br><span class="line">    ketSet.map &#123;<span class="comment">//éå†å›¾ä¸­æ¯ä¸ªé¡¶ç‚¹</span></span><br><span class="line">        <span class="comment">//å¦‚æœé¡¶ç‚¹æ²¡æœ‰åç»§ç‚¹(æ²¡æœ‰é‚»æ¥ç‚¹ï¼Œæˆ–è€…é‚»æ¥ç‚¹å·²ç»è¢«åˆ é™¤)å°±æ˜¯æ»¡è¶³æ¡ä»¶</span></span><br><span class="line">        <span class="keyword">var</span> node: GraphicNode&lt;T&gt;? = hashMap[it]?.next ?: <span class="keyword">return</span> it</span><br><span class="line">        <span class="keyword">while</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> realNode = hashMap[node.<span class="keyword">data</span>]</span><br><span class="line">            <span class="keyword">if</span> (realNode != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span><span class="symbol">@map</span><span class="comment">//æœ‰åç»§ç‚¹ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªé¡¶ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">            node = node.next<span class="comment">//è¿˜æœ‰å…¶ä»–é‚»æ¥ç‚¹ï¼Œä¾æ¬¡éå†</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> it</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result<span class="comment">//æ²¡æœ‰æ‰¾åˆ°â€œæ²¡æœ‰åç»§ç‚¹çš„é¡¶ç‚¹â€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/graph/GraphClazz.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹<code>DFS/BFS/MST</code>æºç </p><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/graph/Digraph.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹<code>æ‹“æ‰‘æ’åº</code>æºç </p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://zh.wikipedia.org/wiki/%E6%8B%93%E6%92%B2%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener">æ‹“æ‰‘æ’åºâ€”â€”ç»´åŸºç™¾ç§‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_å †</title>
      <link href="/blog/posts/b3af796a/"/>
      <url>/blog/posts/b3af796a/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å †æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼Œç”¨ä»–å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—æ’å…¥å’Œåˆ é™¤æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯$O(LogN)$ ã€‚</p><h1 id="ç‰¹å¾"><a href="#ç‰¹å¾" class="headerlink" title="ç‰¹å¾"></a>ç‰¹å¾</h1><ol><li>å †æ˜¯å®Œå…¨äºŒå‰æ ‘<a href="#å®Œå…¨äºŒå‰æ ‘">*</a></li><li>å¸¸ç”¨æ•°ç»„å®ç°</li><li>æ¯ä¸ªå †çš„èŠ‚ç‚¹éƒ½æ»¡è¶³å †çš„æ¡ä»¶ï¼Œå³å †çš„æ¯ä¸ªèŠ‚ç‚¹å…³é”®å­—éƒ½å¤§äºï¼ˆæˆ–ç­‰äºï¼‰å­èŠ‚ç‚¹çš„å…³é”®å­—</li></ol><p><code>ç‰¹å¾3</code>ä¿è¯äº†æ ¹èŠ‚ç‚¹æ˜¯å †ä¸­æœ€å¤§çš„å€¼ï¼Œä»¥åŠé¡ºç€æŸä¸€ä¸ªèŠ‚ç‚¹ä¸€ç›´åˆ°é‡åˆ°å¶èŠ‚ç‚¹çš„è·¯å¾„ä¸Šçš„èŠ‚ç‚¹å…³é”®å­—æ˜¯ä¾æ¬¡é€’å‡çš„ï¼Œä½†æ˜¯æ²¡æ³•ä¿è¯è¿™ä¸ªå€¼æ˜¯è¿™ä¸ªå †ä¸­çš„æœ€å°å€¼ï¼Œè¿™æ˜¯å› ä¸ºå †ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å³å­èŠ‚ç‚¹çš„ä½ç½®å’Œå¤§å°æ— å…³ï¼Œä¸¤æ¡è¿™æ ·çš„è·¯å¾„ä¹‹å‰çš„å€¼çš„å¤§å°æ²¡æœ‰ä¸€å®šçš„å…³ç³»ã€‚</p><h1 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h1><p>å †å¯ä»¥è¿›è¡Œæ’å…¥ã€ç§»é™¤ï¼Œéå†ç­‰æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯$O(LogN)$ã€‚åˆæ¬¡ä¹‹å¤–ï¼Œåˆ©ç”¨å †æ ¹èŠ‚ç‚¹å…³é”®å€¼æœ€å¤§è¿™ä¸ªå±æ€§ï¼Œè¿˜å¯ä»¥è¿›è¡Œå †æ’åº,æ—¶é—´å¤æ‚åº¦ä¸º$O(N*LogN)$ã€‚</p><p>å¯¹äºåœ¨æ•°ç»„ä¸­ä¿å­˜çš„å †ï¼Œè®¾å…ƒç´ ä¸‹æ ‡ä¸º<code>x</code>ï¼Œåˆ™å„ä¸ªç›¸å…³å…ƒç´ ä¸‹æ ‡å¦‚ä¸‹ï¼š</p><ul><li>çˆ¶èŠ‚ç‚¹<code>(x-1)/2</code></li><li>å·¦å­èŠ‚ç‚¹ <code>2*x+1</code></li><li>å³å­èŠ‚ç‚¹ <code>2*x+2</code></li></ul><p>åœ¨æ’å…¥ï¼Œç§»é™¤çš„æ—¶å€™ä¸ºäº†ä¿è¯æ»¡è¶³å †çš„æ¡ä»¶ï¼Œéœ€è¦å¯¹å †è¿›è¡Œå‘ä¸Šæˆ–å‘ä¸‹çš„éå†ï¼Œå°†ä¿®æ”¹çš„å€¼ç§»åŠ¨åˆ°å¯¹åº”çš„ä½ç½®ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°å¤åˆ¶å’Œäº¤æ¢ã€‚å¦‚æœæ¯æ¬¡æ¯”è¾ƒéƒ½éœ€è¦äº¤æ¢æ•°æ®çš„è¯ä¼šå¤åˆ¶å¾ˆå¤šæ¬¡ï¼Œè€Œå¦‚æœå°†æœ€ç»ˆè¦ç§»åŠ¨å€¼ä¿å­˜åœ¨ä¸´æ—¶å˜é‡ä¸­ï¼Œç”¨ä¸€ä¸ªå€¼ä¸“é—¨è®°å½•è¦ç§»åŠ¨åˆ°çš„ä¸‹æ ‡ï¼Œåœ¨æ¯æ¬¡ç¬¦åˆæ¡ä»¶æ—¶åªå¤åˆ¶å‚ä¸å¯¹æ¯”çš„å€¼ï¼Œåœ¨æœ€åå†å°†è¦ä¸´æ—¶ä¿å­˜çš„å€¼å¤åˆ¶åˆ°ç›®çš„ä¸‹æ ‡ï¼Œå°±ä¼šå‡å°‘å¤åˆ¶çš„æ¬¡æ•°ã€‚</p><p>å¦‚ä¸‹å›¾å°±å°†å¤åˆ¶æ¬¡æ•°ä»9æ¬¡å‡å°‘åˆ°äº†5æ¬¡ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20181225213813.png" alt></p><h2 id="æ’å…¥"><a href="#æ’å…¥" class="headerlink" title="æ’å…¥"></a>æ’å…¥</h2><p>æ’å…¥æ“ä½œæ€è·¯æ˜¯ï¼Œå°†å…ƒç´ æ’å…¥åˆ°æ•°ç»„æœ€åä¸€ä½ï¼Œç„¶åä¾æ¬¡å‘å…ƒç´ çˆ¶èŠ‚ç‚¹éå†ï¼Œå°†ä¸æ»¡è¶³çš„å…ƒç´ ä¸‹æ²‰ï¼Œç›´åˆ°æ‰¾åˆ°æ»¡è¶³<code>å †ç‰¹å¾3</code>ï¼ˆçˆ¶èŠ‚ç‚¹å…³é”®å­—å¤§äºè¯¥ç‚¹ï¼Œå¹¶ä¸”å­èŠ‚ç‚¹å…³é”®å­—å°äºè¯¥ç‚¹ï¼‰çš„ä¸‹æ ‡ï¼Œæˆ–è€…æŒ‡å‘äº†æ ¹ç›®å½•ï¼Œå°†è¯¥å…ƒç´ æ’å…¥è¯¥å¤„ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä»ä¸‹å‘ä¸Šéå†</span></span><br><span class="line"><span class="comment">    * å¦‚æœçˆ¶èŠ‚ç‚¹æ¯”æ’å…¥å€¼å°ï¼Œå°±å°†çˆ¶èŠ‚ç‚¹ç§»åŠ¨åˆ°æ’å…¥å€¼çš„ä½ç½®ï¼Œå°†toIndexæŒ‡å‘ç©ºå‡ºçš„åœ°æ–¹</span></span><br><span class="line"><span class="comment">    * ä¾æ¬¡æŸ¥æ‰¾ï¼Œç›´åˆ°æŸ¥æ‰¾åˆ°çˆ¶èŠ‚ç‚¹æ¯”æ’å…¥å€¼å¤§ï¼Œå­èŠ‚ç‚¹æ¯”æ’å…¥å€¼å°çš„åœ°æ–¹ï¼Œæˆ–è€…æŒ‡å‘äº†æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkUp</span><span class="params">(index: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">       <span class="keyword">var</span> bottom = headArray[index]<span class="comment">//headArrayæ˜¯ä¿å­˜å †å…ƒç´ çš„æ•°ç»„</span></span><br><span class="line">       <span class="keyword">var</span> toIndex = index</span><br><span class="line">       <span class="keyword">var</span> father = (toIndex - <span class="number">1</span>) / <span class="number">2</span></span><br><span class="line">       <span class="keyword">while</span> (toIndex &gt; <span class="number">0</span> &amp;&amp; bottom!!.key &gt; headArray[father]!!.key) &#123;</span><br><span class="line">           headArray[toIndex] = headArray[father]<span class="comment">//å°†çˆ¶èŠ‚ç‚¹ä¸‹æ²‰</span></span><br><span class="line">           toIndex = father</span><br><span class="line">           father = (toIndex - <span class="number">1</span>) / <span class="number">2</span></span><br><span class="line">       &#125;</span><br><span class="line">       headArray[toIndex] = bottom<span class="comment">//å°†è¯¥å€¼æ’å…¥åˆ°å¯¹åº”ä¸‹æ ‡</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="ç§»é™¤"><a href="#ç§»é™¤" class="headerlink" title="ç§»é™¤"></a>ç§»é™¤</h2><p>ç§»é™¤æŒ‡çš„æ˜¯å°†æ ¹èŠ‚ç‚¹æ¨å‡ºå †ä¸­ã€‚</p><p>åŸºæœ¬æ€è·¯æ˜¯å°†æ ¹èŠ‚ç‚¹æ¨å‡ºï¼Œå†å°†æ•°ç»„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåŒæ—¶ä¹Ÿæ˜¯å †çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰ç§»åŠ¨åˆ°æ ¹èŠ‚ç‚¹ç©ºå‡ºçš„ä½ç½®ï¼Œå†ä¾æ¬¡å‘ä¸‹éå†ï¼Œç›´åˆ°å°†è¯¥èŠ‚ç‚¹æ”¾åˆ°ç¬¦åˆå †æ¡ä»¶çš„ä½ç½®æˆ–è€…åˆ°è¾¾å¶å­èŠ‚ç‚¹ã€‚</p><p>å’Œæ’å…¥ç›¸æ¯”ï¼Œç§»é™¤æ—¶è¦ç§»åŠ¨çš„èŠ‚ç‚¹è¦æ¯”è¾ƒçš„ç¨å¾®å¤šäº›ã€‚</p><ul><li>è¯¥èŠ‚ç‚¹æ˜¯å¶èŠ‚ç‚¹    ç›´æ¥æ’å…¥âœ…</li><li>æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹        å’Œä¸¤ä¸ªå¶å­èŠ‚ç‚¹ä¸­æœ€å¤§çš„æ¯”è¾ƒï¼Œå¦‚æœå°äºåˆ™äº¤æ¢ï¼Œå¹¶å†å’Œæ–°çš„å­èŠ‚ç‚¹æ¯”è¾ƒ</li><li>åªæœ‰å·¦èŠ‚ç‚¹    å¦‚æœå·¦èŠ‚ç‚¹å¤§äºæœ¬èŠ‚ç‚¹åˆ™äº¤æ¢ï¼Œå¦åˆ™å°±æ˜¯è¯¥ä½ç½®</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»ä¸Šå‘ä¸‹éå†</span></span><br><span class="line"><span class="comment"> * å¦‚æœé‡åˆ°æ¯”å½“å‰å€¼topå¤§çš„å°±å°†å…¶å¤åˆ¶åˆ°å½“å‰ä½ç½®toIndexï¼Œå¹¶è®°å½•ä¸‹ç©ºå‡ºçš„ä½ç½®ä¸ºtoIndex</span></span><br><span class="line"><span class="comment"> * å†ä»¥toIndexä¸ºèµ·ç‚¹å‘ä¸‹æ¯”è¾ƒï¼Œç›´åˆ°é‡åˆ°topæ¯”çˆ¶èŠ‚ç‚¹å°ï¼Œæ¯”å­èŠ‚ç‚¹å¤§çš„ä½ç½®ï¼Œæˆ–è€…å¶å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * å°†topç§»åŠ¨åˆ°è¯¥ä½ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkDown</span><span class="params">(index: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> toIndex = index</span><br><span class="line">    <span class="keyword">var</span> top = headArray[size - <span class="number">1</span>]!!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (toIndex &lt; size / <span class="number">2</span>) &#123;<span class="comment">//éå¶å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">var</span> leftIndex = <span class="number">2</span> * toIndex + <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> rightIndex = <span class="number">2</span> * toIndex + <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> (headArray[rightIndex] == <span class="literal">null</span>) &#123;<span class="comment">//åªæœ‰å·¦èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (headArray[leftIndex]!!.key &gt; top.key) &#123;</span><br><span class="line">                headArray[toIndex] = headArray[leftIndex]</span><br><span class="line">                toIndex = leftIndex</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (headArray[leftIndex] != <span class="literal">null</span> &amp;&amp; headArray[rightIndex] != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (headArray[leftIndex]!!.key &gt;= headArray[rightIndex]!!.key) &#123;<span class="comment">//å¦‚æœå·¦èŠ‚ç‚¹æ¯”è¾ƒå¤§</span></span><br><span class="line">                <span class="keyword">if</span> (headArray[leftIndex]!!.key &gt; top.key) &#123;</span><br><span class="line">                    headArray[toIndex] = headArray[leftIndex]</span><br><span class="line">                    toIndex = leftIndex</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//å¦‚æœå³èŠ‚ç‚¹æ¯”è¾ƒå¤§</span></span><br><span class="line">                <span class="keyword">if</span> (headArray[rightIndex]!!.key &gt; top.key) &#123;</span><br><span class="line">                    headArray[toIndex] = headArray[rightIndex]</span><br><span class="line">                    toIndex = rightIndex</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    headArray[toIndex] = top<span class="comment">//å°†è¯¥èŠ‚ç‚¹ç§»åŠ¨åˆ°æ‰¾åˆ°çš„ä¸‹æ ‡å¤„</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å †æ’åº"><a href="#å †æ’åº" class="headerlink" title="å †æ’åº"></a>å †æ’åº</h2><p>åˆ©ç”¨å †<code>æ ¹èŠ‚ç‚¹å…³é”®å€¼æœ€å¤§</code>è¿™ä¸€ç‰¹æ€§ï¼Œå¯ä»¥è¿›è¡Œå †æ’åºã€‚</p><p>åªéœ€è¦å°†å¾…æ’åºçš„æ•°ç»„ä¾æ¬¡æ’å…¥å †ä¸­ï¼Œç„¶åå†ä¾æ¬¡ç§»é™¤å³å¯ã€‚</p><p>è¿™æ ·éœ€è¦æœ‰ä¸¤å€ä¸å¾…æ’åºæ•°ç»„å¤§å°çš„ç©ºé—´ã€‚å¦‚æœæ¯æ¬¡æ’å…¥æ—¶å€™åªä¿å­˜æ•°æ®ï¼Œä¸è¿›è¡Œå‘ä¸Šéå†ï¼Œåœ¨æ¯æ¬¡ç§»é™¤æ•°æ®æ—¶è¿›è¡Œå‘ä¸‹éå†ï¼Œå°†å½“å‰å‰©ä½™æ•°æ®æœ€å¤§å€¼é€‰å‡ºæ¥ï¼ˆå…¶ä½™æ•°æ®ä»ç„¶æ— åºï¼‰ä»å †ä¸­ç§»é™¤æ ¹å…ƒç´ æ—¶éƒ½ä¼šåœ¨æ•°ç»„æœ«å°¾ç©ºå‡ºä¸€ä¸ªä½ç½®ï¼Œå°†è¯¥å€¼å­˜å‚¨åœ¨è¯¥ä½ç½®å³å¯ï¼Œè¿™æ ·ç­‰å®Œå…¨æ’å…¥ã€ç§»é™¤åå°±å¾—åˆ°ä¸€ä¸ªæœ‰åºæ•°ç»„ã€ä»æ•°ç»„æœ«å°¾å¼€å§‹ä¾æ¬¡å‡å°ã€‘</p><p>å †æ’åºå’Œå¿«é€Ÿæ’åºæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <code>O(N*LogN)</code> ï¼Œä½†æ˜¯ç”±äºå‘ä¸Šã€å‘ä¸‹éå†è€—æ—¶ï¼Œå®é™…ä¸Šè¦æ¯”å¿«é€Ÿæ’åºç¨æ…¢ä¸€äº›ã€‚ä½†æ˜¯å †æ’åºå †æ•°æ®åˆå§‹åˆ†å¸ƒä¸æ•æ„Ÿä¸€ç›´éƒ½æ˜¯ <code>O(N*LogN)</code> ï¼Œå¿«é€Ÿæ’åºåœ¨æŸäº›æƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦å¯è¾¾åˆ° <code>O(N^2)</code> ã€‚</p><h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><h2 id="æ»¡äºŒå‰æ ‘"><a href="#æ»¡äºŒå‰æ ‘" class="headerlink" title="æ»¡äºŒå‰æ ‘"></a>æ»¡äºŒå‰æ ‘</h2><p>æ»¡äºŒå‰æ ‘æŒ‡é™¤æœ€åä¸€å±‚æ— ä»»ä½•å­èŠ‚ç‚¹å¤–ï¼Œæ¯ä¸€å±‚ä¸Šçš„æ‰€æœ‰ç»“ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­ç»“ç‚¹äºŒå‰æ ‘ã€‚</p><p>å¦‚æœä¸€ä¸ªäºŒå‰æ ‘çš„å±‚æ•°ä¸ºKï¼Œä¸”èŠ‚ç‚¹æ€»æ•°æ˜¯ $(2^k) -1$  ï¼Œåˆ™å®ƒå°±æ˜¯æ»¡äºŒå‰æ ‘ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20181225210750.png" alt="æ»¡äºŒå‰æ ‘"></p><h2 id="å®Œå…¨äºŒå‰æ ‘"><a href="#å®Œå…¨äºŒå‰æ ‘" class="headerlink" title="å®Œå…¨äºŒå‰æ ‘"></a>å®Œå…¨äºŒå‰æ ‘</h2><p>å®Œå…¨äºŒå‰æ ‘ å¦‚æœå°†äºŒå‰æ ‘æ¯å±‚ä»å·¦åˆ°å³éå†ï¼Œé‚£ä¹ˆå®Œå…¨äºŒå‰æ ‘åªæœ‰æœ€åä¸€å±‚çš„å³è¾¹ä¼šå‡ºç°æ²¡æœ‰å¶å­èŠ‚ç‚¹çš„æƒ…å†µï¼Œå³åœ¨å‰1~nä¹‹é—´æ²¡æœ‰â€œæ´â€ã€‚</p><p>å¦‚ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181225211304.png" alt="å®Œå…¨äºŒå‰æ ‘"></p><p>ä½†ä¸‹å›¾ä¸æ˜¯å®Œå…¨äºŒå‰æ ‘ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223211217.png" alt="ä¸æ˜¯å®Œå…¨äºŒå‰æ ‘"></p><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/tree/HeadClazz.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a> æŸ¥çœ‹æºç </p><h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://baike.baidu.com/item/%E6%BB%A1%E4%BA%8C%E5%8F%89%E6%A0%91" target="_blank" rel="noopener">æ»¡äºŒå‰æ ‘â€”â€”ç™¾åº¦ç™¾ç§‘</a></p><p><a href="https://blog.csdn.net/u013812939/article/details/46798743" target="_blank" rel="noopener">å®Œå…¨äºŒå‰æ ‘ä¸æ»¡äºŒå‰æ ‘çš„åŒºåˆ«</a></p><p>ã€ŠJavaæ•°æ®ç»“æ„å’Œç®—æ³• ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ Robert Lafore é™ˆç»´å®</p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_Hashè¡¨</title>
      <link href="/blog/posts/1f6681a0/"/>
      <url>/blog/posts/1f6681a0/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Hashè¡¨æ˜¯ä¸€ç§å¯ä»¥å¿«é€Ÿæ’å…¥å’ŒæŸ¥æ‰¾çš„æ•°æ®ç»“æ„ï¼Œå°†æ•°æ®ä¿å­˜åœ¨é€šè¿‡hashå‡½æ•°è®¡ç®—å¾—åˆ°çš„ä¸‹æ ‡ä¸­ã€‚</p><p>æ’å…¥å’Œåˆ é™¤ æ‰€éœ€æ—¶é—´ä¸ºO(1)ã€‚åœ¨ç¡®å®šå®¹é‡ã€æ— éœ€éå†æ—¶æ•ˆæœæœ€å¥½ã€‚</p><p>å½“å…¶å¤§å°æ¥è¿‘å®¹é‡æ—¶ï¼Œæ•ˆç‡ä¼šå˜å¾—å¾ˆå·®ã€‚</p><h1 id="å­˜å‚¨æ–¹å¼"><a href="#å­˜å‚¨æ–¹å¼" class="headerlink" title="å­˜å‚¨æ–¹å¼"></a>å­˜å‚¨æ–¹å¼</h1><p>Hashè¡¨æœ‰ä¸¤ç§å­˜å‚¨æ–¹å¼</p><ol><li><p>å¼€æ”¾åœ°å€æ³•</p><p>å¼€æ”¾åœ°å€æ³•ï¼Œç›´æ¥å°†æ•°æ®å­˜å‚¨åœ¨æ•°ç»„ä¸­ã€‚</p><p>å½“hashç®—å‡ºçš„åœ°å€å·²ç»è¢«å ç”¨æ—¶ï¼Œåˆ™èµ°è¿‡ä¸€å®šçš„æ­¥é•¿æ‰¾åˆ°å¦å¤–ä¸€ä¸ªç©ºä½ï¼ˆåœ¨å¡«å……è´¨æ•°å¾ˆå¤§æ—¶å°±ä¼šå¾ˆè€—æ—¶ï¼‰å¹¶ä¿å­˜æ•°æ®ã€‚</p></li><li><p>é“¾åœ°å€æ³•</p><p>é“¾åœ°å€æ³•ï¼Œåˆ›å»ºä¿å­˜æ•°æ®çš„æ•°ç»„ï¼Œè¯¥æ•°ç»„ä¸­ä¸ç›´æ¥ä¿å­˜æ•°æ®ï¼Œè€Œæ˜¯ä¿å­˜ä¸€ä¸ªç”¨æ¥å­˜å‚¨è¿™äº›æ•°æ®çš„é“¾è¡¨ï¼Œå°†æ•°æ®é¡¹ç›´æ¥å­˜å‚¨çš„é“¾è¡¨ä¸­ã€‚</p><p>å½“hashç®—æ³•è®¡ç®—å‡ºçš„åœ°å€æ—¶ï¼Œéå†æ•°ç»„ä¸­å¯¹åº”çš„é“¾è¡¨æ‰¾åˆ°ç©ºä½å¹¶ä¿å­˜ã€‚</p></li></ol><p>å…¶ä¸­ï¼Œå¼€æ”¾åœ°å€æ³•åˆåˆ†ä¸º3ç§å®ç°ï¼š</p><ul><li><p>çº¿æ€§æ¢æµ‹</p><p>æ¯æ¬¡å‰è¿›çš„æ­¥é•¿ä¸º1</p><p>å³æŸ¥æ‰¾çš„ä½ç½®ä¾æ¬¡æ˜¯<code>x + 1,2,3,4,5,â€¦â€¦</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å­˜å‚¨è¾¾åˆ°å®¹é‡2/3ä»¥ä¸Šæ—¶å€™è¯»å†™æ€§èƒ½ä¼šå¾ˆå·®</span><br></pre></td></tr></table></figure></li><li><p>äºŒæ¬¡æ¢æµ‹</p><p>æ¯æ¬¡å‰è¿›çš„æ­¥é•¿ä¸ºå½“å‰æŸ¥æ‰¾æ¬¡æ•°çš„å¹³æ–¹</p><p>å³æŸ¥æ‰¾çš„ä½ç½®ä¾æ¬¡æ˜¯<code>x + 1,4,9,â€¦â€¦</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰å‡ æ¬¡æ‰¾ä¸åˆ°ä¹‹åå°±ä¼šå¾ˆææ…Œï¼Œæ­¥é•¿è¶Šæ¥è¶Šå¤§åˆ°åé¢æ— æ³•ç»§ç»­ä¸‹å»</span><br></pre></td></tr></table></figure></li><li><p>å†å“ˆå¸Œæ³•</p><p>æ¯æ¬¡å‰è¿›çš„æ­¥é•¿æ˜¯æ ¹æ®å¦å¤–ä¸€ä¸ªhashç®—æ³•è®¡ç®—å‡ºæ¥çš„å€¼</p><p>è¿™ä¸ªç®—æ³•è¦æ±‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. ä¸ç¬¬ä¸€æ¬¡hashè¾“å‡ºä¸åŒ  </span><br><span class="line"><span class="number">2</span>. ä¸èƒ½è¾“å‡º<span class="number">0</span></span><br></pre></td></tr></table></figure><p>å·²ç»æœ‰ä¸€ä¸ªå…¬è®¤çš„æ¯”è¾ƒå¥½çš„äºŒæ¬¡hashç®—æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stepSize = constant - (key % constant)</span><br><span class="line">å¦‚ï¼šstepSize = <span class="number">5</span> - (key % <span class="number">5</span>)</span><br><span class="line">* constant æ˜¯å°äºæ•°ç»„å®¹é‡çš„è´¨æ•°</span><br></pre></td></tr></table></figure></li></ul><h1 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h1><p><strong>å†å“ˆå¸Œæ³• VS äºŒæ¬¡æ¢æµ‹æ³•</strong></p><p>åœ¨å°å‹å“ˆå¸Œè¡¨ä¸­ï¼Œå†å“ˆå¸Œæ³•æ¯”äºŒæ¬¡æ¢æµ‹å¥½ï¼›</p><p>ä½†å¦‚æœå®¹é‡å……è¶³ï¼Œå¹¶ä¸”å®¹é‡å¤§å°ä¸å†å˜åŒ–æ—¶ï¼ŒäºŒæ¬¡æ¢æµ‹æ•ˆæœå¥½ï¼Œåœ¨è£…å¡«å› å­å°äº0.5æ—¶å‡ ä¹æ²¡æœ‰æ€§èƒ½æŸå¤±</p><p><strong>å¼€æ”¾åœ°å€æ³• VS é“¾åœ°å€æ³•</strong></p><p>hashè¡¨å®¹å™¨å¤§å°æœªçŸ¥æ—¶ï¼Œç”¨é“¾åœ°å€æ³•æ¯”è¾ƒå¥½</p><p>å½“è£…å¡«å› å­å˜å¾—å¾ˆå¤§æ—¶ï¼Œå¼€æ”¾åœ°å€æ³•æ€§èƒ½ä¸‹é™å¾ˆå¿«ï¼Œä½†é“¾åœ°å€æ³•åªæ˜¯çº¿æ€§ä¸‹é™ã€‚</p><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/tree/Hash.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a>æŸ¥çœ‹æºç </p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„_çº¢é»‘æ ‘</title>
      <link href="/blog/posts/11c01876/"/>
      <url>/blog/posts/11c01876/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çº¢é»‘æ ‘æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æœç´¢æ ‘ï¼ŒæŸ¥æ‰¾ï¼Œæ’å…¥å’Œåˆ é™¤çš„æ—¶é—´å¤æ‚åº¦å‡ä¸º$O(log_2N)$ã€‚</p><p>çº¢é»‘æ ‘å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ol><li><p>å¿…é¡»æœ‰é¢œè‰²ï¼ˆé»‘/çº¢ï¼‰</p></li><li><p>æ ¹èŠ‚ç‚¹é¢œè‰²ä¸ºé»‘</p></li><li>è‹¥èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œåˆ™å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²ï¼ˆåä¹‹åˆ™ä¸ç„¶ï¼‰</li><li>åˆ°å¶èŠ‚ç‚¹æˆ–ç©ºå­èŠ‚ç‚¹çš„æ¯ä¸€æ¡è¾¹ä¸Šçš„é»‘è‰²èŠ‚ç‚¹æ•°é‡å¿…é¡»ç›¸åŒï¼ˆç©ºå­èŠ‚ç‚¹æŒ‡æœ¬åº”è¯¥æœ‰å¶èŠ‚ç‚¹å´æ²¡æœ‰çš„èŠ‚ç‚¹ï¼Œé»˜è®¤ä¸ºé»‘è‰²ï¼‰</li></ol><p>å¦‚æœä¸æ»¡è¶³å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¿®æ­£ï¼š</p><ul><li>æ”¹å˜èŠ‚ç‚¹é¢œè‰²</li><li>æ—‹è½¬ï¼ˆå·¦ã€å³ï¼‰</li></ul><h1 id="æ—‹è½¬"><a href="#æ—‹è½¬" class="headerlink" title="æ—‹è½¬"></a>æ—‹è½¬</h1><p>ä»¥æŸä¸ªæ”¯ç‚¹æ—‹è½¬ï¼ˆå³æ—‹ä¸ºä¾‹ï¼Œæ—‹è½¬æ—¶æ³¨æ„æ›´æ–°å„ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼‰ï¼š</p><p>æœ¬è´¨æ˜¯å°†è¯¥<code>èŠ‚ç‚¹a</code>å‘ä¸‹è¿›ä¸€ä½æ’å…¥åˆ°å…¶<code>å³èŠ‚ç‚¹b</code>åŸå…ˆçš„ä½ç½®ï¼Œå°†å…¶<code>å·¦èŠ‚ç‚¹c</code>å‘ä¸Šè¿›ä¸€ä½æ’å…¥åˆ°è¯¥<code>èŠ‚ç‚¹a</code>åŸå…ˆçš„ä½ç½®ï¼Œå¹¶å°†<code>å·¦èŠ‚ç‚¹cçš„å³èŠ‚ç‚¹</code>èµ‹å€¼ç»™è¯¥<code>èŠ‚ç‚¹a</code>ã€‚</p><p>æ­¥éª¤ï¼š</p><ol><li><p>å°†è¯¥<code>èŠ‚ç‚¹a</code>æ”¾åˆ°<code>å³èŠ‚ç‚¹b</code>çš„ä½ç½®ï¼Œå°†è¯¥<code></code>å·¦èŠ‚ç‚¹c<code>æ”¾åˆ°</code>èŠ‚ç‚¹a`åŸå…ˆçš„ä½ç½®ï¼Œä¾æ¬¡ç±»æ¨</p></li><li><p>ç‰¹æ®Šçš„ï¼Œå°†è¯¥<code>ç‚¹açš„å†…ä¾§å­™å­</code>ï¼ˆ<code>açš„å·¦å­èŠ‚ç‚¹c</code>çš„<code>å³å­èŠ‚ç‚¹d</code>ï¼‰æ–­å¼€ä¸å…¶<code>çˆ¶èŠ‚ç‚¹c</code>çš„è¿æ¥ï¼Œè½¬è€Œè¿æ¥åˆ°<code>a</code>ä¸Šï¼Œæˆä¸º<code>açš„å·¦å­èŠ‚ç‚¹</code></p></li></ol><p>å¦‚å›¾ï¼Œä¾æ¬¡æ’å…¥<code>6,34,23</code>ï¼Œ<strong>ä»¥<code>34</code>ä¸ºæ”¯ç‚¹å³æ—‹</strong>ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223175956.png" width="50%" height="50%"></p><p>å¯¹è·å¾—çš„ç»“æœï¼Œç”±äº<font color="#ff0000">23</font>ï¼Œ<font color="#ff0000">34</font>éƒ½æ˜¯çº¢è‰²è¿åäº†<code>è§„åˆ™3</code>ï¼Œå°†<code>34çš„çˆ¶èŠ‚ç‚¹23</code>è®¾ç½®é»‘ï¼Œ<code>ç¥–çˆ¶èŠ‚ç‚¹6</code>è®¾ä¸ºçº¢ï¼Œ<strong>ä»¥<code>ç¥–çˆ¶èŠ‚6</code>ç‚¹ä¸ºæ”¯ç‚¹å·¦æ—‹</strong>ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223180637.png" alt="æœ€ç»ˆç»“æœ"></p><h1 id="æ’å…¥"><a href="#æ’å…¥" class="headerlink" title="æ’å…¥"></a>æ’å…¥</h1><p>æ¯æ¬¡æ’å…¥çº¢è‰²èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿé¿å…è§„åˆ™4ã€‚</p><p>ä¸€èˆ¬å…ˆä»¥äºŒå‰æœç´¢æ ‘çš„è§„åˆ™å°†æ•°æ®æ’å…¥è¡¨ä¸­ï¼Œç„¶åå†å¯¹ç…§è§„åˆ™æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´çº¢é»‘æ ‘ã€‚</p><p>çº¢é»‘æ ‘æ’å…¥æƒ…å†µåˆ†ç±»å¦‚ä¸‹ï¼š</p><ol><li>æ’å…¥ä½ç½®ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå°†èŠ‚ç‚¹é¢œè‰²æ›´æ”¹ä¸ºé»‘è‰²</li><li>æ’å…¥ä½ç½®çš„çˆ¶èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹æˆ–çˆ¶èŠ‚ç‚¹é¢œè‰²ä¸ºé»‘è‰²ï¼Œç›´æ¥æ’å…¥</li><li>çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²ã€‚</li></ol><p>åªæœ‰çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²è¿™ç§æƒ…å†µéœ€è¦è¿›è¡Œä¿®æ­£ï¼Œè¿™æ—¶åˆå¯ä»¥ç»†åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223182532.jpg" alt="è¡¨æ ¼æ¥è‡ª http://www.cnblogs.com/skywang12345/p/3245399.html#a1"></p><p>ã€æ³¨æ„ã€‘å¯¹äº<code>Case 3</code>å½“ç¥–çˆ¶èŠ‚ç‚¹æ²¡æœ‰<strong>å·¦èŠ‚ç‚¹</strong>æ— æ³•å³æ—‹æ—¶çš„ç‰¹æ®Šå¤„ç†ï¼š</p><p>éœ€è¦å¯¹å…ˆå¯¹å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹è¿›è¡Œå³æ—‹ï¼Œå†ä»¥çˆ¶èŠ‚ç‚¹ä½œä¸º<strong>æ–°æ’å…¥çš„ç‚¹N</strong>ï¼Œå°†Nçš„çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºçº¢è‰²ï¼Œä»¥ç¥–çˆ¶èŠ‚ç‚¹ä¸ºæ”¯ç‚¹å·¦æ—‹ã€‚</p><p>å¦‚ä¾æ¬¡æ’å…¥å¦‚ä¸‹å€¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">32,3,53,13,983,[137],237,83,483,43,183</span><br></pre></td></tr></table></figure><p>å½“æ’å…¥<code>137</code>åçº¢é»‘æ ‘å¦‚å›¾ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223210305.png" alt="æ’å…¥137åçš„æ ‘"></p><p>æœ¬æ¥æŒ‰ç…§<code>Case 3 çˆ¶çº¢ å”é»‘ æ˜¯å·¦èŠ‚ç‚¹</code> åº”è¯¥è¦ä»¥ç¥–èŠ‚ç‚¹å³æ—‹ï¼Œä½†æ˜¯ç»„èŠ‚ç‚¹53æ²¡æœ‰å·¦å­èŠ‚ç‚¹ï¼Œæ— æ³•å³æ—‹ï¼Œæ‰€ä»¥å…ˆå¯¹çˆ¶èŠ‚ç‚¹983è¿›è¡Œå³æ—‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223210800.png" alt></p><p>å†ä»¥<code>983</code>ä¸ºæ–°èŠ‚ç‚¹ï¼Œ<code>çˆ¶çº¢ å”é»‘ æ˜¯å³èŠ‚ç‚¹</code>ï¼Œå°†<code>çˆ¶èŠ‚ç‚¹137</code>è®¾ç½®ä¸ºé»‘è‰²ï¼Œ<code>ç¥–èŠ‚ç‚¹53</code>è®¾ç½®ä¸ºçº¢è‰²ï¼Œä»¥<code>ç»„èŠ‚ç‚¹53</code>ä¸ºæ”¯ç‚¹å·¦æ—‹ï¼š</p><p><img src="https://jixiaoyong.github.io/images/20181223211217.png" alt></p><h1 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h1><p>åˆ é™¤æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥æœ‰ä¸¤ç§æ“ä½œï¼š</p><ol><li>åœ¨èŠ‚ç‚¹ä¸­ä¿å­˜ä¸€ä¸ªæ ‡å¿—ä½ï¼Œæ ‡è®°è¯¥èŠ‚ç‚¹æ˜¯å¦è¢«åˆ é™¤ï¼Œå¹¶ä¸é’ˆçœŸçš„åˆ é™¤è¯¥ç‚¹ã€‚</li><li>åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶çœŸæ­£åˆ é™¤è¯¥ç‚¹ã€‚</li></ol><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/Notes-Files/blob/master/AndroidLearningResource/java_note/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/tree/RedBlackTree.kt" target="_blank" rel="noopener">ğŸ‘‰ç‚¹è¿™é‡Œ</a>æŸ¥çœ‹æºç </p><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a href="https://sandbox.runjs.cn/show/2nngvn8w" target="_blank" rel="noopener">åœ¨çº¿æ“ä½œçº¢é»‘æ ‘</a></p><p><a href="http://www.cnblogs.com/skywang12345/p/3245399.html#a1" target="_blank" rel="noopener">çº¢é»‘æ ‘(ä¸€)ä¹‹ åŸç†å’Œç®—æ³•è¯¦ç»†ä»‹ç»</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ©ç”¨travisé€šè¿‡Hexoåœ¨Githubä¸Šè‡ªåŠ¨éƒ¨ç½²Markdownæ–‡æ¡£</title>
      <link href="/blog/posts/b00ac86a/"/>
      <url>/blog/posts/b00ac86a/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote><p>æœ¬æ–‡ä»‹ç»äº†ä¸€ä¸ªåªéœ€è¦æ›´æ–°Markdownæ–‡æ¡£åˆ°Githubï¼Œå³å¯å®æ—¶æ›´æ–°åšå®¢å†…å®¹çš„æ–¹æ³•ã€‚</p><p>æœ¬æ–‡å‚è€ƒ<a href="https://juejin.im/post/5a1fa30c6fb9a045263b5d2a" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> å®ç°ï¼Œå¹¶æ ¹æ®æˆ‘çš„éœ€æ±‚æ›´æ”¹äº†éƒ¨åˆ†å†…å®¹ï¼Œä»¥å®ç°<strong>éƒ¨ç½²å¤šä¸ªhexoå·¥ç¨‹åˆ°åŒä¸€Githubé¡¹ç›®ä¸åŒç›®å½•ä¸‹</strong>ã€‚</p></blockquote><p>Githubä¸ºæˆ‘ä»¬æä¾›äº†<a href="https://pages.github.com/" target="_blank" rel="noopener">Github Pages</a> æ–¹ä¾¿æˆ‘ä»¬å»ºç«‹ç®€å•çš„ç½‘é¡µæ¥ä»‹ç»é¡¹ç›®ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ç”¨ä»–æ¥æ­å»ºé™æ€åšå®¢ã€‚</p><p>é€šè¿‡<a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>å¯ä»¥å°†æˆ‘ä»¬å†™çš„<code>Markdownæ–‡æ¡£</code>æ ¼å¼åŒ–ä¸º<code>é™æ€ç½‘é¡µ</code>ï¼Œå†å°†å…¶éƒ¨ç½²åˆ°Githubä¸Šé¢å¯¹åº”çš„<code>user_name.github.io</code>ä¸Šé¢ï¼Œå°±å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªåœ¨çº¿çš„é™æ€åšå®¢ã€‚</p><p>ä½†æ˜¯å—Hexoçš„é™åˆ¶ï¼Œæ¯æ¬¡æ›´æ–°åšå®¢å†…å®¹éƒ½éœ€è¦åœ¨æ›´æ–°å®ŒMarkdownæ–‡æ¡£åï¼Œéƒ½éœ€è¦å†æ¬¡é‡æ–°åˆ›å»ºå¯¹åº”çš„é™æ€ç½‘é¡µã€å°†æ›´æ–°æäº¤åˆ°Githubã€‚è¿™æ ·çš„æ­¥éª¤ç¹çä¸”æ²¡æœ‰æ„ä¹‰ï¼Œè€Œä¸”æ›´æ¢ç”µè„‘åè¿™äº›ç¯å¢ƒéƒ½éœ€è¦é‡æ–°è®¾ç½®ä¸€æ¬¡ã€‚</p><p>é€šè¿‡<a href="https://www.travis-ci.org" target="_blank" rel="noopener">travis</a>æä¾›çš„å…è´¹CIæŠ€æœ¯ï¼Œå¯ä»¥è®©äº‘æœåŠ¡å™¨ä»£æ›¿æˆ‘ä»¬å®ç°Hexoåˆ›å»ºä»¥åŠåŒæ­¥Githubç­‰æ­¥éª¤ï¼Œæ¯æ¬¡æ›´æ–°åšå®¢æ—¶<strong>åªéœ€è¦å°†å†™å¥½çš„Markdownæ–‡æ¡£æ¨é€åˆ°Githubé¡¹ç›®å¯¹åº”ç›®å½•ä¸­ï¼Œç­‰å¾…ä¸€ä¼šå„¿å°±å¯ä»¥çœ‹åˆ°æ›´æ–°åçš„åšå®¢äº†</strong>ã€‚</p><p>å…·ä½“æ­å»ºè¿‡ç¨‹å¯ä»¥å‚è€ƒ<a href="https://juejin.im/post/5a1fa30c6fb9a045263b5d2a" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> æœ¬æ–‡åªè®²è¿°å®ç°<strong>éƒ¨ç½²å¤šä¸ªhexoå·¥ç¨‹åˆ°åŒä¸€Githubé¡¹ç›®ä¸åŒç›®å½•ä¸‹</strong>éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼šã€‚</p><blockquote><p><strong>æ‡’â€”â€”æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›</strong></p></blockquote><h1 id="å…·ä½“å·®å¼‚"><a href="#å…·ä½“å·®å¼‚" class="headerlink" title="å…·ä½“å·®å¼‚"></a>å…·ä½“å·®å¼‚</h1><h2 id="hexoåˆ†æ”¯çš„ç»“æ„"><a href="#hexoåˆ†æ”¯çš„ç»“æ„" class="headerlink" title="hexoåˆ†æ”¯çš„ç»“æ„"></a>hexoåˆ†æ”¯çš„ç»“æ„</h2><p>å› ä¸ºæœ‰å¤šä¸ªhexoé¡¹ç›®ï¼Œæ‰€ä»¥åœ¨githubé¡¹ç›®çš„hexoåˆ†æ”¯ä¸‹ï¼Œå¯¹ä¸åŒçš„hexoé¡¹ç›®åˆ†åˆ«æ–°å»ºæ–‡ä»¶å¤¹å­˜æ”¾ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- your_name.github.io //githubé¡¹ç›®ï¼Œåˆ‡æ¢åˆ°hexoåˆ†æ”¯</span><br><span class="line">  --hexo_project1 //æœ¬åœ°hexoé¡¹ç›®1çš„æ‰€æœ‰æ–‡ä»¶</span><br><span class="line">  --hexo_project2 //æœ¬åœ°hexoé¡¹ç›®2çš„æ‰€æœ‰æ–‡ä»¶</span><br></pre></td></tr></table></figure><h2 id="travis-yml"><a href="#travis-yml" class="headerlink" title=".travis.yml"></a>.travis.yml</h2><p>é‡ç‚¹ä¿®æ”¹<code>script:</code>å’Œ<code>after_script:</code>ä¸¤éƒ¨åˆ†ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="comment"># 1. åˆ›å»ºå¯¹åº”çš„é™æ€åšå®¢å†…å®¹</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">blog</span> <span class="comment"># ç¬¬ä¸€ä¸ªæœ¬åœ°hexoé¡¹ç›®</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">imissyou</span> <span class="comment"># ç¬¬äºŒä¸ªæœ¬åœ°hexoé¡¹ç›®</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">"jixiaoyong"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="string">"jixiaoyong1995@gmail.com"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mkdir</span> <span class="string">publish</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">publish</span></span><br><span class="line">  <span class="comment"># 2. åœ¨è¿™é‡Œå†æ‹‰å–masteråˆ†æ”¯çš„æ–‡ä»¶ï¼Œå¹¶åˆ é™¤æ—§çš„åšå®¢å†…å®¹</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://$&#123;GH_TOKEN&#125;@github.com/jixiaoyong/jixiaoyong.github.io.git</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">./jixiaoyong.github.io/blog/*</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">./jixiaoyong.github.io/imissyou/*</span></span><br><span class="line">   <span class="comment"># 3. å°†ç¬¬1æ­¥ç”Ÿæˆçš„é™æ€åšå®¢å†…å®¹æ·»åŠ åˆ°masteråˆ†æ”¯ï¼Œå¹¶åŒæ­¥åˆ°githubä¸Šé¢</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cp</span> <span class="string">-rf</span> <span class="string">jixiaoyong.github.io/blog/public/*</span> <span class="string">publish/jixiaoyong.github.io/blog/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cp</span> <span class="string">-rf</span> <span class="string">jixiaoyong.github.io/imissyou/public/*</span> <span class="string">publish/jixiaoyong.github.io/imissyou/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">publish/jixiaoyong.github.io/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">add</span> <span class="string">.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">commit</span> <span class="string">-m</span> <span class="string">"auto update by www.travis-ci.org"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">push</span></span><br></pre></td></tr></table></figure><p>æ–‡æ¡£é“¾æ¥ï¼š<a href="https://github.com/jixiaoyong/jixiaoyong.github.io/blob/hexo_blog/.travis.yml" target="_blank" rel="noopener">.travis.yml</a></p><h1 id="æ›´æ–°åšå®¢å†…å®¹"><a href="#æ›´æ–°åšå®¢å†…å®¹" class="headerlink" title="æ›´æ–°åšå®¢å†…å®¹"></a>æ›´æ–°åšå®¢å†…å®¹</h1><p>å½“ä»¥ä¸Šå†…å®¹éƒ½é…ç½®å®Œæˆåï¼Œåªè¦æ–°å»ºä¸€ä¸ªç¬¦åˆhexoè¦æ±‚çš„æ–‡æ¡£ï¼Œå¹¶æäº¤åˆ°Githubå¯¹åº”é¡¹ç›®çš„hexoåˆ†æ”¯ä¸­<code>source</code>ç›®å½•ï¼ŒTravisä¾¿ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºå¹¶æ›´æ–°é™æ€ç½‘é¡µã€‚</p><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a href="https://juejin.im/post/5a1fa30c6fb9a045263b5d2a" target="_blank" rel="noopener">Hexoé‡ä¸ŠTravis-CIï¼šå¯èƒ½æ˜¯æœ€é€šä¿—æ˜“æ‡‚çš„è‡ªåŠ¨å‘å¸ƒåšå®¢å›¾æ–‡æ•™ç¨‹</a> ï¼ˆå®Œå…¨åœ¨è¯¥æ–‡æ¡£æŒ‡å¯¼ä¸‹å®Œæˆï¼Œéƒ¨åˆ†æ­¥éª¤æœ‰å·®å¼‚ï¼Œæ„Ÿè°¢ä½œè€…<a href="https://juejin.im/user/56efe6461ea493005565dafd" target="_blank" rel="noopener">MichaelX</a> ï¼‰</p>]]></content>
      
      
      
        <tags>
            
            <tag> ci </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidè¿è¡Œæ—¶æƒé™</title>
      <link href="/blog/posts/a2863875/"/>
      <url>/blog/posts/a2863875/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>æœ¬æ–‡ä»‹ç»äº†Androidè¿è¡Œæ—¶æƒé™çš„ä¸€äº›å¤„ç†æµç¨‹ã€‚</p><p>Androidè¿è¡Œæ—¶æƒé™æ˜¯Android6ä¹‹åå‡ºç°çš„å¤„ç†æƒé™çš„æ–°æ–¹å¼ï¼Œæ­¤å‰å¼€å‘è€…åªéœ€è¦åº”ç”¨éœ€è¦çš„æƒé™åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­å£°æ˜å³å¯ï¼Œç°åœ¨åˆ™éœ€è¦åœ¨ä½¿ç”¨åˆ°å¯¹åº”æƒé™æ—¶æ£€æµ‹æ˜¯å¦æœ‰è¯¥æƒé™å¹¶ä½œå‡ºç›¸åº”å¤„ç†ã€‚</p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="ä¸€èˆ¬æµç¨‹"><a href="#ä¸€èˆ¬æµç¨‹" class="headerlink" title="ä¸€èˆ¬æµç¨‹"></a>ä¸€èˆ¬æµç¨‹</h2><ol><li><p>åœ¨<code>AndroidManifest.xml</code>ä¸­å£°æ˜æ‰€éœ€æƒé™</p></li><li><p>åœ¨ä½¿ç”¨ä¹‹å‰æ£€æŸ¥æ˜¯å¦æœ‰è¯¥æƒé™<code>checkSelfPermission()</code>,å¦‚æœæœ‰åˆ™ç»§ç»­ç›¸åº”æ“ä½œ</p></li><li><p>å¦‚æœæ²¡æœ‰æƒé™åˆ™æ£€æµ‹æ˜¯å¦éœ€è¦å‘ç”¨æˆ·è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è¯¥æƒé™<code>ActivityCompat.shouldShowRequestPermissionRationale()</code>ï¼Œå†å†³å®šå¦‚ä½•ç”³è¯·æƒé™<code>requestPermissions()</code></p><blockquote><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒshouldShowRequestPermissionRationale()åœ¨ç¬¬ä¸€æ¬¡ç”³è¯·è¯¥æƒé™æ—¶ä¼šè¿”å›falseï¼Œç¬¬äºŒæ¬¡ç”³è¯·æ—¶è¿”å›trueï¼›</p><p>ä½†æ˜¯å¦‚æœç”¨æˆ·é€‰æ‹©äº†<em>ä¸å†æé†’</em> åˆ™ä¼šä¸€ç›´è¿”å›falseã€‚æ‰€ä»¥å¦‚æœåˆ¤æ–­å½“å‰å¹¶éç¬¬ä¸€æ¬¡ç”³è¯·è¯¥æƒé™ï¼Œå¹¶ä¸”è¿”å›ç»“æœä¸ºfalseï¼Œå°±è¯´æ˜ç”¨æˆ·é€‰æ‹©äº†ä¸å†æç¤ºï¼Œä¸€èˆ¬å°±éœ€è¦æç¤ºç”¨æˆ·åˆ°è®¾ç½®ä¸­å¼€å¯å¯¹åº”æƒé™ã€‚</p></blockquote></li><li><p>ç”³è¯·æƒé™çš„ç»“æœåœ¨<code>onRequestPermissionsResult()</code>æ–¹æ³•ä¸­è¿”å›ï¼Œæ ¹æ®ç”¨æˆ·å¯¹æƒé™çš„å¤„ç†ç»“æœå†³å®šæ¥ä¸‹æ¥çš„æ“ä½œ</p></li></ol><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p><code>onCreate()</code>æ–¹æ³•ä¸­è°ƒç”¨å¯¹åº”æ–¹æ³•</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mSharedPreferences = getSharedPreferences(packageName, Context.MODE_PRIVATE)</span><br><span class="line">checkCameraDeviceAndPremissions()</span><br></pre></td></tr></table></figure><p><code>checkCameraDeviceAndPremissions()</code>å…·ä½“å†…å®¹</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkCameraDeviceAndPremissions</span><span class="params">()</span></span> &#123;</span><br><span class="line">     ...</span><br><span class="line">    <span class="comment">//[2]æ¯æ¬¡ä½¿ç”¨ä¹‹å‰æ£€æµ‹æ˜¯å¦æœ‰æ”¹æƒé™</span></span><br><span class="line">        <span class="keyword">if</span> (checkSelfPermission(Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            safeRequestCameraPermission()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            safeOpenCamera(cameraId)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯¹ç”³è¯·ç»“æœè¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRequestPermissionsResult</span><span class="params">(requestCode: <span class="type">Int</span>, permissions: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">String</span>&gt;, grantResults: <span class="type">IntArray</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (requestCode) &#123;</span><br><span class="line">            <span class="comment">//[4]å¤„ç†è¯·æ±‚æƒé™çš„ç»“æœ</span></span><br><span class="line">            REQUEST_CAMERA -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                    safeOpenCamera(cameraId)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">var</span> noCameraPermissionDialog = AlertDialog.Builder(<span class="keyword">this</span><span class="symbol">@MainActivity</span>)</span><br><span class="line">                        .setTitle(<span class="string">"è­¦å‘Šâš ï¸"</span>)</span><br><span class="line">                        .setMessage(<span class="string">"æ²¡æœ‰ç›¸æœºæƒé™ï¼Œä¸å¯ç»§ç»­ï¼\nè¯·èµ‹äºˆç›¸æœºæƒé™"</span>)</span><br><span class="line">                        .setCancelable(<span class="literal">false</span>)</span><br><span class="line">                        .setPositiveButton(<span class="string">"Yes"</span>) &#123; _, _ -&gt;</span><br><span class="line">                            safeRequestCameraPermission()</span><br><span class="line">                        &#125;</span><br><span class="line">                        .setNegativeButton(<span class="string">"No"</span>) &#123; _, _ -&gt; finish() &#125;</span><br><span class="line">                        .create()</span><br><span class="line">                    noCameraPermissionDialog.show()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>safeRequestCameraPermission()</code>çš„å†…å®¹ï¼Œè¿™é‡Œæ‰æ˜¯å¤„ç†ç”³è¯·æƒé™çš„ç›¸å…³ä»£ç </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">safeRequestCameraPermission</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//[3]æ£€æµ‹æ˜¯å¦éœ€è¦è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦æ”¹æƒé™</span></span><br><span class="line">    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(<span class="keyword">this</span>, Manifest.permission.CAMERA)) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ä¸ºfalse</span></span><br><span class="line"><span class="comment">         * ç¬¬äºŒæ¬¡è¯·æ±‚æ—¶ä¸ºtrueï¼Œéœ€è¦è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæƒé™</span></span><br><span class="line"><span class="comment">         * è‹¥ç”¨æˆ·é€‰æ‹©äº†ä¸å†æç¤ºåˆ™ä¸€ç›´ä¸ºfalse</span></span><br><span class="line"><span class="comment">         * ç»¼ä¸Šï¼Œå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚è¯¥æƒé™ï¼Œå¹¶ä¸”è¿”å›å€¼ä¸ºfalseï¼Œé‚£ä¹ˆå¯ä»¥åˆ¤æ–­ç”¨æˆ·é€‰æ‹©äº†ä¸å†æç¤º</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//å‘ç”¨æˆ·è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦æ”¹æƒé™</span></span><br><span class="line">        <span class="keyword">var</span> noCameraDialog = AlertDialog.Builder(<span class="keyword">this</span><span class="symbol">@MainActivity</span>)</span><br><span class="line">            .setTitle(<span class="string">"æç¤ºï¸"</span>)</span><br><span class="line">            .setMessage(<span class="string">"æœ¬åº”ç”¨æ­£å¸¸è¿è¡Œéœ€è¦ç›¸æœºæƒé™ï¼Œç‚¹å‡»ç¡®è®¤å¼€å§‹èµ‹äºˆæƒé™"</span>)</span><br><span class="line">            .setCancelable(<span class="literal">false</span>)</span><br><span class="line">            .setPositiveButton(<span class="string">"Yes"</span>) &#123; _, _ -&gt;</span><br><span class="line">                <span class="comment">//ç”¨æˆ·åŒæ„åå¼€å§‹ç”³è¯·æƒé™</span></span><br><span class="line">                doRequestCameraPermission()</span><br><span class="line">            &#125;</span><br><span class="line">            .create()</span><br><span class="line">        noCameraDialog.show()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.d(<span class="string">"TAG"</span>, <span class="string">"count "</span> + mSharedPreferences.getInt(KEY_COUNT_REQUEST_CAMERA_PERMISSION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">if</span> (mSharedPreferences.getInt(KEY_COUNT_REQUEST_CAMERA_PERMISSION, <span class="number">0</span>) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//TODO ç”¨æˆ·æ‹’ç»äº†èµ‹äºˆæƒé™ï¼Œå¹¶ä¸”é€‰æ‹©äº†â€œä¸å†æé†’â€ï¼Œæç¤ºç”¨æˆ·åˆ°è®¾ç½®ä¸­å¼€å¯</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            doRequestCameraPermission()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">doRequestCameraPermission</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//æ¯æ¬¡ç”³è¯·æƒé™æ—¶æ›´æ–°è®¡æ•°å™¨</span></span><br><span class="line">    <span class="keyword">var</span> count = mSharedPreferences.getInt(KEY_COUNT_REQUEST_CAMERA_PERMISSION, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    mSharedPreferences.edit().putInt(KEY_COUNT_REQUEST_CAMERA_PERMISSION, count).apply()</span><br><span class="line">    requestPermissions(arrayOf(Manifest.permission.CAMERA), REQUEST_CAMERA)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><p>æ ·ä¾‹ä»£ç : <a href="https://github.com/jixiaoyong/Notes-Files/commit/f41afa99c24cde1dab619462754435f2a2afc64e#diff-67ccb5e5c6c34760486a1071b23338a2" target="_blank" rel="noopener">Github</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä¸­çš„æ³›å‹</title>
      <link href="/blog/posts/b2cdb69e/"/>
      <url>/blog/posts/b2cdb69e/</url>
      
        <content type="html"><![CDATA[<p>Javaä¸­çš„æ³›å‹å®ç°äº†<strong>å‚æ•°ç±»å‹åŒ–</strong>çš„æ¦‚å¿µã€‚</p><p>ä¸»è¦æœ‰ä»¥ä¸‹å½¢å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OneClazz</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    T t;</span><br><span class="line">    &lt;Y&gt; <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡ä¸»è¦è®°å½•Javaæ³›å‹ä¸€äº›æ¯”è¾ƒç‰¹æ®Šçš„çŸ¥è¯†ç‚¹ã€‚</p><h1 id="æ³›å‹ç‰¹æ€§"><a href="#æ³›å‹ç‰¹æ€§" class="headerlink" title="æ³›å‹ç‰¹æ€§"></a>æ³›å‹ç‰¹æ€§</h1><p>æ³›å‹åœ¨Java SE5è¢«å¼•å…¥ï¼Œå¯ä»¥åœ¨ç±»å’Œæ–¹æ³•ä¸­ï¼Œå°†ç±»å‹ä½œä¸ºç±»å‹å‚æ•°ä¼ å…¥ã€‚</p><p>æ³›å‹ç±»å‹å‚æ•°ä¼šåœ¨å®é™…è¿è¡Œæ—¶è¢«<strong>æ“¦é™¤</strong>åˆ°ä»–çš„ç¬¬ä¸€ä¸ªè¾¹ç•Œã€‚å¦‚<code>&lt;T&gt;</code>ä¼šè¢«æ“¦é™¤ä¸º<code>Objet</code>ï¼Œè€Œ<code>&lt;T extends ClazzA&gt;</code>åˆ™ä¼šè¢«æ“¦é™¤ä¸º<code>ClazzA</code>ã€‚</p><h1 id="éœ€è¦æ³¨æ„çš„åœ°æ–¹"><a href="#éœ€è¦æ³¨æ„çš„åœ°æ–¹" class="headerlink" title="éœ€è¦æ³¨æ„çš„åœ°æ–¹"></a>éœ€è¦æ³¨æ„çš„åœ°æ–¹</h1><h2 id="ä¸èƒ½æœ‰æ³›å‹æ•°ç»„"><a href="#ä¸èƒ½æœ‰æ³›å‹æ•°ç»„" class="headerlink" title="ä¸èƒ½æœ‰æ³›å‹æ•°ç»„"></a>ä¸èƒ½æœ‰æ³›å‹æ•°ç»„</h2><p>è¿™æ˜¯å› ä¸ºJavaä¸­Object[]é»˜è®¤ä¸ºæ‰€æœ‰æ•°ç»„çš„çˆ¶ç±»ï¼Œå¦‚ä¸‹ä»£ç è™½ç„¶åœ¨ç¼–è¯‘æœŸä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ä¼šè¢«æ£€æŸ¥å‡ºobjArræŒ‡å‘çš„æ•°ç»„å®é™…ç±»å‹ï¼ˆStringï¼‰å’Œè¦èµ‹äºˆçš„ç±»å‹ï¼ˆIntegerï¼‰ä¸ä¸€è‡´è€ŒæŠ¥é”™ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°ç»„åªèƒ½å­˜æ”¾<strong>å®šä¹‰çš„å®é™…ç±»å‹</strong>ä»¥åŠä»–ä»¬çš„<strong>å­ç±»å‹</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object[] objArr = <span class="keyword">new</span> String[<span class="number">10</span>];</span><br><span class="line">objArr[<span class="number">0</span>] = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œå¦‚æœæ”¯æŒæ³›å‹æ•°ç»„ï¼šç”±äºæ³›å‹ç±»å‹å‚æ•°ä¼šåœ¨è¿è¡Œæ—¶è¢«æ“¦é™¤ï¼Œå¯¼è‡´å³ä½¿åˆ°äº†è¿è¡Œæ—¶ä¹Ÿæ— æ³•å‘ç°è¿™ä¸ªé”™è¯¯ï¼Œä»è€Œä¼šå¯¼è‡´é”™è¯¯ã€‚</p><p>å¦‚ä¸‹ï¼ŒåŠ å…¥æ”¯æŒæ³›å‹å‚æ•°ï¼Œåˆ™objArr1ä¸­å®é™…ä¿å­˜çš„ç±»å‹ï¼ˆMap&lt;String,Integer&gt;ï¼‰ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ç”±äºobjArr1å’ŒobjArr2éƒ½æ˜¯Objectç±»å‹çš„æ•°ç»„ï¼Œç¼–è¯‘é€šè¿‡ï¼›åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œç”±äºMapä¸­çš„æ³›å‹å‚æ•°ç±»å‹å·²ç»è¢«æ“¦é™¤ï¼Œä¹Ÿæ— æ³•åŒºåˆ†objArr1å’ŒobjArr2ä¸­å®é™…æŒ‡å‘çš„ä¸¤ä¸ªMap&lt;K,V&gt;æ•°ç»„ï¼Œä¹Ÿæ˜¯åˆæ³•çš„ï¼Œè¿™æ ·åŸæœ¬å®šä¹‰çš„æ˜¯Map&lt;String,Integer&gt;æ•°ç»„ï¼Œå´å¯ä»¥ä¿å­˜ä»»ä½•ç±»ä¼¼çš„Mapï¼Œè€Œè¿™æœ¬æ¥æ˜¯ä¸å…è®¸çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object[] objArr1 = <span class="keyword">new</span> Map&lt;String,Integer&gt;[<span class="number">10</span>];</span><br><span class="line">Object[] objArr2 = <span class="keyword">new</span> Map&lt;Double,Integer&gt;[<span class="number">10</span>];</span><br><span class="line">objArr1[<span class="number">0</span>] = objArr2[<span class="number">0</span>];</span><br></pre></td></tr></table></figure><blockquote><p>Collections ç±»é€šè¿‡ä¸€ç§åˆ«æ‰­çš„æ–¹æ³•ç»•è¿‡äº†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ Collections ç±»ç¼–è¯‘æ—¶ä¼šäº§ç”Ÿç±»å‹æœªæ£€æŸ¥è½¬æ¢çš„è­¦å‘Šã€‚</p><p><code>ArrayList</code>å…·ä½“å®ç°çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line">&gt;     <span class="keyword">private</span> V[] backingArray;</span><br><span class="line">&gt;     <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span></span>&#123;</span><br><span class="line">&gt;         backingArray = (V[])<span class="keyword">new</span> Object()[DEFAULT_SIZE];</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>ä¸ºä½•è¿™äº›ä»£ç åœ¨è®¿é—® <code>backingArray</code>æ—¶æ²¡æœ‰äº§ç”Ÿ <code>ArrayStoreException</code>å‘¢ï¼Ÿæ— è®ºå¦‚ä½•ï¼Œéƒ½ä¸èƒ½å°† <code>Object</code>æ•°ç»„èµ‹ç»™ <code>String</code>æ•°ç»„ã€‚å› ä¸ºæ³›å‹æ˜¯é€šè¿‡æ“¦é™¤å®ç°çš„ï¼Œ<code>backingArray</code>çš„ç±»å‹å®é™…ä¸Šå°±æ˜¯ <code>Object[]</code>ï¼Œå› ä¸º <code>Object</code>ä»£æ›¿äº† <code>V</code>ã€‚</p><p><strong>è¿™æ„å‘³ç€ï¼šå®é™…ä¸Šè¿™ä¸ªç±»æœŸæœ› <code>backingArray</code>æ˜¯ä¸€ä¸ª <code>Object</code>æ•°ç»„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨è¦è¿›è¡Œé¢å¤–çš„ç±»å‹æ£€æŸ¥ï¼Œä»¥ç¡®ä¿å®ƒåŒ…å« <code>V</code>ç±»å‹çš„å¯¹è±¡ã€‚</strong></p><p>æ¥æºï¼š<a href="https://www.ibm.com/developerworks/cn/java/j-jtp01255.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-jtp01255.html</a></p></blockquote><h1 id="æ³›å‹å®¹å™¨"><a href="#æ³›å‹å®¹å™¨" class="headerlink" title="æ³›å‹å®¹å™¨"></a>æ³›å‹å®¹å™¨</h1><p>ç”±äºæ³›å‹çš„ç±»å‹åœ¨è¿è¡Œæ—¶ä¼šè¢«æ“¦é™¤ï¼Œæ‰€ä»¥å°†ç±»å‹æ£€æŸ¥æ”¾åˆ°äº†ç¼–è¯‘æœŸã€‚</p><p><code>List&lt;Clazz&gt;</code> æ³›å‹åˆ—è¡¨åªèƒ½ä¿å­˜æŒ‡å®šæ³›å‹ç±»å‹<code>T</code>çš„æ•°æ®ï¼Œè€Œä¸èƒ½ä¿å­˜å…¶å­ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fruit</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">extends</span> <span class="title">Fruit</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jonathan</span> <span class="keyword">extends</span> <span class="title">Apple</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">//ç¼–è¯‘æ—¶æŠ¥é”™ï¼Œç±»å‹ä¸å…¼å®¹</span></span><br><span class="line">List&lt;Fruit&gt; fruits = <span class="keyword">new</span> ArrayList&lt;Apple&gt;();</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯èƒ½ä¿å­˜Fruitçš„å®¹å™¨åº”è¯¥ä¹Ÿè¦èƒ½å®‰å…¨çš„ä¿å­˜Appleï¼Œä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œç±»ä¼¼äºæ•°ç»„ä¸­<code>Object[] arr = Apple[]</code>çš„å‘ä¸Šè½¬å‹ï¼Œå¯ä»¥ä½¿ç”¨<code>?</code>å¼•å…¥åå˜ã€‚</p><h2 id="åå˜"><a href="#åå˜" class="headerlink" title="åå˜"></a>åå˜</h2><p><code>List&lt;? extends T&gt;</code> å¯ä»¥<strong>åˆæ³•çš„æŒ‡å‘ä¸€ä¸ª<code>List&lt; SubT&gt;</code></strong>ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå®Œæˆè‡ªåŠ¨<strong>å‘ä¸Šè½¬å‹</strong>ï¼Œæˆä¸ºå¯ä»¥æŒæœ‰<strong>æŸä¸ªè¯¸å¦‚Tæˆ–è€…Tçš„å­ç±»</strong>çš„Listï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¸çŸ¥é“è¿™ä¸ª<strong>ç±»</strong>å…·ä½“æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥æ‹’ç»å‘å…¶ä¸­ä¼ é€’ä»»ä½•ç±»å‹å¯¹è±¡ï¼Œå³ä½¿Objectä¹Ÿä¸è¡Œã€‚</p><p>å¯ä»¥è¿™ä¹ˆæƒ³ï¼Œ<code>&lt;? extends T&gt;</code>è¡¨ç¤ºçš„æ˜¯Tçš„å­ç±»ï¼Œé‚£ä¹ˆ<code>List&lt;? extends T&gt;</code> ä¿å­˜çš„ä¾¿æ˜¯<strong>Tçš„æŸä¸ªå­ç±»</strong>ï¼Œæ‰€ä»¥ä¸èƒ½ä¿å­˜Objectæˆ–è€…Tç­‰ç±»å‹ï¼Œåˆç”±äºåˆ—è¡¨ä¸èƒ½ä¿å­˜ä¸åŒçš„ç±»å‹ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ä¿å­˜ä»»ä½•Tçš„å­ç±»,å³å®¹å™¨å°†æ•°ç»„åœ¨è¿è¡Œæ—¶æ‰ä¼šæœ‰çš„ç±»å‹æ£€æŸ¥æ”¾åˆ°äº†ç¼–è¯‘æœŸï¼ˆåŸå› æ˜¯è¿è¡Œæ—¶ç±»å‹ä¼šè¢«æ“¦é™¤ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;? extends Fruit&gt; fruits = <span class="keyword">new</span> ArrayList&lt;Apple&gt;();<span class="comment">//å¯ä»¥å®‰å…¨çš„åº”ç”¨</span></span><br><span class="line">fruits2.add(<span class="keyword">new</span> Apple());<span class="comment">//ç¼–è¯‘æ—¶æŠ¥é”™ï¼Œç±»å‹è½¬åŒ–é”™è¯¯</span></span><br><span class="line">fruits2.add(<span class="keyword">new</span> Fruit());<span class="comment">//ç¼–è¯‘æ—¶æŠ¥é”™</span></span><br></pre></td></tr></table></figure><h2 id="é€†å˜"><a href="#é€†å˜" class="headerlink" title="é€†å˜"></a>é€†å˜</h2><p><code>List&lt;? super T&gt;</code> <strong>ä¸»åŠ¨å£°æ˜</strong>é€šé…ç¬¦<code>?</code>çš„è¶…ç±»å‹ä¸º<code>T</code>,å³Listä¿å­˜çš„æ˜¯<strong>Tçš„æŸä¸ªçˆ¶ç±»</strong>ï¼Œé‚£ä¹ˆListä¹Ÿå¯ä»¥å®‰å…¨çš„ä¿å­˜<strong>Tæˆ–è€…Tçš„å­ç±»</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(List&lt;? <span class="keyword">super</span> Apple&gt; apples)</span></span>&#123;</span><br><span class="line">    apples.add(<span class="keyword">new</span> Apple());</span><br><span class="line">    apples.add(<span class="keyword">new</span> Jonathan());</span><br><span class="line">    apples.add(<span class="keyword">new</span> Fruit());<span class="comment">//error ç±»å‹é”™è¯¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.zhihu.com/question/20928981/answer/39234969" target="_blank" rel="noopener">javaä¸ºä»€ä¹ˆä¸æ”¯æŒæ³›å‹æ•°ç»„ï¼Ÿ - ylxfcçš„å›ç­” - çŸ¥ä¹</a></p><p><a href="https://www.oracle.com/technetwork/cn/articles/java/juneau-generics-2255374-zhs.html" target="_blank" rel="noopener">Oracle Java æ³›å‹åŸç†</a></p><p><a href="https://www.ibm.com/developerworks/cn/java/j-jtp01255.html" target="_blank" rel="noopener">Java ç†è®ºå’Œå®è·µ-äº†è§£æ³›å‹-è¯†åˆ«å’Œé¿å…å­¦ä¹ ä½¿ç”¨æ³›å‹è¿‡ç¨‹ä¸­çš„é™·é˜±</a></p><p><a href="https://www.jianshu.com/p/2bf15c5265c5" target="_blank" rel="noopener">Javaæ³›å‹ï¼ˆäºŒï¼‰ åå˜ä¸é€†å˜</a></p><p>ã€ŠJavaç¼–ç¨‹æ€æƒ³ ç¬¬4ç‰ˆã€‹</p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter Widgetç®€å•å…¥é—¨</title>
      <link href="/blog/posts/e35c106d/"/>
      <url>/blog/posts/e35c106d/</url>
      
        <content type="html"><![CDATA[<p>Flutteræ˜¯Googleæå‡ºçš„è·¨å¹³å°å¼€å‘æ¡†æ¶ï¼Œä½¿ç”¨Dartè¯­è¨€ï¼Œæ”¯æŒAndroidï¼ŒIOSç³»ç»Ÿã€‚Flutterä¸€ä¸ªé‡è¦çš„æ¦‚å¿µå³æ˜¯â€”â€”<em>â€œä¸‡ç‰©çš†æ§ä»¶ï¼ˆWidgetï¼‰â€</em>ï¼Œåƒ<code>Padding</code>,<code>Center</code>ç­‰éƒ½æ˜¯Widgetã€‚</p><p>Widgetå’ŒAndroidä¸­çš„Viewå¾ˆç›¸ä¼¼ä½†åˆæœ‰ä¸åŒï¼ŒWidgetä¸€æ—¦ç”Ÿæˆä¾¿â€œä¸€æˆä¸å˜â€ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡å› ä¸ºWidgetæ›´æ”¹æˆ–è€…stateæ›´æ–°è€Œè¢«é‡æ–°åˆ›å»ºï¼ˆFlutterâ€™s framework creates a new tree of widget instances.ï¼‰ï¼Œè€ŒViewåˆ™åªä¼šè¢«<code>drawn</code>ä¸€æ¬¡ï¼Œç›´åˆ°<code>invalidate</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚</p><p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹Flutterä¸­ä¸¤ä¸ªé‡è¦çš„æ§ä»¶ï¼šStatelessWidgetå’ŒStatefulWidgetï¼Œä»¥åŠFlutterå¼€å‘çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚</p><h1 id="FlutteråŸºç¡€çŸ¥è¯†"><a href="#FlutteråŸºç¡€çŸ¥è¯†" class="headerlink" title="FlutteråŸºç¡€çŸ¥è¯†"></a>FlutteråŸºç¡€çŸ¥è¯†</h1><p>Flutterä»¥Dartå¼€å‘ï¼Œå…¶å·¥ç¨‹åŸºæœ¬çš„ç»“æ„å¦‚ä¸‹ï¼š</p><ul><li>android</li><li>ios</li><li>lib<ul><li>main.dart</li></ul></li><li>pubspec.yaml //Flutterå·¥ç¨‹çš„é…ç½®ä¿¡æ¯</li></ul><p>Flutteré¡¹ç›®å¯åŠ¨åä¼šé¦–å…ˆåŠ è½½<code>/lib/main.dart</code>ä¸­çš„<code>main()</code>æ–¹æ³•ã€‚<br>ä¸€ä¸ªæ ‡å‡†çš„material appçš„main.dartå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./product_manager.dart'</span>;</span><br><span class="line"></span><br><span class="line">main() =&gt; runApp(MyApp());<span class="comment">//åœ¨main()æ–¹æ³•ä¸­è°ƒç”¨äº†materialçš„runApp()æ–¹æ³•ï¼Œé‡Œé¢ä¼ å…¥äº†è¦å±•ç¤ºçš„Widgetâ€”â€”APPçš„ç•Œé¢ï¼Œç›¸å½“äºAndroidçš„setContentView()</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.deepOrange</span><br><span class="line">      ),</span><br><span class="line">      home: Scaffold(<span class="comment">//è„šæ‰‹æ¶ï¼Œä¸€ä¸ªé¢„åˆ¶çš„APPç•Œé¢ç»“æ„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰Widget</span></span><br><span class="line">        appBar: AppBar(</span><br><span class="line">          title: Text(<span class="string">"EasyList"</span>),</span><br><span class="line">        ),</span><br><span class="line">        body: ProductManager(<span class="string">"Test"</span>),<span class="comment">//è¿™é‡Œæ˜¯è‡ªå®šä¹‰çš„æ§ä»¶ï¼Œå¸ƒå±€ä¿¡æ¯ä¸»è¦åœ¨è¿™é‡Œå±•ç¤º</span></span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="StatelessWidget-amp-StatefulWidget"><a href="#StatelessWidget-amp-StatefulWidget" class="headerlink" title="StatelessWidget &amp; StatefulWidget"></a>StatelessWidget &amp; StatefulWidget</h1><p>StatelessWidgetå’ŒStateFulWidgetåŒºåˆ«åœ¨äºï¼šå‰è€…ä¸€æ—¦åˆ›å»ºï¼ŒçŠ¶æ€ä¾¿ä¸ä¼šå†æ›´æ”¹ï¼Œè€Œåè€…åˆ™å¯ä»¥åŠ¨æ€æ”¹å˜Stateä»è€Œä½¿flutteræ”¹å˜å…¶çŠ¶æ€ã€‚ä½†æ˜¯ä¸¤è€…éƒ½ä¼šåœ¨æ¯ä¸€å¸§è¢«rebuildã€‚</p><h2 id="StatelessWidget"><a href="#StatelessWidget" class="headerlink" title="StatelessWidget"></a>StatelessWidget</h2><blockquote><p>A <code>StatelessWidget</code> is just what it sounds likeâ€”a widget with no state information.</p></blockquote><p>StatelessWidgetä¸€æ—¦åˆ›å»ºä¾¿ä¸ä¼šæ›´æ”¹ï¼Œå…¶çŠ¶æ€åªå’Œæ„é€ å‡½æ•°ä¸­çš„å‚æ•°æœ‰å…³ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªStatelessWidgetç¤ºä¾‹ï¼Œä¸€èˆ¬åªéœ€è¦é‡å†™å…¶build()æ–¹æ³•ï¼Œè¿”å›è¦å±•ç¤ºçš„æ§ä»¶å³å¯ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWidget</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> CustomerWidget();<span class="comment">//åœ¨è¿™é‡Œæ„å»ºä¸€ä¸ªé¡µé¢å¹¶è¿”å›</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="StatefulWidget"><a href="#StatefulWidget" class="headerlink" title="StatefulWidget"></a>StatefulWidget</h2><blockquote><p><code>StatefulWidget</code> has a <code>State</code> object that stores state data across frames and restores it.</p></blockquote><p>StatefulWidgetå¯ä»¥é€šè¿‡åŠ¨æ€æ›´æ”¹å…¶åŒ…å«çš„Stateï¼Œä»è€Œä½¿flutteråœ¨ä¸‹ä¸€æ¬¡æ›´æ–°ç•Œé¢æ—¶ä¾æ®stateæ›´æ–°StateWidgetï¼Œ<em>æœ¬è´¨ä¸Šè¿˜æ˜¯æ›´æ–°äº†ä¸€ä¸ªå¯ä»¥åœ¨å¤šå¸§ä¹‹é—´å­˜æ´»çš„Stateï¼Œåœ¨ä¸‹ä¸€å¸§æ›´æ–°æ§ä»¶</em>ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªStatefulWidgetçš„ç¤ºä¾‹:</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductManager</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;StatefulWidget&gt; createState() &#123;</span><br><span class="line">    <span class="keyword">return</span> ProductManagerState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductManagerState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ProductManager</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> CustomerWidget();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°StatefulWidgeté‡å†™äº†<code>createState()</code>ï¼Œè€Œè¯¥æ–¹æ³•è¿”å›äº†è‡ªå®šä¹‰çš„<code>ProductManagerState</code>ç±»å¯¹è±¡ï¼Œåœ¨è¯¥ç±»ä¸­<code>build()</code>æ–¹æ³•å®ç°å’ŒStatelessWidgetä¸­çš„æ–¹æ³•ç±»ä¼¼ï¼Œè¿”å›è¦å±•ç¤ºçš„é¡µé¢æ§ä»¶ã€‚</p><p>ä¸¤è€…çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒStatefulWidgetä¸­å¯ä»¥è°ƒç”¨<code>setState()</code>ï¼Œæ›´æ”¹å…¶ç›¸åº”çš„<code>state</code>ï¼Œä»¥ä¾¿å‘Šè¯‰flutteråœ¨ä¸‹ä¸€æ¬¡rebuildçš„æ—¶å€™æ›´æ–°UIã€‚</p><p>StatelessWidgetè¦æƒ³å®ç°åŠ¨æ€æ›´æ–°å…¶å†…å®¹ï¼Œå¯ä»¥åœ¨å…¶å¤–éƒ¨åŒ…è£¹ä¸€å±‚StatefulWidgetï¼Œé€šè¿‡StatefulWidgetæ›´æ”¹çŠ¶æ€stateï¼Œå°†æ›´æ”¹åçš„stateä¼ ç»™StatelessWidgetï¼Œä»è€Œé—´æ¥æ›´æ–°äº†StatelessWidgetçš„çŠ¶æ€ã€‚</p><p>å¯ä»¥é€šè¿‡å¯¹è¯¥æ–¹æ³•å°±è¡ŒåŒ…è£…ï¼Œä½¿å¾—åœ¨StatelessWidgetæ§ä»¶ä¸­è°ƒç”¨StatefulWidgetæ§ä»¶çš„<code>setState()</code>æ–¹æ³•ï¼Œè¾¾åˆ°åˆ·æ–°é¡µé¢çš„æ•ˆæœï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StatefulWidget</span></span><br><span class="line">  <span class="keyword">void</span> aFun()&#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      <span class="comment">// update UI</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">AStatelessWidget(aFun);<span class="comment">// å°†è¯¥æ–¹æ³•ä¼ å…¥StatelessWidgetä¸­</span></span><br><span class="line"><span class="comment">// StatelessWidget</span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">Function</span> aFun</span><br><span class="line">AStatelessWidget(<span class="keyword">this</span>.aFun);<span class="comment">// æ¥æ”¶ä¼ å…¥çš„æ–¹æ³•</span></span><br><span class="line">aFun();<span class="comment">// æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œä»è€Œå®ç°è°ƒç”¨StatelessWidgetä¸­çš„æ–¹æ³•ä¹Ÿå¯ä»¥åˆ·æ–°UI</span></span><br></pre></td></tr></table></figure><h1 id="ä¸Androidçš„å¯¹æ¯”"><a href="#ä¸Androidçš„å¯¹æ¯”" class="headerlink" title="ä¸Androidçš„å¯¹æ¯”"></a>ä¸Androidçš„å¯¹æ¯”</h1><h2 id="Intent"><a href="#Intent" class="headerlink" title="Intent"></a>Intent</h2><p>Androidçš„Intentæœ‰ä¸¤ä¸ªä¸»è¦ä½œç”¨ï¼š</p><ul><li>Activityé—´è·³è½¬</li><li>ç»„ä»¶é—´ä¼ é€’æ•°æ®</li></ul><p>Flutterå¯¹æ­¤ç›¸åº”ï¼š</p><ul><li>ä½¿ç”¨Navigatorå’Œ<code>Route</code>så®ç°åœ¨åŒä¸€ä¸ªâ€œActivityâ€ä¸­ä¸åŒçš„ç•Œé¢é—´ï¼ˆ â€œscreenâ€ or â€œpageâ€ï¼‰è·³è½¬ï¼ˆpushï¼Œpopï¼‰ï¼ŒNavigatorç±»ä¼¼äºAndroidä¸­çš„Activityæ ˆã€‚</li><li>é€šè¿‡AndroidåŸç”ŸIntentç»„ä»¶è·å–åˆ°å…¶ä»–Appä¼ æ¥çš„æ•°æ®ï¼Œç„¶åä¸­é€šè¿‡ä¸‹é¢çš„æ–¹æ³•å®ç°Androidå’ŒFlutteräº¤äº’ï¼š</li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//Android</span></span><br><span class="line"> MethodChannel(getFlutterView(), <span class="string">"app.channel.shared.data"</span>)</span><br><span class="line">      .setMethodCallHandler(MethodChannel.MethodCallHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        public <span class="keyword">void</span> onMethodCall(MethodCall methodCall, MethodChannel.Result result) &#123;</span><br><span class="line">          <span class="keyword">if</span> (methodCall.method.contentEquals(<span class="string">"getSharedText"</span>)) &#123;</span><br><span class="line">            result.success(sharedText);</span><br><span class="line">            sharedText = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"> <span class="comment">//Flutter</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">_SampleAppPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">SampleAppPage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> platform = <span class="keyword">const</span> MethodChannel(<span class="string">'app.channel.shared.data'</span>);</span><br><span class="line">  <span class="built_in">String</span> dataShared = <span class="string">"No data"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    getSharedText();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(body: Center(child: Text(dataShared)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getSharedText() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sharedData = <span class="keyword">await</span> platform.invokeMethod(<span class="string">"getSharedText"</span>);</span><br><span class="line">    <span class="keyword">if</span> (sharedData != <span class="keyword">null</span>) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        dataShared = sharedData;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><p>Flutteræ˜¯å•çº¿ç¨‹çš„ï¼Œä»–çš„çº¿ç¨‹å’ŒAndroidçš„UIçº¿ç¨‹ç»‘å®šï¼Œåœ¨è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ŒIOæ“ä½œç­‰æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>sync/await</code> åœ¨æ‰§è¡Œå®Œè€—æ—¶æ“ä½œåï¼Œå†å»æ›´æ–°stateåˆ·æ–°UIã€‚</p><blockquote><p>Since Flutter is single threaded and runs an event loop (like Node.js), you donâ€™t have to worry about thread management or spawning background threads. If youâ€™re doing I/O-bound work, such as disk access or a network call, then you can safely use async/await and youâ€™re all set. </p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">loadData() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">String</span> dataURL = <span class="string">"https://jsonplaceholder.typicode.com/posts"</span>;</span><br><span class="line">  http.Response response = <span class="keyword">await</span> http.<span class="keyword">get</span>(dataURL);</span><br><span class="line">  setState(() &#123;</span><br><span class="line">    widgets = json.decode(response.body);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¦‚æœæœ‰ç‰¹åˆ«é¢‘ç¹çš„cpuè®¡ç®—ä»¥è‡³äºèƒ½å¯¼è‡´UIæŒ‚èµ·ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨<code>Isolate</code>såˆ©ç”¨CPUå¤šæ ¸å¿ƒå¤„ç†ä»»åŠ¡ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸èƒ½å’Œä¸»çº¿ç¨‹å…±äº«æ•°æ®ï¼Œé€šè¿‡<code>ReceivePort</code>ï¼Œ<code>SendPort</code>ç­‰ä¼ é€’æ•°æ®ã€‚</p><blockquote><p>Isolates(éš”ç¦») are separate execution threads that do not share any memory with the main execution memory heap. This means you canâ€™t access variables from the main thread, or update your UI by calling <code>setState()</code>. Unlike Android threads, Isolates are true to their name, and cannot share memory (in the form of static fields, for example).</p></blockquote><h2 id="æœ¬åœ°èµ„æº"><a href="#æœ¬åœ°èµ„æº" class="headerlink" title="æœ¬åœ°èµ„æº"></a>æœ¬åœ°èµ„æº</h2><p>æˆªæ­¢Flutter beta 2 ä»ç„¶ä¸èƒ½ç›´æ¥è®¿é—®Android assetsæˆ–è€…å…¶ä»–æœ¬åœ°èµ„æºï¼Œä½†æ˜¯Androidå¯ä»¥è®¿é—®flutterçš„assetsèµ„æºï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val flutterAssetStream = assetManager.open(<span class="string">"flutter_assets/assets/my_flutter_asset.png"</span>)</span><br></pre></td></tr></table></figure><p>é€šè¿‡Channelï¼Œflutterå¯ä»¥é—´æ¥è®¿é—®Androidèµ„æºï¼Œåä¹‹äº¦ç„¶ã€‚</p><blockquote><p>ä¸»è¦æ˜¯é€šè¿‡Channelå®Œæˆï¼Œå¯ä»¥ç§°ä¹‹ä¸ºéš§é“ã€‚ä¸»è¦æ˜¯MethodChannelå’ŒMessageChannelä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯è°ƒç”¨æ–¹æ³•ï¼Œç¬¬äºŒç§æ˜¯ä¼ é€’ä¿¡æ¯ã€‚é¦–å…ˆé€šä¿¡çš„åŒæ–¹æ˜¯Flutterå’Œæœ¬åœ°æ“ä½œç³»ç»Ÿæˆ–è€…åº”ç”¨ï¼Œè€Œä¸”æ–¹æ³•çš„è°ƒç”¨å’Œæ¶ˆæ¯çš„æ–¹æ³•å¯ä»¥ä»ä»»ä½•ä¸€æ–¹å‘èµ·ï¼Œç±»ä¼¼RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ã€‚</p><p>ä½œè€…ï¼šé»„é©¬</p><p>é“¾æ¥ï¼šæ˜é‡‘  <a href="https://juejin.im/post/5b35a75e51882574ea3a25e3" target="_blank" rel="noopener">https://juejin.im/post/5b35a75e51882574ea3a25e3</a></p><p>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h2><p>Flutterç”Ÿå‘½å‘¨æœŸæ²¡æœ‰Androidä¸­é‚£ä¹ˆâ€œé‡è¦â€ï¼Œå¯ä»¥é‡å†™ <code>didChangeAppLifecycleState()</code> ç›‘å¬ã€‚</p><ul><li><code>inactive</code> â€” åº”ç”¨å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œä¸æ¥å—è¾“å…¥ã€‚iOS</li><li><code>paused</code> â€” åº”ç”¨åœ¨åå°è¿è¡Œï¼Œä¸å¯è§ï¼Œä¸æ¥å—è¾“å…¥ã€‚ç±»ä¼¼Androidçš„<code>onPause()</code></li><li><code>resumed</code> â€” åº”ç”¨å¯è§ï¼Œå¹¶æ¥å—è¾“å…¥ã€‚ç±»ä¼¼Androidçš„<code>onPostResume()</code></li><li><code>suspending</code> â€” åº”ç”¨è¯·æ±‚æš‚åœã€‚ç±»ä¼¼Androidçš„<code>onStop()</code></li></ul><h2 id="å¸ƒå±€"><a href="#å¸ƒå±€" class="headerlink" title="å¸ƒå±€"></a>å¸ƒå±€</h2><p>Flutteræœ‰å¸ƒå±€Widgetå¦‚ï¼š</p><ul><li>Column åˆ—</li><li>Row è¡Œ</li><li>Stack å·¦ä¸Šè§’å †ç§¯ï¼Œç±»ä¼¼FrameLayout</li></ul><h2 id="ç‚¹å‡»äº‹ä»¶"><a href="#ç‚¹å‡»äº‹ä»¶" class="headerlink" title="ç‚¹å‡»äº‹ä»¶"></a>ç‚¹å‡»äº‹ä»¶</h2><p>FLutterä¸­çš„â€œ<code>onClick()</code>â€: <code>onPressed</code>,<code>onTap</code>ç­‰ç­‰ã€‚</p><p>æ·»åŠ ç‚¹å‡»äº‹ä»¶,åœ¨Widgetå¤–é¢æ·»åŠ ä¸€ä¸ª<code>GestureDetector</code>Widgetï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GestureDetector(</span><br><span class="line">  child: Padding(</span><br><span class="line">      padding: EdgeInsets.all(<span class="number">10.0</span>),</span><br><span class="line">      child: Text(<span class="string">"Row <span class="subst">$i</span>"</span>)),</span><br><span class="line">  onTap: () &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'row tapped'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://www.youtube.com/watch?v=GLSG_Wh_YWc" target="_blank" rel="noopener">Flutter Tutorial for Beginners - Build iOS and Android Apps with Googleâ€™s Flutter &amp; Dart</a></p><p><a href="https://flutter.io/flutter-for-android/" target="_blank" rel="noopener">Flutter for android</a></p><p><a href="https://juejin.im/post/5b35a75e51882574ea3a25e3" target="_blank" rel="noopener">Flutter è®¿é—®æœ¬åœ°èµ„æº</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidä¸­AIDLçš„ä½¿ç”¨</title>
      <link href="/blog/posts/f931e8ae/"/>
      <url>/blog/posts/f931e8ae/</url>
      
        <content type="html"><![CDATA[<p>AIDLï¼ˆAndroid Interface Definition Language ï¼ŒAndroidæ¥å£å®šä¹‰è¯­è¨€ï¼‰ç”¨äºAndroid IPCï¼Œé€‚ç”¨äº<strong>å¤§é‡å¹¶å‘</strong>è¯·æ±‚ã€‚</p><p>ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>æœåŠ¡ç«¯ åˆ›å»ºServiceç›‘å¬Clientçš„è¯·æ±‚ï¼Œé€šè¿‡åˆ›å»ºAIDLå°†æ¥å£æš´éœ²ç»™å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯ ç»‘å®šåˆ°æœåŠ¡ç«¯è·å–BInderå¯¹è±¡ï¼Œå°†å…¶è½¬åŒ–ä¸ºå¯¹åº”AIDLï¼Œå¹¶è°ƒç”¨æ¥å£å¯¹åº”æ–¹æ³•ã€‚</li></ol><p>ä¸¤è€…çš„è¿çº¿å°±æ˜¯AIDLï¼Œå› æ­¤ä¸¤ä¸ªAPPçš„AIDLå¿…é¡»ä¸€è‡´ï¼Œå¯ä»¥å°†AIDLæ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªAndroid Libraryä¸­ï¼Œæˆ–è€…æ‰“æˆaaræ–‡ä»¶ä¾›äºŒè€…ä¾èµ–ã€‚</p><p>ä¹Ÿå¯ä»¥å°†AIDLæ¶‰åŠåˆ°çš„AIDLæ–‡ä»¶ã€javaéƒ½æ”¾åˆ°AIDLæ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶ååœ¨build.gradleçš„<code>android{...}</code>ä¸­æ·»åŠ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sourceSets&#123;</span><br><span class="line">     main&#123;</span><br><span class="line">         java.srcDirs = [&apos;src/main/java&apos;,&apos;src/main/adil&apos;]</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p> å³æ·»åŠ ä¸€ä¸ªjavaè·¯å¾„</p><h1 id="AIDL-æ–‡ä»¶ç‰¹ç‚¹"><a href="#AIDL-æ–‡ä»¶ç‰¹ç‚¹" class="headerlink" title="AIDL æ–‡ä»¶ç‰¹ç‚¹"></a>AIDL æ–‡ä»¶ç‰¹ç‚¹</h1><h2 id="æ”¯æŒçš„æ•°æ®æ ¼å¼"><a href="#æ”¯æŒçš„æ•°æ®æ ¼å¼" class="headerlink" title="æ”¯æŒçš„æ•°æ®æ ¼å¼"></a>æ”¯æŒçš„æ•°æ®æ ¼å¼</h2><p>åŸºæœ¬æ•°æ®ç±»å‹ã€Listï¼ˆArrayListï¼‰ã€Mapï¼ˆHashMapï¼‰ä»¥åŠå®ç°äº†Parcelableæ¥å£çš„å¯¹è±¡ã€AIDLæ¥å£ã€‚</p><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ul><li>è‡ªå®šä¹‰çš„Parcelableå¯¹è±¡ã€AIDLå¯¹è±¡å¿…é¡»æ˜¾ç¤ºimportã€‚</li><li>AIDLä¸­ç”¨åˆ°çš„Parcelableå¯¹è±¡å¿…é¡»æ–°å»ºä¸€ä¸ªåŒåAIDLæ¥å£ï¼Œå£°æ˜å…¶ä¸ºParcelableç±»å‹ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// People.aidl</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.androidlib;</span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.People;</span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line">parcelable People;</span><br></pre></td></tr></table></figure><ul><li>AIDLä¸­é™¤äº†åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå…¶ä»–çš„å‚æ•°å¿…é¡»æ ‡è®°æ–¹å‘ï¼ˆin,out,inoutï¼‰ã€‚</li><li>AIDLä¸æ”¯æŒæ–¹æ³•é‡è½½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½æœ‰ä¸¤ä¸ªåŒåçš„æ–¹æ³•ï¼ˆå³ä½¿å‚æ•°ç±»å‹ã€ä¸ªæ•°ä¸åŒä¹Ÿä¸è¡Œï¼‰ã€‚</li><li>AIDLä¸­åªæ”¯æŒæ–¹æ³•ï¼Œä¸æ”¯æŒé™æ€å˜é‡ã€‚</li></ul><h1 id="AIDLç”¨æ³•"><a href="#AIDLç”¨æ³•" class="headerlink" title="AIDLç”¨æ³•"></a>AIDLç”¨æ³•</h1><h2 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ManagerAidl.aidl</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.androidlib;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.People;</span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.TaskCallBack;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ManagerAidl</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å®¢æˆ·ç«¯æä¾›çš„æ–¹æ³•</span></span><br><span class="line">    <span class="function">List&lt;People&gt; <span class="title">getPeopleList</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addPeople</span><span class="params">(in People people)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å›è°ƒæ¥å£ï¼Œç”¨äºæœåŠ¡ç«¯å¾€å®¢æˆ·ç«¯é€šä¿¡</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerCallBack</span><span class="params">(in TaskCallBack callback)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterCallBack</span><span class="params">(in TaskCallBack callback)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TaskCallBack.aidl</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.androidlib;</span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.People;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://blog.csdn.net/woshiwoshiyu/article/details/54266101</span></span><br><span class="line"><span class="comment">//å›è°ƒçš„å…·ä½“æ–¹æ³•ï¼Œä¾›æœåŠ¡ç«¯å›è°ƒ</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TaskCallBack</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">callBack</span><span class="params">(in <span class="keyword">int</span> size)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onPeopleChange</span><span class="params">(in List&lt;People&gt; peoples)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//People.java</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.androidlib;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PeopleManager.java</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.androidlib;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.ComponentName;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.ServiceConnection;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸€ä¸ªç®¡ç†ç±»ï¼Œå°è£…äº†å®¢æˆ·ç«¯ç»‘å®šæœåŠ¡ç«¯çš„ä¸€äº›æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * å±äºå®¢æˆ·ç«¯éƒ¨åˆ†ï¼Œä¸è¿‡æ”¾åœ¨AIDLä¸­ä¾¿äºå¤šä¸ªå®¢æˆ·ç«¯å¼€å‘</span></span><br><span class="line"><span class="comment"> * Created by jixiaoyong on 2018/8/6.</span></span><br><span class="line"><span class="comment"> * email:jixiaoyong1995@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> PeopleManager mPeopleManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  Context mContext;</span><br><span class="line">    <span class="keyword">private</span>  Listener mListener;</span><br><span class="line">    <span class="keyword">private</span> ManagerAidl managerAidl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;People&gt; peopleList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ç°è¯¥å›è°ƒæ–¹æ³•ï¼Œç”¨äºè°ƒç”¨å®¢æˆ·ç«¯çš„å…·ä½“æ–¹æ³•</span></span><br><span class="line">    <span class="comment">//æ³¨æ„è¿™é‡Œæ˜¯new TaskCallBack.Stub()ï¼Œè€Œénew TaskCallBack(),å¦åˆ™æœåŠ¡å™¨æ— æ³•æ¥æ”¶åˆ°callback</span></span><br><span class="line">    <span class="comment">//TaskCallBack.Stub()æ˜¯TaskCallBackçš„å­ç±»ï¼Œå½“è·¨è¿›ç¨‹é€šä¿¡æ—¶ä¼ é€’çš„æ˜¯proxyç±»</span></span><br><span class="line">    <span class="keyword">private</span> TaskCallBack callBack = <span class="keyword">new</span> TaskCallBack.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callBack</span><span class="params">(<span class="keyword">int</span> size)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            mListener.onCallback(size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPeopleChange</span><span class="params">(List&lt;People&gt; peoples)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            peopleList = peoples;</span><br><span class="line">            mListener.onPeopleListChange(peoples);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServiceConnection serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//åœ¨è¿æ¥ä¸ŠæœåŠ¡ç«¯åï¼Œå®¢æˆ·ç«¯ä»IBinderå¯¹è±¡ä¸­è·å–åˆ°AIDLæ¥å£å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå…¶æ–¹æ³•</span></span><br><span class="line">            managerAidl =  ManagerAidl.Stub.asInterface(service);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                peopleList = managerAidl.getPeopleList();</span><br><span class="line">                managerAidl.registerCallBack(callBack);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            mListener.onCreate(mPeopleManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                managerAidl.unregisterCallBack(callBack);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PeopleManager</span><span class="params">(Context context,Listener listener)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mListener = listener;</span><br><span class="line">        peopleList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"cf.android666.demo"</span>,</span><br><span class="line">                <span class="string">"cf.android666.demo.MService"</span>));<span class="comment">//Android5.0åå¿…é¡»æ˜¾ç¤ºçš„å¯åŠ¨æœåŠ¡</span></span><br><span class="line">        context.bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context,Listener listener)</span> </span>&#123;</span><br><span class="line">        mPeopleManager = <span class="keyword">new</span> PeopleManager( context, listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPeople</span><span class="params">(People people)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            managerAidl.addPeople(people);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;People&gt; <span class="title">getPeopleList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> peopleList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­ç±»å¯ä»¥å®ç°è¯¥Listenerçš„æ–¹æ³•ï¼Œåœ¨æœåŠ¡ç«¯è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶æ‰§è¡Œå¯¹åº”æ“ä½œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Listener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(PeopleManager peopleManager)</span></span>;<span class="comment">//æœåŠ¡è¿æ¥æˆåŠŸ</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCallback</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onPeopleListChange</span><span class="params">(List&lt;People&gt; peoples)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><p>æ³¨æ„MServiceåœ¨AndroidManife.xmlä¸­é…ç½®:</p><p><code>android:exported=&quot;true&quot;android:enabled=&quot;true&quot;android:process=&quot;:people&quot;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MService.java</span></span><br><span class="line"><span class="keyword">package</span> cf.android666.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteCallbackList;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.text.InputFilter;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.ManagerAidl;</span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.People;</span><br><span class="line"><span class="keyword">import</span> cf.android666.androidlib.TaskCallBack;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by jixiaoyong on 2018/8/6.</span></span><br><span class="line"><span class="comment"> * email:jixiaoyong1995@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MService</span> <span class="keyword">extends</span> <span class="title">Service</span> <span class="keyword">implements</span> <span class="title">ManagerAidl</span>.<span class="title">Stub</span>.<span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;People&gt; mPeopleList;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RemoteCallbackList&lt;TaskCallBack&gt; callbackList = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();;</span><br><span class="line">    <span class="keyword">private</span> TaskCallBack mCallBack;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨AIDLæ¥å£ç”ŸæˆmIBinderï¼Œåœ¨æœåŠ¡ç«¯å®ç°æ¥å£å„ä¸ªæ–¹æ³•ï¼Œä¾›å®¢æˆ·ç«¯è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">private</span> IBinder mIBinder = <span class="keyword">new</span> ManagerAidl.Stub() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;People&gt; <span class="title">getPeopleList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mPeopleList;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPeople</span><span class="params">(People people)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            mPeopleList.add(people);</span><br><span class="line">            onPeopleChange(mPeopleList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallBack</span><span class="params">(TaskCallBack callback)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            mCallBack = callback;</span><br><span class="line">            Log.d(<span class="string">"TAG"</span>, <span class="string">"registerCallBackæ³¨å†Œå›è°ƒæ–¹æ³• callback == null"</span> + callback);</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;<span class="comment">//æ³¨æ„è¿™é‡Œä¸€å®šè¦åˆ¤æ–­éç©º</span></span><br><span class="line">                callbackList.register(callback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterCallBack</span><span class="params">(TaskCallBack callback)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                callbackList.unregister(callback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"tag"</span>, <span class="string">"onBind  MServiceå¼€å§‹äº†"</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mPeopleList == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPeopleList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            mPeopleList.add(<span class="keyword">new</span> People(<span class="string">"people"</span> + i, i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mIBinder;<span class="comment">//è¿”å›å¼€å§‹ç”¨AIDLåˆ›å»ºçš„IBinder</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®ç°DeathRecipientæ¥å£çš„æ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯ç»ˆæ­¢åè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        callbackList.unregister(mCallBack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œæ—¶åœ¨æœåŠ¡ç«¯è°ƒç”¨å›è°ƒæ–¹æ³•çš„å†™æ³•ï¼Œæ˜¯ä»callbackListä¾æ¬¡å–å‡ºæ¥æ‰§è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onPeopleChange</span><span class="params">(List&lt;People&gt; peoples)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (callbackList == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> len = callbackList.beginBroadcast();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                callbackList.getBroadcastItem(i).onPeopleChange(peoples);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            callbackList.finishBroadcast();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ol><li><p>è¿™é‡Œç”¨æ¥æ³¨å†Œç›‘å¬çš„ç±»æ˜¯RemoteCallbackList</p><p>æˆ‘ä»¬çŸ¥é“è·¨è¿›ç¨‹çš„ä¸¤ä¸ªlisteneræ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œé‚£ä»–æ˜¯æ€ä¹ˆä¿è¯è·¨è¿›ç¨‹æ³¨å†Œã€æ³¨é”€çš„æ˜¯æŒ‡å®šçš„listenerå‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºè™½ç„¶ä¸¤ä¸ªlistenerå¯¹è±¡ä¸åŒï¼Œä½†æ˜¯ä»–ä»¬åº•å±‚çš„Binderå¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œåœ¨RemoteCallbackListä¸­æœ‰ä¸€ä¸ªä»¥Binderå¯¹è±¡ä¸ºKEYçš„mapæ¥å­˜æ”¾è¿™äº›listenerå¯¹è±¡ï¼Œå½“è¦æ³¨é”€æ—¶ï¼Œåªéœ€è¦æŒ‰å½“å‰å¾…æ³¨é”€çš„listenerçš„Binderå¯¹è±¡æ‰¾åˆ°å·²ç»æ³¨å†Œäº†çš„listenerå¹¶åˆ é™¤æ‰å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ArrayMap&lt;IBinder, Callback&gt; mCallbacks</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;IBinder, Callback&gt;()</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼ŒRemoteCallbackListå¯ä»¥åœ¨å®¢æˆ·ç«¯æ­»äº¡çš„æ—¶å€™è‡ªåŠ¨æ³¨é”€æ‰å¯¹åº”çš„listenerï¼Œè¿™æ˜¯å› ä¸ºä»–åœ¨æ³¨å†Œçš„åŒæ—¶ä¹Ÿå¯¹Binderçš„æ­»äº¡å°±è¡Œäº†ç›‘å¬ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">register</span><span class="params">(E callback, Object cookie)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mCallbacks) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mKilled) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Flag unusual case that could be caused by a leak. b/36778087</span></span><br><span class="line">        logExcessiveCallbacks();</span><br><span class="line">        IBinder binder = callback.asBinder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Callback cb = <span class="keyword">new</span> Callback(callback, cookie);</span><br><span class="line">            binder.linkToDeath(cb, <span class="number">0</span>);<span class="comment">//ç›‘å¬binderçš„æ­»äº¡äº‹ä»¶</span></span><br><span class="line">            mCallbacks.put(binder, cb);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//å½“binderæ­»äº¡æ—¶ï¼Œä¼šä¸»åŠ¨ç§»é™¤å…¶æ³¨å†Œçš„listener</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mCallbacks) &#123;</span><br><span class="line">                mCallbacks.remove(mCallback.asBinder());</span><br><span class="line">            &#125;</span><br><span class="line">            onCallbackDied(mCallback, mCookie);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•è¿è¡Œçš„çº¿ç¨‹</p><p><strong>å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿è¡Œåœ¨åŒä¸€è¿›ç¨‹</strong>ï¼šå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯å’ŒæœåŠ¡ç«¯å›è°ƒå®¢æˆ·ç«¯æ–¹æ³•ï¼ˆRemoteCallbackListï¼Œä¸‹åŒï¼‰éƒ½ä¼šè¿è¡Œåœ¨åŒä¸€çº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯æ—¶æ‰€åœ¨çš„çº¿ç¨‹ï¼Œé»˜è®¤ä¸ºä¸»çº¿ç¨‹</p><p><strong>å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿è¡Œåœ¨ä¸åŒè¿›ç¨‹</strong>ï¼šå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•ï¼Œå®¢æˆ·ç«¯ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°æœåŠ¡ç«¯æ–¹æ³•åœ¨Binderçº¿ç¨‹æ± ä¸­è¿è¡Œå®Œæ¯•,è¿™ç§æƒ…å†µä¸‹æœåŠ¡ç«¯å¯ä»¥æ‰§è¡Œè€—æ—¶æ“ä½œè€Œæ— éœ€å¦å»ºçº¿ç¨‹ï¼›æœåŠ¡ç«¯å›è°ƒå®¢æˆ·ç«¯æ–¹æ³•è¿è¡Œåœ¨å®¢æˆ·ç«¯ä¸»çº¿ç¨‹(ä¸å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•åœ¨åŒä¸€çº¿ç¨‹)</p><p>é€šè¿‡ä¸Šè¿°åˆ†æï¼Œå¯ä»¥æ³¨æ„åˆ°ä¸€ä¸ªç»†èŠ‚ï¼š<strong>è™½ç„¶åœ¨æœåŠ¡ç«¯ä¸­å›è°ƒå®¢æˆ·ç«¯çš„æ–¹æ³•æ˜¯åœ¨æœåŠ¡ç«¯çš„Binderçº¿ç¨‹ï¼Œä½†æ˜¯åœ¨å®¢æˆ·ç«¯ä¸­è¢«å›è°ƒçš„æ–¹æ³•å´æ˜¯å’Œå®¢æˆ·ç«¯ä¸­ä¸»åŠ¨è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•çš„çº¿ç¨‹ä¸€è‡´</strong>ã€‚</p></li></ol><h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PeopleManager.init(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœåŠ¡è¿æ¥æˆåŠŸåï¼Œå¯ä»¥å¼€å§‹è°ƒç”¨æœåŠ¡çš„ä¸€ç³»åˆ—æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(PeopleManager peopleManager)</span> </span>&#123;</span><br><span class="line">    mPeopleManager = peopleManager;</span><br><span class="line">    peopleList = peopleManager.getPeopleList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; peopleList.size(); i++) &#123;</span><br><span class="line">        Log.d(<span class="string">"tag"</span>, <span class="string">"people list is "</span> + peopleList.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å…¶ä»–å›è°ƒæ–¹æ³•ï¼Œç­‰æœåŠ¡ç«¯å›è°ƒæ—¶ä¼šæ‰§è¡Œå¯¹åº”æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPeopleListChange</span><span class="params">(List&lt;People&gt; peoples)</span> </span>&#123;</span><br><span class="line">    Log.d(<span class="string">"TAG"</span>, <span class="string">"demo2 peopleå˜åŒ–äº†"</span> + peoples.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç›‘å¬å¹¶å¤„ç†Binderæ­»äº¡äº‹ä»¶"><a href="#ç›‘å¬å¹¶å¤„ç†Binderæ­»äº¡äº‹ä»¶" class="headerlink" title="ç›‘å¬å¹¶å¤„ç†Binderæ­»äº¡äº‹ä»¶"></a>ç›‘å¬å¹¶å¤„ç†Binderæ­»äº¡äº‹ä»¶</h2><p>å½“æœåŠ¡ç«¯è¿›ç¨‹æ„å¤–æ­»äº¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©é‡æ–°è¿æ¥æœåŠ¡ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>binderDied åœ¨å®¢æˆ·ç«¯çš„Binderçº¿ç¨‹æ± ä¸­</li><li>onServiceDisconnected åœ¨å®¢æˆ·ç«¯UIçº¿ç¨‹</li></ol><h2 id="AIDLçš„æƒé™éªŒè¯"><a href="#AIDLçš„æƒé™éªŒè¯" class="headerlink" title="AIDLçš„æƒé™éªŒè¯"></a>AIDLçš„æƒé™éªŒè¯</h2><p>å¯ä»¥åœ¨æœåŠ¡çš„onBind(Intent intent)æˆ–è€…onTransact()æ–¹æ³•ä¸­åšéªŒè¯</p><p>åšéªŒè¯çš„æ‰‹æ®µæœ‰ï¼š1.permissionéªŒè¯ï¼›2.Uidï¼ŒPidç­‰åšéªŒè¯</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹</p>]]></content>
      
      
      
        <tags>
            
            <tag> aidl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidäº‹ä»¶åˆ†å‘</title>
      <link href="/blog/posts/c0fefed0/"/>
      <url>/blog/posts/c0fefed0/</url>
      
        <content type="html"><![CDATA[<p>Androidäº‹ä»¶åˆ†å‘ï¼ŒæŒ‡æ‰‹æŒ‡ç‚¹å‡»å±å¹•åï¼Œä»Activityã€ViewGroupåˆ°Viewçš„ä¸€ç³»åˆ—è¿‡ç¨‹ã€‚</p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Androidç³»ç»Ÿçš„çª—å£æœºåˆ¶å¦‚ä¸‹å›¾ï¼š</p><p>Activityå†…æœ‰ä¸€ä¸ªWindowå¯¹è±¡ï¼Œå…¶å®ç°ç±»æ˜¯PhoneWindowï¼›</p><p>DecorViewä¸ºé¡¶å±‚Viewï¼ŒDecorViewæ˜¯ä¸€ä¸ªFrameLayoutï¼Œå…¶ä¸­æœ‰TitleViewå’ŒContentViewï¼›</p><p><img src="https://github.com/jixiaoyong/jixiaoyong.github.io/blob/master/images/blog/2018-04/AndroidDispatchTouchEvent.png?raw=true" alt="Androidç³»ç»Ÿçª—å£ç®¡ç†æœºåˆ¶"></p><p>TitleViewä¸ºæ ‡é¢˜æ ï¼ŒContentViewå°±æ˜¯å¹³æ—¶åœ¨Activityçš„onCreate()æ–¹æ³•ä¸­è®¾ç½®çš„è§†å›¾ï¼ŒTitleViewå¯ä»¥ç”¨<code>this.requestWindowFeature(Window.FEATURE_NO_TITLE);</code>éšè—æ‰ï¼Œä½†æ˜¯å¿…é¡»æ³¨æ„è¦åœ¨setContentView()ä¹‹å‰ï¼ŒåŸå› å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    getWindow().setContentView(view);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç‚¹å‡»äº‹ä»¶-Activity-â€“-gt-ViewGroup"><a href="#ç‚¹å‡»äº‹ä»¶-Activity-â€“-gt-ViewGroup" class="headerlink" title="ç‚¹å‡»äº‹ä»¶ Activity â€“&gt; ViewGroup"></a>ç‚¹å‡»äº‹ä»¶ Activity â€“&gt; ViewGroup</h1><p>ç‚¹å‡»äº‹ä»¶å‘ç”Ÿåï¼Œé¦–å…ˆè¢«è°ƒç”¨çš„æ˜¯<code>Activity.dispatchTouchEvent()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        onUserInteraction();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> onTouchEvent(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å†…éƒ¨å…ˆè°ƒç”¨äº†<code>getWindow().superDispatchTouchEvent(ev)</code>è¿™ä¸ªæ–¹æ³•ï¼ŒgetWindow()è¿”å›çš„mWindowæ˜¯PhoneWindowçš„å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹PhoneWindow.superDispatchTouchEvent()æ–¹æ³•ï¼Œæ˜¾ç„¶åˆè°ƒç”¨äº†DecorViewçš„superDispatchTouchEvent()æ–¹æ³•,åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†FrameLayout.dispatchKeyEvent(event)ï¼Œæ­¤æ—¶<strong>ç‚¹å‡»äº‹ä»¶ä»Activityè½¬åˆ°äº†ViewGroupä¸­</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PhoneWindow</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mDecor.superDispatchKeyEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DecorView extends FrameLayout</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Give priority to closing action modes if applicable.</span></span><br><span class="line">    <span class="keyword">if</span> (event.getKeyCode() == KeyEvent.KEYCODE_BACK) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();</span><br><span class="line">        <span class="comment">// Back cancels action modes first.</span></span><br><span class="line">        <span class="keyword">if</span> (mPrimaryActionMode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (action == KeyEvent.ACTION_UP) &#123;</span><br><span class="line">                mPrimaryActionMode.finish();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.dispatchKeyEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç‚¹å‡»äº‹ä»¶-ViewGroup-â€“-gt-View"><a href="#ç‚¹å‡»äº‹ä»¶-ViewGroup-â€“-gt-View" class="headerlink" title="ç‚¹å‡»äº‹ä»¶ ViewGroup â€“&gt; View"></a>ç‚¹å‡»äº‹ä»¶ ViewGroup â€“&gt; View</h1><p>ViewGroupä¸äº‹ä»¶åˆ†å‘çš„æ–¹æ³•æœ‰ä¸‰ä¸ªï¼š</p><ul><li><code>dispatchTouchEvent()</code>  åˆ†å‘äº‹ä»¶ï¼Œæ¯æ¬¡éƒ½ä¼šè¢«è°ƒç”¨</li><li><code>onInterceptTouchEvent()</code>  æ‹¦æˆªäº‹ä»¶ï¼Œå¦‚æœå½“å‰ViewGroupå·²ç»å†³å®šæ‹¦æˆªäº‹ä»¶ï¼Œé‚£ä¹ˆä¸ä¼šå†è°ƒç”¨</li><li><code>onTouchEvent()</code>  å¤„ç†ç‚¹å‡»äº‹ä»¶,å¦‚æœè®¾ç½®äº†<code>mOnTouchListener</code>çš„è¯ï¼Œåˆ™ä¸ä¼šå›è°ƒæœ¬æ–¹æ³•</li></ul><p>è¿™ä¸‰ä¸ªä¸»è¦æ–¹æ³•å…³ç³»å¦‚ä¸‹ï¼ˆä¼ªä»£ç ï¼Œæ¥è‡ªã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¯æ¬¡ç‚¹å‡»äº‹ä»¶å›è°ƒè¯¥æ–¹æ³•</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (onInterceptTouchEvent(event)) &#123;<span class="comment">//viewGroupä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œç¡®è®¤æ˜¯å¦æ‹¦æˆªç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">        result = onTouchEvent(event)<span class="comment">//å¯¹ç‚¹å‡»äº‹ä»¶è¿›è¡Œå¤„ç†</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = child.dispatchTouchEvent(event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ViewGroup.dispatchTouchEvent()è¢«è°ƒç”¨åï¼Œä¼šé€šè¿‡ä¸€ç³»åˆ—æ¡ä»¶åˆ¤æ–­æ˜¯ç”±ViewGroupæ‹¦æˆªè¯¥äº‹ä»¶ï¼Œè¿˜æ˜¯ç”±å­Viewæ¶ˆè€—è¯¥äº‹ä»¶ã€‚</p><p>ä¸»è¦æµç¨‹åˆ†ä¸ºä¸¤éƒ¨åˆ†</p><p><strong>1.æ£€æŸ¥æ˜¯å¦éœ€è¦æ‹¦æˆª</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/ViewGroup.java line2567-2582</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">            <span class="comment">// Check for interception.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                    intercepted = onInterceptTouchEvent(ev);<span class="comment">//åœ¨è¿™é‡Œè°ƒç”¨äº†onInterceptTouchEvent()æ–¹æ³•ï¼Œå¦‚æœå·²ç»æ‹¦æˆªäº†</span></span><br><span class="line">                    ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    intercepted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">                <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">                intercepted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">     ...</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ev.isFromSource(InputDevice.SOURCE_MOUSE)</span><br><span class="line">                &amp;&amp; ev.getAction() == MotionEvent.ACTION_DOWN</span><br><span class="line">                &amp;&amp; ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY)</span><br><span class="line">                &amp;&amp; isOnScrollbarThumb(ev.getX(), ev.getY())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>æ¯æ¬¡ACTION_DOWNäº‹ä»¶éƒ½éœ€è¦è°ƒç”¨<code>onInterceptTouchEvent()</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆª</li><li>å…¶ä»–MotionEventäº‹ä»¶ï¼Œå¦‚æœæœ‰èƒ½å¤„ç†ç‚¹å‡»äº‹ä»¶çš„å­Viewï¼ˆ<code>mFirstTouchTarget != null</code>ï¼‰ä¸”<code>disallowIntercept</code>ä¸ºfalseä¹Ÿéœ€è¦è°ƒç”¨<code>onInterceptTouchEvent()</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼Œå¦åˆ™ä¸éœ€è¦æ‹¦æˆª</li><li>å…¶ä½™æƒ…å†µéƒ½éœ€è¦æ‹¦æˆªï¼ˆæ²¡æœ‰å¯ä»¥å¤„ç†ç‚¹å‡»äº‹ä»¶çš„å­Viewï¼Œå¹¶ä¸”ä¸æ˜¯ACTION_DOWNäº‹ä»¶ï¼‰</li></ul><p>å¦‚æœViewGroupåˆ¤æ–­è¦æ‹¦æˆªè¯¥äº‹ä»¶ï¼Œåˆ™ä¼šè°ƒç”¨<code>dispatchTransformedTouchEvent()</code>ï¼ˆåé¢ä¼šå†è®²åˆ°ï¼‰é€šè¿‡ä»–è°ƒç”¨ç»§æ‰¿è‡ªViewçš„<code>dispatchTouchEvent(MotionEvent event)</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatch to touch targets.</span></span><br><span class="line">           <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// No touch targets so treat this as an ordinary view.</span></span><br><span class="line">               handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</span><br><span class="line">                       TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ...</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure></p><p>å¦åˆ™å°±éœ€è¦éå†å…¶å­View</p><p><strong>2.éå†ViewGroupçš„æ‰€æœ‰å­Viewï¼Œå¯»æ‰¾ä¸€ä¸ªå¯ä»¥å¤„ç†ç‚¹å‡»äº‹ä»¶çš„å­View</strong></p><ul><li><code>dispatchTransformedTouchEvent()</code>   è°ƒç”¨äº†å­Viewçš„<code>dispatchTouchEvent()</code></li><li><code>addTouchTarget()</code>   å¯¹<code>mFirstTouchTarget</code>è¿›è¡Œæ›´æ–°</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 1. Check for interception.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆª</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                || mFirstTouchTarget != <span class="keyword">null</span>) &#123;<span class="comment">//mFirstTouchTargetè¡¨ç¤ºèƒ½å¤„ç†ç‚¹å‡»äº‹ä»¶çš„å­View</span></span><br><span class="line">            <span class="comment">//FLAG_DISALLOW_INTERCEPTæ¯æ¬¡ACTION_DOWNéƒ½ä¼šè¢«é‡ç½®</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                intercepted = onInterceptTouchEvent(ev);<span class="comment">//è°ƒç”¨æ‹¦æˆªæ–¹æ³•</span></span><br><span class="line">                ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                intercepted = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">            <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">            intercepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.éå†å­Viewï¼Œå¯»æ‰¾å¯ä»¥å¤„ç†ç‚¹å‡»äº‹ä»¶çš„å­View</span></span><br><span class="line">    <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">                     <span class="comment">// Child wants to receive touch within its bounds.</span></span><br><span class="line">                     ...</span><br><span class="line">                     newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                     alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatchTransformedTouchEvent()æ–¹æ³•å¦‚ä¸‹ï¼Œç”±äº<code>child != null</code>å…¶å†…éƒ¨è°ƒç”¨<code>child.dispatchTouchEvent(event)</code>æ–¹æ³•ï¼Œå¦‚æ­¤å¾ªç¯ç›´åˆ°å­Viewæ˜¯ä¸€ä¸ªViewï¼ˆå•å°±ViewGroupå’ŒViewè€Œè®ºï¼‰å³<strong>å°†ç‚¹å‡»äº‹ä»¶ä»ViewGroupåˆ†å‘åˆ°äº†View</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></span><br><span class="line"><span class="function"><span class="params">            View child, <span class="keyword">int</span> desiredPointerIdBits)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">        handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        handled = child.dispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å­Viewå¯ä»¥å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨<code>addTouchTarget()</code>æ–¹æ³•å†…éƒ¨å¯¹<code>mFirstTouchTarget</code>è¿›è¡Œæ›´æ–°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TouchTarget <span class="title">addTouchTarget</span><span class="params">(@NonNull View child, <span class="keyword">int</span> pointerIdBits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> TouchTarget target = TouchTarget.obtain(child, pointerIdBits);</span><br><span class="line">    target.next = mFirstTouchTarget;</span><br><span class="line">    mFirstTouchTarget = target;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç‚¹å‡»äº‹ä»¶-Viewå†…éƒ¨"><a href="#ç‚¹å‡»äº‹ä»¶-Viewå†…éƒ¨" class="headerlink" title="ç‚¹å‡»äº‹ä»¶ Viewå†…éƒ¨"></a>ç‚¹å‡»äº‹ä»¶ Viewå†…éƒ¨</h1><p>Viewçš„ç‚¹å‡»äº‹ä»¶åˆ†å‘ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>dispatchTouchEvent()</code></li><li><code>onTouchEvent()</code></li></ul><p>å…¶ç‚¹å‡»äº‹ä»¶åˆ†å‘ç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(mListenerInfo.mOnTouchListener.onTouch(<span class="keyword">this</span>, event))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> onTouchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§Viewçš„dispatchTouchEvent()æ–¹æ³•ä¸­ï¼Œå¦‚æœViewæ³¨å†Œäº†OnTouchListeneråˆ™ä¼šå…ˆæ‰§è¡Œ<code>mOnTouchListener.onTouch()</code>æ–¹æ³•,å¦‚æœè¯¥æ–¹æ³•è¿”å›falseæ‰ä¼šæ‰§è¡Œ<code>onTouchEvent()</code>ã€‚</p><p>åœ¨çœ‹onTouchEvent()æ–¹æ³•ï¼š</p><ul><li>å¦‚æœViewå¤„äº<strong>ä¸å¯ç”¨çŠ¶æ€</strong>ä¸‹ï¼Œä¹Ÿä¼šæ¶ˆè€—ç‚¹å‡»äº‹ä»¶ï¼Œåªä¸è¿‡æ²¡æœ‰ååº”</li><li>å¦‚æœæ³¨å†Œäº†OnClickListenerä¼šåœ¨ACTION_UPçš„æ—¶å€™è°ƒç”¨<code>mOnClickListener.onClick(this)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(CLICKABLE&amp;&amp;LONG_CLICKABLE)&#123;<span class="comment">//LONG_CLICKABLEé»˜è®¤ä¸ºfalseï¼ŒCLICKABLEã€LONG_CLICKABLEä¼šåœ¨è®¾ç½®ç‚¹å‡»äº‹ä»¶æ—¶è¢«è®¾ç½®ä¸ºtrue</span></span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:&#123;</span><br><span class="line">                ...</span><br><span class="line">                performClick();<span class="comment">//å¦‚æœæ³¨å†Œäº†OnClickListeneråˆ™ä¼šè°ƒç”¨å…¶onClick()æ–¹æ³•</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mListenerInfo.mOnClickListener.onClick(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ•´ä¸ªAndroidçš„æ—¶é—´åˆ†å‘å§‹äºActivity,ç»è¿‡PhoneWindowã€DecorViewåˆ°è¾¾ViewGroupï¼Œå†é€å±‚åˆ†å‘åˆ°Viewä¸­ã€‚</p><p>å¦‚æœåº•å±‚æ²¡æœ‰å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œåˆ™åˆä¸€å±‚å±‚å‘ä¸Šè¿”å›ï¼Œç›´åˆ°æœ€é¡¶å±‚æ¶ˆè€—æ‰ç‚¹å‡»äº‹ä»¶ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹</p><p><a href="http://androidxref.com" target="_blank" rel="noopener">Androidæºä»£ç </a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AsyncTaskæºç è§£æ</title>
      <link href="/blog/posts/7ee9086b/"/>
      <url>/blog/posts/7ee9086b/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¿™æ˜¯AsyncTaskæºç çš„ç®€å•åˆ†æï¼Œä¸»è¦åŸºäºã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹ä¸€ä¹¦çš„å†…å®¹ã€‚</p></blockquote><p>AsyncTaskæ˜¯Androidä¸­å¤šçº¿ç¨‹å¤„ç†æ–¹å¼ä¹‹ä¸€ï¼ˆå…¶ä½™ä¸º1.HandlerThreadã€2.IntentServiceä»¥åŠæ™®é€šçš„çº¿ç¨‹Threadï¼‰ã€‚</p><p>AsyncTaskæœ¬è´¨æ˜¯çº¿ç¨‹æ± å’ŒHandlerçš„åŒ…è£…ç±»ï¼Œé€‚åˆå®æ—¶æ›´æ–°åå°ä»»åŠ¡è¿›åº¦çš„å·¥ä½œï¼Œç‰¹åˆ«è€—æ—¶çš„å·¥ä½œåº”å½“äº¤ç»™çº¿ç¨‹æ± å¤„ç†ã€‚</p><p>AsyncTaskå¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li>onPreExecute()</li><li>doInBackground()</li><li>onProgressUpdate()</li><li>onPostExecute()</li></ul><p>AsyncTaskæœ‰ä¸€ä¸‹é™åˆ¶ï¼š</p><ol><li>AsyncTaskå¯¹è±¡å¿…é¡»åœ¨ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼Œä¸‹åŒï¼‰åˆ›å»º</li><li>AsyncTaskçš„execute()å¿…é¡»åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œä¸”åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡</li><li>ä¸èƒ½<strong>ç›´æ¥è°ƒç”¨</strong>å…¶4ç§å¸¸ç”¨æ–¹æ³•ï¼ˆè§ä¸Šï¼‰</li></ol><h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><ul><li>ç»§æ‰¿è‡ªAsyncTaskï¼Œé‡å†™å¯¹åº”æ–¹æ³•ã€‚ï¼ˆæ³¨æ„å¦‚æœéœ€è¦æ›´æ–°è¿›åº¦ï¼Œè¦åœ¨doInBackground()æ–¹æ³•ä¸­è°ƒç”¨publishProgress()æ–¹æ³•ï¼‰</li><li>åœ¨<strong>UIçº¿ç¨‹</strong> å®ä¾‹åŒ–AsyncTaskå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶execute()æ–¹æ³•ï¼Œä¼ å…¥å‚æ•°å¼€å§‹æ‰§è¡Œã€‚</li></ul><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p><strong>åœ¨execute(params)æ‰§è¡Œåï¼Œå°†å‚æ•°paramsä¼ å…¥mWorker.call()æ–¹æ³•</strong></p><p>{è°ƒç”¨doInBackground(params)åå°æ‰§è¡Œä»»åŠ¡ï¼ŒåŒæ—¶é€šè¿‡postResult()æ–¹æ³•å‘é€æ‰§è¡Œç»“æœï¼Œç”±InternalHandler.handleMessage()åˆ¤æ–­è¯¥æ‰§è¡Œfinish()è¿˜æ˜¯onProgressUpdate()}</p><p>{å°†mWorkerä¼ å…¥mFutureä¸­ä½œä¸ºå…¶callableåœ¨runAndReset()æ–¹æ³•ä¸­æ‰§è¡Œc.call()æ–¹æ³•ã€‚}</p><p><strong>é€šè¿‡exec.execute(mFuture)å°†å…¶å‹å…¥SerialExecutorçº¿ç¨‹æ± ä¸­æ’é˜Ÿï¼Œå¹¶åœ¨THREAD_POOL_EXECUTOR.execute(mActive)çœŸæ­£æ‰§è¡Œã€‚</strong></p><h1 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h1><p>åˆ›å»ºå¯¹è±¡ï¼ˆä»£ç æœ‰èŠ‚ç•¥ï¼Œä¸‹åŒï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates a new asynchronous task. This constructor must be invoked on the UI thread.</span></span><br><span class="line"><span class="comment">//æ³¨æ„è¿™é‡Œçš„è¦æ±‚ï¼Œå¿…é¡»åœ¨uiçº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">(@Nullable Looper callbackLooper)</span> </span>&#123;</span><br><span class="line">    mHandler = callbackLooper == <span class="keyword">null</span> || callbackLooper == Looper.getMainLooper()</span><br><span class="line">        ? getMainHandler()<span class="comment">//æ­¤å¤„åˆ›å»ºInternalHandlerç”¨äºåœ¨UIçº¿ç¨‹å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">        : <span class="keyword">new</span> Handler(callbackLooper);</span><br><span class="line"></span><br><span class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = doInBackground(mParams);<span class="comment">//æ³¨æ„è¿™é‡Œä¼šè°ƒç”¨doInBackground()æ–¹æ³•ï¼Œåå°çº¿ç¨‹</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable tr) &#123;</span><br><span class="line">                mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">throw</span> tr;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                postResult(result);<span class="comment">//æ­¤å¤„å‘é€msgåˆ°mHandleré‚£é‡Œæ¥å—å¤„ç†</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;<span class="comment">//è¿™é‡Œå°†mWorkerä¼ äº†è¿›å»</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹FutureTask</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callable == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">this</span>.callable = callable; <span class="comment">//å°†mWorkerå½“åšäº†ä»–çš„callable</span></span><br><span class="line">    <span class="keyword">this</span>.state = NEW;       <span class="comment">// ensure visibility of callable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Callable&lt;V&gt; c = callable;</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">                 result = c.call(); <span class="comment">//ä¼šåœ¨è¿™é‡Œå›è°ƒmWorkerçš„call()æ–¹æ³•ï¼Œå³å‰æ–‡æ‰€è¯´çš„doInBackgroud()ä¹‹ç±»çš„æ–¹æ³•</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»çº¿ç¨‹è°ƒç”¨execute()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></span><br><span class="line"><span class="function"><span class="params">        Params... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123; <span class="comment">//æ­¤å¤„é™åˆ¶execute()åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">switch</span> (mStatus) &#123;</span><br><span class="line">            <span class="keyword">case</span> RUNNING:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                        + <span class="string">" the task is already running."</span>);</span><br><span class="line">            <span class="keyword">case</span> FINISHED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                        + <span class="string">" the task has already been executed "</span></span><br><span class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mStatus = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    onPreExecute(); <span class="comment">//å¼€å§‹å‰å‡†å¤‡å·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">    mWorker.mParams = params; <span class="comment">//å°†å‚æ•°ä¼ å…¥mWorkerï¼Œå¹¶ä¸€å¹¶ä¼ å…¥mFutureä¸­</span></span><br><span class="line">    exec.execute(mFuture);<span class="comment">//å°†å‡†å¤‡å¥½å‚æ•°ã€æ‰§è¡Œæ—¶é—´çš„mFutureæ’é˜Ÿæ”¾å…¥ä¸²è¡Œçº¿ç¨‹æ± ä¸­ï¼Œç­‰å¾…æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†å¸¸ç”¨æ–¹æ³•ä¹‹ä¸€onPreExecute();</p><p>mWorkerå’ŒmFutureçš„å…³ç³»å‰æ–‡å·²ç»æè¿°äº†ï¼Œåœ¨çœ‹ä¸€ä¸‹exec.execute(mFuture)æ‰§è¡Œäº†ä»€ä¹ˆï¼š</p><p>execæ˜¯execute()ä¼ å…¥çš„ï¼Œå¯¹åº”äºsDefaultExecutorï¼Œå†æŸ¥ä¸‹å»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An &#123;<span class="doctag">@link</span> Executor&#125; that executes tasks one at a time in serial</span></span><br><span class="line"><span class="comment">     * order.  This serialization is global to a particular process.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹SerialExecutorè¿™ä¸ªçº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SerialExecutorä¸»è¦çš„ä½œç”¨æ˜¯å°†è¿™äº›çº¿ç¨‹æ”¾åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¹¶æŒ‰ç…§ä¸²è¡Œçš„é¡ºåºä¾æ¬¡è°ƒç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</span><br><span class="line">    Runnable mActive;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//offer() Inserts the specified element at the end of this deque.</span></span><br><span class="line">        <span class="comment">//å°†ræ’å…¥åˆ°çº¿ç¨‹æ± ä¸­</span></span><br><span class="line">        mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//ç­‰åˆ°å½“å‰çš„æ‰§è¡Œå®Œäº†ï¼Œå°±è°ƒç”¨ä¸‹ä¸€ä¸ª</span></span><br><span class="line">                    scheduleNext();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</span><br><span class="line">            scheduleNext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            THREAD_POOL_EXECUTOR.execute(mActive);<span class="comment">//åœ¨è¿™é‡Œé¢æ‰æ˜¯çœŸæ­£çš„æ‰§è¡Œçº¿ç¨‹çš„å†…å®¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ä»”ç»†çœ‹ä¸€ä¸‹THREAD_POOL_EXECUTOR</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">        CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,</span><br><span class="line">        sPoolWorkQueue, sThreadFactory);</span><br><span class="line">threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</span><br><span class="line">THREAD_POOL_EXECUTOR = threadPoolExecutor;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//Executes the given task sometime in the future.  The task</span></span><br><span class="line"> <span class="comment">//may execute in a new thread or in an existing pooled thread.</span></span><br><span class="line">ThreadPoolExector.executr()</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»‹ç»äº†çº¿ç¨‹å’Œçº¿ç¨‹æ± éƒ¨åˆ†çš„å†…å®¹ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹åœ¨ä¸»çº¿ç¨‹å’Œåå°çº¿ç¨‹ä¹‹é—´æ˜¯å¦‚ä½•ä¾é handleræœºåˆ¶æ¥ä¼ é€’æ¶ˆæ¯çš„ã€‚</p><p>å…³äºæ„é€ å‡½æ•°ï¼Œç”±äºæˆ‘ä»¬å¼€å‘è€…åªèƒ½æ¥è§¦åˆ°AsyncTask()è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œæ‰€ä»¥<code>mHandler=getMainHandler()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>((Looper) <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//@hideï¼Œæ™®é€šå¼€å‘è€…ä¸å¯è§</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">(@Nullable Looper callbackLooper)</span> </span>&#123;</span><br><span class="line">        mHandler = callbackLooper == <span class="keyword">null</span> || callbackLooper == Looper.getMainLooper()</span><br><span class="line">            ? getMainHandler()</span><br><span class="line">            : <span class="keyword">new</span> Handler(callbackLooper);</span><br><span class="line">            ......</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getMainHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AsyncTask<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sHandler = <span class="keyword">new</span> InternalHandler(Looper.getMainLooper());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sHandler;<span class="comment">//sHandleræ˜¯ä¸€ä¸ªç±»å˜é‡ï¼Œå–çš„æ˜¯ä¸»çº¿ç¨‹çš„looper,æ‰€ä»¥é™åˆ¶äº†AsyncTaskåªèƒ½åœ¨ä¸»çº¿ç¨‹å®ä¾‹åŒ–</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸€ä¸‹InternalHandlerç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123; <span class="comment">//åœ¨è¿™é‡Œå¤„ç†åå°çº¿ç¨‹å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼ŒUIçº¿ç¨‹</span></span><br><span class="line">        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MESSAGE_POST_RESULT:</span><br><span class="line">                <span class="comment">// There is only one result</span></span><br><span class="line">                result.mTask.finish(result.mData[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</span><br><span class="line">                result.mTask.onProgressUpdate(result.mData);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œåœ¨doInBackground()æ–¹æ³•ä¸­å¯ä»¥ä½¿ç”¨publishProgress()åœ¨åå°æ›´æ–°è¿›åº¦ï¼Œå³æ˜¯ä½¿ç”¨äº†handlerå‘é€æ¶ˆæ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isCancelled()) &#123;</span><br><span class="line">        getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</span><br><span class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼ŒAsyncTaskçš„finish()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¯è§ï¼Œæœ€åä¼šæ ¹æ®æƒ…å†µè°ƒç”¨onCancelled()æˆ–è€…onPostExecute()</span></span><br><span class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">        onCancelled(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onPostExecute(result);</span><br><span class="line">    &#125;</span><br><span class="line">    mStatus = Status.FINISHED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠ è½½å·²å®‰è£…åº”ç”¨ã€æœªå®‰è£…apkä¸­çš„èµ„æº</title>
      <link href="/blog/posts/8d60b485/"/>
      <url>/blog/posts/8d60b485/</url>
      
        <content type="html"><![CDATA[<p> åŠ è½½å·²å®‰è£…åº”ç”¨ã€æœªå®‰è£…apkä¸­çš„èµ„æºï¼Œå…¶æ€è·¯ä¸»è¦æ˜¯è·å–åˆ°å¯¹åº”çš„ClassLoader/Contextï¼Œé€šè¿‡ClassLoaderåŠ è½½R.javaç­‰ç±»ï¼Œå†é€šè¿‡åå°„è·å–å¯¹åº”çš„èµ„æºidåŠèµ„æºã€‚</p><h1 id="åŠ è½½å·²å®‰è£…åº”ç”¨èµ„æº"><a href="#åŠ è½½å·²å®‰è£…åº”ç”¨èµ„æº" class="headerlink" title="åŠ è½½å·²å®‰è£…åº”ç”¨èµ„æº"></a>åŠ è½½å·²å®‰è£…åº”ç”¨èµ„æº</h1><h2 id="sharedUserId"><a href="#sharedUserId" class="headerlink" title="sharedUserId"></a>sharedUserId</h2><p>åœ¨å½“å‰åº”ç”¨ä¸­åŠ è½½å·²å®‰è£…çš„å…¶ä»–åº”ç”¨èµ„æºï¼Œéœ€è¦äºŒè€…æœ‰ç›¸åŒçš„<code>sharedUserId</code>ï¼Œè¿™æ ·Androidç³»ç»Ÿä¸ºäºŒè€…åˆ†é…åŒä¸€ä¸ªLinuxç”¨æˆ·IDï¼Œä¸¤ä¸ªAppå¯ä»¥ç›¸äº’è®¿é—®ä»£ç ã€èµ„æºç­‰ã€‚</p><blockquote><p>é€šè¿‡Shared User id,æ‹¥æœ‰åŒä¸€ä¸ªUser idçš„å¤šä¸ªAPKå¯ä»¥é…ç½®æˆè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­.æ‰€ä»¥é»˜è®¤å°±æ˜¯å¯ä»¥äº’ç›¸è®¿é—®ä»»æ„æ•°æ®. ä¹Ÿå¯ä»¥é…ç½®æˆè¿è¡Œæˆä¸åŒçš„è¿›ç¨‹, åŒæ—¶å¯ä»¥è®¿é—®å…¶ä»–APKçš„æ•°æ®ç›®å½•ä¸‹çš„æ•°æ®åº“å’Œæ–‡ä»¶.å°±åƒè®¿é—®æœ¬ç¨‹åºçš„æ•°æ®ä¸€æ ·ã€‚</p><p><a href="https://blog.csdn.net/jiangwei0910410003/article/details/51316688" target="_blank" rel="noopener">Androidé€†å‘ä¹‹æ—…â€”Androidä¸­çš„sharedUserIdå±æ€§è¯¦è§£ - CSDNåšå®¢</a></p></blockquote><p>å…·ä½“è®¾ç½®æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"cf.android666.dynamicloadapk"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:sharedUserId</span>=<span class="string">"cf.android666.dynamic"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ç­›é€‰æ‰€æœ‰å·²å®‰è£…åº”ç”¨ä¿¡æ¯"><a href="#ç­›é€‰æ‰€æœ‰å·²å®‰è£…åº”ç”¨ä¿¡æ¯" class="headerlink" title="ç­›é€‰æ‰€æœ‰å·²å®‰è£…åº”ç”¨ä¿¡æ¯"></a>ç­›é€‰æ‰€æœ‰å·²å®‰è£…åº”ç”¨ä¿¡æ¯</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> packageBeanList: ArrayList&lt;PackageInfoBean&gt; = arrayListOf()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> packageInfoList: ArrayList&lt;PackageInfo&gt; = arrayListOf()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> packageInfoList = packageManager.getInstalledPackages(PackageManager.GET_UNINSTALLED_PACKAGES) <span class="keyword">as</span> ArrayList&lt;PackageInfo&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (packageInfoList.isNotEmpty()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (x <span class="keyword">in</span> packageInfoList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.sharedUserId != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; x.sharedUserId.equals(sharedUid)</span><br><span class="line">            &amp;&amp; !x.packageName.equals(packageName)) &#123;</span><br><span class="line">            <span class="comment">//sharedUserIdä¸å½“å‰Appç›¸åŒï¼Œä¸”packageNameå’Œå½“å‰Appä¸åŒçš„Appä¿¡æ¯ï¼Œå³æ’ä»¶App</span></span><br><span class="line">            packageBeanList.add(PackageInfoBean(packageManager</span><br><span class="line">                                                .getApplicationLabel(x.applicationInfo).toString(), x.packageName))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆæ’ä»¶Appçš„Context"><a href="#ç”Ÿæˆæ’ä»¶Appçš„Context" class="headerlink" title="ç”Ÿæˆæ’ä»¶Appçš„Context"></a>ç”Ÿæˆæ’ä»¶Appçš„Context</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">activity.createPackageContext(<span class="string">"cf.android666.pluginapp"</span>,</span><br><span class="line">        Context.CONTEXT_INCLUDE_CODE | Context.CONTEXT_IGNORE_SECURITY)</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡Contextåå°„è·å–æ’ä»¶Appä¸­çš„èµ„æº"><a href="#é€šè¿‡Contextåå°„è·å–æ’ä»¶Appä¸­çš„èµ„æº" class="headerlink" title="é€šè¿‡Contextåå°„è·å–æ’ä»¶Appä¸­çš„èµ„æº"></a>é€šè¿‡Contextåå°„è·å–æ’ä»¶Appä¸­çš„èµ„æº</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–ClassLoader</span></span><br><span class="line"><span class="keyword">var</span> pClassLoader = PathClassLoader(pluginContext.packageResourcePath</span><br><span class="line">                , ClassLoader.getSystemClassLoader())</span><br><span class="line"><span class="comment">//åå°„è·å–è¯¥ç±»åŠå…¶èµ„æº</span></span><br><span class="line"><span class="keyword">var</span> clazz = pluginContext.classLoader</span><br><span class="line">        .loadClass(pluginContext.packageName + <span class="string">".R\$mipmap"</span>)</span><br><span class="line"><span class="keyword">var</span> abc = clazz.getField(s)</span><br><span class="line"><span class="keyword">var</span> id = abc.getInt(R.mipmap::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line"><span class="comment">//è°ƒç”¨æ’ä»¶Appçš„Contextè·å–å…¶èµ„æº</span></span><br><span class="line"><span class="keyword">var</span> bg = pluginContext.resources.getDrawable(id)</span><br></pre></td></tr></table></figure><h1 id="åŠ è½½æœªå®‰è£…Apkå†…èµ„æº"><a href="#åŠ è½½æœªå®‰è£…Apkå†…èµ„æº" class="headerlink" title="åŠ è½½æœªå®‰è£…Apkå†…èµ„æº"></a>åŠ è½½æœªå®‰è£…Apkå†…èµ„æº</h1><h2 id="è·å–apkä¿¡æ¯"><a href="#è·å–apkä¿¡æ¯" class="headerlink" title="è·å–apkä¿¡æ¯"></a>è·å–apkä¿¡æ¯</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sdPath = Environment.getExternalStorageDirectory().absolutePath</span><br><span class="line"><span class="keyword">val</span> apkPath = <span class="string">"<span class="variable">$sdPath</span>/plugin/plugin.apk"</span></span><br><span class="line"><span class="keyword">var</span> info = packageManager.getPackageArchiveInfo(apkPath, PackageManager.GET_ACTIVITIES)<span class="comment">//è·å–æœªå®‰è£…apkçš„packageInfo</span></span><br></pre></td></tr></table></figure><h2 id="è·å–ClassLoader"><a href="#è·å–ClassLoader" class="headerlink" title="è·å–ClassLoader"></a>è·å–ClassLoader</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> file = getDir(<span class="string">"dex"</span>, Context.MODE_PRIVATE)</span><br><span class="line"><span class="keyword">var</span> dexClassLoader = DexClassLoader(apkPath, file.absolutePath, <span class="literal">null</span>, ClassLoader.getSystemClassLoader())</span><br></pre></td></tr></table></figure><blockquote><p>getDir()è°ƒç”¨äº†Contextçš„getDir()</p><p>Retrieve, creating if needed, a new directory in which the application can place its own custom data files.  You can use the returned File object to create and access files in this directory.  Note that files created through a File object will only be accessible by your own application; you can only set the mode of the entire directory, not of individual files.</p></blockquote><h2 id="é€šè¿‡åå°„åŠ è½½ç±»ï¼Œè·å–èµ„æº"><a href="#é€šè¿‡åå°„åŠ è½½ç±»ï¼Œè·å–èµ„æº" class="headerlink" title="é€šè¿‡åå°„åŠ è½½ç±»ï¼Œè·å–èµ„æº"></a>é€šè¿‡åå°„åŠ è½½ç±»ï¼Œè·å–èµ„æº</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> drawableClazz = dexClassLoader.loadClass(<span class="string">"cf.android666.pluginapp.R\$drawable"</span>)</span><br><span class="line"><span class="keyword">var</span> onePng = drawableClazz.getDeclaredField(<span class="string">"abc"</span>)</span><br><span class="line"><span class="keyword">var</span> onId = onePng.getInt(R.id::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)//åå°„è·å–èµ„æº<span class="title">id</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resources = getUninstallApkResource()<span class="comment">//resourceä¹Ÿæ˜¯é€šè¿‡åå°„è·å–åˆ°</span></span><br><span class="line"><span class="keyword">var</span> drawable = resources.getDrawable(onId)</span><br></pre></td></tr></table></figure><p><code>AssetManager.addAssetPath()</code>æ–¹æ³•æ˜¯ç”¨æ¥å°†apkç­‰ä¸­çš„èµ„æºæ·»åŠ åˆ°<code>AssetManager</code>ä¸­ï¼Œå†é€šè¿‡å…¶è·å–åˆ°<code>Resourceså¯¹è±¡</code>ï¼Œè¿™æ ·å°±è·å–åˆ°æœªå®‰è£…apkä¸­çš„èµ„æºäº†ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getUninstallApkResource</span><span class="params">()</span></span>: Resources &#123;</span><br><span class="line">    <span class="keyword">var</span> assetManager = AssetManager::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">newInstance</span></span>()</span><br><span class="line">    <span class="keyword">var</span> addAssetPath = assetManager.javaClass.getMethod(<span class="string">"addAssetPath"</span>,String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">    addAssetPath.invoke(assetManager, apkPath)<span class="comment">//è®¾ç½®äº†apkPath</span></span><br><span class="line">    <span class="keyword">return</span> Resources(assetManager, resources.displayMetrics, resources.configuration)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æº"><a href="#å‚è€ƒèµ„æº" class="headerlink" title="å‚è€ƒèµ„æº"></a>å‚è€ƒèµ„æº</h1><p><a href="https://www.cnblogs.com/lee0oo0/p/3665066.html" target="_blank" rel="noopener">Androidä¹‹Android apkåŠ¨æ€åŠ è½½æœºåˆ¶çš„ç ”ç©¶ï¼ˆäºŒï¼‰ï¼šèµ„æºåŠ è½½å’Œactivityç”Ÿå‘½å‘¨æœŸç®¡ç† - lee0oo0 - åšå®¢å›­  </a></p><p><a href="https://blog.csdn.net/jiangwei0910410003/article/details/51316688" target="_blank" rel="noopener">Androidé€†å‘ä¹‹æ—…â€”Androidä¸­çš„sharedUserIdå±æ€§è¯¦è§£ - CSDNåšå®¢</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMç±»åŠ è½½æœºåˆ¶ä¹‹ClassLoader</title>
      <link href="/blog/posts/b3994218/"/>
      <url>/blog/posts/b3994218/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä¸º<a href="https://blog.csdn.net/briblue/article/details/54973413" target="_blank" rel="noopener">ã€Šä¸€çœ‹ä½ å°±æ‡‚ï¼Œè¶…è¯¦ç»†javaä¸­çš„ClassLoaderè¯¦è§£ - CSDNåšå®¢ã€‹</a>é˜…è¯»ç¬”è®°</p></blockquote><h1 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h1><p>JVMæœ‰ä¸‰ç§ç±»åŠ è½½å™¨ï¼š</p><ol><li><strong>BootStrap ClassLoader</strong> å¯åŠ¨ç±»åŠ è½½å™¨ï¼ŒåŠ è½½æ ¸å¿ƒç±»åº“ï¼Œä¸»è¦åŠ è½½æ ¸å¿ƒç±»åº“ï¼Œ%JRE_HOME%\libä¸‹çš„rt.jarã€resources.jarã€charsets.jarå’Œclassç­‰ã€‚</li><li><strong>Extention ClassLoader</strong> æ‰©å±•ç±»åŠ è½½å™¨ï¼ŒåŠ è½½ç›®å½•%JRE_HOME%\lib\extç›®å½•ä¸‹çš„jaråŒ…å’Œclassæ–‡ä»¶ã€‚</li><li><strong>App ClassLoader</strong> åº”ç”¨ç¨‹åºåŠ è½½å™¨ï¼ŒåŠ è½½å½“å‰åº”ç”¨çš„classpathçš„æ‰€æœ‰ç±»ã€‚</li></ol><p>é™¤ä»¥ä¸Šä¸‰ç§å¤–ï¼Œè¿˜æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚</p><p>æ¯ä¸ªç±»ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œç±»æœ¬èº«ç¡®å®šå…¶å”¯ä¸€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç±»åŠ è½½å™¨ä¸åŒï¼Œç±»è‚¯å®šä¸åŒã€‚</p><h1 id="åŠ è½½è¿‡ç¨‹"><a href="#åŠ è½½è¿‡ç¨‹" class="headerlink" title="åŠ è½½è¿‡ç¨‹"></a>åŠ è½½è¿‡ç¨‹</h1><p>åœ¨åŠ è½½ç±»æ—¶ï¼Œé€šè¿‡<strong>â€œåŒäº²å§”æ‰˜â€</strong>æœºåˆ¶ï¼Œä¾æ¬¡ä»<strong>1</strong> -&gt; <strong>3</strong>å‘ä¸ŠæŸ¥è¯¢ï¼Œå†ä»<strong>3</strong>-&gt;<strong>1</strong>ä¾æ¬¡è¿”å›ç»“æœï¼š</p><ol><li>è°ƒç”¨<code>findLoadedClass(className)</code>æŸ¥è¯¢æ˜¯å¦å·²ç»åŠ è½½è¯¥ç±»</li><li>è°ƒç”¨çˆ¶åŠ è½½å™¨çš„<code>loadClass(className,false)</code>ï¼Œè‹¥çˆ¶åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨<code>BootStrap ClassLoader</code></li><li>å¦‚æœè¿˜æ˜¯æ²¡æœ‰åŠ è½½åˆ°è¯¥ç±»ï¼Œè°ƒç”¨<code>findClass(className)</code></li></ol><p>è¿™æ ·å­ä¿è¯äº†æ¯ä¸ªç±»éƒ½æ˜¯å…ˆç»è¿‡æœ€é¡¶ç«¯çš„ç±»åŠ è½½å™¨<code>BootStrap ClassLoader</code>ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½åˆ°å†ä¾æ¬¡ç»è¿‡<code>Extention ClassLoader</code>ã€<code>App ClassLoader</code> åŠ è½½ï¼Œç¡®ä¿å¦‚Stringç­‰å…³é”®ç±»ä¸ä¼šè¢«è‡ªå®šä¹‰çš„ClassLoaderåŠ è½½è€Œå¯¼è‡´å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// é¦–å…ˆï¼Œæ£€æµ‹æ˜¯å¦å·²ç»åŠ è½½</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//çˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºåˆ™è°ƒç”¨çˆ¶åŠ è½½å™¨çš„loadClass</span></span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//çˆ¶åŠ è½½å™¨ä¸ºç©ºåˆ™è°ƒç”¨Bootstrap Classloader</span></span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                    <span class="comment">//çˆ¶åŠ è½½å™¨æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è°ƒç”¨findclass</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨resolveClass()</span></span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>AppClassLoader</code>å’Œ<code>ExtClassLoader</code>éƒ½ç»§æ‰¿è‡ª<code>URLClassLoader</code></p><p><code>AppClassLoader</code>çš„çˆ¶åŠ è½½å™¨æ˜¯<code>ExtClassLoader</code>ï¼Œ<code>ExtClassLoader</code>çš„çˆ¶åŠ è½½å™¨ä¸º<code>null</code>ï¼Œæ•…è€Œä¼šè°ƒç”¨<code>BootStrap ClassLoader</code></p><p>ClassLoaderå¦‚æœæ²¡æœ‰æŒ‡å®šçˆ¶åŠ è½½å™¨ï¼Œåˆ™é»˜è®¤çš„çˆ¶åŠ è½½å™¨ä¸º<code>AppClassLoader</code>ï¼Œè‡ªå®šä¹‰ClassLoaderä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><h1 id="è‡ªå®šä¹‰ClassLoader"><a href="#è‡ªå®šä¹‰ClassLoader" class="headerlink" title="è‡ªå®šä¹‰ClassLoader"></a>è‡ªå®šä¹‰ClassLoader</h1><p>è‡ªå®šä¹‰ClassLoaderä¸€èˆ¬æ­¥éª¤ï¼š</p><ol><li>ç»§æ‰¿è‡ª<code>ClassLoader</code></li><li>é‡å†™<code>findClass()</code></li><li>åœ¨<code>findClass()</code>æ–¹æ³•ä¸­è°ƒç”¨å¹¶è¿”å›<code>defineClass()</code></li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MClasLoader</span>:<span class="type">ClassLoader</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">findClass</span><span class="params">(name: <span class="type">String</span>?)</span></span>: Class&lt;*&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sysDir = System.getProperty(<span class="string">"user.dir"</span>)</span><br><span class="line">        <span class="keyword">var</span> classPath = <span class="string">"<span class="variable">$sysDir</span>/src/main/res/<span class="variable">$name</span>.class"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> classFile = File(classPath)</span><br><span class="line">        <span class="comment">//ã€æ³¨æ„ã€‘è¿™é‡Œä¸€æ¬¡åªè¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œå¦åˆ™ä¼šæŠ¥é”™java.lang.ClassFormatError:</span></span><br><span class="line">        <span class="comment">// Extra bytes at the end of class file TestClass</span></span><br><span class="line">        <span class="keyword">var</span> bytes = ByteArray(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">var</span> fileInputStream = FileInputStream(classFile)</span><br><span class="line">        <span class="keyword">var</span> len = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> byteBuffer = ByteOutputStream()</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            len = fileInputStream.read(bytes)</span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                byteBuffer.write(bytes)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> byteArr = byteBuffer.toByteArray()</span><br><span class="line">        <span class="keyword">return</span> defineClass(name,byteArr,<span class="number">0</span>,byteArr.size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> clazz = MClasLoader().loadClass(<span class="string">"TestClass"</span>)</span><br><span class="line">    <span class="keyword">var</span> say = clazz.getDeclaredMethod(<span class="string">"say"</span>,String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">    say.invoke(clazz.newInstance(),<span class="string">"hello world"</span>)</span><br><span class="line"></span><br><span class="line">    print(MClasLoader().parent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>defineClass()</code>åˆ™å°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„è½¬åŒ–ä¸ºä¸€ä¸ªç±»çš„å®ä¾‹ï¼ˆConverts an array of bytes into an instance of class with an optional ProtectionDomainï¼‰</p><h1 id="contextClassLoader"><a href="#contextClassLoader" class="headerlink" title="contextClassLoader"></a>contextClassLoader</h1><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªClassLoaderï¼š<code>contextClassLoader</code>ï¼Œé€šè¿‡å°†å…¶è®¾ç½®ä¸ºè‡ªå®šä¹‰çš„ClassLoaderå¯ä»¥åœ¨åŠ è½½ç±»çš„æ—¶å€™åšä¸€äº›ç‰¹æ®Šçš„äº‹æƒ…ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().contextClassLoader = MClasLoader()</span><br><span class="line"><span class="keyword">var</span> clazz = Class.forName(<span class="string">"TestClass"</span>,</span><br><span class="line">        <span class="literal">true</span>, Thread.currentThread().contextClassLoader)</span><br><span class="line"><span class="keyword">var</span> say = clazz.getDeclaredMethod(<span class="string">"say"</span>,String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">say.invoke(clazz.newInstance(),<span class="string">"hello world"</span>)</span><br><span class="line"></span><br><span class="line">println(Thread.currentThread().contextClassLoader )</span><br><span class="line">println(Thread.currentThread().contextClassLoader.parent )</span><br></pre></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello world</span><br><span class="line">MClasLoader@1d44bcfa</span><br><span class="line">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ Handlerã€Messageã€Looper</title>
      <link href="/blog/posts/5962504e/"/>
      <url>/blog/posts/5962504e/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ­¤æ–‡ä¸ºé¸¿æ´‹åšå®¢é˜…è¯»ç¬”è®°ï¼Œé…åˆåŸæ–‡é£Ÿç”¨å£å‘³æ›´ä½³ã€‚</p><p><a href="https://blog.csdn.net/lmj623565791/article/details/38377229" target="_blank" rel="noopener">Android å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ è®©ä½ æ·±å…¥ç†è§£ Looperã€Handlerã€Messageä¸‰è€…å…³ç³» - CSDNåšå®¢</a></p></blockquote><h1 id="å¯¼å›¾"><a href="#å¯¼å›¾" class="headerlink" title="å¯¼å›¾"></a>å¯¼å›¾</h1><p><img src="https://jixiaoyong.github.io/images/20200429160005.png" alt="20200429160005"></p><h1 id="è¿‡ç¨‹åˆ†æ"><a href="#è¿‡ç¨‹åˆ†æ" class="headerlink" title="è¿‡ç¨‹åˆ†æ"></a>è¿‡ç¨‹åˆ†æ</h1><h2 id="Looper"><a href="#Looper" class="headerlink" title="Looper"></a>Looper</h2><h3 id="Looper-perpare"><a href="#Looper-perpare" class="headerlink" title="Looper.perpare()"></a><strong>Looper.perpare()</strong></h3><p><code>Looper.perpare()</code>æ–¹æ³•åˆ›å»º<code>Looperå¯¹è±¡</code>ï¼ˆåŒæ—¶åˆ›å»º<code>MessageQueueå¯¹è±¡</code>ï¼‰ï¼Œå¹¶ä¸å½“å‰çº¿ç¨‹å…³è”ä¿å­˜åœ¨<code>sThreadLocal</code>ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        sThreadLocal.set(<span class="keyword">new</span> Looper(<span class="keyword">true</span>));  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;  </span><br><span class="line">        mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);  </span><br><span class="line">        mRun = <span class="keyword">true</span>;  </span><br><span class="line">        mThread = Thread.currentThread();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Looper-loop"><a href="#Looper-loop" class="headerlink" title="Looper.loop()"></a><strong>Looper.loop()</strong></h3><p><code>Looper.loop()</code>æ–¹æ³•è·å–ä¿å­˜çš„<code>Looperå¯¹è±¡</code>å¹¶ç”±æ­¤è·å–åˆ°<code>MessageQueueå¯¹è±¡</code>ã€‚</p><p>é€šè¿‡<code>forå¾ªç¯</code>ï¼Œä¸åœçš„é€šè¿‡<code>mQueue</code>è·å–åˆ°<code>msg</code>ï¼Œå¹¶è°ƒç”¨<code>msg.target.dispatchMessage(msg)</code>æ‰§è¡Œmsgå¯¹åº”çš„å¤„ç†æ–¹æ³•ã€‚</p><p>æœ€åé€šè¿‡<code>msg.recycle()</code>å›æ”¶ä½¿ç”¨å®Œçš„msgã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;  </span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block  </span></span><br><span class="line">        ...</span><br><span class="line">        msg.target.dispatchMessage(msg); </span><br><span class="line">        ...</span><br><span class="line">        msg.recycle();  </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="Looper-myLooper"><a href="#Looper-myLooper" class="headerlink" title="Looper.myLooper()"></a><strong>Looper.myLooper()</strong></h3><p><code>myLooper()</code>å†…éƒ¨è°ƒç”¨<code>sThreadLocal</code>è·å–å·²æœ‰çš„<code>Looperå¯¹è±¡</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Looper myLooper() &#123;</span><br><span class="line">    return sThreadLocal.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Androidçš„Activityé»˜è®¤åœ¨UIçº¿ç¨‹è°ƒç”¨äº†Looperçš„<code>prepare()</code>å’Œ<code>loop()</code>æ–¹æ³•</strong></p><h2 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h2><h3 id="handler-sendMessage"><a href="#handler-sendMessage" class="headerlink" title="handler.sendMessage()"></a>handler.sendMessage()</h3><p>Handleræ„é€ æ–¹æ³•ä¼šè·å–åˆ°<code>mLooper</code>å’Œ<code>mQueue</code>ä»¥åŠ<code>mCallback</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mLooper = Looper.myLooper();  </span><br><span class="line">mQueue = mLooper.mQueue;  </span><br><span class="line">mCallback = callback;  <span class="comment">// Handler()ä¸­æ­¤å€¼ä¸ºnull</span></span><br></pre></td></tr></table></figure><p><code>sendMessage()</code>æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨<code>sendMessageAtTime()</code>æ–¹æ³•,åœ¨å…¶å†…éƒ¨è°ƒç”¨<code>enqueueMessage()</code>æ–¹æ³•ï¼Œå°†handlerèµ‹äºˆmsg.targetï¼Œå¹¶å°†msgå‹å…¥mQueueä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//enqueueMessageæ–¹æ³•</span></span><br><span class="line">msg.target = <span class="keyword">this</span>;</span><br><span class="line">queue.enqueueMessage(msg, uptimeMillis);<span class="comment">//å°†handlerå‘é€çš„msgå‹å…¥åˆ°å½“å‰çº¿ç¨‹çš„LooperæŒæœ‰çš„MessageQueueä¸­</span></span><br></pre></td></tr></table></figure><h3 id="handler-dispatchMessage"><a href="#handler-dispatchMessage" class="headerlink" title="handler.dispatchMessage()"></a>handler.dispatchMessage()</h3><p>Handlerçš„<code>dispatchMessage()</code>æ–¹æ³•ä¼šåœ¨<code>Looper.loop()</code>ä¸­è¢«è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;  <span class="comment">//msgè‡ªå¸¦çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">            handleCallback(msg);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;  <span class="comment">//handleræŒ‡å®šçš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;  </span><br><span class="line">                    <span class="keyword">return</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            handleMessage(msg);  <span class="comment">//handlerçš„handleMessage()æ–¹æ³•</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ‰§è¡Œé¡ºåºæ˜¯ï¼š<code>msg.callback</code> &gt; <code>mCallback</code> &gt; <code>handleMessage()</code></p><h3 id="handler-post"><a href="#handler-post" class="headerlink" title="handler.post()"></a>handler.post()</h3><p><code>handler.post(new Runnable())</code>è°ƒç”¨äº†<code>getPostMessage(r)</code>æ–¹æ³•å°†rèµ‹äºˆmsg.callback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable r)</span>  </span>&#123;  </span><br><span class="line">      <span class="keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="number">0</span>);  </span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;  </span><br><span class="line">      Message m = Message.obtain();  </span><br><span class="line">      m.callback = r;  </span><br><span class="line">      <span class="keyword">return</span> m;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¹Ÿæ˜¯åœ¨<code>sendMessageDelayedæ–¹æ³•</code>ä¸­è°ƒç”¨<code>sendMessageAtTime()æ–¹æ³•</code>å°†msgå‹å…¥MessageQueueä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessageDelayed</span><span class="params">(Message msg, <span class="keyword">long</span> delayMillis)</span>  </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="msgçš„è·å–"><a href="#msgçš„è·å–" class="headerlink" title="msgçš„è·å–"></a>msgçš„è·å–</h2><ul><li><code>Message.obtain();</code> å¤ç”¨MessageMessageæ± ä¸­å·²æœ‰çš„å¯¹è±¡ï¼Œé¿å…å‡ºç°åˆ†é…å†…å­˜ <strong>æ¨è</strong> </li><li><code>new Message();</code></li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><strong>Looper</strong>åœ¨<strong><code>perfare()</code></strong>æ–¹æ³•ä¸­åˆ›å»º<code>LooperåŠMessageQueueå¯¹è±¡</code>å¹¶ä¿å­˜åœ¨<code>sThreadLocal</code>ä¸­ï¼Œ</p><p>åœ¨<strong><code>loop()</code></strong>æ–¹æ³•ä¸­é€šè¿‡<code>myLooper()</code>ä»<code>sThreadLocal</code>ä¸­å–å‡º<code>mLooper</code>ï¼Œå¹¶ç”±æ­¤è·å¾—<code>mQueue</code>ï¼Œåœ¨forå¾ªç¯ä¸­é€šè¿‡<code>mQueue.next()</code>è·å–<code>msg</code>ï¼Œç”¨<code>msg.target.dispatchMessage()</code>æ–¹æ³•å›è°ƒ<code>handlerä¸­çš„msgå¤„ç†æ–¹æ³•</code>ã€‚</p><p><strong>Handler</strong>åœ¨<strong><code>æ„é€ å‡½æ•°</code></strong>ä¸­é€šè¿‡<code>Looper.myLooper()</code>è·å–åˆ°<code>å½“å‰çº¿ç¨‹çš„Looperå’ŒMessageQueue</code>ï¼›</p><p><strong><code>sendMessage()</code></strong>æ–¹æ³•æœ€ç»ˆé€šè¿‡<code>sendMessageAtTime()</code>è°ƒç”¨<code>enqueueMessage()</code>æ–¹æ³•<code>å°†msgå‹å…¥åˆ°MessageQueue</code>ä¸­ã€‚</p><p>è‡³æ­¤å°†<em>Looperå’ŒHandleré€šè¿‡MessageQueueè”ç³»åœ¨ä¸€èµ·</em>ï¼Œå¹¶å…±åŒå‚ä¸å¤„ç†Messageã€‚</p><p>æ­¤å¤–<strong><code>handler.post(runnable)</code></strong>ä¹Ÿæ˜¯é€šè¿‡åœ¨<strong><code>post()</code></strong>å†…éƒ¨è°ƒç”¨<code>getPostMessage()</code>æ–¹æ³•å°†<code>runnableèµ‹äºˆmsg.callback</code>ï¼Œå¹¶åœ¨<code>post()</code>ä¸­é€šè¿‡<code>sendMessageDelayed()</code>æ–¹æ³•è°ƒç”¨<code>sendMessageAtTime()æ–¹æ³•</code>å°†<code>msgå‹å…¥MessageQueue</code>ä¸­</p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidå¤šæ¸ é“æ‰“åŒ…çŸ¥è¯†</title>
      <link href="/blog/posts/a3a3dc4c/"/>
      <url>/blog/posts/a3a3dc4c/</url>
      
        <content type="html"><![CDATA[<p>å›½å†…Androidåº”ç”¨å¸¸å¸¸è¦åˆ†å‘åˆ°å¤šä¸ªåº”ç”¨å•†åº—ï¼Œä½¿ç”¨Android Studioæ­£ç¡®é…ç½®build.gradleä¸AndroidManifest.xmlæ–‡ä»¶å¯ä»¥<strong>ä¸€æ­¥æ‰“åŒ…å¤šä¸ªæ¸ é“</strong>ã€‚</p><p>æœ¬æ–‡å®ç°çš„å¤šæ¸ é“æ‰“åŒ…å¯å®ç°ä¸åŒæ¸ é“ï¼š</p><ul><li>æœ‰ä¸åŒçš„é¡¹ç›®idï¼ˆapplicationIdï¼‰</li><li>ä¸åŒAppåç§°ï¼ˆandroid:labelï¼‰</li><li>ä¸åŒAppå›¾æ ‡ï¼ˆandroid:iconï¼‰</li><li>ç­‰ç­‰</li></ul><h1 id="1-å‹ç›Ÿé…ç½®"><a href="#1-å‹ç›Ÿé…ç½®" class="headerlink" title="1.å‹ç›Ÿé…ç½®"></a>1.å‹ç›Ÿé…ç½®</h1><p>*å…·ä½“é…ç½®è¯·å‚è€ƒUMengå®˜æ–¹æ–‡æ¡£ã€‚</p><p>ä½œä¸ºç¬¬ä¸‰æ–¹ç»Ÿè®¡å¹³å°ï¼Œå›½å†…å¾ˆå¤šè½¯ä»¶éƒ½ä½¿ç”¨çš„æ˜¯Umengçš„äº§å“ï¼Œæ•…è€Œå¤§å¤šæ•°è½¯ä»¶å¤šæ¸ é“æ‰“åŒ…é…ç½®å¦‚ä¸‹ï¼š</p><ul><li>æ·»åŠ ä¾èµ–</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">../app/build.gradle</span><br><span class="line">dependencies &#123;</span><br><span class="line"><span class="comment">//å‹ç›Ÿsdk</span></span><br><span class="line">compile <span class="string">'com.umeng.sdk:common:latest.integration'</span></span><br><span class="line">compile <span class="string">'com.umeng.sdk:analytics:latest.integration'</span></span><br><span class="line">...&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹AndroidManifest.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">&lt;!--å‹ç›Ÿåˆå§‹åŒ–appkeyå’Œchannel--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:value</span>=<span class="string">"$&#123;APP_KEY&#125;"</span> <span class="attr">android:name</span>=<span class="string">"UMENG_APPKEY"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">"UMENG_CHANNEL"</span> <span class="attr">android:value</span>=<span class="string">"$&#123;UMENG_CHANNEL_VALUE&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹build.gradle</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line"> productFlavors &#123;</span><br><span class="line">        beta &#123;&#125;</span><br><span class="line">        baidu &#123;&#125;</span><br><span class="line">        zhushou91  &#123;&#125; <span class="comment">//ä¸èƒ½ä»¥æ•°å­—å¼€å¤´</span></span><br><span class="line">        anzhi &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    productFlavors.all &#123;</span><br><span class="line"></span><br><span class="line">        flavor -&gt; flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name</span><br><span class="line">                                                 ,APP_KEY:umenInfo[<span class="string">'APP_KEY'</span>]]</span><br><span class="line">            <span class="comment">//è¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œç”¨build.gradleè¯»å–propertiesæ–‡ä»¶ä¿¡æ¯ï¼Œç”¨äºå°†éƒ¨åˆ†ä¿¡æ¯ç»Ÿä¸€æ”¾ç½®åœ¨æœ¬åœ°é…ç½®æ–‡ä»¶ä¸­ï¼Œé¿å…æ³„æ¼ï¼Œè‹¥æ— æ­¤ç±»è¦æ±‚å¯ç›´æ¥ä½¿ç”¨ APP_KEY:'da15d26d1a'ç­‰</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è§£å†³flavor Dimensionsé—®é¢˜  http://blog.csdn.net/syif88/article/details/75009663</span></span><br><span class="line">    flavorDimensions <span class="string">"versionCode"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å…¶ä»–umengè¦æ±‚çš„é…ç½®</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ç¼–è¯‘å®Œä¹‹åï¼Œé€šè¿‡é€šè¿‡build&gt;Generate Signed APKâ€¦ä¾¿å¯ä»¥æ‰“åŒ…ä¸åŒæ¸ é“çš„apkï¼Œåœ¨å‹ç›Ÿç»Ÿè®¡å¹³å°ä¸Šç»Ÿè®¡å„ä¸ªæ¸ é“çš„Appä¿¡æ¯äº†ã€‚</p><h1 id="2-Android-Studioå®ç°å¤šæ¸ é“æ‰“åŒ…"><a href="#2-Android-Studioå®ç°å¤šæ¸ é“æ‰“åŒ…" class="headerlink" title="2.Android Studioå®ç°å¤šæ¸ é“æ‰“åŒ…"></a>2.Android Studioå®ç°å¤šæ¸ é“æ‰“åŒ…</h1><p>æ–¹æ³•1è¦æ±‚ä¾èµ–umengæ¨¡å—ï¼Œä½¿ç”¨åœºæ™¯éš¾å…æœ‰äº›å—é™ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å®ç°å¤šæ¸ é“æ‰“åŒ…ï¼Œæ–¹æ³•1ä½¿ç”¨çš„åº”è¯¥ä¹Ÿæ˜¯æ­¤åŸç†ã€‚</p><ul><li>AndroidManifest.xml</li></ul><p>åœ¨éœ€è¦æ ¹æ®æ¸ é“ä¸åŒè€Œå˜åŒ–çš„åœ°æ–¹ä½¿ç”¨<code>${KEY}</code>å½¢å¼æ›¿æ¢æ‰åŸå…ˆçš„å€¼ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:label</span>=<span class="string">"$&#123;APP_NAME&#125;"</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">"APP_TEXT"</span> <span class="attr">android:value</span>=<span class="string">"$&#123;APP_TEXT&#125;"</span>/&gt;</span>//å¯ä»¥åœ¨javaæ–‡ä»¶ä¸­è·å–åˆ°</span><br></pre></td></tr></table></figure><ul><li>app/build.gradle</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">    beta &#123;applicationId = <span class="string">"cf.android666.mykotlin.beta"</span><span class="comment">//æ¯ä¸ªæ¸ é“æœ‰ä¸åŒçš„åŒ…å</span></span><br><span class="line">        manifestPlaceholders = [APP_NAME : name ,APP_TEXT:<span class="string">'beta'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    baidu &#123;applicationId = <span class="string">"cf.android666.mykotlin.baidu"</span></span><br><span class="line">        manifestPlaceholders = [APP_NAME:<span class="string">'A APP'</span>,APP_TEXT:<span class="string">'baidu'</span>]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨javaä¸­è·å–<code>meta-data</code>ï¼ˆéå¿…é¡»ï¼‰</li></ul><blockquote><p>Androidè·å–Manifestä¸­<meta-data>å…ƒç´ çš„å€¼ - CSDNåšå®¢  <a href="https://blog.csdn.net/zhang31jian/article/details/29868235" target="_blank" rel="noopener">https://blog.csdn.net/zhang31jian/article/details/29868235</a></meta-data></p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//applicationä¸­çš„meta-data</span></span><br><span class="line"><span class="keyword">var</span> appInfo = context.packageManager.getApplicationInfo(context.packageName,</span><br><span class="line">        PackageManager.GET_META_DATA)</span><br><span class="line"><span class="comment">//serviceã€receiverä¸­çš„meta-data</span></span><br><span class="line"><span class="keyword">var</span> appInfo = context.packageManager.getServiceInfo(ComponentName(context,MService::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>),<span class="type"></span></span></span><br><span class="line">                PackageManager.GET_META_DATA)</span><br><span class="line"><span class="keyword">var</span> appName = appInfo.metaData.getString(<span class="string">"APP_NAME"</span>)</span><br></pre></td></tr></table></figure><h1 id="3-ç”Ÿæˆå¤šä¸ªæ¸ é“æ–‡ä»¶å¤¹"><a href="#3-ç”Ÿæˆå¤šä¸ªæ¸ é“æ–‡ä»¶å¤¹" class="headerlink" title="3.ç”Ÿæˆå¤šä¸ªæ¸ é“æ–‡ä»¶å¤¹"></a>3.ç”Ÿæˆå¤šä¸ªæ¸ é“æ–‡ä»¶å¤¹</h1><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œé€šè¿‡åœ¨é¡¹ç›®ä¸­ç”Ÿæˆå¤šä¸ªæ¸ é“çš„æ–‡ä»¶å¤¹ï¼Œåœ¨é‡Œé¢æ›¿æ¢å¯¹åº”çš„èµ„æºæ–‡ä»¶ï¼Œä»è€Œå®ç°å¤šæ¸ é“æ‰“åŒ…ä¸åŒé¡¹ç›®åï¼Œä¸åŒiconç­‰ç­‰</p><ul><li><p>åœ¨../app/src/ç›®å½•ä¸‹æ–°å»ºå¯¹åº”æ¸ é“æ–‡ä»¶å¤¹ï¼Œå’ŒmainåŒçº§</p></li><li><p>åœ¨è¯¥æ¸ é“ç›®å½•ä¸‹æ–°å»ºå¯¹åº”çš„èµ„æºç›®å½•ï¼Œåœ¨æ‰“åŒ…æ—¶è‡ªåŠ¨æ›¿æ¢å¯¹åº”èµ„æº</p><p>â€‹</p><p>ç›®å½•æ ‘å¦‚ä¸‹</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line"></span><br><span class="line">--baidu</span><br><span class="line"></span><br><span class="line">----res/drawable</span><br><span class="line"></span><br><span class="line">--beta</span><br><span class="line"></span><br><span class="line">--main</span><br><span class="line"></span><br><span class="line">----res/drawable</span><br></pre></td></tr></table></figure><h1 id="4-More"><a href="#4-More" class="headerlink" title="4.More"></a>4.More</h1><p>æ­¤å¤–è¿˜æœ‰ç¾å›¢çš„å¤šæ¸ é“æ‰“åŒ…æŠ€æœ¯ç­‰</p><p>å…·ä½“å¯å‚è€ƒæ–‡ç« ï¼š<a href="https://tech.meituan.com/mt-apk-packaging.html" target="_blank" rel="noopener">ç¾å›¢Androidè‡ªåŠ¨åŒ–ä¹‹æ—…â€”ç”Ÿæˆæ¸ é“åŒ…</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EventBus3ç®€ä»‹</title>
      <link href="/blog/posts/c1d65822/"/>
      <url>/blog/posts/c1d65822/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote><p>EventBus is a publish/subscribe event bus for Android and Java.</p><p>è‹¥æ— ç‰¹æ®Šè¯´æ˜ï¼Œè‹±æ–‡æ³¨é‡Šå¼•è‡ªå®˜æ–¹æºç æˆ–æ–‡æ¡£ï¼ŒååŒ</p></blockquote><p>EventBusåœ¨androidä¸­å¯ä»¥ç”¨äºç»„ä»¶é—´ï¼Œç»„ä»¶å’Œåå°çº¿ç¨‹é—´çš„é€šä¿¡ï¼Œä»–åŸºäºè®¢é˜…ã€å‘å¸ƒçš„æœºåˆ¶ï¼Œå°†äº‹ä»¶çš„æ”¶/å‘è§£è€¦ï¼Œå¼€é”€å°ã€‚</p><p>å…¶æµç¨‹å¦‚ä¸‹ï¼ˆç¤ºæ„å›¾æ¥è‡ªå®˜æ–¹githubåº“ï¼‰ï¼š</p><p><img src="https://github.com/greenrobot/EventBus/raw/master/EventBus-Publish-Subscribe.png" alt="EventBus-Publish-Subscribe"></p><h1 id="è¦ç‚¹"><a href="#è¦ç‚¹" class="headerlink" title="è¦ç‚¹"></a>è¦ç‚¹</h1><h2 id="EventBusçš„ä¸‰ä¸ªè¦ç´ "><a href="#EventBusçš„ä¸‰ä¸ªè¦ç´ " class="headerlink" title="EventBusçš„ä¸‰ä¸ªè¦ç´ "></a>EventBusçš„ä¸‰ä¸ªè¦ç´ </h2><ul><li><p>Event</p><p>äº‹ä»¶ï¼Œè¦ä¼ é€’çš„äº‹ä»¶ï¼ˆä¸€ä¸ªç±»ï¼‰ï¼ŒEventBusä¼ é€’è¯¥äº‹ä»¶çš„å¯¹è±¡ï¼Œè¦ä¼ é€’çš„ä¿¡æ¯åŒ…å«åœ¨è¯¥å¯¹è±¡çš„å±æ€§ä¸­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span></span>&#123; &#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>Subscriber</p><p>è®¢é˜…è€…ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶è¦å¯¹äº‹ä»¶æ‰§è¡Œçš„æ“ä½œã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.MAIN)</span>  <span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">()</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>Publisher</p><p>å‘å¸ƒè€…ï¼Œåœ¨åˆé€‚çš„æ—¶å€™å‘å¸ƒäº‹ä»¶</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().post(Event())</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜éœ€è¦æ³¨å†Œã€æ³¨é”€EventBusä»¥ä¾¿è®¢é˜…è€…èƒ½å¤Ÿæ­£å¸¸æ¥æ”¶æ¶ˆæ¯</p></li></ul><h2 id="Subscriberçš„5ä¸ªçº¿ç¨‹æ¨¡å¼ï¼ˆThreadModeï¼‰"><a href="#Subscriberçš„5ä¸ªçº¿ç¨‹æ¨¡å¼ï¼ˆThreadModeï¼‰" class="headerlink" title="Subscriberçš„5ä¸ªçº¿ç¨‹æ¨¡å¼ï¼ˆThreadModeï¼‰"></a>Subscriberçš„5ä¸ªçº¿ç¨‹æ¨¡å¼ï¼ˆThreadModeï¼‰</h2><ul><li><p>POSTING</p><p>é»˜è®¤çš„ï¼Œè®¢é˜…è€…å’Œå‘å¸ƒè€…åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆSubscriber will be called directly in the same thread, which is posting the eventï¼‰ã€‚å› ä¸ºæœ‰å¯èƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸è¦è€—æ—¶æ“ä½œï¼Œä»¥å…ANRã€‚</p></li><li><p>MAIN</p><p>Androidä¸­ï¼Œè®¢é˜…è€…ä¼šåœ¨UIçº¿ç¨‹è¢«å”¤èµ·ï¼ŒåŒæ ·ä¸èƒ½è€—æ—¶æ“ä½œ</p><blockquote><p>If the posting thread is the main thread, subscriber methods will be called directly, blocking the posting thread. Otherwise the event is queued for delivery (non-blocking). </p></blockquote></li><li><p>MAIN_ORDERED</p><p>Androidï¼Œè®¢é˜…è€…ä¼šåœ¨UIçº¿ç¨‹è¢«å”¤èµ·ï¼Œä¸èƒ½è€—æ—¶æ“ä½œã€‚</p><blockquote><p>Different from MAIN, the event will always be queued for delivery. This ensures that the post call is non-blocking.</p></blockquote></li><li><p>BACKGROUND</p><p>Androidä¸­ï¼Œå¦‚æœpoståœ¨ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆè®¢é˜…è€…åœ¨æ–°å¼€çš„åå°çº¿ç¨‹ï¼Œå¦åˆ™åœ¨postçš„çº¿ç¨‹è¢«å”¤èµ·ã€‚</p><p>åœ¨å¦‚æœä¸æ˜¯åœ¨Androidä¸­ï¼Œåˆ™éƒ½åœ¨åå°çº¿ç¨‹å”¤èµ·ã€‚</p></li><li><p>ASYNC</p><p>è®¢é˜…è€…åœ¨æ–°çš„å­çº¿ç¨‹ä¸­è¿è¡Œï¼Œç‹¬ç«‹äºUIçº¿ç¨‹å’Œpostçº¿ç¨‹</p></li></ul><h1 id="ä½¿ç”¨ä¸¾ä¾‹"><a href="#ä½¿ç”¨ä¸¾ä¾‹" class="headerlink" title="ä½¿ç”¨ä¸¾ä¾‹"></a>ä½¿ç”¨ä¸¾ä¾‹</h1><h2 id="æ™®é€šäº‹ä»¶"><a href="#æ™®é€šäº‹ä»¶" class="headerlink" title="æ™®é€šäº‹ä»¶"></a>æ™®é€šäº‹ä»¶</h2><ol><li><p>å®šä¹‰äº‹ä»¶</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span></span>(s: String)&#123;</span><br><span class="line">    <span class="keyword">var</span> string : String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        string = s</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ³¨å†Œ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().register(context)</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®è®¢é˜…è€…</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.MAIN)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">(event: <span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">      Log.d(<span class="string">"tag"</span>,event.string)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å‘å¸ƒ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().post(Event(<span class="string">"hello"</span>))</span><br></pre></td></tr></table></figure></li><li><p>æ³¨é”€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().unregister(context)</span><br></pre></td></tr></table></figure></li></ol><h2 id="ç²˜æ€§äº‹ä»¶"><a href="#ç²˜æ€§äº‹ä»¶" class="headerlink" title="ç²˜æ€§äº‹ä»¶"></a>ç²˜æ€§äº‹ä»¶</h2><p>ç²˜æ€§äº‹ä»¶å³äº‹ä»¶å‘ç”Ÿï¼ˆ<code>postSticky()</code>ï¼‰ä¹‹åï¼Œå†è®¢é˜…ï¼Œä¹Ÿå¯å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†</p><p>å‘å¸ƒï¼ˆ<code>postSticky()</code>ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().postSticky(Event(<span class="string">"ç²˜æ€§äº‹ä»¶"</span>))</span><br></pre></td></tr></table></figure><p>è®¢é˜…è€…ï¼ˆ<code>sticky = true</code>ï¼‰ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.MAIN,sticky = true)</span><span class="comment">//stickyé»˜è®¤ä¸ºfalseï¼Œå¯ä»¥ä¸å†™</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">(event: <span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">    Log.d(<span class="string">"tag"</span>,event.string)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¿®æ”¹<code>å‘å¸ƒ</code>å’Œ<code>è®¢é˜…è€…</code> ä¹‹åï¼Œå½“<code>postSticky()</code>ä¹‹åï¼Œåªæœ‰ä¸‹æ¬¡<code>æ³¨å†Œäº‹ä»¶</code>æ—¶ï¼Œ<code>è®¢é˜…è€…</code>æ‰ä¼šå¯¹äº‹ä»¶è¿›è¡Œååº”ã€‚</p><p>å¦‚ä¸‹ä»£ç å°±åªä¼šåœ¨ç‚¹å‡»äº‹ä»¶ä¹‹åï¼Œ<code>è®¢é˜…è€…</code>æ‰ä¼šå¯¹<code>postSticky()</code>äº‹ä»¶åšååº”</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(view: <span class="type">View</span>)</span></span>&#123;</span><br><span class="line">    EventBus.getDefault().register(context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://github.com/greenrobot/EventBus" target="_blank" rel="noopener">greenrobot/EventBus: Event bus for Android and Java that simplifies communication between Activities, Fragments, Threads, Services, etc. Less code, better quality.</a></p><p><a href="http://blog.csdn.net/itachi85/article/details/52205464" target="_blank" rel="noopener">Androidäº‹ä»¶æ€»çº¿ï¼ˆä¸€ï¼‰EventBus3.0ç”¨æ³•å…¨è§£æ - CSDNåšå®¢</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMç±»åŠ è½½æœºåˆ¶è§£æ</title>
      <link href="/blog/posts/cf83ef31/"/>
      <url>/blog/posts/cf83ef31/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h1><p>æœ¬æ–‡ä»‹ç»äº†javaè™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ã€‚</p><h1 id="ç±»åŠ è½½æœºåˆ¶"><a href="#ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½æœºåˆ¶"></a>ç±»åŠ è½½æœºåˆ¶</h1><p>JVMç±»åŠ è½½ä¸€å…±7æ­¥ï¼Œå‰äº”æ­¥æ˜¯ç±»åŠ è½½æœºåˆ¶ï¼Œå„ä¸ªæ­¥éª¤æŒ‰ç…§é¡ºåºè¿›è¡Œï¼Œä½†æ˜¯å¹¶éå›ºå®šçš„1,2,3æ­¥ï¼Œåœ¨å®é™…ä¸­æœ‰å¯èƒ½ä»å…¶ä¸­é—´æŸä¸€æ­¥å¼€å§‹ã€‚</p><p>ç±»åŠ è½½æœºåˆ¶ä¸€èˆ¬åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š<strong>åŠ è½½Loading -&gt; è¿æ¥Linking -&gt; åˆå§‹åŒ–Initializing</strong></p><p><img src="https://github.com/jixiaoyong/Notes-Files/blob/master/draw-io/png/JVMClassLoader.png?raw=true" alt="JVM Class Loader"></p><p>å…¶ä¸­<strong>åŠ è½½ã€éªŒè¯ã€å‡†å¤‡å’Œåˆå§‹åŒ–</strong>å‘ç”Ÿçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œä½†<strong>è§£æ</strong>å¯ä»¥åœ¨åˆå§‹åŒ–ä¹‹åå¼€å§‹ï¼ˆjavaåŠ¨æ€ç»‘å®šï¼‰</p><blockquote><p>javaç»‘å®šåˆ†ä¸ºé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šï¼š</p><ul><li><strong>é™æ€ç»‘å®š</strong>ï¼šå³å‰æœŸç»‘å®šã€‚åœ¨ç¨‹åºæ‰§è¡Œå‰æ–¹æ³•å·²ç»è¢«ç»‘å®šï¼Œæ­¤æ—¶ç”±ç¼–è¯‘å™¨æˆ–å…¶å®ƒè¿æ¥ç¨‹åºå®ç°ã€‚é’ˆå¯¹javaï¼Œç®€å•çš„å¯ä»¥ç†è§£ä¸ºç¨‹åºç¼–è¯‘æœŸçš„ç»‘å®šã€‚javaå½“ä¸­çš„æ–¹æ³•åªæœ‰finalï¼Œstaticï¼Œprivateå’Œæ„é€ æ–¹æ³•æ˜¯å‰æœŸç»‘å®šçš„ã€‚</li><li><strong>åŠ¨æ€ç»‘å®š</strong>ï¼šå³æ™šæœŸç»‘å®šï¼Œä¹Ÿå«è¿è¡Œæ—¶ç»‘å®šã€‚åœ¨è¿è¡Œæ—¶æ ¹æ®å…·ä½“å¯¹è±¡çš„ç±»å‹è¿›è¡Œç»‘å®šã€‚åœ¨javaä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯åæœŸç»‘å®šçš„ã€‚</li></ul><p><a href="http://blog.csdn.net/ns_code/article/details/17881581" target="_blank" rel="noopener">http://blog.csdn.net/ns_code/article/details/17881581</a></p></blockquote><h1 id="ç±»åŠ è½½æœºåˆ¶å…·ä½“è¿‡ç¨‹"><a href="#ç±»åŠ è½½æœºåˆ¶å…·ä½“è¿‡ç¨‹" class="headerlink" title="ç±»åŠ è½½æœºåˆ¶å…·ä½“è¿‡ç¨‹"></a>ç±»åŠ è½½æœºåˆ¶å…·ä½“è¿‡ç¨‹</h1><h2 id="I-Loading"><a href="#I-Loading" class="headerlink" title="I.Loading "></a><strong>I.Loading </strong></h2><p><strong>åŠ è½½</strong>ï¼ŒJVMå°†æ–‡ä»¶ï¼ˆclassï¼Œjarï¼Œzipï¼Œç½‘ç»œç­‰ï¼‰ä¸­çš„äºŒè¿›åˆ¶å­—èŠ‚æµä¿å­˜åˆ°è™šæ‹Ÿæœºæ–¹æ³•åŒºå’Œå †ä¸­,å¹¶ç”¨è¯¥äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼åˆ›å»ºç±»æˆ–è€…æ¥å£çš„è¿‡ç¨‹ã€‚</p><blockquote><p>Loading is the process of finding the binary representation of a class or interface type with a particular name and <em>creating</em> a class or interface from that binary representation</p><p><a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-5.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-5.html</a> (<em>è‹±æ–‡æ–‡æ¡£è‹¥æ— ç‰¹æ®Šè¯´æ˜éƒ½æ˜¯å¼•ç”¨å®˜æ–¹æ–‡æ¡£ï¼Œä¸‹åŒ</em>)</p></blockquote><ol><li><p>ç”¨<strong>ç±»å…¨é™å®šå</strong>è·å–ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</p></li><li><p>å°†å­—èŠ‚æµä¸­<strong>é™æ€å­˜å‚¨ç»“æ„</strong>è½¬åŒ–ä¸º<strong>æ–¹æ³•åŒº</strong>çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</p></li><li><p><u><em>åœ¨<strong>å †</strong>ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºæ•°æ®çš„è®¿é—®å…¥å£ã€‚</em></u></p><p>ï¼ˆ<del><strong>è¿™å¥è¯å­˜ç–‘</strong> ï¼Œæœ‰äººè¯´<a href="http://blog.csdn.net/ns_code/article/details/17881581" target="_blank" rel="noopener">åœ¨å †ä¸­</a> ,ä¹Ÿæœ‰äººè¯´åœ¨<a href="http://gityuan.com/2015/10/25/jvm-class-loading/" target="_blank" rel="noopener">æ–¹æ³•åŒº</a> ,å®˜æ–¹æ–‡æ¡£æœªç›¸å…³æè¿°</del> </p><p><code>2019/01/12 æ›´æ–°</code> Classå¯¹è±¡æ²¡æœ‰æ˜ç¡®è§„å®šå®åœ¨<strong>JAVAå †</strong>ä¸­ï¼Œå¯¹åº”HotSpotè™šæ‹Ÿæœºæ¥è¯´ï¼Œè¯¥å¯¹è±¡åœ¨<strong>æ–¹æ³•åŒº</strong>ä¸­ï¼‰</p></li></ol><p>ç±»åŠ è½½çš„åœ°æ–¹æ˜¯å¼€å‘äººå‘˜å¯æ§æ€§æœ€å¼ºçš„åœ°æ–¹ã€‚é™¤äº†å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„ClassLoaderå¤–è¿˜å¯ä»¥è‡ªå®šä¹‰ClassLoaderï¼ˆåæ–‡è¯¦è¿°ï¼‰ã€‚</p><p>ç±»åŠ è½½æ ¹æ®åŠ è½½çš„ç±»ä¸åŒåˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>éæ•°ç»„ç±» ä½¿ç”¨ç³»ç»Ÿ/è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å®ŒæˆåŠ è½½</li><li>æ•°ç»„ç±» æ•°ç»„ç±»ä¸é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡JVMç›´æ¥åˆ›å»ºï¼Œä½†æ˜¯æ•°ç»„ç±»çš„å…ƒç´ ç±»å‹è¦é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»º</li></ul><p>æ•°ç»„ç±»çš„å…ƒç´ åŠ è½½ï¼Œæ ¹æ®æ•°ç»„å…ƒç´ çš„ç±»å‹ä¸åŒï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>å¼•ç”¨ç±» é€šè¿‡æ™®é€šç±»åŠ è½½å™¨åŠ è½½ï¼Œå¹¶å°†æ•°ç»„ç”¨è¯¥ç±»åŠ è½½å™¨æ ‡è¯†</li><li>éå¼•ç”¨ç±» å°†æ•°ç»„ä¸å¼•å¯¼ç±»åŠ è½½å™¨æ ‡è¯†</li></ul><p>æ•°ç»„ç±»çš„å¯è§æ€§ä¸å…¶å…ƒç´ ç±»çš„å¯è§æ€§ä¸€è‡´ã€‚</p><hr><h2 id="II-Linking"><a href="#II-Linking" class="headerlink" title="II.Linking "></a><strong>II.Linking </strong></h2><p><strong>è¿æ¥</strong>ï¼Œæ˜¯å°†ç±»æˆ–è€…æ¥å£ç»„åˆåˆ°javaè™šæ‹Ÿæœºè¿è¡ŒçŠ¶æ€çš„è¿‡ç¨‹ï¼Œè¿™æ ·ä»–å°±å¯ä»¥è¢«è¿è¡Œã€‚</p><blockquote><p>Linking is the process of taking a class or interface and combining(ç»„åˆ) it into the run-time state of the Java Virtual Machine so that it can be executed(è¿è¡Œ)</p></blockquote><p>è¿æ¥ä¸€èˆ¬åˆ†ä¸º3éƒ¨åˆ†ï¼šéªŒè¯Verification ã€å‡†å¤‡Preparation ã€è§£æResolution ã€‚</p><blockquote><p>Linking a class or interface involves(åŒ…æ‹¬) verifying and preparing(éªŒè¯å’Œå‡†å¤‡) that class or interface, its direct(ç›´æ¥) superclass, its direct superinterfaces, and its element type (if it is an array type), if necessary. Resolution of symbolic references in the class or interface is an optional part of linking.</p></blockquote><h3 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a><strong>Verification</strong></h3><p><strong>éªŒè¯</strong>ï¼Œä¿è¯classæ–‡ä»¶ä¸­çš„å­—èŠ‚æµä¿¡æ¯ç¬¦åˆè™šæ‹Ÿæœºçš„è¦æ±‚ã€‚</p><blockquote><p>Verification(<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-4.html#jvms-4.10" target="_blank" rel="noopener">Â§4.10</a>) ensures that the binary representation(äºŒè¿›åˆ¶æ ¼å¼) of a class or interface is structurally correct(ç»“æ„æ­£ç¡®) (<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-4.html#jvms-4.9" target="_blank" rel="noopener">Â§4.9</a>). Verification may cause additional classes and interfaces to be loaded (<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-5.html#jvms-5.3" target="_blank" rel="noopener">Â§5.3</a>) but need not cause them to be verified or prepared.</p></blockquote><p>éªŒè¯å†…å®¹åŒ…æ‹¬ï¼š</p><ol><li>æ–‡ä»¶æ ¼å¼éªŒè¯ï¼ŒéªŒè¯å­—èŠ‚æµç¬¦åˆclassæ–‡ä»¶æ ¼å¼è§„èŒƒï¼›</li><li>å…ƒæ•°æ®éªŒè¯</li><li>å­—èŠ‚ç éªŒè¯</li><li>ç¬¦å·å¼•ç”¨éªŒè¯</li></ol><h3 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation "></a><strong>Preparation </strong></h3><p><strong>å‡†å¤‡</strong>ï¼Œåœ¨æ–¹æ³•åŒºå¯¹ç±»å˜é‡åˆ†é…å†…å­˜ï¼Œ<strong>åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼</strong>ï¼ˆâ€œé›¶å€¼â€ï¼‰ã€‚</p><p>æ¯”å¦‚ï¼š<code>static int i = 5ï¼›</code>åœ¨è¿™ä¸€æ­¥åªä¼šè¿›è¡Œåˆ°<code>i = 0</code> ï¼Œè€Œ<code>i = 5</code>è¦åœ¨åˆå§‹åŒ–é‚£ä¸€æ­¥æ‰è¿›è¡Œï¼›</p><p>ä½†æ˜¯å¦‚æœæ˜¯finalä¿®é¥°çš„<strong>å¸¸é‡</strong>ï¼Œåˆ™åœ¨æ­¤åˆ†é…å…·ä½“å€¼ã€‚</p><blockquote><p><em>Preparation</em> involves creating the static fields for a class or interface and initializing such fields to their default values (<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-2.html#jvms-2.3" target="_blank" rel="noopener">Â§2.3</a>, <a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-2.html#jvms-2.4" target="_blank" rel="noopener">Â§2.4</a>). This does not require the execution of any Java Virtual Machine code; explicit initializers for static fields are executed as part of initialization (<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-5.html#jvms-5.5" target="_blank" rel="noopener">Â§5.5</a>), not preparation.</p></blockquote><p>å‡†å¤‡å·¥ä½œå¯èƒ½åœ¨åˆ›å»ºä¹‹åçš„ä»»ä½•æ—¶å€™å‘ç”Ÿï¼Œä½†æ˜¯å¿…é¡»åœ¨åˆå§‹åŒ–ä¹‹å‰å®Œæˆã€‚</p><h3 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a><strong>Resolution</strong></h3><p><strong>è§£æ</strong>ï¼Œæ˜¯åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­åŠ¨æ€ç¡®å®šç¬¦å·å¼•ç”¨çš„å…·ä½“å€¼çš„è¿‡ç¨‹ã€‚</p><p>æ¯ä¸ªæ ˆå¸§frameéƒ½æœ‰ä¸€ä¸ª<code>å½“å‰æ–¹æ³•</code>åˆ°<code>è¿è¡Œæ—¶å¸¸é‡æ± </code> çš„å¼•ç”¨ï¼Œç”¨æ¥æ”¯æŒæ–¹æ³•ä»£ç (method code)çš„<strong>åŠ¨æ€é“¾æ¥ï¼ˆdynamic linkingï¼‰</strong>ã€‚</p><p>method codeï¼šè¦è¢«æ‰§è¡Œçš„æ–¹æ³•ä»¥åŠé€šè¿‡ç¬¦å·å¼•ç”¨çš„å˜é‡ã€‚</p><blockquote><p>Each frame (<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-2.html#jvms-2.6" target="_blank" rel="noopener">Â§2.6</a>) contains a reference to the run-time constant pool (<a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-2.html#jvms-2.5.5" target="_blank" rel="noopener">Â§2.5.5</a>) for the type of the current method to support <em>dynamic linking</em> of the method code.</p></blockquote><p>åŠ¨æ€é“¾æ¥å°†ç¬¦å·å¼•ç”¨ï¼ˆsymbolic referencesï¼‰è½¬åŒ–ä¸ºå…·ä½“æ–¹æ³•çš„è°ƒç”¨ï¼ˆconcrete method referencesï¼‰å³ç›´æ¥å¼•ç”¨ï¼Œæ ¹æ®éœ€è¦åŠ è½½ç±»æ¥è§£ææœªå®šä¹‰çš„ç¬¦å·ï¼Œå°†å˜é‡è®¿é—®è½¬åŒ–ä¸ºè¿è¡Œæ—¶å†…å­˜ï¼ˆruntime locationï¼‰ã€‚</p><blockquote><p>This late binding of the methods and variables makes changes in other classes that a method uses less likely to break this code.</p><p><em>æ–¹æ³•å’Œå˜é‡çš„è¿™ç§åæœŸç»‘å®š,ä½¿å¾—æ–¹æ³•ä½¿ç”¨çš„å…¶ä»–ç±»çš„æ›´æ”¹ä¸å¤ªå¯èƒ½ç ´åè¿™ä¸ªä»£ç ã€‚</em></p><p>ç›´æ¥å¼•ç”¨å¯ä»¥ç›´æ¥å®šä½åˆ°å†…å­˜ä¸­æŸä¸€æ®µåœ°å€ï¼›ç¬¦å·å¼•ç”¨åˆ™ä¸JVMå†…å­˜æ— ç®¡</p></blockquote><p>è§£æåˆ†ä¸ºï¼š</p><ol><li>ç±»ï¼Œæ¥å£è§£æ</li><li>å­—æ®µè§£æ</li><li>ç±»æ–¹æ³•è§£æ</li><li>æ¥å£æ–¹æ³•è§£æ</li></ol><hr><h2 id="III-Initialization"><a href="#III-Initialization" class="headerlink" title="III.Initialization"></a><strong>III.Initialization</strong></h2><p><strong>åˆå§‹åŒ–</strong> ï¼Œ<em>Initialization</em> of a class or interface consists of executing its class or interface initialization methodï¼ˆæ‰§è¡Œç±»ï¼Œæ¥å£çš„æ„é€ æ–¹æ³•<code>clinit()</code>ï¼‰</p><p>ç±»æˆ–æ¥å£åœ¨è¢«åˆå§‹åŒ–ä¹‹å‰ï¼Œå¿…é¡»å…ˆè¢«è¿æ¥linkedï¼ˆ verified, prepared, and optionallyï¼ˆå¯é€‰ï¼‰ resolved.ï¼‰ã€‚</p><p>åˆå§‹åŒ–æœ‰ä¸”åªæœ‰ä»¥ä¸‹äº”ç§æƒ…å†µï¼š</p><ul><li><code>new</code>ã€è¯»å–/è®¾ç½®ç±»ï¼ˆåªæœ‰ç›´æ¥å®šä¹‰å…¶çš„ç±»æ‰ä¼šï¼Œå­ç±»ç­‰ä¸å—å½±å“ï¼‰çš„é™æ€å˜é‡ï¼ˆfinalä¿®é¥°çš„å¸¸é‡é™¤å¤–ï¼‰ã€æ‰§è¡Œé™æ€æ–¹æ³•</li><li><code>java.lang.reflect</code>åå°„è°ƒç”¨ç±»</li><li>åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœçˆ¶ç±»æœªåˆå§‹åŒ–ï¼Œå…ˆè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ï¼ˆæ¥å£ç±»é™¤å¤–ï¼‰</li><li>è™šæ‹Ÿæœºç­‰å¯åŠ¨æ—¶æ‰§è¡Œä¸»ç±»çš„<code>main()</code>æ–¹æ³•æ—¶ï¼Œéœ€è¦å…ˆåˆå§‹åŒ–ä¸»ç±»</li><li>JDK1.7 åŠ¨æ€æ”¯æŒæ—¶ï¼Œå¦‚æœ<code>java.lang.invoke.MethodHandle</code>å®ä¾‹æœ€åè§£æç»“æœ<code>REF_get/put/invokeStaticçš„æ–¹æ³•å¥æŸ„å¯¹åº”çš„ç±»æœªè¢«åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦å…ˆåˆå§‹åŒ–å¯¹åº”çš„ç±»</code></li></ul><p>ä»¥ä¸Š5ç§ç§°ä¸ºå¯¹ä¸€ä¸ªç±»çš„<strong>ä¸»åŠ¨å¼•ç”¨</strong>ï¼Œå…¶ä½™ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œç§°ä¸º<strong>è¢«åŠ¨å¼•ç”¨</strong></p><p><code>clinit()</code> ,æœ‰<strong>ç±»å˜é‡èµ‹å€¼ï¼Œé™æ€è¯­å¥å—</strong>ä¼šç”±ç¼–è¯‘å™¨åˆå¹¶ä¸º<code>clinit()</code>æ–¹æ³•,åˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>ç±» çˆ¶ç±»çš„<code>clinit()</code>æ–¹æ³•ä¼šå…ˆäºå­ç±»æ‰§è¡Œ</li><li>æ¥å£  æ¥å£<code>clinit()</code>æ–¹æ³•æ— éœ€è°ƒç”¨çˆ¶ç±»æ¥å£çš„<code>clinit()</code>æ–¹æ³•ï¼›æ¥å£çš„å®ç°ç±»ä¹Ÿæ— éœ€æ‰§è¡Œæ¥å£çš„<code>clinit()</code>æ–¹æ³•</li></ol><p><code>clinit()</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹çš„ä¸­åªä¼šæœ‰<strong>ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€æ¬¡<code>clinit()</code></strong>ï¼Œå…¶ä½™çº¿ç¨‹é˜»å¡ç­‰å¾…</p><p><code>clinit()</code>å’Œ<code>init()</code>ä¸åŒå¦‚ä¸‹ï¼š</p><blockquote><p><strong>init</strong>æ˜¯å¯¹è±¡æ„é€ å™¨æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¨‹åºæ‰§è¡Œ new ä¸€ä¸ªå¯¹è±¡è°ƒç”¨è¯¥å¯¹è±¡ç±»çš„ constructor æ–¹æ³•æ—¶æ‰ä¼šæ‰§è¡Œinitæ–¹æ³•<u>ï¼ˆæ˜¯åœ¨<strong>newå¯¹è±¡</strong>çš„æ—¶å€™<strong>åˆå§‹åŒ–éé™æ€å˜é‡</strong>ï¼‰</u>ï¼›</p><p>è€Œclinitæ˜¯ç±»æ„é€ å™¨æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨jvmè¿›è¡Œç±»<strong>åŠ è½½â€”â€“éªŒè¯â€”-è§£æâ€”â€“åˆå§‹åŒ–</strong>ï¼Œä¸­çš„åˆå§‹åŒ–é˜¶æ®µjvmä¼šè°ƒç”¨clinitæ–¹æ³•<u>ï¼ˆæ˜¯åœ¨<strong>JVMåˆå§‹åŒ–ç±»</strong>çš„æ—¶å€™<strong>åˆå§‹åŒ–é™æ€å˜é‡</strong>ï¼‰</u>ã€‚</p><p><a href="http://blog.csdn.net/u013309870/article/details/72975536" target="_blank" rel="noopener">http://blog.csdn.net/u013309870/article/details/72975536</a></p></blockquote><p>å¦‚æœç±»æ²¡æœ‰é™æ€èµ‹å€¼ã€é™æ€è¯­å¥å—ç­‰åˆ™ä¸ä¼šæœ‰<code>clinit()</code>æ–¹æ³•ã€‚</p><p><code>clinit()</code>å…ˆäº<code>init()</code>æ‰§è¡Œã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-5.html" target="_blank" rel="noopener">Java Virtual Machine Specification Chapter 5. Loading, Linking, and Initializing</a></p><p><a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-2.html#jvms-2.5.2" target="_blank" rel="noopener">Chapter 2. The Structure of the Java Virtual Machine</a></p><p><a href="http://blog.csdn.net/ns_code/article/details/17881581" target="_blank" rel="noopener">ã€æ·±å…¥Javaè™šæ‹Ÿæœºã€‘ä¹‹å››ï¼šç±»åŠ è½½æœºåˆ¶</a></p><p><a href="http://blog.csdn.net/zhangliangzi/article/details/51319033" target="_blank" rel="noopener">JVMç±»åŠ è½½æœºåˆ¶è¯¦è§£ï¼ˆä¸€ï¼‰JVMç±»åŠ è½½è¿‡ç¨‹</a></p><p><a href="http://gityuan.com/2015/10/25/jvm-class-loading/" target="_blank" rel="noopener">Jvmç³»åˆ—3â€”ç±»çš„åŠ è½½ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢  </a></p><p><a href="http://wiki.jikexueyuan.com/project/java-vm/class-loading-mechanism.html" target="_blank" rel="noopener">ç±»åŠ è½½æœºåˆ¶ - æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœº - æå®¢å­¦é™¢Wiki </a></p><p><a href="http://blog.csdn.net/javazejian/article/details/70768369" target="_blank" rel="noopener">æ·±å…¥ç†è§£Javaç±»å‹ä¿¡æ¯(Classå¯¹è±¡)ä¸åå°„æœºåˆ¶ - CSDNåšå®¢</a></p><p><a href="http://blog.csdn.net/u013309870/article/details/72975536" target="_blank" rel="noopener">æ·±å…¥ç†è§£jvmâ€“Javaä¸­initå’ŒclinitåŒºåˆ«å®Œå…¨è§£æ - CSDNåšå®¢</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMå†…å­˜åˆ†é…</title>
      <link href="/blog/posts/f31c11c5/"/>
      <url>/blog/posts/f31c11c5/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬ç¬”è®°åŸºäºã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹åŠéƒ¨åˆ†åœ¨çº¿åšå®¢æ•´ç†ã€‚</p></blockquote><p>JVMï¼šjava virtual machineï¼Œä¸€ä¸ªjavaç¨‹åºï¼ˆè¿›ç¨‹ï¼‰æ‹¥æœ‰ä¸€ä¸ªjvmå®ä¾‹</p><h1 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h1><p>JVMåŒºåŸŸæ€»ä½“åˆ†ä¸¤ç±»ï¼ŒheapåŒºå’ŒéheapåŒº:</p><p><strong>heapåŒº</strong>ï¼šEden Spaceï¼ˆä¼Šç”¸å›­ï¼‰ã€Survivor Space(å¹¸å­˜è€…åŒº)ã€Tenured Genï¼ˆè€å¹´ä»£-å…»è€åŒºï¼‰ã€‚<br><strong>éheapåŒº</strong>ï¼šCode Cache(ä»£ç ç¼“å­˜åŒº)ã€Perm Genï¼ˆæ°¸ä¹…ä»£ï¼‰ã€Jvm Stack(Javaè™šæ‹Ÿæœºæ ˆ)ã€Local Method Statck(æœ¬åœ°æ–¹ æ³•æ ˆ)ã€‚</p><h1 id="å†…å­˜åˆ’åˆ†"><a href="#å†…å­˜åˆ’åˆ†" class="headerlink" title="å†…å­˜åˆ’åˆ†"></a>å†…å­˜åˆ’åˆ†</h1><h2 id="1-head"><a href="#1-head" class="headerlink" title="1.head"></a>1.head</h2><p>å †ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜æ”¾æ‰€æœ‰å¯¹è±¡å®ä¾‹ã€æ•°ç»„ï¼ŒGCä¸»è¦åœºæ‰€ï¼Œä¼šOOM</p><p>åˆ†ç±»</p><p><strong>1.æ–°ç”Ÿä»£</strong></p><ul><li>eden  åˆšåˆšåˆ›å»ºçš„å¯¹è±¡ä¼˜å…ˆ</li></ul><ul><li>s1  ç»å†å‡ æ¬¡GC</li></ul><ul><li>s2  ç»å†å‡ æ¬¡GC</li></ul><p><strong>2.è€å¹´ä»£</strong></p><ul><li>å­˜æ´»æ—¶é—´é•¿çš„è€å¹´å¯¹è±¡</li></ul><ul><li>å¤§å¯¹è±¡ï¼Œå¦‚æ•°ç»„ï¼Œå¤§Stringâ€¦</li></ul><h2 id="2-stack"><a href="#2-stack" class="headerlink" title="2.stack"></a>2.stack</h2><p>æ ˆï¼Œçº¿ç¨‹ç§æœ‰ï¼Œå­˜æ”¾åŸºæœ¬æ•°æ®å’Œå¯¹è±¡çš„å¼•ç”¨ï¼ŒLIFOï¼Œä¼šOOMï¼ŒStackOverflow</p><h3 id="java-virtual-machine-stack"><a href="#java-virtual-machine-stack" class="headerlink" title="java virtual machine stack"></a>java virtual machine stack</h3><p>çº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºJVMå…è®¸çš„æ·±åº¦ä¼šå¯¼è‡´Stack Overflow<br>åœ¨ç¼–è¯‘æœŸå®Œæˆå†…å­˜åˆ†é…ï¼Œå¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œä½†æ˜¯å½“æ‹“å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿå†…å­˜æ—¶ä¼šå¯¼è‡´OutOfMemory</p><p><strong>stack  frame</strong></p><p>stack frameï¼šæ ˆå¸§ï¼Œæ¯æ‰§è¡Œä¸€ä¸ªæ–¹æ³•å°±ä¼šäº§ç”Ÿä¸€ä¸ªæ ˆå¸§å¹¶å‹å…¥æ ˆä¸­</p><ul><li><p>å±€éƒ¨å˜é‡è¡¨</p><ul><li>åŸºæœ¬æ•°æ®ç±»å‹</li><li>å¯¹è±¡å¼•ç”¨</li><li>returnAddress ç±»å‹,æŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„ä½ç½®</li></ul></li><li><p>æ“ä½œæ•°æ ˆ</p></li><li>åŠ¨æ€é“¾æ¥</li><li>æ–¹æ³•å‡ºå£ç­‰</li></ul><h3 id="native-method-stack"><a href="#native-method-stack" class="headerlink" title="native method stack"></a>native method stack</h3><p>ä¸javaè™šæ‹Ÿæœºæ ˆä½œç”¨ç±»ä¼¼ï¼Œä¸è¿‡native method stackæ˜¯ä¸ºnativeæ–¹æ³•æœåŠ¡ã€‚<br>jvmå¯ä»¥è‡ªç”±å®ç°å®ƒï¼Œç”šè‡³åœ¨sun HotSpot VMä¸­å°†ä»–ä¸è™šæ‹Ÿæœºæ ˆåˆå¹¶<br>ä¼šOOMï¼ŒstackOverflow</p><h2 id="3-method-area"><a href="#3-method-area" class="headerlink" title="3.method area"></a>3.method area</h2><p>æ–¹æ³•åŒºï¼Œçº¿ç¨‹å…±äº«ï¼Œå­˜æ”¾ç±»ä¿¡æ¯ï¼Œå¸¸é‡ï¼Œé™æ€å˜é‡ï¼Œå³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ï¼Œä¼šOOM</p><p><strong>è¿è¡Œæ—¶å¸¸é‡æ± </strong></p><p>ç±»åŠ è½½åï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ä¼šæ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œä¼šOOM<br><code>String.intern()</code>ï¼Œæœ‰è¯¥stringå¯¹è±¡åˆ™è¿”å›ï¼Œæ— åˆ™åˆ›å»ºå¹¶è¿”å›</p><blockquote><p><code>String.intern()</code>æ–¹æ³•çš„æ³¨æ„äº‹é¡¹ï¼š</p><p>JDK1.6åŠä»¥ä¸‹ï¼šå°†é¦–æ¬¡å‡ºç°çš„å¯¹è±¡å®ä¾‹<strong>å¤åˆ¶</strong>åˆ°æ°¸ä¹…ä»£ï¼Œè¿”å›å…¶å¼•ç”¨</p><p>JDK1.7åŠä»¥ä¸Šï¼šåªä¼š<strong>è®°å½•</strong>ä¸‹é¦–æ¬¡å‡ºç°çš„å®ä¾‹çš„å¼•ç”¨ï¼Œè¿”å›å…¶å¼•ç”¨</p><p>æ‰€ä»¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; String s2 = <span class="string">"java"</span>;</span><br><span class="line">&gt; System.out.println(s2.intern() == s2);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>åœ¨JDK1.6åŠä»¥ä¸‹è¾“å‡º<code>false</code>ï¼Œåœ¨JDK1.7åŠä»¥ä¸Šè¾“å‡º<code>true</code></p><p>æ­¤å¤–ï¼Œç”±äº<code>String</code>ç±»æ˜¯<code>final</code>çš„ï¼Œæ¯æ¬¡<code>new String(&quot;str&quot;)</code>ä¼šäº§ç”Ÿä¸¤ä¸ªå¯¹è±¡ï¼šä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²<code>str</code>æœ¬èº«ï¼Œä¸€ä¸ªæ˜¯å€¼ä¸º<code>str</code>çš„å­—ç¬¦ä¸²ã€‚</p></blockquote><p>ä»¥<code>String s = &quot;Hello&quot;;</code>ä¸ºä¾‹ï¼Œè§£é‡Šå‡ ä¸ªæ¦‚å¿µï¼š</p><p><strong>å­—é¢é‡</strong> æºç ä¸­è¡¨ç¤ºå…·ä½“çš„å€¼ï¼Œå¦‚<code>Hello</code></p><p><strong>ç¬¦å·å¼•ç”¨</strong> ç”¨æ¥æŒ‡ä»£æŸç§å€¼å¾—ç¬¦å·ï¼Œå¦‚<code>s</code></p><p><strong>ç›´æ¥å¼•ç”¨</strong> å¯ä»¥å®šä½åˆ°å†…å­˜ä¸­çš„ï¼ˆç±»ã€å¯¹è±¡ã€æ–¹æ³•ã€å˜é‡ï¼‰ç­‰çš„å…·ä½“åœ°å€</p><h2 id="4-program-count"><a href="#4-program-count" class="headerlink" title="4.program count"></a>4.program count</h2><p><strong>ç¨‹åºè®¡æ•°å™¨</strong>ï¼Œçº¿ç¨‹ç§æœ‰ï¼Œå ç”¨å†…å­˜å°ï¼Œå½“åšå½“å‰çº¿ç¨‹æ‰§è¡Œå­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚</p><p>è‹¥æ‰§è¡Œjavaæ–¹æ³•ï¼Œè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„ä½ç½®</p><p>è‹¥æ‰§è¡Œçš„æ˜¯nativeæ–¹æ³•ï¼Œåˆ™è®¡æ•°å™¨ä¸ºç©ºundefinedã€‚</p><p>æ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨javaè™šæ‹Ÿæœºè§„èŒƒå­—æ²¡æœ‰è§„å®šä»»ä½•OOMErrorçš„åŒºåŸŸ</p><h1 id="å†…å­˜æº¢å‡º"><a href="#å†…å­˜æº¢å‡º" class="headerlink" title="å†…å­˜æº¢å‡º"></a>å†…å­˜æº¢å‡º</h1><blockquote><p>ä»¥Sun HotSpot VM ä¸ºä¾‹</p></blockquote><h2 id="1-javaå †æº¢å‡º"><a href="#1-javaå †æº¢å‡º" class="headerlink" title="1.javaå †æº¢å‡º"></a>1.javaå †æº¢å‡º</h2><p>å¯¹è±¡è¿‡å¤šå¯¼è‡´headå†…å­˜æº¢å‡º</p><ol><li>æ˜¯å†…å­˜æ³„æ¼memory leakï¼Œå®šä½æ³„éœ²å¯¹è±¡</li><li>æ˜¯å†…å­˜æº¢å‡ºmemory overflowï¼Œæ£€æŸ¥è™šæ‹Ÿæœºå †å‚æ•°æ˜¯å¦å¯ä»¥è°ƒå¤§ï¼›å»é™¤éå¿…é¡»çš„ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡</li></ol><h2 id="2-è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º"><a href="#2-è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º" class="headerlink" title="2.è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º"></a>2.è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º</h2><ol><li><p>å•çº¿ç¨‹ï¼ŒStack Overflow</p><p>å•çº¿ç¨‹ä¸‹ï¼Œæ ˆå¸§è¿‡å¤§æˆ–è€…è™šæ‹Ÿæœºæ ˆå®¹é‡å¤ªå°ï¼Œå½“å†…å­˜æ— æ³•åˆ†é…æ—¶éƒ½ä¼šå¯¼è‡´Stack Overflowå¼‚å¸¸</p></li><li><p>å¤šçº¿ç¨‹ï¼Œ</p><p>å¤šçº¿ç¨‹æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹æ ˆåˆ†é…çš„å†…å­˜è¶Šå¤§ï¼Œè¶Šå®¹æ˜“å°è¯•å†…å­˜æº¢å‡ºOOM</p><p>åŸå› ï¼šè™šæ‹Ÿæœºæœ€å¤§å†…å­˜ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œå»æ‰å…±äº«çš„Headå’ŒMethodAreaå çš„å†…å­˜ï¼Œå‰©ä¸‹çš„å†…å­˜/å•ä¸ªçº¿ç¨‹æœ€å¤§æ ˆå†…å­˜=æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œå½“å•ä¸ªçº¿ç¨‹æœ€å¤§æ ˆå†…å­˜å¢åŠ æ—¶ï¼Œå¯ä»¥äº§ç”Ÿçš„çº¿ç¨‹æ•°å°±ä¼šè¶Šå°‘</p></li></ol><h2 id="3-è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º"><a href="#3-è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º" class="headerlink" title="3.è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º"></a>3.è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</h2><p>è¿è¡Œæ—¶å¸¸é‡æ± å±äºæ–¹æ³•åŒºï¼Œå½“å¸¸é‡è¿‡å¤šæ—¶ä¼šå¯¼è‡´OOMï¼Œå¯ä»¥ç”¨String.intern()æ–¹æ³•å°è¯•</p><h2 id="4-æ–¹æ³•åŒºæº¢å‡º"><a href="#4-æ–¹æ³•åŒºæº¢å‡º" class="headerlink" title="4.æ–¹æ³•åŒºæº¢å‡º"></a>4.æ–¹æ³•åŒºæº¢å‡º</h2><p>ç»å¸¸åŠ¨æ€ç”Ÿæˆå¤§é‡Classçš„åº”ç”¨ï¼Œå¦‚Springç­‰æ¡†æ¶ï¼Œéœ€è¦æ³¨æ„OOM</p><h2 id="5-æœ¬åœ°ç›´æ¥å†…å­˜æº¢å‡º"><a href="#5-æœ¬åœ°ç›´æ¥å†…å­˜æº¢å‡º" class="headerlink" title="5.æœ¬åœ°ç›´æ¥å†…å­˜æº¢å‡º"></a>5.æœ¬åœ°ç›´æ¥å†…å­˜æº¢å‡º</h2><p>åŸç”Ÿæ–¹æ³•ç›´æ¥æ“ä½œç‰©ç†å†…å­˜æ—¶å¯¼è‡´ç‰©ç†å†…å­˜ä¸å¤Ÿï¼Œäº§ç”ŸOOM</p><h1 id="GCåƒåœ¾å›æ”¶"><a href="#GCåƒåœ¾å›æ”¶" class="headerlink" title="GCåƒåœ¾å›æ”¶"></a>GCåƒåœ¾å›æ”¶</h1><p>JVMä¸­GCä¼šæ ¹æ®ä¸åŒæƒ…å†µé‡‡å–ä»¥ä¸‹ä¸€ç³»åˆ—ç®—æ³•ç»„åˆè¿›è¡Œå†…å­˜å›æ”¶</p><h2 id="å›æ”¶ç®—æ³•"><a href="#å›æ”¶ç®—æ³•" class="headerlink" title="å›æ”¶ç®—æ³•"></a>å›æ”¶ç®—æ³•</h2><h3 id="1-å¤åˆ¶ç®—æ³•"><a href="#1-å¤åˆ¶ç®—æ³•" class="headerlink" title="1.å¤åˆ¶ç®—æ³•"></a>1.å¤åˆ¶ç®—æ³•</h3><p><strong>åŸç†</strong>ï¼šå†…å­˜ä¸€åˆ†ä¸ºäºŒï¼Œåªä½¿ç”¨ä¸€åŠï¼›GCæ—¶å°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€åŠå†…å­˜ï¼Œå‰©ä¸‹çš„åˆ™æ¸…ç©º</p><p><strong>ä¼˜ç¼ºç‚¹</strong>ï¼š1.æ— STWï¼Œä½†ä¸é€‚åˆå¯¹è±¡è¿‡å¤šçš„æƒ…å†µï¼›2.å†…å­˜åˆ©ç”¨æ•ˆç‡ä½</p><h3 id="2-æ ‡è®°æ¸…é™¤æ³•"><a href="#2-æ ‡è®°æ¸…é™¤æ³•" class="headerlink" title="2.æ ‡è®°æ¸…é™¤æ³•"></a>2.æ ‡è®°æ¸…é™¤æ³•</h3><p><strong>åŸç†</strong>ï¼šä»GC Rootså¼€å§‹éå†ï¼Œå¯è¾¾æ ‡è®°å­˜æ´»ï¼Œä¸å¯è¾¾åˆ™æœªæ ‡è®°</p><p>javaä¸­ï¼ŒGC Rootså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIå¼•ç”¨çš„å¯¹è±¡</li></ul><p><strong>ä¼˜ç¼ºç‚¹</strong>ï¼š1.è¦StopTheWorldé˜²æ­¢æ ‡è®°çš„æ—¶å€™æ–°newçš„å¯¹è±¡æœªè¢«æ ‡è®°è€Œå‡ºé”™ï¼›</p><p>2.æ¸…é™¤å¯¹è±¡åå†…å­˜ä¸è¿ç»­ï¼Œä¼šæœ‰ä¸€å®šçš„æµªè´¹</p><h3 id="3-æ ‡è®°å‹ç¼©æ³•"><a href="#3-æ ‡è®°å‹ç¼©æ³•" class="headerlink" title="3.æ ‡è®°å‹ç¼©æ³•"></a>3.æ ‡è®°å‹ç¼©æ³•</h3><p><strong>åŸç†</strong>ï¼šç±»ä¼¼ã€æ ‡è®°æ¸…é™¤æ³•ã€‘ï¼Œä½†ä¼šå¯¹æ ‡è®°è¿›è¡Œå‹ç¼©ï¼Œå¦‚a-&gt;b-&gt;cï¼Œä¼šè¢«å‹ç¼©ä¸ºa-&gt;cï¼Œå…·ä½“è¯•è®²æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œå¤–çš„å†…å­˜</p><p><strong>ä¼˜ç¼ºç‚¹</strong>ï¼š1.ä¹Ÿè¦StopTheWorld</p><h3 id="4-å¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#4-å¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="4.å¼•ç”¨è®¡æ•°ç®—æ³•"></a>4.å¼•ç”¨è®¡æ•°ç®—æ³•</h3><p><strong>åŸç†</strong>ï¼šå¼•ç”¨+1ï¼Œä¸å¼•ç”¨-1ï¼Œä¸º0åˆ™åˆ é™¤ï¼Œä½†æ˜¯ä¼šæœ‰ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œjavaæœªä½¿ç”¨</p><p><strong>ä¼˜ç¼ºç‚¹</strong>ï¼šç›¸äº’å¾ªç¯ä½¿ç”¨ï¼š<br>a = b<br>b = a<br>é™¤æ­¤ä¹‹å¤–å†æ²¡æœ‰ç”¨åˆ°aï¼Œbçš„åœ°æ–¹ï¼Œä½†æ˜¯ç”±äºaï¼Œbçš„å¼•ç”¨ä¸ä¸º0æ‰€ä»¥æ— æ³•è¢«å›æ”¶ï¼Œå¯¼è‡´å†…å­˜æµªè´¹</p><h2 id="å›æ”¶è¿‡ç¨‹"><a href="#å›æ”¶è¿‡ç¨‹" class="headerlink" title="å›æ”¶è¿‡ç¨‹"></a>å›æ”¶è¿‡ç¨‹</h2><p>ä¸€ä¸ªä¸å¯è¾¾å¯¹è±¡åœ¨â€œæ­»ç¼“â€åˆ°â€œæ‰§è¡Œæ­»åˆ‘â€å‰è‡³å°‘ç»å†ä¸¤ä¸ªæ ‡è®°è¿‡ç¨‹</p><ol><li><p>ç¬¬ä¸€æ¬¡æ ‡è®°ï¼Œç­›é€‰ï¼šæ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼Œè‹¥æ˜¯åˆ™æ”¾åˆ°F-Queueé˜Ÿåˆ—ä¸­ã€è§¦å‘ã€‘è¯¥æ–¹æ³•ï¼Œä½†ä¸ä¿è¯æ‰§è¡Œå®Œè¯¥æ–¹æ³•ã€‚</p><p>å¯ä»¥åœ¨finlize()æ–¹æ³•ä¸­<strong>è‡ªæ•‘ä¸€æ¬¡</strong>ï¼šåœ¨è¯¥æ–¹æ³•ä¸­å°†<em>è‡ªèº«this</em>èµ‹å€¼ç»™å…¶ä»–å˜é‡ï¼Œè¿™æ ·åœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶ä¼šè¢«ç§»å‡º<em>å³å°†å›æ”¶</em>é›†åˆï¼›ä½†æ˜¯ç”±äºfinlize()æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åªèƒ½è‡ªæ•‘ä¸€æ¬¡ã€‚å¹¶<em>ä¸æ¨èè¯¥æ–¹æ³•</em>ï¼Œè¯¥æ–¹æ³•æ‰€æœ‰å¯ä»¥åšçš„å·¥ä½œï¼Œå¯ä»¥ç”¨<strong>tryâ€¦finally</strong>æˆ–è€…å…¶ä»–æ–¹æ³•æ›´å¥½çš„å®ç°</p></li><li><p>ç¬¬äºŒæ¬¡æ ‡è®°ï¼Œè‹¥finalize()æ–¹æ³•ä»¥åŠè°ƒç”¨è¿‡ï¼Œæˆ–è€…ä¸ºé‡å†™è¯¥æ–¹æ³•ï¼Œåˆ™â€œæ²¡å¿…è¦æ‰§è¡Œâ€ï¼Œå¯ä»¥å›æ”¶</p></li></ol><h1 id="å¯¹è±¡"><a href="#å¯¹è±¡" class="headerlink" title="å¯¹è±¡"></a>å¯¹è±¡</h1><h2 id="å¯¹è±¡å¼•ç”¨"><a href="#å¯¹è±¡å¼•ç”¨" class="headerlink" title="å¯¹è±¡å¼•ç”¨"></a>å¯¹è±¡å¼•ç”¨</h2><h3 id="å¼ºå¼•ç”¨StrongReference"><a href="#å¼ºå¼•ç”¨StrongReference" class="headerlink" title="å¼ºå¼•ç”¨StrongReference"></a>å¼ºå¼•ç”¨StrongReference</h3><p>People p = new People();å“ªæ€•æŠ›å‡ºOOMä¹Ÿä¸ä¼šè¢«GCå›æ”¶çš„å¯¹è±¡</p><h3 id="è½¯å¼•ç”¨SoftReference"><a href="#è½¯å¼•ç”¨SoftReference" class="headerlink" title="è½¯å¼•ç”¨SoftReference"></a>è½¯å¼•ç”¨SoftReference</h3><p>SoftReference sf = new SoftReference(p);åªè¦æœ‰è¶³å¤Ÿå†…å­˜å°±ä¸ä¼šè¢«GCå›æ”¶ï¼Œè‹¥å†…å­˜ä¸å¤Ÿåˆ™ä¼šè¢«GCå›æ”¶ï¼Œå¸¸ç”¨ä½œæœåŠ¡å™¨ç¼“å­˜</p><h3 id="å¼±å¼•ç”¨WeakReference"><a href="#å¼±å¼•ç”¨WeakReference" class="headerlink" title="å¼±å¼•ç”¨WeakReference"></a>å¼±å¼•ç”¨WeakReference</h3><p>åœ¨ä¸‹æ¬¡GCå›æ”¶ä¹‹å‰éƒ½å­˜åœ¨ï¼Œç”¨ä½œandroidç­‰å†…å­˜ç´§å¼ çš„è®¾å¤‡ä¸­çš„ç¼“å­˜</p><h3 id="è™šå¼•ç”¨PhantomReference"><a href="#è™šå¼•ç”¨PhantomReference" class="headerlink" title="è™šå¼•ç”¨PhantomReference"></a>è™šå¼•ç”¨PhantomReference</h3><p>æ— æ³•å½±å“å…¶ç”Ÿå­˜æ—¶é—´ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨è·å–å…¶å®ä¾‹ï¼Œè®¾ç½®è™šå¼•ç”¨åªæ˜¯ä¸ºäº†åœ¨å¯¹è±¡è¢«GCå›æ”¶æ—¶è·å–ç³»ç»Ÿé€šçŸ¥</p><h1 id="è„‘å›¾"><a href="#è„‘å›¾" class="headerlink" title="è„‘å›¾"></a>è„‘å›¾</h1><p><img src="https://jixiaoyong.github.io/images/blog/2018-02/JVMMemory.png" alt></p>]]></content>
      
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidç³»ç»Ÿæ¶æ„ç®€ä»‹</title>
      <link href="/blog/posts/e3bb9a54/"/>
      <url>/blog/posts/e3bb9a54/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¯´æ˜ï¼šæœ¬æ–‡åŸºäº<a href="http://gityuan.com/android/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¼€ç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢ </a> çš„å­¦ä¹ ç¬”è®°æ•´ç†</p></blockquote><p>Androidç³»ç»Ÿå¤§ä½“åˆ†ä¸º4ä¸ªæ¨¡å—ï¼Œä»åº•å±‚å¼€å§‹ä¾æ¬¡æ˜¯1.linuxå†…æ ¸ã€2.ç³»ç»Ÿåº“+Androidè¿è¡Œæ—¶ã€3.æ¡†æ¶å±‚ã€4.åº”ç”¨å±‚ã€‚</p><p><img src="https://raw.githubusercontent.com/jixiaoyong/jixiaoyong.github.io/master/images/blog/2018-02/AndroidSystemArchitecture.png" alt></p><p>ä¸‹å›¾æè¿°äº†Androidç³»ç»Ÿä»å¼€æœºåˆ°Apkè¿è¡Œçš„æ•´ä¸ªæµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/jixiaoyong/jixiaoyong.github.io/master/images/blog/2018-02/androidBoot.jpg" alt="ç³»ç»Ÿå¯åŠ¨æ¡†æ¶å›¾ï¼Œæ¥è‡ªgityuan.com"></p><p>æµç¨‹å¦‚ä¸‹ï¼š<code>Loader</code> -&gt; <code>Kernel</code> -&gt; <code>Native</code>-&gt; <code>Framework</code> -&gt; <code>App</code></p><p><strong>Loaderå±‚</strong></p><ol><li>Boot ROM ï¼šå¼€æœºæ—¶ï¼Œå¼•å¯¼èŠ¯ç‰‡ä»ROMè¯»å–è¯»å–åˆå§‹åŒ–ä»£ç ï¼ŒåŠ è½½å¼•å¯¼ç¨‹åºåˆ°RAMä¸­ã€‚</li><li>Boot Loaderï¼šæ˜¯å¯åŠ¨Androidç³»ç»Ÿä¹‹å‰çš„å¼•å¯¼ç¨‹åºï¼Œæ£€æŸ¥RAMã€åˆå§‹åŒ–ç¡¬ä»¶å‚æ•°ç­‰ã€‚</li></ol><p><strong>Kernelå±‚</strong>ï¼ˆå³Androidå†…æ ¸å±‚ï¼Œè¿›å…¥Androidç³»ç»Ÿï¼‰</p><ol><li>swapperè¿›ç¨‹ï¼ˆpid=0ï¼‰ï¼šBoot Loaderå¯åŠ¨swapperï¼ˆidleï¼‰è¿›ç¨‹ï¼Œæ˜¯ç”±å†…æ ¸åˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œç”¨æ¥åˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ã€é©±åŠ¨ç­‰ç­‰ã€‚</li><li>kthreaddè¿›ç¨‹ï¼ˆpid=2ï¼‰ï¼šæ˜¯Linuxç³»ç»Ÿçš„å†…æ ¸è¿›ç¨‹ï¼Œ<strong>æ˜¯æ‰€æœ‰å†…æ ¸è¿›ç¨‹çš„é¼»ç¥–</strong>ã€‚</li></ol><hr><p><strong>Syscall</strong>ï¼Œåœ¨Nativeå’ŒKernelä¹‹é—´çš„ç³»ç»Ÿè°ƒç”¨å±‚ã€‚</p><hr><p><strong>Nativeå±‚</strong></p><ol><li>initè¿›ç¨‹ï¼ˆpid=1ï¼‰ï¼šç”±swapperè¿›ç¨‹åˆ›å»ºï¼Œ<strong>æ˜¯æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹é¼»ç¥–</strong></li><li>initè¿›ç¨‹å­µåŒ–å‡ºç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ã€å¯åŠ¨ServiceManagerç®¡ç†ç³»ç»ŸæœåŠ¡ï¼Œå¯åŠ¨å¼€æœºåŠ¨ç”»Bootnaimã€‚</li></ol><hr><p><strong>JNI</strong>ï¼ŒJavaå±‚å’ŒNativeï¼ˆC/C++ï¼‰å±‚ä¹‹é—´ã€‚</p><hr><p><strong>Frameworkå±‚</strong></p><ol><li>Zygoteè¿›ç¨‹ï¼šç”±initè¿›ç¨‹forkç”Ÿæˆï¼Œæ˜¯<strong>Androidç³»ç»Ÿç¬¬ä¸€ä¸ªjavaè¿›ç¨‹ï¼Œæ˜¯æ‰€æœ‰javaè¿›ç¨‹çš„çˆ¶è¿›ç¨‹</strong></li><li>SystemServerè¿›ç¨‹ï¼šç”±Zygoteè¿›ç¨‹forkè€Œæ¥ï¼Œ<strong>æ˜¯Zygoteå­µåŒ–çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹</strong>ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ª<strong>java framework</strong>ï¼Œå¦‚ActivityManagerã€PowerManagerâ€¦</li><li>MediaServerè¿›ç¨‹ï¼šç”±initè¿›ç¨‹forkè€Œæ¥ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ª<strong>C++ framework</strong></li></ol><p><strong>APPå±‚</strong></p><ol><li>Launcherï¼š<strong>Zygoteè¿›ç¨‹å­µåŒ–çš„ç¬¬ä¸€ä¸ªAppè¿›ç¨‹</strong>ï¼Œæ¡Œé¢Appã€‚</li><li>å…¶ä»–ç”±Zygoteè¿›ç¨‹å­µåŒ–çš„ç³»ç»Ÿè¿›ç¨‹ï¼ˆBrowserã€Phoneâ€¦ï¼‰å’Œéç³»ç»Ÿappè¿›ç¨‹ã€‚</li></ol><p>æ‰¼è¦å†…å®¹å¦‚å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/jixiaoyong/jixiaoyong.github.io/master/images/blog/2018-02/AndroidBootImg.png" alt="ç³»ç»Ÿå¯åŠ¨ç¤ºæ„å›¾"></p><p>Androidå¸¸ç”¨çš„é€šä¿¡æ–¹å¼</p><ol><li>Binder</li><li>Socket</li><li>Handler</li></ol><p><strong>Binder/Socketç”¨äºè¿›ç¨‹é—´ï¼ˆéƒ½å…·æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼‰é€šä¿¡ï¼Œè€ŒHandleræ¶ˆæ¯æœºåˆ¶ç”¨äºåŒè¿›ç¨‹çš„çº¿ç¨‹é—´ï¼ˆå…±äº«å†…å­˜ç©ºé—´ï¼‰é€šä¿¡</strong></p><p>åœ¨Androidç³»ç»Ÿä¸­ï¼š</p><ul><li>Zygoteè¿›ç¨‹  â€“&gt;  Socketæœºåˆ¶</li><li>SystemServerã€MediaServerã€Appä¹‹é—´  â€“&gt;  Binder IPC</li><li>åŒä¸€è¿›ç¨‹ä¸åŒçº¿ç¨‹é—´ â€“&gt;  Handler</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidé˜…è¯»ç¬”è®°</title>
      <link href="/blog/posts/aacd75ab/"/>
      <url>/blog/posts/aacd75ab/</url>
      
        <content type="html"><![CDATA[<h2 id="layout-weight"><a href="#layout-weight" class="headerlink" title="layout_weight"></a>layout_weight</h2><p>layout_weight é‡è¦æ€§ï¼Œé»˜è®¤çš„æ˜¯0,0ç­‰çº§æœ€é«˜ï¼Œè¦æ˜¾ç¤ºï¼Œæ•°å­—è¶Šå¤§é‡è¦æ€§è¶Šä½ã€‚</p><p>ä¾‹ï¼šaï¼Œbçš„å®½åº¦ä¸º0ï¼Œlayout_weightåˆ†åˆ«ä¸º1ã€2ï¼Œåˆ™aï¼Œbå®½åº¦åˆ†åˆ«ä¸ºçˆ¶å®¹å™¨çš„2/3ã€1/3ã€‚</p><h2 id="PendingIntent"><a href="#PendingIntent" class="headerlink" title="PendingIntent"></a>PendingIntent</h2><p>PendingIntentæ˜¯å°è£…åçš„intentï¼Œæœ‰intentæ‰§è¡Œæ‰€éœ€çš„contextï¼Œæ‰€ä»¥å³ä½¿è¦æ‰§è¡Œintentçš„activityå·²ç»æ¶ˆå¤±æˆ–è€…è¿˜æ²¡ç”Ÿæˆï¼Œå…¶ä»–activityä¾ç„¶å¯ä»¥é€šè¿‡PendingIntentæ‰§è¡Œintentã€‚</p><blockquote><p>PendingIntent is a description of an Intent and target action to perform with it. Instances of this class are created with <code>getActivity(Context, int, Intent, int)</code>, <code>getActivities(Context, int, Intent[], int)</code>, <code>getBroadcast(Context, int, Intent, int)</code>, and <code>getService(Context, int, Intent, int)</code>; the returned object can be handed to other applications so that they can perform the action you described on your behalf at a later time.</p></blockquote><p>ä¹Ÿå°±æ˜¯æŠŠè‡ªå·±è¦æ‰§è¡Œçš„intentå’Œæ‰§è¡Œæ‰€éœ€çš„contextå°è£…åç»™åˆ«äººï¼Œè¯·åˆ«äººåœ¨é€‚å½“çš„æ—¶å€™æ‰§è¡Œã€‚</p><h2 id="androidæ¨¡æ‹Ÿå™¨è®¿é—®ç”µè„‘localhost"><a href="#androidæ¨¡æ‹Ÿå™¨è®¿é—®ç”µè„‘localhost" class="headerlink" title="androidæ¨¡æ‹Ÿå™¨è®¿é—®ç”µè„‘localhost"></a>androidæ¨¡æ‹Ÿå™¨è®¿é—®ç”µè„‘localhost</h2><p>ç”µè„‘<code>localhost</code>æˆ–è€…<code>127.0.0.1</code>è®¿é—®æœ¬åœ°ç½‘å€ã€‚</p><p>æ¨¡æ‹Ÿå™¨è®¿é—®<code>localhost</code>ä¼šé»˜è®¤è®¿é—®æ‰‹æœºçš„æœ¬åœ°ç½‘å€ï¼Œè¦è®¿é—®ç”µè„‘çš„æœ¬åœ°ç½‘å€åˆ™éœ€è¦è®¿é—®<code>10.0.2.2:8080</code>ï¼Œè®°å¾—åŠ ä¸Šå¯¹åº”çš„ç«¯å£ã€‚</p><h2 id="è·å–å±å¹•ç”»é¢"><a href="#è·å–å±å¹•ç”»é¢" class="headerlink" title="è·å–å±å¹•ç”»é¢"></a>è·å–å±å¹•ç”»é¢</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">View decor = MainActivity.<span class="keyword">this</span>.getWindow().getDecorView();</span><br><span class="line">decor.setDrawingCacheEnabled(<span class="keyword">true</span>);</span><br><span class="line">imageView.setImageBitmap(decor.getDrawingCache());</span><br></pre></td></tr></table></figure><h2 id="è·å–ç½‘ç»œä¿¡æ¯ï¼Œè¯·æ±‚ç½‘ç»œ"><a href="#è·å–ç½‘ç»œä¿¡æ¯ï¼Œè¯·æ±‚ç½‘ç»œ" class="headerlink" title="è·å–ç½‘ç»œä¿¡æ¯ï¼Œè¯·æ±‚ç½‘ç»œ"></a>è·å–ç½‘ç»œä¿¡æ¯ï¼Œè¯·æ±‚ç½‘ç»œ</h2><p>éœ€è¦è¯·æ±‚æƒé™</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>javaä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">chackNetWork</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isNetAvailable = <span class="keyword">false</span>;</span><br><span class="line">    ConnectivityManager manager = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (manager.getActiveNetworkInfo() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        isNetAvailable = manager.getActiveNetworkInfo().isAvailable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isNetAvailable) &#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"open network"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        intent.setAction(Settings.ACTION_NETWORK_OPERATOR_SETTINGS);</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a>LiveData</h1><p><code>LiveData</code>å¯ä»¥åœ¨æ•°æ®æœ‰å˜åŒ–çš„æ—¶å€™è°ƒç”¨è®¢é˜…è€…å¹¶æ‰§è¡ŒæŒ‡å®šæ–¹æ³•ã€‚</p><p><code>Transformations</code>æœ‰ä¸¤ä¸ªè½¬åŒ–<code>LiveData</code>çš„æ–¹æ³•ï¼š<code>map()</code>å’Œ<code>switchMap()</code>ã€‚</p><p><code>map()</code>å¯ä»¥å°†ä¸€ä¸ª<code>LiveData</code>ç»è¿‡å¤„ç†è½¬åŒ–ä¸ºå¦å¤–ä¸€ä¸ª<code>LiveData</code>ã€‚</p><p>è€Œ<code>switchMap()</code>åˆ™å¯ä»¥æ ¹æ®ä¸åŒçš„éœ€è¦åˆ‡æ¢ä¸åŒçš„<code>LiveData</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> live = MutableLiveData&lt;String&gt;()</span><br><span class="line"><span class="keyword">val</span> d : LiveData&lt;String&gt; = map(live)&#123;</span><br><span class="line">  <span class="string">"this is <span class="variable">$it</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">val</span> e = switchMap(live) &#123;</span><br><span class="line">    <span class="keyword">return</span><span class="symbol">@switchMap</span> <span class="keyword">when</span> (it) &#123;</span><br><span class="line">        <span class="string">"a"</span> -&gt; MutableLiveData&lt;String&gt;(<span class="string">"a"</span>)</span><br><span class="line">        <span class="string">"b"</span> -&gt; MutableLiveData(<span class="string">"b"</span>)</span><br><span class="line">        <span class="keyword">else</span> -&gt; MutableLiveData(<span class="string">"else"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œ<code>LiveData</code>çš„å­ç±»<code>MediatorLiveData</code>å¯ä»¥æ·»åŠ å¤šä¸ªç›‘å¬é¡¹ï¼Œæ¯ä¸ªé¡¹ç›®æ”¹å˜éƒ½ä¼šå›è°ƒå¯¹åº”çš„<code>onChange()</code>æ–¹æ³•ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> mediatorLiveData = MediatorLiveData&lt;String&gt;()</span><br><span class="line"></span><br><span class="line">mediatorLiveData.addSource(d) &#123;</span><br><span class="line">    update(it, e.value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mediatorLiveData.addSource(e) &#123;</span><br><span class="line">    update(d.value, it)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(a: <span class="type">String</span>? = <span class="string">""</span>, b: <span class="type">String</span>? = <span class="string">""</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">//do sth</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.jianshu.com/p/dab2ee97d680" target="_blank" rel="noopener">ã€è¯‘ã€‘LiveData ä½¿ç”¨è¯¦è§£</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidå®ç°å¯æŠ˜å toolbar</title>
      <link href="/blog/posts/b4832cd1/"/>
      <url>/blog/posts/b4832cd1/</url>
      
        <content type="html"><![CDATA[<p>ä½¿ç”¨åˆ°çš„ç±»æœ‰ï¼š</p><ul><li>android.support.design.widget.CoordinatorLayout</li><li>android.support.design.widget.AppBarLayout</li><li>android.support.design.widget.CollapsingToolbarLayout</li><li>android.support.v7.widget.Toolbar</li></ul><h1 id="æ•ˆæœé¢„è§ˆ"><a href="#æ•ˆæœé¢„è§ˆ" class="headerlink" title="æ•ˆæœé¢„è§ˆ"></a>æ•ˆæœé¢„è§ˆ</h1><p>å¦‚å›¾ï¼š</p><p><img src="http://jixiaoyong.github.io/blog/images/default/2018-02-22/coordinatorlayout.gif" alt></p><h1 id="ç®€è¦è¯´æ˜"><a href="#ç®€è¦è¯´æ˜" class="headerlink" title="ç®€è¦è¯´æ˜"></a>ç®€è¦è¯´æ˜</h1><p>CoordinatorLayoutç±»ï¼Œåè°ƒè€…å¸ƒå±€ï¼Œé€šè¿‡Behaviorå°†ä¸€ä¸ªå­viewï¼ˆ<code>child</code>ï¼‰çš„è¡Œä¸ºå’Œå¦ä¸€ä¸ªå­viewï¼ˆ<code>dependency</code>ï¼‰çš„æ´»åŠ¨è”ç»“èµ·æ¥ï¼Œä»è€Œå®ç°å­viewä¹‹é—´çš„è”åŠ¨ã€‚</p><p>AppBarLayoutç±»ï¼Œæ˜¯ä¸€ä¸ªå®ç°äº†ææ–™è®¾è®¡çš„é»˜è®¤å‚ç›´å¸ƒå±€çš„ViewGroupï¼Œå½“å…¶æ˜¯CoordinatorLayoutç±»çš„ç›´æ¥å­viewæ—¶,å¦å¤–ä¸€ä¸ªCoordinatorLayoutçš„å­viewæŒ‡å®šäº†behaviorä¸ºAppBarLayout.ScrollingViewBehaviorçš„å®ä¾‹ï¼ˆ<code>app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot;</code>ï¼‰,ä¸”è¯¥å­viewéœ€è¦æ˜¯NestedScrollingChildçš„å®ç°ç±»ã€‚</p><p>CollapsingToolbarLayoutç±»ï¼Œæä¾›ä¸€ä¸ªå¯ä»¥æŠ˜å çš„toolbarå¸ƒå±€ï¼Œå¯ä»¥åœ¨è¿™ä¸ªå¸ƒå±€é‡Œé¢ï¼Œè®¾ç½®toolbarä»¥åŠå’Œtoolbarä¸€èµ·è”åŠ¨çš„å­viewï¼Œæœ¬æ¡ˆä¾‹ä¸­æ˜¯ä¸€å¼ å›¾ç‰‡ã€‚</p><p>Toolbarç±»ï¼Œå®ç°toolbarçš„æ•ˆæœã€‚</p><h1 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h1><p>æºç ï¼š<a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/2018-02-22" target="_blank" rel="noopener">github</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.design.widget.CoordinatorLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.AppBarLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">android.support.design.widget.CollapsingToolbarLayout</span></span></span><br><span class="line"><span class="tag">              <span class="attr">app:layout_scrollFlags</span>=<span class="string">"scroll|exitUntilCollapsed"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">ImageView</span> </span></span><br><span class="line"><span class="tag">                  <span class="attr">app:layout_collapseMode</span>=<span class="string">"parallax"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">app:layout_collapseMode</span>=<span class="string">"pin"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">android.support.design.widget.CollapsingToolbarLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">android.support.design.widget.AppBarLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_behavior</span>=<span class="string">"@string/appbar_scrolling_view_behavior"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.design.widget.CoordinatorLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><ol><li>CoordinatorLayoutåœ¨æœ€å¤–å±‚ï¼Œæ³¨æ„å…¶ç›´æ¥å­viewå¿…é¡»å°±æ˜¯è¦å®ç°è”åŠ¨çš„viewï¼Œå¦åˆ™è”åŠ¨å¤±æ•ˆã€‚</li><li>CollapsingToolbarLayoutå¿…é¡»è®¾ç½®layout_scrollFlagsï¼Œå…¶ä½™å±æ€§å¯é€‰ã€‚</li></ol><blockquote><p>layout_scrollFlagsè¯´æ˜å¦‚ä¸‹ï¼š</p><p><strong>scroll</strong>ï¼šæ‰€æœ‰æƒ³æ»šåŠ¨å‡ºå±å¹•çš„viewéƒ½éœ€è¦è®¾ç½®è¿™ä¸ªflagï¼Œ æ²¡æœ‰è®¾ç½®è¿™ä¸ªflagçš„viewå°†è¢«å›ºå®šåœ¨å±å¹•é¡¶éƒ¨ã€‚</p><p><strong>enterAlways</strong>ï¼šè¿™ä¸ªflagè®©ä»»æ„å‘ä¸‹çš„æ»šåŠ¨éƒ½ä¼šå¯¼è‡´è¯¥viewå˜ä¸ºå¯è§ï¼Œå¯ç”¨å¿«é€Ÿâ€œè¿”å›æ¨¡å¼â€ã€‚</p><p><strong>enterAlwaysCollapsed</strong>ï¼šå‡è®¾ä½ å®šä¹‰äº†ä¸€ä¸ªæœ€å°é«˜åº¦ï¼ˆminHeightï¼‰åŒæ—¶enterAlwaysä¹Ÿå®šä¹‰äº†ï¼Œé‚£ä¹ˆviewå°†åœ¨åˆ°è¾¾è¿™ä¸ªæœ€å°é«˜åº¦çš„æ—¶å€™å¼€å§‹æ˜¾ç¤ºï¼Œå¹¶ä¸”ä»è¿™ä¸ªæ—¶å€™å¼€å§‹æ…¢æ…¢å±•å¼€ï¼Œå½“æ»šåŠ¨åˆ°é¡¶éƒ¨çš„æ—¶å€™å±•å¼€å®Œã€‚</p><p><strong>exitUntilCollapsed</strong>ï¼šå½“ä½ å®šä¹‰äº†ä¸€ä¸ªminHeightï¼Œæ­¤å¸ƒå±€å°†åœ¨æ»šåŠ¨åˆ°è¾¾è¿™ä¸ªæœ€å°é«˜åº¦çš„æ—¶å€™æŠ˜å ã€‚</p><p><strong>snap</strong>ï¼šå½“ä¸€ä¸ªæ»šåŠ¨äº‹ä»¶ç»“æŸï¼Œå¦‚æœè§†å›¾æ˜¯éƒ¨åˆ†å¯è§çš„ï¼Œé‚£ä¹ˆå®ƒå°†è¢«æ»šåŠ¨åˆ°æ”¶ç¼©æˆ–å±•å¼€ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè§†å›¾åªæœ‰åº•éƒ¨25%æ˜¾ç¤ºï¼Œå®ƒå°†æŠ˜å ã€‚ç›¸åï¼Œå¦‚æœå®ƒçš„åº•éƒ¨75%å¯è§ï¼Œé‚£ä¹ˆå®ƒå°†å®Œå…¨å±•å¼€ã€‚</p><p>ä½œè€…ï¼šå°¹star</p><p>é“¾æ¥ï¼š<a href="https://www.jianshu.com/p/5287d090e777" target="_blank" rel="noopener">https://www.jianshu.com/p/5287d090e777</a></p></blockquote><ol><li>CollapsingToolbarLayoutçš„å­viewéœ€è¦æŒ‡å®šlayout_collapseModeï¼Œè¿˜æœ‰ä¸€ç‚¹éœ€æ³¨æ„ï¼š<strong>å’Œtoolbarè”åŠ¨çš„å­viewé«˜åº¦éœ€å¤§äºtoolbaré«˜åº¦ï¼Œå¦åˆ™æ— æ•ˆæœã€‚</strong></li><li>ViewPagerå°±æ˜¯æœ¬æ¡ˆä¾‹ä¸­è§¦å‘å­viewè”åŠ¨æ•ˆæœçš„<code>dependency</code>ï¼Œéœ€è¦æŒ‡å®šå…¶behaviorï¼š</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app:layout_behavior="@string/appbar_scrolling_view_behavior"</span><br></pre></td></tr></table></figure><p>å…¶å®é™…å¯¹åº”äºandroid.support.design.widget.AppBarLayout$ScrollingViewBehavior ï¼Œè¿™ä¸ªæ˜¯ç³»ç»Ÿå®ç°çš„ä¸€ä¸ªbehaviorï¼Œç”¨äºå’ŒåµŒå¥—æ»‘åŠ¨äº‹ä»¶ç»‘å®šï¼Œ<strong>æŒ‡å®šè¯¥behaviorçš„å­viewéœ€è¦æ˜¯NestedScrollingChildçš„å®ç°ç±»</strong>ï¼ˆç³»ç»Ÿæä¾›äº†4ä¸ªå®ç°ç±»ï¼šNavigationMenuViewã€NestedScrollViewã€RecyclerViewã€SwipleRefreshLayoutï¼‰ï¼Œæ‰€ä»¥viewPagerä¸­é¡µé¢æœ‰ä¸Šè¿°4ä¸ªç±»æˆ–å…¶å­ç±»æ—¶ï¼Œæ‰èƒ½å®ç°ç»‘å®šæ•ˆæœã€‚</p><h1 id="å»¶ä¼¸"><a href="#å»¶ä¼¸" class="headerlink" title="å»¶ä¼¸"></a>å»¶ä¼¸</h1><p><strong>è‡ªå®šä¹‰Behavior</strong></p><p>è‡ªå®šä¹‰Behavioræœ‰ä¸¤ä¸ªç›®çš„ï¼š</p><ol><li>å°†ä¸¤ä¸ªæˆ–å¤šä¸ªå­viewç»‘å®šï¼›</li><li>å°†ä¸€ä¸ªå­viewä¸å¦ä¸€ä¸ªå­viewçš„æ»‘åŠ¨äº‹ä»¶ç»‘å®šåœ¨ä¸€èµ·</li></ol><p>ä¸¤è€…çš„å·®å¼‚åœ¨äºåœ¨å®ç°<code>CoordinatorLayout.Behavior&lt;T&gt;</code> ç±»æ—¶å€™å…·ä½“é‡å†™çš„æ–¹æ³•ä¸ä¸€æ ·ã€‚</p><p><strong>ç›®çš„1</strong>ï¼šéœ€è¦é‡å†™çš„æ–¹æ³•æœ‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">layoutDependsOn</span><span class="params">(CoordinatorLayout parent, T child, View dependency)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœdependencyæ˜¯è¦ä¾èµ–çš„å­viewï¼ˆæ­¤å¤„æ˜¯TempViewç±»ï¼‰çš„å®ä¾‹ï¼Œè¯´æ˜å®ƒå°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„Dependency</span></span><br><span class="line">    <span class="keyword">return</span> dependency <span class="keyword">instanceof</span> TempView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¯æ¬¡dependencyä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šæ‰§è¡ŒonDependentViewChangedæ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDependentViewChanged</span><span class="params">(CoordinatorLayout parent, T child, View dependency)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®dependencyçš„ä½ç½®ï¼Œè®¾ç½®childçš„ä½ç½®,å¯¹childè¿›è¡Œæƒ³è¦å®ç°çš„å˜åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;<span class="comment">//è¿”å›trueè¡¨ç¤ºæ”¹å˜äº†child çš„å°ºå¯¸å’Œä½ç½®å‚æ•°ï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç›®çš„2</strong>ï¼šéœ€è¦é‡å†™çš„æ–¹æ³•æœ‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦è¦å¼€å§‹æ ¹æ®dependencyå­viewçš„è¡Œä¸ºæ”¹å˜childçš„çŠ¶æ€</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStartNestedScroll</span><span class="params">(@NonNull CoordinatorLayout coordinatorLayout, @NonNull ImageView child,@NonNull View directTargetChild, @NonNull View target, <span class="keyword">int</span> axes, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> child <span class="keyword">instanceof</span> ImageView &amp;&amp; axes == View.SCROLL_AXIS_VERTICAL;<span class="comment">//å­viewæ˜¯ImageViewï¼Œå¹¶ä¸”æ»‘åŠ¨çš„æ–¹å‘æ˜¯å‚ç›´çš„</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“dependencyå­viewæ»‘åŠ¨æ—¶ï¼Œå¯¹childè¿›è¡Œç›¸åº”å¤„ç†</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedPreScroll</span><span class="params">(@NonNull CoordinatorLayout coordinatorLayout, @NonNull ImageView child, @NonNull View target, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, @NonNull <span class="keyword">int</span>[] consumed, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onNestedPreScroll(coordinatorLayout, child, target, dx, dy, consumed, type);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><h1 id="è‡ªå®šä¹‰-Behavior-çš„æ€»ç»“"><a href="#è‡ªå®šä¹‰-Behavior-çš„æ€»ç»“" class="headerlink" title="è‡ªå®šä¹‰ Behavior çš„æ€»ç»“"></a>è‡ªå®šä¹‰ Behavior çš„æ€»ç»“</h1><ol><li>ç¡®å®š CoordinatorLayout ä¸­ View ä¸ View ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œé€šè¿‡ layoutDependsOn() æ–¹æ³•ï¼Œè¿”å›å€¼ä¸º true åˆ™ä¾èµ–ï¼Œå¦åˆ™ä¸ä¾èµ–ã€‚</li><li>å½“ä¸€ä¸ªè¢«ä¾èµ–é¡¹ dependency å°ºå¯¸æˆ–è€…ä½ç½®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¾èµ–æ–¹ä¼šé€šè¿‡ Byhavior è·å–åˆ°ï¼Œç„¶ååœ¨ onDependentViewChanged ä¸­å¤„ç†ã€‚å¦‚æœåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ child å°ºå¯¸æˆ–è€…ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™éœ€è¦ return trueã€‚</li><li>å½“ Behavior ä¸­çš„ View å‡†å¤‡å“åº”åµŒå¥—æ»‘åŠ¨æ—¶ï¼Œå®ƒä¸éœ€è¦é€šè¿‡ layoutDependsOn() æ¥è¿›è¡Œä¾èµ–ç»‘å®šã€‚åªéœ€è¦åœ¨ onStartNestedScroll() æ–¹æ³•ä¸­é€šè¿‡è¿”å›å€¼å‘ŠçŸ¥ ViewParentï¼Œå®ƒæ˜¯å¦å¯¹åµŒå¥—æ»‘åŠ¨æ„Ÿå…´è¶£ã€‚è¿”å›å€¼ä¸º true æ—¶ï¼Œåç»­çš„æ»‘åŠ¨äº‹ä»¶æ‰èƒ½è¢«å“åº”ã€‚</li><li>åµŒå¥—æ»‘åŠ¨åŒ…æ‹¬æ»‘åŠ¨(scroll) å’Œ å¿«é€Ÿæ»‘åŠ¨(fling) ä¸¤ç§æƒ…å†µã€‚å¼€å‘è€…æ ¹æ®å®é™…æƒ…å†µè¿ç”¨å°±å¥½äº†ã€‚</li><li>Behavior é€šè¿‡ 3 ç§æ–¹å¼ç»‘å®šï¼š1. xml å¸ƒå±€æ–‡ä»¶ã€‚2. ä»£ç è®¾ç½® layoutparamã€‚3. è‡ªå®šä¹‰ View çš„æ³¨è§£ã€‚</li></ol><p>æ¥æº ï¼š<a href="http://blog.csdn.net/briblue/article/details/73076458" target="_blank" rel="noopener">é’ˆå¯¹ CoordinatorLayout åŠ Behavior çš„ä¸€æ¬¡ç»†èŠ‚è¾ƒçœŸ - frank çš„ä¸“æ  - CSDNåšå®¢</a></p></blockquote><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><ul><li><a href="http://blog.csdn.net/briblue/article/details/73076458" target="_blank" rel="noopener">é’ˆå¯¹ CoordinatorLayout åŠ Behavior çš„ä¸€æ¬¡ç»†èŠ‚è¾ƒçœŸ - frank çš„ä¸“æ  - CSDNåšå®¢</a>  </li><li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0824/6565.html" target="_blank" rel="noopener">CoordinatorLayout è‡ªå®šä¹‰Behaviorå¹¶ä¸éš¾ï¼Œç”±ç®€åˆ°éš¾æ‰‹æŠŠæ‰‹å¸¦ä½ æ’¸ä¸‰æ¬¾ï¼ - æ³¡åœ¨ç½‘ä¸Šçš„æ—¥å­</a></li><li><a href="https://www.jianshu.com/p/8c92d0a1e591" target="_blank" rel="noopener">ä¸€æ­¥ä¸€æ­¥æ·±å…¥ç†è§£CoordinatorLayout - ç®€ä¹¦</a></li><li><a href="https://www.jianshu.com/p/5287d090e777" target="_blank" rel="noopener">ä½¿ç”¨CoordinatorLayoutæ‰“é€ ä¸€ä¸ªç‚«é…·çš„è¯¦æƒ…é¡µ - ç®€ä¹¦</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidè‡ªå®šä¹‰viewçš„ä¸€äº›çŸ¥è¯†ç‚¹</title>
      <link href="/blog/posts/e41787ec/"/>
      <url>/blog/posts/e41787ec/</url>
      
        <content type="html"><![CDATA[<h1 id="Viewçš„ç»˜åˆ¶"><a href="#Viewçš„ç»˜åˆ¶" class="headerlink" title="Viewçš„ç»˜åˆ¶"></a>Viewçš„ç»˜åˆ¶</h1><p>Viewçš„ç»˜åˆ¶åˆ†ä¸º3éƒ¨åˆ†ï¼š</p><ol><li><p>measure</p><p>æµ‹é‡ï¼Œå†³å®šäº†Viewçš„æµ‹é‡å®½ã€é«˜ã€‚å‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹éƒ½ç­‰åŒäºViewçš„æœ€ç»ˆå®½ã€é«˜ï¼ˆå¦‚æœViewéœ€è¦å¤šæ¬¡measureæ‰èƒ½ç¡®å®šå¤§å°ï¼Œæˆ–è€…é‡å†™äº†<code>layout()</code>æ–¹æ³•ï¼Œå¹¶ä¿®æ”¹äº†ä¼ å…¥çš„å€¼çš„è¯åˆ™ä¸ä¼šç›¸ç­‰ï¼‰ã€‚</p></li><li><p>layout</p><p>å¸ƒå±€ï¼Œå†³å®šViewçš„å››ä¸ªé¡¶ç‚¹åæ ‡å’Œå®é™…çš„å®½ã€é«˜ã€‚</p></li><li><p>draw</p><p>ç»˜åˆ¶ï¼Œå†³å®šäº†Viewçš„å…·ä½“æ˜¾ç¤ºå†…å®¹ã€‚</p></li></ol><p>å…¶ä¸­é€šè¿‡ViewRootImplç±»çš„<code>performTraversals()</code>ä¾æ¬¡è°ƒç”¨<code>performXXX()</code>æ–¹æ³•ã€‚</p><h1 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h1><p>MeasureSpecæ˜¯ä¸€ä¸ª32ä½intå€¼ï¼Œé«˜2ä½è¡¨ç¤ºSpecModeï¼Œä½30ä½è¡¨ç¤ºSpecSizeã€‚</p><p>SpecModeæœ‰3ç§å¯èƒ½å€¼ï¼š</p><ul><li>UNSPECIFIED çˆ¶å®¹å™¨æ²¡æœ‰é™å®šViewå¤§å°ï¼Œå¯ä»¥æ˜¯ä»»æ„éœ€è¦çš„å¤§å°</li><li>EXACTLY çˆ¶ç±»æŒ‡å®šäº†Viewçš„å…·ä½“å¤§å°ï¼ŒViewçš„æœ€ç»ˆå¤§å°å°±æ˜¯è¿™ä¸ªå€¼(match_parentæˆ–è€…å…·ä½“æ•°å€¼)</li><li>AT_MOST Viewå¯ä»¥æ˜¯è¿™ä¸ªå€¼ä»¥å†…çš„ä»»æ„å¤§å°(wrap_content)</li></ul><p>æˆ‘ä»¬æŒ‡å®šçš„Viewçš„LayoutParamså’Œçˆ¶å®¹å™¨ï¼ˆDecorViewåˆ™æ˜¯çª—å£çš„å°ºå¯¸ï¼Œæ™®é€šViewæ˜¯çˆ¶å®¹å™¨çš„MeasureSpecï¼‰ä¸€èµ·å†³å®šäº†Viewçš„MeasureSpecï¼Œè¿›è€Œå†³å®šäº†Viewçš„å®½é«˜ã€‚</p><p>SpecSizeå†³å®šäºçˆ¶å®¹å™¨çš„å°ºå¯¸ã€ä»¥åŠViewçš„marginå’Œpaddingã€‚</p><h1 id="Viewç»˜åˆ¶æµç¨‹"><a href="#Viewç»˜åˆ¶æµç¨‹" class="headerlink" title="Viewç»˜åˆ¶æµç¨‹"></a>Viewç»˜åˆ¶æµç¨‹</h1><p>finalç±»å‹çš„<code>measure()</code>æ–¹æ³•è°ƒç”¨<code>onMeasure()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (forceLayout || needsLayout) &#123;</span><br><span class="line">            <span class="keyword">int</span> cacheIndex = forceLayout ? -<span class="number">1</span> : mMeasureCache.indexOfKey(key);</span><br><span class="line">            <span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</span><br><span class="line">                <span class="comment">// measure ourselves, this should set the measured dimension flag back</span></span><br><span class="line">                onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">                mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">            &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>onMeasure()</code>è°ƒç”¨äº†<code>setMeasuredDimension()</code>æ–¹æ³•è®¾ç½®äº†Viewå®½ã€é«˜çš„æµ‹é‡å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = size;</span><br><span class="line">        <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">        <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">            result = size;<span class="comment">//è¿”å›getSuggestedMinimumWidth/Heightçš„å¤§å°</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">            result = specSize;<span class="comment">//è¿”å›æµ‹é‡å¤§å°</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getSuggestedMinimumXXX()</code>çš„å€¼ï¼š</p><p>å¦‚æœViewæ²¡æœ‰èƒŒæ™¯ï¼Œåˆ™è¿”å›çš„æ˜¯Viewçš„<code>android:miniWidth</code>æŒ‡å®šçš„å€¼ï¼›</p><p>å¦‚æœViewæœ‰èƒŒæ™¯ï¼Œåˆ™è¿”å›çš„æ˜¯èƒŒæ™¯çš„<code>minimumWidth</code>çš„å€¼å’Œ<code>android:miniWidth</code>æŒ‡å®šçš„å€¼ä¸­æœ€å¤§çš„ä¸€ä¸ªå€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinHeight : max(mMinHeight, mBackground.getMinimumHeight());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœç›´æ¥ç»§æ‰¿è‡ªViewçš„æ§ä»¶å¿…é¡»é‡å†™<code>onMeasure()</code>æ–¹æ³•ï¼Œè®¾ç½®wrap_contentæ—¶å€™æ§ä»¶çš„å¤§å°ã€‚è¿™æ˜¯å› ä¸ºï¼š</p><p>wrap_contentå¯¹åº”çš„specModeæ˜¯AT_MOSTæ¨¡å¼ï¼Œå…¶å®½é«˜ç­‰äº<code>specSize</code>ã€‚</p><p>æ ¹æ®ViewGroupçš„<code>getChildMeasureSpec()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“æ­¤æ—¶çš„<code>specSize</code>æ˜¯çˆ¶å®¹å™¨ç›®å‰å¯ä»¥ç”¨çš„å¤§å°ï¼Œå³è¿™ç§æƒ…å†µä¸‹wrap_contentçš„æ•ˆæœå’Œmatch_parentçš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p><p>è¦é¿å…è¿™ç§æƒ…å†µï¼Œå°±éœ€è¦é‡å†™<code>onMeasure()</code>æ–¹æ³•ï¼Œåœ¨é‡Œé¢ä¸“é—¨æŒ‡å®šwrap_contentæ—¶Viewå¯¹åº”çš„å¤§å°ã€‚</p><h1 id="è·å–Viewçš„å®½é«˜"><a href="#è·å–Viewçš„å®½é«˜" class="headerlink" title="è·å–Viewçš„å®½é«˜"></a>è·å–Viewçš„å®½é«˜</h1><p>ç”±äºViewçš„ç»˜åˆ¶å’ŒActivityçš„ç”Ÿå‘½å‘¨æœŸä¸åŒæ­¥ï¼Œæ‰€ä»¥åœ¨<code>onCreate()/onStart()/onResume()</code>ä¸­éƒ½æ— æ³•æœ‰æ•ˆè·å–Viewçš„å®½é«˜ã€‚ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ™å¯ä»¥æ­£å¸¸è·å–Viewçš„å®½é«˜ï¼š</p><ol><li><p>Activity/View#onWindowFocusChanged()</p><p>å½“å‰çš„Windowè·å–æˆ–å¤±å»ç„¦ç‚¹çš„æ—¶å€™è°ƒç”¨ï¼Œæ­¤æ—¶Viewå·²ç»åˆå§‹åŒ–å®Œæ¯•ï¼Œå¯ä»¥è·å–å®½ã€é«˜ã€‚</p><p>Activityçª—å£ç„¦ç‚¹å˜åŒ–(onPause/onResume)æ—¶ä¼šè¢«è°ƒç”¨å¤šæ¬¡ã€‚</p></li><li><p>View#post(runnable)</p><p>è¯¥runnableåœ¨viewçš„æ¶ˆæ¯é˜Ÿåˆ—å°¾éƒ¨ï¼Œè¢«æ‰§è¡Œæ—¶Viewå·²ç»åˆå§‹åŒ–å¥½äº†ï¼Œå¯ä»¥åœ¨è¿™é‡Œè·å–å®½é«˜ã€‚</p></li><li><p>ViewTreeObserver</p><p>æ³¨å†ŒonGlobalLayoutListenerï¼Œå½“Viewæ ‘çš„çŠ¶æ€å˜æ›´ï¼Œæˆ–è€…Viewæ ‘å†…éƒ¨Viewå¯è§æ€§å‘ç”Ÿå˜åŒ–å°±ä¼šè¢«å›è°ƒã€‚</p><p>å½“Viewæ ‘çš„çŠ¶æ€å˜æ›´å¯èƒ½è¢«è°ƒç”¨å¤šæ¬¡ã€‚</p></li><li><p>View#measure()</p><p>æ‰‹åŠ¨è°ƒç”¨<code>measure()</code>æ–¹æ³•è·å–å®½é«˜ã€‚</p></li></ol><h1 id="drawè¿‡ç¨‹"><a href="#drawè¿‡ç¨‹" class="headerlink" title="drawè¿‡ç¨‹"></a>drawè¿‡ç¨‹</h1><p>ç»˜åˆ¶è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>ç»˜åˆ¶èƒŒæ™¯ <code>background.draw(canvas);</code></li><li>ç»˜åˆ¶è‡ªèº« <code>onDraw(canvas);</code></li><li>ç»˜åˆ¶children <code>dispatchDraw(canvas);</code></li><li>ç»˜åˆ¶è£…é¥° <code>onDrawForeground(canvas);</code></li></ol><p><code>setWillNotDraw()</code>è¡¨ç¤ºå½“å‰çš„ViewGroupä¸éœ€è¦ç»˜åˆ¶ä»»ä½•å†…å®¹ï¼Œç³»ç»Ÿä¼šå¯¹æ­¤è¿›è¡Œä¼˜åŒ–ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ã€‚å¦‚æœViewGroupéœ€è¦ç»˜åˆ¶å†…å®¹æ—¶ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨å…³é—­è¿™ä¸ªæ ‡å¿—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWillNotDraw</span><span class="params">(<span class="keyword">boolean</span> willNotDraw)</span> </span>&#123;</span><br><span class="line">    setFlags(willNotDraw ? WILL_NOT_DRAW : <span class="number">0</span>, DRAW_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç»˜åˆ¶ä¸¤ä¸ªå›¾å½¢é‡å éƒ¨åˆ†"><a href="#ç»˜åˆ¶ä¸¤ä¸ªå›¾å½¢é‡å éƒ¨åˆ†" class="headerlink" title="ç»˜åˆ¶ä¸¤ä¸ªå›¾å½¢é‡å éƒ¨åˆ†"></a>ç»˜åˆ¶ä¸¤ä¸ªå›¾å½¢é‡å éƒ¨åˆ†</h1><p>androidè‡ªå®šä¹‰viewæ—¶ä¸¤ä¸ªå›¾å½¢é‡å éƒ¨åˆ†çš„ç»˜åˆ¶æ–¹å¼,ä¸€å®šè¦è°ƒç”¨<code>canvas.saveLayer()</code> ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸ªæ­¥éª¤ååˆ†é‡è¦ï¼Œå°†å½“å‰ç”»å¸ƒä¿å­˜ä¸ºæ–°çš„ä¸€å±‚</span></span><br><span class="line"><span class="keyword">int</span> save = canvas.saveLayer(<span class="number">0</span>,<span class="number">0</span>,mWidth,mHeight,<span class="keyword">null</span>,Canvas.ALL_SAVE_FLAG);</span><br><span class="line"></span><br><span class="line">Paint paint = <span class="keyword">new</span> Paint();</span><br><span class="line">paint.setColor(mBackgroundColor);</span><br><span class="line"></span><br><span class="line">RectF backgroundRectF = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, mWidth, mHeight);</span><br><span class="line">canvas.drawRoundRect(backgroundRectF, mRadius, mRadius, paint);</span><br><span class="line"></span><br><span class="line">paint.setColor(mForwardColor);</span><br><span class="line"><span class="comment">//è®¾ç½®äºŒè€…é‡å éƒ¨åˆ†çš„ç»˜åˆ¶æ–¹å¼</span></span><br><span class="line">paint.setXfermode(<span class="keyword">new</span> PorterDuffXfermode(PorterDuff.Mode.SRC_IN));</span><br><span class="line">RectF progressRectF = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, mWidth * mProgress, mHeight);</span><br><span class="line">canvas.drawRect(progressRectF,paint);</span><br><span class="line"></span><br><span class="line"><span class="comment">//restore to canvas</span></span><br><span class="line">canvas.restoreToCount(save);</span><br></pre></td></tr></table></figure><p><code>paint.setXfermode()</code>å¯ä»¥è®¾ç½®çš„å€¼å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="http://jixiaoyong.github.io/images/20190408175100.png" alt></p><p>å‚è€ƒè‡ª<a href="https://www.cnblogs.com/DarkMaster/p/4618872.html" target="_blank" rel="noopener">ã€åŸã€‘ä½¿ç”¨Xfermodeæ­£ç¡®çš„ç»˜åˆ¶å‡ºé®ç½©æ•ˆæœ - sky0014 - åšå®¢å›­  </a></p><h1 id="é€‚é…è‡ªå®šä¹‰viewå®½é«˜ï¼Œè®¾ç½®é»˜è®¤å€¼"><a href="#é€‚é…è‡ªå®šä¹‰viewå®½é«˜ï¼Œè®¾ç½®é»˜è®¤å€¼" class="headerlink" title="é€‚é…è‡ªå®šä¹‰viewå®½é«˜ï¼Œè®¾ç½®é»˜è®¤å€¼"></a>é€‚é…è‡ªå®šä¹‰viewå®½é«˜ï¼Œè®¾ç½®é»˜è®¤å€¼</h1><p>ä»¥å…¶å®½åº¦ä¸ºä¾‹ï¼Œåœ¨<code>onMeasure(int widthMeasureSpec, int heightMeasureSpec)</code>æ–¹æ³•ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (widthMode == MeasureSpec.EXACTLY) &#123;</span><br><span class="line">    mWidth = widthSize;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mWidth = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">        mWidth = Math.min(mWidth, widthSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹</p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaåˆ›å»ºçº¿ç¨‹å®‰å…¨çš„å•ä¾‹Singleton</title>
      <link href="/blog/posts/36721083/"/>
      <url>/blog/posts/36721083/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>åœ¨ç¼–ç ä¸­å¸¸å¸¸ä¼šç”¨åˆ°å•ä¾‹ï¼Œæ¥ç¡®ä¿ç±»æœ‰ä¸€ä¸ªå”¯ä¸€çš„å¯¹è±¡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°†æ„é€ æ–¹æ³•ç§æœ‰åŒ–æ—¢å¯ä»¥å®ç°ï¼Œä½†å½“è€ƒè™‘åˆ°å¤šçº¿ç¨‹æ—¶äº‹æƒ…ä¼šå˜å¾—æœ‰äº›å¤æ‚ï¼Œæœ¬æ–‡è®¨è®ºçš„æ­£æ˜¯å‡ ç§å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å®ç°å•ä¾‹çš„æ–¹æ³•ã€‚</p><h1 id="1-æ™®é€šå•ä¾‹"><a href="#1-æ™®é€šå•ä¾‹" class="headerlink" title="1.æ™®é€šå•ä¾‹"></a>1.æ™®é€šå•ä¾‹</h1><p>ç§æœ‰åŒ–æ„é€ æ–¹æ³•ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªå…¬æœ‰ã€é™æ€çš„æ–¹æ³•ï¼Œåœ¨å…¶å†…éƒ¨åˆ¤æ–­ç±»å¯¹è±¡æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦çš„è¯ç”Ÿæˆç±»å¯¹è±¡å†è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ASingleton</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ASingleton as;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ASinleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.print(<span class="string">"ASingleton init!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ASingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(as == <span class="keyword">null</span>) &#123;              <span class="comment">//tag1</span></span><br><span class="line">as = <span class="keyword">new</span> ASingleton();    <span class="comment">//tag2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> as;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œåœ¨è€ƒè™‘å¤šçº¿ç¨‹æ—¶ï¼Œç”±äºjavaä»£ç æ˜¯ä¸€è¡Œè¡Œè¿›è¡Œçš„ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹t1ã€t2ï¼Œå½“asä¸ºnullçš„æ—¶å€™t1æ‰§è¡Œåˆ°tag1ä½ç½®ï¼Œåˆ¤æ–­ä¸ºtrueï¼Œäºæ˜¯å‡†å¤‡æ‰§è¡Œtag2ï¼Œå°±åœ¨æ­¤æ—¶ï¼Œcupè°ƒåº¦t2å¼€å§‹æ‰§è¡Œtag1ï¼Œæ­¤æ—¶t1å°šæœªæ‰§è¡Œtag2ï¼Œæ‰€ä»¥åœ¨t2ä¸­tag1åˆ¤æ–­ä¸ºtrue,t2ä¹Ÿå¼€å§‹æ‰§è¡Œtag2ç”Ÿæˆä¸€ä¸ªæ–°å¯¹è±¡,è¿™æ ·å½“t1å†æ¬¡æ‰§è¡Œtag2æ—¶å°±ä¼šå†ç”Ÿæˆä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè¿™æ ·å°±åŒæ—¶å­˜åœ¨å¤šä¸ªç±»çš„å¯¹è±¡ã€‚</p><h1 id="2-åŒæ­¥é”"><a href="#2-åŒæ­¥é”" class="headerlink" title="2.åŒæ­¥é”"></a>2.åŒæ­¥é”</h1><p>å¯¹ä¸Šé¢çš„ä»£ç ç¨ä½œä¼˜åŒ–,å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†synchronizedï¼Œå¯¹åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå§‹åŒ–è¿›è¡Œäº†åŒæ­¥é”ï¼Œè¿™æ ·å½“çº¿ç¨‹t1è®¿é—®æ—¶ï¼Œè¯­å¥è¢«é”å®šï¼Œt2è¿è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œåªèƒ½ç­‰t1è¿è¡Œå®Œè¿™æ®µè¯­å¥å¹¶é‡Šæ”¾ä¹‹åï¼Œæ‰èƒ½ç»§ç»­è®¿é—®ï¼Œæ­¤æ—¶aså·²ç»è¢«èµ‹äºˆäº†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ä¼šå†ç»§ç»­æ–°å»ºï¼Œè¿™æ ·å°±ä¿è¯äº†å•ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ASingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ASingleton as;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ASinleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.print(<span class="string">"ASingleton init!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ASingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (ASingleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (as == <span class="keyword">null</span>) &#123;</span><br><span class="line">as = <span class="keyword">new</span> ASingleton();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> as;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·ä¹Ÿå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–å•ä¾‹éƒ½è¦è¿›å…¥åŒæ­¥é”ï¼Œè¿™æ ·ç´¯è®¡ä¸‹æ¥å¿…ç„¶å½±å“æ•ˆç‡ã€‚</p><h1 id="3-åŒé‡æ£€æŸ¥é”å®š"><a href="#3-åŒé‡æ£€æŸ¥é”å®š" class="headerlink" title="3.åŒé‡æ£€æŸ¥é”å®š"></a>3.åŒé‡æ£€æŸ¥é”å®š</h1><p>é‚£ä¹ˆåœ¨åˆ¤æ–­asä¸ºnullåï¼Œå¯¹asçš„åˆå§‹åŒ–è¿›è¡ŒåŒæ­¥é”å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ASingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (as == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (ASingleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (as == <span class="keyword">null</span>) &#123;           <span class="comment">//tag1</span></span><br><span class="line">as = <span class="keyword">new</span> ASingleton();  <span class="comment">//tag2</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> as;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å­ï¼Œå½“åˆ¤æ–­asä¸ºnullæ—¶ï¼Œæ‰ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒæ—¶ç”±äºåˆå§‹åŒ–è¿‡ç¨‹åŠ é”ï¼Œæ‰€ä»¥t1å’Œt2æ— æ³•åŒæ—¶è®¿é—®åˆå§‹åŒ–è¯­å¥tag2ï¼Œä¹Ÿä¿è¯äº†åªèƒ½åˆ›å»ºä¸€ä¸ªå•ä¾‹ã€‚</p><p>çœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œä½†æ˜¯ç”±äºjavaè¯­è¨€çš„ç‰¹æ€§ï¼Œåœ¨è¯¥æ®µä»£ç ç¼–è¯‘ä¸ºæ±‡ç¼–è¯­è¨€æ—¶ï¼Œä¸Šè¿°æ–¹æ³•ä¼šè¢«ç¼–è¯‘ä¸ºç±»ä¼¼ä¸‹é¢çš„è¿‡ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>åˆ¤æ–­asæ˜¯å¦ä¸ºnull</span><br><span class="line"><span class="number">2.</span>ä»¤as = ASingleton() <span class="comment">//æ³¨æ„æ­¤æ—¶åªæ˜¯ä¸ºasåˆ†é…äº†å†…å­˜ï¼Œå¹¶æœªæ‰§è¡ŒASingletonçš„æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="number">3.</span>å¼€å§‹æ‰§è¡ŒASingletonæ„é€ æ–¹æ³•ï¼Œasæœ‰äº†åˆå§‹åŒ–çš„å€¼</span><br><span class="line"><span class="number">4.</span>è¿”å›as</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå½“t1æ‰§è¡Œåˆ°è¯­å¥2ï¼Œè€Œt2å¼€å§‹æ‰§è¡Œè¯­å¥1æ—¶ï¼Œæ­¤æ—¶ç”±äºaså·²ç»åˆ†é…äº†å†…å­˜ä¸ä¸ºnullï¼Œæ‰€ä»¥t2ç›´æ¥æ‰§è¡Œè¯­å¥4ï¼Œæ­¤æ—¶t2è·å–åˆ°çš„æ˜¯ä¸€ä¸ªæ²¡æœ‰æ‰§è¡Œæ„é€ æ–¹æ³•çš„ASingletonå¯¹è±¡ï¼Œæ˜¾ç„¶è¿™æ ·ååˆ†å±é™©ã€‚åœ¨çº¿ç¨‹å¤æ‚çš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜ã€‚</p><p>ä¸‹é¢æä¾›äº†ä¸¤ä¸ªç»“å±€æ€è·¯ï¼Œä¸ºç®€ä¾¿èµ·è§ï¼Œå°†å…¶ç®€å•åˆ†ä¸ºâ€œé¥¿æ±‰æ¨¡å¼â€å’Œâ€œæ‡’æ±‰æ¨¡å¼â€ï¼ˆå…¶å®ä¸Šè¿°æ–¹æ³•ä¹Ÿå¯åˆ†ä¸ºè¿™ä¸¤ä¸ªæ¨¡å¼ï¼Œbutï¼Œwho caresâ€¦ï¼‰ã€‚</p><h1 id="4-é¥¿æ±‰æ¨¡å¼å®ç°å•ä¾‹"><a href="#4-é¥¿æ±‰æ¨¡å¼å®ç°å•ä¾‹" class="headerlink" title="4.é¥¿æ±‰æ¨¡å¼å®ç°å•ä¾‹"></a>4.é¥¿æ±‰æ¨¡å¼å®ç°å•ä¾‹</h1><p>é¥¿æ±‰æ¨¡å¼ï¼Œå³åœ¨å£°æ˜çš„æ—¶å€™å°±å°†å¯¹è±¡åˆå§‹åŒ–ã€‚</p><p>è¿™æ ·å®ç°å•ä¾‹çš„åŸç†æ˜¯ç±»çš„é™æ€å˜é‡å…¨å±€å”¯ä¸€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ASingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ASingleton as = <span class="keyword">new</span> ASingleton();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ASinleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.print(<span class="string">"ASingleton init!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ASingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> as;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·ä»ç„¶æœ‰ä¸ªé—®é¢˜ï¼Œå¯èƒ½åœ¨ç”¨åˆ°ASingletonç±»çš„æ—¶å€™ï¼Œå¹¶ä¸éœ€è¦ç«‹å³è·å–åˆ°å…¶å•ä¾‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¥¿æ±‰æ¨¡å¼ä»ç„¶æœ‰æµªè´¹èµ„æºçš„å«Œç–‘ã€‚</p><h1 id="5-æ‡’æ±‰æ¨¡å¼å®ç°å•ä¾‹"><a href="#5-æ‡’æ±‰æ¨¡å¼å®ç°å•ä¾‹" class="headerlink" title="5.æ‡’æ±‰æ¨¡å¼å®ç°å•ä¾‹"></a>5.æ‡’æ±‰æ¨¡å¼å®ç°å•ä¾‹</h1><p>æ‡’æ±‰æ¨¡å¼ï¼Œåªæœ‰è¦ç”¨åˆ°è¯¥å®ä¾‹æ—¶ï¼Œæ‰è·å–è¯¥å•ä¾‹ã€‚</p><p>è¿™æ¬¡æˆ‘ä»¬ç”¨åˆ°çš„æ—¶é™æ€å†…éƒ¨ç±»ï¼Œé™æ€å†…éƒ¨ç±»ä¸ç±»çš„é™æ€å˜é‡ä¸åŒï¼Œåªæœ‰æ˜ç¡®è°ƒç”¨é™æ€å†…éƒ¨ç±»çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–é™æ€å†…éƒ¨ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ASingletonFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ASingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ASingleton as = <span class="keyword">new</span> ASingleton();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ASinleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.print(<span class="string">"ASingleton init!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ASingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> ASingleton.as;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å—¯ï¼Œè‡³æ­¤å·²ç»å®Œæˆäº†javaå®ç°å•ä¾‹çš„ç»å¤§éƒ¨åˆ†æ–¹æ³•ï¼Œä½†å…¶å®è¿˜æœ‰ä¸€å¼ æ›´åŠ ç®€æ´çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯ç”¨enmuå®ç°ã€‚</p><h1 id="6-enmuå®ç°å•ä¾‹"><a href="#6-enmuå®ç°å•ä¾‹" class="headerlink" title="6.enmuå®ç°å•ä¾‹"></a>6.enmuå®ç°å•ä¾‹</h1><p>ç”±äºæšä¸¾ç±»å‹çš„å¯¹è±¡æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æ˜¯å®ç°å•ä¾‹çš„è¾ƒä¼˜é€‰æ‹©ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> SingletonEnum&#123;</span><br><span class="line">INSTANCE;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosth</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œandroidå¼€å‘è€…è¦æ³¨æ„ï¼Œæšä¸¾å ç”¨çš„å†…å­˜æ˜¯æ™®é€šå•ä¾‹çš„ä¸¤å€å¤šï¼Œæ‰€ä»¥ï¼Œå¹¶ä¸æ¨èåœ¨androidä¸­ä½¿ç”¨ã€‚</p><p>å…³äºæšä¸¾çš„æ›´è¯¦ç»†èµ„æ–™ï¼Œå‚é˜…(æ·±å…¥ç†è§£Javaæšä¸¾ç±»å‹(enum))[<a href="http://blog.csdn.net/javazejian/article/details/71333103#t7]" target="_blank" rel="noopener">http://blog.csdn.net/javazejian/article/details/71333103#t7]</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kotlinå­¦ä¹ ç¬”è®°2</title>
      <link href="/blog/posts/8a52763a/"/>
      <url>/blog/posts/8a52763a/</url>
      
        <content type="html"><![CDATA[<h1 id="å°¾é€’å½’ä¼˜åŒ–"><a href="#å°¾é€’å½’ä¼˜åŒ–" class="headerlink" title="å°¾é€’å½’ä¼˜åŒ–"></a>å°¾é€’å½’ä¼˜åŒ–</h1><p>æŠŠé€’å½’é€šè¿‡ç¼–è¯‘å™¨è½¬åŒ–ä¸ºè¿­ä»£ï¼Œä»è€Œé¿å…Stack Overflow</p><p>â€œä»¥æ—¶é—´æ¢å–ç©ºé—´â€</p><p>æ™®é€šé€’å½’ï¼š</p><p>è°ƒç”¨å‡½æ•°ä¹‹åï¼Œè¿˜éœ€è¦ä½¿ç”¨å…¶è¿”å›å€¼ä¾›è‡ªå·±ä½¿ç”¨ï¼Œå³è‡ªèº«è¿”å›å€¼ä¾èµ–äºä¸‹ä¸€çº§å‡½æ•°ï¼Œä¸€èˆ¬æ˜¯è°ƒç”¨è‡ªèº«çš„ä»£ç åé¢ï¼Œè¿˜æœ‰å…¶ä»–çš„ä»£ç è¦æ‰§è¡Œã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">(n: <span class="type">Int</span>)</span></span>: BigInteger &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> BigInteger.valueOf(<span class="number">1L</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n.toBigInteger().times(fun1(n - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°¾é€’å½’ï¼š</p><p>è°ƒç”¨è‡ªèº«ä¹‹åï¼Œæ— éœ€å†è¿”å›å½“å‰å‡½æ•°,å°†å¤„ç†ç»“æœä»¥å…¶ä»–å½¢å¼è¿”å›ã€‚</p><p>æ™®é€šé€’å½’å’Œå°¾é€’å½’éƒ½å­˜åœ¨æ ˆæº¢å‡ºé£é™©ï¼ˆæœªä¼˜åŒ–å‰ï¼Œä¾‹å­ä¸­çš„å‡½æ•°è®¡ç®—10000åˆ°100000çš„é˜¶ä¹˜æ—¶ä¼šæº¢å‡ºï¼‰ï¼Œkotlinæä¾›äº†ä¸€ç§å°¾é€’å½’ä¼˜åŒ–çš„æ–¹æ³•â€”â€”<code>tailrec</code>ï¼Œä½¿å¾—ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶å°†é€’å½’è½¬åŒ–ä¸ºè¿­ä»£ï¼Œä»è€Œé¿å…æ ˆæº¢å‡ºã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span></span>(<span class="keyword">var</span> value: BigInteger = BigInteger.valueOf(<span class="number">1L</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°¾é€’å½’ï¼Œtailrecä¸ºkotlinä¸­ä¼˜åŒ–å…³é”®å­—</span></span><br><span class="line"><span class="keyword">tailrec</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun2</span><span class="params">(n: <span class="type">Int</span>, m: <span class="type">Result</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        m.value = m.value.times(BigInteger.valueOf(<span class="number">1L</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        m.value = m.value.times(n.toBigInteger())</span><br><span class="line">        fun2(n-<span class="number">1</span>,m)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬ä¾‹ä¸­ä¼ å…¥<code>fun2()</code>çš„<code>Result</code>å®ä¾‹ä¿å­˜äº†è®¡ç®—ç»“æœ</p><h1 id="sealed-class-å¯†å°ç±»"><a href="#sealed-class-å¯†å°ç±»" class="headerlink" title="sealed class å¯†å°ç±»"></a>sealed class å¯†å°ç±»</h1><p>å¯†å°ç±»çš„æ‰€æœ‰å­ç±»å¿…é¡»åœ¨ä¸€ä¸ªæ–‡ä»¶(xx.kt)ä¸­ï¼Œä»–çš„å­ç±»æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥å½“<code>when()</code>çš„æ—¶å€™ä¸éœ€è¦<code>else</code>ã€‚</p><p>æŸç§æ„ä¹‰ä¸Šä»–ä»¬åƒæ˜¯ä¸€ç§<code>enum class</code>ï¼Œåªä¸è¿‡ä»–çš„å­ç±»å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ã€‚</p><blockquote><p>Sealed classes are used for representing restricted class hierarchies, when a value can have one of the types from a limited set, but cannot have any other type. They are, in a sense, an extension of enum classes: the set of values for an enum type is also restricted, but each enum constant exists only as a single instance, whereas a subclass of a sealed class can have multiple instances which can contain state.</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sealed class</span></span><br><span class="line"><span class="keyword">sealed</span> <span class="class"><span class="keyword">class</span> <span class="title">Player</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Play</span></span>(<span class="keyword">var</span> arg:String) : Player()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">object</span> Stop : Player()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">p2</span></span>():Player()</span><br></pre></td></tr></table></figure><h1 id="kotlinæŠ›å‡ºå¼‚å¸¸"><a href="#kotlinæŠ›å‡ºå¼‚å¸¸" class="headerlink" title="kotlinæŠ›å‡ºå¼‚å¸¸"></a>kotlinæŠ›å‡ºå¼‚å¸¸</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Throws(RemoteException::class)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getBookList</span><span class="params">()</span></span>:List&lt;Book&gt;</span><br></pre></td></tr></table></figure><h1 id="kotlinä¸­çš„æ³›å‹"><a href="#kotlinä¸­çš„æ³›å‹" class="headerlink" title="kotlinä¸­çš„æ³›å‹"></a>kotlinä¸­çš„æ³›å‹</h1><p><code>out</code> åå˜ï¼Œä½¿ç”¨å­ç±»æ³›å‹çš„å¯¹è±¡å¯ä»¥èµ‹å€¼ç»™ä½¿ç”¨çˆ¶ç±»æ³›å‹çš„å¯¹è±¡ï¼Œç›¸å½“äº<code>extend</code>ï¼Œç”¨äºæ–¹æ³•çš„è¿”å›å€¼ï¼ˆç”Ÿäº§è€…ï¼‰æ—¶ä½¿ç”¨</p><p><code>in</code> é€†å˜ï¼Œä½¿ç”¨çˆ¶ç±»æ³›å‹çš„å¯¹è±¡å¯ä»¥èµ‹å€¼ç»™ä½¿ç”¨å­ç±»æ³›å‹çš„å¯¹è±¡ï¼Œç›¸å½“äº<code>super</code>ï¼Œç”¨äºæ–¹æ³•çš„å‚æ•°ï¼ˆæ¶ˆè´¹è€…ï¼‰æ—¶ä½¿ç”¨</p><p>ä¸å˜ï¼Œå½“æ³›å‹å³å½“æ¶ˆè´¹è€…ï¼Œåˆå½“ç”Ÿäº§è€…æ—¶ï¼Œä¸ç”¨<code>in</code>æˆ–è€…<code>out</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> from = arrayOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">val</span> to = arrayOf(Any())</span><br><span class="line"></span><br><span class="line">    copyArray(from,to)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">copyArray</span><span class="params">(from: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">Any</span>&gt;, to: <span class="type">Array</span>&lt;<span class="type">in</span> <span class="type">Int</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„fromè¢«outä¿®é¥°ï¼Œåªèƒ½ä½œä¸ºç”Ÿäº§è€…è°ƒç”¨getä¹‹ç±»çš„æ–¹æ³•ï¼Œä¸èƒ½ä½œä¸ºæ¶ˆè´¹è€…è°ƒç”¨setä¹‹ç±»çš„æ–¹æ³•</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ˜Ÿå·æŠ•å°„"><a href="#æ˜Ÿå·æŠ•å°„" class="headerlink" title="æ˜Ÿå·æŠ•å°„"></a>æ˜Ÿå·æŠ•å°„</h1><blockquote><p>ä½ å¯¹ç±»å‹å‚æ•°ä¸€æ— æ‰€çŸ¥ï¼Œä½†ä»ç„¶å¸Œæœ›ä»¥å®‰å…¨çš„æ–¹å¼ä½¿ç”¨å®ƒã€‚</p></blockquote><p><strong>å®‰å…¨çš„ä½¿ç”¨</strong>ï¼Œåˆ™è¡¨ç¤ºè¯¥ç±»<code>Group&lt;T&gt;</code>æ»¡è¶³</p><blockquote><p>1.å­ç±»è‡³å°‘æ¥æ”¶å’Œçˆ¶ç±»ä¸€æ ·èŒƒå›´çš„å‚æ•° &gt;=  â€”&gt; çˆ¶ç±»å…¥å‚ä¸ºNoting ä¸èƒ½å®‰å…¨å†™å…¥</p><p>2.å­ç±»æœ€å¤šè¿”å›å’Œçˆ¶ç±»ä¸€æ ·èŒƒå›´çš„å‚æ•° &lt;=  â€”&gt; çˆ¶ç±»å‡ºå‚ä¸ºAny? å¯ä»¥å®‰å…¨è¯»å–</p></blockquote><p>åˆ™æœ‰ä»¥ä¸‹ä¸‰ç§å®ç°æ–¹å¼</p><p><img src="https://jixiaoyong.github.io/images/20191022194750.png" alt="in-out-star-projection-approaches"></p><p>å…¶ä¸­ï¼š</p><p><code>Group&lt;in Noting&gt;</code> çš„<code>fetch()</code>æ–¹æ³•ä¸€ç›´è¿”å›<code>Any?</code></p><p><code>Group&lt;out Any?&gt;</code> çš„<code>T</code>éœ€è¦ä¸å®é™…çš„<code>Group</code>çš„<code>T</code>ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™</p><p><code>Group&lt;*&gt;</code> æ—¢èƒ½<code>insert</code>æ­£ç¡®è¿”å›å¯¹åº”çš„ç±»å‹ï¼Œä¹Ÿä¸ç”¨å®æ—¶ä¿®æ”¹</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> TClass &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">readIn</span><span class="params">(group: <span class="type">Group</span>&lt;<span class="type">in</span> <span class="type">Nothing</span>&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> d = group.fetch()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">readOut</span><span class="params">(group: <span class="type">Group</span>&lt;<span class="type">out</span> <span class="type">Animal</span>&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> d = group.fetch()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">read</span><span class="params">(group: <span class="type">Group</span>&lt;*&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> d = group.fetch()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Group</span>&lt;<span class="type">T : Dog</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(member: <span class="type">T</span>)</span></span>: <span class="built_in">Unit</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fetch</span><span class="params">()</span></span>: T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å§”æ‰˜"><a href="#å§”æ‰˜" class="headerlink" title="å§”æ‰˜"></a>å§”æ‰˜</h1><p>å§”æ‰˜æ˜¯å°†é‡å¤å‡ºç°çš„ä»£ç æ”¾åˆ°ä¸€ä¸ªåœ°æ–¹ã€‚</p><p><img src="https://jixiaoyong.github.io/images/20191023194526.png" alt="å§”æ‰˜ç¤ºæ„å›¾"></p><ul><li>ç±»å§”æ‰˜ ï¼š</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interface</span> </span>&#123;<span class="function"><span class="keyword">fun</span> <span class="title">a</span><span class="params">()</span></span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> : <span class="type">Interface</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>(a: Interface) : Interface <span class="keyword">by</span> a</span><br></pre></td></tr></table></figure><p>è¿™æ ·Bä¾¿å¯ä»¥å°†<code>Interface</code>ä¸­æ–¹æ³•çš„å®ç°å§”æ‰˜ç»™ç±»<code>A</code>çš„å¯¹è±¡<code>a</code></p><ul><li>å§”æ‰˜å±æ€§ï¼š</li></ul><p>å°†åŒä¸€ç±»å‹çš„å±æ€§çš„<code>get</code>ã€<code>set</code>æ–¹æ³•æ”¾åˆ°ä¸€ä¸ªåœ°æ–¹å®ç°ï¼Œå¯ä»¥åœ¨åŠ å…¥<code>å…¶å®ƒæ“ä½œ</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Delegate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: String = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(clazz: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: String &#123;</span><br><span class="line">        println(<span class="string">"get()"</span>)<span class="comment">//å…¶å®ƒæ“ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(clazz: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;, t: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">" set()"</span>)</span><br><span class="line">        name = t</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: String <span class="keyword">by</span> Delegate()</span><br><span class="line">    <span class="keyword">var</span> age: String <span class="keyword">by</span> Delegate()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å§”æ‰˜ç±»çš„åˆå§‹åŒ–å‡½æ•°ï¼š</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">delegate</span><span class="params">(initializer: () -&gt; <span class="type">T</span>)</span></span> = Delegate(initializer)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: String <span class="keyword">by</span> delegate &#123;</span><br><span class="line">        println(<span class="string">"MyClass1.name init"</span>)</span><br><span class="line">        <span class="string">"MyClass1"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Delegate</span>&lt;<span class="type">T</span>&gt;</span>(initializer: () -&gt; T) &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(myClass1: <span class="type">T</span>, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: String &#123;</span><br><span class="line">        println(<span class="string">"<span class="variable">$className</span> get()"</span>)</span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(myClass1: <span class="type">T</span>, property: <span class="type">KProperty</span>&lt;*&gt;, t: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">"<span class="variable">$className</span> set()"</span>)</span><br><span class="line">        name = t</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> name: String = <span class="string">""</span></span><br><span class="line">    <span class="keyword">var</span> className = initializer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Mapå§”æ‰˜ï¼š</li></ul><p>å°†ç±»çš„<code>å±æ€§</code>åç§°å’Œ<code>map</code>ä¸­çš„<code>key</code>ä¸€ä¸€å¯¹åº”ï¼Œä»è€Œå°†å¯¹äº<code>value</code>èµ‹å€¼ç»™<code>å±æ€§</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassB</span></span>(map: Map&lt;String, Any&gt;) &#123;</span><br><span class="line">    <span class="keyword">val</span> name: String <span class="keyword">by</span> map</span><br><span class="line">    <span class="keyword">val</span> age: <span class="built_in">Int</span> <span class="keyword">by</span> map</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> map = mapOf(<span class="string">"name"</span> to <span class="string">"shany"</span>,</span><br><span class="line">            <span class="string">"age"</span> to <span class="number">18</span>)</span><br><span class="line">    <span class="keyword">val</span> b = ClassB(map)</span><br><span class="line">    print(b.name)<span class="comment">//shayn</span></span><br><span class="line">    print(b.age)<span class="comment">//18</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>veroable</li></ul><p>å¯ä»¥æ‹¦æˆªèµ‹å€¼æ“ä½œ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassB</span></span>() &#123;</span><br><span class="line">   <span class="keyword">var</span> name:String <span class="keyword">by</span> Delegates.vetoable(<span class="string">"ThisIsInitialValue"</span>)&#123;</span><br><span class="line">       property, oldValue, newValue -&gt;</span><br><span class="line">       <span class="keyword">return</span><span class="symbol">@vetoable</span> <span class="literal">false</span> <span class="comment">//è¿”å›trueå…è®¸æ›´æ”¹å€¼ï¼Œfalseä¸å…è®¸æ›´æ”¹</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¸­ç¼€å‡½æ•°"><a href="#ä¸­ç¼€å‡½æ•°" class="headerlink" title="ä¸­ç¼€å‡½æ•°"></a>ä¸­ç¼€å‡½æ•°</h1><p>éœ€è¦æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š</p><ol><li>æˆå‘˜å‡½æ•°æˆ–æ‹“å±•å‡½æ•°</li><li>åªæœ‰ä¸€ä¸ªå‚æ•°</li><li>infixå£°æ˜</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> String.<span class="title">div</span><span class="params">(string: <span class="type">String</span>)</span></span>:String&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.replace(string,<span class="string">""</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ï¼š</span><br><span class="line"><span class="keyword">val</span> s = <span class="string">"bababbaab"</span> div <span class="string">"a"</span></span><br></pre></td></tr></table></figure><h1 id="inlineå†…è”å‡½æ•°"><a href="#inlineå†…è”å‡½æ•°" class="headerlink" title="inlineå†…è”å‡½æ•°"></a>inlineå†…è”å‡½æ•°</h1><p><code>inline</code>ä¿®é¥°çš„å‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶å°†å­—èŠ‚ç åŠ¨æ€æ’å…¥åˆ°è¢«åˆ°è°ƒç”¨çš„åœ°æ–¹ã€‚</p><p><code>inline</code>ä¿®é¥°çš„å‡½æ•°çš„<code>lambdaå‚æ•°</code>å¦‚æœè¿è¡Œåœ¨è¯¥å‡½æ•°å†…éƒ¨çš„<em><code>å­å‡½æ•°/å…¶ä»–ç¯å¢ƒ</code></em>ï¼Œåˆ™ä¸å…è®¸è¿™ä¸ªlambdaå‡½æ•°<strong>éå±€éƒ¨è¿”å›</strong>ï¼ˆå› ä¸ºæ²¡æœ‰åŠæ³•ä»è¯¥ <code>å­å‡½æ•°/å…¶ä»–ç¯å¢ƒ</code> ä¸­ç›´æ¥é€€å‡ºlambdaæ‰€åœ¨çš„å¤–å±‚å‡½æ•°ï¼‰ï¼Œå¯¹äºè¿™ç§lambdaå‡½æ•°éœ€è¦æ·»åŠ <strong><code>crossinline</code></strong>ä¿®é¥°ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//**éå±€éƒ¨è¿”å›**æŒ‡ä»lambda2ä¸­æ‰§è¡Œreturnè¯­å¥ï¼Œæ¨å‡ºçš„æ˜¯æ•´ä¸ªfunc()</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">func1</span><span class="params">(<span class="keyword">crossinline</span> lambda1:()-&gt;<span class="type">Unit</span>,  lambda2:()-&gt;<span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">val</span> f = Runnable &#123;</span><br><span class="line">        lambda1()<span class="comment">//ä¸å¯ä»¥è°ƒç”¨éå±€éƒ¨è¿”å›ï¼Œæ‰€ä»¥ç”¨crossinlineä¿®é¥°</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    lambda2()<span class="comment">//å¯ä»¥è°ƒç”¨éå±€éƒ¨è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlinä¹Ÿå­˜åœ¨Javaæ³›å‹æ‰€å…·æœ‰çš„<strong>ç±»å‹æ“¦é™¤</strong>é—®é¢˜ï¼Œä¸ºäº†ä¼˜åŒ–è¯¥é—®é¢˜ï¼Œinlineå‡½æ•°å¯ä»¥ç»“åˆ<code>reified</code>å®ç°<strong>å®ä½“åŒ–ç±»å‹å‚æ•°</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">isInstanceOf</span><span class="params">(value: <span class="type">Any</span>)</span></span> = value <span class="keyword">is</span> T <span class="comment">//åœ¨è¿™é‡Œä»ç„¶å¯ä»¥çŸ¥é“Tæ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Œæ‰€ä»¥å¯ä»¥æ‰§è¡Œvalue is T </span></span><br><span class="line">print(isInstanceOf&lt;String&gt;(<span class="string">""</span>))<span class="comment">//true</span></span><br></pre></td></tr></table></figure><p><strong>åŸç†:</strong>å†…è”å‡½æ•°ä¼šç›´æ¥è¢«æ’å…¥åˆ°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼Œè€Œ<code>reified</code>ä¿®é¥°çš„ç±»å‹å‚æ•°ä¼šä¿è¯å°†ç”¨æˆ·è°ƒç”¨æ—¶å†™çš„ç±»å‹<code>String</code>åŒæ—¶ä¹Ÿå†™å…¥åˆ°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼Œå¦‚æ­¤ä¾¿æ²¡æœ‰å‘ç”Ÿç±»å‹æ“¦é™¤ã€‚</p><h1 id="coroutines-åç¨‹"><a href="#coroutines-åç¨‹" class="headerlink" title="coroutines åç¨‹"></a>coroutines åç¨‹</h1><p>åç¨‹å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªè½»é‡çº§çš„threadï¼Œä»–è¿è¡Œåœ¨çº¿ç¨‹å½“ä¸­ï¼Œç”±ç”¨æˆ·æ§åˆ¶ï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚</p><p>åœ¨Androidä¸­ä½¿ç”¨åç¨‹ï¼Œç‰¹åˆ«æ˜¯åœ¨IOæ“ä½œåŠç½‘ç»œè¯·æ±‚ç­‰éœ€è¦æ ¹æ®è€—æ—¶æ“ä½œæ›´æ–°ç•Œé¢çš„éœ€æ±‚æ—¶ï¼Œå¯ä»¥å°†IOæ“ä½œå’Œç•Œé¢æ“ä½œä¸²è¡Œï¼Œé¿å…åˆ‡æ¢çº¿ç¨‹ã€å›è°ƒåµŒå¥—ç­‰å¯¼è‡´ä»£ç å¯è¯»æ€§æŸ¥çš„é—®é¢˜ã€‚</p><p>å¦‚é…åˆæ”¯æŒåç¨‹çš„retrofitï¼Œæˆ‘ä»¬å¯ä»¥å°†ç½‘ç»œè¯·æ±‚ç®€åŒ–å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">launch(Dispatchers.Main) &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œæ˜¯ä¸»çº¿ç¨‹</span></span><br><span class="line">    showProgressOnMainThread()</span><br><span class="line">    <span class="keyword">val</span> repos = withContext(Dispatchers.IO) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œæ˜¯UIçº¿ç¨‹</span></span><br><span class="line">        retrofitApi.getRepos(<span class="string">"jixiaoyong"</span>).string()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™é‡Œæ˜¯ä¸»çº¿ç¨‹</span></span><br><span class="line">    updateUIOnMainThread(repos)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>kotlinåç¨‹éœ€è¦å•ç‹¬æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.3.2'</span></span><br><span class="line">implementation <span class="string">"org.jetbrains.kotlinx:kotlinx-coroutines-android:1.3.2"</span> <span class="comment">//Androidå¯ä»¥å†æ·»åŠ è¿™ä¸ªä¾èµ–ï¼Œä¼šæœ‰ä¸€äº›ç‰¹æ®Šæ–¹æ³•</span></span><br></pre></td></tr></table></figure><p> ä¸€ä¸ªçˆ¶åç¨‹æ€»æ˜¯ç­‰å¾…æ‰€æœ‰çš„å­åç¨‹æ‰§è¡Œç»“æŸï¼Œ çˆ¶åç¨‹è¢«å–æ¶ˆçš„æ—¶å€™ï¼Œæ‰€æœ‰å®ƒçš„å­åç¨‹ä¹Ÿä¼šè¢«é€’å½’çš„å–æ¶ˆã€‚ </p><h2 id="åç¨‹ä¸­runBlockingä¸coroutineScopeçš„åŒºåˆ«"><a href="#åç¨‹ä¸­runBlockingä¸coroutineScopeçš„åŒºåˆ«" class="headerlink" title="åç¨‹ä¸­runBlockingä¸coroutineScopeçš„åŒºåˆ«"></a>åç¨‹ä¸­<code>runBlocking</code>ä¸<code>coroutineScope</code>çš„åŒºåˆ«</h2><p>ç›¸åŒç‚¹ï¼š</p><p>ä¾æ¬¡æ‰§è¡Œå†…éƒ¨ä»£ç ï¼Œå¦‚æœ<code>ä»£ç 1</code>æ˜¯å¯åŠ¨åç¨‹ï¼Œé‚£ä¹ˆå¯åŠ¨è¯¥å­åç¨‹åï¼Œç»§ç»­æ‰§è¡Œ<code>ä»£ç 1</code>åé¢çš„ä»£ç ç›´åˆ°æœ€åä¸€è¡Œï¼ˆç±»ä¼¼å¯åŠ¨æ–°çº¿ç¨‹ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼‰ï¼Œç„¶åå†ç­‰å¾…æ‰€æœ‰å†…éƒ¨åç¨‹ç»“æŸï¼Œæ‰ä¼šé€€å‡ºã€‚</p><p>ä¸åŒç‚¹ï¼š</p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html" target="_blank" rel="noopener"><strong><code>runBlocking</code></strong></a>ï¼šä¼šè¿è¡Œä¸€ä¸ªæ–°çš„åç¨‹çº¿ç¨‹ï¼Œå¹¶é˜»å¡å…¶æ‰€åœ¨<code>çº¿ç¨‹</code>,ç›´åˆ°å…¶å†…éƒ¨æ‰€æœ‰åç¨‹/å­åç¨‹æ‰§è¡Œå®Œæ¯•æ‰ä¼šé€€å‡ºã€‚è®¾è®¡ç”¨æ¥ä»¥é˜»å¡çš„æ–¹å¼æ‰§è¡Œåç¨‹ä»£ç ï¼Œä¸åº”è¯¥åœ¨åç¨‹ä¸­ä½¿ç”¨ã€‚</p><p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html" target="_blank" rel="noopener"><strong><code>coroutineScope</code></strong></a>ï¼šä¸ä¼šé˜»å¡å…¶æ‰€åœ¨çº¿ç¨‹ï¼Œè¦åœ¨åç¨‹ä¸­ä½¿ç”¨ï¼Œå½“å…¶å†…éƒ¨æ‰€æœ‰åç¨‹/å­åç¨‹æ‰§è¡Œå®Œæ¯•æ‰ä¼šé€€å‡ºã€‚è®¾è®¡ç”¨æ¥æ‰§è¡Œå¹¶è¡Œæ“ä½œï¼Œä¸€æ—¦æœ‰å­åç¨‹å¤±è´¥ï¼Œåˆ™å…¶ä»–å­åç¨‹éƒ½ä¼šè¢«å–æ¶ˆï¼Œæ•´ä¸ªä»£ç å—æ‰§è¡Œå¤±è´¥ã€‚</p><h2 id="åç¨‹çš„æ€ç»´å¯¼å›¾"><a href="#åç¨‹çš„æ€ç»´å¯¼å›¾" class="headerlink" title="åç¨‹çš„æ€ç»´å¯¼å›¾"></a>åç¨‹çš„æ€ç»´å¯¼å›¾</h2><iframe width="853" height="480" src="https://embed.coggle.it/diagram/Xb_CZoumpCamgUAj/1235701ea5f157867e045f0f5ac28f886effdb5fa1e27b72afa5266e6e3e8891" frameborder="0" allowfullscreen></iframe><p>éœ€è¦è¯´æ˜çš„æ˜¯</p><p><code>Dispatchers.Unconfined</code> éå—é™ï¼Œä¸ä¼šé™å®šåç¨‹è¿è¡Œçš„çº¿ç¨‹ï¼Œè€Œæ˜¯éšç¯å¢ƒåˆ‡æ¢</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">launch(Dispatchers.Unconfined) &#123;</span><br><span class="line">    <span class="comment">// main thread</span></span><br><span class="line">    withContext(newSingleThreadContext(<span class="string">"hello"</span>))&#123;</span><br><span class="line">        <span class="comment">//hello thread</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//hello thread</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åç¨‹å±€éƒ¨å˜é‡"><a href="#åç¨‹å±€éƒ¨å˜é‡" class="headerlink" title="åç¨‹å±€éƒ¨å˜é‡"></a>åç¨‹å±€éƒ¨å˜é‡</h2><p>é€šè¿‡<code>ThreadLocal</code>ã€<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-thread-context-element/index.html" target="_blank" rel="noopener"><code>ThreadContextElement</code></a>ï¼Œé…åˆ<code>asContextElement(&quot;value&quot;)</code>æ–¹æ³•å®ç°ã€‚å’Œåç¨‹æ‰€åœ¨çš„çº¿ç¨‹æ²¡æœ‰å…³ç³»ã€‚</p><p>ç›´æ¥ä¿®æ”¹<code>ThreadLocal</code>çš„å€¼ï¼Œä¼šåœ¨åˆ‡æ¢åç¨‹çš„æ—¶å€™å¤±æ•ˆï¼ˆä¼šè¢«æ”¹ä¸ºåˆ‡æ¢åˆ°çš„åç¨‹æ‰€ä½¿ç”¨çš„çš„å€¼ï¼‰ï¼Œå½“å†æ¬¡åˆ‡å›æœ¬åç¨‹æ—¶ï¼Œè¢«é‡ç½®ä¸ºä¸Šä¸€ä¸ªé€šè¿‡<code>asContextElement(&quot;value&quot;)</code>æ–¹æ³•æ›´æ–°çš„å€¼æˆ–è€…<code>null</code>ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šï¼‰ã€‚</p><blockquote><p> åŸç†ï¼š<strong>å¯åŠ¨å’Œæ¢å¤æ—¶ä¿å­˜<code>ThreadLocal</code>åœ¨å½“å‰çº¿ç¨‹çš„å€¼ï¼Œå¹¶ä¿®æ”¹ä¸º valueï¼ŒæŒ‚èµ·å’Œç»“æŸæ—¶ä¿®æ”¹å½“å‰çº¿ç¨‹<code>ThreadLocal</code>çš„å€¼ä¸ºä¹‹å‰ä¿å­˜çš„å€¼</strong> </p><p> â€”â€” <a href="https://johnnyshieh.me/posts/kotlin-coroutine-concurrency/" target="_blank" rel="noopener">Kotlin Coroutines(åç¨‹) å®Œå…¨è§£æï¼ˆäº”ï¼‰ï¼Œåç¨‹çš„å¹¶å‘</a></p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> threadLocal = ThreadLocal&lt;String?&gt;() <span class="comment">// å£°æ˜çº¿ç¨‹å±€éƒ¨å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    threadLocal.<span class="keyword">set</span>(<span class="string">"main"</span>)</span><br><span class="line">    printValue(<span class="number">1</span>) <span class="comment">// main</span></span><br><span class="line">    async (Dispatchers.Default + threadLocal.asContextElement(value = <span class="string">"launch"</span>)) &#123;</span><br><span class="line">        printValue(<span class="number">2</span>) <span class="comment">// launch</span></span><br><span class="line">        threadLocal.<span class="keyword">set</span>(<span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">//        threadLocal.asContextElement("hello") //å¦‚æœä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ›´æ–°ï¼Œåˆ™ printValue(4) ä¼šæ‰“å° hello</span></span><br><span class="line">        printValue(<span class="number">3</span>) <span class="comment">// hello</span></span><br><span class="line">        yield()</span><br><span class="line">        printValue(<span class="number">4</span>)<span class="comment">// launch</span></span><br><span class="line">    &#125;.await()</span><br><span class="line">    printValue(<span class="number">5</span>) <span class="comment">// main</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">printValue</span><span class="params">(number: <span class="type">Int</span>)</span></span>&#123;</span><br><span class="line">    println(<span class="string">"<span class="variable">$number</span>: <span class="subst">$&#123;Thread.currentThread()&#125;</span>, thread local value: '<span class="subst">$&#123;threadLocal.get()&#125;</span>'"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åœ¨Androidä¸­ä½¿ç”¨"><a href="#åœ¨Androidä¸­ä½¿ç”¨" class="headerlink" title="åœ¨Androidä¸­ä½¿ç”¨"></a>åœ¨Androidä¸­ä½¿ç”¨</h2><p>Kotlinå®˜æ–¹æ¨èä¸€ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. CoroutineScope</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activity</span> : <span class="type">CoroutineScope by CoroutineScope</span></span>(Dispatchers.Default) &#123;</span><br><span class="line">    <span class="comment">// ç»§ç»­è¿è¡Œâ€¦â€¦</span></span><br><span class="line">    </span><br><span class="line"><span class="number">2</span>. MainScope</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mainScope = MainScope()</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">destroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">    mainScope.cancel()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»§ç»­è¿è¡Œâ€¦â€¦</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://typealias.com/guides/star-projections-and-how-they-work/" target="_blank" rel="noopener">Star-Projections and How They Work</a></p><p><a href="https://blog.csdn.net/u013064109/article/details/83507076" target="_blank" rel="noopener">Kotlinçš„ç‹¬é—¨ç§˜ç±Reifiedå®åŒ–ç±»å‹å‚æ•°(ä¸‹ç¯‡)</a></p><p><a href="https://www.kotlincn.net/docs/reference/coroutines/coroutines-guide.html" target="_blank" rel="noopener">Kotlin åç¨‹å®˜ç½‘</a></p><p><a href="https://johnnyshieh.me/posts/kotlin-coroutine-concurrency/" target="_blank" rel="noopener">Kotlin Coroutines(åç¨‹) å®Œå…¨è§£æï¼ˆäº”ï¼‰ï¼Œåç¨‹çš„å¹¶å‘</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kotlinå­¦ä¹ ç¬”è®°1</title>
      <link href="/blog/posts/135b2780/"/>
      <url>/blog/posts/135b2780/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯æˆ‘åœ¨å­¦ä¹ Bennyhuoï¼ˆ <a href="https://github.com/enbandari/Kotlin-Tutorials" target="_blank" rel="noopener">github</a> ï¼‰çš„kotlinå…¥é—¨è§†é¢‘æ—¶çš„ä¸€äº›ç¬”è®°ï¼Œæ¯”è¾ƒååŸºç¡€ï¼Œç”¨äºæŸ¥ç¼ºè¡¥æ¼ã€‚</p><ul><li><p>xx.map() &amp; xx.flatMap()</p><p>xx.flatMap()ç”¨äºè¿”å›<strong>å¯è¿­ä»£</strong>çš„æ•°ç»„ï¼Œè€Œxx.map()åˆ™æ˜¯ä»»ä½•<strong>å¯è¿­ä»£</strong>æ•°æ®éƒ½æœ‰çš„ç”¨æ¥éå†çš„æ–¹æ³•ã€‚</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = arrayListOf&lt;String&gt;(<span class="string">"a c v de  fb s e  gf d"</span>)</span><br><span class="line">arr.flatMap &#123;</span><br><span class="line">    it.split(<span class="string">" "</span>)</span><br><span class="line">&#125;.map&#123; </span><br><span class="line">    print(<span class="string">"<span class="subst">$&#123;it.toUpperCase()&#125;</span>"</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>enum class æšä¸¾ç±»å‹</p><p>åˆ†ä¸ºæœ‰å‚å’Œæ— å‚ï¼Œæšä¸¾å˜é‡ä»¥<code>,</code>åˆ†éš”ï¼Œå¦‚æœenumè¿˜æœ‰æ–¹æ³•æˆ–è€…ä¼´ç”Ÿå¯¹è±¡ï¼Œåˆ™æœ€åä¸€ä¸ªå˜é‡åä¸º<code>;</code>ï¼Œå¦åˆ™å¯ä¸º<code>,</code>ã€<code>;</code>æˆ–è€…æ²¡æœ‰ã€‚</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">City</span></span>&#123;</span><br><span class="line">    UK,USA,EU;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä»¥ä¸‹ä¸ºéå¿…é¡»ä»£ç ï¼Œä»…è¡¨ç¤ºå¯ä»¥æœ‰è¿™äº›åŠŸèƒ½</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">say</span><span class="params">()</span></span>&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">(s:<span class="type">String</span>)</span></span>:City&#123;</span><br><span class="line">            <span class="keyword">return</span> valueOf(s.toUpperCase())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        æœ‰å‚çš„æƒ…å†µå¦‚ä¸‹</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Country</span></span>(<span class="keyword">val</span> aName:String)&#123;</span><br><span class="line">    CHINA(<span class="string">"ä¸­å›½"</span>),</span><br><span class="line">    JAPAN(<span class="string">"æ—¥æœ¬"</span>),</span><br><span class="line">    USA(<span class="string">"ç¾å›½"</span>),</span><br><span class="line">    UK(<span class="string">"è‹±å›½"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>â€‹        ä½¿ç”¨ï¼šé€šè¿‡enumçš„valueOf()æ–¹æ³•è·å–æšä¸¾å¯¹è±¡å®ä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var s = &quot;uk&quot;</span><br><span class="line">var city = City.valueOf(s.toUpperCase())</span><br><span class="line">//æˆ–è€…é€šè¿‡ä¼´ç”Ÿå¯¹è±¡ï¼š</span><br><span class="line">var city = City.fun1(s)</span><br></pre></td></tr></table></figure><ul><li><p>companion objectä¼´ç”Ÿå¯¹è±¡</p><p>åœ¨ç±»çš„å®šä¹‰ï¼Œå¯ä»¥ç›´æ¥ç”¨<code>ç±»å.æ–¹æ³•å()</code>è°ƒç”¨ï¼Œç›¸å½“äºjavaä¸­çš„é™æ€æ–¹æ³•</p><p>ä¸€ä¸ªç±»ä¸­åªèƒ½æœ‰ä¸€ä¸ªä¼´ç”Ÿå¯¹è±¡</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xxx</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">parse</span><span class="params">(x: <span class="type">String</span>)</span></span>: Country &#123;</span><br><span class="line">            <span class="keyword">return</span> valueOf(x.toUpperCase())</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>objectä¿®é¥°çš„ç±»</p><p>ç­‰åŒäºåªæœ‰ä¸€ä¸ªå®ä¾‹çš„ç±»ï¼Œç›¸å½“äºjavaä¸­çš„é™æ€ç±»ï¼Œæ‰€æœ‰æ–¹æ³•å¯ä»¥ç›´æ¥ç”¨ç±»åè°ƒç”¨</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ClassName&#123;</span><br><span class="line">    <span class="function"><span class="title">fun</span><span class="params">()</span></span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>fun ClassName.funName()ä¸ºç±»æ·»åŠ æ–°çš„æ–¹æ³•</p><p>å¯¹äºä¸èƒ½ç›´æ¥ä¿®æ”¹çš„ç±»ï¼Œæœ‰éœ€è¦å¯¹å…¶å¢åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª<code>ClassName.funName()</code>çš„æ–¹æ³•æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> Country.<span class="title">sayNum</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//thiså¼•ç”¨çš„æ˜¯countryå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> num = <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        CHINA -&gt; <span class="number">1</span></span><br><span class="line">        JAPAN -&gt; <span class="number">2</span></span><br><span class="line">        USA -&gt; <span class="number">3</span></span><br><span class="line">        UK -&gt; <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        åœ¨ä½¿ç”¨æ—¶å¯ä»¥é€šè¿‡<code>Country</code>çš„å¯¹è±¡è°ƒç”¨<code>syaNum()</code>æ–¹æ³•</p><ul><li><p>data class æ•°æ®ç±»</p><p>å¯ä»¥æœ‰æ–¹æ³•ï¼Œæ–¹ä¾¿å¤åˆ¶ã€‚</p><p>å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”å‚æ•°éƒ½éœ€è¦ç”¨var/valä¿®é¥°</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">dataClass</span></span>(<span class="keyword">var</span> name: String, <span class="keyword">val</span> age :<span class="built_in">Int</span>)</span><br></pre></td></tr></table></figure><ul><li>æ–‡ä»¶è¯»å–<ul><li>resourceç›®å½•ä¸‹çš„æ–‡ä»¶è¯»å–</li></ul></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> input = File(ClassLoader.getSystemResource(<span class="string">"input"</span>).path).readText()</span><br></pre></td></tr></table></figure><ul><li><p>ä¸RxJavaç»“åˆ</p><p>ç»Ÿè®¡æ–‡æœ¬ä¸­å­—æ¯ä¸ªæ•°ï¼ŒåŸºäºRxJava 1.2.1</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(input.toCharArray().asIterable())</span><br><span class="line">        .filter &#123; !it.isWhitespace() &#125;</span><br><span class="line">        .groupBy &#123; it &#125;</span><br><span class="line">        .map&#123;</span><br><span class="line">            o -&gt;o.count().subscribe&#123;</span><br><span class="line">                print(<span class="string">"<span class="subst">$&#123;o.key&#125;</span>-&gt; <span class="variable">$it</span>  ,"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lambdaè¡¨è¾¾å¼åœ¨kotlinä¸­çš„åº”ç”¨</title>
      <link href="/blog/posts/53875104/"/>
      <url>/blog/posts/53875104/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h1><p><strong>æ™®é€šå†™æ³•</strong>ï¼š</p><ol><li>å®šä¹‰ä¸€ä¸ªæ¥å£OnClickListener</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClickListener</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(view: <span class="type">View</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å®šä¹‰æ–¹æ³•SetOnClickListener</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setOnCLickListener</span><span class="params">(listener: <span class="type">ClickListener</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.listener = listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰çš„æ–¹æ³•å’ŒJavaä¸­å†™æ³•ç±»ä¼¼ï¼Œåœ¨ä½¿ç”¨è¯¥æ–¹æ³•æ—¶ä¹Ÿç±»ä¼¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> testInterface = TestInterface()</span><br><span class="line"></span><br><span class="line">testInterface.setOnCLickListener(<span class="keyword">object</span> : TestInterface.ClickListener&#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">            TODO(<span class="string">"not implemented"</span>) <span class="comment">//To change body of created functions use File | Settings | File Templates.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p><strong>lambdaå†™æ³•</strong>ï¼š</p><p>å®šä¹‰åªéœ€è¦ä¸€æ­¥ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨åˆå§‹åŒ–çš„æ—¶åˆå§‹åŒ–listener</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AClass</span></span>(<span class="keyword">var</span> listener : (uri:String) -&gt; <span class="built_in">Unit</span>)&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ–è€…ç›´æ¥å®šä¹‰è¿™ä¸ªå˜é‡</span></span><br><span class="line">listener:((uri : String)-&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨éœ€è¦ç”¨åˆ°æ–¹æ³•æ—¶ï¼Œlistenerçš„æ–¹æ³•ï¼Œæ¯”å¦‚onClickListener()&#123;&#125;</span></span><br><span class="line">listener.invoke(agrs)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨èµ·æ¥ä¹Ÿæ›´åŠ ç®€æ´ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t = TestInterface&#123; uri: String -&gt; print(uri) &#125;<span class="comment">//è·å–å¯¹è±¡çš„åŒæ—¶åˆå§‹åŒ–listener</span></span><br></pre></td></tr></table></figure><blockquote><p>æ–¹æ³•æœ€åä¸€ä¸ªå‚æ•°æ˜¯lambdaè¡¨è¾¾å¼æ—¶ï¼Œlambdaè¡¨è¾¾å¼çš„æ–¹æ³•<code>{}</code>å¯ä»¥æ”¾åˆ°<code>()</code>çš„åé¢ï¼Œå¦‚æœåªæœ‰è¿™ä¸€ä¸ªå‚æ•°æ—¶ï¼Œ<code>()</code>ä¹Ÿå¯ä»¥çœç•¥</p></blockquote><p>å½“æ–¹æ³•åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå¯ä»¥çœç•¥å‚æ•°ï¼Œè¿˜ç”¨<code>it</code>ä»£æ›¿ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testInterface.setNewOnClickListener &#123; print(it) &#125;</span><br></pre></td></tr></table></figure><p>ç”šè‡³æ›´åŠ ç®€æ´ï¼Œå¦‚æœè¦æ‰§è¡Œçš„æ–¹æ³•å’Œlistenerå®šä¹‰çš„æ–¹æ³•è¿”å›å€¼ç±»å‹ç›¸åŒï¼Œå¯ä»¥ç›´æ¥å¼•ç”¨è¯¥æ–¹æ³•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testInterface.setNewOnClickListener(::print)</span><br></pre></td></tr></table></figure><h1 id="lambda"><a href="#lambda" class="headerlink" title="lambda"></a>lambda</h1><p>lambdaåœ¨Java8ä¸­å¼•è¿›ï¼Œå¯ä»¥å¾ˆå¥½çš„æ›¿ä»£åŒ¿åå†…éƒ¨ç±»ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´ã€‚</p><p>lambdaè¡¨è¾¾å¼å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sum = &#123; x: <span class="built_in">Int</span>, y: <span class="built_in">Int</span> -&gt; x + y &#125;</span><br></pre></td></tr></table></figure><blockquote><p>lambda è¡¨è¾¾å¼æ€»æ˜¯è¢«å¤§æ‹¬å·æ‹¬ç€ï¼Œ å®Œæ•´è¯­æ³•å½¢å¼çš„å‚æ•°å£°æ˜æ”¾åœ¨å¤§æ‹¬å·å†…ï¼Œå¹¶æœ‰å¯é€‰çš„ç±»å‹æ ‡æ³¨ï¼Œ å‡½æ•°ä½“è·Ÿåœ¨ä¸€ä¸ª <code>-&gt;</code> ç¬¦å·ä¹‹åã€‚å¦‚æœæ¨æ–­å‡ºçš„è¯¥ lambda çš„è¿”å›ç±»å‹ä¸æ˜¯ <code>Unit</code>ï¼Œé‚£ä¹ˆè¯¥ lambda ä¸»ä½“ä¸­çš„æœ€åä¸€ä¸ªï¼ˆæˆ–å¯èƒ½æ˜¯å•ä¸ªï¼‰è¡¨è¾¾å¼ä¼šè§†ä¸ºè¿”å›å€¼ã€‚</p><p>kotlincn.net <a href="http://www.kotlincn.net/docs/reference/lambdas.html#é«˜é˜¶å‡½æ•°å’Œ-lambda-è¡¨è¾¾å¼" target="_blank" rel="noopener">é«˜é˜¶å‡½æ•°å’Œlambdaè¡¨è¾¾å¼</a></p></blockquote><p>ä½¿ç”¨lambdaçš„å½¢å¼å¦‚ä¸‹<code>() -&gt; {}</code>,<code>()</code>å†…æ˜¯å‚æ•°ï¼Œ<code>{}</code>æ˜¯å‡½æ•°å…·ä½“çš„è¡Œä¸ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java 8æ–¹å¼ï¼š</span></span><br><span class="line"><span class="keyword">new</span> Thread( () -&gt; System.out.println(<span class="string">"In Java8, Lambda expression rocks !!"</span>) ).start();</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æ¥è‡ªimportNew.com,<a href="http://www.importnew.com/16436.html" target="_blank" rel="noopener">Java8 lambdaè¡¨è¾¾å¼10ä¸ªç¤ºä¾‹</a></p><h1 id="å°çŸ¥è¯†ç‚¹"><a href="#å°çŸ¥è¯†ç‚¹" class="headerlink" title="å°çŸ¥è¯†ç‚¹"></a>å°çŸ¥è¯†ç‚¹</h1><ul><li>xx.map()</li></ul><p>å‡¡æ˜¯<strong>å¯è¿­ä»£</strong>çš„æ•°æ®éƒ½å¯ä»¥ä½¿ç”¨<code>map()</code>å‡½æ•°</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> args: Array&lt;String&gt; = arrayOf()</span><br><span class="line">args.map &#123;</span><br><span class="line">    print(it)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥æ›´ç®€æ´ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">args.map(::print)</span><br><span class="line"><span class="comment">//::printè¡¨ç¤ºå¼•ç”¨è¯¥æ–¹æ³•</span></span><br></pre></td></tr></table></figure><ul><li>xx.flatMap()</li></ul><p>è¿”å›<strong>å¯è¿­ä»£</strong>çš„æ•°ç»„ï¼Œå¯ä»¥å’Œ<code>xx.map()</code>ä¸€èµ·ä½¿ç”¨</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">args.flatMap &#123;</span><br><span class="line">    it.split(<span class="string">" "</span>) <span class="comment">//æŠŠå­—ç¬¦ä¸²æŒ‰ç…§" "åˆ‡å‰²</span></span><br><span class="line">&#125;.map&#123; </span><br><span class="line">    print(<span class="string">"<span class="subst">$&#123;it.toUpperCase()&#125;</span>"</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> lambda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidä¸­WebViewä½¿ç”¨çš„ä¸€äº›é—®é¢˜</title>
      <link href="/blog/posts/b35fe0f7/"/>
      <url>/blog/posts/b35fe0f7/</url>
      
        <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°ï¼šWebViewåœ¨fragmentä¸­ä¸æ˜¾ç¤º"><a href="#é—®é¢˜æè¿°ï¼šWebViewåœ¨fragmentä¸­ä¸æ˜¾ç¤º" class="headerlink" title="é—®é¢˜æè¿°ï¼šWebViewåœ¨fragmentä¸­ä¸æ˜¾ç¤º"></a>é—®é¢˜æè¿°ï¼šWebViewåœ¨fragmentä¸­ä¸æ˜¾ç¤º</h1><p>è§£å†³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//kotlin ä»£ç </span></span><br><span class="line">webView.webViewClient = <span class="keyword">object</span> : WebViewClient() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(view: <span class="type">WebView</span>?, url: <span class="type">String</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">                view!!.loadUrl(url)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ­¤ä»£ç åŒæ ·å¼ºåˆ¶åœ¨webviewä¸­æ‰“å¼€å¯¹åº”çš„ç½‘é¡µ</p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonè‡ªåŠ¨åˆ›å»ºå‘å¸ƒhexoæ–‡ç« å¹¶åŒæ­¥github</title>
      <link href="/blog/posts/d9a2e1ba/"/>
      <url>/blog/posts/d9a2e1ba/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote><p>ç¯å¢ƒ linux(deepin)</p><p>python 2.7</p></blockquote><p>è¿™æ˜¯ä¸€ä¸ªPythonè„šæœ¬ï¼Œç”¨äºå®ç°hexoæ–‡ç« åˆ›å»ºã€ç”Ÿæˆç½‘é¡µå¹¶é¢„è§ˆã€å‘å¸ƒåˆ°å¯¹åº”xxx.github.ioåšå®¢çš„å…¨è¿‡ç¨‹ã€‚</p><h1 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h1><h2 id="ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®è‡ªå·±çš„é¡¹ç›®æ›´æ–°main-pyçš„ä¸€ä¸‹å˜é‡ï¼š"><a href="#ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®è‡ªå·±çš„é¡¹ç›®æ›´æ–°main-pyçš„ä¸€ä¸‹å˜é‡ï¼š" class="headerlink" title="ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®è‡ªå·±çš„é¡¹ç›®æ›´æ–°main.pyçš„ä¸€ä¸‹å˜é‡ï¼š"></a>ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®è‡ªå·±çš„é¡¹ç›®æ›´æ–°main.pyçš„ä¸€ä¸‹å˜é‡ï¼š</h2><ul><li><p>hexo_url = â€˜your_path/hexo/blogâ€™</p><p>ã€å¿…éœ€ã€‘æœ¬åœ°hexoåšå®¢è·¯å¾„</p></li><li><p>hexo_public_dir = â€˜your_path/hexo/blog/publicâ€™</p><p>ã€å¿…éœ€ã€‘æœ¬åœ°hexoåšå®¢è¾“å‡ºè·¯å¾„</p></li><li><p>hexo_post_dir = â€˜your_path/hexo/blog/source/_postsâ€™</p><p>ã€å¯é€‰ã€‘æœ¬åœ°hexoåšå®¢æ–‡ç« æºæ–‡ä»¶è·¯å¾„</p></li><li><p>git_dir = â€˜your_path/xxx.github.ioâ€™</p><p>ã€å¿…éœ€ã€‘åšå®¢è¦åŒæ­¥çš„gitå·¥ç¨‹è·¯å¾„</p></li><li><p>git_backup_dir = â€˜your_path/xxx.github.io/blog/backup/sources/_postsâ€™</p><p>ã€å¯é€‰ã€‘æœ¬è·¯å¾„ç”¨äºå¤‡ä»½postæºæ–‡ä»¶åˆ°github</p></li><li><p>hexo.py ä¸­çš„<code>post()</code>æ–¹æ³•ä¸­<code>webbrowser.open(&#39;http://jixiaoyong.github.io/blog/&#39;)</code>ä¸­çš„åšå®¢åœ°å€ï¼Œå‘å¸ƒå®Œåé»˜è®¤æ‰“å¼€è¯¥ç½‘é¡µã€‚ï¼ˆåæœŸä¹Ÿå¯ä»¥æ”¹ä¸º<code>post()</code>å‚æ•°ä¼ å…¥ï¼Œè¿™æ ·åªéœ€è¦æ›´æ”¹<code>main.py</code>å°±è¡Œï¼‰</p></li></ul><h2 id="è¿è¡Œmain-pyæ–‡ä»¶"><a href="#è¿è¡Œmain-pyæ–‡ä»¶" class="headerlink" title="è¿è¡Œmain.pyæ–‡ä»¶"></a>è¿è¡Œ<code>main.py</code>æ–‡ä»¶</h2><ul><li>åœ¨Linuxå‘½ä»¤è¡Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œå¹¶å›è½¦ï¼Œæ ¹æ®æç¤ºæ“ä½œå³å¯ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python main.py</span><br></pre></td></tr></table></figure><p>â€‹    Windowsä¸‹å¯ä»¥è¿è¡Œ<code>start.cmd</code>è„šæœ¬ï¼ˆå¾…å®ç°ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//start.cmdè„šæœ¬å†…å®¹</span><br><span class="line">python main.py</span><br><span class="line">cmd</span><br></pre></td></tr></table></figure><ul><li><p>æ“ä½œè¿‡ç¨‹æç¤ºåŠè¯´æ˜å¦‚ä¸‹ï¼šï¼ˆæ¸£è‹±è¯­è¯·å¿½ç•¥â€¦ï¼‰</p><ul><li><p>input yout file name è¾“å…¥è¦å‘å¸ƒçš„æ–‡ç« åç§°xxxï¼ˆå½“å‰ç‰ˆæœ¬æš‚ä¸æ”¯æŒä¸­æ–‡ï¼‰</p><p>è¾“å…¥å›è½¦ä¼šè‡ªåŠ¨åˆ›å»ºxxx.mdæ–‡ä»¶å¹¶æ‰“å¼€ï¼ˆéœ€è¦ç³»ç»Ÿæ”¯æŒè¯¥æ ¼å¼ï¼‰</p></li><li><p>are you finish your post è¾“å…¥yæˆ–nï¼Œé€‰æ‹©æ˜¯å¦ç”¨hexoç¼–è¯‘æ–‡ç« </p><p>y:ç¼–è¯‘æ–‡ç«   n:ä¸ç¼–è¯‘æ–‡ç« ï¼Œé€€å‡ºå‘½ä»¤è¡Œ</p></li><li><p>post or not  è¾“å…¥yæˆ–nï¼Œé€‰æ‹©æ˜¯å¦å‘å¸ƒæ–‡ç« åˆ°ç½‘ç«™,å¯ä»¥åœ¨æ‰“å¼€çš„é¡µé¢é¢„è§ˆååšå†³å®š</p><p>y:å‘å¸ƒæ–‡ç«   n:ä¸å‘å¸ƒæ–‡ç« ï¼Œé€€å‡ºå‘½ä»¤è¡Œ</p></li><li><p>update post  ã€Šxxxã€‹ æç¤ºå¼€å§‹å‘å¸ƒæ–‡ç« ï¼Œè‡ªåŠ¨æ‰“å¼€ç½‘é¡µï¼Œå¹¶ä¿å­˜æºæ–‡ä»¶</p></li></ul></li></ul><h1 id="æºä»£ç "><a href="#æºä»£ç " class="headerlink" title="æºä»£ç "></a>æºä»£ç </h1><p>æºä»£ç å·²ç»ä¸Šä¼ <a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/2018-1-31/python%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%96%87%E7%AB%A0" target="_blank" rel="noopener">github</a></p><h1 id="åæœŸè®¡åˆ’"><a href="#åæœŸè®¡åˆ’" class="headerlink" title="åæœŸè®¡åˆ’"></a>åæœŸè®¡åˆ’</h1><ul><li>å¢åŠ æ–‡ä»¶åä¸­æ–‡æ”¯æŒ</li><li><del>å¢åŠ å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ ã€æ›¿æ¢ä¸ºgithubé“¾æ¥</del>(2018/2/2å·²å®ç°)</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonè‡ªåŠ¨åŒ–éƒ¨ç½²æ–‡ç« </title>
      <link href="/blog/posts/af2aa19e/"/>
      <url>/blog/posts/af2aa19e/</url>
      
        <content type="html"><![CDATA[<p>pythonè„šæœ¬å®ç°ä¸€é”®è‡ªåŠ¨æ–°å»ºæ–‡ç« ï¼Œç¼–è¯‘ï¼Œé¢„è§ˆï¼Œå‘å¸ƒgithub.</p><p>Just test</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonçˆ¬å–gityuanæ‰€æœ‰æ–‡ç« åˆ—è¡¨</title>
      <link href="/blog/posts/6e070881/"/>
      <url>/blog/posts/6e070881/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>æ›´æ–°å†…å®¹ï¼š</p><ul><li>çˆ¬å–gityuan.comç½‘ç«™æ‰€æœ‰æ–‡ç« åˆ—è¡¨å¹¶è¾“å‡ºjson</li><li>æ±‡æ€»ä¿¡æ¯è¾“å‡ºconfig.jsonä¸ºåé¢çš„å®¢æˆ·ç«¯åšå‡†å¤‡</li></ul><p>æ›´æ–°æ–‡ä»¶ï¼š</p><ul><li>spider_main.py</li><li>html_output.py</li><li><strong>gityuan_urls.py</strong></li><li><strong>html_downloader.py</strong></li></ul><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><ul><li><strong>spider_main.py</strong></li></ul><p>ä½œä¸ºå…¥å£ç±»ï¼Œä¸»è¦å¢åŠ äº†åˆå§‹åŒ–æ‰€æœ‰URLï¼Œä»¥åŠä¾¿åˆ©è¿™äº›URLçš„åŠŸèƒ½ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp = SpiderMain()</span><br><span class="line"></span><br><span class="line">gityuan = gityuan_urls.GitYuanUrls()</span><br><span class="line"></span><br><span class="line">gityuan_urls = gityuan.get_urls(<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'gityuan_page_'</span></span><br><span class="line"></span><br><span class="line">sp.craw(gityuan_urls,file_name)</span><br></pre></td></tr></table></figure><p>å…¶<code>craw()</code>æ–¹æ³•ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">craw</span><span class="params">(self, root_urls, file_name)</span>:</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#å°†æ‰€æœ‰æœ‰æ•ˆé“¾æ¥å…¨éƒ¨åŠ å…¥</span></span><br><span class="line">        self.urls.add_new_urls(root_urls)</span><br><span class="line"></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#å¾ªç¯éå†è¿™äº›é“¾æ¥</span></span><br><span class="line">        <span class="keyword">while</span> self.urls.has_next():</span><br><span class="line"></span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            new_url = self.urls.get_new_url()</span><br><span class="line"></span><br><span class="line">            html_cont = self.downloader.download(new_url)</span><br><span class="line"></span><br><span class="line">            new_url, new_data = self.parser.parse(new_url, html_cont)</span><br><span class="line"></span><br><span class="line">            self.output.collect_data(new_data)</span><br><span class="line"></span><br><span class="line">            new_file_name = file_name + (<span class="string">'%d.json'</span>%i)</span><br><span class="line"></span><br><span class="line">            self.output.output_html(new_file_name)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#ç­‰å¾…3sï¼Œé˜²æ­¢å¤ªé¢‘ç¹è®¿é—®è¢«è¯†åˆ«</span></span><br><span class="line">            sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#ç»“æŸéå†ï¼Œè¾“å‡ºæ±‡æ€»ä¿¡æ¯</span></span><br><span class="line">        self.output.end(file_name,root_urls[<span class="number">0</span>],i)</span><br></pre></td></tr></table></figure><ul><li><strong>html_output.py</strong></li></ul><p>ä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ol><li><code>output_html(self,file_name)</code>æ–¹æ³•å¢åŠ ä¸€ä¸ª<code>file_name</code>çš„å‚æ•°ï¼Œå¹¶åœ¨å†…éƒ¨è°ƒç”¨<code>self.mkdir()</code>æ–¹æ³•ç”Ÿæˆoutputç›®å½•ï¼Œæ–¹ä¾¿åŒæ—¶è¾“å‡ºå¤šä¸ªæ–‡æ¡£</li><li><code>mkdir()</code>æ–¹æ³•ï¼Œåˆ›å»ºæ–‡ä»¶</li><li><code>end(self,file_name_start, url, num)</code>æ–¹æ³•ï¼Œè¾“å‡ºæ±‡æ€»æ–‡æ¡£ï¼Œä»£ç å¦‚ä¸‹</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">end</span><span class="params">(self,file_name_start, url, num)</span>:</span></span><br><span class="line"></span><br><span class="line">    self.mkdir()</span><br><span class="line"></span><br><span class="line">    file_name = self.output_dir + <span class="string">'config.json'</span></span><br><span class="line"></span><br><span class="line">    file_out = open(file_name,<span class="string">'w'</span>)</span><br><span class="line">    </span><br><span class="line">    current_time = time.time()</span><br><span class="line"></span><br><span class="line">    config_str = (<span class="string">'&#123;"url":"%s","total":"%d","update_time":"%d","file_name":"%s"&#125;'</span> % (url,num,current_time,file_name_start))</span><br><span class="line"></span><br><span class="line">    file_out.write(config_str)</span><br></pre></td></tr></table></figure><ul><li><strong>gityuan_urls.py</strong></li></ul><p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼Œé€šè¿‡å¾ªç¯éå†è·å–æ‰€æœ‰æ–‡ç« åˆ—è¡¨ä¿¡æ¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GitYuanUrls</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="string">"""docstring for GitYuanUrls"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_urls</span><span class="params">(self, num)</span>:</span></span><br><span class="line"></span><br><span class="line">urls = []</span><br><span class="line"></span><br><span class="line">urls.append(<span class="string">'http://www.gityuan.com'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">1</span>,num):</span><br><span class="line">url_ = (<span class="string">'http://www.gityuan.com/page%d/'</span>%x)</span><br><span class="line">urls.append(url_)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> urls</span><br></pre></td></tr></table></figure><ul><li><strong>html_downloader.py</strong></li></ul><p>å°±åœ¨æœ¬æ–‡ç¼–è¾‘çš„è¿‡ç¨‹ä¸­ï¼Œçˆ¬è™«è¢«è¯†åˆ«ï¼Œå¹¶ä¸”é™åˆ¶è®¿é—®æ–‡ä»¶æ•°é‡ï¼Œæ‰€ä»¥å¯¹ä¸‹è½½åŠŸèƒ½åšäº†ç®€å•çš„ä¼ªè£…ã€å¢åŠ è¶…æ—¶å¤„ç†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download2</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        <span class="comment">#å‡çº§ç‰ˆ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#ä¼ªè£…ä¸ºæµè§ˆå™¨</span></span><br><span class="line">        req_header = &#123;<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.87 Safari/537.36'</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request = urllib2.Request(url,<span class="literal">None</span>,req_header)</span><br><span class="line"></span><br><span class="line">            response = urllib2.urlopen(request,<span class="literal">None</span>,<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> response.read()</span><br><span class="line">        <span class="keyword">except</span> socket.timeout <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment">#è¶…æ—¶å¤„ç†</span></span><br><span class="line">            print(type(e))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>å½“å‰çˆ¬è™«ä¸»ä½“åŠŸèƒ½ä»¥åŠå®ç°ï¼Œå¯ä»¥çˆ¬å–gityuan.comæ‰€æœ‰æœ‰æ•ˆæ–‡ç« åˆ—è¡¨ï¼Œå¯ä»¥æ»¡è¶³å®¢æˆ·ç«¯éœ€æ±‚ã€‚ä½†ä»ç„¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li>æ²¡æœ‰ä¼ªè£…ï¼Œçˆ¬è™«<strong>å¾ˆå®¹æ˜“</strong>è¢«è¯†åˆ«å¹¶è¢«æ‹’ç»æœåŠ¡ï¼ˆ<del>å°±åœ¨åˆšåˆšå†™ä¸‹è¿™å¥è¯çš„æ—¶å€™ï¼Œå°±å‘ç”Ÿäº†è¢«é™åˆ¶è®¿é—®ï¼ŒçœŸ*ä¹Œé¸¦å˜´</del>ï¼‰ã€‚</li><li>ç”±äºåŸç½‘ç«™ç‰¹æ€§ï¼Œå…¶ç½®é¡¶æ–‡ç« æ¯é¡µéƒ½æœ‰ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†æ•°æ®é‡å¤ã€‚</li><li>æœªçˆ¬å–å…·ä½“æ–‡ç« å†…å®¹ã€‚</li></ol><blockquote><p><strong>è¯´æ˜</strong></p><p>æœ¬æ–‡åªä¸ºå­¦æœ¯ç ”ç©¶ï¼Œå…¶ä¸­æ¶‰åŠåˆ°çš„ç¬¬ä¸‰æ–¹ç½‘ç«™åŠå…¶æ‰€æœ‰èµ„æºå‡å±åŸä¸»æ‰€æœ‰ã€‚å‘gityuanå¤§ç¥è‡´æ•¬ï¼Œæ¬¢è¿è®¿é—®å…¶<a href="http://gityuan.com/" target="_blank" rel="noopener">blog</a>ã€‚</p></blockquote><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/2018-1-26/gityuan_spider" target="_blank" rel="noopener">githubé“¾æ¥</a></p><p><code>tag</code>ä¸º<code>gityuan_spider1.5</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonçˆ¬è™«çˆ¬å–gityuan.comæ•°æ®å¹¶è¾“å‡ºjson</title>
      <link href="/blog/posts/9c0ccf0d/"/>
      <url>/blog/posts/9c0ccf0d/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote><p>æœ¬æ–‡åŸºäºPython2.7</p></blockquote><p>è¿™ç¯‡æ–‡ç« åŸºäºæˆ‘åœ¨<a href="www.imooc.com">æ…•è¯¾ç½‘</a>ä¸Šé¢å­¦ä¹ Pythonç®€å•çˆ¬è™«å†™çš„å†…å®¹ï¼Œæ•™ç¨‹å†…å®¹æ˜¯çˆ¬å–1000æ¡ç™¾åº¦ç™¾ç§‘çš„æ•°æ®ï¼Œä½†æ˜¯æ•™ç¨‹ä¸­çˆ¬è™«æˆªæ­¢2018-01-27å·²ç»å¤±æ•ˆï¼Œåˆšå¥½çœ‹åˆ°å¤§ç¥gityuan.comçš„å†…å®¹ï¼Œäºæ˜¯ç”¨Pythonå®ç°çˆ¬å–å…¶ç½‘é¡µå†…å®¹å¹¶ç”Ÿæˆjsonæ•°æ®ã€‚</p><p>æœ¬æ–‡å³ä¸Šè¿°è¿‡ç¨‹æ•´ç†ã€‚</p><p>æœ¬æ–‡æ¶‰åŠæºä»£ç å·²ä¸Šä¼ githubï¼ˆ<a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/2018-1-26/gityuan_spider" target="_blank" rel="noopener">ç‚¹è¿™é‡ŒæŸ¥çœ‹</a>ï¼‰ã€‚</p><h1 id="æ¡†æ¶"><a href="#æ¡†æ¶" class="headerlink" title="æ¡†æ¶"></a>æ¡†æ¶</h1><p>çˆ¬è™«ä¸»è¦æ´»åŠ¨æ˜¯ï¼š</p><ol><li>çˆ¬å–ç›®æ ‡ç½‘é¡µå†…å®¹</li><li>å¯¹è·å–åˆ°çš„å†…å®¹è¿›è¡Œåˆ†æï¼Œè·å–æœ‰ç”¨æ•°æ®</li><li>å°†å¤„ç†å¥½çš„æ•°æ®æŒ‰æ ¼å¼è¾“å‡º</li></ol><p>æ­¤å¤–è¿˜éœ€è¦æœ‰ä¸€ä¸ªä¸“é—¨ç®¡ç†çˆ¬è™«æ´»åŠ¨çš„ä¸»ç±»ï¼Œæ•…è€Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><ol><li>spider_main.py             å…¥å£ç±»</li><li>url_manager.py             ç®¡ç†è¦ä¸‹è½½çš„é“¾æ¥</li><li>html_downloader.py    ä¸‹è½½ç½‘é¡µå†…å®¹</li><li>html_paeser.py              å¯¹è·å–åˆ°çš„æ•°æ®è¿›è¡Œè§£æã€åŠ å·¥</li><li>html_out.py                     è¾“å‡ºæ ¼å¼åŒ–çš„æ•°æ®</li></ol><p>ç›®å‰åªå®ç°äº†çˆ¬å–gityuan.comç¬¬ä¸€é¡µå†…å®¹å¹¶è¾“å‡ºjsonï¼Œæ‰€ä»¥æš‚æ—¶ä¸éœ€è¦å®ç°url_manager.py</p><h1 id="å…³é”®ä»£ç "><a href="#å…³é”®ä»£ç " class="headerlink" title="å…³é”®ä»£ç "></a>å…³é”®ä»£ç </h1><p><strong>spider_main.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯¼å…¥ç”¨åˆ°çš„å„ä¸ªç±»</span></span><br><span class="line"><span class="keyword">import</span> html_downloader</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®šä¹‰å…¥å£ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderMain</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–å„ä¸ªå˜é‡downloaderã€parserã€output...</span></span><br><span class="line">    self.downloader = html_downloader.HtmlDownloader()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#ç•¥</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">craw</span><span class="params">(self,root_url)</span>:</span></span><br><span class="line">    </span><br><span class="line">    html_cont = self.downloader.download(root_url)</span><br><span class="line">    </span><br><span class="line">    new_data = self.parser.parse(html_cont)</span><br><span class="line">    </span><br><span class="line">    self.output.collect_data(new_data)</span><br><span class="line">    </span><br><span class="line">    self.output.output_json()</span><br><span class="line">    </span><br><span class="line">root_url = <span class="string">'http://www.gityuan.com/'</span></span><br><span class="line">sp = SpiderMain()</span><br><span class="line">sp.craw(root_url)</span><br></pre></td></tr></table></figure><ul><li>åœ¨<code>__init__()</code> æ–¹æ³•åˆå§‹åŒ–å„ä¸ªå˜é‡ï¼›</li><li>åœ¨<code>craw()</code>ä¸­åˆ†åˆ«å®ç°ä¸‹è½½ã€è§£æç½‘é¡µå†…å®¹ã€è¾“å‡ºåŠ å·¥æ•°æ®</li></ul><p><strong>html_download.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlDownLoader</span><span class="params">(object)</span>:</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(self,url)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    respone = urllib2.urlopen(url,timeout=<span class="number">300</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> respone.getcode() != <span class="number">200</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> respone.read()</span><br></pre></td></tr></table></figure><p>ä¸‹è½½å¹¶è¿”å›ç½‘é¡µå†…å®¹ï¼Œæ¯”è¾ƒç®€å•</p><p><strong>html_parser.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup <span class="comment">#ç¬¬ä¸‰æ–¹åŒ…ï¼Œéœ€è¦å•ç‹¬ä¸‹è½½</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlParser</span><span class="params">(object)</span>:</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self,html_cont)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> html_cont <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#ç”¨BeautifulSoupè§£ææ–‡æ¡£å†…å®¹</span></span><br><span class="line">    soup = BeautifulSoup(html_cont,<span class="string">'html.parser'</span>)</span><br><span class="line">    </span><br><span class="line">    res_data = [] <span class="comment">#æ•°ç»„</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è·å–æ‰€æœ‰çš„æ–‡ç« èŠ‚ç‚¹nodes</span></span><br><span class="line">    post_div_nodes = soup.find_all(<span class="string">'div'</span>,class_=<span class="string">'post-preview'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#éå†nodesï¼Œè¯»å–æ¯ä¸€é¡¹å†…å®¹å¹¶ä¿å­˜</span></span><br><span class="line">    <span class="keyword">for</span> post_div_node <span class="keyword">in</span> post_div_nodes:</span><br><span class="line">      post_div_soup = BeautifulSoup(str(post_div_node))</span><br><span class="line">      </span><br><span class="line">      post_info = &#123;&#125; <span class="comment">#å­—å…¸dict</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">#åˆ¤æ–­URLæ˜¯å¦æ˜¯å®Œæ•´</span></span><br><span class="line">      url_ = post_div_soup.a[<span class="string">'href'</span>]</span><br><span class="line">      <span class="keyword">if</span> <span class="string">'http://'</span> <span class="keyword">not</span> <span class="keyword">in</span> url_:</span><br><span class="line">        url_ = <span class="string">"http://gityuan.com"</span> + url_</span><br><span class="line">       </span><br><span class="line">      <span class="comment">#ä¿å­˜æ•°æ®</span></span><br><span class="line">      post_info[<span class="string">'url'</span>] = url_</span><br><span class="line">      post_info[<span class="string">'title'</span>] = post_div_soup.find(<span class="string">'h2'</span>).get_text()</span><br><span class="line">      post_info[<span class="string">'summary'</span>] = post_div_soup.find(<span class="string">'div'</span>,class_=<span class="string">'post-content-preview'</span>).get_text()</span><br><span class="line">       </span><br><span class="line">      res_data.append(post_info)</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">return</span> res_data</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯çˆ¬è™«åŠŸèƒ½çš„é‡ç‚¹ä¹‹ä¸€ï¼šå¯¹ç½‘é¡µæ•°æ®è¿›è¡Œè§£æï¼Œç”±æ­¤æ•°æ®æ‰å˜ä¸ºå¯ç”¨æ•°æ®</p><p>ä¸»è¦æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹æ’ä»¶<code>BeautifulSoup</code>è§£ææ•°æ®ï¼Œå¹¶ä¿å­˜åˆ°æ•°ç»„<code>res_data</code>ä¸­ï¼Œå…·ä½“è§ä»£ç ä¸­å®ç°</p><p><strong>html_output.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment">#ä¸‹é¢ä¸¤è¡Œä»£ç è§£å†³ç¼–ç é—®é¢˜ï¼Œå¼ºåˆ¶ä½¿ç”¨utf-8ï¼Œè€Œéé»˜è®¤çš„unicodeç¼–ç </span></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonOutput</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.datas = []</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">collect_data</span><span class="params">(self,new_data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> new_data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">      self.datas.append(new_data)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">output_json</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment">#æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶ä»¥jsonæ ¼å¼è¾“å‡º</span></span><br><span class="line">    fout = open(<span class="string">'output.json'</span>,<span class="string">'w'</span>)</span><br><span class="line">    </span><br><span class="line">    fout.write(<span class="string">'&#123;'</span>)</span><br><span class="line">    fout.write(<span class="string">r'"data":['</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> self.datas:</span><br><span class="line">      <span class="keyword">for</span> post_info <span class="keyword">in</span> data:</span><br><span class="line">        </span><br><span class="line">        fout.write(<span class="string">'&#123;'</span>)</span><br><span class="line">        fout.write(<span class="string">'"url":"%",'</span> % post_info[<span class="string">'url'</span>])</span><br><span class="line">        fout.write(<span class="string">'"title":"%",'</span> % post_info[<span class="string">'title'</span>])</span><br><span class="line">        fout.write(<span class="string">'"summary":"%",'</span> % post_info[<span class="string">'summary'</span>])</span><br><span class="line">        fout.write(<span class="string">'&#125;,'</span>)</span><br><span class="line">    <span class="comment">#ä¸ºäº†ç¬¦åˆjsonè§„èŒƒï¼Œæœ€åä¸€ä¸ªè¾“å…¥ç©ºæ•°æ®ï¼Œæ— æœ«å°¾é€—å·</span></span><br><span class="line">    fout.write(<span class="string">r'&#123;&#125;'</span>)</span><br><span class="line">    </span><br><span class="line">    fout.write(<span class="string">']&#125;'</span>)</span><br></pre></td></tr></table></figure><p>æœ¬ç±»ä¹Ÿå¾ˆé‡è¦ï¼Œä¸»è¦æ˜¯æ•°æ®å­˜å–ï¼Œä»¥åŠå°†è§£æå¥½çš„æ•°æ®æ ¼å¼åŒ–è¾“å‡º</p><h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>æœ¬æ–‡ä¸­ä»£ç ç»äºŒæ¬¡å¤„ç†ï¼Œä¸ä¸€å®šä¸æºä»£ç ä¸€è‡´ï¼Œä½†æ€è·¯å¦‚æ­¤ï¼Œä»¥ä¾›å‚è€ƒã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidè‡ªå®šä¹‰é€æ˜èƒŒæ™¯çš„Dialog</title>
      <link href="/blog/posts/f20627c9/"/>
      <url>/blog/posts/f20627c9/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>é€šè¿‡è‡ªå®šä¹‰Dialogç±»ï¼Œä½¿ç”¨Styleã€AnimationDrawableç­‰å®ç°ä¸€ä¸ªé€æ˜èƒŒæ™¯çš„ã€å¸¦è¿›åº¦æ›´æ–°çš„å¼¹çª—ã€‚</p><p>ä¸»è¦æ¶‰åŠStyleè‡ªå®šä¹‰ä»¥åŠAnimationDrawableçš„ä½¿ç”¨ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><ul><li><strong>å¸ƒå±€æ–‡ä»¶</strong></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/dialog_bg"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/image"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"250dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"250dp"</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><strong>èµ„æºæ–‡ä»¶</strong></li></ul><p>1ï¼‰ä¸‹è½½å¯¹åº”è¿›åº¦æ¡çš„å›¾ç‰‡èµ„æºï¼Œæ”¾åˆ°drawableç›®å½•ä¸‹</p><p>2ï¼‰åœ¨drawableä¸‹æ–°å»ºdialog_progress.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">animation-list</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:oneshot</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:drawable</span>=<span class="string">"@drawable/progress_1"</span> //èµ„æºæ–‡ä»¶</span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"300"</span> /&gt;</span> //æŒç»­æ—¶é—´ms</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:drawable</span>=<span class="string">"@drawable/progress_2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"300"</span> /&gt;</span></span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">animation-list</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3ï¼‰dialogåœ†è§’èƒŒæ™¯ï¼ˆéå¿…é¡»ï¼‰</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shape</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"#6fb6d4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"500dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4ï¼‰è‡ªå®šä¹‰dialogçš„style</p><p><code>windowBackground</code>ä½¿èƒŒæ™¯é€æ˜</p><p><code>backgroundDimEnabled</code>åˆ™å¯ä»¥å»é™¤åŠé€æ˜é®ç½©æ•ˆæœ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"diyDialogStyle"</span> <span class="attr">parent</span>=<span class="string">"@android:style/Theme.Dialog"</span> &gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowBackground"</span>&gt;</span>@android:color/transparent<span class="tag">&lt;/<span class="name">item</span>&gt;</span><span class="comment">&lt;!--èƒŒæ™¯é€æ˜--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:backgroundDimEnabled"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span><span class="comment">&lt;!--åŠé€æ˜ï¼Œæ¨¡ç³Š--&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><strong>DIYDialog.java</strong></li></ul><p>ç»§æ‰¿è‡ª<code>Dialog.java</code> ï¼Œå¹¶ç”¨æ„é€ å‡½æ•°è°ƒç”¨<code>initView()</code>æ–¹æ³•åˆå§‹åŒ–dialogæ ·å¼ï¼Œæœ‰å…¶ä»–éœ€æ±‚å¯ä»¥å†è‡ªå·±å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–viewã€æ§ä»¶</span></span><br><span class="line">View view = View.inflate(context, R.layout.layout_dialog, <span class="keyword">null</span>);</span><br><span class="line">ImageView imageView = view.findViewById(R.id.image);</span><br><span class="line">imageView.setBackgroundResource(R.drawable.dialog_progress);</span><br><span class="line"><span class="comment">//å¡«å……å¸ƒå±€</span></span><br><span class="line">setContentView(view);</span><br><span class="line"><span class="comment">//å®ç°åŠ¨ç”»</span></span><br><span class="line">AnimationDrawable animationDrawable = (AnimationDrawable) imageView.getBackground();</span><br><span class="line">animationDrawable.run();</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p><a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/2018-1-26/DIY_Dialog" target="_blank" rel="noopener">githubæºç è·¯å¾„</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®ç°AESåŠ å¯†è§£å¯†åº”ç”¨</title>
      <link href="/blog/posts/375fcf66/"/>
      <url>/blog/posts/375fcf66/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>æœ€è¿‘æ‰‹æœºä¸­æ¶‰åŠåˆ°ç”¨æˆ·è´¦æˆ·å¯†ç ä¿å­˜çš„é—®é¢˜ï¼Œé€‰ç”¨AESåŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†åï¼Œå†é€šè¿‡SharedPreferencesä¿å­˜åœ¨æ‰‹æœºç«¯ã€‚</p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»AESçš„åŠ å¯†ã€è§£å¯†ç”¨æ³•ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><p>åˆå§‹åŒ–ç§˜é’¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AES = <span class="string">"AES"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWPRD = <span class="string">"123456"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SecretKeySpec <span class="title">initKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SecretKeySpec key = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        KeyGenerator kg = KeyGenerator.getInstance(AES);</span><br><span class="line">        kg.init(<span class="number">128</span>,<span class="keyword">new</span> SecureRandom(PASSWPRD.getBytes()));<span class="comment">//é€šè¿‡è¿™ç§ç®—æ³•ï¼Œæ¯æ¬¡ç”Ÿæˆçš„keyéƒ½æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">      <span class="comment">//ä¹Ÿå¯ä»¥kg.init(128),è¿™æ ·æ¯æ¬¡ç”Ÿæˆçš„keyéƒ½ä¸ä¸€æ ·</span></span><br><span class="line">        SecretKey securityKey = kg.generateKey();</span><br><span class="line">        <span class="keyword">byte</span>[] encodedKey = securityKey.getEncoded();</span><br><span class="line">        key = <span class="keyword">new</span> SecretKeySpec(encodedKey, AES);<span class="comment">//AESä¹Ÿå¯ä»¥æ›¿æ¢ä¸º"AES/CBC/PKCS5PADDING"</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ å¯†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¸å¿ƒä»£ç </span></span><br><span class="line"><span class="comment">//sourceæ˜¯è¦åŠ å¯†çš„å†…å®¹</span></span><br><span class="line">Cipher cipher = Cipher.getInstance(AES);<span class="comment">//åˆ›å»ºå¯†ç å™¨</span></span><br><span class="line"><span class="keyword">byte</span>[] byteContent = source.getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">cipher.init(Cipher.ENCRYPT_MODE, key);<span class="comment">//åˆ›å»ºå¯†ç å™¨</span></span><br><span class="line"><span class="keyword">byte</span>[] result = cipher.doFinal(byteContent);<span class="comment">//åŠ å¯†</span></span><br></pre></td></tr></table></figure><p>è§£å¯†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¸å¿ƒä»£ç </span></span><br><span class="line">Cipher cipher = Cipher.getInstance(AES);</span><br><span class="line">cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line"><span class="keyword">byte</span>[] result = cipher.doFinal(source);</span><br></pre></td></tr></table></figure><p>åŠ å¯†å’Œè§£å¯†çš„ç»“æœéƒ½æ˜¯äºŒè¿›åˆ¶çš„ï¼Œæ— æ³•ç›´æ¥è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†äºŒè¿›åˆ¶ä¸åå…­è¿›åˆ¶äº’è½¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">parseByte2HexStr</span><span class="params">(<span class="keyword">byte</span> buf[])</span> </span>&#123;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; buf.length; i++) &#123;</span><br><span class="line">        String hex = Integer.toHexString(buf[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="keyword">if</span> (hex.length() == <span class="number">1</span>) &#123;</span><br><span class="line">            hex = <span class="string">'0'</span> + hex;</span><br><span class="line">        &#125;</span><br><span class="line">        stringBuffer.append(hex.toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] parseHexStr2Byte(String hexStr)&#123;</span><br><span class="line">    <span class="keyword">if</span> (hexStr.length() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[hexStr.length() / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hexStr.length() / <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> high = Integer.parseInt(hexStr.substring(i * <span class="number">2</span>, i * <span class="number">2</span> + <span class="number">1</span>), <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">int</span> low = Integer.parseInt(hexStr.substring(i * <span class="number">2</span> + <span class="number">1</span>, i * <span class="number">2</span> + <span class="number">2</span>), <span class="number">16</span>);</span><br><span class="line">        result[i] = (<span class="keyword">byte</span>) (high * <span class="number">16</span> + low);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥åœ¨åˆå§‹åŒ–ä¸€ä¸ªkeyåï¼Œå¯¹æ–‡æœ¬è¿›è¡ŒåŠ å¯†å’Œè§£å¯†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–key</span></span><br><span class="line">SecretKeySpec key = initKey();</span><br><span class="line"><span class="comment">//åŠ å¯†æ–‡æœ¬å¹¶è½¬åŒ–ä¸º16è¿›åˆ¶ï¼Œæ–¹ä¾¿ä¿å­˜</span></span><br><span class="line">String eStr = parseByte2HexStr(encrypt(resource,key));</span><br><span class="line"><span class="comment">//å°†åŠ å¯†16è¿›åˆ¶æ–‡æœ¬è½¬ä¸ºäºŒè¿›åˆ¶ï¼Œè¿›è¡Œè§£å¯†</span></span><br><span class="line">String dStr = decrypt(parseHexStr2Byte(estr));</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="http://blog.csdn.net/hbcui1984/article/details/5201247" target="_blank" rel="noopener">JAVAå®ç°AESåŠ å¯† - CSDNåšå®¢</a></p><p><a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/2018-1-22/encryption" target="_blank" rel="noopener">æºç githubé“¾æ¥</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> åŠ å¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaæ³¨è§£</title>
      <link href="/blog/posts/3f6454bb/"/>
      <url>/blog/posts/3f6454bb/</url>
      
        <content type="html"><![CDATA[<p>æ³¨è§£ï¼Œ<em>æ˜¯æè¿°Javaä»£ç çš„ä»£ç ï¼Œå®ƒèƒ½å¤Ÿè¢«ç¼–è¯‘å™¨è§£æï¼Œå‘ç¼–è¯‘å™¨ã€è™šæ‹Ÿæœºè¯´æ˜ä¸€äº›äº‹æƒ…ï¼Œå°±åƒjavaä¸­ç»™ç¨‹åºå‘˜çœ‹çš„æ³¨é‡Šä¸€æ ·</em>ã€‚</p><p>Androidåº”ç”¨å¼€å‘è¿™æ–¹é¢æ¯”è¾ƒç«çš„æ˜¯<a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="noopener">Butter Knife</a> ,æœ¬æ–‡è®²è¿°å¦‚ä½•è‡ªå®šä¹‰æ³¨è§£æ›¿æ¢findViewById()ã€‚</p><p>å®ç°<strong>æ³¨è§£ï¼ˆannotationï¼‰</strong>çš„æ€è·¯ï¼šé€šè¿‡<strong>åå°„</strong>è·å–åˆ°ç±»ä¸­ä½¿ç”¨æ³¨è§£çš„å˜é‡ï¼Œæ–¹æ³•ï¼Œå†è°ƒç”¨ä¸åŒçš„æ–¹æ³•å¯¹è¿™äº›å˜é‡ï¼Œæ–¹æ³•è¿›è¡Œå¤„ç†ä»¥è¾¾åˆ°ç›®çš„ã€‚</p><p>ä¸»è¦æ¶‰åŠä¸‰æ–¹é¢ï¼š</p><ul><li>å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»</li><li>å®šä¹‰ä¸€ä¸ªæ³¨è§£å¸®åŠ©ç±»</li><li>ä½¿ç”¨æ³¨è§£</li></ul><h1 id="javaå…ƒæ³¨è§£"><a href="#javaå…ƒæ³¨è§£" class="headerlink" title="javaå…ƒæ³¨è§£"></a>javaå…ƒæ³¨è§£</h1><p>javaè¯­è¨€æœ‰å››ä¸ªé¢„ç•™çš„æ³¨è§£ï¼Œç”¨æ¥ç”Ÿæˆå…¶ä»–è‡ªå®šä¹‰çš„æ³¨è§£ï¼š</p><ul><li>@Target</li></ul><p>è¯´æ˜æ³¨è§£æ‰€èƒ½ä¿®é¥°çš„èŒƒå›´ã€‚å…¶å€¼ä¸€èˆ¬ä¸ºElementType.xxxï¼Œä¸»è¦æœ‰ï¼š</p><ol><li>CONSTRUCTOR æè¿°æ„é€ å™¨</li><li>FIELD æè¿°åŸŸ</li><li>LOCAL_VARIABLE æè¿°å±€éƒ¨å˜é‡</li><li>METHOD æè¿°æ–¹æ³•</li><li>PACKAGE æè¿°åŒ…</li><li>PARAMETER æè¿°å‚æ•°</li><li>TYPE æè¿°ç±»ï¼Œæ¥å£ï¼Œenumå£°æ˜</li></ol><ul><li>@Retention</li></ul><p>è¯´æ˜æ³¨è§£å­˜æ´»çš„ç”Ÿå‘½å‘¨æœŸ,å…¶å€¼ä¸€èˆ¬ä¸ºRetentionPolicy.xxxï¼Œä¸»è¦æœ‰</p><ol><li>SOURCE ä»…æºæ–‡ä»¶æœ‰æ•ˆï¼Œè¢«ç¼–è¯‘å™¨ä¸¢å¼ƒ</li><li>CLASS åœ¨classæ–‡ä»¶ä¸­æœ‰æ•ˆï¼Œå¯èƒ½è¢«è™šæ‹Ÿæœºå¿½ç•¥</li><li>RUNTIME åœ¨è¿è¡Œæ—¶æœ‰æ•ˆï¼Œåœ¨classè¢«è£…è½½æ—¶è¢«è·å–</li></ol><ul><li>@Documented</li></ul><blockquote><p>ç”¨äºæè¿°å…¶å®ƒç±»å‹çš„annotationåº”è¯¥è¢«ä½œä¸ºè¢«æ ‡æ³¨çš„ç¨‹åºæˆå‘˜çš„å…¬å…±API</p></blockquote><p>è¡¨ç¤ºæ˜¯å¦å°†æ³¨è§£ä¿¡æ¯æ·»åŠ åœ¨javaæ–‡æ¡£ä¸­ã€‚æœ‰è¯¥æ³¨è§£åˆ™ä¼šè¢«Javadocå·¥å…·æ–‡æ¡£åŒ–</p><p>æ˜¯ä¸€ä¸ªæ ‡è®°æ³¨è§£ï¼Œæ²¡æœ‰å€¼</p><ul><li>@Inherited</li></ul><p>è¡¨ç¤ºè¯¥æ ‡è®°ä¼šè¢«æ ‡è®°çš„classçš„å­ç±»ç»§æ‰¿ï¼Œåœ¨æŸ¥æ‰¾è¯¥æ³¨è§£æ—¶ï¼Œå¦‚æœå½“å‰ç±»æ²¡æœ‰ï¼Œä¼šè‡ªåŠ¨å‘ä¸Šåˆ°å…¶çˆ¶ç±»ä¸­æŸ¥æ‰¾ï¼Œç›´åˆ°<em>è¯¥æ³¨è§£ç±»å‹è¢«æ‰¾åˆ°æˆ–æ˜¯æŸ¥æ‰¾å®Œäº†Objectç±»è¿˜æœªæ‰¾åˆ°</em></p><p>æ˜¯ä¸€ä¸ªæ ‡è®°æ³¨è§£ï¼Œæ²¡æœ‰å€¼</p><p><strong>æ³¨è§£ä¸èƒ½ç»§æ‰¿å…¶ä»–æ³¨è§£æˆ–æ¥å£</strong></p><h1 id="å†…å»ºæ³¨è§£"><a href="#å†…å»ºæ³¨è§£" class="headerlink" title="å†…å»ºæ³¨è§£"></a>å†…å»ºæ³¨è§£</h1><p>javaä¸­å¸¸è§çš„å†…å»ºæ³¨è§£ï¼š</p><ul><li><code>@Override</code> é‡å†™çˆ¶ç±»æ–¹æ³•</li><li><code>@Deprecated</code> ä¸èµæˆä½¿ç”¨çš„api</li><li><code>@SuppressWarnings()</code> å¿½ç•¥æŒ‡å®šè­¦å‘Š</li></ul><p>å‚æ•°å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>deprecation</td><td>ä½¿ç”¨äº†è¿‡æ—¶çš„ç±»æˆ–æ–¹æ³•æ—¶çš„è­¦å‘Š</td></tr><tr><td>unchecked</td><td>æ‰§è¡Œäº†æœªæ£€æŸ¥çš„è½¬æ¢æ—¶çš„è­¦å‘Š</td></tr><tr><td>fallthrough</td><td>å½“Switchç¨‹åºå—è¿›å…¥è¿›å…¥ä¸‹ä¸€ä¸ªcaseè€Œæ²¡æœ‰Breakæ—¶çš„è­¦å‘Š</td></tr><tr><td>path</td><td>åœ¨ç±»è·¯å¾„ã€æºæ–‡ä»¶è·¯å¾„ç­‰æœ‰ä¸å­˜åœ¨è·¯å¾„æ—¶çš„è­¦å‘Š</td></tr><tr><td>serial</td><td>å½“å¯åºåˆ—åŒ–çš„ç±»ç¼ºå°‘serialVersionUIDå®šä¹‰æ—¶çš„è­¦å‘Š</td></tr><tr><td>finally</td><td>ä»»æ„finallyå­å¥ä¸èƒ½æ­£å¸¸å®Œæˆæ—¶çš„è­¦å‘Š</td></tr><tr><td>all</td><td>ä»¥ä¸Šæ‰€æœ‰æƒ…å†µçš„è­¦å‘Š</td></tr></tbody></table><h1 id="è‡ªå®šä¹‰æ³¨è§£"><a href="#è‡ªå®šä¹‰æ³¨è§£" class="headerlink" title="è‡ªå®šä¹‰æ³¨è§£"></a>è‡ªå®šä¹‰æ³¨è§£</h1><h2 id="æ³¨è§£ç±»"><a href="#æ³¨è§£ç±»" class="headerlink" title="æ³¨è§£ç±»"></a>æ³¨è§£ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</span><br><span class="line">    <span class="comment">//æ³¨è§£å‚æ•°åªå¯ä»¥ä¸ºpublicæˆ–è€…é»˜è®¤</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ³¨è§£ä¸­çš„å€¼ä¸æ˜¯valueï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œæ³¨è§£çš„æ—¶å€™ï¼Œéœ€è¦ç»™å‡ºå¯¹åº”çš„å€¼çš„åå­—</span></span><br><span class="line">    <span class="comment">//å¦‚@ViewInject(id = R.id.buy)</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//æ³¨è§£å…ƒç´ å¿…é¡»æœ‰æ˜ç¡®çš„å€¼ï¼Œè¦ä¸åœ¨å®šä¹‰æ³¨è§£æ—¶æŒ‡å®šé»˜è®¤å€¼ï¼Œè¦ä¸åœ¨ä½¿ç”¨æ³¨è§£æ—¶æŒ‡å®š</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">age</span><span class="params">()</span> <span class="keyword">default</span> 18</span>;<span class="comment">//æŒ‡å®šé»˜è®¤å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨è§£å‚æ•°æ”¯æŒæ•°æ®ç±»å‹å¦‚ä¸‹ï¼š</p><p>1.æ‰€æœ‰åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆint,float,boolean,byte,double,char,long,short)<br>2.Stringç±»å‹<br>3.Classç±»å‹<br>4.enumç±»å‹<br>5.Annotationç±»å‹<br>6.ä»¥ä¸Šæ‰€æœ‰ç±»å‹çš„æ•°ç»„</p></blockquote><h2 id="æ³¨è§£å¸®åŠ©ç±»"><a href="#æ³¨è§£å¸®åŠ©ç±»" class="headerlink" title="æ³¨è§£å¸®åŠ©ç±»"></a>æ³¨è§£å¸®åŠ©ç±»</h2><p>ä¸»è¦æä¾›ä½¿ç”¨æ³¨è§£çš„æ–¹æ³•ï¼Œä»£ç ä¸­çš„æ³¨è§£æ›¿æ¢ä¸ºçœŸæ­£è¦å®ç°çš„é€»è¾‘ï¼Œä¸ºæ³¨è§£å’Œä½¿ç”¨æ³¨è§£çš„ç±»æ­å»ºä¸€ä¸ªæ¡¥æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¸å¿ƒæ–¹æ³•å¦‚ä¸‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bindViews</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//è·å–åˆ°ä½¿ç”¨æ³¨è§£çš„ç±»</span></span><br><span class="line">        Class&lt;? extends Activity&gt; clazz = activity.getClass();</span><br><span class="line">  <span class="comment">//è·å–è¯¥ç±»ä¸­çš„æ‰€æœ‰åŸŸå˜é‡</span></span><br><span class="line">        Field[] fields = clazz.getDeclaredFields();</span><br><span class="line">  <span class="comment">//é€šè¿‡éå†ï¼Œå°†ä½¿ç”¨åˆ°æ³¨è§£çš„å˜é‡åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">          <span class="comment">//è·å–æ³¨è§£å¯¹è±¡</span></span><br><span class="line">            BindView bindView = field.getAnnotation(BindView<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (bindView != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">//è·å–æ³¨è§£çš„å€¼</span></span><br><span class="line">                <span class="keyword">int</span> viewId = bindView.value();</span><br><span class="line">                <span class="keyword">if</span> (viewId != -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                      <span class="comment">//æ³¨è§£è¦å®ç°çš„é€»è¾‘ï¼Œæ­¤å¤„ä¸ºæ›¿ä»£clazzä¸­çš„findViewById()æ–¹æ³•ï¼Œæ³¨æ„getMethod()æ˜¯è·å–è¯¥ç±»åŠå…¶å®ç°çš„æ¥å£ä¸­æ‰€æœ‰çš„publicæ–¹æ³•</span></span><br><span class="line">                        Method findViewById = clazz.getMethod(<span class="string">"findViewById"</span>, <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                        findViewById.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        Object o = findViewById.invoke(activity, viewId);</span><br><span class="line">                      <span class="comment">//ä¿®æ”¹è¦æ³¨è§£çš„ç±»ï¼Œåˆ°æ­¤æ³¨è§£ç›®çš„è¾¾åˆ°</span></span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        field.set(activity,o);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æ³¨è§£"><a href="#ä½¿ç”¨æ³¨è§£" class="headerlink" title="ä½¿ç”¨æ³¨è§£"></a>ä½¿ç”¨æ³¨è§£</h2><p>åœ¨ç±»ä¸­é€šè¿‡<code>@xxx()</code> ä½¿ç”¨æ³¨è§£ï¼Œå¹¶é€šè¿‡å¸®åŠ©ç±»çœŸæ­£å®ç°æ³¨è§£é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ‡è®°æ³¨è§£</span></span><br><span class="line"><span class="meta">@BindView</span>(R.id.text)</span><br><span class="line"><span class="keyword">private</span> TextView textView;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨å¸®åŠ©ç±»æ–¹æ³•</span></span><br><span class="line">AnnotationUtils.bindViews(ASampleActivity.<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨åˆå§‹åŒ–ä¹‹åçš„å˜é‡</span></span><br><span class="line">textView.setText(<span class="string">"hello annotation"</span>);</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><ul><li><a href="http://www.importnew.com/23816.html" target="_blank" rel="noopener">Javaæ ¸å¿ƒæŠ€æœ¯ç‚¹ä¹‹æ³¨è§£ - ImportNew</a></li><li><a href="http://gityuan.com/2016/01/23/java-annotation/" target="_blank" rel="noopener">javaæ³¨è§£â€“gityuan</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> æ³¨è§£ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonå…¥é—¨çŸ¥è¯†</title>
      <link href="/blog/posts/a8f97c56/"/>
      <url>/blog/posts/a8f97c56/</url>
      
        <content type="html"><![CDATA[<p>åŸºäºPython3.x</p><p>Pythonæ–‡ä»¶é»˜è®¤æ ¼å¼<code>.py</code></p><p>é¦–è¡Œé»˜è®¤ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br></pre></td></tr></table></figure><h1 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h1><ul><li><p><strong>æ•°å­—</strong></p><p>æ•´æ•°int  1ï¼Œ2ï¼Œ3</p><p>é•¿æ•´æ•°long  1112L</p><p>æµ®ç‚¹æ•°float ï¼ˆå°æ•°ï¼‰1.23ï¼Œ3.14</p><p>å¤æ•°complex  3.14j</p></li><li><p><strong>å­—ç¬¦ä¸²</strong></p><p> â€˜abcâ€™ï¼Œâ€abcâ€ï¼Œâ€™â€™â€™abcâ€˜â€™â€˜</p><p>â€˜xâ€™å’Œâ€xâ€ åŒºåˆ«ä¸å¤§</p><p>â€˜â€™â€™abcâ€˜â€™â€˜ æ–‡æœ¬å¯ä»¥è·¨è¡Œ</p><p>å­—ç¬¦ä¸²å‰é¢åŠ ræˆ–è€…Rè¡¨ç¤ºå­—ç¬¦ä¸²å†…éƒ¨ä¸éœ€è¦è½¬ä¹‰ï¼Œå¦åˆ™è¦ç”¨<code>\</code> è½¬ä¹‰</p><p>æ”¯æŒ<code>a[0]</code>å–å€¼</p></li><li><p><strong>å¸ƒå°”å€¼</strong></p><p> <code>True</code> å’Œ<code>False</code></p><p>å¸ƒå°”å€¼å¯ä»¥ç”¨<code>and</code>ã€<code>or</code>å’Œ<code>not</code>è¿ç®—</p></li><li><p><strong>ç©ºå€¼</strong></p><p> <code>None</code></p></li><li><p><strong>å˜é‡</strong> </p><p>å‘½åè§„åˆ™ï¼šå¼€å¤´<code>aA_</code>ï¼Œå…¶åå¯ä»¥åŒ…å«<code>aA_1</code></p></li><li><p><strong>å¸¸é‡</strong></p><p> ä¸èƒ½å˜çš„å˜é‡</p></li></ul><h1 id="é›†åˆ"><a href="#é›†åˆ" class="headerlink" title="é›†åˆ"></a>é›†åˆ</h1><ul><li><p><strong>åˆ—è¡¨list</strong></p><p> [1,2,3,3]</p><p>æ’å…¥list.insert(1,â€™vauleâ€™)</p><p>åˆ é™¤list.pop() / list.pop(1)</p></li><li><p><strong>å…ƒç»„tuple </strong></p><p>(1,2,3,3)</p><p>ä¸åˆ—è¡¨ç±»ä¼¼ï¼Œä½†æ˜¯ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½å†ä¿®æ”¹</p><hr></li><li><p><strong>å­—å…¸dict</strong></p><p> {â€˜aâ€™:1,â€™bâ€™:â€™vauleâ€™}</p><p>é”®å€¼å¯¹ï¼Œè¯»å–å¿«ï¼Œç›¸å½“äºjavaçš„map</p></li><li><p><strong>set</strong></p><p> set([1,2,3])</p><p>é”®çš„é›†åˆï¼Œä¸èƒ½æœ‰é‡å¤çš„ï¼Œç›¸å½“äºjavaçš„set</p></li></ul><h1 id="é€»è¾‘è¯­å¥"><a href="#é€»è¾‘è¯­å¥" class="headerlink" title="é€»è¾‘è¯­å¥"></a>é€»è¾‘è¯­å¥</h1><ul><li>if â€¦ : â€¦ elif â€¦ : â€¦ else : â€¦</li><li>for x in xs : â€¦</li><li>while x : â€¦</li></ul><h1 id="è‡ªå®šä¹‰å‡½æ•°"><a href="#è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="è‡ªå®šä¹‰å‡½æ•°"></a>è‡ªå®šä¹‰å‡½æ•°</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(n)</span></span></span><br><span class="line"><span class="function"><span class="title">return</span> <span class="title">n</span></span></span><br></pre></td></tr></table></figure><ul><li><strong>return</strong></li></ul><p>å¯ä»¥æ²¡æœ‰returnï¼Œé»˜è®¤è¿”å›None</p><p>å¯ä»¥return å¤šä¸ªå€¼ï¼Œå®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ªtuple</p><ul><li><p><strong>pass</strong></p><p>ä¸æƒ³æ‰§è¡Œä»»ä½•è¯­å¥ï¼Œä½†æ˜¯ä¸ºäº†ç¬¦åˆè¯­æ³•è§„èŒƒï¼Œå¯ä»¥ç”¨passå½“åšå ä½ç¬¦</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">pass</span></span></span><br></pre></td></tr></table></figure><ul><li><strong>æŠ›å‡ºå¼‚å¸¸</strong> </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">raise</span> TypeError(<span class="string">'an error'</span>)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­TypeErroréœ€è¦ç»§æ‰¿è‡ª<code>error</code>æˆ–è€…<code>Exception</code></p><ul><li><strong>å‚æ•°</strong></li></ul><p>ä½ç½®å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(arg)</span></span></span><br><span class="line"><span class="function"><span class="title">pass</span></span></span><br></pre></td></tr></table></figure><p>é»˜è®¤å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(arg0,arg1 = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">pass</span></span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong> é»˜è®¤å‚æ•°å¿…é¡»æ˜¯å‚æ•°ä¸­åé¢çš„å‡ ä½ï¼›é»˜è®¤å€¼å¿…é¡»ä¸å¯å˜ï¼Œå¦‚intï¼Œstringç­‰</p><p>å¯å˜å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(arg,*args)</span></span></span><br><span class="line"><span class="function"><span class="title">pass</span></span></span><br></pre></td></tr></table></figure><p><code>*args</code> è¡¨ç¤ºå‚æ•°ä¸ªæ•°å¯å˜ï¼Œå¯ä»¥è¾“å…¥list/tupleç­‰ï¼Œæˆ–è€…ä¾æ¬¡è¾“å…¥å¤šä¸ªå‚æ•°ï¼Œç”¨é€—å·åˆ†éš”</p><p>å…³é”®è¯å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(arg,**keywords)</span></span></span><br><span class="line"><span class="function"><span class="title">if</span> '<span class="title">city</span>' <span class="title">in</span> <span class="title">kw</span>:</span></span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p><code>**keywords</code> è¡¨ç¤ºæ¥å—å…³é”®è¯ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¯ä»¥ä¼ å…¥dictï¼Œæˆ–è€…ä¾æ¬¡è¾“å…¥å¤šä¸ªå…³é”®è¯å‚æ•°</p><p>å‘½åå…³é”®è¯å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun0</span><span class="params">(args,*ï¼Œname,age)</span></span></span><br><span class="line"><span class="function"><span class="title">pass</span></span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">fun1</span><span class="params">(arg.*args,name,age)</span>#å¦‚æœå‘½åå…³é”®è¯å‰é¢æœ‰å¯å˜å‚æ•°ï¼Œåˆ™ä¸ç”¨*åˆ†éš”</span></span><br><span class="line"><span class="function"><span class="title">pass</span></span></span><br></pre></td></tr></table></figure><p>é™åˆ¶è¾“å…¥çš„å…³é”®å­—ï¼Œé™åˆ¶åªæœ‰nameå’Œageä½œä¸ºå…³é”®è¯å‚æ•°</p><h1 id="ä½¿ç”¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°"><a href="#ä½¿ç”¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°" class="headerlink" title="ä½¿ç”¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°"></a>ä½¿ç”¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä½¿ç”¨æ—¶ sys.fun()</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment">#ä½¿ç”¨æ—¶ç›´æ¥fun()</span></span><br><span class="line"><span class="keyword">from</span> xxFile <span class="keyword">import</span> fun</span><br><span class="line">form sys <span class="keyword">import</span> *</span><br><span class="line">form sys <span class="keyword">import</span> fun</span><br></pre></td></tr></table></figure><h1 id="ç±»"><a href="#ç±»" class="headerlink" title="ç±»"></a>ç±»</h1><ul><li><strong>å®šä¹‰ç±»</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AClass</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="string">'''doc for AClass</span></span><br><span class="line"><span class="string">you can use this by</span></span><br><span class="line"><span class="string">AClass.__doc__'''</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">  <span class="comment">#é»˜è®¤çš„åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">aFun</span><span class="params">(self)</span>:</span></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"><span class="comment">#åˆ›å»ºç±»å¯¹è±¡</span></span><br><span class="line">a = AClass()</span><br><span class="line"><span class="comment">#è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">a.aFun()</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰çš„ç±»æ–¹æ³•å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ¨èå‘½åä¸ºselfï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¼ å…¥ç±»å¯¹è±¡ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ å…¥ã€‚</p><ul><li><strong>ç»§æ‰¿</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(<span class="string">"father"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(<span class="string">"i am f"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(Father)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment">#å­ç±»æ–¹æ³•ä¸ä¼šè‡ªå·±è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨</span></span><br><span class="line">    super(Child,self).__init__()</span><br><span class="line">    <span class="comment">#è°ƒç”¨çˆ¶ç±»æ–¹æ³•2ï¼š</span></span><br><span class="line">    <span class="comment">#Father.__init__(self)</span></span><br><span class="line">    print(<span class="string">"child"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(<span class="string">'i am c'</span>)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(self,where)</span>:</span></span><br><span class="line">    print(<span class="string">'go to %s'</span>%where)</span><br><span class="line"></span><br><span class="line">c = Child() <span class="comment">#father child</span></span><br><span class="line">c.say() <span class="comment">#i am c</span></span><br><span class="line">c.go(<span class="string">'home'</span>) <span class="comment">#go ro home</span></span><br></pre></td></tr></table></figure><p>å­ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œåˆ™éœ€è¦åœ¨å­ç±»å®šä¹‰æ—¶ä¼ å…¥çˆ¶ç±»</p><p>å­ç±»å¦‚æœæœ‰ä¸çˆ¶ç±»åŒåæ–¹æ³•ï¼Œåˆ™ä¼˜å…ˆè°ƒç”¨å­ç±»æ–¹æ³•ï¼Œé™¤éå­ç±»ç‰¹åˆ«è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaåå°„ç®€å•åº”ç”¨</title>
      <link href="/blog/posts/3e9e8cb1/"/>
      <url>/blog/posts/3e9e8cb1/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>åå°„ï¼Œç”¨æ¥åœ¨è¿è¡Œæ—¶è·å–ç»™å®šç±»çš„æ„é€ å‡½æ•°ï¼Œå˜é‡ï¼Œæ–¹æ³•ï¼Œå¹¶å¯¹å…¶ä½œä»¥ä¿®æ”¹ï¼Œè€Œä¸å¿…åœ¨ç¼–è¯‘æ—¶è·å–è¯¥ç±»ã€‚</p><blockquote><p>Reflection allows programmatic access to information about the fields, methods and constructors of loaded classes, and the use of reflected fields, methods, and constructors to operate on their underlying counterparts, within security restrictions.</p><p>â€“<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/package-summary.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/package-summary.html</a></p></blockquote><h1 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h1><p>å®šä¹‰ä¸€ä¸ªå¾…åå°„çš„ç±»ATestClass.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cf.android666.reflect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ATestClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String name;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ATestClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">" age: "</span> + age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨TestReflect.javaä¸­åå°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¸å¿ƒä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line"><span class="comment">//æ³¨æ„è¿™é‡Œéœ€è¦æ˜¯å®Œæ•´çš„ç±»åï¼ŒåŒ…æ‹¬åŒ…å</span></span><br><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">"cf.android666.reflect.ATestClass"</span>);</span><br><span class="line">ATestClass aTestClsObj=(ATestClass) clazz.newInstance();</span><br><span class="line">  </span><br><span class="line"><span class="comment">//åå°„è·å–å˜é‡</span></span><br><span class="line">Field mName = clazz.getDeclaredField(<span class="string">"name"</span>);</span><br><span class="line">mName.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">mName.set(aTestClsObj, <span class="string">"aReflect"</span>);</span><br><span class="line">System.out.println(aTestClsObj.name);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åå°„è·å–æ–¹æ³•</span></span><br><span class="line">Method mInit= clazz.getDeclaredMethod(<span class="string">"init"</span>, String<span class="class">.<span class="keyword">class</span>,<span class="title">int</span>.<span class="title">class</span>)</span>;</span><br><span class="line">mInit.setAccessible(<span class="keyword">true</span>);<span class="comment">//è§£é™¤ç§æœ‰é™å®šï¼Œè®©æˆ‘ä»¬åœ¨ç”¨åå°„æ—¶è®¿é—®ç§æœ‰å˜é‡</span></span><br><span class="line">mInit.invoke(aTestClsObj, <span class="string">"aInitName"</span>,<span class="number">66</span>);</span><br><span class="line">System.out.println(aTestClsObj.name + aTestClsObj.getAge());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>åå°„çš„ç”¨æ³•è¾ƒä¸ºç®€å•</p><ul><li>é€šè¿‡<code>Class.froName()</code> è·å–Classå¯¹è±¡<code>clazz</code> ï¼Œè·å–è¦åå°„çš„Classå¯¹è±¡<code>aTestClsObj</code> </li><li>é€šè¿‡<code>clazz</code> è·å–è¦åå°„Classçš„å˜é‡ã€æ–¹æ³•</li><li>é€šè¿‡<code>aTestClsObj</code> æ“ä½œè¿™äº›å˜é‡ï¼Œæ–¹æ³•</li></ul><p>å…¶ä¸­éœ€è¦æ³¨æ„çš„æœ‰</p><ul><li><code>f.setAccessible(true);</code> æ–¹æ³•å¯ä»¥è§£é™¤<code>private</code> é™åˆ¶ï¼Œè¿›è€Œå¯ä»¥æ“ä½œç±»çš„ç§æœ‰å˜é‡ï¼Œæ–¹æ³•</li><li><code>clazz.getXXX()</code> æ–¹æ³•è·å–<strong>å…¨éƒ¨å…¬æœ‰</strong>å˜é‡ã€æ–¹æ³• ï¼Œ<strong>åŒ…æ‹¬çˆ¶ç±»æˆ–æ¥å£</strong>çš„xxï¼Œ<code>clazz.getDeclaredXXX()</code> æ–¹æ³•è·å–<strong>å…¨éƒ¨</strong> å˜é‡ã€æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰çš„ï¼Œå®ç°æ¥å£çš„æ–¹æ³•ï¼Œ<strong>ä½†æ˜¯ä¸åŒ…æ‹¬çˆ¶ç±»çš„</strong></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidé€šè¿‡Hookå¯åŠ¨æœªæ³¨å†ŒActivity</title>
      <link href="/blog/posts/26eab50a/"/>
      <url>/blog/posts/26eab50a/</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>hookæ˜¯é’©å­çš„æ„æ€ï¼Œhookçš„è¿‡ç¨‹æ˜¯é€šè¿‡åå°„ã€ä»£ç†ç­‰æ”¹å˜ç³»ç»ŸåŸæœ‰çš„è¡Œä¸ºä»¥è¾¾åˆ°è‡ªå·±çš„ç›®çš„ã€‚</p><p>æœ¬æ–‡ä¸»è¦æ˜¯é€šè¿‡hook android ä¸­çš„ActivityManagerServiceå’ŒHandler.CallBackï¼Œæ¬ºéª—ç³»ç»Ÿè°ƒèµ·activityçš„è¿‡ç¨‹ï¼Œåœ¨è°ƒç”¨startActivityæ—¶å°†targetIntenté€šè¿‡proxyä¼ªè£…ä¸ºproxyIntentï¼Œç­‰åˆ°é€šè¿‡ç³»ç»ŸéªŒè¯ï¼Œæ­£å¼å¯åŠ¨activityæ—¶ï¼Œå†è®²proxyIntentæ¢å¤ä¸ºtargetIntentï¼Œä»è€Œå®ç°è°ƒç”¨æœªåœ¨AndroidManifest.xmlä¸­æ³¨å†Œçš„activityã€‚</p><blockquote><p>éœ€è¦æ³¨æ„ï¼Œæœ¬æ–¹æ³•åªåœ¨Api&lt;26ä¸‹æœ‰æ•ˆã€‚å…·ä½“åŸå› è§åé¢ã€‚</p></blockquote><h1 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h1><h2 id="1-æ–°å»ºActivityç­‰"><a href="#1-æ–°å»ºActivityç­‰" class="headerlink" title="1.æ–°å»ºActivityç­‰"></a>1.æ–°å»ºActivityç­‰</h2><p><code>IndexActivity.java</code>ç”¨äºå¯åŠ¨<code>targetIntent</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">((Button)findViewById(R.id.btn1)).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">               <span class="comment">//å¯åŠ¨æœªåœ¨AndroidManifest.xmlæ³¨å†Œçš„activity</span></span><br><span class="line">               mContext.startActivity(<span class="keyword">new</span> Intent(mContext,TargetActivity<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><p><code>TargetActivity.java</code> å’Œ<code>ProxyActivity.java</code> åˆ†åˆ«è®¾ç½®å¯¹åº”é¡µé¢å¸ƒå±€<code>setContentView(R.layout.activity_xxx);</code></p><p><code>HookApplication.java</code> ç”¨äºè°ƒç”¨hookæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Utils.hookAms(<span class="keyword">this</span>);</span><br><span class="line">        Utils.hookHandle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>AndroidManifest.xml</code>ä¸­æ³¨å†Œ<code>IndexActivity</code>å’Œ<code>ProxyActivity</code>ï¼ŒApplicationä½¿ç”¨<code>HookApplication</code>ã€‚</p><h2 id="2-Utils-javaå®ç°hookå…·ä½“é€»è¾‘"><a href="#2-Utils-javaå®ç°hookå…·ä½“é€»è¾‘" class="headerlink" title="2.Utils.javaå®ç°hookå…·ä½“é€»è¾‘"></a>2.Utils.javaå®ç°hookå…·ä½“é€»è¾‘</h2><p><code>Utils.hookAms()</code> å®ç°æ‹¦æˆªtargetIntentå¹¶å‘èµ·proxyIntentï¼Œæ¬ºéª—ç³»ç»Ÿå¯¹activityæ˜¯å¦å·²æ³¨å†Œçš„éªŒè¯ï¼Œå…¶ä¸­proxyIntenté€šè¿‡<code>proxyIntent.putExtra(TARGET_KEY, targetIntent);</code> æ–¹æ³•æºå¸¦targetIntentã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hookAms()æ ¸å¿ƒä»£ç </span></span><br><span class="line">Class hookActivityManagerNative = Class.forName(<span class="string">"android.app.ActivityManagerNative"</span>);</span><br><span class="line">            <span class="comment">//åœ¨api&gt;26æ—¶æ— æ­¤å˜é‡ï¼šgDefaultï¼Œè¯¥æ–¹æ³•å¤±æ•ˆ</span></span><br><span class="line">            Field gDefault = hookActivityManagerNative.getDeclaredField(<span class="string">"gDefault"</span>);</span><br><span class="line">            gDefault.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object object = gDefault.get(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            Class hookSingleton = Class.forName(<span class="string">"android.util.Singleton"</span>);</span><br><span class="line">            Field mInstance = hookSingleton.getDeclaredField(<span class="string">"mInstance"</span>);</span><br><span class="line">            mInstance.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            Object oldAms = mInstance.get(object);</span><br><span class="line"></span><br><span class="line">            Class hookIActivityManagerService = Class.forName(<span class="string">"android.app.IActivityManager"</span>);</span><br><span class="line">            Object proxy = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class="line">                    <span class="keyword">new</span> Class&lt;?&gt;[]&#123;hookIActivityManagerService&#125;,</span><br><span class="line">                    <span class="keyword">new</span> MAmsInvocationHandler(context,oldAms));</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†åŸæœ‰çš„ActivityManagerServiceæ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„</span></span><br><span class="line">            mInstance.set(object,proxy);</span><br></pre></td></tr></table></figure><p>åœ¨<code>MAmsInvocationHandler</code> é‡Œé¢å®ç°targetIntentå’Œproxyçš„è½¬æ¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MAmsInvocationHandleræ ¸å¿ƒä»£ç </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MAmsInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_KEY = <span class="string">"targetIntent"</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"startActivity"</span>.equals(method.getName())) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            Intent targetIntent = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> Intent) &#123;</span><br><span class="line">                    index = i;</span><br><span class="line">                    targetIntent = (Intent) args[i];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (targetIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Intent proxyIntent = <span class="keyword">new</span> Intent(mContext, ProxyActivity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                proxyIntent.putExtra(TARGET_KEY, targetIntent);</span><br><span class="line">                args[index] = proxyIntent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(mOldAms,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå·²ç»å¯¹activity.startActivityåšäº†æ‹¦æˆªï¼Œæ‰€æœ‰çš„targetIntentéƒ½ä¼šè¢«æ‹¦æˆªï¼Œå­˜å‚¨åœ¨proxyIntentä¸­ï¼Œä»¥é€šè¿‡ç³»ç»Ÿçš„æ£€æŸ¥ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ç³»ç»Ÿæ£€æŸ¥åï¼Œ<code>hookHandle()</code>é€šè¿‡é‡å†™Handler.CallBackï¼Œå¯¹å¯åŠ¨proxyIntentäº‹ä»¶åšæ‹¦æˆªï¼Œä½¿ä¹‹å¯åŠ¨targetIntentå¯¹åº”çš„Activityã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hookHandle()æ ¸å¿ƒä»£ç </span></span><br><span class="line">Class activityThreadCls = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">Method currentActivityThread = activityThreadCls.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">currentActivityThread.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">Object activityThread = currentActivityThread.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">Field mH = activityThreadCls.getDeclaredField(<span class="string">"mH"</span>);</span><br><span class="line">mH.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Handler handler = (Handler) mH.get(activityThread);</span><br><span class="line">Field callBack = Handler.class.getDeclaredField("mCallback");</span><br><span class="line">callBack.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">callBack.set(handler, <span class="keyword">new</span> ActivityThreadHandlerCallBack(handler));</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>ActivityThreadHandlerCallBack</code> å°†è¿”å›æˆ‘ä»¬è‡ªå®šä¹‰çš„CallBackä»¥æ›¿æ¢ç³»ç»Ÿçš„ï¼Œå®ç°å¯åŠ¨targetIntentè€ŒéproxyIntentã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityThreadHandlerCallBackæ ¸å¿ƒä»£ç </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThreadHandlerCallBack</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span></span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.what == <span class="number">100</span>) &#123;</span><br><span class="line">            handleLaunchActivity(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        mHandler.handleMessage(msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ä¸»è¦ä»£ç ï¼Œåœ¨è¿™é‡Œå°†proxyIntentè½¬åŒ–ä¸ºtargetIntent</span></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        Object object = msg.obj;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field intent = object.getClass().getDeclaredField(<span class="string">"intent"</span>);</span><br><span class="line">            intent.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Intent proxyIntent = (Intent) intent.get(object);</span><br><span class="line">            Intent targetIntent = proxyIntent.getParcelableExtra(MAmsInvocationHandler.TARGET_KEY);</span><br><span class="line">            <span class="keyword">if</span> (targetIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                proxyIntent.setComponent(targetIntent.getComponent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œå°±å®ç°äº†å¯åŠ¨é€šè¿‡å·²ç»æ³¨å†Œäº†çš„ProxyActivityå¯åŠ¨æœªæ³¨å†ŒTargetActivityçš„å…¨è¿‡ç¨‹ã€‚</p><p>ä¸»è¦æ€æƒ³æ˜¯æ‰¾åˆ°ç³»ç»Ÿå®ç°è¯¥è¿‡ç¨‹çš„é€»è¾‘ï¼Œåœ¨å¯¹åº”åœ°æ–¹é€šè¿‡åå°„è·å–åˆ°å¯¹åº”å˜é‡ï¼Œæ’å…¥è‡ªå·±çš„é€»è¾‘ï¼Œä»è€Œè¾¾åˆ°ç›®çš„ã€‚</p><h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><p>ä¸Šé¢æ¶‰åŠåˆ°çš„ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/jixiaoyong/AndroidNote/tree/master/code/AndroidHook/20180116" target="_blank" rel="noopener">githubæºä»£ç è·¯å¾„</a></p><p>å‚è€ƒäº†å‡ ç¯‡æ–‡ç« ï¼Œå…¶ä¸­è¾ƒä¸ºå®Œæ•´çš„ä¸€ç¯‡å¦‚ä¸‹ï¼š</p><p><a href="https://www.jianshu.com/p/69bfbda302df" target="_blank" rel="noopener">Androidæ’ä»¶åŒ–ç³»åˆ—ç¬¬ï¼ˆä¸€ï¼‰ç¯‡â€”HookæŠ€æœ¯ä¹‹Activityçš„å¯åŠ¨è¿‡ç¨‹æ‹¦æˆª</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AndroidServiceç›¸å…³çŸ¥è¯†</title>
      <link href="/blog/posts/ad4c562c/"/>
      <url>/blog/posts/ad4c562c/</url>
      
        <content type="html"><![CDATA[<h2 id="å¯åŠ¨ä¸€ä¸ªService"><a href="#å¯åŠ¨ä¸€ä¸ªService" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªService"></a>å¯åŠ¨ä¸€ä¸ªService</h2><ul><li><p>MyServices.java</p><p>å¿…é¡»ç»§æ‰¿è‡ªServiceï¼Œæˆ–è€…å¦‚IntentServiceæœ¬èº«å°±æ˜¯ç­‰å…¶å­ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServices</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"TAG"</span>,<span class="string">"onBind"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.d(<span class="string">"TAG"</span>,<span class="string">"onCreate"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.d(<span class="string">"TAG"</span>, <span class="string">"onDestroy: "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>AndroidManifest.xml</p><p>æ³¨å†ŒMyServices</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".MyServices"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"cf.android666.myservices"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>MainActivity.java</p><p>åœ¨javaä¸­è°ƒç”¨Serviceï¼Œéœ€è¦<code>ServiceConnection</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"onServiceConnected: æœåŠ¡ç»‘å®š"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"onServiceDisconnected: æœåŠ¡è§£ç»‘"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">Intent intent = <span class="keyword">new</span> Intent(context, MyServices<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">bindService(intent, mConnection, Service.BIND_AUTO_CREATE);<span class="comment">//ç»‘å®šService</span></span><br><span class="line"><span class="comment">//startService(intent); å¯åŠ¨service</span></span><br><span class="line">unbindService(mConnection);<span class="comment">//è§£ç»‘Service</span></span><br></pre></td></tr></table></figure><p><code>bindService()</code>å’Œ<code>startService()</code>çš„åŒºåˆ«åœ¨äºï¼š</p><p>** <code>bindService()</code>å°†serviceå’Œå½“å‰çš„activityç»‘å®šåœ¨ä¸€èµ·ï¼Œactivityé”€æ¯æ—¶ï¼Œserviceä¹Ÿä¼šè¢«é”€æ¯ï¼›</p><p>** <code>startService()</code>åˆ™åªæ˜¯â€œå¯åŠ¨â€serviceï¼Œåœ¨æ­¤åserviceçš„æ´»åŠ¨å’Œactivityæ— å…³ï¼Œå¹¶ä¸€ç›´å­˜æ´»ã€‚</p></li></ul><h1 id="Serviceå…·ä½“åˆ†æ"><a href="#Serviceå…·ä½“åˆ†æ" class="headerlink" title="Serviceå…·ä½“åˆ†æ"></a>Serviceå…·ä½“åˆ†æ</h1><p>Serviceåœ¨AndroidManifest.xmlä¸­çš„å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android:name=<span class="string">".MyService"</span><span class="comment">//å¿…é¡»è¢«æŒ‡å®š</span></span><br><span class="line">android:exported=<span class="keyword">true</span>/<span class="keyword">false</span> <span class="comment">//æ˜¯å¦èƒ½è¢«å…¶ä»–åº”ç”¨éšå¼è°ƒç”¨</span></span><br><span class="line"><span class="comment">//æœ‰intent-filteråˆ™é»˜è®¤ä¸ºtrueï¼Œå¦åˆ™é»˜è®¤falseï¼›è‹¥æ‰‹åŠ¨æŒ‡å®šä¸ºfalseåˆ™å³ä½¿æœ‰intent-filterä¹Ÿæ— æ³•éšå¼è°ƒç”¨</span></span><br><span class="line">android:process=<span class="string">"remote"</span>/<span class="string">":remote"</span><span class="comment">//å‰è€…åœ¨å…±æœ‰çš„è¿›ç¨‹ä¸­è¿›è¡Œï¼Œåè€…åœ¨åå­—ä¸º&#123;packageName&#125;:remote çš„ç§æœ‰è¿›ç¨‹ä¸­è¿›è¡Œï¼Œå…¶ä»–è¿›è¡Œä¸å¯è®¿é—®ï¼›å¦‚æœä¸è®¾ç½®è¯¥å±æ€§ï¼Œåˆ™serviceåœ¨åº”ç”¨è‡ªå·±çš„è¿›ç¨‹é‡Œé¢è¿è¡Œ</span></span><br></pre></td></tr></table></figure><p>Serviceé»˜è®¤è¿è¡Œåœ¨åˆ›å»ºä»–çš„çº¿ç¨‹ä¸­ï¼Œè¦æ˜¯è¿›è¡Œè€—æ—¶æ“ä½œï¼Œæœ€å¥½åœ¨serviceä¸­å•ç‹¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å­å¯ä»¥åœ¨å­çº¿ç¨‹å·¥ä½œï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°å·¥ä½œè¿›åº¦ã€‚</p><p>Serviceä¸­çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨åˆæ¬¡åˆ›å»ºæœåŠ¡æ—¶è°ƒç”¨ï¼Œå¹¶ä¸”ç›´è‡³æœåŠ¡æ­»äº¡ï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//åœ¨ç»‘å®šæœåŠ¡æ˜¯æ‰ä¼šè¢«è°ƒç”¨ï¼Œå¿…é¡»å®ç°è¯¥æ–¹æ³•</span></span></span><br><span class="line"><span class="function">IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function"><span class="comment">//æ¯ä¸€æ¬¡é€šè¿‡startService()æ–¹æ³•å¯åŠ¨Serviceçš„æ—¶å€™éƒ½ä¼šè¢«è°ƒç”¨</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span></span></span><br><span class="line"><span class="function">  <span class="comment">//1.intent å¯åŠ¨æ—¶ï¼Œå¯åŠ¨ç»„ä»¶ä¼ é€’è¿‡æ¥çš„Intent</span></span></span><br><span class="line"><span class="function">  <span class="comment">//2.flags è¡¨ç¤ºå¯åŠ¨è¯·æ±‚æ—¶æ˜¯å¦æœ‰é¢å¤–æ•°æ®ï¼Œå¯ä»¥æ˜¯ï¼š</span></span></span><br><span class="line"><span class="function">  <span class="comment">//  0ï¼šæ— </span></span></span><br><span class="line"><span class="function">  <span class="comment">//  START_FLAG_REDELIVERYï¼šè¡¨ç¤ºè¯¥æ–¹æ³•è¿”å›å€¼ä¸ºSTART_REDELIVER_INTENTï¼Œåœ¨ä¸Šä¸ªæœåŠ¡è¢«æ€æ­»ä¹‹å‰è°ƒç”¨stopSelf()åœæ­¢æœåŠ¡</span></span></span><br><span class="line"><span class="function">  <span class="comment">//  START_FLAG_RETRYï¼šåœ¨onStartCommand()è¢«è°ƒç”¨åä¸€ç›´æ— è¿”å›å€¼æ—¶ï¼Œä¼šå°è¯•é‡æ–°è°ƒç”¨onStartCommand()</span></span></span><br><span class="line"><span class="function">  <span class="comment">//3.å½“å‰æœåŠ¡id</span></span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>onStartCommand()</code>æ–¹æ³•çš„è¿”å›å€¼æ„ä¹‰å¦‚ä¸‹ï¼š</p><p><code>START_STICKY</code>:serviceåœ¨å†…å­˜ä¸è¶³è¢«æ€æ­»åï¼Œå†…å­˜ç©ºé—²æ—¶ç³»ç»Ÿä¼šé‡æ–°åˆ›å»ºserviceï¼Œä¸€æ—¦æˆåŠŸåˆ›å»ºä¼šå›è°ƒ<code>onStartCommand()</code>æ–¹æ³•ï¼Œæ­¤æ—¶intentæ˜¯nullï¼Œé™¤éæ˜¯æŒ‚èµ·çš„intentå¦‚pendingintentï¼Œæ— é™æœŸè¿è¡Œ</p><p><code>START_NOT_STICKY</code>ï¼šserviceå› å†…å­˜ä¸è¶³è¢«æ€æ­»ï¼Œå†…å­˜å†æ¬¡ç©ºé—²ç³»ç»Ÿä¹Ÿä¸ä¼šå†é‡æ–°åˆ›å»ºæœåŠ¡ï¼Œæœ€å®‰å…¨</p><p><code>START_REDELIVER_INTENT</code>ï¼šserviceå› å†…å­˜ä¸è¶³è¢«æ€æ­»ï¼Œä¼šé‡å»ºæœåŠ¡å¹¶ä¼ é€’ç»™æœ€åä¸€ä¸ªintentï¼ˆæœ€åä¸€æ¬¡è°ƒç”¨<code>startService()</code> æ—¶çš„intentï¼‰ï¼Œç”¨äºè¿ç»­ä½œä¸šï¼Œå¦‚ä¸‹è½½ç­‰</p><h2 id="Serviceç»‘å®šæœåŠ¡çš„ä¸‰ç§æ–¹å¼"><a href="#Serviceç»‘å®šæœåŠ¡çš„ä¸‰ç§æ–¹å¼" class="headerlink" title="Serviceç»‘å®šæœåŠ¡çš„ä¸‰ç§æ–¹å¼"></a>Serviceç»‘å®šæœåŠ¡çš„ä¸‰ç§æ–¹å¼</h2><h3 id="1-æ‹“å±•Binderç±»"><a href="#1-æ‹“å±•Binderç±»" class="headerlink" title="1.æ‹“å±•Binderç±»"></a>1.æ‹“å±•Binderç±»</h3><p><strong>è¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡åœ¨åŒä¸€åº”ç”¨çš„åŒä¸€è¿›ç¨‹å†…</strong>ã€‚å®¢æˆ·ç«¯é€šè¿‡å…¶è®¿é—®serviceä¸­çš„å…¬å…±æ–¹æ³•ã€‚</p><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºBindServiceæœåŠ¡ç«¯ï¼Œåœ¨ç±»ä¸­åˆ›å»ºä¸€ä¸ªå®ç°äº†IBinderæ¥å£çš„å®åŠ›å¯¹è±¡å¹¶æä¾›å…¬å…±æ–¹æ³•ç»™å®¢æˆ·ç«¯ä½¿ç”¨</li><li>åœ¨onBind()å›è°ƒæ–¹æ³•è¿”å›æ­¤Binderå®ä¾‹</li><li>åœ¨å®¢æˆ·ç«¯çš„onServiceConnected()æ–¹æ³•æ¥æ”¶Binderï¼Œä½¿ç”¨æä¾›çš„æ–¹æ³•ç»‘å®šæœåŠ¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//serviceæœåŠ¡ç«¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">  LocalService mService;</span><br><span class="line">  <span class="keyword">private</span> LocalBinder binder = <span class="keyword">new</span> LocalBinder();</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> binder;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomeThing</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//æœåŠ¡ä¸­å…¬å…±æ–¹æ³•ï¼Œå¯ä»¥è¢«å®¢æˆ·ç«¯é€šè¿‡IBInderè·å–å®ä¾‹è°ƒç”¨</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span></span>&#123;</span><br><span class="line">    <span class="function">LocalService <span class="title">getService</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BindActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(...)</span></span>&#123;</span><br><span class="line">    ServiceConnection conn = <span class="keyword">new</span> ServiceConnection()&#123;</span><br><span class="line">      <span class="comment">//ç»‘å®šæœåŠ¡æ—¶è¢«è°ƒç”¨ï¼Œå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº¤äº’ï¼ˆIBinderï¼‰</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span></span>&#123;</span><br><span class="line">        LocalService.LocalBinder binder = (LocalService.LocalBinder)service;<span class="comment">//è·å–æœåŠ¡ç«¯IBinder</span></span><br><span class="line">        mService = binder.getService();<span class="comment">//è·å–æœåŠ¡å®ä¾‹ï¼Œä»¥è°ƒç”¨æœåŠ¡çš„å…¬å…±æ–¹æ³•</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//å–æ¶ˆç»‘å®šæ—¶å›è°ƒï¼Œå¤šæ•°æ—¶å€™æ˜¯serviceè¢«æ„å¤–é”€æ¯ï¼Œå¦‚å†…å­˜ä¸è¶³</span></span><br><span class="line">      <span class="comment">//å½“å®¢æˆ·ç«¯å–æ¶ˆç»‘å®šæ—¶ï¼Œç³»ç»Ÿâ€œç»å¯¹ä¸ä¼šâ€è°ƒç”¨è¯¥æ–¹æ³•ã€‚</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span></span>&#123;</span><br><span class="line">        mService = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//åˆ›å»ºç»‘å®šå¯¹è±¡</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>,LocalService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">//ç»‘å®šæœåŠ¡</span></span><br><span class="line">    <span class="comment">//å‚æ•°3 flagsåˆ™æ˜¯æŒ‡å®šç»‘å®šæ—¶æ˜¯å¦è‡ªåŠ¨åˆ›å»ºServiceã€‚0ä»£è¡¨ä¸è‡ªåŠ¨åˆ›å»ºã€BIND_AUTO_CREATEåˆ™ä»£è¡¨è‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">    bindService(intent,conn,Service.BIND_AUTO_CREATE);</span><br><span class="line">    <span class="comment">//è°ƒç”¨æœåŠ¡ä¸­çš„æ–¹æ³•ï¼Œæœ€å¥½å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºnull</span></span><br><span class="line">    mService.doSomeThing();</span><br><span class="line">    <span class="comment">//è§£é™¤ç»‘å®š</span></span><br><span class="line">    unbindService(conn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-Messenger"><a href="#2-Messenger" class="headerlink" title="2.Messenger"></a>2.Messenger</h3><p><strong>serviceä¸ä¸åŒè¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰</strong> ã€‚</p><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>Serviceå®ç°ä¸€ä¸ªHandlerï¼Œæ¥æ”¶å®¢æˆ·ç«¯æ¯ä¸ªè°ƒç”¨çš„å›è°ƒ</li><li>ç”¨Handleråˆ›å»ºMessengerå¯¹è±¡</li><li>ç”¨Messengeråˆ›å»ºIBinderå¯¹è±¡ï¼Œå¹¶é€šè¿‡onBind()è¿”å›å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯ä½¿ç”¨IBinderå®ä¾‹åŒ–Messengerï¼Œç”¨å…¶å°†Messageå¯¹è±¡å‘é€ç»™Service</li><li>Serviceåœ¨Handleræ¥æ”¶å¹¶å¤„ç†Message</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MSG_WHAT = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">//åˆ›å»ºHandleræ¥æ”¶ã€å¤„ç†å®¢æˆ·ç«¯msg</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">IncomingHanler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>&#123;</span><br><span class="line">      <span class="comment">//do sth with msg...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Messenger messenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHanlder());</span><br><span class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> messenger.getBinder();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">//onCreate()æ–¹æ³•ä¸­ï¼š</span></span><br><span class="line">mConnection = <span class="keyword">new</span> ServiceConnection()&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName className, IBinder service)</span></span>&#123;</span><br><span class="line">    Messenger mService = <span class="keyword">new</span> Messenger(service);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//ç»™æœåŠ¡å‘æ¶ˆæ¯</span></span><br><span class="line">Message msg = Message.obtain(<span class="keyword">null</span>,MessengerService.MSG_WHAT,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">mService.send(msg);</span><br></pre></td></tr></table></figure><p>æ³¨æ„serviceè¦åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AndroidMinafast.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".messenger.MessengerService"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">":remote"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æœåŠ¡ä¸å®¢æˆ·ç«¯åŒå‘é€šä¿¡</strong></p><p>æœåŠ¡ç«¯ï¼Œä¿®æ”¹IncomingHandlerï¼Œå›å¤å®¢æˆ·ç«¯æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>&#123;</span><br><span class="line">    <span class="comment">//å›å¤æ¶ˆæ¯</span></span><br><span class="line">    Messenger client = msg.replyTo;</span><br><span class="line">    Message replyMsg = Message.obtain(<span class="keyword">null</span>,MessengerService.MSG_WHAT);</span><br><span class="line">    Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">    bundle.putString(<span class="string">"key"</span>,<span class="string">"value"</span>);</span><br><span class="line">    replyMsg.setData(bundle);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      client.send(replyMsg);</span><br><span class="line">    &#125;<span class="keyword">catch</span>()&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ï¼Œå¢åŠ Messengerå’ŒHandlerå¤„ç†æœåŠ¡ç«¯å›å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerReplyMsgHandler</span> <span class="keyword">extends</span> <span class="title">Hanlder</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>&#123;</span><br><span class="line">    <span class="comment">//æ¥æ”¶æœåŠ¡ç«¯è¿”å›çš„msg</span></span><br><span class="line">  <span class="comment">//do sth ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Messenger mRecevierReplyMsg = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> RecyclerReplyMsgHandler());</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œåœ¨å‘é€æ¶ˆæ¯æ˜¯éœ€è¦å°†æ¥æ”¶æœåŠ¡ç«¯å›å¤çš„Messengeré€šè¿‡Messageçš„replyToä¼ é€’ç»™æœåŠ¡ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//create msg...</span></span><br><span class="line">msg.replyTo = mRecevierReplyMsg;</span><br><span class="line"><span class="comment">//send msg...</span></span><br></pre></td></tr></table></figure><h3 id="3-AIDL"><a href="#3-AIDL" class="headerlink" title="3.AIDL"></a>3.AIDL</h3><p>ä¸€èˆ¬ä¸ä¼šä½¿ç”¨ï¼Œå…·ä½“ä½¿ç”¨å¯ä»¥å‚è€ƒ<a href="https://jixiaoyong.github.io/blog/posts/f931e8ae/">è¿™ç¯‡æ–‡ç« </a></p><h1 id="ç»‘å®šæœåŠ¡æ—¶çš„æ³¨æ„äº‹é¡¹"><a href="#ç»‘å®šæœåŠ¡æ—¶çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="ç»‘å®šæœåŠ¡æ—¶çš„æ³¨æ„äº‹é¡¹"></a>ç»‘å®šæœåŠ¡æ—¶çš„æ³¨æ„äº‹é¡¹</h1><ul><li>å¤šä¸ªå®¢æˆ·ç«¯å¯è¿æ¥ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ç»‘å®šæ—¶æ‰ä¼šè°ƒç”¨æœåŠ¡<code>onBind()</code>æ–¹æ³•æ¥æ£€ç´¢IBinderï¼Œæ­¤åæ— éœ€è°ƒç”¨å°±å¯å°†åŒä¸€ä¸ªIBinderä¼ é€’ç»™å…¶ä»–å®¢æˆ·ç«¯</li><li><code>bindService()</code> ç»‘å®šæœåŠ¡æ˜¯å¼‚æ­¥è¿›è¡Œçš„</li><li>ä¸€èˆ¬åœ¨activityå¯è§ç”Ÿå‘½å‘¨æœŸå†…ç»‘å®š-å–æ¶ˆæœåŠ¡ï¼Œä¸è¦åœ¨<code>onResume()</code>ã€<code>onPause()</code>æœŸé—´æ‰§è¡Œç»‘å®š/è§£ç»‘</li></ul><h1 id="Serviceç»‘å®šå’Œå¯åŠ¨è½¬æ¢"><a href="#Serviceç»‘å®šå’Œå¯åŠ¨è½¬æ¢" class="headerlink" title="Serviceç»‘å®šå’Œå¯åŠ¨è½¬æ¢"></a>Serviceç»‘å®šå’Œå¯åŠ¨è½¬æ¢</h1><table><thead><tr><th>é¡ºåº</th><th>ç»“æœ</th></tr></thead><tbody><tr><td>å…ˆç»‘å®šåå¯åŠ¨service</td><td>å¯åŠ¨service</td></tr><tr><td>å…ˆå¯åŠ¨åç»‘å®šservice</td><td>ä¼šç»‘å®šå®¿ä¸»ï¼Œä½†æ˜¯å®¿ä¸»æ­»åä»æŒ‰ç…§å¯åŠ¨serviceæ–¹å¼å­˜æ´»</td></tr></tbody></table><h1 id="å‰å°æœåŠ¡å’Œé€šçŸ¥"><a href="#å‰å°æœåŠ¡å’Œé€šçŸ¥" class="headerlink" title="å‰å°æœåŠ¡å’Œé€šçŸ¥"></a>å‰å°æœåŠ¡å’Œé€šçŸ¥</h1><blockquote><ul><li><strong>startForeground(int id, Notification notification)</strong><br>è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠå½“å‰æœåŠ¡è®¾ç½®ä¸ºå‰å°æœåŠ¡ï¼Œå…¶ä¸­idå‚æ•°ä»£è¡¨å”¯ä¸€æ ‡è¯†é€šçŸ¥çš„æ•´å‹æ•°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æä¾›ç»™ startForeground() çš„æ•´å‹ ID ä¸å¾—ä¸º 0ï¼Œè€Œnotificationæ˜¯ä¸€ä¸ªçŠ¶æ€æ çš„é€šçŸ¥ã€‚</li><li><strong>stopForeground(boolean removeNotification)</strong><br>è¯¥æ–¹æ³•æ˜¯ç”¨æ¥ä»å‰å°åˆ é™¤æœåŠ¡ï¼Œæ­¤æ–¹æ³•ä¼ å…¥ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦ä¹Ÿåˆ é™¤çŠ¶æ€æ é€šçŸ¥ï¼Œtrueä¸ºåˆ é™¤ã€‚ æ³¨æ„è¯¥æ–¹æ³•å¹¶ä¸ä¼šåœæ­¢æœåŠ¡ã€‚ ä½†æ˜¯ï¼Œå¦‚æœåœ¨æœåŠ¡æ­£åœ¨å‰å°è¿è¡Œæ—¶å°†å…¶åœæ­¢ï¼Œåˆ™é€šçŸ¥ä¹Ÿä¼šè¢«åˆ é™¤ã€‚</li></ul></blockquote><p>æ–‡ç« å‚è€ƒï¼š</p><p><a href="http://blog.csdn.net/javazejian/article/details/52709857#t3" target="_blank" rel="noopener">å…³äºAndroid ServiceçœŸæ­£çš„å®Œå…¨è¯¦è§£ï¼Œä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡ - CSDNåšå®¢</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¹‹å‰å‘å¸ƒçš„å‡ ä¸ªApp</title>
      <link href="/blog/posts/1a589649/"/>
      <url>/blog/posts/1a589649/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰å­¦ä¹ androidçš„è¿‡ç¨‹ä¸­ï¼Œè·Ÿç€æ•™ç¨‹åšäº†å‡ ä¸ªappï¼Œè™½ç„¶éšç€ä½¿ç”¨çš„apiçš„å¤±æ•ˆï¼Œå¤§å¤šæ•°åº”ç”¨å¦‚ä»Šå·²ç»ä¸èƒ½æ­£å¸¸ä½¿ç”¨äº†ï¼Œä½†æ˜¯ä½œä¸ºåˆå…¥ç¼–ç¨‹çš„ä¸€ç‚¹ç‚¹å°çºªå¿µï¼Œè¿˜æ˜¯ä¸ºä»–ä»¬å†™ä¸€ä¸ªç´¢å¼•æ–‡ç« ï¼Œè‡³å°‘èƒ½å¤Ÿæ™šä¸€äº›æ¶ˆå¯‚äºè¿™å¹¿é˜”çš„æ•°æ®æµ·æ´‹ä¸­ã€‚</p><h1 id="NiceNews"><a href="#NiceNews" class="headerlink" title="NiceNews"></a><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/05/NiceNews/">NiceNews</a></h1><p>Posted on 2016-05-30</p><p>NieceNewsæˆ‘åˆ¶ä½œçš„ç¬¬äºŒæ¬¾APPï¼Œä¸€ä¸ªå®æ—¶æ–°é—»è½¯ä»¶ã€‚</p><p><img src="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/05/NiceNews/images/icon.png" alt="NiceNews"></p><h1 id="IWeather"><a href="#IWeather" class="headerlink" title="IWeather"></a><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/07/IWeather/">IWeather</a></h1><p>Posted on 2016-07-16</p><p>IWeatherï¼Œæˆ‘çš„ç¬¬ä¸‰ä¸ªAndroidåº”ç”¨ï¼Œä¸€ä¸ªå¤©æ°”é¢„æŠ¥APPã€‚</p><p><img src="http://jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/07/IWeather/images/1.png" alt="IWeather"></p><h1 id="2048"><a href="#2048" class="headerlink" title="2048"></a><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/07/2048/">2048</a></h1><p>Posted on 2016-07-21</p><p>2048ï¼Œæˆ‘çš„ç¬¬å››ä¸ªAndroidåº”ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æˆ‘çš„ç¬¬ä¸€æ¬¾æ¸¸æˆAPPã€‚</p><p><img src="http://jixiaoyong.github.io/blogbackup/blog_2016To2017/2016/07/2048/images/1.png" alt="2048"></p><h1 id="Içœ‹çŸ¥ä¹"><a href="#Içœ‹çŸ¥ä¹" class="headerlink" title="Içœ‹çŸ¥ä¹"></a><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/07/I%E7%9C%8B%E7%9F%A5%E4%B9%8E/">Içœ‹çŸ¥ä¹</a></h1><p>Posted on 2016-07-24   | </p><p>içœ‹çŸ¥ä¹ï¼Œæˆ‘çš„ç¬¬äº”ä¸ªAndroidåº”ç”¨ã€‚</p><p><img src="http://jixiaoyong.github.io/blog/backup/blog_2016To2017/2016/07/I%E7%9C%8B%E7%9F%A5%E4%B9%8E/images/1.png" alt="logo"></p><p>å­¦ä¹ çš„è¿‡ç¨‹éœ€è¦ä¸æ–­çš„é‡å¤ï¼Œæ›´éœ€è¦æœ‰æ¡ç†çš„æ€»ç»“ï¼Œæˆ‘ä¼šæŠŠå¹³æ—¶å­¦ä¹ çš„å¿ƒå¾—ä½“ä¼šï¼Œç»éªŒï¼Œä»¥åŠæ— èŠæ—¶çç¢ç£¨å¾—å‡ºæ¥çš„ç¨€å¥‡å¤æ€ªçš„æƒ³æ³•æ”¾åˆ°è¿™é‡Œï¼Œä¸»è¦æ˜¯ä¸ºäº†è‡ªå·±èƒ½å¤Ÿåœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­æœ‰è®¡åˆ’çš„æ€»ç»“å­¦ä¹ åˆ°çš„çŸ¥è¯†ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿ä¹‹åæŸ¥é˜…ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Androidæ§ä»¶ç»„</title>
      <link href="/blog/posts/3b69424a/"/>
      <url>/blog/posts/3b69424a/</url>
      
        <content type="html"><![CDATA[<p>è¿™å‡ å¤©çš„å·¥ä½œä¸­ç”¨åˆ°äº†æ§ä»¶ç»„æ¥å®ç°å¤æ‚å¸ƒå±€ï¼Œæ•ˆæœä¸é”™ï¼Œè®°å½•ä¸‹æ¥å¤‡ç”¨ã€‚</p><h1 id="1-å®šä¹‰æ§ä»¶ç»„å¸ƒå±€xxx-layout-xml"><a href="#1-å®šä¹‰æ§ä»¶ç»„å¸ƒå±€xxx-layout-xml" class="headerlink" title="1. å®šä¹‰æ§ä»¶ç»„å¸ƒå±€xxx_layout.xml"></a>1. å®šä¹‰æ§ä»¶ç»„å¸ƒå±€xxx_layout.xml</h1><p>åœ¨è¿™é‡Œå®šä¹‰è¦ä½¿ç”¨çš„æ§ä»¶ç»„å¸ƒå±€ï¼Œè¿™é‡Œçš„å¸ƒå±€å†³å®šäº†å¸ƒå±€æ˜¾ç¤ºçš„æ ·å­ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:padding</span>=<span class="string">"10dp"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span> /&gt;</span></span><br><span class="line">      </span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="2-æ–°å»ºè‡ªå®šä¹‰å±æ€§æ–‡ä»¶attr-xmlï¼ˆå¯é€‰ï¼‰"><a href="#2-æ–°å»ºè‡ªå®šä¹‰å±æ€§æ–‡ä»¶attr-xmlï¼ˆå¯é€‰ï¼‰" class="headerlink" title="2.æ–°å»ºè‡ªå®šä¹‰å±æ€§æ–‡ä»¶attr.xmlï¼ˆå¯é€‰ï¼‰"></a>2.æ–°å»ºè‡ªå®šä¹‰å±æ€§æ–‡ä»¶attr.xmlï¼ˆå¯é€‰ï¼‰</h1><ul><li><p>åœ¨<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- MSearchBarè¡¨æ˜æ˜¯ç»™è¯¥æ§ä»¶ä½¿ç”¨çš„è‡ªå®šä¹‰å±æ€§ --&gt;</span><br><span class="line">    &lt;declare-styleable name=&quot;MSearchBar&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- ä»¥ä¸‹ä¸ºç¤ºä¾‹ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚å¢å‡ --&gt;</span><br><span class="line">        &lt;attr name=&quot;textColor&quot; format=&quot;color&quot; /&gt;</span><br><span class="line">        &lt;attr name=&quot;textSize&quot; format=&quot;dimension&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/declare-styleable&gt;</span><br><span class="line"></span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure></p></li><li><p>åœ¨è¯¥è‡ªå®šä¹‰æ§ä»¶çš„ç±»xxx.javaä¸­ï¼Œé€šè¿‡å¦‚ä¸‹è¯­å¥è·å–ä»ç”¨æˆ·ä½¿ç”¨æ—¶èµ‹ç»™è¿™äº›å±æ€§çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.MSearchBar);</span><br><span class="line"><span class="keyword">float</span> textSize = array.getDimension(R.styleable.MSearchBar_textSize, <span class="number">13</span>);</span><br></pre></td></tr></table></figure><p>â€‹</p></li><li><p>ç”¨æˆ·åŠ¨æ€ç»™è¿™äº›å±æ€§èµ‹å€¼ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">cf.android666.jixiaoyong.weightgroup.weight.MSearchBar</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:textColor</span>=<span class="string">"@color/colorPrimaryDark"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">cf.android666.jixiaoyong.weightgroup.weight.MSearchBar</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™é‡Œå†™çš„æ˜¯<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  â€‹</span><br><span class="line"></span><br><span class="line"># 3. æ–°å»ºç»„åˆæ§ä»¶çš„ç±»XXX.java</span><br><span class="line"></span><br><span class="line">* æ–°å»ºXXX.javaï¼Œç»§æ‰¿è‡ªå¸ƒå±€æ–‡ä»¶çš„çˆ¶å¸ƒå±€LinearLayout</span><br><span class="line"></span><br><span class="line">* æ›´æ”¹å‚æ•°å°‘çš„æ„é€ æ–¹æ³•çš„```super(a1,a2,a3)```ä¸º```this(a1,a2,a3)```ï¼Œå…¶ä¸­```this()```ä¸­çš„å‚æ•°ä¸ªæ•°ä¸ºå‚æ•°æœ€å¤šçš„æ„é€ æ–¹æ³•çš„å‚æ•°æ•°ã€‚</span><br><span class="line"></span><br><span class="line">  **æ³¨æ„** ï¼šä¸€å®šè¦åšè¿™ä¸€æ­¥ï¼Œå¦åˆ™åœ¨ä½¿ç”¨è¯¥è‡ªå®šä¹‰æ§ä»¶ç»„æ—¶ï¼Œæ–°å»ºè¯¥ç±»çš„å¯¹è±¡ä¼šæç¤ºå‡ºé”™</span><br><span class="line"></span><br><span class="line">* åœ¨æœ€ç»ˆä¼šè¢«è°ƒç”¨çš„æ„é€ æ–¹æ³•é‡Œé¢å°†xmlé‡Œé¢å®šä¹‰çš„å¸ƒå±€åŠ è½½è¿›æ¥ï¼š</span><br><span class="line"></span><br><span class="line">  ```java</span><br><span class="line">  //æ³¨æ„ä¸‰ä¸ªå‚æ•°ï¼šå¸ƒå±€æ–‡ä»¶ï¼šR.layout.weight_group_layout, rootï¼šthis,æ˜¯å¦ä¾é™„åˆ°rootï¼štrue</span><br><span class="line">  //å¿…é¡»æœ‰å‰ä¸¤ä¸ªå‚æ•°ï¼Œå¦åˆ™æ§ä»¶çš„å®½é«˜ç­‰ä¼šæœ‰å¼‚å¸¸</span><br><span class="line">  View view = LayoutInflater.from(context).inflate(R.layout.weight_group_layout, this,true);</span><br></pre></td></tr></table></figure></p></li><li><p>ä½¿ç”¨è‡ªå®šä¹‰å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MSearchBar</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//do sth</span></span><br><span class="line">  </span><br><span class="line">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.MSearchBar);</span><br><span class="line">        <span class="keyword">float</span> textSize = array.getDimension(R.styleable.MSearchBar_textSize, <span class="number">13</span>);</span><br><span class="line">        editText.setTextSize(textSize);</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>ç»™æ§ä»¶ç»„å†…éƒ¨æ§ä»¶æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼š</p><ul><li><p>xxx.java è¦å®ç°ç‚¹å‡»äº‹ä»¶ç›‘å¬æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MSearchBar</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰æ¥å£ï¼Œä¾›ä½¿ç”¨xxx.javaç±»æ—¶å®ç°å¯¹ç›‘å¬äº‹ä»¶çš„å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImgLeftOnClickListener</span><span class="params">(OnImgClickListener listener)</span></span>&#123;</span><br><span class="line">    listenerL = listener;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnImgClickListener</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OnImgClickListener listenerL;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹è¦ç›‘å¬ç‚¹å‡»äº‹ä»¶çš„æ§ä»¶è®¾ç½®ç›‘å¬ï¼Œå¹¶è°ƒç”¨<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```java</span><br><span class="line">//åœ¨æ„é€ æ–¹æ³•ç­‰åœ°æ–¹è®¾ç½®ç›‘å¬äº‹ä»¶</span><br><span class="line">imageViewLeft.setOnClickListener(this);</span><br><span class="line"></span><br><span class="line">//åœ¨xxx.javaä¸­é‡å†™onClick()æ–¹æ³•</span><br><span class="line">    @Override</span><br><span class="line">    public void onClick(View view) &#123;</span><br><span class="line">        switch (view.getId()) &#123;</span><br><span class="line">            //ImageLeft</span><br><span class="line">            case R.id.imageView:</span><br><span class="line">                if (listenerL != null) &#123;</span><br><span class="line">                    listenerL.onClick();</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            //imageRight</span><br><span class="line">            case R.id.imageView2:</span><br><span class="line">                if (listenerR != null) &#123;</span><br><span class="line">                    listenerR.onClick();</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p></li></ul></li></ul><h1 id="4-ä½¿ç”¨è‡ªå®šä¹‰æ§ä»¶ç»„xxx-java"><a href="#4-ä½¿ç”¨è‡ªå®šä¹‰æ§ä»¶ç»„xxx-java" class="headerlink" title="4. ä½¿ç”¨è‡ªå®šä¹‰æ§ä»¶ç»„xxx.java"></a>4. ä½¿ç”¨è‡ªå®šä¹‰æ§ä»¶ç»„xxx.java</h1><ul><li><p>åœ¨å¸ƒå±€æ–‡ä»¶main_activity.xmlä¸­æ·»åŠ è¯¥æ§ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cf.android666.jixiaoyong.weightgroup.weight.MSearchBar</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">"@+id/search_bar"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">app:textColor</span>=<span class="string">"@color/colorPrimaryDark"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">cf.android666.jixiaoyong.weightgroup.weight.MSearchBar</span>&gt;</span></span><br></pre></td></tr></table></figure><p>â€‹</p></li><li><p>åœ¨javaä¸­ä½¿ç”¨è¯¥æ§ä»¶ï¼Œè®¾ç½®ç›‘å¬äº‹ä»¶</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MSearchBar searchBar = (MSearchBar) findViewById(R.id.search_bar);</span><br><span class="line">searchBar.setImgLeftOnClickListener(<span class="keyword">new</span> MSearchBar.OnImgClickListener() &#123;</span><br><span class="line">        <span class="meta">@SuppressLint</span>(<span class="string">"WrongConstant"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Click on Left"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h1 id="5-æ•ˆæœé¢„è§ˆ"><a href="#5-æ•ˆæœé¢„è§ˆ" class="headerlink" title="5.æ•ˆæœé¢„è§ˆ"></a>5.æ•ˆæœé¢„è§ˆ</h1><p><img src="http://upload-images.jianshu.io/upload_images/120748-48d0cbbf03ded7f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ•ˆæœé¢„è§ˆ"></p><h1 id="6-æºç "><a href="#6-æºç " class="headerlink" title="6.æºç "></a>6.æºç </h1><p>demoçš„githubé“¾æ¥:<a href="https://github.com/jixiaoyong/my_application_on_deepin/tree/master/weightgroup" target="_blank" rel="noopener">github</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Androidè‡ªå®šä¹‰Viewå®ç°è”ç³»äººåˆ—è¡¨</title>
      <link href="/blog/posts/a2c96aac/"/>
      <url>/blog/posts/a2c96aac/</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªå®šä¹‰çš„view"><a href="#è‡ªå®šä¹‰çš„view" class="headerlink" title="è‡ªå®šä¹‰çš„view"></a>è‡ªå®šä¹‰çš„view</h1><ul><li>LetterIndex.java extends View</li><li>ContactsListView.java extends RecyclerView<br>#åˆ†æ</li><li>è”ç³»äººåˆ—è¡¨æœ‰ä¸¤ä¸ªè¦ç‚¹<ul><li>å­—æ¯å¯¼èˆªæ <br>é€šè¿‡è‡ªå®šä¹‰Viewç”»å‡º26ä¸ªå­—æ¯ï¼Œè®¾ç½®æ»‘åŠ¨ç›‘å¬äº‹ä»¶ï¼Œæ ¹æ®ä¸Šä¸‹æ»‘åŠ¨çš„è·ç¦»åˆ¤æ–­å½“å‰é€‰ä¸­çš„å­—æ¯ï¼Œå¹¶ç›¸åº”æ›´æ–°ç•Œé¢ã€‚</li><li>åˆ—è¡¨ä¸­çš„å­—æ¯æ ‡é¢˜<br>é’ˆå¯¹itemä¸­çš„è”ç³»äººå§“åé¦–å­—æ¯å¯¹åº”çš„tagä½œæ¯”è¾ƒï¼Œè‹¥ä¸å‰ä¸€ä¸ªç›¸åŒåˆ™ä¸æ˜¾ç¤ºtitleï¼Œå¦åˆ™æ˜¾ç¤ºã€‚</li></ul></li><li>äº‹ä»¶è”åŠ¨<ul><li>å½“æ»‘åŠ¨å­—æ¯å¯¼èˆªæ æ—¶ï¼Œé™¤äº†å¤„ç†æœ¬èº«çš„å˜åŒ–å¤–ï¼Œè¿˜è¦ç•™å‡ºæ¥å£ï¼Œä»¥ä¾¿å…¶ä»–æ§ä»¶è·å–å½“å‰é€‰ä¸­çš„å­—æ¯ã€‚</li><li>è”ç³»äººåˆ—è¡¨æ»‘åŠ¨æ—¶ï¼Œé™¤äº†å¤„ç†æœ¬èº«å˜åŒ–å¤–ï¼ŒåŒæ ·è¦ç•™å‡ºæ¥å£ä»¥ä¾¿è·å–å½“å‰ç½®é¡¶çš„itemå¯¹åº”çš„å­—æ¯</li><li>å­—æ¯å¯¼èˆªæ è¦ç•™å‡ºæ–¹æ³•ï¼Œä»¥ä¾¿å…¶ä»–æ§ä»¶æŒ‡å®šé€‰ä¸­çš„å­—æ¯ï¼Œå¹¶æ›´æ–°ç•Œé¢<h1 id="å…·ä½“ä»£ç "><a href="#å…·ä½“ä»£ç " class="headerlink" title="å…·ä½“ä»£ç "></a>å…·ä½“ä»£ç </h1><strong>ContactsListView.java</strong><br>é‡å†™è¯¥ç±»ä¸»è¦æ˜¯ä¸ºäº†å®ç°ItemDecorationæ ¹æ®ä¸åŒçš„itemå˜åŒ–ï¼ŒåŒæ—¶å¯ä»¥ä»xmlå¸ƒå±€æ–‡ä»¶ä¸­è·å–ItemDecorationçš„è‡ªå®šä¹‰å±æ€§ã€‚<br>ä¸»è¦ä»£ç ï¼š</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public ContactsListView(Context context) &#123;</span><br><span class="line">    this(context, null, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ContactsListView(Context context, @Nullable AttributeSet attrs) &#123;</span><br><span class="line">    this(context, attrs, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ContactsListView(Context context, @Nullable AttributeSet attrs, int defStyle) &#123;</span><br><span class="line">    super(context, attrs, defStyle);</span><br><span class="line">    mTypeArray = context.obtainStyledAttributes(attrs, R.styleable.MyRecyclerDecoration);</span><br><span class="line">    mContext = context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•…è€Œåœ¨å…¶å†…éƒ¨è‡ªå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿è‡ªItemDecoratioå¾—é™æ€å†…éƒ¨ç±»Decorationnç±»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public Decoration(List&lt;String&gt; data)&#123;</span><br><span class="line">//è·å–è¦æ˜¾ç¤ºçš„è”ç³»äººæ•°æ®å¯¹åº”çš„è‹±æ–‡tagé›†åˆ</span><br><span class="line">//åˆå§‹åŒ–å„ç§è‡ªå®šä¹‰å±æ€§</span><br><span class="line">//ä¾‹å¦‚é¢œè‰²ï¼šmColorLetterText = mTypeArray.getColor(R.styleable.MyRecyclerDecoration_color_letter_text, 0xff152648);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">        public void onDraw(Canvas c, RecyclerView parent, RecyclerView.State state)&#123;</span><br><span class="line">//ç”»å‡ºå„ä¸ªå¯¼èˆªtitle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">        public void onDrawOver(Canvas c, RecyclerView parent, RecyclerView.State state) &#123;</span><br><span class="line">//ç”»å‡ºç½®é¡¶çš„å¯¼èˆªtitle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> @Override</span><br><span class="line">        public void getItemOffsets(Rect outRect, View view, RecyclerView parent, RecyclerView.State</span><br><span class="line">                state) &#123;</span><br><span class="line">//åˆ¤æ–­æ˜¯å¦ç”»å‡ºå¯¼èˆªtitle</span><br><span class="line"> super.getItemOffsets(outRect, view, parent, state);</span><br><span class="line">            int position = ((RecyclerView.LayoutParams) (view.getLayoutParams())).getViewAdapterPosition();</span><br><span class="line"></span><br><span class="line">            if (position != -1) &#123;</span><br><span class="line">                String text = mDatas.get(position).substring(0, 1).toUpperCase();</span><br><span class="line">                if (position == 0) &#123;</span><br><span class="line">                    outRect.set(0, mTitleHeight, 0, 0);</span><br><span class="line">                &#125; else if (text != null &amp;&amp; !text.equals(mDatas.get(position - 1).substring(0, 1).toUpperCase())) &#123;</span><br><span class="line">                    outRect.set(0, mTitleHeight, 0, 0);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    outRect.set(0, 0, 0, 0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void drawText(Canvas canvas, float left, float right, View child, String text) &#123;</span><br><span class="line">//ç”»å‡ºæ–‡å­—</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>LetterIndex.java</strong><br>è¯¥ç±»ç”¨æ¥ç”»å‡ºå­—æ¯å¯¼èˆªæ ï¼Œå¹¶ä¸”æä¾›æ–¹æ³•è·å–/è®¾ç½®å½“å‰é€‰ä¸­çš„å­—æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public interface onIndexClickListener &#123;</span><br><span class="line">       void onIndexClick(int chooseId);</span><br><span class="line">       void onActionUp();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public void setOnIndexClickListener(onIndexClickListener listener) &#123;</span><br><span class="line">       this.mClickListener = listener;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public void setChooseId(int chooseId) &#123;</span><br><span class="line">       if (chooseId &gt;= 0 &amp;&amp; chooseId &lt; mIndexTexts.length) &#123;</span><br><span class="line">           mChooseId = chooseId;</span><br><span class="line">           invalidate();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé‡å†™<code>onTouchEvent(MotionEvent event)</code>æ–¹æ³•ï¼Œåœ¨ACTION_DOWNã€ACTION_MOVEã€ACTION_UPæ—¶è°ƒç”¨å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚</p><p>é‡å†™onDraw()æ–¹æ³•ï¼Œç”»å‡ºå¯¹åº”çš„ç•Œé¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">     super.onDraw(canvas);</span><br><span class="line">     int height = getHeight() - getPaddingTop() - getPaddingBottom();</span><br><span class="line">     float width = getWidth();</span><br><span class="line">     //childHeight æ˜¯æ¯ä¸€ä¸ªå­—æ¯æ‰€åœ¨å•å…ƒçš„é«˜åº¦</span><br><span class="line">     float childHeight = (float) height / mIndexTexts.length;</span><br><span class="line"></span><br><span class="line">     //å¦‚æœè¢«ç‚¹å‡»äº†ï¼Œå°±ç”»å‡ºèƒŒæ™¯</span><br><span class="line">     if (isClick) &#123;</span><br><span class="line">         mPaint.setColor(mColorIndexBg);</span><br><span class="line">         canvas.drawRect(0, 0, width, height, mPaint);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Rect bounds = new Rect();</span><br><span class="line">     mPaint.setTextSize(mSizeText);</span><br><span class="line">     mPaint.setTextAlign(Paint.Align.CENTER);</span><br><span class="line">     for (int i = 0; i &lt; mIndexTexts.length; i++) &#123;</span><br><span class="line">         String text = mIndexTexts[i];</span><br><span class="line">         mPaint.setColor(mColorText);</span><br><span class="line">         //åœ¨è¢«é€‰ä¸­çš„å­—åé¢ç”»ä¸€ä¸ªåœ†ï¼Œå¹¶æ”¹å˜å­—çš„é¢œè‰²</span><br><span class="line">         if (i == mChooseId) &#123;</span><br><span class="line">             mPaint.setColor(mColorChooseTextBg);</span><br><span class="line">             canvas.drawCircle(width / 2, childHeight / 2 + i * childHeight,</span><br><span class="line">                     mSizeText / 2 + 2, mPaint);</span><br><span class="line">             mPaint.setColor(mColorChooseText);</span><br><span class="line">         &#125;</span><br><span class="line">         mPaint.getTextBounds(text, 0, text.length(), bounds);</span><br><span class="line">         //boundsé‡Œé¢ä¿å­˜ç€è¦ç”»çš„å­—çš„ä¸€äº›å±æ€§ï¼Œå¦‚xï¼Œyï¼ŒcenterXï¼ŒcenterYç­‰ï¼Œ</span><br><span class="line">         //è¦æ³¨æ„ canvas.drawTextï¼ˆtext,x,y,mpaintï¼‰ä¸­yå¹¶ä¸æ˜¯textçš„æœ€ä½ç«¯ï¼Œè€Œæ˜¯baselineã€‚</span><br><span class="line">         float x = width / 2;</span><br><span class="line">         float y = -bounds.centerY() + childHeight / 2 + i * childHeight;</span><br><span class="line">         canvas.drawText(text, x, y, mPaint);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p>æºä»£ç åœ¨æˆ‘çš„Githubï¼Œ<a href="https://github.com/jixiaoyong/my_application_on_deepin/tree/master/contactsdemo/src/main" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a>å¯ä»¥æ‰¾åˆ°ã€‚</p><h1 id="é¢„è§ˆå¦‚ä¸‹"><a href="#é¢„è§ˆå¦‚ä¸‹" class="headerlink" title="é¢„è§ˆå¦‚ä¸‹"></a>é¢„è§ˆå¦‚ä¸‹</h1><p><img src="http://upload-images.jianshu.io/upload_images/120748-183eea3cad2b42ac.gif?imageMogr2/auto-orient/strip" alt="é¢„è§ˆ.gif"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Androidå¼€å‘å¸¸ç”¨è®¾ç½®</title>
      <link href="/blog/posts/1c56d6b9/"/>
      <url>/blog/posts/1c56d6b9/</url>
      
        <content type="html"><![CDATA[<h1 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a>Android Studio</h1><ul><li>å›½å†…è¾ƒå¿«çš„ä»“åº“ï¼š</li></ul><pre><code>maven {url&apos;http://maven.aliyun.com/nexus/content/groups/public/&apos;}</code></pre><ul><li>RecyclerViewæ·»åŠ ä¾èµ–<br>æ³¨æ„RecyclerViewçš„ç‰ˆæœ¬å·è¦å’Œå½“å‰å·¥ç¨‹ä¸­å…¶ä»–android.supportåŒ…ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œå¦åˆ™è™½ç„¶å¯¼å…¥äº†å¯¹åº”çš„åŒ…ï¼Œä½†æ˜¯ä»ç„¶æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚</li></ul><pre><code>compile &apos;com.android.support:recyclerview-v7:26+&apos;</code></pre><ul><li>è®¾ç½®ï¼š<br>è‡ªåŠ¨æ·»åŠ ä¾èµ–ï¼šinsert imports on paste: None<br>è‡ªåŠ¨åˆ é™¤æ— ç”¨ä¾èµ–ï¼šOptimize imports on the fly</li></ul><h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><ul><li>è®¾ç½®ndkç¯å¢ƒå˜é‡ /etc/profile</li></ul><pre><code>#set ndk envNDKROOT=/home/jixiaoyong/AndroidDev/Sdk/ndk-bundleexport PATH=$NDKROOT:$PATH</code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Javaä¸­ä¸‰ç§å¸¸ç”¨çš„æ’åºæ–¹æ³•</title>
      <link href="/blog/posts/1fd30f6e/"/>
      <url>/blog/posts/1fd30f6e/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©é‡æ–°å­¦ä¹ ç±»ä¸‰ç§æ’åºæ–¹æ³•ï¼ŒæŒ‰ç…§æ’åºé€Ÿåº¦ä¾æ¬¡æ˜¯å†’æ³¡æ’åºï¼Œé€‰æ‹©æ’åºå’Œæ’å…¥æ’åºã€‚<br>ä»¥ä¸‹ç¤ºä¾‹çš†ä¸ºä»å°åˆ°å¤§çš„æ’åº</p><h1 id="1-å†’æ³¡æ’åº"><a href="#1-å†’æ³¡æ’åº" class="headerlink" title="1.å†’æ³¡æ’åº"></a>1.å†’æ³¡æ’åº</h1><p>æ¯ä¸€æ¬¡æ¯”è¾ƒéƒ½å¯èƒ½è¦äº¤æ¢å…ƒç´ ã€‚<br>å†’æ³¡æ’åºçš„æ€æƒ³æ˜¯ï¼š<br>æ¯ä¸€è½®å¼€å§‹çš„æ—¶å€™ï¼Œå°†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆaï¼‰å¼€å§‹ä¸å…¶åçš„å…ƒç´ ï¼ˆbï¼‰ä¾æ¬¡è¿›è¡Œæ¯”è¾ƒï¼Œå°†è¾ƒå¤§çš„å…ƒç´ ï¼ˆè®¾ä¸ºmï¼‰æ”¾åˆ°åé¢ï¼Œå¹¶å°†mä¸å…¶åçš„å¦å¤–ä¸€ä¸ªå…ƒç´ ç»§ç»­è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ²¡æœ‰æ’å¥½åºçš„å…ƒç´ ã€‚<br>åœ¨æ¥ä¸‹æ¥ä¸€è½®çš„æ’åºä¸­ï¼Œåˆšæ‰ä»¥åŠä¹‹å‰é€‰å‡ºæ¥çš„ã€å·²ç»æ’å¥½é¡ºåºçš„æœ€å¤§å€¼ä¸ç”¨å‚ä¸æ’åºã€‚<br>ä¾æ¬¡ç±»æ¨ï¼Œæ€»å…±éå†n-1è½®ï¼Œå³å¯å®Œæˆæ’åºã€‚<br>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code> void bubble(int[] arr){    int temp;    for (int i = 0; i &lt; arr.length - 1; i++) {        for (int j = 0; j &lt; arr.length - i - 1; j++) {            if (arr[j] &gt; arr[j + 1]) {                temp = arr[j];                arr[j] = arr[j + 1];                arr[j + 1] = temp;            }        }    }    System.out.println(&quot;\n--bubble :&quot;);    for (int i = 0; i &lt; arr.length; i++) {        System.out.print(arr[i] + &quot; &quot;);    }}</code></pre><h1 id="2-é€‰æ‹©æ’åº"><a href="#2-é€‰æ‹©æ’åº" class="headerlink" title="2.é€‰æ‹©æ’åº"></a>2.é€‰æ‹©æ’åº</h1><p>æ¯æ¬¡æ¯”è¾ƒçš„æ—¶å€™ä¸äº¤æ¢<br>é€‰æ‹©æ’åºçš„æ€æƒ³ï¼š<br>æ¯æ¬¡æ¯”è¾ƒçš„æ—¶å€™æ‰¾åˆ°çš„ä¸¤ä¸ªæ•°ä¸­çš„è¾ƒå¤§å€¼å¹¶è®°ä¸‹å…¶ä½ç½®ï¼Œç­‰åˆ°å½“å‰ä¸€è½®çš„éå†å®Œæˆä¹‹åï¼Œå°†æœ€åä¸€ä¸ªæœªæ’åºå…ƒç´ ä¸è¿™ä¸€è½®éå†æ‰¾åˆ°çš„æœ€å¤§å€¼äº¤æ¢<br>æœ€å¤šäº¤æ¢n-1æ¬¡<br>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>   void select(int[] arr){    for (int i = 0; i &lt; arr.length; i++) {        int maxIndex = 0;        int temp = 0;        for (int j = 1; j &lt; arr.length - i; j++) {            if (arr[maxIndex] &lt; arr[j]) {                maxIndex = j;            }        }        temp = arr[maxIndex];        arr[maxIndex] = arr[arr.length - i - 1];        arr[arr.length - i - 1] = temp;    }    System.out.println(&quot;\n--select :&quot;);    for (int i = 0; i &lt; arr.length; i++) {        System.out.print(arr[i] + &quot; &quot;);    }}</code></pre><h1 id="3-æ’å…¥æ’åºæ³•"><a href="#3-æ’å…¥æ’åºæ³•" class="headerlink" title="3.æ’å…¥æ’åºæ³•"></a>3.æ’å…¥æ’åºæ³•</h1><p>æ’å…¥æ’åºæ³•æ€æƒ³ï¼š<br>å°†å¾…æ’åºçš„å…ƒç´ åˆ†ä¸ºæœ‰åºå’Œæ— åºä¸¤ç§ï¼Œåˆšå¼€å§‹æ’åºçš„æ—¶å€™å‡è®¾åªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æœ‰åºçš„ï¼Œå…¶ä½™n-1ä¸ªå…ƒç´ éƒ½æ˜¯æ— åºçš„ï¼›<br>æ’åºå¼€å§‹çš„æ—¶ï¼Œå°†æ— åºéƒ¨åˆ†çš„ä¸€ä¸ªå…ƒç´ ï¼ˆaï¼‰ä¸æœ‰åºéƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆbï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœa&lt;bï¼Œåˆ™å°†aä¸bäº¤æ¢ï¼Œå†å°†aä¸ä¸‹ä¸€ä¸ªæœ‰åºå…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼›å¦åˆ™ï¼Œå°†aåŠ åˆ°båé¢ï¼Œä½œä¸ºæœ‰åºéƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚<br>æ¥ç€å†ä»æ— åºéƒ¨åˆ†å–å‡ºä¸€ä¸ªå…ƒç´ ä¸æœ‰åºéƒ¨åˆ†çš„å…ƒç´ ä¾æ¬¡æ¯”è¾ƒï¼Œç›´è¾¾æ‰€æœ‰å…ƒç´ éƒ½ä¸ºæœ‰åºå…ƒç´ ã€‚<br>éå†n-1æ¬¡<br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertSort</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line"><span class="keyword">int</span> instertValue = arr[i];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = i - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line"><span class="keyword">if</span> (instertValue &lt; arr[j]) &#123;</span><br><span class="line">arr[j+<span class="number">1</span>] = arr[j];</span><br><span class="line">arr[j] = instertValue;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç¬¬äºŒç§è¡¨ç¤ºå½¢å¼</span></span><br><span class="line"><span class="comment">for (int i = 1; i &lt; arr.length; i++) &#123;</span></span><br><span class="line"><span class="comment">int instertVal = arr[i];</span></span><br><span class="line"><span class="comment">int index = i - 1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">while (index &gt;= 0 &amp;&amp; instertVal &lt; arr[index]) &#123;</span></span><br><span class="line"><span class="comment">arr[index + 1] = arr[index];</span></span><br><span class="line"><span class="comment">index--;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">arr[index + 1] = instertVal;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"\n--insertSort :"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">System.out.print(arr[i] + <span class="string">" "</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linuxä¸‹é…ç½®Gitï¼Œä½¿ç”¨AndroidStudioåŒæ­¥å·¥ç¨‹åˆ°Github</title>
      <link href="/blog/posts/25db0a11/"/>
      <url>/blog/posts/25db0a11/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº†å¦‚ä½•åœ¨ linux ç¯å¢ƒä¸‹å®‰è£…å’Œé…ç½® git ä¸ github ï¼Œå¹¶ä¸”ä½¿ç”¨ Android Studio å°†æœ¬åœ°çš„é¡¹ç›®åŒæ­¥åˆ° github ä¸Šé¢ã€‚</p><h1 id="å®‰è£…-git"><a href="#å®‰è£…-git" class="headerlink" title="å®‰è£… git"></a>å®‰è£… git</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-gat install git</span><br></pre></td></tr></table></figure><h1 id="é…ç½®-git-å’Œ-github"><a href="#é…ç½®-git-å’Œ-github" class="headerlink" title="é…ç½® git å’Œ github"></a>é…ç½® git å’Œ github</h1><ul><li><p>åˆ›å»º Github è´¦å·</p></li><li><p>ç”Ÿæˆ ssh key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;your_email@youremail.com</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ github ä¸Šé¢æ·»åŠ  ssh key</p></li></ul><p>è¿›å…¥ Account Settings â€“&gt; SSH Keys â€“&gt; Add SSH Key æ·»åŠ  SSH Keys ï¼š<br>åå­—èµ·ä¸€ä¸ªå®¹æ˜“è¯†åˆ«çš„åå­—ï¼Œkey æ˜¯ç”Ÿæˆçš„ <code>/home/username/.ssh/id_rsa.pub.</code> ä¸­çš„å†…å®¹ï¼Œç›´æ¥ç²˜è´´åˆ°æŒ‡å®šä½ç½®å°±è¡Œ</p><ul><li><p>æµ‹è¯• ssh key æ˜¯å¦æˆåŠŸ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure></li></ul><p>æç¤ºå¦‚<code>Youâ€™ve successfully authenticated, but GitHub does not provide shell access</code>åˆ™è¯´æ˜æˆåŠŸè¿æ¥ github</p><ul><li><p>é…ç½® Github</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;your name&quot; //é…ç½®ç”¨æˆ·å</span><br><span class="line">git config --global user.email &quot;your email&quot; //é…ç½®email</span><br></pre></td></tr></table></figure></li></ul><h1 id="ç”¨-Android-Studio-åŒæ­¥å·¥ç¨‹åˆ°-Github"><a href="#ç”¨-Android-Studio-åŒæ­¥å·¥ç¨‹åˆ°-Github" class="headerlink" title="ç”¨ Android Studio åŒæ­¥å·¥ç¨‹åˆ° Github"></a>ç”¨ Android Studio åŒæ­¥å·¥ç¨‹åˆ° Github</h1><ul><li><p>å¯åŠ¨android studio</p><p>è¿›å…¥<code>android studio/bin</code>ï¼Œç»ˆç«¯è¾“å…¥<code>./studio.sh</code></p></li><li><p>é€‰æ‹© <code>VCS ---&gt; Import into Version Control --&gt; Share Project on Github</code></p></li></ul><p>ç¬¬ä¸€æ¬¡è¿›å…¥ä¼šè¦æ±‚è¾“å…¥ github çš„è´¦å·å’Œå¯†ç  æŒ‰ç…§è¦æ±‚è¾“å…¥å³å¯<br>æ­¤åè¿˜ä¼šè¦æ±‚ä½ è¾“å…¥ä¸€ä¸ªæœ¬åœ°å¯†ç ï¼Œå½“ä¸‹æ¬¡åŒæ­¥çš„æ—¶å€™éœ€è¦è¾“å…¥<br>ä¹‹åå°±è¿›å…¥åˆ°é€‰æ‹©åŒæ­¥çš„ä»“åº“ï¼Œæ–°å»ºä¸€ä¸ªä»“åº“ï¼Œå¼€å§‹åŒæ­¥å°±å¯ä»¥äº†</p><p><strong>åˆ°è¿™é‡Œå°±é¡ºåˆ©çš„åœ¨ Android Studio ä¸Šé¢å°†å·¥ç¨‹åŒæ­¥åˆ° Github ä¸Šé¢äº†</strong></p><hr><p><strong>ä»¥ä¸‹ä¸ºåŸæ–‡æåˆ°çš„å…¶ä»–æ–¹æ³•ï¼Œæ‘˜å½•å¦‚ä¸‹ï¼Œä»¥å¤‡åç”¨ï¼š</strong></p><h1 id="åˆ©ç”¨Gitä»æœ¬åœ°ä¸Šä¼ åˆ°GitHub"><a href="#åˆ©ç”¨Gitä»æœ¬åœ°ä¸Šä¼ åˆ°GitHub" class="headerlink" title="åˆ©ç”¨Gitä»æœ¬åœ°ä¸Šä¼ åˆ°GitHub"></a>åˆ©ç”¨Gitä»æœ¬åœ°ä¸Šä¼ åˆ°GitHub</h1><p>ç¬¬ä¸€æ­¥ï¼š è¿›å…¥è¦æ‰€è¦ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•</p><p>è¾“å…¥å‘½ä»¤ <code>git init</code></p><p>ç¬¬äºŒæ­¥ï¼š åˆ›å»ºä¸€ä¸ªæœ¬åœ°ä»“åº“ origin</p><p>ä½¿ç”¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:yourName/yourRepo.git</span><br></pre></td></tr></table></figure><p><code>youname</code>æ˜¯ä½ çš„GitHubçš„ç”¨æˆ·åï¼Œ<code>yourRepo</code>æ˜¯ä½ è¦ä¸Šä¼ åˆ°GitHubçš„ä»“åº“</p><p>ç¬¬ä¸‰æ­¥ï¼š æ¯”å¦‚ä½ è¦æ·»åŠ ä¸€ä¸ªæ–‡ä»¶xxxåˆ°æœ¬åœ°ä»“åº“ï¼Œä½¿ç”¨å‘½ä»¤ <code>git add xxx</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>git add .</code> è‡ªåŠ¨åˆ¤æ–­æ·»åŠ å“ªäº›æ–‡ä»¶</p><p>ç„¶åæŠŠè¿™ä¸ªæ·»åŠ æäº¤åˆ°æœ¬åœ°çš„ä»“åº“ï¼Œä½¿ç”¨å‘½ä»¤ <code>git commit -m</code>è¯´æ˜è¿™æ¬¡çš„æäº¤</p><p>æœ€åæŠŠæœ¬åœ°ä»“åº“originæäº¤åˆ°è¿œç¨‹çš„GitHubä»“åº“ï¼Œä½¿ç”¨å‘½ä»¤ <code>git push origin master</code></p><h1 id="ä»GitHubå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°"><a href="#ä»GitHubå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°" class="headerlink" title="ä»GitHubå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°"></a>ä»GitHubå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°</h1><p>ç¬¬ä¸€æ­¥ï¼š åˆ°GitHubçš„æŸä¸ªä»“åº“ï¼Œç„¶åå¤åˆ¶å³è¾¹çš„æœ‰ä¸ª<code>HTTPS clone url</code></p><p>ç¬¬äºŒæ­¥ï¼š å›åˆ°è¦å­˜æ”¾çš„ç›®å½•ä¸‹ï¼Œä½¿ç”¨å‘½ä»¤ <code>git clone https://github.com/chenguolin/scrapy.git</code>ï¼Œè¿™é‡Œçš„urlåªæ˜¯ä¸€ä¸ªä¾‹å­</p><p>ç¬¬ä¸‰æ­¥ï¼š å¦‚æœæœ¬åœ°çš„ç‰ˆæœ¬ä¸æ˜¯æœ€æ–°çš„ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>git fetch origin</code>ï¼Œoriginæ˜¯æœ¬åœ°ä»“åº“</p><p>ç¬¬å››æ­¥ï¼š æŠŠæ›´æ–°çš„å†…å®¹åˆå¹¶åˆ°æœ¬åœ°åˆ†æ”¯ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>git merge origin/master</code></p><p>å¦‚æœä½ ä¸æƒ³æ‰‹åŠ¨å»åˆå¹¶ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ï¼š<br><code>git pull &lt;æœ¬åœ°ä»“åº“&gt; master</code> // è¿™ä¸ªå‘½ä»¤å¯ä»¥æ‹‰å»æœ€æ–°ç‰ˆæœ¬å¹¶è‡ªåŠ¨åˆå¹¶</p><h1 id="GitHubçš„åˆ†æ”¯ç®¡ç†"><a href="#GitHubçš„åˆ†æ”¯ç®¡ç†" class="headerlink" title="GitHubçš„åˆ†æ”¯ç®¡ç†"></a>GitHubçš„åˆ†æ”¯ç®¡ç†</h1><ul><li>åˆ›å»º</li></ul><p>1 åˆ›å»ºä¸€ä¸ªæœ¬åœ°åˆ†æ”¯ï¼š <code>git branch &lt;æ–°åˆ†æ”¯åå­—&gt;</code></p><p>2 å°†æœ¬åœ°åˆ†æ”¯åŒæ­¥åˆ°GitHubä¸Šé¢ï¼š <code>git push &lt;æœ¬åœ°ä»“åº“å&gt; &lt;æ–°åˆ†æ”¯å&gt;</code></p><p>3 åˆ‡æ¢åˆ°æ–°å»ºç«‹çš„åˆ†æ”¯ï¼š <code>git checkout &lt;æ–°åˆ†æ”¯å&gt;</code></p><p>4 ä¸ºä½ çš„åˆ†æ”¯åŠ å…¥ä¸€ä¸ªæ–°çš„è¿œç¨‹ç«¯ï¼š <code>git remote add &lt;è¿œç¨‹ç«¯åå­—&gt; &lt;åœ°å€&gt;</code></p><p>5 æŸ¥çœ‹å½“å‰ä»“åº“æœ‰å‡ ä¸ªåˆ†æ”¯: <code>git branch</code></p><ul><li>åˆ é™¤</li></ul><p>1 ä»æœ¬åœ°åˆ é™¤ä¸€ä¸ªåˆ†æ”¯ï¼š <code>git branch -d &lt;åˆ†æ”¯åç§°&gt;</code></p><p>2 åŒæ­¥åˆ°GitHubä¸Šé¢åˆ é™¤è¿™ä¸ªåˆ†æ”¯ï¼š <code>git push &lt;æœ¬åœ°ä»“åº“å&gt; :&lt;GitHubç«¯åˆ†æ”¯&gt;</code></p><h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä»Šå¤©åœ¨ linux ä¸‹å®‰è£… git ï¼Œä¸Šä¼ å·¥ç¨‹åˆ° github ä¸Šé¢æ—¶çš„æ­¥éª¤çš„æ€»ç»“ï¼Œå¤§éƒ¨åˆ†å†…å®¹éƒ½å‚è€ƒ/æ‘˜å½•è‡ªä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼Œæ„Ÿè°¢åŸä½œè€…çš„åˆ†äº«ï¼ŒåŸæ–‡ä¿¡æ¯åŠé“¾æ¥å¦‚ä¸‹ï¼š</p><blockquote><p>Linuxä¸‹Gitå’ŒGitHubä½¿ç”¨æ–¹æ³•æ€»ç»“<br>[æ—¥æœŸï¼š2014-03-07] æ¥æºï¼šLinuxç¤¾åŒº ä½œè€…ï¼šchenguolin<br><a href="http://www.linuxidc.com/Linux/2014-03/97821.htm" target="_blank" rel="noopener">http://www.linuxidc.com/Linux/2014-03/97821.htm</a></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linuxä¸‹é…ç½®JDKå’ŒAndroidStudioå¼€å‘ç¯å¢ƒ</title>
      <link href="/blog/posts/ca532ade/"/>
      <url>/blog/posts/ca532ade/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸‹è½½-JDK-å¹¶è§£å‹"><a href="#ä¸‹è½½-JDK-å¹¶è§£å‹" class="headerlink" title="ä¸‹è½½ JDK å¹¶è§£å‹"></a>ä¸‹è½½ JDK å¹¶è§£å‹</h1><ul><li>åˆ°å®˜ç½‘ä¸‹è½½ jdk</li><li>ä¸‹è½½åˆ°çš„ JDK æ–‡ä»¶è§£å‹</li></ul><h1 id="è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç¯å¢ƒå˜é‡</h1><p>ç®¡ç†å‘˜æƒé™è¿›å…¥ etc/environment å†™å…¥ä»¥ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=&quot;JDKä¸»ç›®å½•çš„ç»å¯¹è·¯å¾„&quot;</span><br></pre></td></tr></table></figure><h1 id="é…ç½®-alternatives"><a href="#é…ç½®-alternatives" class="headerlink" title="é…ç½® alternatives"></a>é…ç½® alternatives</h1><p>æ‰“å¼€ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --install  /usr/bin/java java  JDKä¸»ç›®å½•çš„ç»å¯¹è·¯å¾„/bin/java 300</span><br><span class="line"></span><br><span class="line">sudo update-alternatives --install  /usr/bin/javac javac  JDKä¸»ç›®å½•çš„ç»å¯¹è·¯å¾„/bin/javac 300</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ JDK çš„ç¯å¢ƒå°±é…ç½®å¥½äº†</p><h1 id="è¿è¡Œ-Android-Studio"><a href="#è¿è¡Œ-Android-Studio" class="headerlink" title="è¿è¡Œ Android Studio"></a>è¿è¡Œ Android Studio</h1><p>è¿›å…¥ android studio/bin ç›®å½•ä¸‹ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œ</p><p>è¾“å…¥ <code>./studio.sh</code></p><p>åˆ°è¿™é‡Œï¼Œå°±å¯ä»¥æ­£å¸¸è¿è¡Œ android studio äº†</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>AppWidgetçš„ä½¿ç”¨ä¹‹PendingIntent</title>
      <link href="/blog/posts/fcfc830b/"/>
      <url>/blog/posts/fcfc830b/</url>
      
        <content type="html"><![CDATA[<p>è¿™å‡ å¤©å­¦ä¹  AppWidget ï¼Œå¾ˆç®€å•çš„ç»„ä»¶å´èŠ±è´¹äº†ä¸å°‘åŠŸå¤«ï¼Œä»Šå¤©å¯¹ PendingIntent çš„ç”¨æ³•åšäº†ä¸€äº›ç®€å•çš„æ•´ç†ã€‚</p><p><strong>PendingIntent</strong></p><blockquote><p>PandingIntent å°±åƒæ˜¯ä¸€ä¸ªè®¾è®¡å¥½çš„å¤„ç†é¢„æ¡ˆï¼Œå½“è¾¾åˆ°æŸä¸ªç‰¹å®šæ¡ä»¶æ—¶ï¼Œä¾¿ä¼šè°ƒç”¨è¯¥ Intent æ‰€æŒ‡å®šåŠ¨ä½œï¼ˆæ‰“å¼€æœåŠ¡ï¼ŒActivityæˆ–è€…å‘é€å¹¿æ’­ï¼‰ã€‚</p><p>è¿™é‡Œä½¿ç”¨è¯¥æ–¹æ³•åœ¨ AppWidget é‡Œé¢ä¸ºæŒ‰é’®æ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå½“æŒ‰é’®è¢«ç‚¹å‡»çš„æ—¶å€™è§¦å‘ç›¸åº”çš„åŠ¨ä½œ</p></blockquote><p>AppWidget å’Œåº”ç”¨ç¨‹åºä¸å†åŒä¸€ä¸ªè¿›ç¨‹å½“ä¸­ï¼Œè€Œæ˜¯åœ¨ HomeScreen ä¸Šé¢æ‰§è¡Œ,æ‰€ä»¥ä¸èƒ½ç›´æ¥ä¸º AppWidget ä¸­çš„ Button æ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œéœ€è¦ç”¨ <code>remoteViews.setPendingIntent(R.id.widget_button,pendingIntent);</code>æ„æ€æ˜¯å½“æŒ‰ä¸‹æŒ‰é’®çš„æ—¶å€™ pendingIntent ä¸­çš„ Intent å°±ä¼šæ‰§è¡Œ</p><p>PendingIntent å½“æŸä¸ªäº‹ä»¶å‡ºç°ä¹‹åæ‰ä¼šæ‰§è¡Œ</p><p>RemoteViewså¯¹è±¡ ä»£è¡¨äº†ä¸€ç³»åˆ—çš„ View å¯¹è±¡ï¼Œå’Œä¸»ç¨‹åºä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸º AppWidget æ§ä»¶ç»‘å®šå¤„ç†å™¨</p><p><strong>æµç¨‹æ¦‚è¿°ï¼š</strong></p><ul><li><p>æ·»åŠ  appwidget_provider_info.xml åœ¨ res/xml ä¸‹æ–°å»º appwidget_provider_info.xml</p><ul><li>æè¿° AppWidget çš„åŸºæœ¬ä¿¡æ¯å¦‚æœ€å°é«˜åº¦ã€å®½åº¦ç­‰ï¼Œè¿˜æœ‰å°±æ˜¯è¯¥æŒ‚ä»¶çš„å¸ƒå±€æ–‡ä»¶</li></ul></li><li><p>åœ¨ res/layout ä¸‹é¢ä¸ºè¯¥æŒ‚ä»¶è®¾ç½®å…·ä½“çš„å¸ƒå±€æ ·å¼</p><ul><li>å‘ AppWidget çš„å¸ƒå±€æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª Button</li><li>å‘ AppWidget çš„å¸ƒå±€æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª TextView</li></ul></li><li><p>æ–°å»º MyAppWidget.java ç»§æ‰¿è‡ª AppWidgetProvider</p><p>åœ¨è¯¥ç±»çš„ onUpdate() æ–¹æ³•ä¸­ä¸º Button è®¾ç½®ã€æ·»åŠ ç›‘å¬äº‹ä»¶</p><ul><li>å»ºç«‹ä¸€ä¸ª Intent å¯¹è±¡</li><li>ç”¨è¯¥ Intent å¯¹è±¡åˆ›å»ºä¸€ä¸ª PendingIntent å¯¹è±¡</li><li>åˆ›å»ºä¸€ä¸ª RemoteViews å¯¹è±¡</li><li>ç”¨è¯¥ RemoveViews å¯¹è±¡ä¸º æŒ‰é’®ç»‘å®šäº‹ä»¶å¤„ç†å™¨</li><li>æ›´æ–°æŒ‰é’®</li></ul></li><li><p>æ³¨å†Œäº‹ä»¶</p></li><li><p>å¤‡æ³¨ï¼šè¦æ˜¯ä¸º AppWidget ä¸­çš„ Button è®¾ç½®çš„äº‹ä»¶æ˜¯æ‰“å¼€ä¸€ä¸ª TargetActivity ï¼Œè¿˜éœ€è¦æ·»åŠ ä¸€ä¸ª TargetActivity ç±»å’Œå¯¹åº”çš„å¸ƒå±€æ–‡ä»¶</p></li></ul><p><strong>ä»¥ä¸‹æ˜¯ä»£ç </strong></p><ul><li>appwidget_provider_info.xml</li></ul><p>è¿™ä¸ªå¸ƒå±€æ–‡ä»¶æ˜¯ AppWidget çš„ä¿¡æ¯</p><p>æè¿°äº† AppWidget çš„æœ€å°é«˜ï¼Œæœ€å°å®½ä»¥åŠå®ƒçš„å¸ƒå±€æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;appwidget-provider</span><br><span class="line">    android:minHeight=&quot;200dp&quot;</span><br><span class="line">    android:minWidth=&quot;300dp&quot;</span><br><span class="line">    android:initialLayout=&quot;@layout/app_widget&quot;</span><br><span class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; &gt;</span><br><span class="line">&lt;/appwidget-provider&gt;</span><br></pre></td></tr></table></figure><ul><li>app_widget.xml</li></ul><p>è¿™ä¸ªå¸ƒå±€æ–‡ä»¶æ˜¯ Widget åœ¨æ¡Œé¢ä¸Šæ˜¾ç¤ºçš„æ ·å¼</p><p>å®šä¹‰äº† AppWidget ä¸­å„ä¸ªç»„ä»¶åŠå…¶æ ·å¼</p><p>å…¶ä¸­ Button ç”¨æ¥å“åº”ç‚¹å‡»äº‹ä»¶ï¼ŒåŠ å…¥ TargetActivity</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;200dp&quot;</span><br><span class="line">    android:layout_height=&quot;200dp&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;TextView</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:text=&quot;hello,world!&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">        android:id=&quot;@+id/app_widget_btn&quot;</span><br><span class="line">        android:layout_width=&quot;200dp&quot;</span><br><span class="line">        android:layout_height=&quot;150dp&quot;</span><br><span class="line">        android:background=&quot;#ff00ff&quot;</span><br><span class="line">        android:text=&quot;this is my app widget button&quot;/&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure><ul><li>target_activity.xml</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:textSize=&quot;50sp&quot;</span><br><span class="line">        android:background=&quot;#00ff00&quot;</span><br><span class="line">        android:text=&quot;\n hello,welcome to target activity!&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure><ul><li>MyAppWidget.java</li></ul><p>ä¸»è¦æ˜¯ä¿®æ”¹äº† update() æ–¹æ³•ï¼š</p><p>å®šä¹‰äº†ä¸€ä¸ªé¢„å…ˆè®¾å®šçš„åŠ¨ä½œâ€”- Intent å¯¹è±¡ï¼›</p><p>åˆ©ç”¨è¯¥ Intent è¯»å†™ï¼Œåˆ›å»ºä¸€ä¸ª PendingIntent å¯¹è±¡ï¼›</p><p>åˆ›å»ºä¸€ä¸ª RemoteView å¯¹è±¡ï¼Œå¹¶ä¸ºæŒ‰é’®ç»‘å®šç›‘å¬äº‹ä»¶</p><p>åˆ·æ–° AppWidgetã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">public class MyAppWidget extends AppWidgetProvider &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        super.onReceive(context, intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onUpdate(Context context, AppWidgetManager appWidgetManager,</span><br><span class="line">                         int[] appWidgetIds) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        super.onUpdate(context, appWidgetManager, appWidgetIds);</span><br><span class="line"></span><br><span class="line">        //appWidgetIds æ¯ä¸€æ¬¡å‘å±å¹•æ·»åŠ  AppWidget çš„æ—¶å€™éƒ½ä¼šå¢åŠ ä¸€ä¸ªå”¯ä¸€çš„ appWidget çš„ Id</span><br><span class="line">        for(int i = 0; i &lt; appWidgetIds.length;i++)&#123;</span><br><span class="line">          //åˆ›å»ºä¸€ä¸ª Intent å¯¹è±¡</span><br><span class="line">            Intent intent = new Intent(context,TargetActivity.class);</span><br><span class="line">            //åˆ›å»ºä¸€ä¸ª PendingIntent å¯¹è±¡</span><br><span class="line">            PendingIntent pendingIntent = PendingIntent.getActivity(context,0,intent,0);</span><br><span class="line">            // remoteViews ä»£è¡¨ AppWidget ä¸Šæ‰€æœ‰çš„æ§ä»¶</span><br><span class="line">            RemoteViews remoteViews = new RemoteViews(context.getPackageName(), R.layout.app_widget);</span><br><span class="line">            //ä¸ºæŒ‰é’®ç»‘å®šäº‹ä»¶å¤„ç†å™¨</span><br><span class="line">            /*</span><br><span class="line">            * å‚1ï¼ŒæŒ‡å®šè¢«ç»‘å®šå¤„ç†å™¨çš„æ§ä»¶id</span><br><span class="line">            * å‚2ï¼ŒæŒ‡å®šäº‹ä»¶å‘ç”Ÿæ—¶ä¼šè¢«æ‰§è¡Œçš„ PendingIntent</span><br><span class="line">             */</span><br><span class="line">            remoteViews.setOnClickPendingIntent(R.id.app_widget_btn,pendingIntent);</span><br><span class="line">            //æ›´æ–° AppWidget ï¼Œå‚1æ˜¯ç”¨äºæŒ‡å®šè¢«æ›´æ–° appWidget çš„ID</span><br><span class="line">            appWidgetManager.updateAppWidget(appWidgetIds[i],remoteViews);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDeleted(Context context, int[] appWidgetIds) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        super.onDeleted(context, appWidgetIds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onEnabled(Context context) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        super.onEnabled(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDisabled(Context context) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        super.onDisabled(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>TargetActivity.java</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class TargetActivity extends Activity &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.target_activity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AndroidManifest.xml</li></ul><p>åœ¨ AndroidManifest.xml ä¸­æ³¨å†Œ TargetActivity å’Œ MyAppWidget</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".TargetActivity"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- æ³¨æ„è¿™é‡Œæ³¨å†Œäº†ä¸€ä¸ª MyAppWidget æ¥æ”¶æ•°æ®--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".MyAppWidget"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.appwidget.action.APPWIDGET_UPDATE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"android.appwidget.provider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:resource</span>=<span class="string">"@xml/appwidget_provider_info"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hexo+Github=Blog</title>
      <link href="/blog/posts/f7965978/"/>
      <url>/blog/posts/f7965978/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Worldï¼</span><br></pre></td></tr></table></figure><p>ä¸€ç›´ä»¥æ¥ï¼Œä¸ºäº†æœ‰ä¸€ä¸ªåˆé€‚çš„åœ¨çº¿å†™å­—çš„åœ°æ–¹ï¼Œæˆ‘å°è¯•è¿‡è®¸å¤šç§å·¥å…·ï¼Œä»æœ€åˆçš„ QQ ç©ºé—´å¼€å§‹ï¼Œåˆ°å„ç§é—¨æˆ·ç½‘ç«™çš„åšå®¢ï¼Œå†åˆ°è‡ªå·±å¼€å§‹å°è¯•æ­å»ºåšå®¢ï¼Œä¸€è·¯å¥”å¿™ï¼Œé—¨æˆ·ç½‘ç«™çš„é™åˆ¶å¤ªå¤šï¼Œè‡ªå·±æ­å»ºçš„åšå®¢åˆæ—¶å¸¸ç”±äºç©ºé—´æä¾›å•†çš„å„ç§é—®é¢˜è€Œæ— æ³•è®¿é—®ã€‚è®¸å¤šæ—¶å€™ä¸€ä¸ªå¹³å°åªèƒ½ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œè¿™æ ·å­é¢ é¢ æ’æ’å¤§æ¦‚ä¹Ÿæœ‰äº”å…­å¹´çš„æ—¶é—´äº†ã€‚</p><p>ä¸€ç›´å¬è¯´ github è¿™ä¸ªå¹³å°çš„å„ç§ä¼˜ç‚¹ï¼Œå°¤å…¶æ˜¯å¯ä»¥ä½œä¸ºç¨³å®šè€Œå…è´¹çš„ç©ºé—´æ‰˜ç®¡åšå®¢æœ€ä»¤æˆ‘å¿ƒåŠ¨ï¼Œä½†æ˜¯ä¹‹å‰å¤šæ¬¡å°è¯•ä¸å¾—å…¶é“ï¼Œç»ˆä»¥å¤±è´¥å‘Šç»ˆã€‚æœ€è¿‘åœ¨å­¦ä¹  Android è¯­è¨€çš„æ—¶å€™ï¼Œåˆå†æ¬¡ç”¨èµ·äº† github ï¼Œä¸è¿‡è¿™æ¬¡æ˜¯ç”¨å®ƒæ¥å­˜å‚¨ä»£ç ã€‚ä¸å¾—ä¸æ‰¿è®¤ï¼Œä½¿ç”¨ github æ¥æ§åˆ¶ç¨‹åºç‰ˆæœ¬çœŸæ˜¯ä¸€ä»¶ä»¤äººæ„‰æ‚¦çš„äº‹ä»¶ã€‚</p><p>æœºç¼˜å·§åˆï¼Œå› ä¸ºéœ€è¦å°†å­¦ä¹ è¿‡ç¨‹ä¸­çš„ä¸€äº›ç¬”è®°ï¼Œå¿ƒå¾—æ€»ç»“æ‰¾ä¸ªåœ°æ–¹æ•´ç†ï¼Œæ˜¾ç„¶å•çº¯çš„ä½¿ç”¨ github å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½åŠæ³•ï¼Œè€Œå…¶ä»–çš„å¹³å°çš„åšå®¢é™åˆ¶åˆå¤ªå¤šï¼Œäºæ˜¯åˆå°è¯•ç”¨ github æ­å»ºä¸€ä¸ªåšå®¢ï¼Œè™½ç„¶å¯¹è¿™äº›çŸ¥è¯†å¹¶ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä½†è¯¯æ‰“è¯¯æ’ç«Ÿç„¶ä¹ŸæˆåŠŸçš„æ­å»ºå¥½äº†åšå®¢ã€‚ä¸‹é¢å°±æŠŠæ•´ä¸ªå»ºç«™çš„è¿‡ç¨‹å¤§æ¦‚æ¢³ç†ä¸€ä¸‹ï¼Œä»¥ä¾¿ä»¥åæŸ¥çœ‹ã€‚</p><h1 id="å‡†å¤‡è½¯ä»¶"><a href="#å‡†å¤‡è½¯ä»¶" class="headerlink" title="å‡†å¤‡è½¯ä»¶"></a>å‡†å¤‡è½¯ä»¶</h1><p>ä¸‹è½½è½¯ä»¶ï¼š</p><ul><li>node å®¢æˆ·ç«¯</li><li>git</li><li>github windows å®¢æˆ·ç«¯(å¯é€‰)</li></ul><h1 id="è£…-git-å’Œ-github-windows-å®¢æˆ·ç«¯"><a href="#è£…-git-å’Œ-github-windows-å®¢æˆ·ç«¯" class="headerlink" title="è£… git å’Œ github windows å®¢æˆ·ç«¯"></a>è£… git å’Œ github windows å®¢æˆ·ç«¯</h1><ul><li><p>å®‰è£… git:</p><p>git å®‰è£…æ—¶æŒ‰ç…§é»˜è®¤çš„é…ç½®ï¼Œä¸€è·¯ç‚¹å‡»ç¡®å®šå°±å¯ä»¥ã€‚</p></li><li><p>~å®‰è£… githubå®¢æˆ·ç«¯ï¼ˆå¯é€‰ï¼Œå¦‚æœç†Ÿæ‚‰gitå‘½ä»¤å¯ä»¥ç›´æ¥å‘½ä»¤è¡Œæ“ä½œï¼‰~</p><p>~github å®‰è£…åˆ†ä¸ºä¸¤ç§ï¼š~<br>~ä¸€ç§æ˜¯ç›´æ¥ç”¨å®˜ç½‘çš„å®‰è£…åŒ…ï¼Œåœ¨å®‰è£…çš„æ—¶å€™éœ€è¦ä»ç½‘ä¸Šä¸‹è½½èµ„æ–™ï¼Œå—ç½‘é€Ÿé™åˆ¶ï¼Œè¿™ç§æ–¹æ³•å¾ˆæ…¢ï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ï¼›<br>å¦ä¸€ç§ç›´æ¥æ‰¾ä¸€ä»½githubç¦»çº¿å®‰è£…åŒ…è§£å‹åˆ°æœ¬åœ°å³å¯ä½¿ç”¨ï¼Œæˆ‘å°±æ˜¯ä½¿ç”¨åä¸€ç§æ–¹æ³•ã€‚~</p></li></ul><h1 id="å®‰è£…node"><a href="#å®‰è£…node" class="headerlink" title="å®‰è£…node"></a>å®‰è£…node</h1><ul><li>å®‰è£… node å®¢æˆ·ç«¯<br>ä¸‹è½½å¹¶å®‰è£… node ,æˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ node-v5.7.1-x64ã€‚</li></ul><p>åœ¨å®‰è£…å®Œ git, node ä¹‹å</p><ul><li>win é”® + R è¾“å…¥cmd æ‰“å¼€ windows è‡ªå¸¦å‘½ä»¤è¡Œï¼Œ<br>åˆ†åˆ«è¾“å…¥<code>git</code> ã€ <code>npm</code><br>ä¹‹åï¼Œå¦‚æœæ˜¾ç¤ºå‡ºå¸®åŠ©ä¿¡æ¯è€Œé<em>â€œä¸æ˜¯å†…éƒ¨æˆ–å¤–éƒ¨å‘½ä»¤ï¼Œä¹Ÿä¸æ˜¯å¯è¿è¡Œçš„ç¨‹åºæˆ–æ‰¹å¤„ç†æ–‡ä»¶â€</em>è¿™æ ·çš„æç¤ºï¼Œå°±è¯´æ˜ git å’Œ node å·²ç»é…ç½®å¥½äº†ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™å°±éœ€è¦æ‰‹åŠ¨é…ç½®ã€‚</li></ul><h1 id="é…ç½®ç¯å¢ƒå˜é‡æ–¹æ³•ï¼š"><a href="#é…ç½®ç¯å¢ƒå˜é‡æ–¹æ³•ï¼š" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡æ–¹æ³•ï¼š"></a>é…ç½®ç¯å¢ƒå˜é‡æ–¹æ³•ï¼š</h1><ul><li>æ­¤ç”µè„‘ â€“&gt; å³é”® â€“&gt; å±æ€§ â€“&gt; é«˜çº§ç³»ç»Ÿè®¾ç½® â€“&gt; ç¯å¢ƒå˜é‡</li><li>æ‰¾åˆ°ç”¨æˆ·ç¯å¢ƒå˜é‡ â€“&gt; path ï¼Œå¦‚ä¸‹å›¾<br><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/2016/04/%E5%B0%8F%E7%99%BD%E7%AC%94%E8%AE%B0%EF%BC%9Agithub%20+%20hexo%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/BaiduShurufa_2016-4-23_17-41-1.png"><img src="http://upload-images.jianshu.io/upload_images/120748-8aae916f0dfa3dd4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¿®æ”¹ç”¨æˆ·ç¯å¢ƒå˜é‡å‰"></a></li></ul><p>å¦‚ä¸‹å›¾ä¿®æ”¹<br><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/2016/04/%E5%B0%8F%E7%99%BD%E7%AC%94%E8%AE%B0%EF%BC%9Agithub%20+%20hexo%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/BaiduShurufa_2016-4-23_17-41-44.png"><img src="http://upload-images.jianshu.io/upload_images/120748-aa40a7e6049eeecd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¿®æ”¹ç³»ç»Ÿç¯å¢ƒå˜é‡å"></a></p><p>è¿™æ ·å­ node åº”è¯¥å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚</p><h1 id="å®‰è£…hexo"><a href="#å®‰è£…hexo" class="headerlink" title="å®‰è£…hexo"></a>å®‰è£…hexo</h1><p>æ‰“å¼€å‘½ä»¤è¡Œï¼Œå…¨å±€å®‰è£… Hexo ,åŠ  -g å‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ hexo ç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo version</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blockquotehexo-cli: 1.0.1os: Windows_NT 10.0.14316 win32 x64http_parser: 2.6.2node: 5.7.1v8: 4.6.85.31uv: 1.8.0zlib: 1.2.8ares: 1.10.1-DEVicu: 56.1modules: 47openssl: 1.0.2g</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ hexo å°±åœ¨ç”µè„‘ä¸Šé¢å®‰è£…å¥½äº†ã€‚</p><h1 id="é…ç½®hexo"><a href="#é…ç½®hexo" class="headerlink" title="é…ç½®hexo"></a>é…ç½®hexo</h1><ul><li>è¿›å…¥å­˜æ”¾ hexo æ–‡ä»¶çš„ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹blogå­˜å‚¨ hexo çš„æ–‡ä»¶</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init blog</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›å…¥è¿™ä¸ªæ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd blog</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ hexo æœåŠ¡å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo server[info] Hexo is running at http://localhost:4000/. Press Ctrl+C to stop</span><br></pre></td></tr></table></figure><p>æ‰“å¼€æœ¬åœ°åœ°å€ï¼š<a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a> ï¼Œå°±å¯ä»¥çœ‹åˆ°æœ¬åœ°æ­å»ºå¥½çš„ hexo åšå®¢äº†<br>è¿™æ ·å­ä¸€ä¸ª hexo åšå®¢å°±åœ¨æœ¬åœ°æ­å»ºå¥½äº†</p><h1 id="ç›®å½•çš„è§£é‡Šï¼š"><a href="#ç›®å½•çš„è§£é‡Šï¼š" class="headerlink" title="ç›®å½•çš„è§£é‡Šï¼š"></a>ç›®å½•çš„è§£é‡Šï¼š</h1><p>scaffolds è„šæ‰‹æ¶ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå·¥å…·æ¨¡æ¿ scripts å†™æ–‡ä»¶çš„jsï¼Œæ‰©å±•hexoçš„åŠŸèƒ½<br>source å­˜æ”¾åšå®¢æ­£æ–‡å†…å®¹<br>source/_drafts è‰ç¨¿ç®±<br>source/_posts æ–‡ä»¶ç®±<br>themes å­˜æ”¾çš®è‚¤çš„ç›®å½•<br>themes/landscapeé»˜è®¤çš„çš®è‚¤<br>_config.yml å…¨å±€çš„é…ç½®æ–‡ä»¶<br>db.json é™æ€å¸¸é‡</p><h1 id="ä¸€äº›-hexo-è¯­å¥è§£é‡Š"><a href="#ä¸€äº›-hexo-è¯­å¥è§£é‡Š" class="headerlink" title="ä¸€äº› hexo è¯­å¥è§£é‡Š"></a>ä¸€äº› hexo è¯­å¥è§£é‡Š</h1><p>help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯<br>init åˆ›å»ºä¸€ä¸ªhexoé¡¹ç›®<br>migrate ä»å…¶ä»–ç³»ç»Ÿå‘hexoè¿ç§»<br>version æŸ¥çœ‹hexoçš„ç‰ˆæœ¬<br>â€“configå‚æ•°ï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œä»£æ›¿é»˜è®¤çš„_config.yml<br>â€“debugå‚æ•°ï¼Œè°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºæ‰€æœ‰æ—¥å¿—ä¿¡æ¯<br>â€“safeå‚æ•°ï¼Œå®‰å…¨æ¨¡å¼ï¼Œç¦ç”¨æ‰€æœ‰çš„æ’ä»¶å’Œè„šæœ¬<br>â€“silentå‚æ•°ï¼Œæ— æ—¥å¿—è¾“å‡ºæ¨¡å¼</p><h1 id="æ–°å»ºæ–‡ç« "><a href="#æ–°å»ºæ–‡ç« " class="headerlink" title="æ–°å»ºæ–‡ç« "></a>æ–°å»ºæ–‡ç« </h1><p>å‘½åä¸ºâ€œæ–°çš„æ–‡ç« â€ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new æ–°çš„æ–‡ç« </span><br></pre></td></tr></table></figure><p>hexo é»˜è®¤ç”Ÿæˆ md æ–‡ä»¶ï¼Œæ–°ç”Ÿæˆçš„æ–‡ç« åœ¨ç›®å½•ï¼š.\blog\source_posts\æ–°çš„æ–‡ç« .md ï¼Œå¯¹å…¶è¿›è¡Œç›¸åº”çš„ç¼–è¾‘å³å¯<br>æ–‡ç« æ ¼å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title: æ–°çš„æ–‡ç« date: 2014-05-07 18:44:12updated : 2014-05-10 18:44:12permalink: abctags:- å¼€å§‹- æˆ‘- æ—¥è®°categories:- æ—¥å¿—- ç¬¬ä¸€å¤©---</span><br></pre></td></tr></table></figure><h1 id="é…ç½®github"><a href="#é…ç½®github" class="headerlink" title="é…ç½®github"></a>é…ç½®github</h1><ul><li>æ³¨å†Œå¹¶ç™»å½• github<br>è¿›å…¥ <a href="https://github.com/" target="_blank" rel="noopener">https://github.com/</a> ï¼Œæ³¨å†Œæ–°è´¦æˆ·ï¼Œå¹¶ä¸”ç™»å½•</li><li>æ–°å»º respositoy<br>åœ¨ä¸»é¡µç‚¹å‡» New respositoy æ–°å»ºä¸€ä¸ªåå­—ä¸ºyourname.github.io<br> çš„ respositoyï¼›<br><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/2016/04/%E5%B0%8F%E7%99%BD%E7%AC%94%E8%AE%B0%EF%BC%9Agithub%20+%20hexo%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/1461473623662.jpg"><img src="http://upload-images.jianshu.io/upload_images/120748-fbb8934ceb25f0d3.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ–°å»º respositoy"></a></li><li>è®¾ç½®æ–°å»ºä¸€ä¸ª github pages<br>è¿›å…¥ä»“åº“ä¸»é¡µï¼Œé€‰æ‹©settings â€“&gt; github pages â€“&gt; Launch automatic page generator ,æŒ‰ç…§é»˜è®¤çš„ä¸»é¢˜é…ç½®é€‰æ‹©ä¸€ä¸ªå°±å¥½<br><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/2016/04/%E5%B0%8F%E7%99%BD%E7%AC%94%E8%AE%B0%EF%BC%9Agithub%20+%20hexo%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/BaiduShurufa_2016-4-24_12-59-58.png"><img src="http://upload-images.jianshu.io/upload_images/120748-c6e9742ee6120d8b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Launch automatic page generator"></a></li><li>ä¸Šä¼ ç½‘ç«™<br>å¯¹äº hexo çš„ç›¸å…³é…ç½®ï¼š<br>æ‰“å¼€_config.ymlï¼Œä¿®æ”¹ä»¥ä¸‹éƒ¨åˆ†ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Sitetitle: Jixiaoyong&apos;s Blog</span><br><span class="line">subtitle:</span><br><span class="line">description:</span><br><span class="line">author: Jixiaoyong</span><br><span class="line">language: zh-CN</span><br><span class="line">timezone:# URL</span><br><span class="line">#If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; </span><br><span class="line">and root as &apos;/child/&apos;</span><br><span class="line">url: http://yoursite.github.io/</span><br><span class="line">root: http://yoursite.github.io/blog/</span><br></pre></td></tr></table></figure><p>æ­¤å¤„ç”±äºæˆ‘æ˜¯å°†ç½‘ç«™æ”¾åœ¨äºŒçº§ç›®å½• ./blog/ ä¸‹é¢ï¼Œæ‰€ä»¥ root ç›®å½•è®¾ç½®å¦‚æ­¤ï¼Œä½¿ç”¨çš„æ˜¯ç»å¯¹è·¯å¾„ï¼Œå¦åˆ™åœ¨ç½‘é¡µä¸Šæ˜¾ç¤ºçš„æ—¶å€™ï¼Œcss ç­‰ç”±äºè·¯å¾„ä¸å¯¹ï¼ŒåŠ è½½å¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚</p><p><strong>éƒ¨ç½²æ–¹æ³•1</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deploy: type: git repo:https://github.com/yourname/yourname.github.io.git</span><br></pre></td></tr></table></figure><p>è¿™è¡Œè¯­å¥æ˜¯ä½¿ç”¨ hexo è‡ªåŠ¨ deploy åˆ° github æ—¶çš„è®¾ç½®ï¼Œ~å¦‚æœæ­£å¸¸çš„è¯ï¼Œå½“ç”¨ hexo å¯¹ç½‘ç«™é™æ€åŒ–å¤„ç†åï¼Œå†æ‰§è¡Œ hexo deploy å°±å¯ä»¥è‡ªåŠ¨éƒ¨ç½²åˆ° github ä¸Šé¢äº†ï¼Œä½†æ˜¯æˆ‘çš„ç”µè„‘ git æˆ–è€… node ç”±äºæ˜¯ä¸åŒæ—¶é—´è£…çš„æœŸé—´è¿˜é‡è£…äº†å‡ æ¬¡ç³»ç»Ÿï¼Œå¯èƒ½å¯¼è‡´æŸäº›è®¾ç½®æœ‰è¯¯ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œ hexo deploy çš„æ—¶å€™ä¸€ç›´æç¤ºæœ‰é—®é¢˜ï¼Œæ•…è€Œé‡‡ç”¨å¦ä¸€ç§åŠæ³•æ‰‹åŠ¨åŒæ­¥ç½‘ç«™ï¼Œè¿™å¥è¯ä¹Ÿå¯ä»¥ä¸ä¿®æ”¹ã€‚~</p><p><strong>éƒ¨ç½²æ–¹æ³•1</strong></p><ul><li><p>ç”¨ hexo å¯¹æ–‡ç« è¿›è¡Œé™æ€åŒ–å¤„ç†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo generate</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨<code>blog\public</code>ç›®å½•ä¸‹ç”Ÿæˆçš„ <code>public</code> åŒ…å«æ‰€æœ‰çš„é™æ€åŒ–æ–‡ä»¶,æ­¤æ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å†…æ‰€æœ‰çš„å†…å®¹å°±æ˜¯å¤„ç†å¥½çš„ç½‘ç«™ï¼Œå°†å…¶å‘å¸ƒåˆ°åˆé€‚çš„ç©ºé—´å°±å¯ä»¥æ­£å¸¸æ˜¾ç¤ºã€‚<br>ç”±äºä¹‹å‰çš„ git æˆ–è€… node é…ç½®æœ‰è¯¯ï¼Œæ‰€ä»¥è¿™æ—¶å€™é‡‡ç”¨æ‰‹åŠ¨åŒæ­¥ç½‘ç«™:</p><ul><li>å°†ä¸Šæ¬¡åœ¨ github ä¸Šå»ºç«‹çš„é¡¹ç›®yourname.github.io<br>åŒæ­¥åˆ°æœ¬åœ°ã€‚<br>åŒæ­¥çš„æ–¹æ³•å¾ˆå¤šï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯ä½¿ç”¨ github çš„ windows å®¢æˆ·ç«¯ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼š</li></ul><p>æ‰“å¼€ github å®¢æˆ·ç«¯ï¼Œæ‰¾åˆ°é¡¹ç›®ï¼Œé€‰æ‹©cloneåˆ°æœ¬åœ°å³å¯ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/120748-9100b83bb7ebf3b1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åŒæ­¥é¡¹ç›®åˆ°æœ¬åœ°"></p><p>ä¹‹åæ‰“å¼€åŒæ­¥çš„é¡¹ç›®ï¼Œç¡®è®¤å½“å‰çš„branchæ˜¯masterï¼Œå¦åˆ™åŒæ­¥ä¹‹åç½‘ç«™ä¸ä¼šæ˜¾ç¤ºã€‚<br><a href="http://jixiaoyong.github.io/jixiaoyong.github.io/blog/2016/04/%E5%B0%8F%E7%99%BD%E7%AC%94%E8%AE%B0%EF%BC%9Agithub%20+%20hexo%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/1461461275758.jpg"><img src="http://upload-images.jianshu.io/upload_images/120748-620f9db488c0c384.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ç¡®è®¤æ˜¯ master"></a></p><p>åœ¨ github åŒæ­¥çš„ç›®å½•ä¸‹æ‰¾åˆ°ä¸Šæ¬¡å»ºå¥½çš„é¡¹ç›®<code>yourname.github.io</code>,è¿›å…¥ä¹‹åï¼Œå°†ä¸Šæ–‡è·å¾—åˆ°çš„publicå†…å®¹æ”¾å…¥ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œæˆ‘é€‰æ‹©çš„æ˜¯å°†åšå®¢æ”¾åœ¨å­ç›®å½•ï¼Œæ‰€ä»¥è¿™é‡Œæ–°å»ºäº†ä¸€ä¸ªblogæ–‡ä»¶å¤¹ç”¨äºæ”¾ç½®åšå®¢ï¼Œæ‰€ä»¥å°±æ˜¯å°†public<br>å…¨éƒ¨å†…å®¹ æ”¾å…¥./yourname.github.io/blog/ ç›®å½•ä¸‹ï¼Œè¿™æ ·å­åœ¨ç½‘ç«™ä¸Šæ˜¾ç¤ºçš„æ—¶å€™ï¼Œåšå®¢çš„ç½‘å€å°±æ˜¯<a href="http://yourname.github.io/blog/" target="_blank" rel="noopener">http://yourname.github.io/blog/</a></p><p>è¿™æ ·ä¸€ä¸ªç®€å•çš„åˆ©ç”¨ github æ‰˜ç®¡çš„ hexo åšå®¢å°±æ­å»ºå¥½äº†ã€‚<br>æ³¨ï¼šæœ¬æ–‡å†…å®¹æ˜¯æ ¹æ®æˆ‘å»ºç«‹åšå®¢æ—¶çš„åšæ³•æ•´ç†è€Œæˆï¼Œå…¶ä¸­æœ‰éƒ¨åˆ†å†…å®¹æ˜¯å‚è€ƒç½‘ä¸Šçš„æ•™ç¨‹ï¼Œæ–‡ä¸­å¼•ç”¨çš„æ–‡å­—å…¨éƒ¨æ¥è‡ª<a href="http://blog.fens.me/hexo-bootstarp-github/" target="_blank" rel="noopener">http://blog.fens.me/hexo-bootstarp-github/</a> ï¼Œæ­¤æ–‡å¯¹æˆ‘å¸®åŠ©å¾ˆå¤§ï¼Œæ„Ÿè°¢ä½œè€…å¼ ä¸¹(Conan)çš„åˆ†äº«ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/blog/posts/4a17b156/"/>
      <url>/blog/posts/4a17b156/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
