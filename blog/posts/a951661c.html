<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.64" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://jixiaoyong.github.io/blog/posts/a951661c.html"><meta property="og:site_name" content="JI,XIAOYONG"><meta property="og:title" content="Dart Isolate 源码分析"><meta property="og:description" content="Isolate 💡 本文基于 Dart 2.17.1 Isolate, an isolated Dart execution context. All Dart code runs in an isolate, and code can access classes and values only from the same isolate. Different isolates can communicate by sending values through ports (see ReceivePort, SendPort)."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-01-01T15:46:34.000Z"><meta property="article:author" content="JI,XIAOYONG"><meta property="article:published_time" content="2022-05-28T07:20:01.000Z"><meta property="article:modified_time" content="2024-01-01T15:46:34.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Dart Isolate 源码分析","image":[""],"datePublished":"2022-05-28T07:20:01.000Z","dateModified":"2024-01-01T15:46:34.000Z","author":[{"@type":"Person","name":"JI,XIAOYONG","url":"https://jixiaoyong.github.io"}]}</script><link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content=" #096dd9"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><link rel="alternate" type="application/rss+xml" href="https://jixiaoyong.github.io/blog/rss.xml" title="JI,XIAOYONG RSS Feed"><title>Dart Isolate 源码分析 | JI,XIAOYONG</title><meta name="description" content="Isolate 💡 本文基于 Dart 2.17.1 Isolate, an isolated Dart execution context. All Dart code runs in an isolate, and code can access classes and values only from the same isolate. Different isolates can communicate by sending values through ports (see ReceivePort, SendPort).">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blog/assets/style-331bf80b.css" as="style"><link rel="stylesheet" href="/blog/assets/style-331bf80b.css">
    <link rel="modulepreload" href="/blog/assets/app-b427197f.js"><link rel="modulepreload" href="/blog/assets/a951661c.html-c2f95fc6.js"><link rel="modulepreload" href="/blog/assets/a951661c.html-7c368c80.js"><link rel="prefetch" href="/blog/assets/index.html-128c4d28.js" as="script"><link rel="prefetch" href="/blog/assets/about.html-5635c497.js" as="script"><link rel="prefetch" href="/blog/assets/1c56d6b9.html-621d2324.js" as="script"><link rel="prefetch" href="/blog/assets/12cb887a.html-59a26493.js" as="script"><link rel="prefetch" href="/blog/assets/5754fcd2.html-c131b959.js" as="script"><link rel="prefetch" href="/blog/assets/c0fefed0.html-6b1cedfe.js" as="script"><link rel="prefetch" href="/blog/assets/caa169b7.html-fd2bd604.js" as="script"><link rel="prefetch" href="/blog/assets/e5860bb5.html-522303aa.js" as="script"><link rel="prefetch" href="/blog/assets/ad4c562c.html-cfa844ee.js" as="script"><link rel="prefetch" href="/blog/assets/5962504e.html-9f2011a5.js" as="script"><link rel="prefetch" href="/blog/assets/f931e8ae.html-e848ad0a.js" as="script"><link rel="prefetch" href="/blog/assets/2270057c.html-5b3d5b60.js" as="script"><link rel="prefetch" href="/blog/assets/1b0362b.html-6cbc8c51.js" as="script"><link rel="prefetch" href="/blog/assets/b35fe0f7.html-da022e3a.js" as="script"><link rel="prefetch" href="/blog/assets/b0dc2559.html-dfa0d449.js" as="script"><link rel="prefetch" href="/blog/assets/c2f123c.html-164cfd71.js" as="script"><link rel="prefetch" href="/blog/assets/76d69fc6.html-e19915b4.js" as="script"><link rel="prefetch" href="/blog/assets/a3a3dc4c.html-b005a399.js" as="script"><link rel="prefetch" href="/blog/assets/b4832cd1.html-e7710f2e.js" as="script"><link rel="prefetch" href="/blog/assets/3b69424a.html-aff29016.js" as="script"><link rel="prefetch" href="/blog/assets/6f46f598.html-2ed8ef52.js" as="script"><link rel="prefetch" href="/blog/assets/104c9058.html-a100f523.js" as="script"><link rel="prefetch" href="/blog/assets/7e97a976.html-9623844f.js" as="script"><link rel="prefetch" href="/blog/assets/e3bb9a54.html-4ce4d56f.js" as="script"><link rel="prefetch" href="/blog/assets/5c023044.html-74a09680.js" as="script"><link rel="prefetch" href="/blog/assets/a2c96aac.html-34528d16.js" as="script"><link rel="prefetch" href="/blog/assets/e41787ec.html-5fb8a9b7.js" as="script"><link rel="prefetch" href="/blog/assets/f20627c9.html-d9a21775.js" as="script"><link rel="prefetch" href="/blog/assets/a2863875.html-fe4537ba.js" as="script"><link rel="prefetch" href="/blog/assets/26eab50a.html-0d6aab97.js" as="script"><link rel="prefetch" href="/blog/assets/aacd75ab.html-42e9f646.js" as="script"><link rel="prefetch" href="/blog/assets/fcfc830b.html-00a6da56.js" as="script"><link rel="prefetch" href="/blog/assets/7ee9086b.html-cc813e7c.js" as="script"><link rel="prefetch" href="/blog/assets/e15dda2e.html-d1788df4.js" as="script"><link rel="prefetch" href="/blog/assets/2822c354.html-39e4a842.js" as="script"><link rel="prefetch" href="/blog/assets/c04fdc6c.html-fc2f755e.js" as="script"><link rel="prefetch" href="/blog/assets/db62c118.html-8f2f8973.js" as="script"><link rel="prefetch" href="/blog/assets/3db5282.html-0b63ceab.js" as="script"><link rel="prefetch" href="/blog/assets/4cbcfe72.html-8e53c939.js" as="script"><link rel="prefetch" href="/blog/assets/4c220635.html-befc7414.js" as="script"><link rel="prefetch" href="/blog/assets/767a594.html-91e4dc28.js" as="script"><link rel="prefetch" href="/blog/assets/e35c106d.html-1f9916ee.js" as="script"><link rel="prefetch" href="/blog/assets/9e235953.html-3580887d.js" as="script"><link rel="prefetch" href="/blog/assets/47c43abe.html-78f68b25.js" as="script"><link rel="prefetch" href="/blog/assets/6ec43bd8.html-7ce92172.js" as="script"><link rel="prefetch" href="/blog/assets/adf541c0.html-ec63d36d.js" as="script"><link rel="prefetch" href="/blog/assets/62beedda.html-c2f12682.js" as="script"><link rel="prefetch" href="/blog/assets/820d6240.html-4cb97ff4.js" as="script"><link rel="prefetch" href="/blog/assets/1912667a.html-8570c37d.js" as="script"><link rel="prefetch" href="/blog/assets/23ac516a.html-c05ad331.js" as="script"><link rel="prefetch" href="/blog/assets/727d7800.html-00ee5f64.js" as="script"><link rel="prefetch" href="/blog/assets/ae8e53be.html-3041ba5e.js" as="script"><link rel="prefetch" href="/blog/assets/60f8d92f.html-c6b25c82.js" as="script"><link rel="prefetch" href="/blog/assets/d3bdcb53.html-c1fb8b8a.js" as="script"><link rel="prefetch" href="/blog/assets/4a17b156.html-67fb6935.js" as="script"><link rel="prefetch" href="/blog/assets/f31c11c5.html-94a11add.js" as="script"><link rel="prefetch" href="/blog/assets/b3994218.html-8e3235ab.js" as="script"><link rel="prefetch" href="/blog/assets/cf83ef31.html-17266d2c.js" as="script"><link rel="prefetch" href="/blog/assets/ff927bd4.html-eb669c95.js" as="script"><link rel="prefetch" href="/blog/assets/875283bd.html-3a4c94cf.js" as="script"><link rel="prefetch" href="/blog/assets/b0793c74.html-095127b0.js" as="script"><link rel="prefetch" href="/blog/assets/9a8e41a8.html-407da6a3.js" as="script"><link rel="prefetch" href="/blog/assets/1fd30f6e.html-f5807920.js" as="script"><link rel="prefetch" href="/blog/assets/b2cdb69e.html-51764214.js" as="script"><link rel="prefetch" href="/blog/assets/36721083.html-6309298c.js" as="script"><link rel="prefetch" href="/blog/assets/3e9e8cb1.html-9579ec5f.js" as="script"><link rel="prefetch" href="/blog/assets/375fcf66.html-1e9720eb.js" as="script"><link rel="prefetch" href="/blog/assets/b4abf652.html-f41bd948.js" as="script"><link rel="prefetch" href="/blog/assets/3f6454bb.html-785e9a0d.js" as="script"><link rel="prefetch" href="/blog/assets/87a89a43.html-0c64f51f.js" as="script"><link rel="prefetch" href="/blog/assets/9d9183ec.html-5d8abf32.js" as="script"><link rel="prefetch" href="/blog/assets/24967ad4.html-86552de5.js" as="script"><link rel="prefetch" href="/blog/assets/135b2780.html-a87ac72f.js" as="script"><link rel="prefetch" href="/blog/assets/8a52763a.html-4b427412.js" as="script"><link rel="prefetch" href="/blog/assets/fd5546ac.html-e975f766.js" as="script"><link rel="prefetch" href="/blog/assets/10414aef.html-4a6fdfd7.js" as="script"><link rel="prefetch" href="/blog/assets/53875104.html-83b549eb.js" as="script"><link rel="prefetch" href="/blog/assets/a64dc0bc.html-68242977.js" as="script"><link rel="prefetch" href="/blog/assets/25db0a11.html-c2dc75da.js" as="script"><link rel="prefetch" href="/blog/assets/ca532ade.html-a49d9c6a.js" as="script"><link rel="prefetch" href="/blog/assets/d0edc1ed.html-666adae7.js" as="script"><link rel="prefetch" href="/blog/assets/6ff87ae7.html-f3d99221.js" as="script"><link rel="prefetch" href="/blog/assets/d9a2e1ba.html-0d885cf4.js" as="script"><link rel="prefetch" href="/blog/assets/a8f97c56.html-69f1a4e6.js" as="script"><link rel="prefetch" href="/blog/assets/6e070881.html-caf499c1.js" as="script"><link rel="prefetch" href="/blog/assets/9c0ccf0d.html-e6602bb3.js" as="script"><link rel="prefetch" href="/blog/assets/550e5790.html-66de8670.js" as="script"><link rel="prefetch" href="/blog/assets/1a589649.html-9915f04b.js" as="script"><link rel="prefetch" href="/blog/assets/27065732.html-2779c698.js" as="script"><link rel="prefetch" href="/blog/assets/b00ac86a.html-e36c8b96.js" as="script"><link rel="prefetch" href="/blog/assets/f7965978.html-88bb07fc.js" as="script"><link rel="prefetch" href="/blog/assets/8d60b485.html-74d3f704.js" as="script"><link rel="prefetch" href="/blog/assets/1f6681a0.html-fc0a4266.js" as="script"><link rel="prefetch" href="/blog/assets/101c73f.html-9a9b0b02.js" as="script"><link rel="prefetch" href="/blog/assets/a71f2ecc.html-07fbeec8.js" as="script"><link rel="prefetch" href="/blog/assets/b3af796a.html-4b21471f.js" as="script"><link rel="prefetch" href="/blog/assets/851be5ef.html-ac394477.js" as="script"><link rel="prefetch" href="/blog/assets/9a784fe0.html-84c37140.js" as="script"><link rel="prefetch" href="/blog/assets/8d059318.html-897b2437.js" as="script"><link rel="prefetch" href="/blog/assets/125c8a12.html-8eb0102c.js" as="script"><link rel="prefetch" href="/blog/assets/11c01876.html-fa07ddfb.js" as="script"><link rel="prefetch" href="/blog/assets/466fbe25.html-6a553e64.js" as="script"><link rel="prefetch" href="/blog/assets/2041f2cb.html-aa9e0715.js" as="script"><link rel="prefetch" href="/blog/assets/af2aa19e.html-20fa1c23.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-948b694d.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-c8994c04.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-09e96cec.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-94c4fa0d.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-9bbb47b1.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-f7182528.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-846e06dd.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-d65e413c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-de034f94.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-80f4f180.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-aef92449.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-b3f7460d.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-d50c863c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-dc2a69e5.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-d874d230.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-907c1412.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-c837b2f0.js" as="script"><link rel="prefetch" href="/blog/assets/about.html-069c0251.js" as="script"><link rel="prefetch" href="/blog/assets/1c56d6b9.html-1da430df.js" as="script"><link rel="prefetch" href="/blog/assets/12cb887a.html-48661726.js" as="script"><link rel="prefetch" href="/blog/assets/5754fcd2.html-b018c1e8.js" as="script"><link rel="prefetch" href="/blog/assets/c0fefed0.html-f555a000.js" as="script"><link rel="prefetch" href="/blog/assets/caa169b7.html-839e825e.js" as="script"><link rel="prefetch" href="/blog/assets/e5860bb5.html-def973a0.js" as="script"><link rel="prefetch" href="/blog/assets/ad4c562c.html-532b52bf.js" as="script"><link rel="prefetch" href="/blog/assets/5962504e.html-8ff91af4.js" as="script"><link rel="prefetch" href="/blog/assets/f931e8ae.html-55eb96e6.js" as="script"><link rel="prefetch" href="/blog/assets/2270057c.html-b51928a3.js" as="script"><link rel="prefetch" href="/blog/assets/1b0362b.html-0e7101be.js" as="script"><link rel="prefetch" href="/blog/assets/b35fe0f7.html-667c27f3.js" as="script"><link rel="prefetch" href="/blog/assets/b0dc2559.html-c5676180.js" as="script"><link rel="prefetch" href="/blog/assets/c2f123c.html-b1ee31d3.js" as="script"><link rel="prefetch" href="/blog/assets/76d69fc6.html-018ec6d1.js" as="script"><link rel="prefetch" href="/blog/assets/a3a3dc4c.html-37e57464.js" as="script"><link rel="prefetch" href="/blog/assets/b4832cd1.html-5c5db231.js" as="script"><link rel="prefetch" href="/blog/assets/3b69424a.html-43246b1d.js" as="script"><link rel="prefetch" href="/blog/assets/6f46f598.html-fea30743.js" as="script"><link rel="prefetch" href="/blog/assets/104c9058.html-24fbcc8a.js" as="script"><link rel="prefetch" href="/blog/assets/7e97a976.html-26b50307.js" as="script"><link rel="prefetch" href="/blog/assets/e3bb9a54.html-0e29c693.js" as="script"><link rel="prefetch" href="/blog/assets/5c023044.html-8a2dbe81.js" as="script"><link rel="prefetch" href="/blog/assets/a2c96aac.html-7be32f4f.js" as="script"><link rel="prefetch" href="/blog/assets/e41787ec.html-edc83997.js" as="script"><link rel="prefetch" href="/blog/assets/f20627c9.html-569cf962.js" as="script"><link rel="prefetch" href="/blog/assets/a2863875.html-77a7951d.js" as="script"><link rel="prefetch" href="/blog/assets/26eab50a.html-cf9cc8bb.js" as="script"><link rel="prefetch" href="/blog/assets/aacd75ab.html-ab9d4162.js" as="script"><link rel="prefetch" href="/blog/assets/fcfc830b.html-799f3b14.js" as="script"><link rel="prefetch" href="/blog/assets/7ee9086b.html-96798ce2.js" as="script"><link rel="prefetch" href="/blog/assets/e15dda2e.html-5c9e9128.js" as="script"><link rel="prefetch" href="/blog/assets/2822c354.html-b174d95d.js" as="script"><link rel="prefetch" href="/blog/assets/c04fdc6c.html-dbb61c22.js" as="script"><link rel="prefetch" href="/blog/assets/db62c118.html-3625c14d.js" as="script"><link rel="prefetch" href="/blog/assets/3db5282.html-03d1a83e.js" as="script"><link rel="prefetch" href="/blog/assets/4cbcfe72.html-10985509.js" as="script"><link rel="prefetch" href="/blog/assets/4c220635.html-9e22f53d.js" as="script"><link rel="prefetch" href="/blog/assets/767a594.html-53cb8618.js" as="script"><link rel="prefetch" href="/blog/assets/e35c106d.html-a942798e.js" as="script"><link rel="prefetch" href="/blog/assets/9e235953.html-c0f47b8d.js" as="script"><link rel="prefetch" href="/blog/assets/47c43abe.html-9620dc0e.js" as="script"><link rel="prefetch" href="/blog/assets/6ec43bd8.html-5357e3e3.js" as="script"><link rel="prefetch" href="/blog/assets/adf541c0.html-221f6b1a.js" as="script"><link rel="prefetch" href="/blog/assets/62beedda.html-78d04d86.js" as="script"><link rel="prefetch" href="/blog/assets/820d6240.html-57029754.js" as="script"><link rel="prefetch" href="/blog/assets/1912667a.html-ca19a18a.js" as="script"><link rel="prefetch" href="/blog/assets/23ac516a.html-efd42d8f.js" as="script"><link rel="prefetch" href="/blog/assets/727d7800.html-53e8873c.js" as="script"><link rel="prefetch" href="/blog/assets/ae8e53be.html-89b588b3.js" as="script"><link rel="prefetch" href="/blog/assets/60f8d92f.html-08af0226.js" as="script"><link rel="prefetch" href="/blog/assets/d3bdcb53.html-f6b15bb9.js" as="script"><link rel="prefetch" href="/blog/assets/4a17b156.html-7ed0f5a8.js" as="script"><link rel="prefetch" href="/blog/assets/f31c11c5.html-a0881fa5.js" as="script"><link rel="prefetch" href="/blog/assets/b3994218.html-aef320ec.js" as="script"><link rel="prefetch" href="/blog/assets/cf83ef31.html-a5f7ac93.js" as="script"><link rel="prefetch" href="/blog/assets/ff927bd4.html-f0a4cd70.js" as="script"><link rel="prefetch" href="/blog/assets/875283bd.html-4c0a334e.js" as="script"><link rel="prefetch" href="/blog/assets/b0793c74.html-46011e82.js" as="script"><link rel="prefetch" href="/blog/assets/9a8e41a8.html-d972c6ee.js" as="script"><link rel="prefetch" href="/blog/assets/1fd30f6e.html-f7747559.js" as="script"><link rel="prefetch" href="/blog/assets/b2cdb69e.html-4acbe6cf.js" as="script"><link rel="prefetch" href="/blog/assets/36721083.html-f76e7794.js" as="script"><link rel="prefetch" href="/blog/assets/3e9e8cb1.html-3bf10339.js" as="script"><link rel="prefetch" href="/blog/assets/375fcf66.html-a8736812.js" as="script"><link rel="prefetch" href="/blog/assets/b4abf652.html-177d7b1a.js" as="script"><link rel="prefetch" href="/blog/assets/3f6454bb.html-17376ba3.js" as="script"><link rel="prefetch" href="/blog/assets/87a89a43.html-15d10ea7.js" as="script"><link rel="prefetch" href="/blog/assets/9d9183ec.html-5039acf6.js" as="script"><link rel="prefetch" href="/blog/assets/24967ad4.html-9aa1cb3a.js" as="script"><link rel="prefetch" href="/blog/assets/135b2780.html-0fb6321a.js" as="script"><link rel="prefetch" href="/blog/assets/8a52763a.html-958a0f23.js" as="script"><link rel="prefetch" href="/blog/assets/fd5546ac.html-bec23bf4.js" as="script"><link rel="prefetch" href="/blog/assets/10414aef.html-f4cff42f.js" as="script"><link rel="prefetch" href="/blog/assets/53875104.html-8281a790.js" as="script"><link rel="prefetch" href="/blog/assets/a64dc0bc.html-62c634b2.js" as="script"><link rel="prefetch" href="/blog/assets/25db0a11.html-7304374e.js" as="script"><link rel="prefetch" href="/blog/assets/ca532ade.html-08d5e05a.js" as="script"><link rel="prefetch" href="/blog/assets/d0edc1ed.html-e6f05692.js" as="script"><link rel="prefetch" href="/blog/assets/6ff87ae7.html-32388da0.js" as="script"><link rel="prefetch" href="/blog/assets/d9a2e1ba.html-eb80d75e.js" as="script"><link rel="prefetch" href="/blog/assets/a8f97c56.html-0876f888.js" as="script"><link rel="prefetch" href="/blog/assets/6e070881.html-e6d9edd1.js" as="script"><link rel="prefetch" href="/blog/assets/9c0ccf0d.html-23d0ed2d.js" as="script"><link rel="prefetch" href="/blog/assets/550e5790.html-ac825bbf.js" as="script"><link rel="prefetch" href="/blog/assets/1a589649.html-5cd51308.js" as="script"><link rel="prefetch" href="/blog/assets/27065732.html-cb99b782.js" as="script"><link rel="prefetch" href="/blog/assets/b00ac86a.html-d9b6fe96.js" as="script"><link rel="prefetch" href="/blog/assets/f7965978.html-9acb7b75.js" as="script"><link rel="prefetch" href="/blog/assets/8d60b485.html-64e6c068.js" as="script"><link rel="prefetch" href="/blog/assets/1f6681a0.html-0b93becb.js" as="script"><link rel="prefetch" href="/blog/assets/101c73f.html-c166a022.js" as="script"><link rel="prefetch" href="/blog/assets/a71f2ecc.html-93a7d99c.js" as="script"><link rel="prefetch" href="/blog/assets/b3af796a.html-0c88ef39.js" as="script"><link rel="prefetch" href="/blog/assets/851be5ef.html-1ad79f61.js" as="script"><link rel="prefetch" href="/blog/assets/9a784fe0.html-ee8158e4.js" as="script"><link rel="prefetch" href="/blog/assets/8d059318.html-4be7e31c.js" as="script"><link rel="prefetch" href="/blog/assets/125c8a12.html-c5240a3a.js" as="script"><link rel="prefetch" href="/blog/assets/11c01876.html-6312dbf3.js" as="script"><link rel="prefetch" href="/blog/assets/466fbe25.html-94303b0c.js" as="script"><link rel="prefetch" href="/blog/assets/2041f2cb.html-40532720.js" as="script"><link rel="prefetch" href="/blog/assets/af2aa19e.html-8081985e.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-d3f04587.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-3c952b12.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-a19289bb.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-e1809b40.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ec371492.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0c3ca2b1.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-7e91c364.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-475e2efc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-222cb052.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0af6c597.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-21b24160.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-8285f497.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-df98ba5d.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-a922da79.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-8661cd65.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0383f4f9.js" as="script"><link rel="prefetch" href="/blog/assets/waline-meta-56fbc549.js" as="script"><link rel="prefetch" href="/blog/assets/component-e19646f5.js" as="script"><link rel="prefetch" href="/blog/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/blog/assets/index-ae8c1e74.js" as="script"><link rel="prefetch" href="/blog/assets/flowchart-d65a1d8e.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-e8fa11b9.js" as="script"><link rel="prefetch" href="/blog/assets/markdown.esm-0191f9da.js" as="script"><link rel="prefetch" href="/blog/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/blog/assets/VuePlayground-a08c1000.js" as="script"><link rel="prefetch" href="/blog/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/blog/assets/index-e32a7948.js" as="script"><link rel="prefetch" href="/blog/assets/pageview-d0122686.js" as="script"><link rel="prefetch" href="/blog/assets/SearchResult-afba9980.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/blog/"><img class="vp-nav-logo" src="/blog/logo.png" alt="JI,XIAOYONG"><!----><span class="vp-site-name">JI,XIAOYONG</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/blog/"><span class="font-icon icon iconfont icon-home" style=""></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/blog/article/"><span class="font-icon icon iconfont icon-blog" style=""></span>归档<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/blog/about.html"><span class="font-icon icon iconfont icon-info" style=""></span>关于<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://github.com/jixiaoyong" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><span class="font-icon icon iconfont icon-github" style=""></span>Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/"><span class="font-icon icon iconfont icon-home" style=""></span>首页<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading active"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">文章</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/caa169b7.html"><!---->Android 5.x 以下加载 MultiDex 白屏的处理优化<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/5754fcd2.html"><!---->Android AlarmManager 设置重复任务<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/e5860bb5.html"><!---->Android paint 绘制 text<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/f931e8ae.html"><!---->Android 中 AIDL 的使用<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/2270057c.html"><!---->Android 中 AIDL 相关知识<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/1b0362b.html"><!---->Android 中 View 相关知识<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b35fe0f7.html"><!---->Android 中 WebView 使用的一些问题<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b0dc2559.html"><!---->Android 中的 Messenger 源码详解<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/c2f123c.html"><!---->Android 中的 SpareArray 和 ArrayMap 实现分析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/c0fefed0.html"><!---->Android 事件分发<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/76d69fc6.html"><!---->Android 今日头条屏幕适配方案的原理梳理<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/a3a3dc4c.html"><!---->Android 多渠道打包知识<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b4832cd1.html"><!---->Android 实现可折叠 toolbar<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/1c56d6b9.html"><!---->Android 开发常用设置<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/5962504e.html"><!---->Android 异步消息机制 Handler、Message、Looper<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/3b69424a.html"><!---->Android 控件组<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/6f46f598.html"><!---->Android 架构模式一览<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/104c9058.html"><!---->Android 笔记之 Xfermode<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/5c023044.html"><!---->Android 笔记之贝塞尔曲线的应用<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/7e97a976.html"><!---->Android 笔记之跨进程通信<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/e3bb9a54.html"><!---->Android 系统架构简介<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/a2c96aac.html"><!---->Android 自定义 View 实现联系人列表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/e41787ec.html"><!---->Android 自定义 view 的一些知识点<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/f20627c9.html"><!---->Android 自定义透明背景的 Dialog<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/a2863875.html"><!---->Android 运行时权限<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/26eab50a.html"><!---->Android 通过 Hook 启动未注册 Activity<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/aacd75ab.html"><!---->Android 阅读笔记<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/12cb887a.html"><!---->Android11 文件分区存储在图片读写的适配<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/ad4c562c.html"><!---->AndroidService 相关知识<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/fcfc830b.html"><!---->AppWidget 的使用之 PendingIntent<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/7ee9086b.html"><!---->AsyncTask 源码解析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/e15dda2e.html"><!---->Compose 屏幕适配<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/c04fdc6c.html"><!---->Dagger 2 ❤️ Android<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/2822c354.html"><!---->Dagger 2 从 0 到 1 之旅<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/db62c118.html"><!---->Dart event loop<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/blog/posts/a951661c.html"><!---->Dart Isolate 源码分析<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#isolate"><!---->Isolate<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#简单使用"><!---->简单使用<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#创建新-isolate-的方式"><!---->创建新 Isolate 的方式：<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#使用方法"><!---->使用方法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#源码分析"><!---->源码分析<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#获取当前-isolate"><!---->获取当前 Isolate<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#创建-isolate"><!---->创建 Isolate<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/posts/a951661c.html#总结"><!---->总结<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/550e5790.html"><!---->Dart VM<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/3db5282.html"><!---->Dart 读取文件过程分析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/4cbcfe72.html"><!---->Flutter APP 绘制过程简析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/767a594.html"><!---->Flutter Expanded VS Flexible<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/4c220635.html"><!---->Flutter UI 绘制与 InheritedWidget 解析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/e35c106d.html"><!---->Flutter Widget 简单入门<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/9e235953.html"><!---->Flutter 中的异常处理<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/47c43abe.html"><!---->Flutter 动画分析之 AnimatedWidget&amp;ImplicitlyAnimatedWidget<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/6ec43bd8.html"><!---->Flutter 动画分析之 AnimationController<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/adf541c0.html"><!---->Flutter 动画分析之 CustomPaint<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/62beedda.html"><!---->Flutter 动画分析之 Hero<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/820d6240.html"><!---->Flutter 动画分析之 Tween&amp;Curve<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/23ac516a.html"><!---->Flutter 图片加载方案分析之 extended_image<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/1912667a.html"><!---->Flutter 图片加载方案分析之 Image<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/727d7800.html"><!---->Flutter 图片加载方案分析之 power_image<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/ae8e53be.html"><!---->Flutter 滑动分析之 NestedScrollView<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/60f8d92f.html"><!---->Flutter 滑动分析之 Scrollview<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/d3bdcb53.html"><!---->Flutter 滑动分析之 SingleChildScrollView<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/4a17b156.html"><!---->Hello World<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/f7965978.html"><!---->Hexo+Github=Blog<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/1fd30f6e.html"><!---->Java 中三种常用的排序方法<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b2cdb69e.html"><!---->Java 中的泛型<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/36721083.html"><!---->Java 创建线程安全的单例 Singleton<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/3e9e8cb1.html"><!---->Java 反射简单应用<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/375fcf66.html"><!---->Java 实现 AES 加密解密应用<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b4abf652.html"><!---->Java 并发编程笔记<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/3f6454bb.html"><!---->Java 注解<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/ff927bd4.html"><!---->Java 笔记之 HashMap 保存数据<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/9a8e41a8.html"><!---->Java 笔记之 ThreadLocal<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/87a89a43.html"><!---->Java 笔记之 YYYY 格式化日期<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/875283bd.html"><!---->Java 笔记之匿名内部类和 final<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/9d9183ec.html"><!---->Java 笔记之序列化与反序列化：Serializable、Externalizable 和 Parcelable<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b0793c74.html"><!---->Java 笔记之计算 Java 对象的大小及其应用<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/24967ad4.html"><!---->Java 线程安全与 volatile 和 synchronize<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/f31c11c5.html"><!---->JVM 内存分配<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b3994218.html"><!---->JVM 类加载机制之 ClassLoader<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/cf83ef31.html"><!---->JVM 类加载机制解析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/135b2780.html"><!---->Kotlin 学习笔记 1<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/8a52763a.html"><!---->Kotlin 学习笔记 2<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/fd5546ac.html"><!---->Kotlin 学习笔记 3<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/10414aef.html"><!---->Kotlin 笔记之 Flow<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/53875104.html"><!---->Lambda 表达式在 kotlin 中的应用<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/a64dc0bc.html"><!---->LeetCode 笔记--重建二叉树<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/ca532ade.html"><!---->Linux 下配置 JDK 和 AndroidStudio 开发环境<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/25db0a11.html"><!---->Linux下配置Git，使用AndroidStudio同步工程到Github<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/d0edc1ed.html"><!---->Linux常用命令<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/6ff87ae7.html"><!---->OKHttpUtils 分析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/a8f97c56.html"><!---->Python 入门知识<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/6e070881.html"><!---->Python 爬取 gityuan 所有文章列表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/9c0ccf0d.html"><!---->Python 爬虫爬取 gityuan.com 数据并输出 json<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/d9a2e1ba.html"><!---->Python 自动创建发布 hexo 文章并同步 github<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/af2aa19e.html"><!---->Python 自动化部署文章<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/1a589649.html"><!---->之前发布的几个 App<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/27065732.html"><!---->从 Sunflower 开始学习优雅的 Jetpack 架构<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b00ac86a.html"><!---->利用 travis 通过 Hexo 在 Github 上自动部署 Markdown 文档<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/8d60b485.html"><!---->加载已安装应用、未安装 apk 中的资源<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/1f6681a0.html"><!---->数据结构_Hash 表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/101c73f.html"><!---->数据结构_二叉树<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/a71f2ecc.html"><!---->数据结构_图<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/b3af796a.html"><!---->数据结构_堆<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/851be5ef.html"><!---->数据结构_总结<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/9a784fe0.html"><!---->数据结构_数组，链表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/8d059318.html"><!---->数据结构_栈和队列<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/125c8a12.html"><!---->数据结构_简单排序<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/11c01876.html"><!---->数据结构_红黑树<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/466fbe25.html"><!---->数据结构_递归和汉诺塔问题<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/posts/2041f2cb.html"><!---->数据结构_高级排序<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/about.html"><span class="font-icon icon iconfont icon-info" style=""></span>关于<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Dart Isolate 源码分析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://jixiaoyong.github.io" target="_blank" rel="noopener noreferrer">JI,XIAOYONG</a></span><span property="author" content="JI,XIAOYONG"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-05-28T07:20:01.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/blog/posts/a951661c.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 30 分钟</span><meta property="timeRequired" content="PT30M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/blog/#isolate">Isolate</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/blog/#简单使用">简单使用</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/blog/#创建新-isolate-的方式">创建新 Isolate 的方式：</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/blog/#使用方法">使用方法</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/blog/#源码分析">源码分析</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/blog/#获取当前-isolate">获取当前 Isolate</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/blog/#创建-isolate">创建 Isolate</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/blog/#总结">总结</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><!--[--><!-- 关于我们 --><div><!-- 其他博文页面 --><div><div style="width:100%;display:inline-block;margin-left:0;"><!----><div class="theme-hope-content"><h2 id="isolate" tabindex="-1"><a class="header-anchor" href="#isolate" aria-hidden="true">#</a> Isolate</h2><p>💡 本文基于 Dart 2.17.1</p><p><a href="https://api.dart.cn/stable/2.17.1/dart-isolate/Isolate-class.html" target="_blank" rel="noopener noreferrer">Isolate<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, an isolated Dart execution context.</p><p>All Dart code runs in an isolate, and <strong>code can access classes and values only from the same isolate</strong>. Different isolates can communicate by <strong>sending values through ports</strong> (see <a href="https://api.dart.cn/stable/2.17.1/dart-isolate/ReceivePort-class.html" target="_blank" rel="noopener noreferrer">ReceivePort<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://api.dart.cn/stable/2.17.1/dart-isolate/SendPort-class.html" target="_blank" rel="noopener noreferrer">SendPort<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>).</p><blockquote><p>In Dart an isolate has its own event loop, its own global fields, can run in parallel with other isolates and have their own live-cycle.<br> — <a href="https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375" target="_blank" rel="noopener noreferrer">https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>The new isolate has its <strong>own memory and its own thread</strong> working in parallel with the main isolate.</p><figure><img src="https://jixiaoyong.github.io/images/isolate_and_isolate_group.png" alt="https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly" tabindex="0" loading="lazy"><figcaption><a href="https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></figcaption></figure><p><a href="https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>Isolate 创建会占用内存，可以使用<code>IsolateGroup</code>来解决，并且目前为止 Dart 和 Flutter 都默认支持在使用<code>Isolate.spawn</code>创建新 Isolate 的时候使用 IsolateGroup（<code>Isolate.spwanUri</code>创建的时候会创建<strong>单独</strong>的 IsolateGroup 和 Isolate）。</p><blockquote><p>💡 在创建 isolate 的时候可以添加<code>addOnExitListener</code> 或者<code>addErrorListener</code>之类的监听，但是可能在执行添加代码的时候<strong>isolate 就已经终止了</strong>而导致这些方法收不到回调。<br> 为了避免这种情况，可以在创建 isolate 的时候指定他的状态为**<code>paused</code>**。</p></blockquote><p>与 isolate 有关的类有：</p><ul><li><code>Isolate</code> 位置在<code>sdk\lib\isolate\isolate.dart</code>。主要是<code>Isolate</code> 通用方法、属性的抽象描述，没有具体实现。</li><li><code>Isolate</code> 位置在<code>sdk\lib\_internal\vm\lib\isolate_patch.dart</code>，是 app 等平台对应的具体实现，部分方法调用了 native 层的 Isolate 实现。</li><li><code>Isolate</code> 位置在<code>runtime\vm\isolate.h</code>以及<code>runtime\vm\isolate.cc</code>中，是 Isolate 的 native 层实现。</li></ul><p>他们的关系大致如图：</p><figure><img src="https://jixiaoyong.github.io/images/isolate_class_dart_and_native.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h2 id="简单使用" tabindex="-1"><a class="header-anchor" href="#简单使用" aria-hidden="true">#</a> 简单使用</h2><h3 id="创建新-isolate-的方式" tabindex="-1"><a class="header-anchor" href="#创建新-isolate-的方式" aria-hidden="true">#</a> 创建新 Isolate 的方式：</h3><ul><li><code>Isolate(``SendPort controlPort``, {this.pauseCapability, this.terminateCapability});</code> 这种方式创建一种<strong>能力受限</strong>的 Isolate。The capabilities should be the subset of the capabilities that are available to the original isolate.本质上并没有在 native 层孵化一个新的 Isolate。</li></ul><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">var</span> newIsolate <span class="token operator">=</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>controlPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newIsolate<span class="token punctuation">.</span><span class="token function">addOnExitListener</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>controlPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newIsolate<span class="token punctuation">.</span><span class="token function">addErrorListener</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>controlPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    newIsolate<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;try kill new isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// after this，the dart code finish</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;finish&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>Isolate.spawn(``void entryPoint(T message), T message,...)</code> 创建一个和当前 Isolate<strong>共享同一份代码</strong>的 Isolate，并执行 entryPoint 方法，一般在 message 中传入 SendPort 以便从 entryPoint 中向来时的 Isolate 发送消息，新建的 Isolate 和当前 Isolate 在同一个 IsolateGroup 中。</li></ul><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">spawnIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> receivePort <span class="token operator">=</span> <span class="token class-name">ReceivePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  receivePort<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;receivePort(</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">) received msg: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建一个和当前的 isolate 共享同一份代码的 Isolate</span>
<span class="token keyword">var</span> isolate <span class="token operator">=</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Isolate initial function(</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">) received msg: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>message <span class="token operator">as</span> <span class="token class-name">SendPort</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;HELLO_FORM_ISOLATE(</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">)&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> receivePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span>debugName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;another_isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>Isolate.spawnUri（Uri uri,List&lt;String&gt; args,var message,...）</code>* 指定的<code>uri</code>中创建并孵化一个 isolate，执行 uri 对应的 library 中的<code>main</code>方法（0~2 个入参），并传入无参、args 或 message 作为参数</li></ul><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">var</span> receivePort <span class="token operator">=</span> <span class="token class-name">ReceivePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  receivePort<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;receivePort(</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression"><span class="token class-name">Isolate</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>debugName</span><span class="token punctuation">}</span></span><span class="token string">) received msg: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建一个和当前的 isolate 共享同一份代码的 Isolate</span>
  <span class="token keyword">var</span> isolate <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span><span class="token function">spawnUri</span><span class="token punctuation">(</span>
      <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">r&quot;E:\workspace\others\flutter_dart_source_code_analysis\lib\dart\another_dart_file_to_spawn_uri.dart&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      receivePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span>
      debugName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;another_isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    receivePort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isolate<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>priority<span class="token punctuation">:</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span>immediate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;try kill new isolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用方法" tabindex="-1"><a class="header-anchor" href="#使用方法" aria-hidden="true">#</a> 使用方法</h3><h4 id="pause" tabindex="-1"><a class="header-anchor" href="#pause" aria-hidden="true">#</a> <strong>pause</strong></h4><p><code>Capability pause([Capability? resumeCapability])</code>，暂停 Isolate，停止从*<code>event loop queue</code>* 中取（并处理）消息，但是依然可以往里面加入消息</p><p><em><code>resumeCapability</code></em> 是用来区分 pause 的，必须使用同一个*<code>resumeCapability</code>*来 resume isolate。</p><ul><li>使用同一个*<code>resumeCapability</code>*多次<code>pause</code>，只需一次<code>resume</code>就可以恢复<code>isolate</code></li><li>使用不同*<code>resumeCapability</code><em>多次<code>pause</code>，必须使用对应的</em><code>resumeCapability</code><em>依次<code>resume</code>才可以恢复<code>isolate</code> （<strong>注意</strong>：这里也只需要使用当时 pause isolate 的</em><code>resumeCapability</code>* 依次调用 resume 即可，而不用保持次数一致，比如，有 2 个*<code>resumeCapability</code> ，*调用 pause 次数分别为 a 1,b 2，那么要想 resume isolate，也只需要分别使用 a,b 调用一次 resume 即可）</li></ul><h4 id="ping" tabindex="-1"><a class="header-anchor" href="#ping" aria-hidden="true">#</a> ping</h4><p>使用 isolate 往<code>receivePort.sendPort</code>发送 response 消息，<strong>即使 isolate 当前被 pause 也可以正常发送</strong></p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code>isolate<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
isolate<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span>receivePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;is isolate resume?&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//receivePort 依然可以收到消息</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ping 可以正常发送的原因是：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; lib\isolate\isolate.dart</span>

<span class="token comment">// ping 方法是一个 external 方法</span>
<span class="token keyword">external</span> <span class="token keyword">void</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span> responsePort<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Object</span><span class="token operator">?</span> response<span class="token punctuation">,</span> int priority <span class="token operator">=</span> immediate<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span>

<span class="token metadata function">@patch</span>
  <span class="token keyword">void</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span> responsePort<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Object</span><span class="token operator">?</span> response<span class="token punctuation">,</span> int priority<span class="token punctuation">:</span> immediate<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">filled</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// Make room for OOM message type.</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _PING
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> responsePort
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> priority
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">;</span>
    <span class="token function">_sendOOB</span><span class="token punctuation">(</span>controlPort<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_sendOOB&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_sendOOB</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// -&gt; runtime/lib/isolate.cc</span>

<span class="token comment">// 创建了一个 oob 消息并压入 oob_queue_</span>
<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_sendOOB</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">GET_NON_NULL_NATIVE_ARGUMENT</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> arguments<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NativeArgAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">GET_NON_NULL_NATIVE_ARGUMENT</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> arguments<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NativeArgAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Make sure to route this request to the isolate library OOB mesage handler.</span>
  <span class="token class-name"><span class="token namespace">msg<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Smi</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Smi</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">:</span><span class="token punctuation">:</span>kIsolateLibOOBMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Ensure message writer (and it&#39;s resources, e.g. forwarding tables) are</span>
  <span class="token comment">// cleaned up before handling interrupts.</span>
  <span class="token punctuation">{</span>
    <span class="token class-name">PortMap</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">PostMessage</span><span class="token punctuation">(</span><span class="token class-name">WriteMessage</span><span class="token punctuation">(</span><span class="token comment">/* can_send_any_object */</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                      <span class="token comment">/* same_group */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">port<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token class-name">Message</span><span class="token punctuation">:</span><span class="token punctuation">:</span>kOOBPriority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Drain interrupts before running so any IMMEDIATE operations on the current</span>
  <span class="token comment">// isolate happen synchronously.</span>
  <span class="token keyword">const</span> <span class="token class-name">Error</span><span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>thread<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">HandleInterrupts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Exceptions</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">PropagateError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNREACHABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 MessageHandler 中有两种 MessageQueue：<code>oob_queue_</code>和<code>queue_</code> ，前者优先级高，即使 isolate 被 pause 也会执行</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\vm\message_handler.h</span>

<span class="token comment">// 普通消息，暂停时不能处理</span>
<span class="token class-name">MessageQueue</span><span class="token operator">*</span> queue_<span class="token punctuation">;</span>
<span class="token comment">// 优先消息，即使处理消息时，优先处理 obb_queue 消息，如果为空再去考虑处理普通消息</span>
<span class="token comment">// 即使 isolate 被 pause 也可以被处理</span>
<span class="token class-name">MessageQueue</span><span class="token operator">*</span> oob_queue_<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>像是<code>ping</code>/<code>kill</code>/<code>pause</code>/<code>addOnExitListener</code>/<code>removeOnExitListener</code>这些指令消息都是压入到<code>obb_queue_</code>中优先处理的。</p><h2 id="源码分析" tabindex="-1"><a class="header-anchor" href="#源码分析" aria-hidden="true">#</a> 源码分析</h2><p>先看一下常用的几个方法是怎么实现的。</p><h3 id="获取当前-isolate" tabindex="-1"><a class="header-anchor" href="#获取当前-isolate" aria-hidden="true">#</a> 获取当前 Isolate</h3><p>（<em>sdk/lib/isolate/isolate.dart</em>）<code>Isolate.current</code> →</p><p>(<em>sdk/lib/_internal/vm/lib/isolate_patch.dart</em>) <code>Isolate get current</code> → <code>Isolate._getCurrentIsolate()</code> → <code>_getPortAndCapabilitiesOfCurrentIsolate()</code></p><p>（<em>runtime/lib/isolate.cc</em>）<code>DEFINE_NATIVE_ENTRY(Isolate_getPortAndCapabilitiesOfCurrentIsolate, 0, 0)</code></p><p>先看一下<em>sdk/lib/_internal/vm/lib/isolate_patch.dart</em>中的实现：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> _currentIsolate <span class="token operator">=</span> <span class="token function">_getCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token metadata function">@patch</span>
  <span class="token keyword">static</span> <span class="token class-name">Isolate</span> <span class="token keyword">get</span> current <span class="token operator">=</span><span class="token operator">&gt;</span> _currentIsolate<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">Isolate</span> <span class="token function">_getCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span> portAndCapabilities <span class="token operator">=</span> <span class="token function">_getPortAndCapabilitiesOfCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 这里的参数分别是 SendPort，Capability，Capability</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span>portAndCapabilities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        pauseCapability<span class="token punctuation">:</span> portAndCapabilities<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        terminateCapability<span class="token punctuation">:</span> portAndCapabilities<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_getPortAndCapabilitiesOfCurrentIsolate&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token class-name">List</span> <span class="token function">_getPortAndCapabilitiesOfCurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，最后是根据 native 端返回的信息，新建了一个 Isolate 引用，但是因为<code>_currentIsolate</code>是<code>static final</code>的，所以只会被调用一次，确保了在 Dart SDK 中调用<code>Isolate.current</code> 时获取的是当前唯一的 Isolate。</p><p>让我们看一下在 native 中是如何找到当前的 Isolate 的：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; \runtime\lib\isolate.cc</span>

<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_getPortAndCapabilitiesOfCurrentIsolate</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">Array</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">result<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">result<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">pause_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">result<span class="token punctuation">.</span></span>SetAt</span><span class="token punctuation">(</span>
      <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">Capability</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">terminate_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可见是直接取的<strong>当前线程对应的 isolate</strong>对应的值，经过包装再返回到调用方。</p><h3 id="创建-isolate" tabindex="-1"><a class="header-anchor" href="#创建-isolate" aria-hidden="true">#</a> 创建 Isolate</h3><p>在 Dart 中创建 Isolate 有 3 种方式：</p><ul><li><code>Isolate(this.controlPort, {this.pauseCapability, this.terminateCapability});</code> <strong>*create</strong> an* <em>isolate，本质上只是将</em><code>controlPort</code> 等设置为传入的对象，并没有在 native 层新建 Isolate</li><li><code>Isolate.spawn</code> <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li><li><code>Isolate.spawnUri</code> <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li></ul><figure><img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这里分析一下后面两种方式，对比一下差异：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk\lib\isolate\isolate.dart</span>

<span class="token comment">// Creates a new [Isolate] object with a restricted set of capabilities.</span>
<span class="token class-name">Isolate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controlPort<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>pauseCapability<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>terminateCapability<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// Creates and spawns an isolate that shares the same code as the current</span>
<span class="token comment">/// isolate.</span>
<span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> spawn<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      <span class="token keyword">void</span> <span class="token function">entryPoint</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">T</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      <span class="token metadata function">@Since</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;2.3&quot;</span></span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/// Creates and spawns an isolate that runs the code from the library with</span>
  <span class="token comment">/// the specified URI.</span>
  <span class="token comment">///</span>
  <span class="token comment">/// The isolate starts executing the top-level `main` function of the library</span>
  <span class="token comment">/// with the given URI.</span>
	<span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">spawnUri</span><span class="token punctuation">(</span>
      <span class="token class-name">Uri</span> uri<span class="token punctuation">,</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">,</span>
      <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      bool<span class="token operator">?</span> checked<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> environment<span class="token punctuation">,</span>
      <span class="token metadata function">@Deprecated</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;The packages/ dir is not supported in Dart 2&#39;</span></span><span class="token punctuation">)</span>
          <span class="token class-name">Uri</span><span class="token operator">?</span> packageRoot<span class="token punctuation">,</span>
      <span class="token class-name">Uri</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      bool automaticPackageResolution <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token metadata function">@Since</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;2.3&quot;</span></span><span class="token punctuation">)</span>
          <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 APP 等来说，上述<code>Isolate.spawn</code>和<code>Isolate.spawnUri</code>的实现都在<code>vm</code>下面的<code>isolate_patch.dart</code>中（js 会返回<code>_unsupported()</code>）：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk\lib\_internal\vm\lib\isolate_patch.dart</span>

  <span class="token metadata function">@patch</span>
  <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> spawn<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">entryPoint</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">T</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// `paused` isn&#39;t handled yet.</span>
    <span class="token comment">// Check for the type of `entryPoint` on the spawning isolate to make</span>
    <span class="token comment">// error-handling easier.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entryPoint <span class="token operator">is!</span> _UnaryFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentError</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// The VM will invoke [_startIsolate] with entryPoint as argument.</span>

    <span class="token comment">// We do not inherit the package config settings from the parent isolate,</span>
    <span class="token comment">// instead we use the values that were set on the command line.</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">final</span> <span class="token class-name">RawReceivePort</span> readyPort <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">RawReceivePort</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&#39;Isolate.spawn ready&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token operator">*</span>_spawnFunction<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>readyPort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span> script<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> message<span class="token punctuation">,</span>
          paused<span class="token punctuation">,</span> errorsAreFatal<span class="token punctuation">,</span> onExit<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> packageConfig<span class="token punctuation">,</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token operator">*</span><span class="token operator">*</span>_spawnCommon<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>readyPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> st<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token metadata function">@patch</span>
  <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">spawnUri</span><span class="token punctuation">(</span><span class="token class-name">Uri</span> uri<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">,</span> <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>bool paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      bool errorsAreFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      bool<span class="token operator">?</span> checked<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> environment<span class="token punctuation">,</span>
      <span class="token class-name">Uri</span><span class="token operator">?</span> packageRoot<span class="token punctuation">,</span>
      <span class="token class-name">Uri</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      bool automaticPackageResolution <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>

    <span class="token comment">// Verify that no mutually exclusive arguments have been passed.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Resolve the uri against the current isolate&#39;s root Uri first.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// The VM will invoke [_startIsolate] and not `main`.</span>
    <span class="token keyword">final</span> packageConfigString <span class="token operator">=</span> packageConfig<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">RawReceivePort</span> readyPort <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">RawReceivePort</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&#39;Isolate.spawnUri ready&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token operator">*</span>_spawnUri<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>
          readyPort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span>
          spawnedUri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          args<span class="token punctuation">,</span>
          message<span class="token punctuation">,</span>
          paused<span class="token punctuation">,</span>
          onExit<span class="token punctuation">,</span>
          onError<span class="token punctuation">,</span>
          errorsAreFatal<span class="token punctuation">,</span>
          checked<span class="token punctuation">,</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token comment">/* environment */</span>
          packageConfigString<span class="token punctuation">,</span>
          debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token operator">*</span><span class="token operator">*</span>_spawnCommon<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>readyPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">rethrow</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">//  Isolate.spawn call</span>
<span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_spawnFunction&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_spawnFunction</span><span class="token punctuation">(</span>
      <span class="token class-name">SendPort</span> readyPort<span class="token punctuation">,</span>
      <span class="token class-name">String</span> uri<span class="token punctuation">,</span>
      <span class="token class-name">Function</span> topLevelFunction<span class="token punctuation">,</span>
      <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      bool paused<span class="token punctuation">,</span>
      bool errorsAreFatal<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  Isolate.spawnUri call</span>
<span class="token metadata function">@pragma</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;vm:external-name&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;Isolate_spawnUri&quot;</span></span><span class="token punctuation">)</span>
  <span class="token keyword">external</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_spawnUri</span><span class="token punctuation">(</span>
      <span class="token class-name">SendPort</span> readyPort<span class="token punctuation">,</span>
      <span class="token class-name">String</span> uri<span class="token punctuation">,</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">,</span>
      <span class="token keyword">var</span> message<span class="token punctuation">,</span>
      bool paused<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onExit<span class="token punctuation">,</span>
      <span class="token class-name">SendPort</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
      bool errorsAreFatal<span class="token punctuation">,</span>
      bool<span class="token operator">?</span> checked<span class="token punctuation">,</span>
      <span class="token class-name">List</span><span class="token operator">?</span> environment<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> packageConfig<span class="token punctuation">,</span>
      <span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听 Isolate spawn 状态，等成功之后将其处理后返回给 Dart 层的调用者</span>
<span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">_spawnCommon</span><span class="token punctuation">(</span><span class="token class-name">RawReceivePort</span> readyPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> completer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Completer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token keyword">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    readyPort<span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token punctuation">(</span>readyMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      readyPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>readyMessage <span class="token operator">is</span> <span class="token class-name">List</span> <span class="token operator">&amp;&amp;</span> readyMessage<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SendPort</span> controlPort <span class="token operator">=</span> readyMessage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span> capabilities <span class="token operator">=</span> readyMessage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token operator">*</span>completer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span>controlPort<span class="token punctuation">,</span>
            pauseCapability<span class="token punctuation">:</span> capabilities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            terminateCapability<span class="token punctuation">:</span> capabilities<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>readyMessage <span class="token operator">is</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We encountered an error while starting the new isolate.</span>
        completer<span class="token punctuation">.</span><span class="token function">completeError</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsolateSpawnException</span><span class="token punctuation">(</span>
            <span class="token string-literal"><span class="token string">&#39;Unable to spawn isolate: </span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">readyMessage</span><span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// This shouldn&#39;t happen.</span>
        completer<span class="token punctuation">.</span><span class="token function">completeError</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsolateSpawnException</span><span class="token punctuation">(</span>
            <span class="token string-literal"><span class="token string">&quot;Internal error: unexpected format for ready message: &quot;</span></span>
            <span class="token string-literal"><span class="token string">&quot;&#39;</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">readyMessage</span><span class="token punctuation">}</span></span><span class="token string">&#39;&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> completer<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其实，根据上述的代码，不管是<code>Isolate.spawnUri()</code> 还是<code>Isolate.spawn</code>，都是先调用<code>RawReceivePort</code>获取<code>RawReceivePort readyPort</code>，最后都是调用了<code>_spawnCommon(readyPort)</code> 方法，最终通过<code>new Isolate(controlPort, pauseCapability: capabilities[0], terminateCapability: capabilities[1])</code>方法创建了新的<code>Isolate</code> 。</p><p>这个方法的定义在<code>sdk/lib/isolate/isolate.dart</code>中：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; sdk/lib/isolate/isolate.dart</span>
<span class="token keyword">final</span> <span class="token class-name">SendPort</span> controlPort<span class="token punctuation">;</span>

<span class="token class-name">Isolate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controlPort<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>pauseCapability<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>terminateCapability<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在 Dart 中，我们拿到的 Isolate 主要是<strong>持有一个和 native 中对应 SendPort</strong>。</p><p>通过上面的分析：</p><ul><li><code>Isolate.spawn</code>最后调用了<code>_spawnFunction</code>方法（native 层实现为<code>Isolate_spawnFunction</code>）；</li><li><code>Isolate.spawnUri</code>最后调用了<code>_spawnUri</code>方法（native 层实现为<code>Isolate_spawnUri</code>）。</li></ul><blockquote><p>💡 <code>new RawReceivePort()</code>方法主要是创建一个不存在于<code>_RawReceivePortImpl</code>的<code>static final _portMap = &lt;int, Map&lt;String, dynamic&gt;&gt;{};</code> 中的 SendPort（具体实现在<code>PortMap::CreatePort</code>中）。</p></blockquote><h4 id="isolate-spawnfunction" tabindex="-1"><a class="header-anchor" href="#isolate-spawnfunction" aria-hidden="true">#</a> Isolate_spawnFunction</h4><p><code>Isolate.spawn</code>最后调用了<code>_spawnFunction</code>方法，来看一下对应的<code>Isolate_spawnFunction</code> 的实现：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\lib\isolate.cc</span>

<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_spawnFunction</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 解析参数</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// closure_tuple_handle 对应我们在 Dart 中 Isolate.spawn() 中传入的 entryPoint</span>
    <span class="token comment">// 也就是 isolate 创建好以后执行的方法</span>

  std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateSpawnState</span><span class="token punctuation">&gt;</span></span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsolateSpawnState</span><span class="token punctuation">(</span>
      <span class="token class-name"><span class="token namespace">port<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String2UTF8</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">)</span><span class="token punctuation">,</span>
      closure_tuple_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>message_buffer<span class="token punctuation">,</span> utf8_package_config<span class="token punctuation">,</span>
      paused<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fatal_errors<span class="token punctuation">,</span> on_exit_port<span class="token punctuation">,</span> on_error_port<span class="token punctuation">,</span>
      utf8_debug_name<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Since this is a call to Isolate.spawn, copy the parent isolate&#39;s code.</span>
  state<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>copy_parent_code <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Run</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpawnIsolateTask</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                                                         std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可见，<code>Isolate_spawnFunction</code>方法中主要还是解析收到的各种参数，最后在当前 isolate 对应的 IsolateGroup 的线程池中执行<code>SpawnIsolateTask</code>：</p><h5 id="spawnisolatetask" tabindex="-1"><a class="header-anchor" href="#spawnisolatetask" aria-hidden="true">#</a> SpawnIsolateTask</h5><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\lib\isolate.cc</span>

<span class="token keyword">class</span> <span class="token class-name">SpawnIsolateTask</span> <span class="token punctuation">:</span> public <span class="token class-name">ThreadPool</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Task</span> <span class="token punctuation">{</span>
	<span class="token class-name">SpawnIsolateTask</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token operator">*</span> parent_isolate<span class="token punctuation">,</span>
                   std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateSpawnState</span><span class="token punctuation">&gt;</span></span> state<span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token function">parent_isolate_</span><span class="token punctuation">(</span>parent_isolate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">state_</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parent_isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">IncrementSpawnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token class-name">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">const</span> char<span class="token operator">*</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
                           <span class="token operator">?</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">function_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                           <span class="token punctuation">:</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    auto group <span class="token operator">=</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">RunHeavyweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">RunLightweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="runlightweight" tabindex="-1"><a class="header-anchor" href="#runlightweight" aria-hidden="true">#</a> RunLightWeight</h5><p>因为这里我们的<code>isolate→group</code>不为空，所以走的是<code>RunLightWeight</code>:</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\lib\isolate.cc</span>

<span class="token keyword">void</span> <span class="token class-name">RunLightweight</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The create isolate initialize callback is mandatory.</span>
    auto initialize_callback <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitializeCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialize_callback <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">&quot;Lightweight isolate spawn is not supported by this Dart embedder\n&quot;</span></span><span class="token punctuation">,</span>
          <span class="token comment">/*has_current_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    char<span class="token operator">*</span> error <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    auto group <span class="token operator">=</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> isolate <span class="token operator">=</span> <span class="token class-name">CreateWithinExistingIsolateGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    parent_isolate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">DecrementSpawnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parent_isolate_ <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token comment">/*has_current_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span><span class="token operator">*</span> child_isolate_data <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token keyword">const</span> bool success <span class="token operator">=</span> <span class="token function">initialize_callback</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>child_isolate_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Dart_ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_init_callback_data</span><span class="token punctuation">(</span>child_isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 注意这里的 Run 方法，在**RunHeavyweight 方法的最后也调用了</span>
    <span class="token comment">// 到时候会一起分析一下</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Run</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\dart_api_impl.cc</span>

<span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">CreateWithinExistingIsolateGroup</span><span class="token punctuation">(</span><span class="token class-name">IsolateGroup</span><span class="token operator">*</span> group<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">,</span>
                                          char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">API_TIMELINE_DURATION</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_NO_ISOLATE</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  auto spawning_group <span class="token operator">=</span> group<span class="token punctuation">;</span>

  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> isolate <span class="token operator">=</span><span class="token operator">*</span><span class="token operator">*</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">Isolate</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>spawning_group<span class="token punctuation">,</span> <span class="token comment">/*is_new_group=*/</span><span class="token boolean">false</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span>
                    <span class="token comment">/*isolate_data=*/</span>nullptr<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>

	<span class="token comment">// 因为执行到这里的都有 IsolateGroup，共享同一份代码</span>
  auto source <span class="token operator">=</span> spawning_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里主要进行了 2 步：</p><ul><li>使用<code>CreateWithinExistingIsolateGroup</code>创建 Isolate</li><li>使用全局的<code>initialize_callback</code> （也就是<code>Isolate::InitializeCallback()</code>）初始化 Isolate</li></ul><h6 id="isolate-initializecallback" tabindex="-1"><a class="header-anchor" href="#isolate-initializecallback" aria-hidden="true">#</a> Isolate::InitializeCallback()</h6><p>这其中的<code>Isolate::InitializeCallback()</code>是在<code>Dart::Init</code>的时候就已经设置了的：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime/bin/main.cc</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char<span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// Initialize the Dart VM.</span>
  <span class="token class-name">Dart_InitializeParams</span> init_params<span class="token punctuation">;</span>
	init_params<span class="token punctuation">.</span>version <span class="token operator">=</span> DART_INITIALIZE_PARAMS_CURRENT_VERSION<span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>vm_snapshot_data <span class="token operator">=</span> vm_snapshot_data<span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>vm_snapshot_instructions <span class="token operator">=</span> vm_snapshot_instructions<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span>init_params<span class="token punctuation">.</span>create_group <span class="token operator">=</span> <span class="token class-name">CreateIsolateGroupAndSetup</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token operator">*</span><span class="token operator">*</span>init_params<span class="token punctuation">.</span>initialize_isolate <span class="token operator">=</span> <span class="token class-name">OnIsolateInitialize</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  init_params<span class="token punctuation">.</span>shutdown_isolate <span class="token operator">=</span> <span class="token class-name">OnIsolateShutdown</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>cleanup_isolate <span class="token operator">=</span> <span class="token class-name">DeleteIsolateData</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>cleanup_group <span class="token operator">=</span> <span class="token class-name">DeleteIsolateGroupData</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_open <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">OpenFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_read <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">ReadFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_write <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">WriteFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>file_close <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CloseFile</span><span class="token punctuation">;</span>
  init_params<span class="token punctuation">.</span>entropy_source <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">EntropySource</span><span class="token punctuation">;</span>

	error <span class="token operator">=</span> <span class="token class-name">Dart_Initialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\dart_api_impl.cc</span>

DART_EXPORT char<span class="token operator">*</span> <span class="token class-name">Dart_Initialize</span><span class="token punctuation">(</span><span class="token class-name">Dart_InitializeParams</span><span class="token operator">*</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">&quot;Dart_Initialize: &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;Dart_InitializeParams is null.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>version <span class="token operator">!=</span> DART_INITIALIZE_PARAMS_CURRENT_VERSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">&quot;Dart_Initialize: &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;Invalid Dart_InitializeParams version.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\dart.cc</span>

char<span class="token operator">*</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Dart_InitializeParams</span><span class="token operator">*</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">init_state_<span class="token punctuation">.</span></span>SetInitializing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">&quot;Bad VM initialization state, &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;already initialized or &quot;</span></span>
        <span class="token string-literal"><span class="token string">&quot;multiple threads initializing the VM.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  char<span class="token operator">*</span> retval <span class="token operator">=</span> <span class="token class-name">DartInit</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name"><span class="token namespace">init_state_<span class="token punctuation">.</span></span>ResetInitializing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name"><span class="token namespace">init_state_<span class="token punctuation">.</span></span>SetInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

char<span class="token operator">*</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">DartInit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Dart_InitializeParams</span><span class="token operator">*</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token class-name">OSThread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Zone</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">IsolateGroup</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">PortMap</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Service</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">ExitIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Unregister the VM isolate from this thread.</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetCreateGroupCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>create_group<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetInitializeCallback_</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>initialize_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetShutdownCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>shutdown_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetCleanupCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>cleanup_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetGroupCleanupCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>cleanup_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetRegisterKernelBlobCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>register_kernel_blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetUnregisterKernelBlobCallback</span><span class="token punctuation">(</span>params<span class="token operator">-</span><span class="token operator">&gt;</span>unregister_kernel_blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说，上文的<code>Isolate::InitializeCallback()</code>实际上就是<code>OnIsolateInitialize</code>，它的主要作用就是在 isolate 创建好之后进行统一的初始化操作，绑定一些数据：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\bin\main.cc</span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">OnIsolateInitialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> child_callback_data<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dart_Isolate isolate <span class="token operator">=</span> <span class="token function">Dart_CurrentIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>isolate <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> isolate_group_data <span class="token operator">=</span>
      <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>IsolateGroupData<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">Dart_CurrentIsolateGroupData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateData</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>child_callback_data <span class="token operator">=</span> isolate_data<span class="token punctuation">;</span>

  <span class="token function">Dart_EnterScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">*</span><span class="token operator">*</span>script_uri<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">=</span> isolate_group_data<span class="token operator">-&gt;</span>script_url<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">bool</span> <span class="token operator">*</span><span class="token operator">*</span>isolate_run_app_snapshot<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">=</span>
      isolate_group_data<span class="token operator">-&gt;</span><span class="token function">RunFromAppSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Dart_Handle <span class="token operator">*</span><span class="token operator">*</span>result<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">=</span> <span class="token function">SetupCoreLibraries</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span>
                                          <span class="token comment">/*group_start=*/</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                                          <span class="token comment">/*resolved_packages_config=*/</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate_run_app_snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token class-name">Loader</span><span class="token double-colon punctuation">::</span><span class="token function">InitForSnapshot</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token class-name">DartUtils</span><span class="token double-colon punctuation">::</span><span class="token function">ResolveScript</span><span class="token punctuation">(</span><span class="token function">Dart_NewStringFromCString</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate_group_data<span class="token operator">-&gt;</span><span class="token function">kernel_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Various core-library parts will send requests to the Loader to resolve</span>
      <span class="token comment">// relative URIs and perform other related tasks. We need Loader to be</span>
      <span class="token comment">// initialized for this to work because loading from Kernel binary</span>
      <span class="token comment">// bypasses normal source code loading paths that initialize it.</span>
      <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> resolved_script_uri <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">Dart_StringToCString</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resolved_script_uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token class-name">Loader</span><span class="token double-colon punctuation">::</span><span class="token function">InitForSnapshot</span><span class="token punctuation">(</span>resolved_script_uri<span class="token punctuation">,</span> isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">Dart_ExitScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

failed<span class="token operator">:</span>
  <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">StrDup</span><span class="token punctuation">(</span><span class="token function">Dart_GetError</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Dart_ExitScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="createwithinexistingisolategroup" tabindex="-1"><a class="header-anchor" href="#createwithinexistingisolategroup" aria-hidden="true">#</a> CreateWithinExistingIsolateGroup</h6><p><code>CreateWithinExistingIsolateGroup</code> → <code>CreateIsolate</code></p><p>再看一下创建 Isolate 的具体方法，这个在不同的 device 上面不一样，我们只关注 vm 下面的实现：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\vm\dart_api_impl.cc</span>

<span class="token keyword">static</span> <span class="token class-name">Dart_Isolate</span> <span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span><span class="token class-name">IsolateGroup</span><span class="token operator">*</span> group<span class="token punctuation">,</span>
                                  bool is_new_group<span class="token punctuation">,</span>
                                  <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">,</span>
                                  <span class="token keyword">void</span><span class="token operator">*</span> isolate_data<span class="token punctuation">,</span>
                                  char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token operator">*</span>CHECK_NO_ISOLATE<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  auto source <span class="token operator">=</span> group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">I</span> <span class="token operator">=</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>flags<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">I</span> <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Isolate creation failed&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dart_Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Thread</span><span class="token operator">*</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    <span class="token class-name">StackZone</span> <span class="token function">zone</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We enter an API scope here as InitializeIsolate could compile some</span>
    <span class="token comment">// bootstrap library files which call out to a tag handler that may create</span>
    <span class="token comment">// Api Handles when an error is encountered.</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">EnterApiScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">Error</span><span class="token operator">&amp;</span> error_obj <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
        <span class="token class-name">Z</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitializeIsolate</span><span class="token punctuation">(</span>
               source<span class="token operator">-</span><span class="token operator">&gt;</span>snapshot_data<span class="token punctuation">,</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>snapshot_instructions<span class="token punctuation">,</span>
               source<span class="token operator">-</span><span class="token operator">&gt;</span>kernel_buffer<span class="token punctuation">,</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>kernel_buffer_size<span class="token punctuation">,</span>
               is_new_group <span class="token operator">?</span> nullptr <span class="token punctuation">:</span> group<span class="token punctuation">,</span> isolate_data<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">error_obj<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FLAG_check_function_fingerprints</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">FLAG_precompiled_mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Library</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CheckFunctionFingerprints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
#endif  <span class="token comment">// defined(DEBUG) &amp;&amp; !defined(DART_PRECOMPILED_RUNTIME).</span>
      success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">StrDup</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">error_obj<span class="token punctuation">.</span></span>ToErrorCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// We exit the API scope entered above.</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">ExitApiScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_new_group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">InitGrowthControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// A Thread structure has been associated to the thread, we do the</span>
    <span class="token comment">// safepoint transition explicitly here instead of using the</span>
    <span class="token comment">// TransitionXXX scope objects as the reverse transition happens</span>
    <span class="token comment">// outside this scope in Dart_ShutdownIsolate/Dart_ExitIsolate.</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_execution_state</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span>kThreadInNative<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">EnterSafepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Api</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CastIsolate</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dart_Isolate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里主要有两步：</p><ul><li><code>Dart::CreateIsolate</code>创建了<code>Isolate* I</code>；</li><li>然后调用<code>Dart::InitializeIsolate</code>初始化 isolate。</li></ul><p><strong>Dart::CreateIsolate：</strong></p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\vm\dart.cc</span>

<span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name_prefix<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">&amp;</span> api_flags<span class="token punctuation">,</span>
                             <span class="token class-name">IsolateGroup</span><span class="token operator">*</span> isolate_group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create a new isolate.</span>
  <span class="token class-name">Isolate</span><span class="token operator">*</span> isolate <span class="token operator">=</span>
      <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitIsolate</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">,</span> isolate_group<span class="token punctuation">,</span> api_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>💡 在 Dart 虚拟机启动（<code>Dart::DartInit</code>）的时候，也会调用<code>Dart::InitIsolate</code>创建虚拟机对应的 Isolate，执行 UI 操作：<br><code>vm_isolate_ = Isolate::InitIsolate(kVmIsolateName, group, api_flags, is_vm_isolate);</code></p></blockquote><p>在<code>Isolate::InitIsolate</code>方法中，先是用<code>isolate_group</code>创建了新的 Isolate，然后将其与<code>Thread</code>，<code>MessageHandler</code>，<code>SendPort</code>等绑定：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\vm\isolate.cc</span>

<span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitIsolate</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name_prefix<span class="token punctuation">,</span>
                              <span class="token class-name">IsolateGroup</span><span class="token operator">*</span> isolate_group<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">&amp;</span> api_flags<span class="token punctuation">,</span>
                              bool is_vm_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 创建新的 Isolate</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Isolate</span><span class="token operator">*</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Isolate</span><span class="token punctuation">(</span>isolate_group<span class="token punctuation">,</span> api_flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">BuildName</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_vm_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vm isolate object store is initialized later, after null instance</span>
    <span class="token comment">// is created (in Dart::Init).</span>
    <span class="token comment">// Non-vm isolates need to have isolate object store initialized is that</span>
    <span class="token comment">// exit_listeners have to be null-initialized as they will be used if</span>
    <span class="token comment">// we fail to create isolate below, have to do low level shutdown.</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ASSERT</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
<span class="token comment">// Initialize metrics.</span>
#define <span class="token function">ISOLATE_METRIC_INIT</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> variable<span class="token punctuation">,</span> name<span class="token punctuation">,</span> unit<span class="token punctuation">)</span>                        \
  result<span class="token operator">-</span><span class="token operator">&gt;</span>metric_##variable##_<span class="token punctuation">.</span><span class="token function">InitInstance</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> name<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> <span class="token class-name">Metric</span><span class="token punctuation">:</span><span class="token punctuation">:</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ISOLATE_METRIC_LIST</span><span class="token punctuation">(</span>ISOLATE_METRIC_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
#undef ISOLATE_METRIC_INIT
#endif  <span class="token comment">// !defined(PRODUCT)</span>

  <span class="token comment">// First we ensure we enter the isolate. This will ensure we&#39;re participating</span>
  <span class="token comment">// in any safepointing requests from this point on. Other threads requesting a</span>
  <span class="token comment">// safepoint operation will therefore wait until we&#39;ve stopped.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Though the [result] isolate is still in a state where no memory has been</span>
  <span class="token comment">// allocated, which means it&#39;s safe to GC the isolate group until here.</span>
  <span class="token comment">// 创建一个 Thread 并和当前 isolate 绑定</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">EnterIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    delete result<span class="token punctuation">;</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Setup the isolate message handler.</span>
  <span class="token class-name">MessageHandler</span><span class="token operator">*</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IsolateMessageHandler</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>handler <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 在这里绑定了 message handler</span>
  <span class="token operator">*</span><span class="token operator">*</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_message_handler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>

  <span class="token operator">*</span><span class="token operator">*</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_main_port</span><span class="token punctuation">(</span><span class="token class-name">PortMap</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreatePort</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
  <span class="token comment">// Verify that we are never reusing a live origin id.</span>
  <span class="token class-name">VerifyOriginId</span> <span class="token function">id_verifier</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">VisitIsolates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id_verifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_origin_id</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_pause_capability</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NextUInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_terminate_capability</span><span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NextUInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
  result<span class="token operator">-</span><span class="token operator">&gt;</span>debugger_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Debugger</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token comment">// Now we register the isolate in the group. From this point on any GC would</span>
  <span class="token comment">// traverse the isolate roots (before this point, the roots are only pointing</span>
  <span class="token comment">// to vm-isolate objects, e.g. null)</span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">RegisterIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">NameEquals</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetServiceIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KernelIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">NameEquals</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">KernelIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">KernelIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SetKernelIsolate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif  <span class="token comment">// !defined(DART_PRECOMPILED_RUNTIME)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FLAG_trace_isolates</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name_prefix <span class="token operator">==</span> nullptr <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>name_prefix<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;vm-isolate&quot;</span></span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      OS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">PrintErr</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">&quot;[+] Starting isolate:\n&quot;</span></span>
          <span class="token string-literal"><span class="token string">&quot;\tisolate:    %s\n&quot;</span></span><span class="token punctuation">,</span>
          result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Add to isolate list. Shutdown and delete the isolate on failure.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TryMarkIsolateReady</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">LowLevelShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">LowLevelCleanup</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Dart::InitializeIsolate</strong></p><p>这里主要是对 isolate 进行初始化，并在初始化完成后通知创建这个 isolate 的 isolate。</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\vm\dart.cc</span>

<span class="token class-name">ErrorPtr</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">InitializeIsolate</span><span class="token punctuation">(</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_data<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_instructions<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> kernel_buffer<span class="token punctuation">,</span>
                                 intptr_t kernel_buffer_size<span class="token punctuation">,</span>
                                 <span class="token class-name">IsolateGroup</span><span class="token operator">*</span> source_isolate_group<span class="token punctuation">,</span>
                                 <span class="token keyword">void</span><span class="token operator">*</span> isolate_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Initialize the new isolate.</span>
  <span class="token class-name">Thread</span><span class="token operator">*</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Isolate</span><span class="token operator">*</span> <span class="token class-name">I</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  auto IG <span class="token operator">=</span> <span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>SUPPORT_TIMELINE<span class="token punctuation">)</span>
  <span class="token class-name">TimelineBeginEndScope</span> <span class="token function">tbes</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Timeline</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">GetIsolateStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token string-literal"><span class="token string">&quot;InitializeIsolate&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">tbes<span class="token punctuation">.</span></span>SetNumArguments</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">tbes<span class="token punctuation">.</span></span>CopyArgument</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;isolateName&quot;</span></span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">I</span> <span class="token operator">!=</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">StackZone</span> <span class="token function">zone</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">HandleScope</span> <span class="token function">handle_scope</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool was_child_cloned_into_existing_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source_isolate_group <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If a static field gets registered in [IsolateGroup::RegisterStaticField]:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   * before this block it will ignore this isolate. The [Clone] of the</span>
    <span class="token comment">//     initial field table will pick up the new value.</span>
    <span class="token comment">//   * after this block it will add the new static field to this isolate.</span>
    <span class="token punctuation">{</span>
      <span class="token class-name">SafepointReadRwLocker</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> source_isolate_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">program_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span>set_field_table<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span>
                         source_isolate_group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">initial_field_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Clone</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">field_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">MarkReadyToUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">}</span>

    was_child_cloned_into_existing_isolate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">Error</span><span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
				<span class="token comment">// 从 IsolateGroup 中引用一些通用的变量（常量等等）</span>
        <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">InitIsolateFromSnapshot</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> snapshot_data<span class="token punctuation">,</span> snapshot_instructions<span class="token punctuation">,</span>
                                kernel_buffer<span class="token punctuation">,</span> kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> error<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">VerifyBuiltinVtables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DEBUG_ONLY</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Verify</span><span class="token punctuation">(</span>kForbidMarked<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
  <span class="token keyword">const</span> bool kIsAotRuntime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
#<span class="token keyword">else</span>
  <span class="token keyword">const</span> bool kIsAotRuntime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
#endif

  <span class="token keyword">if</span> <span class="token punctuation">(</span>kIsAotRuntime <span class="token operator">||</span> was_child_cloned_into_existing_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>TARGET_ARCH_IA32<span class="token punctuation">)</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_generic_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
           <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
           <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>TARGET_ARCH_IA32<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">I</span> <span class="token operator">!=</span> <span class="token class-name">Dart</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">vm_isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_generic_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
          nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SafepointWriteRwLocker</span> <span class="token function">ml</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">program_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_generic_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
            nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_build_generic_method_extractor_code</span><span class="token punctuation">(</span>
              <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
                  <span class="token class-name">StubCode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">GetBuildGenericMethodExtractorStub</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
          nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SafepointWriteRwLocker</span> <span class="token function">ml</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">program_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
            nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_build_nongeneric_method_extractor_code</span><span class="token punctuation">(</span>
              <span class="token class-name">Code</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>
                  <span class="token class-name">StubCode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">GetBuildNonGenericMethodExtractorStub</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(TARGET_ARCH_IA32)</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_ic_miss_code</span><span class="token punctuation">(</span><span class="token class-name">StubCode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SwitchableCallMiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Error</span><span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot_data <span class="token operator">==</span> nullptr <span class="token operator">||</span> kernel_buffer <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    error <span class="token operator">^=</span> IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">PreallocateObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> error<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> auto<span class="token operator">&amp;</span> out_of_memory <span class="token operator">=</span>
      <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">out_of_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  error <span class="token operator">^=</span> <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">PreallocateObjects</span><span class="token punctuation">(</span>out_of_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">error<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>was_child_cloned_into_existing_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">InitGrowthControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_init_callback_data</span><span class="token punctuation">(</span>isolate_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FLAG_print_class_table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IG<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">class_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
  <span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">MaybeMakeServiceIsolate</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">IsSystemIsolate</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_should_pause_on_start</span><span class="token punctuation">(</span>
        <span class="token class-name">FLAG_pause_isolates_on_start</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_should_pause_on_exit</span><span class="token punctuation">(</span><span class="token class-name">FLAG_pause_isolates_on_exit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(PRODUCT)</span>

  <span class="token class-name">ServiceIsolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">SendIsolateStartupMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">NotifyIsolateCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token comment">// Create tag table.</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_tag_table</span><span class="token punctuation">(</span><span class="token class-name">GrowableObjectArray</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">GrowableObjectArray</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Set up default UserTag.</span>
  <span class="token keyword">const</span> <span class="token class-name">UserTag</span><span class="token operator">&amp;</span> default_tag <span class="token operator">=</span> <span class="token class-name">UserTag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">UserTag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">DefaultTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_current_tag</span><span class="token punctuation">(</span>default_tag<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">I</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init_loaded_prefixes_set_storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token class-name">Error</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，如果是调用<code>Isolate.spawn()</code>的话，先从当前 isolate 获取对应的 Isolate Group，然后使用这个 Isolate Group 创建配置一个新的 isolate，这样在同一个 isolate group 中的 Isolate 可以共享常量，heap 等。</p><h4 id="isolate-spawnuri" tabindex="-1"><a class="header-anchor" href="#isolate-spawnuri" aria-hidden="true">#</a> Isolate_spawnUri</h4><p>如果是使用<code>Isolate.spawnUri()</code>的话，就会通过<code>Isolate_spawnUri</code>来创建 isolate。</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\lib\isolate.cc</span>

	<span class="token function">DEFINE_NATIVE_ENTRY</span><span class="token punctuation">(</span><span class="token class-name">Isolate_spawnUri</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 解析参数</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Canonicalize the uri with respect to the current isolate.</span>
  <span class="token keyword">const</span> <span class="token class-name">Library</span><span class="token operator">&amp;</span> root_lib <span class="token operator">=</span>
      <span class="token class-name">Library</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">object_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">root_library</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  char<span class="token operator">*</span> error <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
<span class="token comment">// 获取 canonical_uri</span>
  <span class="token keyword">const</span> char<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">*</span>canonical_uri <span class="token operator">=</span> <span class="token class-name">CanonicalizeUri</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> root_lib<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>canonical_uri <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">String</span><span class="token operator">&amp;</span> msg <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Handle</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">New</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThrowIsolateSpawnException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> char<span class="token operator">*</span> utf8_package_config <span class="token operator">=</span>
      <span class="token class-name"><span class="token namespace">packageConfig<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> NULL <span class="token punctuation">:</span> <span class="token class-name">String2UTF8</span><span class="token punctuation">(</span>packageConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> char<span class="token operator">*</span> utf8_debug_name <span class="token operator">=</span>
      <span class="token class-name"><span class="token namespace">debugName<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> NULL <span class="token punctuation">:</span> <span class="token class-name">String2UTF8</span><span class="token punctuation">(</span>debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateSpawnState</span><span class="token punctuation">&gt;</span></span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">IsolateSpawnState</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>
      <span class="token class-name"><span class="token namespace">port<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canonical_uri<span class="token punctuation">,</span> utf8_package_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arguments_buffer<span class="token punctuation">,</span>
      <span class="token operator">&amp;</span>message_buffer<span class="token punctuation">,</span> paused<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fatal_errors<span class="token punctuation">,</span> on_exit_port<span class="token punctuation">,</span>
			<span class="token comment">// 注意下面这里的 group=nullptr</span>
      on_error_port<span class="token punctuation">,</span> utf8_debug_name<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token comment">/*group=*/</span>nullptr<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If we were passed a value then override the default flags state for</span>
  <span class="token comment">// checked mode.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">checked<span class="token punctuation">.</span></span>IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">*</span> flags <span class="token operator">=</span> state<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flags<span class="token operator">-</span><span class="token operator">&gt;</span>enable_asserts <span class="token operator">=</span> checked<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Since this is a call to Isolate.spawnUri, don&#39;t copy the parent&#39;s code.</span>
  state<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>copy_parent_code <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  isolate<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Run</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpawnIsolateTask</span><span class="token punctuation">&gt;</span></span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                                                         std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到<code>Isolate_spawnUri</code>还是执行了<code>SpawnIsolateTask</code> 。</p><h5 id="spawnisolatetask-1" tabindex="-1"><a class="header-anchor" href="#spawnisolatetask-1" aria-hidden="true">#</a> SpawnIsolateTask</h5><p>在<code>SpawnIsolateTask.Run</code>方法中，因为<code>spawnUri</code>中<code>IsolateSpawnState</code>的<code>IsolateGroup</code>为<code>nulltrp</code>，所以这里执行的是<code>RunHeavyweight(name)</code>：</p><h5 id="runheavyweight" tabindex="-1"><a class="header-anchor" href="#runheavyweight" aria-hidden="true">#</a> RunHeavyweight</h5><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt;</span>

<span class="token keyword">class</span> <span class="token class-name">SpawnIsolateTask</span> <span class="token punctuation">:</span> public <span class="token class-name">ThreadPool</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Task</span> <span class="token punctuation">{</span>

<span class="token keyword">void</span> <span class="token class-name">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">const</span> char<span class="token operator">*</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
                           <span class="token operator">?</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">function_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                           <span class="token punctuation">:</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">debug_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    auto group <span class="token operator">=</span> state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">RunHeavyweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">RunLightweight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">RunHeavyweight</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The create isolate group callback is mandatory.  If not provided we</span>
    <span class="token comment">// cannot spawn isolates.</span>
		<span class="token comment">// 在 Dart::DartInit 中已经被设置，在 Isolate 创建时会被回调</span>
    <span class="token operator">*</span><span class="token operator">*</span>auto create_group_callback <span class="token operator">=</span> <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">CreateGroupCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>create_group_callback <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Isolate spawn is not supported by this Dart embedder\n&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    char<span class="token operator">*</span> error <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token comment">// Make a copy of the state&#39;s isolate flags and hand it to the callback.</span>
    <span class="token class-name">Dart_IsolateFlags</span> api_flags <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    api_flags<span class="token punctuation">.</span>is_system_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// 创建 isolate</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Dart_Isolate</span> isolate <span class="token operator">=</span>
        <span class="token punctuation">(</span>create_group_callback<span class="token punctuation">)</span><span class="token punctuation">(</span>state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">script_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span>
                                state_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">package_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>api_flags<span class="token punctuation">,</span>
                                parent_isolate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init_callback_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
    parent_isolate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">DecrementSpawnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parent_isolate_ <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FailedSpawn</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token comment">/*has_current_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 切换到指定的 isolate</span>
    <span class="token class-name">Dart_EnterIsolate</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 这里也调用了 Run 方法</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">Run</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">Isolate</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要创建 Isolate 的过程在<code>Isolate::CreateGroupCallback();</code>中，让我们看一下他是怎么来的：</p><h5 id="isolate-creategroupcallback" tabindex="-1"><a class="header-anchor" href="#isolate-creategroupcallback" aria-hidden="true">#</a> Isolate::CreateGroupCallback()</h5><p>他和上述<code>Isolate::InitializeCallback_</code>的来源一致，都是在<code>Dart_Initialize</code>中配置的，此外，还使用了<code>parent_isolate_-&gt;init_callback_data()</code>。</p><p>先看一下的<code>CreateIsolateGroupAndSetup</code>实现：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// -&gt; runtime\bin\main.cc</span>

<span class="token keyword">static</span> <span class="token class-name">Dart_Isolate</span> <span class="token class-name">CreateIsolateGroupAndSetup</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> script_uri<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> char<span class="token operator">*</span> main<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> char<span class="token operator">*</span> package_root<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> char<span class="token operator">*</span> package_config<span class="token punctuation">,</span>
                                               <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">*</span> flags<span class="token punctuation">,</span>
                                               <span class="token keyword">void</span><span class="token operator">*</span> callback_data<span class="token punctuation">,</span>
                                               char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// The VM should never call the isolate helper with a NULL flags.</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>flags <span class="token operator">!=</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>flags<span class="token operator">-</span><span class="token operator">&gt;</span>version <span class="token operator">==</span> DART_FLAGS_CURRENT_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>package_root <span class="token operator">==</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  bool dontneed_safe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>DART_HOST_OS_LINUX<span class="token punctuation">)</span>
  <span class="token comment">// This would also be true in Linux, except that Google3 overrides the default</span>
  <span class="token comment">// ELF interpreter to one that apparently doesn&#39;t create proper mappings.</span>
  dontneed_safe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
#elif <span class="token function">defined</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
  <span class="token comment">// If the snapshot isn&#39;t file-backed, madvise(DONT_NEED) is destructive.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">force_load_elf_from_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dontneed_safe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif
  flags<span class="token operator">-</span><span class="token operator">&gt;</span>snapshot_is_dontneed_safe <span class="token operator">=</span> dontneed_safe<span class="token punctuation">;</span>

  int exit_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>EXCLUDE_CFE_AND_KERNEL_PLATFORM<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> DART_KERNEL_ISOLATE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateAndSetupKernelIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> error<span class="token punctuation">,</span>
                                       <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span>

#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> DART_DEV_ISOLATE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateAndSetupDartDevIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                        error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif  <span class="token comment">// !defined(DART_PRECOMPILED_RUNTIME)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> DART_VM_SERVICE_ISOLATE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateAndSetupServiceIsolate</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                        error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool is_main_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CreateIsolateGroupAndSetupHelper</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>is_main_isolate<span class="token punctuation">,</span> script_uri<span class="token punctuation">,</span> main<span class="token punctuation">,</span>
                                          package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> callback_data<span class="token punctuation">,</span>
                                          error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里创建 Isolate 的时候，区分了几种情况：</p><ul><li>如果是 kernel-service（<code>DART_KERNEL_ISOLATE_NAME</code>）就执行<code>CreateAndSetupKernelIsolate</code></li><li>如果是 dartdev（<code>DART_DEV_ISOLATE_NAME</code>）就执行<code>CreateAndSetupDartDevIsolate</code></li><li>如果是 vm-service（<code>DART_VM_SERVICE_ISOLATE_NAME</code>）就执行<code>CreateAndSetupServiceIsolate</code></li><li>如果以上都不满足，就执行<code>CreateIsolateGroupAndSetupHelper</code></li></ul><p>显然，当我们在 Dart 代码中调用<code>Isolate.spawnUri</code>的时候，这里会执行的是<code>CreateIsolateGroupAndSetupHelper</code>：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\bin\main.cc</span>

<span class="token comment">// 调用方</span>
	<span class="token keyword">bool</span> is_main_isolate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">CreateIsolateGroupAndSetupHelper</span><span class="token punctuation">(</span>is_main_isolate<span class="token punctuation">,</span> script_uri<span class="token punctuation">,</span> main<span class="token punctuation">,</span>
                                          package_config<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> callback_data<span class="token punctuation">,</span>
                                          error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns newly created Isolate on success, NULL on failure.</span>
<span class="token keyword">static</span> Dart_Isolate <span class="token function">CreateIsolateGroupAndSetupHelper</span><span class="token punctuation">(</span>
		<span class="token keyword">bool</span> is_main_isolate<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> script_uri<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> packages_config<span class="token punctuation">,</span>
    Dart_IsolateFlags<span class="token operator">*</span> flags<span class="token punctuation">,</span>
    <span class="token keyword">void</span><span class="token operator">*</span> callback_data<span class="token punctuation">,</span>
    <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">,</span>
    <span class="token keyword">int</span><span class="token operator">*</span> exit_code<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// 根据是 AOT 还是 JIT 获取 kernel_buffer，app_snapshot，isolate_run_app_snapshot 等数据</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span><span class="token punctuation">{</span></span></span>
<span class="token comment">// AOT: All isolates need to be run from AOT compiled snapshots.</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token expression"><span class="token punctuation">{</span></span></span>
	<span class="token comment">// JIT: Main isolate starts from the app snapshot, if any. Other isolates</span>
  <span class="token comment">// use the core libraries snapshot.</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建 isolate_group_data</span>
	<span class="token keyword">auto</span> isolate_group_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateGroupData</span><span class="token punctuation">(</span>
      script_uri<span class="token punctuation">,</span> packages_config<span class="token punctuation">,</span> app_snapshot<span class="token punctuation">,</span> isolate_run_app_snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// copy_parent_code 为 true 的话，这里的 kernel_buffer 为 NULL</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>kernel_buffer <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kernel_buffer_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isolate_group_data<span class="token operator">-&gt;</span><span class="token function">SetKernelBufferAlreadyOwned</span><span class="token punctuation">(</span>
          std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>kernel_buffer_ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      isolate_group_data<span class="token operator">-&gt;</span><span class="token function">SetKernelBufferNewlyOwned</span><span class="token punctuation">(</span>kernel_buffer<span class="token punctuation">,</span>
                                                    kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

	Dart_Isolate isolate <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  IsolateData<span class="token operator">*</span> isolate_data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>DART_PRECOMPILED_RUNTIME<span class="token punctuation">)</span></span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate_run_app_snapshot <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>isolate_snapshot_data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> platform_kernel_buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    intptr_t platform_kernel_buffer_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    dfe<span class="token punctuation">.</span><span class="token function">LoadPlatform</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_kernel_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>platform_kernel_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>platform_kernel_buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      platform_kernel_buffer <span class="token operator">=</span> kernel_buffer<span class="token punctuation">;</span>
      platform_kernel_buffer_size <span class="token operator">=</span> kernel_buffer_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>platform_kernel_buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>EXCLUDE_CFE_AND_KERNEL_PLATFORM<span class="token punctuation">)</span></span></span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Binary built with --exclude-kernel-service. Cannot run&quot;</span>
          <span class="token string">&quot; from source.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">&quot;platform_program cannot be NULL.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO(sivachandra): When the platform program is unavailable, check if</span>
    <span class="token comment">// application kernel binary is self contained or an incremental binary.</span>
    <span class="token comment">// Isolate should be created only if it is a self contained kernel binary.</span>
    isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateData</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isolate <span class="token operator">=</span> <span class="token function">Dart_CreateIsolateGroupFromKernel</span><span class="token punctuation">(</span>
        script_uri<span class="token punctuation">,</span> name<span class="token punctuation">,</span> platform_kernel_buffer<span class="token punctuation">,</span> platform_kernel_buffer_size<span class="token punctuation">,</span>
        flags<span class="token punctuation">,</span> isolate_group_data<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IsolateData</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Creates a new isolate. The new isolate becomes the current isolate.</span>
    isolate <span class="token operator">=</span> <span class="token function">Dart_CreateIsolateGroup</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> name<span class="token punctuation">,</span> isolate_snapshot_data<span class="token punctuation">,</span>
                                      isolate_snapshot_instructions<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                      isolate_group_data<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate_data <span class="token operator">=</span> <span class="token keyword">new</span> IsolateData<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>isolate_group_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Creates a new isolate. The new isolate becomes the current isolate.</span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate <span class="token operator">=</span> Dart_CreateIsolateGroup<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> name<span class="token punctuation">,</span> isolate_snapshot_data<span class="token punctuation">,</span>
                                    isolate_snapshot_instructions<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                    <span class="token operator">*</span><span class="token operator">*</span>isolate_group_data<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>isolate_data<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span>

  Dart_Isolate created_isolate <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> isolate_data<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> isolate_group_data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token operator">*</span>created_isolate <span class="token operator">=</span> IsolateSetupHelper<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>
        isolate<span class="token punctuation">,</span> is_main_isolate<span class="token punctuation">,</span> script_uri<span class="token punctuation">,</span> packages_config<span class="token punctuation">,</span>
        isolate_run_app_snapshot<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> error<span class="token punctuation">,</span> exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">int64_t</span> end <span class="token operator">=</span> <span class="token function">Dart_TimelineGetMicros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Dart_TimelineEvent</span><span class="token punctuation">(</span><span class="token string">&quot;CreateIsolateGroupAndSetupHelper&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span>
                     Dart_Timeline_Event_Duration<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> created_isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里可以看到，<code>CreateIsolateGroupAndSetupHelper</code>按照是 JIT 还是 AOT 的编译方式，有不同的获取数据的方式，但不管哪种方式，最后都执行了一下三步：</p><ul><li>创建<code>IsolateData* isolate_data</code> 使用<code>isolate_group_data</code>创建 IsolateData</li><li>创建<code>Dart_Isolate isolate</code> 创建<code>Dart_Isolate</code>，将<code>script_uri</code>，<code>isolate_data</code>，和<code>isolate_group_data</code>等绑定</li><li>创建并返回<code>Dart_Isolate created_isolate</code>包装<code>isolate</code> ，进行数据绑定，并将 isolate 标记为<code>runnable</code></li></ul><h6 id="dart-createisolategroup" tabindex="-1"><a class="header-anchor" href="#dart-createisolategroup" aria-hidden="true">#</a> Dart_CreateIsolateGroup</h6><p>这里分析一下**<code>Dart_CreateIsolateGroup</code>的过程：**</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// --&gt; runtime/vm/dart_api_impl.cc#L1371</span>

DART_EXPORT <span class="token class-name">Dart_Isolate</span>
<span class="token class-name">Dart_CreateIsolateGroup</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span> script_uri<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_data<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> snapshot_instructions<span class="token punctuation">,</span>
                        <span class="token class-name">Dart_IsolateFlags</span><span class="token operator">*</span> flags<span class="token punctuation">,</span>
                        <span class="token keyword">void</span><span class="token operator">*</span> isolate_group_data<span class="token punctuation">,</span>
                        <span class="token keyword">void</span><span class="token operator">*</span> isolate_data<span class="token punctuation">,</span>
                        char<span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">API_TIMELINE_DURATION</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Dart_IsolateFlags</span> api_flags<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Isolate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">FlagsInitialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    flags <span class="token operator">=</span> <span class="token operator">&amp;</span>api_flags<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> char<span class="token operator">*</span> non_null_name <span class="token operator">=</span> name <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string-literal"><span class="token string">&quot;isolate&quot;</span></span> <span class="token punctuation">:</span> name<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsolateGroupSource</span><span class="token punctuation">&gt;</span></span> <span class="token function">source</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">IsolateGroupSource</span><span class="token punctuation">(</span>script_uri<span class="token punctuation">,</span> non_null_name<span class="token punctuation">,</span> snapshot_data<span class="token punctuation">,</span>
                             snapshot_instructions<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建 Isolate Group</span>
  auto group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IsolateGroup</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> isolate_group_data<span class="token punctuation">,</span> <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建 Isolate Group 持有的 Heap，由所有在这个 Isolate Group 下的 isolate 共享</span>
  group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token class-name">CreateHeap</span><span class="token punctuation">(</span>
      <span class="token comment">/*is_vm_isolate=*/</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">IsServiceOrKernelIsolateName</span><span class="token punctuation">(</span>non_null_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IsolateGroup</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token class-name">RegisterIsolateGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据刚刚创建的 Isolate Group 创建 Isolate</span>
  <span class="token class-name">Dart_Isolate</span> isolate <span class="token operator">=</span> <span class="token class-name">CreateIsolate</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token comment">/*is_new_group=*/</span><span class="token boolean">true</span><span class="token punctuation">,</span>
                                       non_null_name<span class="token punctuation">,</span> isolate_data<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    group<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_initial_spawn_successful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="run-isolate-child" tabindex="-1"><a class="header-anchor" href="#run-isolate-child" aria-hidden="true">#</a> Run(Isolate* child)</h4><p>在上面的分析中，我们注意到，无论是<code>RunHeavyweight(const char* name)</code>还是<code>RunLightweight(const char* name)</code>方法，最后在创建了新的 isolate 之后，都执行了<code>Run(Isolate* child)</code>方法，在这里正式启动了 isolate：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\lib\isolate.cc</span>

<span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">EnsureIsRunnable</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Dart_ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    state_<span class="token operator">-&gt;</span><span class="token function">set_isolate</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// origin_id is set to parent isolate main port id when spawning via</span>
      <span class="token comment">// spawnFunction.</span>
      child<span class="token operator">-&gt;</span><span class="token function">set_origin_id</span><span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">origin_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
			<span class="token keyword">auto</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// TransitionNativeToVM is used to transition the safepoint state of a</span>
      <span class="token comment">// thread from &quot;running native code&quot; to &quot;running vm code&quot; and ensures</span>
      <span class="token comment">// that the state is reverted back to &quot;running native code&quot; when</span>
      <span class="token comment">// exiting the scope/frame.</span>
      TransitionNativeToVM <span class="token function">transition</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Create an empty zone and set is at the current zone for the Thread.</span>
      StackZone <span class="token function">zone</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// The class HandleScope is used to start a new handles scope in the</span>
      <span class="token comment">//  code.</span>
      HandleScope <span class="token function">hs</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

      success <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>EnqueueEntrypointInvocationAndNotifySpawner<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      <span class="token function">Dart_ShutdownIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// All preconditions are met for this to always succeed.</span>
    <span class="token keyword">char</span><span class="token operator">*</span> error <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		<span class="token comment">// Lets the VM run message processing for the isolate.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span><span class="token operator">*</span>Dart_RunLoopAsync<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">errors_are_fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">on_error_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           state_<span class="token operator">-&gt;</span><span class="token function">on_exit_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">&quot;Dart_RunLoopAsync() failed: %s. Please file a Dart VM bug report.&quot;</span><span class="token punctuation">,</span>
            error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里只是做了一些环境准备，然后在<code>EnqueueEntrypointInvocationAndNotifySpawner</code>方法中将 isolate 要运行的所有东西都准备好，然后再在<code>Dart_RunLoopAsync</code>方法中正式开始 isolate 处理 event queue.</p><p><strong>EnqueueEntrypointInvocationAndNotifySpawner</strong></p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\lib\isolate.cc</span>

<span class="token keyword">bool</span> <span class="token function">EnqueueEntrypointInvocationAndNotifySpawner</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> isolate <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> zone <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> is_spawn_uri <span class="token operator">=</span> state_<span class="token operator">-&gt;</span><span class="token function">is_spawn_uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step 1) Resolve the entrypoint function.</span>
    <span class="token comment">// 查找 isolate 开始运行的第一个方法，比如 Isolate.spawn 的 spawn 或者 Isolate.spawnUri 的 main 方法</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;</span> entrypoint_closure <span class="token operator">=</span> <span class="token class-name">Closure</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">closure_tuple_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>
          zone<span class="token punctuation">,</span>
          <span class="token function">ReadObjectGraphCopyMessage</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">closure_tuple_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ReportError</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Failed to deserialize the passed entrypoint to the new isolate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      entrypoint_closure <span class="token operator">=</span> <span class="token class-name">Closure</span><span class="token double-colon punctuation">::</span><span class="token function">RawCast</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">ResolveFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>is_spawn_uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ReportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to resolve entrypoint function.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">ASSERT</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">auto</span><span class="token operator">&amp;</span> func <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Cast</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      func <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">ImplicitClosureFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      entrypoint_closure <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">ImplicitStaticClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 2) Enqueue delayed invocation of entrypoint callback.</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> args_obj <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">BuildArgs</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args_obj<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportError</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Failed to deserialize the passed arguments to the new isolate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>args_obj<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> args_obj<span class="token punctuation">.</span><span class="token function">IsInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> message_obj <span class="token operator">=</span>
        <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> state_<span class="token operator">-&gt;</span><span class="token function">BuildMessage</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message_obj<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportError</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Failed to deserialize the passed arguments to the new isolate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>message_obj<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> message_obj<span class="token punctuation">.</span><span class="token function">IsInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析参数，分别是 isolate 初始运行方法，参数 args、messgae、是否 spawn_uri</span>
    <span class="token keyword">const</span> Array<span class="token operator">&amp;</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> entrypoint_closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> message_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> is_spawn_uri <span class="token operator">?</span> <span class="token class-name">Bool</span><span class="token double-colon punctuation">::</span><span class="token function">True</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Bool</span><span class="token double-colon punctuation">::</span><span class="token function">False</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> lib <span class="token operator">=</span> <span class="token class-name">Library</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Library</span><span class="token double-colon punctuation">::</span><span class="token function">IsolateLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;_startIsolate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry_point <span class="token operator">=</span>
        <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> lib<span class="token punctuation">.</span><span class="token function">LookupLocalFunction</span><span class="token punctuation">(</span>entry_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">.</span><span class="token function">IsFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entry_point<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span>
        <span class="token class-name">Object</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">DartEntry</span><span class="token double-colon punctuation">::</span><span class="token function">InvokeFunction</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">IsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportError</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to enqueue delayed entrypoint invocation.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 3) Pause the isolate if required &amp; Notify parent isolate about</span>
    <span class="token comment">// isolate creation.</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> capabilities <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;</span> capability <span class="token operator">=</span> <span class="token class-name">Capability</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    capability <span class="token operator">=</span> <span class="token class-name">Capability</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-&gt;</span><span class="token function">pause_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    capabilities<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    capability <span class="token operator">=</span> <span class="token class-name">Capability</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-&gt;</span><span class="token function">terminate_capability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    capabilities<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> send_port <span class="token operator">=</span>
        <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token operator">-&gt;</span><span class="token function">main_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> message <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> send_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">SetAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state_<span class="token operator">-&gt;</span><span class="token function">paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      capability <span class="token operator">^=</span> capabilities<span class="token punctuation">.</span><span class="token function">At</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token keyword">bool</span> added <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">AddResumeCapability</span><span class="token punctuation">(</span>capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ASSERT</span><span class="token punctuation">(</span>added<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isolate<span class="token operator">-&gt;</span><span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">increment_paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// If parent isolate died, we ignore the fact that we cannot notify it.</span>
      <span class="token comment">// 创建一个新的 Message 并将其压入 Isolate 的父 Isolate 对应的 MessageHandler 的 event queue 中</span>
      <span class="token class-name">PortMap</span><span class="token double-colon punctuation">::</span><span class="token function">PostMessage</span><span class="token punctuation">(</span><span class="token function">WriteMessage</span><span class="token punctuation">(</span><span class="token comment">/* can_send_any_object */</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                        <span class="token comment">/* same_group */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span>
                                        state_<span class="token operator">-&gt;</span><span class="token function">parent_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        Message<span class="token double-colon punctuation">::</span>kNormalPriority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里主要做了 3 件事：</p><ul><li>查找 isolate 开始运行的第一个方法<code>entrypoint</code>，比如<code>Isolate.spawn</code>的<code>entrypoint</code>或者<code>Isolate.spawnUri</code>的<code>main</code>方法</li><li>解析参数，分别是 isolate 初始运行方法，参数<code>args</code>、<code>messgae</code>、是否<code>spawn_uri</code>等等，将其与上一步找到的<code>entrypoint</code>结合</li><li>（如果需要的话暂停创建好的 isolate），并通知 isolate 的父 isolate 当前 isolate 创建成功（附带当前 isolate 的<code>send_port</code>）</li></ul><p>至此，Isolate 的创建工作已经完成，在<code>Dart_RunLoopAsync</code>开始 isolate 处理消息：</p><p><strong>Dart_RunLoopAsync</strong></p><p>在这里主要是开始处理 event loop。</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt;  runtime\vm\dart_api_impl.cc</span>

DART_EXPORT <span class="token keyword">bool</span> <span class="token function">Dart_RunLoopAsync</span><span class="token punctuation">(</span><span class="token keyword">bool</span> errors_are_fatal<span class="token punctuation">,</span>
                                   Dart_Port on_error_port<span class="token punctuation">,</span>
                                   Dart_Port on_exit_port<span class="token punctuation">,</span>
                                   <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> isolate <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_ISOLATE</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">api_top_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">StrDup</span><span class="token punctuation">(</span><span class="token string">&quot;There must not be an active api scope.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token operator">-&gt;</span><span class="token function">is_runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> error_msg <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">MakeRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error_msg <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">StrDup</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  isolate<span class="token operator">-&gt;</span><span class="token function">SetErrorsFatal</span><span class="token punctuation">(</span>errors_are_fatal<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>on_error_port <span class="token operator">!=</span> ILLEGAL_PORT <span class="token operator">||</span> on_exit_port <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TransitionNativeToVM <span class="token function">transition</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    StackZone <span class="token function">zone</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>on_error_port <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> port <span class="token operator">=</span>
          <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>on_error_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      isolate<span class="token operator">-&gt;</span><span class="token function">AddErrorListener</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>on_exit_port <span class="token operator">!=</span> ILLEGAL_PORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> port <span class="token operator">=</span>
          <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SendPort</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>on_exit_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      isolate<span class="token operator">-&gt;</span><span class="token function">AddExitListener</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token double-colon punctuation">::</span><span class="token function">null_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">Dart_ExitIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span>isolate<span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\isolate.cc</span>
<span class="token keyword">void</span> <span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">message_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> ShutdownIsolate<span class="token punctuation">,</span>
                         <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>uword<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Isolate::Run()</code>实际上是开启了处理消息队列：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt;</span>

<span class="token comment">// Runs this message handler on the thread pool.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Before processing messages, the optional StartFunction is run.</span>
  <span class="token comment">//</span>
  <span class="token comment">// A message handler will run until it terminates either normally or</span>
  <span class="token comment">// abnormally.  Normal termination occurs when the message handler</span>
  <span class="token comment">// no longer has any live ports.  Abnormal termination occurs when</span>
  <span class="token comment">// HandleMessage() indicates that an error has occurred during</span>
  <span class="token comment">// message processing.</span>

  <span class="token comment">// Returns false if the handler terminated abnormally, otherwise it</span>
  <span class="token comment">// returns true.</span>
<span class="token keyword">bool</span> <span class="token class-name">MessageHandler</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">,</span>
                         StartCallback start_callback<span class="token punctuation">,</span>
                         EndCallback end_callback<span class="token punctuation">,</span>
                         CallbackData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
        <span class="token string">&quot;[+] Starting message handler:\n&quot;</span>
        <span class="token string">&quot;\thandler:    %s\n&quot;</span><span class="token punctuation">,</span>
        <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>pool_ <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>delete_me_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pool_ <span class="token operator">=</span> pool<span class="token punctuation">;</span>
  start_callback_ <span class="token operator">=</span> start_callback<span class="token punctuation">;</span>
  end_callback_ <span class="token operator">=</span> end_callback<span class="token punctuation">;</span>
  callback_data_ <span class="token operator">=</span> data<span class="token punctuation">;</span>
  task_running_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> result <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>pool_<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">Run</span><span class="token generic class-name"><span class="token operator">&lt;</span>MessageHandlerTask<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pool_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    start_callback_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    end_callback_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    callback_data_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\thread_pool.h</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
	<span class="token keyword">bool</span> <span class="token function">Run</span><span class="token punctuation">(</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">RunImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">T</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\thread_pool.cc</span>

<span class="token keyword">bool</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">RunImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Worker<span class="token operator">*</span> new_worker <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool_monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shutting_down_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 从线程池中获取 task，如果有空闲的/达到最大数量就尝试复用（此时这里返回 null）</span>
		<span class="token comment">// 否则创建新的并返回</span>
    new_worker <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>ScheduleTaskLocked<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_worker <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 创建一个新的 Worker 在新的系统线程运行 task</span>
    new_worker<span class="token operator">-&gt;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token function">StartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ThreadPool<span class="token double-colon punctuation">::</span><span class="token class-name">Worker</span><span class="token double-colon punctuation">::</span><span class="token function">StartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 创建一个新的系统线程，运行指定的代码，</span>
	<span class="token comment">//  android 的实现在 runtime\vm\os_thread_android.cc</span>
  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">OSThread</span><span class="token double-colon punctuation">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">&quot;DartWorker&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>Worker<span class="token double-colon punctuation">::</span>Main<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span>
                               <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>uword<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FATAL1</span><span class="token punctuation">(</span><span class="token string">&quot;Could not start worker thread: result = %d.&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里通过<code>ThreadPool::ScheduleTaskLocked</code>方法获取<code>new_worker</code>：</p><ul><li>如果已有的 worker 有空闲的或者已经达到最大数目了，就等待已有的 worker 执行任务</li><li>否则就创建新的 worker，并在新的线程运行</li></ul><p>在获取到 worker 之后，就执行<code>MessageHandlerTask</code>（见下文详细分析）。</p><p>我们主要关注 3 点：</p><ul><li><code>ScheduleTaskLocked</code> 分配 Worker</li><li><code>OSThread::Start</code>中使用<code>&amp;Worker::Main</code> 在新系统线程开启 Worker 循环</li><li><code>MessageHandlerTask</code> 执行具体的消息分发内容</li></ul><h5 id="scheduletasklocked" tabindex="-1"><a class="header-anchor" href="#scheduletasklocked" aria-hidden="true">#</a> <strong>ScheduleTaskLocked</strong></h5><p>先详细看一下获取<code>new_worker</code>的<code>ThreadPool::ScheduleTaskLocked</code>方法：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\vm\thread_pool.cc</span>

ThreadPool<span class="token double-colon punctuation">::</span>Worker<span class="token operator">*</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleTaskLocked</span><span class="token punctuation">(</span>MonitorLocker<span class="token operator">*</span> ml<span class="token punctuation">,</span>
                                                   std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Enqueue the new task.</span>
  tasks_<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pending_tasks_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span>pending_tasks_ <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Notify existing idle worker (if available).</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count_idle_ <span class="token operator">&gt;=</span> pending_tasks_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>idle_workers_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ml<span class="token operator">-&gt;</span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If we have maxed out the number of threads running, we will not start a</span>
  <span class="token comment">// new one.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>max_pool_size_ <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>count_idle_ <span class="token operator">+</span> count_running_<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> max_pool_size_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>idle_workers_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ml<span class="token operator">-&gt;</span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Otherwise start a new worker.</span>
  <span class="token keyword">auto</span> new_worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Worker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  idle_workers_<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>new_worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
  count_idle_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> new_worker<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的逻辑是：</p><p>将当前任务加入到<code>tasks_</code>队列中。</p><ul><li>如果空闲<code>count_idle_</code> 的 Worker 比等待中的任务数<code>pending_tasks_</code>多，那就发送通知，使用已有的 Worker 处理任务。</li><li>如果当前 Worker 数量已经最大了，那就将等待中的任务数 pending<em>tasks</em> 加一，等待有空闲的 Worker 处理任务。</li><li>否则，就新建一个 Worker（会对应创建一个新的系统线程）来处理任务。</li></ul><h5 id="worker-main" tabindex="-1"><a class="header-anchor" href="#worker-main" aria-hidden="true">#</a> &amp;<strong>Worker::Main</strong></h5><p>在<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>这里，StartThread 的第二个参数，**<code>&amp;Worker::Main</code>**启动了一个循环，不断的在任务队列<code>tasks_</code>中取出消息并执行：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\vm\thread_pool.cc</span>

ThreadPool<span class="token double-colon punctuation">::</span><span class="token class-name">Worker</span><span class="token double-colon punctuation">::</span><span class="token function">Main</span><span class="token punctuation">(</span>uword args<span class="token punctuation">)</span><span class="token punctuation">{</span>
Worker<span class="token operator">*</span> worker <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Worker<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ThreadPool<span class="token operator">*</span> pool <span class="token operator">=</span> worker<span class="token operator">-&gt;</span>pool_<span class="token punctuation">;</span>

pool<span class="token operator">-&gt;</span><span class="token function">WorkerLoop</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">WorkerLoop</span><span class="token punctuation">(</span>Worker<span class="token operator">*</span> worker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WorkerList dead_workers_to_join<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool_monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// worker 会从 task_取出一个 task 并运行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">IdleToRunningLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>tasks_<span class="token punctuation">.</span><span class="token function">RemoveFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pending_tasks_<span class="token operator">--</span><span class="token punctuation">;</span>
        MonitorLeaveScope <span class="token function">mls</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token operator">*</span>task<span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">RunningToIdleLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>running_workers_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ASSERT</span><span class="token punctuation">(</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnEnterIdleLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>shutting_down_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ObtainDeadWorkersLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dead_workers_to_join<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">IdleToDeadLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Sleep until we get a new task, we time out or we&#39;re shutdown.</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> idle_start <span class="token operator">=</span> <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrentMonotonicMicros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span> result <span class="token operator">=</span> ml<span class="token punctuation">.</span><span class="token function">WaitMicros</span><span class="token punctuation">(</span><span class="token function">ComputeTimeout</span><span class="token punctuation">(</span>idle_start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// We have to drain all pending tasks.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>shutting_down_ <span class="token operator">||</span> result <span class="token operator">==</span> Monitor<span class="token double-colon punctuation">::</span>kTimedOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ObtainDeadWorkersLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dead_workers_to_join<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">IdleToDeadLocked</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Before we transitioned to dead we obtained the list of previously died dead</span>
  <span class="token comment">// workers, which we join here. Since every death of a worker will join</span>
  <span class="token comment">// previously died workers, we keep the pending non-joined [dead_workers_] to</span>
  <span class="token comment">// effectively 1.</span>
  <span class="token function">JoinDeadWorkersLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dead_workers_to_join<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>MessageHandlerTask</strong></p><p>无论是哪种 Worker，最后都是执行的<code>MessageHandlerTask</code>：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// -&gt; runtime\vm\message_handler.cc</span>

<span class="token keyword">class</span> <span class="token class-name">MessageHandlerTask</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> ThreadPool<span class="token double-colon punctuation">::</span><span class="token class-name">Task</span></span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token keyword">explicit</span> <span class="token function">MessageHandlerTask</span><span class="token punctuation">(</span>MessageHandler<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">handler_</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">ASSERT</span><span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">ASSERT</span><span class="token punctuation">(</span>handler_ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
handler_<span class="token operator">-&gt;</span><span class="token function">TaskCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">MessageHandler</span><span class="token double-colon punctuation">::</span><span class="token function">TaskCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  MessageStatus status <span class="token operator">=</span> kOK<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> run_end_callback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> delete_me <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  EndCallback end_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  CallbackData callback_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// We will occasionally release and reacquire this monitor in this</span>
    <span class="token comment">// function. Whenever we reacquire the monitor we *must* process</span>
    <span class="token comment">// all pending OOB messages, or we may miss a request for vm</span>
    <span class="token comment">// shutdown.</span>
    MonitorLocker <span class="token function">ml</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>monitor_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This method is running on the message handler task. Which means no</span>
    <span class="token comment">// other message handler tasks will be started until this one sets</span>
    <span class="token comment">// [task_running_] to false.</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>task_running_<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span></span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnStart</span><span class="token punctuation">(</span>kOK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_paused_on_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PausedOnStartLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// More messages may have come in before we (re)acquired the monitor.</span>
      status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnStart</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Still paused.</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// No task in queue.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PausedOnStartLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_paused_on_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnExit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Still paused.</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// No task in queue.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PausedOnExitLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(PRODUCT)</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> kOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>start_callback_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Initialize the message handler by running its start function,</span>
        <span class="token comment">// if we have one.  For an isolate, this will run the isolate&#39;s</span>
        <span class="token comment">// main() function.</span>
        <span class="token comment">//</span>
        <span class="token comment">// Release the monitor_ temporarily while we call the start callback.</span>
        ml<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token function">start_callback_</span><span class="token punctuation">(</span>callback_data_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token class-name">Isolate</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        start_callback_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        ml<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Handle any pending messages for this message handler.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> kShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> kOK<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The isolate exits when it encounters an error or when it no</span>
    <span class="token comment">// longer has live ports.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> kOK <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">HasLivePorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PRODUCT<span class="token punctuation">)</span></span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnExit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_service_pause_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
              <span class="token string">&quot;Isolate %s paused before exiting. &quot;</span>
              <span class="token string">&quot;Use the Observatory to release it.\n&quot;</span><span class="token punctuation">,</span>
              <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">PausedOnExitLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// More messages may have come in while we released the monitor.</span>
        <span class="token operator">*</span><span class="token operator">*</span>status <span class="token operator">=</span> <span class="token function">HandleMessages</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldPauseOnExit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Still paused.</span>
          <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// No task in queue.</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">PausedOnExitLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ml<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(PRODUCT)</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> kOK <span class="token operator">&amp;&amp;</span> <span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> Error<span class="token operator">&amp;</span> error <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token double-colon punctuation">::</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sticky_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
              <span class="token string">&quot;[-] Stopping message handler (%s):\n&quot;</span>
              <span class="token string">&quot;\thandler:    %s\n&quot;</span>
              <span class="token string">&quot;\terror:    %s\n&quot;</span><span class="token punctuation">,</span>
              <span class="token function">MessageStatusString</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">ToCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token class-name">OS</span><span class="token double-colon punctuation">::</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
              <span class="token string">&quot;[-] Stopping message handler (%s):\n&quot;</span>
              <span class="token string">&quot;\thandler:    %s\n&quot;</span><span class="token punctuation">,</span>
              <span class="token function">MessageStatusString</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      pool_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token comment">// Decide if we have a callback before releasing the monitor.</span>
      end_callback <span class="token operator">=</span> end_callback_<span class="token punctuation">;</span>
      callback_data <span class="token operator">=</span> callback_data_<span class="token punctuation">;</span>
      run_end_callback <span class="token operator">=</span> end_callback_ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      delete_me <span class="token operator">=</span> delete_me_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Clear task_running_ last.  This allows other tasks to potentially start</span>
    <span class="token comment">// for this message handler.</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>oob_queue_<span class="token operator">-&gt;</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task_running_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The handler may have been deleted by another thread here if it is a native</span>
  <span class="token comment">// message handler.</span>

  <span class="token comment">// Message handlers either use delete_me or end_callback but not both.</span>
  <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>delete_me <span class="token operator">||</span> <span class="token operator">!</span>run_end_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>run_end_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ASSERT</span><span class="token punctuation">(</span>end_callback <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">end_callback</span><span class="token punctuation">(</span>callback_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The handler may have been deleted after this point.</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>delete_me<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，这里执行了<code>MessageHandler::HandleMessages</code>方法，来处理消息：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token comment">// -&gt; runtime\vm\message_handler.cc</span>

<span class="token literal-property property">MessageHandler</span><span class="token operator">:</span><span class="token operator">:</span>MessageStatus MessageHandler<span class="token operator">:</span><span class="token operator">:</span><span class="token function">HandleMessages</span><span class="token punctuation">(</span>
    <span class="token parameter">MonitorLocker<span class="token operator">*</span> ml<span class="token punctuation">,</span>
    bool allow_normal_messages<span class="token punctuation">,</span>
    bool allow_multiple_normal_messages</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">ASSERT</span><span class="token punctuation">(</span>monitor_<span class="token punctuation">.</span><span class="token function">IsOwnedByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Scheduling of the mutator thread during the isolate start can cause this</span>
  <span class="token comment">// thread to safepoint.</span>
  <span class="token comment">// We want to avoid holding the message handler monitor during the safepoint</span>
  <span class="token comment">// operation to avoid possible deadlocks, which can occur if other threads are</span>
  <span class="token comment">// sending messages to this message handler.</span>
  <span class="token comment">//</span>
  <span class="token comment">// If isolate() returns nullptr [StartIsolateScope] does nothing.</span>
  ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  StartIsolateScope <span class="token function">start_isolate</span><span class="token punctuation">(</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  auto idle_time_handler <span class="token operator">=</span>
      <span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr <span class="token operator">?</span> <span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">idle_time_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> nullptr<span class="token punctuation">;</span>

  MessageStatus max_status <span class="token operator">=</span> kOK<span class="token punctuation">;</span>
  <span class="token literal-property property">Message</span><span class="token operator">:</span><span class="token operator">:</span>Priority min_priority <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>allow_normal_messages <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority
                                            <span class="token operator">:</span> Message<span class="token operator">:</span><span class="token operator">:</span>kOOBPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> **message = DequeueMessage(min_priority);**
  while (message != nullptr) </span><span class="token punctuation">{</span>
    intptr_t message_len <span class="token operator">=</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">OS</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
          <span class="token string">&quot;[&lt;] Handling message:\n&quot;</span>
          <span class="token string">&quot;\tlen:        %&quot;</span> Pd
          <span class="token string">&quot;\n&quot;</span>
          <span class="token string">&quot;\thandler:    %s\n&quot;</span>
          <span class="token string">&quot;\tport:       %&quot;</span> Pd64 <span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span>
          message_len<span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dest_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the monitor_ temporarily while we handle the message.</span>
    <span class="token comment">// The monitor was acquired in MessageHandler::TaskCallback().</span>
    ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token literal-property property">Message</span><span class="token operator">:</span><span class="token operator">:</span>Priority saved_priority <span class="token operator">=</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Dart_Port saved_dest_port <span class="token operator">=</span> message<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dest_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MessageStatus status <span class="token operator">=</span> kOK<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
      DisableIdleTimerScope <span class="token function">disable_idle_timer</span><span class="token punctuation">(</span>idle_time_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> <span class="token function">HandleMessage</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;</span> max_status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      max_status <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ml<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAG_trace_isolates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">OS</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">PrintErr</span><span class="token punctuation">(</span>
          <span class="token string">&quot;[.] Message handled (%s):\n&quot;</span>
          <span class="token string">&quot;\tlen:        %&quot;</span> Pd
          <span class="token string">&quot;\n&quot;</span>
          <span class="token string">&quot;\thandler:    %s\n&quot;</span>
          <span class="token string">&quot;\tport:       %&quot;</span> Pd64 <span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span>
          <span class="token function">MessageStatusString</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> message_len<span class="token punctuation">,</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> saved_dest_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If we are shutting down, do not process any more messages.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> kShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ClearOOBQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Remember time since the last message. Don&#39;t consider OOB messages so</span>
    <span class="token comment">// using Observatory doesn&#39;t trigger additional idle tasks.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FLAG_idle_timeout_micros <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>saved_priority <span class="token operator">==</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>idle_time_handler <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idle_time_handler<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">UpdateStartIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Some callers want to process only one normal message and then quit. At</span>
    <span class="token comment">// the same time it is OK to process multiple OOB messages.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>saved_priority <span class="token operator">==</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>allow_multiple_normal_messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We processed one normal message.  Allow no more.</span>
      allow_normal_messages <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Reevaluate the minimum allowable priority.  The paused state</span>
    <span class="token comment">// may have changed as part of handling the message.  We may also</span>
    <span class="token comment">// have encountered an error during message processing.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Even if we encounter an error, we still process pending OOB</span>
    <span class="token comment">// messages so that we don&#39;t lose the message notification.</span>
    min_priority <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>max_status <span class="token operator">==</span> kOK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allow_normal_messages <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">?</span> Message<span class="token operator">:</span><span class="token operator">:</span>kNormalPriority
                        <span class="token operator">:</span> Message<span class="token operator">:</span><span class="token operator">:</span>kOOBPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    message <span class="token operator">=</span> <span class="token function">DequeueMessage</span><span class="token punctuation">(</span>min_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">
  return max_status;
}
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>MessageHandler::DequeueMessage</code>则是按照优先级，依次从<code>oob_queue_</code>和<code>queue_</code>中获取消息：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token comment">// -&gt; runtime\vm\message_handler.cc</span>

<span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> MessageHandler::DequeueMessage(
    Message::Priority min_priority) </span><span class="token punctuation">{</span>
  <span class="token comment">// TODO(turnidge): Add assert that monitor_ is held here.</span>
  <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> message = oob_queue_-&gt;Dequeue();
  if ((message == nullptr) &amp;&amp; (min_priority &lt; Message::kOOBPriority)) </span><span class="token punctuation">{</span>
    message <span class="token operator">=</span> queue_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">
  return message;
}
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于<code>oob_queue_</code>和<code>queue_</code> 的区别如下：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token comment">// -&gt;</span>

<span class="token keyword">class</span> <span class="token class-name">MessageHandler</span> <span class="token punctuation">{</span>
	MessageQueue<span class="token operator">*</span> queue_<span class="token punctuation">;</span>
  MessageQueue<span class="token operator">*</span> oob_queue_<span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// -&gt; runtime\vm\message.h</span>

<span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
	<span class="token comment">// A message processed at any interrupt point (stack overflow check) instead</span>
  <span class="token comment">// of at the top of the message loop. Control messages from dart:isolate or</span>
  <span class="token comment">// vm-service requests.</span>
  bool <span class="token function">IsOOB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> priority_ <span class="token operator">==</span> Message<span class="token operator">:</span><span class="token operator">:</span>kOOBPriority<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里消息处理的步骤也启动了。</p><p>总结一下，<code>Dart_RunLoopAsync</code>的主要功能是触发 isolate 的<code>message_handler</code>处理消息分发：</p><p><code>Dart_RunLoopAsync</code> → <code>Isolate::Run()</code> → <code>message_handler()-&gt;Run()</code> → <strong>pool_-&gt;</strong><code>Run&lt;MessageHandlerTask&gt;</code> <strong>→</strong> <code>ThreadPool::RunImpl</code></p><p>在<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>这里主要触发了 2 步：</p><ul><li><code>ScheduleTaskLocked</code>获取到<code>new_worker</code></li><li><code>new_worker</code>调用<code>ThreadPool::Worker::StartThread()</code>方法开启循环</li></ul><p>然后根据是否创建了<code>new_worker</code>有两种情况：</p><ul><li>有<code>new_worker</code>，使用在<code>OSThread::Start</code>方法中创建了一个新的系统线程，执行<code>ThreadPool::Worker::Main</code>（这个方法的主要作用使用<code>new_worker</code>从线程池中的取出任务执行）</li><li>没有<code>new_worker</code>，那么等待已有的 Worker 空闲时执行任务</li></ul><p>无论如何，这里的 Worker 要执行的任务都是在<code>MessageHandler::Run</code>方法中指定的<code>MessageHandlerTask</code> ，而这个任务的内容便是开启<code>MessageHandler::HandleMessages</code> 方法，按照优先级不断的依次从<code>oob_queue_</code>和<code>queue_</code>中获取消息并处理。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><figure><img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri_dart_and_native.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Isolate 是 Dart 代码运行的地方，拥有独立的 event loop，和全局变量，在自己单独的线程运行。</p><p>Isolate.spawn 默认会创建在同一个 IsolateGroup 中的 Isolate，他们之间共享 Heap（这里会发生 GC）和一个线程池。</p><p>Isolate.spawnUri 会从制定的 Uri 中创建一个新的 IsolateGroup 和对应的 Isolate，并执行 Uri 中的 main 方法。</p><p>Isolate 内部维持一个 Event Loop。</p></div></div><div><div style="border-left:3px solid red;padding:10px;margin:20px;width:90%;height:auto;display:inline-block;position:relative;line-height:1.5;"><div><div><strong>文章标题：</strong>《Dart Isolate 源码分析》</div><div style="width:100%;display:inline-block;height:auto;"><div style="width:60%;float:left;display:inline-block;"><div><div><strong>本文作者： </strong>JI,XIAOYONG</div></div><div><div><strong>发布时间： </strong>2022/05/28 15:20:01 UTC+8</div></div><div><div><strong>更新时间： </strong>2023/12/30 16:17:02 UTC+8</div></div></div><div style="width:40%;float:right;display:inline-block;"><div style="right:0px;display:flex;justify-content:flex-end;padding-top:0.5em;"><strong></strong><a href="https://notbyai.fyi"><img src="https://notbyai.fyi/img/written-by-human-not-by-ai-white.svg" alt="written by human, not by AI"></a></div></div></div><div style="word-wrap:break-word;"><strong style="white-space:nowrap;">本文地址： </strong>https://jixiaoyong.github.io/blog/posts/a951661c.html</div><div><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>CC BY-NC-SA </a> 许可协议。转载请注明出处！ </div></div></div></div></div></div><!--]--><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/jixiaoyong/blog_source_code/edit/master/blog/src/_posts/dart_isolate_source_code.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: jixiaoyong1995@gmail.com">jixiaoyong</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/blog/posts/db62c118.html"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Dart event loop</div></a><a class="vp-link nav-link next" href="/blog/posts/550e5790.html"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Dart VM<!----></div></a></nav><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱(可选)</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址(可选)</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v2.15.5</div></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">Made by JI,XIAOYONG with ❤️ since 2016</div><div class="vp-copyright">© CC BY-NC-SA 许可协议授权，署名 - 非商业性使用 - 相同方式共享</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-b427197f.js" defer></script>
  </body>
</html>
