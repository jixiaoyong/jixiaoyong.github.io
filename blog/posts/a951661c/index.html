<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/https/jixiaoyong.github.io/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon.ico">
  <link rel="mask-icon" href="/blog/https/jixiaoyong.github.io/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jixiaoyong.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":true,"version":"8.12.3","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="Isolate💡 本文基于Dart 2.17.1 Isolate, an isolated Dart execution context. All Dart code runs in an isolate, and code can access classes and values only from the same isolate. Different isolates can commu">
<meta property="og:type" content="article">
<meta property="og:title" content="Dart Isolate源码分析">
<meta property="og:url" content="https://jixiaoyong.github.io/blog/posts/a951661c/index.html">
<meta property="og:site_name" content="Ji Xiaoyong&#39;s Blog">
<meta property="og:description" content="Isolate💡 本文基于Dart 2.17.1 Isolate, an isolated Dart execution context. All Dart code runs in an isolate, and code can access classes and values only from the same isolate. Different isolates can commu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jixiaoyong.github.io/images/isolate_and_isolate_group.png">
<meta property="og:image" content="https://jixiaoyong.github.io/images/isolate_class_dart_and_native.png">
<meta property="og:image" content="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri.png">
<meta property="og:image" content="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri_dart_and_native.png">
<meta property="article:published_time" content="2022-05-28T07:20:01.000Z">
<meta property="article:modified_time" content="2022-08-01T07:21:15.517Z">
<meta property="article:author" content="JI, XIAOYONG">
<meta property="article:tag" content="blog,jixiaoyong,android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jixiaoyong.github.io/images/isolate_and_isolate_group.png">


<link rel="canonical" href="https://jixiaoyong.github.io/blog/posts/a951661c/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jixiaoyong.github.io/blog/posts/a951661c/","path":"posts/a951661c/","title":"Dart Isolate源码分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dart Isolate源码分析 | Ji Xiaoyong's Blog</title>
  




<link rel="dns-prefetch" href="https://vercel.xiaoyong.ml">
  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ji Xiaoyong's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Isolate"><span class="nav-text">Isolate</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-text">简单使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0Isolate%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">创建新Isolate的方式:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">使用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pause"><span class="nav-text">pause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping"><span class="nav-text">ping</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8DIsolate"><span class="nav-text">获取当前Isolate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAIsolate"><span class="nav-text">创建Isolate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Isolate-spawnFunction"><span class="nav-text">Isolate_spawnFunction</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SpawnIsolateTask"><span class="nav-text">SpawnIsolateTask</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RunLightWeight"><span class="nav-text">RunLightWeight</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Isolate-InitializeCallback"><span class="nav-text">Isolate::InitializeCallback()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CreateWithinExistingIsolateGroup"><span class="nav-text">CreateWithinExistingIsolateGroup</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Isolate-spawnUri"><span class="nav-text">Isolate_spawnUri</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SpawnIsolateTask-1"><span class="nav-text">SpawnIsolateTask</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RunHeavyweight"><span class="nav-text">RunHeavyweight</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Isolate-CreateGroupCallback"><span class="nav-text">Isolate::CreateGroupCallback()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Dart-CreateIsolateGroup"><span class="nav-text">Dart_CreateIsolateGroup</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Run-Isolate-child"><span class="nav-text">Run(Isolate* child)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ScheduleTaskLocked"><span class="nav-text">ScheduleTaskLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#amp-Worker-Main"><span class="nav-text">&amp;Worker::Main</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JI, XIAOYONG"
      src="//jixiaoyong.github.io/images/default_avatar.jpg">
  <p class="site-author-name" itemprop="name">JI, XIAOYONG</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">96</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jixiaoyong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jixiaoyong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jixiaoyong1995@gmail.com" title="E-Mail → mailto:jixiaoyong1995@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jixiaoyong.github.io/blog/posts/a951661c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//jixiaoyong.github.io/images/default_avatar.jpg">
      <meta itemprop="name" content="JI, XIAOYONG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ji Xiaoyong's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Dart Isolate源码分析 | Ji Xiaoyong's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dart Isolate源码分析<a href="https://github.com/jixiaoyong/blog_source_code/edit/master/blog/source/_posts/dart_isolate_source_code.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-28 15:20:01" itemprop="dateCreated datePublished" datetime="2022-05-28T15:20:01+08:00">2022-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-08-01 15:21:15" itemprop="dateModified" datetime="2022-08-01T15:21:15+08:00">2022-08-01</time>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/blog/posts/a951661c/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/blog/posts/a951661c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/blog/posts/a951661c/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Isolate"><a href="#Isolate" class="headerlink" title="Isolate"></a>Isolate</h1><p>💡 本文基于Dart 2.17.1</p>
<p><a target="_blank" rel="noopener" href="https://api.dart.cn/stable/2.17.1/dart-isolate/Isolate-class.html">Isolate</a>, an isolated Dart execution context.</p>
<p>All Dart code runs in an isolate, and <strong>code can access classes and values only from the same isolate</strong>. Different isolates can communicate by <strong>sending values through ports</strong> (see <a target="_blank" rel="noopener" href="https://api.dart.cn/stable/2.17.1/dart-isolate/ReceivePort-class.html">ReceivePort</a>, <a target="_blank" rel="noopener" href="https://api.dart.cn/stable/2.17.1/dart-isolate/SendPort-class.html">SendPort</a>).</p>
<blockquote>
<p>In Dart an isolate has its own event loop, its own global fields, can run in parallel with other isolates and have their own live-cycle.<br>— <a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375">https://github.com/dart-lang/sdk/issues/36097#issuecomment-746510375</a></p>
</blockquote>
<p> The new isolate has its <strong>own memory and its own thread</strong> working in parallel with the main isolate.</p>
<p><img src="https://jixiaoyong.github.io/images/isolate_and_isolate_group.png" alt="[https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly](https://www.youtube.com/watch?v=NoVYI94MJio&amp;ab_channel=Flutterly)"></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel=Flutterly">https://www.youtube.com/watch?v=NoVYI94MJio&ab_channel&#x3D;Flutterly</a></p>
<p>Isolate创建会占用内存，可以使用<code>IsolateGroup</code>来解决，并且目前为止Dart和Flutter都默认支持在使用<code>Isolate.spawn</code>创建新Isolate的时候使用IsolateGroup（<code>Isolate.spwanUri</code>创建的时候会创建<strong>单独</strong>的IsolateGroup和Isolate）。</p>
<blockquote>
<p>💡 在创建isolate的时候可以添加<code>addOnExitListener</code> 或者<code>addErrorListener</code>之类的监听，但是可能在执行添加代码的时候<strong>isolate就已经终止了</strong>而导致这些方法收不到回调。<br>为了避免这种情况，可以在创建isolate的时候指定他的状态为**<code>paused</code>**。</p>
</blockquote>
<p>与isolate有关的类有：</p>
<ul>
<li><code>Isolate</code> 位置在<code>sdk\lib\isolate\isolate.dart</code>。主要是<code>Isolate</code> 通用方法、属性的抽象描述，没有具体实现。</li>
<li><code>Isolate</code> 位置在<code>sdk\lib\_internal\vm\lib\isolate_patch.dart</code>，是app等平台对应的具体实现，部分方法调用了native层的Isolate实现。</li>
<li><code>Isolate</code>  位置在<code>runtime\vm\isolate.h</code>以及<code>runtime\vm\isolate.cc</code>中，是Isolate的native层实现。</li>
</ul>
<p>他们的关系大致如图：</p>
<p><img src="https://jixiaoyong.github.io/images/isolate_class_dart_and_native.png" alt="Untitled"></p>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><h2 id="创建新Isolate的方式"><a href="#创建新Isolate的方式" class="headerlink" title="创建新Isolate的方式:"></a>创建新Isolate的方式:</h2><ul>
<li><code>Isolate(``SendPort controlPort``, &#123;this.pauseCapability, this.terminateCapability&#125;);</code> 这种方式创建一种<strong>能力受限</strong>的Isolate。The capabilities should be the subset of the capabilities that are available to the original isolate.本质上并没有在native层孵化一个新的Isolate。</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newIsolate = Isolate(Isolate.current.controlPort);</span><br><span class="line">  newIsolate.addOnExitListener(Isolate.current.controlPort);</span><br><span class="line">  newIsolate.addErrorListener(Isolate.current.controlPort);</span><br><span class="line">  Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>),()&#123;</span><br><span class="line">    newIsolate.kill();</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;try kill new isolate&quot;</span>); <span class="comment">// after this，the dart code finish</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;finish&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Isolate.spawn(``void entryPoint(T message), T message,...)</code> 创建一个和当前Isolate<strong>共享同一份代码</strong>的Isolate，并执行entryPoint方法，一般在message中传入SendPort以便从entryPoint中向来时的Isolate发送消息，新建的Isolate和当前Isolate在同一个IsolateGroup中。</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> spawnIsolate() &#123;</span><br><span class="line">  <span class="keyword">var</span> receivePort = ReceivePort();</span><br><span class="line">  receivePort.listen((message) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;receivePort(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>) received msg: <span class="subst">$message</span>&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">//创建一个和当前的isolate共享同一份代码的Isolate</span></span><br><span class="line"><span class="keyword">var</span> isolate = Isolate.spawn((message) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Isolate initial function(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>) received msg: <span class="subst">$message</span>&quot;</span>);</span><br><span class="line">    (message <span class="keyword">as</span> SendPort).send(<span class="string">&quot;HELLO_FORM_ISOLATE(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>)&quot;</span>);</span><br><span class="line">  &#125;, receivePort.sendPort,debugName: <span class="string">&quot;another_isolate&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Isolate.spawnUri（Uri uri,List&lt;String&gt; args,var message,...）</code>* 指定的<code>uri</code>中创建并孵化一个isolate，执行uri对应的library中的<code>main</code>方法（0~2个入参），并传入无参、args或message作为参数</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> receivePort = ReceivePort();</span><br><span class="line">  receivePort.listen((message) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;receivePort(<span class="subst">$&#123;Isolate.current.debugName&#125;</span>) received msg: <span class="subst">$message</span>&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 创建一个和当前的isolate共享同一份代码的Isolate</span></span><br><span class="line">  <span class="keyword">var</span> isolate = <span class="keyword">await</span> Isolate.spawnUri(</span><br><span class="line">      <span class="built_in">Uri</span>.file(</span><br><span class="line">          <span class="string">r&quot;E:\workspace\others\flutter_dart_source_code_analysis\lib\dart\another_dart_file_to_spawn_uri.dart&quot;</span>),</span><br><span class="line">      [],</span><br><span class="line">      receivePort.sendPort,</span><br><span class="line">      debugName: <span class="string">&quot;another_isolate&quot;</span>);</span><br><span class="line">  Future.delayed(<span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">2</span>), () &#123;</span><br><span class="line">    receivePort.close();</span><br><span class="line">    isolate.kill(priority: Isolate.immediate);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;try kill new isolate&quot;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="pause"><a href="#pause" class="headerlink" title="pause"></a><strong>pause</strong></h3><p><code>Capability pause([Capability? resumeCapability])</code>，暂停Isolate，停止从*<code>event loop queue</code>* 中取（并处理）消息，但是依然可以往里面加入消息</p>
<p><em><code>resumeCapability</code></em> 是用来区分pause的，必须使用同一个*<code>resumeCapability</code>*来resume isolate。</p>
<ul>
<li>使用同一个*<code>resumeCapability</code>*多次<code>pause</code>，只需一次<code>resume</code>就可以恢复<code>isolate</code></li>
<li>使用不同*<code>resumeCapability</code><em>多次<code>pause</code>，必须使用对应的</em><code>resumeCapability</code><em>依次<code>resume</code>才可以恢复<code>isolate</code> （<strong>注意</strong>：这里也只需要使用当时pause isolate的</em><code>resumeCapability</code>* 依次调用resume即可，而不用保持次数一致，比如，有2个*<code>resumeCapability</code> ，*调用pause次数分别为a 1,b 2，那么要想resume isolate，也只需要分别使用a,b调用一次resume即可）</li>
</ul>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>使用isolate往<code>receivePort.sendPort</code>发送response消息，<strong>即使isolate当前被pause也可以正常发送</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">isolate.pause();</span><br><span class="line">isolate.ping(receivePort.sendPort, response: <span class="string">&quot;is isolate resume?&quot;</span>);<span class="comment">//receivePort依然可以收到消息</span></span><br></pre></td></tr></table></figure>

<p>ping可以正常发送的原因是：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; lib\isolate\isolate.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ping方法是一个external方法</span></span><br><span class="line"><span class="keyword">external</span> <span class="keyword">void</span> ping(SendPort responsePort,</span><br><span class="line">      &#123;<span class="built_in">Object?</span> response, <span class="built_in">int</span> priority = immediate&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">void</span> ping(SendPort responsePort,</span><br><span class="line">      &#123;<span class="built_in">Object?</span> response, <span class="built_in">int</span> priority: immediate&#125;) &#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="keyword">new</span> <span class="built_in">List</span>&lt;<span class="built_in">Object?</span>&gt;.filled(<span class="number">5</span>, <span class="keyword">null</span>)</span><br><span class="line">      ..[<span class="number">0</span>] = <span class="number">0</span> <span class="comment">// Make room for OOM message type.</span></span><br><span class="line">      ..[<span class="number">1</span>] = _PING</span><br><span class="line">      ..[<span class="number">2</span>] = responsePort</span><br><span class="line">      ..[<span class="number">3</span>] = priority</span><br><span class="line">      ..[<span class="number">4</span>] = response;</span><br><span class="line">    _sendOOB(controlPort, msg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&quot;vm:external-name&quot;</span>, <span class="string">&quot;Isolate_sendOOB&quot;</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="keyword">void</span> _sendOOB(port, msg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime/lib/isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建了一个oob消息并压入oob_queue_</span></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_sendOOB, <span class="number">0</span>, <span class="number">2</span>) &#123;</span><br><span class="line">  GET_NON_NULL_NATIVE_ARGUMENT(SendPort, port, arguments-&gt;NativeArgAt(<span class="number">0</span>));</span><br><span class="line">  GET_NON_NULL_NATIVE_ARGUMENT(Array, msg, arguments-&gt;NativeArgAt(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure to route this request to the isolate library OOB mesage handler.</span></span><br><span class="line">  msg.SetAt(<span class="number">0</span>, Smi::Handle(Smi::New(Message::kIsolateLibOOBMsg)));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ensure message writer (and it&#x27;s resources, e.g. forwarding tables) are</span></span><br><span class="line">  <span class="comment">// cleaned up before handling interrupts.</span></span><br><span class="line">  &#123;</span><br><span class="line">    PortMap::PostMessage(WriteMessage(<span class="comment">/* can_send_any_object */</span> <span class="keyword">false</span>,</span><br><span class="line">                                      <span class="comment">/* same_group */</span> <span class="keyword">false</span>, msg, port.Id(),</span><br><span class="line">                                      Message::kOOBPriority));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Drain interrupts before running so any IMMEDIATE operations on the current</span></span><br><span class="line">  <span class="comment">// isolate happen synchronously.</span></span><br><span class="line">  <span class="keyword">const</span> Error&amp; error = Error::Handle(thread-&gt;HandleInterrupts());</span><br><span class="line">  <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">    Exceptions::PropagateError(error);</span><br><span class="line">    UNREACHABLE();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在MessageHandler中有两种MessageQueue：<code>oob_queue_</code>和<code>queue_</code> ，前者优先级高，即使isolate被pause也会执行</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通消息，暂停时不能处理</span></span><br><span class="line">MessageQueue* queue_;</span><br><span class="line"><span class="comment">// 优先消息，即使处理消息时，优先处理obb_queue消息，如果为空再去考虑处理普通消息</span></span><br><span class="line"><span class="comment">// 即使isolate被pause也可以被处理</span></span><br><span class="line">MessageQueue* oob_queue_;</span><br></pre></td></tr></table></figure>

<p>像是<code>ping</code>&#x2F;<code>kill</code>&#x2F;<code>pause</code>&#x2F;<code>addOnExitListener</code>&#x2F;<code>removeOnExitListener</code>这些指令消息都是压入到<code>obb_queue_</code>中优先处理的。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>先看一下常用的几个方法是怎么实现的。</p>
<h2 id="获取当前Isolate"><a href="#获取当前Isolate" class="headerlink" title="获取当前Isolate"></a>获取当前Isolate</h2><p>（<em>sdk&#x2F;lib&#x2F;isolate&#x2F;isolate.dart</em>）<code>Isolate.current</code> →</p>
<p>  (<em>sdk&#x2F;lib&#x2F;_internal&#x2F;vm&#x2F;lib&#x2F;isolate_patch.dart</em>) <code>Isolate get current</code>  → <code>Isolate._getCurrentIsolate()</code> → <code>_getPortAndCapabilitiesOfCurrentIsolate()</code></p>
<p>（<em>runtime&#x2F;lib&#x2F;isolate.cc</em>）<code>DEFINE_NATIVE_ENTRY(Isolate_getPortAndCapabilitiesOfCurrentIsolate, 0, 0)</code></p>
<p>先看一下<em>sdk&#x2F;lib&#x2F;_internal&#x2F;vm&#x2F;lib&#x2F;isolate_patch.dart</em>中的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk/lib/_internal/vm/lib/isolate_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> _currentIsolate = _getCurrentIsolate();</span><br><span class="line"><span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Isolate <span class="keyword">get</span> current =&gt; _currentIsolate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Isolate _getCurrentIsolate() &#123;</span><br><span class="line">    <span class="built_in">List</span> portAndCapabilities = _getPortAndCapabilitiesOfCurrentIsolate();</span><br><span class="line">		<span class="comment">// 这里的参数分别是SendPort，Capability，Capability</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Isolate(portAndCapabilities[<span class="number">0</span>],</span><br><span class="line">        pauseCapability: portAndCapabilities[<span class="number">1</span>],</span><br><span class="line">        terminateCapability: portAndCapabilities[<span class="number">2</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@pragma</span>(<span class="string">&quot;vm:external-name&quot;</span>, <span class="string">&quot;Isolate_getPortAndCapabilitiesOfCurrentIsolate&quot;</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="built_in">List</span> _getPortAndCapabilitiesOfCurrentIsolate();</span><br></pre></td></tr></table></figure>

<p>可以看到，最后是根据native端返回的信息，新建了一个Isolate引用，但是因为<code>_currentIsolate</code>是<code>static final</code>的，所以只会被调用一次，确保了在Dart SDK中调用<code>Isolate.current</code> 时获取的是当前唯一的Isolate。</p>
<p>让我们看一下在native中是如何找到当前的Isolate的：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; \runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_getPortAndCapabilitiesOfCurrentIsolate, <span class="number">0</span>, <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> Array&amp; result = Array::Handle(Array::New(<span class="number">3</span>));</span><br><span class="line">  result.SetAt(<span class="number">0</span>, SendPort::Handle(SendPort::New(isolate-&gt;main_port())));</span><br><span class="line">  result.SetAt(</span><br><span class="line">      <span class="number">1</span>, Capability::Handle(Capability::New(isolate-&gt;pause_capability())));</span><br><span class="line">  result.SetAt(</span><br><span class="line">      <span class="number">2</span>, Capability::Handle(Capability::New(isolate-&gt;terminate_capability())));</span><br><span class="line">  <span class="keyword">return</span> result.ptr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见是直接取的<strong>当前线程对应的isolate</strong>对应的值，经过包装再返回到调用方。</p>
<h2 id="创建Isolate"><a href="#创建Isolate" class="headerlink" title="创建Isolate"></a>创建Isolate</h2><p>在Dart中创建Isolate有3种方式：</p>
<ul>
<li><code>Isolate(this.controlPort, &#123;this.pauseCapability, this.terminateCapability&#125;);</code>  <em><strong>create</strong> an</em> <em>isolate，本质上只是将</em><code>controlPort</code> 等设置为传入的对象，并没有在native层新建Isolate</li>
<li><code>Isolate.spawn</code>  <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li>
<li><code>Isolate.spawnUri</code>  <strong>create</strong> and <strong>spawns</strong> an <em>isolate</em></li>
</ul>
<p><img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri.png"></p>
<p>这里分析一下后面两种方式，对比一下差异：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\isolate\isolate.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates a new [Isolate] object with a restricted set of capabilities.</span></span><br><span class="line">Isolate(<span class="keyword">this</span>.controlPort, &#123;<span class="keyword">this</span>.pauseCapability, <span class="keyword">this</span>.terminateCapability&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">Creates and spawns an isolate that shares the same code as the current</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">isolate.</span></span></span><br><span class="line"><span class="keyword">external</span> <span class="keyword">static</span> Future&lt;Isolate&gt; spawn&lt;T&gt;(</span><br><span class="line">      <span class="keyword">void</span> entryPoint(T message), T message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="meta">@Since</span>(<span class="string">&quot;2.3&quot;</span>) <span class="built_in">String?</span> debugName&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// <span class="language-markdown">Creates and spawns an isolate that runs the code from the library with</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">the specified URI.</span></span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">The isolate starts executing the top-level <span class="code">`main`</span> function of the library</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">with the given URI.</span></span></span><br><span class="line">	<span class="keyword">external</span> <span class="keyword">static</span> Future&lt;Isolate&gt; spawnUri(</span><br><span class="line">      <span class="built_in">Uri</span> uri,</span><br><span class="line">      <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args,</span><br><span class="line">      <span class="keyword">var</span> message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      <span class="built_in">bool?</span> checked,</span><br><span class="line">      <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;? environment,</span><br><span class="line">      <span class="meta">@Deprecated</span>(<span class="string">&#x27;The packages/ dir is not supported in Dart 2&#x27;</span>)</span><br><span class="line">          <span class="built_in">Uri?</span> packageRoot,</span><br><span class="line">      <span class="built_in">Uri?</span> packageConfig,</span><br><span class="line">      <span class="built_in">bool</span> automaticPackageResolution = <span class="keyword">false</span>,</span><br><span class="line">      <span class="meta">@Since</span>(<span class="string">&quot;2.3&quot;</span>)</span><br><span class="line">          <span class="built_in">String?</span> debugName&#125;);</span><br></pre></td></tr></table></figure>

<p>对于APP等来说，上述<code>Isolate.spawn</code>和<code>Isolate.spawnUri</code>的实现都在<code>vm</code>下面的<code>isolate_patch.dart</code>中（js会返回<code>_unsupported()</code>）：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\_internal\vm\lib\isolate_patch.dart</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;Isolate&gt; spawn&lt;T&gt;(<span class="keyword">void</span> entryPoint(T message), T message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">String?</span> debugName&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">// `paused` isn&#x27;t handled yet.</span></span><br><span class="line">    <span class="comment">// Check for the type of `entryPoint` on the spawning isolate to make</span></span><br><span class="line">    <span class="comment">// error-handling easier.</span></span><br><span class="line">    <span class="keyword">if</span> (entryPoint <span class="keyword">is</span>! _UnaryFunction) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentError(entryPoint);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The VM will invoke [_startIsolate] with entryPoint as argument.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// We do not inherit the package config settings from the parent isolate,</span></span><br><span class="line">    <span class="comment">// instead we use the values that were set on the command line.</span></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> RawReceivePort readyPort =</span><br><span class="line">        <span class="keyword">new</span> RawReceivePort(<span class="keyword">null</span>, <span class="string">&#x27;Isolate.spawn ready&#x27;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      **_spawnFunction**(readyPort.sendPort, script.toString(), entryPoint, message,</span><br><span class="line">          paused, errorsAreFatal, onExit, onError, packageConfig, debugName);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> **_spawnCommon**(readyPort);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e, st) &#123;</span><br><span class="line">      readyPort.close();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> Future&lt;Isolate&gt;.error(e, st);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;Isolate&gt; spawnUri(<span class="built_in">Uri</span> uri, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args, <span class="keyword">var</span> message,</span><br><span class="line">      &#123;<span class="built_in">bool</span> paused = <span class="keyword">false</span>,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal = <span class="keyword">true</span>,</span><br><span class="line">      <span class="built_in">bool?</span> checked,</span><br><span class="line">      <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;? environment,</span><br><span class="line">      <span class="built_in">Uri?</span> packageRoot,</span><br><span class="line">      <span class="built_in">Uri?</span> packageConfig,</span><br><span class="line">      <span class="built_in">bool</span> automaticPackageResolution = <span class="keyword">false</span>,</span><br><span class="line">      <span class="built_in">String?</span> debugName&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify that no mutually exclusive arguments have been passed.</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment">// Resolve the uri against the current isolate&#x27;s root Uri first.</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The VM will invoke [_startIsolate] and not `main`.</span></span><br><span class="line">    <span class="keyword">final</span> packageConfigString = packageConfig?.toString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> RawReceivePort readyPort =</span><br><span class="line">        <span class="keyword">new</span> RawReceivePort(<span class="keyword">null</span>, <span class="string">&#x27;Isolate.spawnUri ready&#x27;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      **_spawnUri**(</span><br><span class="line">          readyPort.sendPort,</span><br><span class="line">          spawnedUri.toString(),</span><br><span class="line">          args,</span><br><span class="line">          message,</span><br><span class="line">          paused,</span><br><span class="line">          onExit,</span><br><span class="line">          onError,</span><br><span class="line">          errorsAreFatal,</span><br><span class="line">          checked,</span><br><span class="line">          <span class="keyword">null</span>,</span><br><span class="line">          <span class="comment">/* environment */</span></span><br><span class="line">          packageConfigString,</span><br><span class="line">          debugName);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> **_spawnCommon**(readyPort);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      readyPort.close();</span><br><span class="line">      <span class="keyword">rethrow</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  Isolate.spawn call</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&quot;vm:external-name&quot;</span>, <span class="string">&quot;Isolate_spawnFunction&quot;</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="keyword">void</span> _spawnFunction(</span><br><span class="line">      SendPort readyPort,</span><br><span class="line">      <span class="built_in">String</span> uri,</span><br><span class="line">      <span class="built_in">Function</span> topLevelFunction,</span><br><span class="line">      <span class="keyword">var</span> message,</span><br><span class="line">      <span class="built_in">bool</span> paused,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">String?</span> packageConfig,</span><br><span class="line">      <span class="built_in">String?</span> debugName);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  Isolate.spawnUri call</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&quot;vm:external-name&quot;</span>, <span class="string">&quot;Isolate_spawnUri&quot;</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> <span class="keyword">void</span> _spawnUri(</span><br><span class="line">      SendPort readyPort,</span><br><span class="line">      <span class="built_in">String</span> uri,</span><br><span class="line">      <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args,</span><br><span class="line">      <span class="keyword">var</span> message,</span><br><span class="line">      <span class="built_in">bool</span> paused,</span><br><span class="line">      SendPort? onExit,</span><br><span class="line">      SendPort? onError,</span><br><span class="line">      <span class="built_in">bool</span> errorsAreFatal,</span><br><span class="line">      <span class="built_in">bool?</span> checked,</span><br><span class="line">      <span class="built_in">List?</span> environment,</span><br><span class="line">      <span class="built_in">String?</span> packageConfig,</span><br><span class="line">      <span class="built_in">String?</span> debugName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听Isolate spawn状态，等成功之后将其处理后返回给Dart层的调用者</span></span><br><span class="line"><span class="keyword">static</span> Future&lt;Isolate&gt; _spawnCommon(RawReceivePort readyPort) &#123;</span><br><span class="line">    <span class="keyword">final</span> completer = <span class="keyword">new</span> Completer&lt;Isolate&gt;.<span class="keyword">sync</span>();</span><br><span class="line">    readyPort.handler = (readyMessage) &#123;</span><br><span class="line">      readyPort.close();</span><br><span class="line">      <span class="keyword">if</span> (readyMessage <span class="keyword">is</span> <span class="built_in">List</span> &amp;&amp; readyMessage.length == <span class="number">2</span>) &#123;</span><br><span class="line">        SendPort controlPort = readyMessage[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">List</span> capabilities = readyMessage[<span class="number">1</span>];</span><br><span class="line">        **completer.complete(<span class="keyword">new</span> Isolate(controlPort,</span><br><span class="line">            pauseCapability: capabilities[<span class="number">0</span>],</span><br><span class="line">            terminateCapability: capabilities[<span class="number">1</span>]));**</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readyMessage <span class="keyword">is</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">        <span class="comment">// We encountered an error while starting the new isolate.</span></span><br><span class="line">        completer.completeError(<span class="keyword">new</span> IsolateSpawnException(</span><br><span class="line">            <span class="string">&#x27;Unable to spawn isolate: <span class="subst">$&#123;readyMessage&#125;</span>&#x27;</span>));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This shouldn&#x27;t happen.</span></span><br><span class="line">        completer.completeError(<span class="keyword">new</span> IsolateSpawnException(</span><br><span class="line">            <span class="string">&quot;Internal error: unexpected format for ready message: &quot;</span></span><br><span class="line">            <span class="string">&quot;&#x27;<span class="subst">$&#123;readyMessage&#125;</span>&#x27;&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其实，根据上述的代码，不管是<code>Isolate.spawnUri()</code> 还是<code>Isolate.spawn</code>，都是先调用<code>RawReceivePort</code>获取<code>RawReceivePort readyPort</code>，最后都是调用了<code>_spawnCommon(readyPort)</code> 方法，最终通过<code>new Isolate(controlPort, pauseCapability: capabilities[0], terminateCapability: capabilities[1])</code>方法创建了新的<code>Isolate</code> 。</p>
<p>这个方法的定义在<code>sdk/lib/isolate/isolate.dart</code>中：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk/lib/isolate/isolate.dart</span></span><br><span class="line"><span class="keyword">final</span> SendPort controlPort;</span><br><span class="line"></span><br><span class="line">Isolate(<span class="keyword">this</span>.controlPort, &#123;<span class="keyword">this</span>.pauseCapability, <span class="keyword">this</span>.terminateCapability&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到，在Dart中，我们拿到的Isolate主要是<strong>持有一个和native中对应SendPort</strong>。</p>
<p>通过上面的分析：</p>
<ul>
<li><code>Isolate.spawn</code>最后调用了<code>_spawnFunction</code>方法（native层实现为<code>Isolate_spawnFunction</code>）；</li>
<li><code>Isolate.spawnUri</code>最后调用了<code>_spawnUri</code>方法（native层实现为<code>Isolate_spawnUri</code>）。</li>
</ul>
<blockquote>
<p>💡 <code>new RawReceivePort()</code>方法主要是创建一个不存在于<code>_RawReceivePortImpl</code>的<code>static final _portMap = &lt;int, Map&lt;String, dynamic&gt;&gt;&#123;&#125;;</code> 中的SendPort（具体实现在<code>PortMap::CreatePort</code>中）。</p>
</blockquote>
<h3 id="Isolate-spawnFunction"><a href="#Isolate-spawnFunction" class="headerlink" title="Isolate_spawnFunction"></a>Isolate_spawnFunction</h3><p><code>Isolate.spawn</code>最后调用了<code>_spawnFunction</code>方法，来看一下对应的<code>Isolate_spawnFunction</code> 的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line">DEFINE_NATIVE_ENTRY(Isolate_spawnFunction, <span class="number">0</span>, <span class="number">10</span>) &#123;</span><br><span class="line"><span class="comment">// 解析参数</span></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// closure_tuple_handle对应我们在Dart中Isolate.spawn()中传入的entryPoint</span></span><br><span class="line">    <span class="comment">// 也就是isolate创建好以后执行的方法</span></span><br><span class="line"></span><br><span class="line">  std::unique_ptr&lt;IsolateSpawnState&gt; state(<span class="keyword">new</span> IsolateSpawnState(</span><br><span class="line">      port.Id(), isolate-&gt;origin_id(), String2UTF8(script_uri),</span><br><span class="line">      closure_tuple_handle, &amp;message_buffer, utf8_package_config,</span><br><span class="line">      paused.value(), fatal_errors, on_exit_port, on_error_port,</span><br><span class="line">      utf8_debug_name, **isolate-&gt;group()**));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since this is a call to Isolate.spawn, copy the parent isolate&#x27;s code.</span></span><br><span class="line">  state-&gt;isolate_flags()-&gt;copy_parent_code = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  **isolate-&gt;group()**-&gt;thread_pool()-&gt;Run&lt;SpawnIsolateTask&gt;(isolate,</span><br><span class="line">                                                         std::move(state));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，<code>Isolate_spawnFunction</code>方法中主要还是解析收到的各种参数，最后在当前isolate对应的IsolateGroup的线程池中执行<code>SpawnIsolateTask</code>：</p>
<h4 id="SpawnIsolateTask"><a href="#SpawnIsolateTask" class="headerlink" title="SpawnIsolateTask"></a>SpawnIsolateTask</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpawnIsolateTask</span> : <span class="title">public</span> <span class="title">ThreadPool</span>::<span class="title">Task</span> </span>&#123;</span><br><span class="line">	SpawnIsolateTask(Isolate* parent_isolate,</span><br><span class="line">                   std::unique_ptr&lt;IsolateSpawnState&gt; state)</span><br><span class="line">      : parent_isolate_(parent_isolate), state_(std::move(state)) &#123;</span><br><span class="line">    parent_isolate-&gt;IncrementSpawnCount();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> Run() override &#123;</span><br><span class="line">    <span class="keyword">const</span> char* name = (state_-&gt;debug_name() == nullptr)</span><br><span class="line">                           ? state_-&gt;function_name()</span><br><span class="line">                           : state_-&gt;debug_name();</span><br><span class="line">    ASSERT(name != nullptr);</span><br><span class="line"></span><br><span class="line">    auto group = state_-&gt;isolate_group();</span><br><span class="line">    <span class="keyword">if</span> (group == nullptr) &#123;</span><br><span class="line">      RunHeavyweight(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      RunLightweight(name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RunLightWeight"><a href="#RunLightWeight" class="headerlink" title="RunLightWeight"></a>RunLightWeight</h4><p>因为这里我们的<code>isolate→group</code>不为空，所以走的是<code>RunLightWeight</code>:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RunLightweight(<span class="keyword">const</span> char* name) &#123;</span><br><span class="line">    <span class="comment">// The create isolate initialize callback is mandatory.</span></span><br><span class="line">    auto initialize_callback = **Isolate::InitializeCallback();**</span><br><span class="line">    <span class="keyword">if</span> (initialize_callback == nullptr) &#123;</span><br><span class="line">      FailedSpawn(</span><br><span class="line">          <span class="string">&quot;Lightweight isolate spawn is not supported by this Dart embedder\n&quot;</span>,</span><br><span class="line">          <span class="comment">/*has_current_isolate=*/</span><span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char* error = nullptr;</span><br><span class="line"></span><br><span class="line">    auto group = state_-&gt;isolate_group();</span><br><span class="line">    **Isolate* isolate = CreateWithinExistingIsolateGroup(group, name, &amp;error);**</span><br><span class="line">    parent_isolate_-&gt;DecrementSpawnCount();</span><br><span class="line">    parent_isolate_ = nullptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolate == nullptr) &#123;</span><br><span class="line">      FailedSpawn(error, <span class="comment">/*has_current_isolate=*/</span><span class="keyword">false</span>);</span><br><span class="line">      free(error);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* child_isolate_data = nullptr;</span><br><span class="line">    **<span class="keyword">const</span> <span class="built_in">bool</span> success = initialize_callback(&amp;child_isolate_data, &amp;error);**</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">      FailedSpawn(error);</span><br><span class="line">      Dart_ShutdownIsolate();</span><br><span class="line">      free(error);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    **isolate-&gt;set_init_callback_data(child_isolate_data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意这里的Run方法，在**RunHeavyweight方法的最后也调用了</span></span><br><span class="line">    <span class="comment">// 到时候会一起分析一下</span></span><br><span class="line">    **Run(isolate);**</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line">Isolate* CreateWithinExistingIsolateGroup(IsolateGroup* group,</span><br><span class="line">                                          <span class="keyword">const</span> char* name,</span><br><span class="line">                                          char** error) &#123;</span><br><span class="line">  API_TIMELINE_DURATION(Thread::Current());</span><br><span class="line">  CHECK_NO_ISOLATE(Isolate::Current());</span><br><span class="line"></span><br><span class="line">  auto spawning_group = group;</span><br><span class="line"></span><br><span class="line">  **Isolate* isolate =** reinterpret_cast&lt;Isolate*&gt;(</span><br><span class="line">      **CreateIsolate**(spawning_group, <span class="comment">/*is_new_group=*/</span><span class="keyword">false</span>, name,</span><br><span class="line">                    <span class="comment">/*isolate_data=*/</span>nullptr, error));</span><br><span class="line">  <span class="keyword">if</span> (isolate == nullptr) <span class="keyword">return</span> nullptr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 因为执行到这里的都有IsolateGroup，共享同一份代码</span></span><br><span class="line">  auto source = spawning_group-&gt;source();</span><br><span class="line">  ASSERT(isolate-&gt;source() == source);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要进行了2步：</p>
<ul>
<li>使用<code>CreateWithinExistingIsolateGroup</code>创建Isolate</li>
<li>使用全局的<code>initialize_callback</code> （也就是<code>Isolate::InitializeCallback()</code>）初始化Isolate</li>
</ul>
<h5 id="Isolate-InitializeCallback"><a href="#Isolate-InitializeCallback" class="headerlink" title="Isolate::InitializeCallback()"></a>Isolate::InitializeCallback()</h5><p>这其中的<code>Isolate::InitializeCallback()</code>是在<code>Dart::Init</code>的时候就已经设置了的：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime/bin/main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main(<span class="built_in">int</span> argc, char** argv) &#123;</span><br><span class="line">...</span><br><span class="line">	<span class="comment">// Initialize the Dart VM.</span></span><br><span class="line">  Dart_InitializeParams init_params;</span><br><span class="line">	init_params.version = DART_INITIALIZE_PARAMS_CURRENT_VERSION;</span><br><span class="line">  init_params.vm_snapshot_data = vm_snapshot_data;</span><br><span class="line">  init_params.vm_snapshot_instructions = vm_snapshot_instructions;</span><br><span class="line">  **init_params.create_group = CreateIsolateGroupAndSetup;**</span><br><span class="line">  **init_params.initialize_isolate = OnIsolateInitialize;**</span><br><span class="line">  init_params.shutdown_isolate = OnIsolateShutdown;</span><br><span class="line">  init_params.cleanup_isolate = DeleteIsolateData;</span><br><span class="line">  init_params.cleanup_group = DeleteIsolateGroupData;</span><br><span class="line">  init_params.file_open = DartUtils::OpenFile;</span><br><span class="line">  init_params.file_read = DartUtils::ReadFile;</span><br><span class="line">  init_params.file_write = DartUtils::WriteFile;</span><br><span class="line">  init_params.file_close = DartUtils::CloseFile;</span><br><span class="line">  init_params.entropy_source = DartUtils::EntropySource;</span><br><span class="line"></span><br><span class="line">	error = Dart_Initialize(&amp;init_params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line">DART_EXPORT char* Dart_Initialize(Dart_InitializeParams* params) &#123;</span><br><span class="line">  <span class="keyword">if</span> (params == NULL) &#123;</span><br><span class="line">    <span class="keyword">return</span> Utils::StrDup(</span><br><span class="line">        <span class="string">&quot;Dart_Initialize: &quot;</span></span><br><span class="line">        <span class="string">&quot;Dart_InitializeParams is null.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (params-&gt;version != DART_INITIALIZE_PARAMS_CURRENT_VERSION) &#123;</span><br><span class="line">    <span class="keyword">return</span> Utils::StrDup(</span><br><span class="line">        <span class="string">&quot;Dart_Initialize: &quot;</span></span><br><span class="line">        <span class="string">&quot;Invalid Dart_InitializeParams version.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Dart::Init(params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\dart.cc</span></span><br><span class="line"></span><br><span class="line">char* Dart::Init(<span class="keyword">const</span> Dart_InitializeParams* params) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!init_state_.SetInitializing()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Utils::StrDup(</span><br><span class="line">        <span class="string">&quot;Bad VM initialization state, &quot;</span></span><br><span class="line">        <span class="string">&quot;already initialized or &quot;</span></span><br><span class="line">        <span class="string">&quot;multiple threads initializing the VM.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  char* retval = DartInit(params);</span><br><span class="line">  <span class="keyword">if</span> (retval != NULL) &#123;</span><br><span class="line">    init_state_.ResetInitializing();</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line">  init_state_.SetInitialized();</span><br><span class="line">  <span class="keyword">return</span> NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">char* Dart::DartInit(<span class="keyword">const</span> Dart_InitializeParams* params) &#123;</span><br><span class="line">...</span><br><span class="line">	OSThread::Init();</span><br><span class="line">  Zone::Init();</span><br><span class="line">	IsolateGroup::Init();</span><br><span class="line">  Isolate::InitVM();</span><br><span class="line">	PortMap::Init();</span><br><span class="line">  Service::Init();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">	Thread::ExitIsolate();  <span class="comment">// Unregister the VM isolate from this thread.</span></span><br><span class="line">  **Isolate::SetCreateGroupCallback(params-&gt;create_group);**</span><br><span class="line">  **Isolate::SetInitializeCallback_(params-&gt;initialize_isolate);**</span><br><span class="line">  Isolate::SetShutdownCallback(params-&gt;shutdown_isolate);</span><br><span class="line">  Isolate::SetCleanupCallback(params-&gt;cleanup_isolate);</span><br><span class="line">  Isolate::SetGroupCleanupCallback(params-&gt;cleanup_group);</span><br><span class="line">  Isolate::SetRegisterKernelBlobCallback(params-&gt;register_kernel_blob);</span><br><span class="line">  Isolate::SetUnregisterKernelBlobCallback(params-&gt;unregister_kernel_blob);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，上文的<code>Isolate::InitializeCallback()</code>实际上就是<code>OnIsolateInitialize</code>，它的主要作用就是在isolate创建好之后进行统一的初始化操作，绑定一些数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">OnIsolateInitialize</span><span class="params">(<span class="type">void</span>** child_callback_data, <span class="type">char</span>** error)</span> </span>&#123;</span><br><span class="line">  Dart_Isolate isolate = <span class="built_in">Dart_CurrentIsolate</span>();</span><br><span class="line">  <span class="built_in">ASSERT</span>(isolate != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> isolate_group_data =</span><br><span class="line">      <span class="built_in">reinterpret_cast</span>&lt;IsolateGroupData*&gt;(<span class="built_in">Dart_CurrentIsolateGroupData</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> isolate_data = <span class="keyword">new</span> <span class="built_in">IsolateData</span>(isolate_group_data);</span><br><span class="line">  *child_callback_data = isolate_data;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Dart_EnterScope</span>();</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> **script_uri** = isolate_group_data-&gt;script_url;</span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> **isolate_run_app_snapshot** =</span><br><span class="line">      isolate_group_data-&gt;<span class="built_in">RunFromAppSnapshot</span>();</span><br><span class="line">  Dart_Handle **result** = <span class="built_in">SetupCoreLibraries</span>(isolate, isolate_data,</span><br><span class="line">                                          <span class="comment">/*group_start=*/</span><span class="literal">false</span>,</span><br><span class="line">                                          <span class="comment">/*resolved_packages_config=*/</span><span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Dart_IsError</span>(result)) <span class="keyword">goto</span> failed;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isolate_run_app_snapshot) &#123;</span><br><span class="line">    result = Loader::<span class="built_in">InitForSnapshot</span>(script_uri, isolate_data);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Dart_IsError</span>(result)) <span class="keyword">goto</span> failed;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result = DartUtils::<span class="built_in">ResolveScript</span>(<span class="built_in">Dart_NewStringFromCString</span>(script_uri));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Dart_IsError</span>(result)) <span class="keyword">goto</span> failed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolate_group_data-&gt;<span class="built_in">kernel_buffer</span>() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="comment">// Various core-library parts will send requests to the Loader to resolve</span></span><br><span class="line">      <span class="comment">// relative URIs and perform other related tasks. We need Loader to be</span></span><br><span class="line">      <span class="comment">// initialized for this to work because loading from Kernel binary</span></span><br><span class="line">      <span class="comment">// bypasses normal source code loading paths that initialize it.</span></span><br><span class="line">      <span class="type">const</span> <span class="type">char</span>* resolved_script_uri = <span class="literal">NULL</span>;</span><br><span class="line">      result = <span class="built_in">Dart_StringToCString</span>(result, &amp;resolved_script_uri);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Dart_IsError</span>(result)) <span class="keyword">goto</span> failed;</span><br><span class="line">      result = Loader::<span class="built_in">InitForSnapshot</span>(resolved_script_uri, isolate_data);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Dart_IsError</span>(result)) <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Dart_ExitScope</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">  *error = Utils::<span class="built_in">StrDup</span>(<span class="built_in">Dart_GetError</span>(result));</span><br><span class="line">  <span class="built_in">Dart_ExitScope</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="CreateWithinExistingIsolateGroup"><a href="#CreateWithinExistingIsolateGroup" class="headerlink" title="CreateWithinExistingIsolateGroup"></a>CreateWithinExistingIsolateGroup</h5><p><code>CreateWithinExistingIsolateGroup</code> → <code>CreateIsolate</code></p>
<p>再看一下创建Isolate的具体方法，这个在不同的device上面不一样，我们只关注vm下面的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Dart_Isolate CreateIsolate(IsolateGroup* group,</span><br><span class="line">                                  <span class="built_in">bool</span> is_new_group,</span><br><span class="line">                                  <span class="keyword">const</span> char* name,</span><br><span class="line">                                  <span class="keyword">void</span>* isolate_data,</span><br><span class="line">                                  char** error) &#123;</span><br><span class="line">  **CHECK_NO_ISOLATE**(Isolate::Current());</span><br><span class="line"></span><br><span class="line">  auto source = group-&gt;source();</span><br><span class="line">  **Isolate* I = Dart::CreateIsolate(name, source-&gt;flags, group);**</span><br><span class="line">  <span class="keyword">if</span> (I == NULL) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error != NULL) &#123;</span><br><span class="line">      *error = Utils::StrDup(<span class="string">&quot;Isolate creation failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> reinterpret_cast&lt;Dart_Isolate&gt;(NULL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Thread* T = Thread::Current();</span><br><span class="line">  <span class="built_in">bool</span> success = <span class="keyword">false</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    StackZone zone(T);</span><br><span class="line">    <span class="comment">// We enter an API scope here as InitializeIsolate could compile some</span></span><br><span class="line">    <span class="comment">// bootstrap library files which call out to a tag handler that may create</span></span><br><span class="line">    <span class="comment">// Api Handles when an error is encountered.</span></span><br><span class="line">    T-&gt;EnterApiScope();</span><br><span class="line">    <span class="keyword">const</span> Error&amp; error_obj = Error::Handle(</span><br><span class="line">        Z, **Dart::InitializeIsolate(</span><br><span class="line">               source-&gt;snapshot_data, source-&gt;snapshot_instructions,</span><br><span class="line">               source-&gt;kernel_buffer, source-&gt;kernel_buffer_size,</span><br><span class="line">               is_new_group ? nullptr : group, isolate_data)**);</span><br><span class="line">    <span class="keyword">if</span> (error_obj.IsNull()) &#123;</span><br><span class="line">#<span class="keyword">if</span> defined(DEBUG) &amp;&amp; !defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">      <span class="keyword">if</span> (FLAG_check_function_fingerprints &amp;&amp; !FLAG_precompiled_mode) &#123;</span><br><span class="line">        Library::CheckFunctionFingerprints();</span><br><span class="line">      &#125;</span><br><span class="line">#endif  <span class="comment">// defined(DEBUG) &amp;&amp; !defined(DART_PRECOMPILED_RUNTIME).</span></span><br><span class="line">      success = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error != NULL) &#123;</span><br><span class="line">      *error = Utils::StrDup(error_obj.ToErrorCString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We exit the API scope entered above.</span></span><br><span class="line">    T-&gt;ExitApiScope();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (success) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_new_group) &#123;</span><br><span class="line">      group-&gt;heap()-&gt;InitGrowthControl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// A Thread structure has been associated to the thread, we do the</span></span><br><span class="line">    <span class="comment">// safepoint transition explicitly here instead of using the</span></span><br><span class="line">    <span class="comment">// TransitionXXX scope objects as the reverse transition happens</span></span><br><span class="line">    <span class="comment">// outside this scope in Dart_ShutdownIsolate/Dart_ExitIsolate.</span></span><br><span class="line">    T-&gt;set_execution_state(Thread::kThreadInNative);</span><br><span class="line">    T-&gt;EnterSafepoint();</span><br><span class="line">    <span class="keyword">if</span> (error != NULL) &#123;</span><br><span class="line">      *error = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Api::CastIsolate(I);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Dart::ShutdownIsolate();</span><br><span class="line">  <span class="keyword">return</span> reinterpret_cast&lt;Dart_Isolate&gt;(NULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要有两步：</p>
<ul>
<li><code>Dart::CreateIsolate</code>创建了<code>Isolate* I</code>；</li>
<li>然后调用<code>Dart::InitializeIsolate</code>初始化isolate。</li>
</ul>
<p><strong>Dart::CreateIsolate：</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart.cc</span></span><br><span class="line"></span><br><span class="line">Isolate* Dart::CreateIsolate(<span class="keyword">const</span> char* name_prefix,</span><br><span class="line">                             <span class="keyword">const</span> Dart_IsolateFlags&amp; api_flags,</span><br><span class="line">                             IsolateGroup* isolate_group) &#123;</span><br><span class="line">  <span class="comment">// Create a new isolate.</span></span><br><span class="line">  Isolate* isolate =</span><br><span class="line">      Isolate::InitIsolate(name_prefix, isolate_group, api_flags);</span><br><span class="line">  <span class="keyword">return</span> isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>💡 在Dart虚拟机启动（<code>Dart::DartInit</code>）的时候，也会调用<code>Dart::InitIsolate</code>创建虚拟机对应的Isolate，执行UI操作：<br><code>vm_isolate_ = Isolate::InitIsolate(kVmIsolateName, group, api_flags, is_vm_isolate);</code></p>
</blockquote>
<p>在<code>Isolate::InitIsolate</code>方法中，先是用<code>isolate_group</code>创建了新的Isolate，然后将其与<code>Thread</code>，<code>MessageHandler</code>，<code>SendPort</code>等绑定：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\isolate.cc</span></span><br><span class="line"></span><br><span class="line">Isolate* Isolate::InitIsolate(<span class="keyword">const</span> char* name_prefix,</span><br><span class="line">                              IsolateGroup* isolate_group,</span><br><span class="line">                              <span class="keyword">const</span> Dart_IsolateFlags&amp; api_flags,</span><br><span class="line">                              <span class="built_in">bool</span> is_vm_isolate) &#123;</span><br><span class="line">	<span class="comment">// 创建新的Isolate</span></span><br><span class="line">  **Isolate* result = <span class="keyword">new</span> Isolate(isolate_group, api_flags);**</span><br><span class="line">  result-&gt;BuildName(name_prefix);</span><br><span class="line">  <span class="keyword">if</span> (!is_vm_isolate) &#123;</span><br><span class="line">    <span class="comment">// vm isolate object store is initialized later, after null instance</span></span><br><span class="line">    <span class="comment">// is created (in Dart::Init).</span></span><br><span class="line">    <span class="comment">// Non-vm isolates need to have isolate object store initialized is that</span></span><br><span class="line">    <span class="comment">// exit_listeners have to be null-initialized as they will be used if</span></span><br><span class="line">    <span class="comment">// we fail to create isolate below, have to do low level shutdown.</span></span><br><span class="line">    ASSERT(result-&gt;group()-&gt;object_store() != nullptr);</span><br><span class="line">    result-&gt;isolate_object_store()-&gt;Init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ASSERT(result != nullptr);</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line"><span class="comment">// Initialize metrics.</span></span><br><span class="line">#define ISOLATE_METRIC_INIT(type, variable, name, unit)                        \</span><br><span class="line">  result-&gt;metric_##variable##_.InitInstance(result, name, NULL, Metric::unit);</span><br><span class="line">  ISOLATE_METRIC_LIST(ISOLATE_METRIC_INIT);</span><br><span class="line">#undef ISOLATE_METRIC_INIT</span><br><span class="line">#endif  <span class="comment">// !defined(PRODUCT)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// First we ensure we enter the isolate. This will ensure we&#x27;re participating</span></span><br><span class="line">  <span class="comment">// in any safepointing requests from this point on. Other threads requesting a</span></span><br><span class="line">  <span class="comment">// safepoint operation will therefore wait until we&#x27;ve stopped.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Though the [result] isolate is still in a state where no memory has been</span></span><br><span class="line">  <span class="comment">// allocated, which means it&#x27;s safe to GC the isolate group until here.</span></span><br><span class="line">  <span class="comment">// 创建一个Thread并和当前isolate绑定</span></span><br><span class="line">  <span class="keyword">if</span> (!**Thread::EnterIsolate(result)**) &#123;</span><br><span class="line">    delete result;</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the isolate message handler.</span></span><br><span class="line">  MessageHandler* handler = <span class="keyword">new</span> IsolateMessageHandler(result);</span><br><span class="line">  ASSERT(handler != nullptr);</span><br><span class="line">	<span class="comment">// 在这里绑定了message handler</span></span><br><span class="line">  **result-&gt;set_message_handler(handler);**</span><br><span class="line"></span><br><span class="line">  **result-&gt;set_main_port(PortMap::CreatePort(result-&gt;message_handler()));**</span><br><span class="line">#<span class="keyword">if</span> defined(DEBUG)</span><br><span class="line">  <span class="comment">// Verify that we are never reusing a live origin id.</span></span><br><span class="line">  VerifyOriginId id_verifier(result-&gt;main_port());</span><br><span class="line">  Isolate::VisitIsolates(&amp;id_verifier);</span><br><span class="line">#endif</span><br><span class="line">  result-&gt;set_origin_id(result-&gt;main_port());</span><br><span class="line">  result-&gt;set_pause_capability(result-&gt;random()-&gt;NextUInt64());</span><br><span class="line">  result-&gt;set_terminate_capability(result-&gt;random()-&gt;NextUInt64());</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line">  result-&gt;debugger_ = <span class="keyword">new</span> Debugger(result);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now we register the isolate in the group. From this point on any GC would</span></span><br><span class="line">  <span class="comment">// traverse the isolate roots (before this point, the roots are only pointing</span></span><br><span class="line">  <span class="comment">// to vm-isolate objects, e.g. null)</span></span><br><span class="line">  **isolate_group-&gt;RegisterIsolate(result);**</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ServiceIsolate::NameEquals(name_prefix)) &#123;</span><br><span class="line">    ASSERT(!ServiceIsolate::Exists());</span><br><span class="line">    ServiceIsolate::SetServiceIsolate(result);</span><br><span class="line">#<span class="keyword">if</span> !defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (KernelIsolate::NameEquals(name_prefix)) &#123;</span><br><span class="line">    ASSERT(!KernelIsolate::Exists());</span><br><span class="line">    KernelIsolate::SetKernelIsolate(result);</span><br><span class="line">#endif  <span class="comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name_prefix == nullptr || strcmp(name_prefix, <span class="string">&quot;vm-isolate&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      OS::PrintErr(</span><br><span class="line">          <span class="string">&quot;[+] Starting isolate:\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\tisolate:    %s\n&quot;</span>,</span><br><span class="line">          result-&gt;name());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add to isolate list. Shutdown and delete the isolate on failure.</span></span><br><span class="line">  <span class="keyword">if</span> (!TryMarkIsolateReady(result)) &#123;</span><br><span class="line">    result-&gt;LowLevelShutdown();</span><br><span class="line">    Isolate::LowLevelCleanup(result);</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Dart::InitializeIsolate</strong></p>
<p>这里主要是对isolate进行初始化，并在初始化完成后通知创建这个isolate的isolate。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart.cc</span></span><br><span class="line"></span><br><span class="line">ErrorPtr Dart::InitializeIsolate(<span class="keyword">const</span> uint8_t* snapshot_data,</span><br><span class="line">                                 <span class="keyword">const</span> uint8_t* snapshot_instructions,</span><br><span class="line">                                 <span class="keyword">const</span> uint8_t* kernel_buffer,</span><br><span class="line">                                 intptr_t kernel_buffer_size,</span><br><span class="line">                                 IsolateGroup* source_isolate_group,</span><br><span class="line">                                 <span class="keyword">void</span>* isolate_data) &#123;</span><br><span class="line">  <span class="comment">// Initialize the new isolate.</span></span><br><span class="line">  Thread* T = Thread::Current();</span><br><span class="line">  Isolate* I = T-&gt;isolate();</span><br><span class="line">  auto IG = T-&gt;isolate_group();</span><br><span class="line">#<span class="keyword">if</span> defined(SUPPORT_TIMELINE)</span><br><span class="line">  TimelineBeginEndScope tbes(T, Timeline::GetIsolateStream(),</span><br><span class="line">                             <span class="string">&quot;InitializeIsolate&quot;</span>);</span><br><span class="line">  tbes.SetNumArguments(<span class="number">1</span>);</span><br><span class="line">  tbes.CopyArgument(<span class="number">0</span>, <span class="string">&quot;isolateName&quot;</span>, I-&gt;name());</span><br><span class="line">#endif</span><br><span class="line">  ASSERT(I != NULL);</span><br><span class="line">  StackZone zone(T);</span><br><span class="line">  HandleScope handle_scope(T);</span><br><span class="line">  <span class="built_in">bool</span> was_child_cloned_into_existing_isolate = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (source_isolate_group != nullptr) &#123;</span><br><span class="line">    <span class="comment">// If a static field gets registered in [IsolateGroup::RegisterStaticField]:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//   * before this block it will ignore this isolate. The [Clone] of the</span></span><br><span class="line">    <span class="comment">//     initial field table will pick up the new value.</span></span><br><span class="line">    <span class="comment">//   * after this block it will add the new static field to this isolate.</span></span><br><span class="line">    &#123;</span><br><span class="line">      SafepointReadRwLocker reader(T, source_isolate_group-&gt;program_lock());</span><br><span class="line">      **I-&gt;set_field_table**(T,</span><br><span class="line">                         source_isolate_group-&gt;initial_field_table()-&gt;Clone(I));</span><br><span class="line">      **I-&gt;field_table()-&gt;MarkReadyToUse();**</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    was_child_cloned_into_existing_isolate = <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> Error&amp; error = Error::Handle(</span><br><span class="line">				<span class="comment">// 从IsolateGroup中引用一些通用的变量（常量等等）</span></span><br><span class="line">        **InitIsolateFromSnapshot**(T, I, snapshot_data, snapshot_instructions,</span><br><span class="line">                                kernel_buffer, kernel_buffer_size));</span><br><span class="line">    <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> error.ptr();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>::VerifyBuiltinVtables();</span><br><span class="line">  <span class="keyword">if</span> (T-&gt;isolate()-&gt;origin_id() == <span class="number">0</span>) &#123;</span><br><span class="line">    DEBUG_ONLY(IG-&gt;heap()-&gt;Verify(kForbidMarked));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">bool</span> kIsAotRuntime = <span class="keyword">true</span>;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">bool</span> kIsAotRuntime = <span class="keyword">false</span>;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (kIsAotRuntime || was_child_cloned_into_existing_isolate) &#123;</span><br><span class="line">#<span class="keyword">if</span> !defined(TARGET_ARCH_IA32)</span><br><span class="line">    ASSERT(IG-&gt;object_store()-&gt;build_generic_method_extractor_code() !=</span><br><span class="line">           Code::<span class="keyword">null</span>());</span><br><span class="line">    ASSERT(IG-&gt;object_store()-&gt;build_nongeneric_method_extractor_code() !=</span><br><span class="line">           Code::<span class="keyword">null</span>());</span><br><span class="line">#endif</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">#<span class="keyword">if</span> !defined(TARGET_ARCH_IA32)</span><br><span class="line">    <span class="keyword">if</span> (I != Dart::vm_isolate()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_generic_method_extractor_code() !=</span><br><span class="line">          nullptr) &#123;</span><br><span class="line">        SafepointWriteRwLocker ml(T, IG-&gt;program_lock());</span><br><span class="line">        <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_generic_method_extractor_code() !=</span><br><span class="line">            nullptr) &#123;</span><br><span class="line">          IG-&gt;object_store()-&gt;set_build_generic_method_extractor_code(</span><br><span class="line">              Code::Handle(</span><br><span class="line">                  StubCode::GetBuildGenericMethodExtractorStub(nullptr)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_nongeneric_method_extractor_code() !=</span><br><span class="line">          nullptr) &#123;</span><br><span class="line">        SafepointWriteRwLocker ml(T, IG-&gt;program_lock());</span><br><span class="line">        <span class="keyword">if</span> (IG-&gt;object_store()-&gt;build_nongeneric_method_extractor_code() !=</span><br><span class="line">            nullptr) &#123;</span><br><span class="line">          IG-&gt;object_store()-&gt;set_build_nongeneric_method_extractor_code(</span><br><span class="line">              Code::Handle(</span><br><span class="line">                  StubCode::GetBuildNonGenericMethodExtractorStub(nullptr)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(TARGET_ARCH_IA32)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  I-&gt;set_ic_miss_code(StubCode::SwitchableCallMiss());</span><br><span class="line"></span><br><span class="line">  Error&amp; error = Error::Handle();</span><br><span class="line">  <span class="keyword">if</span> (snapshot_data == nullptr || kernel_buffer != nullptr) &#123;</span><br><span class="line">    error ^= IG-&gt;object_store()-&gt;PreallocateObjects();</span><br><span class="line">    <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> error.ptr();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> auto&amp; out_of_memory =</span><br><span class="line">      <span class="built_in">Object</span>::Handle(IG-&gt;object_store()-&gt;out_of_memory());</span><br><span class="line">  error ^= I-&gt;isolate_object_store()-&gt;PreallocateObjects(out_of_memory);</span><br><span class="line">  <span class="keyword">if</span> (!error.IsNull()) &#123;</span><br><span class="line">    <span class="keyword">return</span> error.ptr();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!was_child_cloned_into_existing_isolate) &#123;</span><br><span class="line">    IG-&gt;heap()-&gt;InitGrowthControl();</span><br><span class="line">  &#125;</span><br><span class="line">  I-&gt;set_init_callback_data(isolate_data);</span><br><span class="line">  <span class="keyword">if</span> (FLAG_print_class_table) &#123;</span><br><span class="line">    IG-&gt;class_table()-&gt;Print();</span><br><span class="line">  &#125;</span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line">  ServiceIsolate::MaybeMakeServiceIsolate(I);</span><br><span class="line">  <span class="keyword">if</span> (!Isolate::IsSystemIsolate(I)) &#123;</span><br><span class="line">    I-&gt;message_handler()-&gt;set_should_pause_on_start(</span><br><span class="line">        FLAG_pause_isolates_on_start);</span><br><span class="line">    I-&gt;message_handler()-&gt;set_should_pause_on_exit(FLAG_pause_isolates_on_exit);</span><br><span class="line">  &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(PRODUCT)</span></span><br><span class="line"></span><br><span class="line">  ServiceIsolate::SendIsolateStartupMessage();</span><br><span class="line">#<span class="keyword">if</span> !defined(PRODUCT)</span><br><span class="line">  I-&gt;debugger()-&gt;NotifyIsolateCreated();</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create tag table.</span></span><br><span class="line">  I-&gt;set_tag_table(GrowableObjectArray::Handle(GrowableObjectArray::New()));</span><br><span class="line">  <span class="comment">// Set up default UserTag.</span></span><br><span class="line">  <span class="keyword">const</span> UserTag&amp; default_tag = UserTag::Handle(UserTag::DefaultTag());</span><br><span class="line">  I-&gt;set_current_tag(default_tag);</span><br><span class="line"></span><br><span class="line">  I-&gt;init_loaded_prefixes_set_storage();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Error::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到，如果是调用<code>Isolate.spawn()</code>的话，先从当前isolate获取对应的Isolate Group，然后使用这个Isolate Group创建配置一个新的isolate，这样在同一个isolate group中的Isolate可以共享常量，heap等。</p>
<h3 id="Isolate-spawnUri"><a href="#Isolate-spawnUri" class="headerlink" title="Isolate_spawnUri"></a>Isolate_spawnUri</h3><p>如果是使用<code>Isolate.spawnUri()</code>的话，就会通过<code>Isolate_spawnUri</code>来创建isolate。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line">	DEFINE_NATIVE_ENTRY(Isolate_spawnUri, <span class="number">0</span>, <span class="number">12</span>) &#123;</span><br><span class="line"><span class="comment">// 解析参数</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Canonicalize the uri with respect to the current isolate.</span></span><br><span class="line">  <span class="keyword">const</span> Library&amp; root_lib =</span><br><span class="line">      Library::Handle(isolate-&gt;group()-&gt;object_store()-&gt;root_library());</span><br><span class="line">  char* error = NULL;</span><br><span class="line"><span class="comment">// 获取canonical_uri </span></span><br><span class="line">  <span class="keyword">const</span> char* **canonical_uri = CanonicalizeUri**(thread, root_lib, uri, &amp;error);</span><br><span class="line">  <span class="keyword">if</span> (canonical_uri == NULL) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">String</span>&amp; msg = <span class="built_in">String</span>::Handle(<span class="built_in">String</span>::New(error));</span><br><span class="line">    ThrowIsolateSpawnException(msg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> char* utf8_package_config =</span><br><span class="line">      packageConfig.IsNull() ? NULL : String2UTF8(packageConfig);</span><br><span class="line">  <span class="keyword">const</span> char* utf8_debug_name =</span><br><span class="line">      debugName.IsNull() ? NULL : String2UTF8(debugName);</span><br><span class="line"></span><br><span class="line">  std::unique_ptr&lt;IsolateSpawnState&gt; state(<span class="keyword">new</span> **IsolateSpawnState**(</span><br><span class="line">      port.Id(), canonical_uri, utf8_package_config, &amp;arguments_buffer,</span><br><span class="line">      &amp;message_buffer, paused.value(), fatal_errors, on_exit_port,</span><br><span class="line">			<span class="comment">// 注意下面这里的group=nullptr</span></span><br><span class="line">      on_error_port, utf8_debug_name, **<span class="comment">/*group=*/</span>nullptr**));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we were passed a value then override the default flags state for</span></span><br><span class="line">  <span class="comment">// checked mode.</span></span><br><span class="line">  <span class="keyword">if</span> (!checked.IsNull()) &#123;</span><br><span class="line">    Dart_IsolateFlags* flags = state-&gt;isolate_flags();</span><br><span class="line">    flags-&gt;enable_asserts = checked.value();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since this is a call to Isolate.spawnUri, don&#x27;t copy the parent&#x27;s code.</span></span><br><span class="line">  state-&gt;isolate_flags()-&gt;copy_parent_code = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  isolate-&gt;group()-&gt;thread_pool()-&gt;**Run&lt;SpawnIsolateTask&gt;**(isolate,</span><br><span class="line">                                                         std::move(state));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>::<span class="keyword">null</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>Isolate_spawnUri</code>还是执行了<code>SpawnIsolateTask</code> 。</p>
<h4 id="SpawnIsolateTask-1"><a href="#SpawnIsolateTask-1" class="headerlink" title="SpawnIsolateTask"></a>SpawnIsolateTask</h4><p>在<code>SpawnIsolateTask.Run</code>方法中，因为<code>spawnUri</code>中<code>IsolateSpawnState</code>的<code>IsolateGroup</code>为<code>nulltrp</code>，所以这里执行的是<code>RunHeavyweight(name)</code>：</p>
<h4 id="RunHeavyweight"><a href="#RunHeavyweight" class="headerlink" title="RunHeavyweight"></a>RunHeavyweight</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpawnIsolateTask</span> : <span class="title">public</span> <span class="title">ThreadPool</span>::<span class="title">Task</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Run() override &#123;</span><br><span class="line">    <span class="keyword">const</span> char* name = (state_-&gt;debug_name() == nullptr)</span><br><span class="line">                           ? state_-&gt;function_name()</span><br><span class="line">                           : state_-&gt;debug_name();</span><br><span class="line">    ASSERT(name != nullptr);</span><br><span class="line"></span><br><span class="line">    auto group = state_-&gt;isolate_group();</span><br><span class="line">    <span class="keyword">if</span> (group == nullptr) &#123;</span><br><span class="line">      **RunHeavyweight(name);**</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      RunLightweight(name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RunHeavyweight(<span class="keyword">const</span> char* name) &#123;</span><br><span class="line">    <span class="comment">// The create isolate group callback is mandatory.  If not provided we</span></span><br><span class="line">    <span class="comment">// cannot spawn isolates.</span></span><br><span class="line">		<span class="comment">// 在Dart::DartInit中已经被设置，在Isolate创建时会被回调</span></span><br><span class="line">    **auto create_group_callback = Isolate::CreateGroupCallback();**</span><br><span class="line">    <span class="keyword">if</span> (create_group_callback == nullptr) &#123;</span><br><span class="line">      FailedSpawn(<span class="string">&quot;Isolate spawn is not supported by this Dart embedder\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char* error = nullptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make a copy of the state&#x27;s isolate flags and hand it to the callback.</span></span><br><span class="line">    Dart_IsolateFlags api_flags = *(state_-&gt;isolate_flags());</span><br><span class="line">    api_flags.is_system_isolate = <span class="keyword">false</span>;</span><br><span class="line">		<span class="comment">// 创建isolate</span></span><br><span class="line">    **Dart_Isolate isolate =</span><br><span class="line">        (create_group_callback)(state_-&gt;script_url(), name, nullptr,</span><br><span class="line">                                state_-&gt;package_config(), &amp;api_flags,</span><br><span class="line">                                parent_isolate_-&gt;init_callback_data(), &amp;error);**</span><br><span class="line">    parent_isolate_-&gt;DecrementSpawnCount();</span><br><span class="line">    parent_isolate_ = nullptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolate == nullptr) &#123;</span><br><span class="line">      FailedSpawn(error, <span class="comment">/*has_current_isolate=*/</span><span class="keyword">false</span>);</span><br><span class="line">      free(error);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 切换到指定的isolate</span></span><br><span class="line">    Dart_EnterIsolate(isolate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里也调用了Run方法</span></span><br><span class="line">    **Run(reinterpret_cast&lt;Isolate*&gt;(isolate));**</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要创建Isolate的过程在<code>Isolate::CreateGroupCallback();</code>中，让我们看一下他是怎么来的：</p>
<h4 id="Isolate-CreateGroupCallback"><a href="#Isolate-CreateGroupCallback" class="headerlink" title="Isolate::CreateGroupCallback()"></a>Isolate::CreateGroupCallback()</h4><p>他和上述<code>Isolate::InitializeCallback_</code>的来源一致，都是在<code>Dart_Initialize</code>中配置的，此外，还使用了<code>parent_isolate_-&gt;init_callback_data()</code>。</p>
<p>先看一下的<code>CreateIsolateGroupAndSetup</code>实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Dart_Isolate CreateIsolateGroupAndSetup(<span class="keyword">const</span> char* script_uri,</span><br><span class="line">                                               <span class="keyword">const</span> char* main,</span><br><span class="line">                                               <span class="keyword">const</span> char* package_root,</span><br><span class="line">                                               <span class="keyword">const</span> char* package_config,</span><br><span class="line">                                               Dart_IsolateFlags* flags,</span><br><span class="line">                                               <span class="keyword">void</span>* callback_data,</span><br><span class="line">                                               char** error) &#123;</span><br><span class="line">  <span class="comment">// The VM should never call the isolate helper with a NULL flags.</span></span><br><span class="line">  ASSERT(flags != NULL);</span><br><span class="line">  ASSERT(flags-&gt;version == DART_FLAGS_CURRENT_VERSION);</span><br><span class="line">  ASSERT(package_root == nullptr);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> dontneed_safe = <span class="keyword">true</span>;</span><br><span class="line">#<span class="keyword">if</span> defined(DART_HOST_OS_LINUX)</span><br><span class="line">  <span class="comment">// This would also be true in Linux, except that Google3 overrides the default</span></span><br><span class="line">  <span class="comment">// ELF interpreter to one that apparently doesn&#x27;t create proper mappings.</span></span><br><span class="line">  dontneed_safe = <span class="keyword">false</span>;</span><br><span class="line">#elif defined(DEBUG)</span><br><span class="line">  <span class="comment">// If the snapshot isn&#x27;t file-backed, madvise(DONT_NEED) is destructive.</span></span><br><span class="line">  <span class="keyword">if</span> (Options::force_load_elf_from_memory()) &#123;</span><br><span class="line">    dontneed_safe = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">#endif</span><br><span class="line">  flags-&gt;snapshot_is_dontneed_safe = dontneed_safe;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> exit_code = <span class="number">0</span>;</span><br><span class="line">#<span class="keyword">if</span> !defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span><br><span class="line">  <span class="keyword">if</span> (strcmp(script_uri, DART_KERNEL_ISOLATE_NAME) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> **CreateAndSetupKernelIsolate**(script_uri, package_config, flags, error,</span><br><span class="line">                                       &amp;exit_code);</span><br><span class="line">  &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(DART_PRECOMPILED_RUNTIME)</span><br><span class="line">  <span class="keyword">if</span> (strcmp(script_uri, DART_DEV_ISOLATE_NAME) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> **CreateAndSetupDartDevIsolate**(script_uri, package_config, flags,</span><br><span class="line">                                        error, &amp;exit_code);</span><br><span class="line">  &#125;</span><br><span class="line">#endif  <span class="comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (strcmp(script_uri, DART_VM_SERVICE_ISOLATE_NAME) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> **CreateAndSetupServiceIsolate**(script_uri, package_config, flags,</span><br><span class="line">                                        error, &amp;exit_code);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> is_main_isolate = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">return</span> **CreateIsolateGroupAndSetupHelper**(is_main_isolate, script_uri, main,</span><br><span class="line">                                          package_config, flags, callback_data,</span><br><span class="line">                                          error, &amp;exit_code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里创建Isolate的时候，区分了几种情况：</p>
<ul>
<li>如果是kernel-service（<code>DART_KERNEL_ISOLATE_NAME</code>）就执行<code>CreateAndSetupKernelIsolate</code></li>
<li>如果是dartdev（<code>DART_DEV_ISOLATE_NAME</code>）就执行<code>CreateAndSetupDartDevIsolate</code></li>
<li>如果是vm-service（<code>DART_VM_SERVICE_ISOLATE_NAME</code>）就执行<code>CreateAndSetupServiceIsolate</code></li>
<li>如果以上都不满足，就执行<code>CreateIsolateGroupAndSetupHelper</code></li>
</ul>
<p>显然,当我们在Dart代码中调用<code>Isolate.spawnUri</code>的时候，这里会执行的是<code>CreateIsolateGroupAndSetupHelper</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用方</span></span><br><span class="line">	<span class="type">bool</span> is_main_isolate = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">CreateIsolateGroupAndSetupHelper</span>(is_main_isolate, script_uri, main,</span><br><span class="line">                                          package_config, flags, callback_data,</span><br><span class="line">                                          error, &amp;exit_code);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns newly created Isolate on success, NULL on failure.</span></span><br><span class="line"><span class="function"><span class="type">static</span> Dart_Isolate <span class="title">CreateIsolateGroupAndSetupHelper</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">bool</span> is_main_isolate,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* script_uri,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* packages_config,</span></span></span><br><span class="line"><span class="params"><span class="function">    Dart_IsolateFlags* flags,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>* callback_data,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>** error,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span>* exit_code)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// 根据是AOT还是JIT获取kernel_buffer，app_snapshot，isolate_run_app_snapshot等数据</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(DART_PRECOMPILED_RUNTIME)&#123;</span></span><br><span class="line"><span class="comment">// AOT: All isolates need to be run from AOT compiled snapshots.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span>&#123;</span></span><br><span class="line">	<span class="comment">// JIT: Main isolate starts from the app snapshot, if any. Other isolates</span></span><br><span class="line">  <span class="comment">// use the core libraries snapshot.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建isolate_group_data</span></span><br><span class="line">	<span class="keyword">auto</span> isolate_group_data = <span class="keyword">new</span> <span class="built_in">IsolateGroupData</span>(</span><br><span class="line">      script_uri, packages_config, app_snapshot, isolate_run_app_snapshot);</span><br><span class="line">	<span class="comment">// copy_parent_code为true的话，这里的kernel_buffer为NULL</span></span><br><span class="line">  <span class="keyword">if</span> (kernel_buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (kernel_buffer_ptr) &#123;</span><br><span class="line">      isolate_group_data-&gt;<span class="built_in">SetKernelBufferAlreadyOwned</span>(</span><br><span class="line">          std::<span class="built_in">move</span>(kernel_buffer_ptr), kernel_buffer_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isolate_group_data-&gt;<span class="built_in">SetKernelBufferNewlyOwned</span>(kernel_buffer,</span><br><span class="line">                                                    kernel_buffer_size);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	Dart_Isolate isolate = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  IsolateData* isolate_data = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(DART_PRECOMPILED_RUNTIME)</span></span><br><span class="line">  <span class="keyword">if</span> (!isolate_run_app_snapshot &amp;&amp; (isolate_snapshot_data == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span>* platform_kernel_buffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">intptr_t</span> platform_kernel_buffer_size = <span class="number">0</span>;</span><br><span class="line">    dfe.<span class="built_in">LoadPlatform</span>(&amp;platform_kernel_buffer, &amp;platform_kernel_buffer_size);</span><br><span class="line">    <span class="keyword">if</span> (platform_kernel_buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      platform_kernel_buffer = kernel_buffer;</span><br><span class="line">      platform_kernel_buffer_size = kernel_buffer_size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (platform_kernel_buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span><br><span class="line">      <span class="built_in">FATAL</span>(</span><br><span class="line">          <span class="string">&quot;Binary built with --exclude-kernel-service. Cannot run&quot;</span></span><br><span class="line">          <span class="string">&quot; from source.&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;platform_program cannot be NULL.&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// defined(EXCLUDE_CFE_AND_KERNEL_PLATFORM)</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO(sivachandra): When the platform program is unavailable, check if</span></span><br><span class="line">    <span class="comment">// application kernel binary is self contained or an incremental binary.</span></span><br><span class="line">    <span class="comment">// Isolate should be created only if it is a self contained kernel binary.</span></span><br><span class="line">    isolate_data = <span class="keyword">new</span> <span class="built_in">IsolateData</span>(isolate_group_data);</span><br><span class="line">    isolate = <span class="built_in">Dart_CreateIsolateGroupFromKernel</span>(</span><br><span class="line">        script_uri, name, platform_kernel_buffer, platform_kernel_buffer_size,</span><br><span class="line">        flags, isolate_group_data, isolate_data, error);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isolate_data = <span class="keyword">new</span> <span class="built_in">IsolateData</span>(isolate_group_data);</span><br><span class="line">		<span class="comment">// Creates a new isolate. The new isolate becomes the current isolate.</span></span><br><span class="line">    isolate = <span class="built_in">Dart_CreateIsolateGroup</span>(script_uri, name, isolate_snapshot_data,</span><br><span class="line">                                      isolate_snapshot_instructions, flags,</span><br><span class="line">                                      isolate_group_data, isolate_data, error);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  **isolate_data = <span class="keyword">new</span> IsolateData**(isolate_group_data);</span><br><span class="line">	<span class="comment">// Creates a new isolate. The new isolate becomes the current isolate.</span></span><br><span class="line">  **isolate = Dart_CreateIsolateGroup**(script_uri, name, isolate_snapshot_data,</span><br><span class="line">                                    isolate_snapshot_instructions, flags,</span><br><span class="line">                                    **isolate_group_data**, **isolate_data**, error);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// !defined(DART_PRECOMPILED_RUNTIME)</span></span></span><br><span class="line"></span><br><span class="line">  Dart_Isolate created_isolate = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (isolate == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">delete</span> isolate_data;</span><br><span class="line">    <span class="keyword">delete</span> isolate_group_data;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    **created_isolate = IsolateSetupHelper**(</span><br><span class="line">        isolate, is_main_isolate, script_uri, packages_config,</span><br><span class="line">        isolate_run_app_snapshot, flags, error, exit_code);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int64_t</span> end = <span class="built_in">Dart_TimelineGetMicros</span>();</span><br><span class="line">  <span class="built_in">Dart_TimelineEvent</span>(<span class="string">&quot;CreateIsolateGroupAndSetupHelper&quot;</span>, start, end,</span><br><span class="line">                     Dart_Timeline_Event_Duration, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">return</span> created_isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看到，<code>CreateIsolateGroupAndSetupHelper</code>按照是JIT还是AOT的编译方式，有不同的获取数据的方式，但不管哪种方式，最后都执行了一下三步：</p>
<ul>
<li>创建<code>IsolateData* isolate_data</code> 使用<code>isolate_group_data</code>创建IsolateData</li>
<li>创建<code>Dart_Isolate isolate</code> 创建<code>Dart_Isolate</code>，将<code>script_uri</code>，<code>isolate_data</code>，和<code>isolate_group_data</code>等绑定</li>
<li>创建并返回<code>Dart_Isolate created_isolate</code>包装<code>isolate</code> ，进行数据绑定，并将isolate标记为<code>runnable</code></li>
</ul>
<h5 id="Dart-CreateIsolateGroup"><a href="#Dart-CreateIsolateGroup" class="headerlink" title="Dart_CreateIsolateGroup"></a>Dart_CreateIsolateGroup</h5><p>这里分析一下**<code>Dart_CreateIsolateGroup</code>的过程：**</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --&gt; runtime/vm/dart_api_impl.cc#L1371</span></span><br><span class="line"></span><br><span class="line">DART_EXPORT Dart_Isolate</span><br><span class="line">Dart_CreateIsolateGroup(<span class="keyword">const</span> char* script_uri,</span><br><span class="line">                        <span class="keyword">const</span> char* name,</span><br><span class="line">                        <span class="keyword">const</span> uint8_t* snapshot_data,</span><br><span class="line">                        <span class="keyword">const</span> uint8_t* snapshot_instructions,</span><br><span class="line">                        Dart_IsolateFlags* flags,</span><br><span class="line">                        <span class="keyword">void</span>* isolate_group_data,</span><br><span class="line">                        <span class="keyword">void</span>* isolate_data,</span><br><span class="line">                        char** error) &#123;</span><br><span class="line">  API_TIMELINE_DURATION(Thread::Current());</span><br><span class="line"></span><br><span class="line">  Dart_IsolateFlags api_flags;</span><br><span class="line">  <span class="keyword">if</span> (flags == nullptr) &#123;</span><br><span class="line">    Isolate::FlagsInitialize(&amp;api_flags);</span><br><span class="line">    flags = &amp;api_flags;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> char* non_null_name = name == nullptr ? <span class="string">&quot;isolate&quot;</span> : name;</span><br><span class="line">  std::unique_ptr&lt;IsolateGroupSource&gt; source(</span><br><span class="line">      <span class="keyword">new</span> IsolateGroupSource(script_uri, non_null_name, snapshot_data,</span><br><span class="line">                             snapshot_instructions, nullptr, <span class="number">-1</span>, *flags));</span><br><span class="line">  <span class="comment">// 创建Isolate Group</span></span><br><span class="line">  auto group = <span class="keyword">new</span> IsolateGroup(std::move(source), isolate_group_data, *flags);</span><br><span class="line">  <span class="comment">// 创建Isolate Group持有的Heap，由所有在这个Isolate Group下的isolate共享</span></span><br><span class="line">  group-&gt;CreateHeap(</span><br><span class="line">      <span class="comment">/*is_vm_isolate=*/</span><span class="keyword">false</span>, IsServiceOrKernelIsolateName(non_null_name));</span><br><span class="line">  IsolateGroup::RegisterIsolateGroup(group);</span><br><span class="line">  <span class="comment">// 根据刚刚创建的Isolate Group创建Isolate</span></span><br><span class="line">  Dart_Isolate isolate = CreateIsolate(group, <span class="comment">/*is_new_group=*/</span><span class="keyword">true</span>,</span><br><span class="line">                                       non_null_name, isolate_data, error);</span><br><span class="line">  <span class="keyword">if</span> (isolate != nullptr) &#123;</span><br><span class="line">    group-&gt;set_initial_spawn_successful();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> isolate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Run-Isolate-child"><a href="#Run-Isolate-child" class="headerlink" title="Run(Isolate* child)"></a>Run(Isolate* child)</h3><p>在上面的分析中，我们注意到，无论是<code>RunHeavyweight(const char* name)</code>还是<code>RunLightweight(const char* name)</code>方法，最后在创建了新的isolate之后，都执行了<code>Run(Isolate* child)</code>方法，在这里正式启动了isolate：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">(Isolate* child)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">EnsureIsRunnable</span>(child)) &#123;</span><br><span class="line">      <span class="built_in">Dart_ShutdownIsolate</span>();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    state_-&gt;<span class="built_in">set_isolate</span>(child);</span><br><span class="line">    <span class="keyword">if</span> (state_-&gt;<span class="built_in">origin_id</span>() != ILLEGAL_PORT) &#123;</span><br><span class="line">      <span class="comment">// origin_id is set to parent isolate main port id when spawning via</span></span><br><span class="line">      <span class="comment">// spawnFunction.</span></span><br><span class="line">      child-&gt;<span class="built_in">set_origin_id</span>(state_-&gt;<span class="built_in">origin_id</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> success = <span class="literal">true</span>;</span><br><span class="line">    &#123;</span><br><span class="line">			<span class="keyword">auto</span> thread = Thread::<span class="built_in">Current</span>();</span><br><span class="line">      <span class="comment">// TransitionNativeToVM is used to transition the safepoint state of a</span></span><br><span class="line">      <span class="comment">// thread from &quot;running native code&quot; to &quot;running vm code&quot; and ensures</span></span><br><span class="line">      <span class="comment">// that the state is reverted back to &quot;running native code&quot; when</span></span><br><span class="line">      <span class="comment">// exiting the scope/frame.</span></span><br><span class="line">      <span class="function">TransitionNativeToVM <span class="title">transition</span><span class="params">(thread)</span></span>;</span><br><span class="line">      <span class="comment">// Create an empty zone and set is at the current zone for the Thread.</span></span><br><span class="line">      <span class="function">StackZone <span class="title">zone</span><span class="params">(thread)</span></span>;</span><br><span class="line">      <span class="comment">// The class HandleScope is used to start a new handles scope in the</span></span><br><span class="line">      <span class="comment">//  code.</span></span><br><span class="line">      <span class="function">HandleScope <span class="title">hs</span><span class="params">(thread)</span></span>;</span><br><span class="line"></span><br><span class="line">      success = **EnqueueEntrypointInvocationAndNotifySpawner**(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">      state_ = <span class="literal">nullptr</span>;</span><br><span class="line">      <span class="built_in">Dart_ShutdownIsolate</span>();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All preconditions are met for this to always succeed.</span></span><br><span class="line">    <span class="type">char</span>* error = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="comment">// Lets the VM run message processing for the isolate.</span></span><br><span class="line">    <span class="keyword">if</span> (!**Dart_RunLoopAsync**(state_-&gt;<span class="built_in">errors_are_fatal</span>(), state_-&gt;<span class="built_in">on_error_port</span>(),</span><br><span class="line">                           state_-&gt;<span class="built_in">on_exit_port</span>(), &amp;error)) &#123;</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Dart_RunLoopAsync() failed: %s. Please file a Dart VM bug report.&quot;</span>,</span><br><span class="line">            error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里只是做了一些环境准备，然后在<code>EnqueueEntrypointInvocationAndNotifySpawner</code>方法中将isolate要运行的所有东西都准备好，然后再在<code>Dart_RunLoopAsync</code>方法中正式开始isolate处理event queue.</p>
<p><strong>EnqueueEntrypointInvocationAndNotifySpawner</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\lib\isolate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EnqueueEntrypointInvocationAndNotifySpawner</span><span class="params">(Thread* thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> isolate = thread-&gt;<span class="built_in">isolate</span>();</span><br><span class="line">    <span class="keyword">auto</span> zone = thread-&gt;<span class="built_in">zone</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> is_spawn_uri = state_-&gt;<span class="built_in">is_spawn_uri</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1) Resolve the entrypoint function.</span></span><br><span class="line">    <span class="comment">// 查找isolate开始运行的第一个方法，比如Isolate.spawn的spawn或者Isolate.spawnUri的main方法</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; entrypoint_closure = Closure::<span class="built_in">Handle</span>(zone);</span><br><span class="line">    <span class="keyword">if</span> (state_-&gt;<span class="built_in">closure_tuple_handle</span>() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; result = Object::<span class="built_in">Handle</span>(</span><br><span class="line">          zone,</span><br><span class="line">          <span class="built_in">ReadObjectGraphCopyMessage</span>(thread, state_-&gt;<span class="built_in">closure_tuple_handle</span>()));</span><br><span class="line">      <span class="keyword">if</span> (result.<span class="built_in">IsError</span>()) &#123;</span><br><span class="line">        <span class="built_in">ReportError</span>(</span><br><span class="line">            <span class="string">&quot;Failed to deserialize the passed entrypoint to the new isolate.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      entrypoint_closure = Closure::<span class="built_in">RawCast</span>(result.<span class="built_in">ptr</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; result = Object::<span class="built_in">Handle</span>(zone, state_-&gt;<span class="built_in">ResolveFunction</span>());</span><br><span class="line">      <span class="keyword">if</span> (result.<span class="built_in">IsError</span>()) &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(is_spawn_uri);</span><br><span class="line">        <span class="built_in">ReportError</span>(<span class="string">&quot;Failed to resolve entrypoint function.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">ASSERT</span>(result.<span class="built_in">IsFunction</span>());</span><br><span class="line">      <span class="keyword">auto</span>&amp; func = Function::<span class="built_in">Handle</span>(zone, Function::<span class="built_in">Cast</span>(result).<span class="built_in">ptr</span>());</span><br><span class="line">      func = func.<span class="built_in">ImplicitClosureFunction</span>();</span><br><span class="line">      entrypoint_closure = func.<span class="built_in">ImplicitStaticClosure</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2) Enqueue delayed invocation of entrypoint callback.</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; args_obj = Object::<span class="built_in">Handle</span>(zone, state_-&gt;<span class="built_in">BuildArgs</span>(thread));</span><br><span class="line">    <span class="keyword">if</span> (args_obj.<span class="built_in">IsError</span>()) &#123;</span><br><span class="line">      <span class="built_in">ReportError</span>(</span><br><span class="line">          <span class="string">&quot;Failed to deserialize the passed arguments to the new isolate.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ASSERT</span>(args_obj.<span class="built_in">IsNull</span>() || args_obj.<span class="built_in">IsInstance</span>());</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; message_obj =</span><br><span class="line">        Object::<span class="built_in">Handle</span>(zone, state_-&gt;<span class="built_in">BuildMessage</span>(thread));</span><br><span class="line">    <span class="keyword">if</span> (message_obj.<span class="built_in">IsError</span>()) &#123;</span><br><span class="line">      <span class="built_in">ReportError</span>(</span><br><span class="line">          <span class="string">&quot;Failed to deserialize the passed arguments to the new isolate.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ASSERT</span>(message_obj.<span class="built_in">IsNull</span>() || message_obj.<span class="built_in">IsInstance</span>());</span><br><span class="line">    <span class="comment">// 解析参数，分别是isolate初始运行方法，参数args、messgae、是否spawn_uri</span></span><br><span class="line">    <span class="type">const</span> Array&amp; args = Array::<span class="built_in">Handle</span>(zone, Array::<span class="built_in">New</span>(<span class="number">4</span>));</span><br><span class="line">    args.<span class="built_in">SetAt</span>(<span class="number">0</span>, entrypoint_closure);</span><br><span class="line">    args.<span class="built_in">SetAt</span>(<span class="number">1</span>, args_obj);</span><br><span class="line">    args.<span class="built_in">SetAt</span>(<span class="number">2</span>, message_obj);</span><br><span class="line">    args.<span class="built_in">SetAt</span>(<span class="number">3</span>, is_spawn_uri ? Bool::<span class="built_in">True</span>() : Bool::<span class="built_in">False</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; lib = Library::<span class="built_in">Handle</span>(zone, Library::<span class="built_in">IsolateLibrary</span>());</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; entry_name = String::<span class="built_in">Handle</span>(zone, String::<span class="built_in">New</span>(<span class="string">&quot;_startIsolate&quot;</span>));</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; entry_point =</span><br><span class="line">        Function::<span class="built_in">Handle</span>(zone, lib.<span class="built_in">LookupLocalFunction</span>(entry_name));</span><br><span class="line">    <span class="built_in">ASSERT</span>(entry_point.<span class="built_in">IsFunction</span>() &amp;&amp; !entry_point.<span class="built_in">IsNull</span>());</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; result =</span><br><span class="line">        Object::<span class="built_in">Handle</span>(zone, DartEntry::<span class="built_in">InvokeFunction</span>(entry_point, args));</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">IsError</span>()) &#123;</span><br><span class="line">      <span class="built_in">ReportError</span>(<span class="string">&quot;Failed to enqueue delayed entrypoint invocation.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3) Pause the isolate if required &amp; Notify parent isolate about</span></span><br><span class="line">    <span class="comment">// isolate creation.</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; capabilities = Array::<span class="built_in">Handle</span>(zone, Array::<span class="built_in">New</span>(<span class="number">2</span>));</span><br><span class="line">    <span class="keyword">auto</span>&amp; capability = Capability::<span class="built_in">Handle</span>(zone);</span><br><span class="line">    capability = Capability::<span class="built_in">New</span>(isolate-&gt;<span class="built_in">pause_capability</span>());</span><br><span class="line">    capabilities.<span class="built_in">SetAt</span>(<span class="number">0</span>, capability);</span><br><span class="line">    capability = Capability::<span class="built_in">New</span>(isolate-&gt;<span class="built_in">terminate_capability</span>());</span><br><span class="line">    capabilities.<span class="built_in">SetAt</span>(<span class="number">1</span>, capability);</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; send_port =</span><br><span class="line">        SendPort::<span class="built_in">Handle</span>(zone, SendPort::<span class="built_in">New</span>(isolate-&gt;<span class="built_in">main_port</span>()));</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; message = Array::<span class="built_in">Handle</span>(zone, Array::<span class="built_in">New</span>(<span class="number">2</span>));</span><br><span class="line">    message.<span class="built_in">SetAt</span>(<span class="number">0</span>, send_port);</span><br><span class="line">    message.<span class="built_in">SetAt</span>(<span class="number">1</span>, capabilities);</span><br><span class="line">    <span class="keyword">if</span> (state_-&gt;<span class="built_in">paused</span>()) &#123;</span><br><span class="line">      capability ^= capabilities.<span class="built_in">At</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="type">const</span> <span class="type">bool</span> added = isolate-&gt;<span class="built_in">AddResumeCapability</span>(capability);</span><br><span class="line">      <span class="built_in">ASSERT</span>(added);</span><br><span class="line">      isolate-&gt;<span class="built_in">message_handler</span>()-&gt;<span class="built_in">increment_paused</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// If parent isolate died, we ignore the fact that we cannot notify it.</span></span><br><span class="line">      <span class="comment">// 创建一个新的Message并将其压入Isolate的父Isolate对应的MessageHandler的event queue中</span></span><br><span class="line">      PortMap::<span class="built_in">PostMessage</span>(<span class="built_in">WriteMessage</span>(<span class="comment">/* can_send_any_object */</span> <span class="literal">false</span>,</span><br><span class="line">                                        <span class="comment">/* same_group */</span> <span class="literal">false</span>, message,</span><br><span class="line">                                        state_-&gt;<span class="built_in">parent_port</span>(),</span><br><span class="line">                                        Message::kNormalPriority));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里主要做了3件事：</p>
<ul>
<li>查找isolate开始运行的第一个方法<code>entrypoint</code>，比如<code>Isolate.spawn</code>的<code>entrypoint</code>或者<code>Isolate.spawnUri</code>的<code>main</code>方法</li>
<li>解析参数，分别是isolate初始运行方法，参数<code>args</code>、<code>messgae</code>、是否<code>spawn_uri</code>等等，将其与上一步找到的<code>entrypoint</code>结合</li>
<li>（如果需要的话暂停创建好的isolate），并通知isolate的父isolate当前isolate创建成功（附带当前isolate的<code>send_port</code>）</li>
</ul>
<p>至此，Isolate的创建工作已经完成，在<code>Dart_RunLoopAsync</code>开始isolate处理消息：</p>
<p><strong>Dart_RunLoopAsync</strong></p>
<p>在这里主要是开始处理event loop。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt;  runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">DART_EXPORT <span class="type">bool</span> <span class="title">Dart_RunLoopAsync</span><span class="params">(<span class="type">bool</span> errors_are_fatal,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   Dart_Port on_error_port,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   Dart_Port on_exit_port,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">char</span>** error)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> thread = Thread::<span class="built_in">Current</span>();</span><br><span class="line">  <span class="keyword">auto</span> isolate = thread-&gt;<span class="built_in">isolate</span>();</span><br><span class="line">  <span class="built_in">CHECK_ISOLATE</span>(isolate);</span><br><span class="line">  *error = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (thread-&gt;<span class="built_in">api_top_scope</span>() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *error = Utils::<span class="built_in">StrDup</span>(<span class="string">&quot;There must not be an active api scope.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isolate-&gt;<span class="built_in">is_runnable</span>()) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* error_msg = isolate-&gt;<span class="built_in">MakeRunnable</span>();</span><br><span class="line">    <span class="keyword">if</span> (error_msg != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error = Utils::<span class="built_in">StrDup</span>(error_msg);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isolate-&gt;<span class="built_in">SetErrorsFatal</span>(errors_are_fatal);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (on_error_port != ILLEGAL_PORT || on_exit_port != ILLEGAL_PORT) &#123;</span><br><span class="line">    <span class="keyword">auto</span> thread = Thread::<span class="built_in">Current</span>();</span><br><span class="line">    <span class="function">TransitionNativeToVM <span class="title">transition</span><span class="params">(thread)</span></span>;</span><br><span class="line">    <span class="function">StackZone <span class="title">zone</span><span class="params">(thread)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (on_error_port != ILLEGAL_PORT) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; port =</span><br><span class="line">          SendPort::<span class="built_in">Handle</span>(thread-&gt;<span class="built_in">zone</span>(), SendPort::<span class="built_in">New</span>(on_error_port));</span><br><span class="line">      isolate-&gt;<span class="built_in">AddErrorListener</span>(port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (on_exit_port != ILLEGAL_PORT) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; port =</span><br><span class="line">          SendPort::<span class="built_in">Handle</span>(thread-&gt;<span class="built_in">zone</span>(), SendPort::<span class="built_in">New</span>(on_exit_port));</span><br><span class="line">      isolate-&gt;<span class="built_in">AddExitListener</span>(port, Instance::<span class="built_in">null_instance</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Dart_ExitIsolate</span>();</span><br><span class="line">  **isolate-&gt;<span class="built_in">Run</span>();**</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\isolate.cc</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Isolate::Run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">message_handler</span>()-&gt;<span class="built_in">Run</span>(<span class="built_in">group</span>()-&gt;<span class="built_in">thread_pool</span>(), <span class="literal">nullptr</span>, ShutdownIsolate,</span><br><span class="line">                         <span class="built_in">reinterpret_cast</span>&lt;uword&gt;(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Isolate::Run()</code>实际上是开启了处理消息队列：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Runs this message handler on the thread pool.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Before processing messages, the optional StartFunction is run.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// A message handler will run until it terminates either normally or</span></span><br><span class="line">  <span class="comment">// abnormally.  Normal termination occurs when the message handler</span></span><br><span class="line">  <span class="comment">// no longer has any live ports.  Abnormal termination occurs when</span></span><br><span class="line">  <span class="comment">// HandleMessage() indicates that an error has occurred during</span></span><br><span class="line">  <span class="comment">// message processing.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns false if the handler terminated abnormally, otherwise it</span></span><br><span class="line">  <span class="comment">// returns true.</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MessageHandler::Run</span><span class="params">(ThreadPool* pool,</span></span></span><br><span class="line"><span class="params"><span class="function">                         StartCallback start_callback,</span></span></span><br><span class="line"><span class="params"><span class="function">                         EndCallback end_callback,</span></span></span><br><span class="line"><span class="params"><span class="function">                         CallbackData data)</span> </span>&#123;</span><br><span class="line">  <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;monitor_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">    OS::<span class="built_in">PrintErr</span>(</span><br><span class="line">        <span class="string">&quot;[+] Starting message handler:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\thandler:    %s\n&quot;</span>,</span><br><span class="line">        <span class="built_in">name</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">ASSERT</span>(pool_ == <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">ASSERT</span>(!delete_me_);</span><br><span class="line">  pool_ = pool;</span><br><span class="line">  start_callback_ = start_callback;</span><br><span class="line">  end_callback_ = end_callback;</span><br><span class="line">  callback_data_ = data;</span><br><span class="line">  task_running_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="type">bool</span> result = **pool_-&gt;<span class="built_in">Run</span>&lt;MessageHandlerTask&gt;(<span class="keyword">this</span>);**</span><br><span class="line">  <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">    pool_ = <span class="literal">nullptr</span>;</span><br><span class="line">    start_callback_ = <span class="literal">nullptr</span>;</span><br><span class="line">    end_callback_ = <span class="literal">nullptr</span>;</span><br><span class="line">    callback_data_ = <span class="number">0</span>;</span><br><span class="line">    task_running_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> &#123;</span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">Run</span><span class="params">(Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RunImpl</span>(std::<span class="built_in">unique_ptr</span>&lt;Task&gt;(<span class="keyword">new</span> <span class="built_in">T</span>(std::forward&lt;Args&gt;(args)...)));</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ThreadPool::RunImpl</span><span class="params">(std::unique_ptr&lt;Task&gt; task)</span> </span>&#123;</span><br><span class="line">  Worker* new_worker = <span class="literal">nullptr</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;pool_monitor_)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (shutting_down_) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 从线程池中获取task，如果有空闲的/达到最大数量就尝试复用（此时这里返回null）</span></span><br><span class="line">		<span class="comment">// 否则创建新的并返回</span></span><br><span class="line">    new_worker = **ScheduleTaskLocked**(&amp;ml, std::<span class="built_in">move</span>(task));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (new_worker != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="comment">// 创建一个新的Worker在新的系统线程运行task</span></span><br><span class="line">    new_worker-&gt;**<span class="built_in">StartThread</span>()**;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> ThreadPool::Worker::<span class="built_in">StartThread</span>() &#123;</span><br><span class="line">	<span class="comment">// 创建一个新的系统线程，运行指定的代码，</span></span><br><span class="line">	<span class="comment">//  android的实现在runtime\vm\os_thread_android.cc</span></span><br><span class="line">  <span class="type">int</span> result = OSThread::<span class="built_in">Start</span>(<span class="string">&quot;DartWorker&quot;</span>, &amp;**Worker::Main**,</span><br><span class="line">                               <span class="built_in">reinterpret_cast</span>&lt;uword&gt;(<span class="keyword">this</span>));</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">FATAL1</span>(<span class="string">&quot;Could not start worker thread: result = %d.&quot;</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里通过<code>ThreadPool::ScheduleTaskLocked</code>方法获取<code>new_worker</code>：</p>
<ul>
<li>如果已有的worker有空闲的或者已经达到最大数目了，就等待已有的worker执行任务</li>
<li>否则就创建新的worker，并在新的线程运行</li>
</ul>
<p>在获取到worker之后，就执行<code>MessageHandlerTask</code>（见下文详细分析）。</p>
<p>我们主要关注3点：</p>
<ul>
<li><code>ScheduleTaskLocked</code> 分配Worker</li>
<li><code>OSThread::Start</code>中使用<code>&amp;Worker::Main</code> 在新系统线程开启Worker循环</li>
<li><code>MessageHandlerTask</code> 执行具体的消息分发内容</li>
</ul>
<h4 id="ScheduleTaskLocked"><a href="#ScheduleTaskLocked" class="headerlink" title="ScheduleTaskLocked"></a><strong>ScheduleTaskLocked</strong></h4><p>先详细看一下获取<code>new_worker</code>的<code>ThreadPool::ScheduleTaskLocked</code>方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">ThreadPool::Worker* <span class="title">ThreadPool::ScheduleTaskLocked</span><span class="params">(MonitorLocker* ml,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                   std::unique_ptr&lt;Task&gt; task)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Enqueue the new task.</span></span><br><span class="line">  tasks_.<span class="built_in">Append</span>(task.<span class="built_in">release</span>());</span><br><span class="line">  pending_tasks_++;</span><br><span class="line">  <span class="built_in">ASSERT</span>(pending_tasks_ &gt;= <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify existing idle worker (if available).</span></span><br><span class="line">  <span class="keyword">if</span> (count_idle_ &gt;= pending_tasks_) &#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(!idle_workers_.<span class="built_in">IsEmpty</span>());</span><br><span class="line">    ml-&gt;<span class="built_in">Notify</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have maxed out the number of threads running, we will not start a</span></span><br><span class="line">  <span class="comment">// new one.</span></span><br><span class="line">  <span class="keyword">if</span> (max_pool_size_ &gt; <span class="number">0</span> &amp;&amp; (count_idle_ + count_running_) &gt;= max_pool_size_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!idle_workers_.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">      ml-&gt;<span class="built_in">Notify</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Otherwise start a new worker.</span></span><br><span class="line">  <span class="keyword">auto</span> new_worker = <span class="keyword">new</span> <span class="built_in">Worker</span>(<span class="keyword">this</span>);</span><br><span class="line">  idle_workers_.<span class="built_in">Append</span>(new_worker);</span><br><span class="line">  count_idle_++;</span><br><span class="line">  <span class="keyword">return</span> new_worker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的逻辑是：</p>
<p>将当前任务加入到<code>tasks_</code>队列中。</p>
<ul>
<li>如果空闲<code>count_idle_</code> 的Worker比等待中的任务数<code>pending_tasks_</code>多，那就发送通知，使用已有的Worker处理任务。</li>
<li>如果当前Worker数量已经最大了，那就将等待中的任务数pending_tasks_ 加一，等待有空闲的Worker处理任务。</li>
<li>否则，就新建一个Worker（会对应创建一个新的系统线程）来处理任务。</li>
</ul>
<h4 id="amp-Worker-Main"><a href="#amp-Worker-Main" class="headerlink" title="&amp;Worker::Main"></a>&amp;<strong>Worker::Main</strong></h4><p>在<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>这里，StartThread的第二个参数，**<code>&amp;Worker::Main</code>**启动了一个循环，不断的在任务队列<code>tasks_</code>中取出消息并执行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line">ThreadPool::Worker::<span class="built_in">Main</span>(uword args)&#123;</span><br><span class="line">Worker* worker = <span class="built_in">reinterpret_cast</span>&lt;Worker*&gt;(args);</span><br><span class="line">  ThreadPool* pool = worker-&gt;pool_;</span><br><span class="line"></span><br><span class="line">pool-&gt;<span class="built_in">WorkerLoop</span>(worker);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadPool::WorkerLoop</span><span class="params">(Worker* worker)</span> </span>&#123;</span><br><span class="line">  WorkerList dead_workers_to_join;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;pool_monitor_)</span></span>;</span><br><span class="line">		<span class="comment">// worker会从task_取出一个task并运行</span></span><br><span class="line">    <span class="keyword">if</span> (!tasks_.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">      <span class="built_in">IdleToRunningLocked</span>(worker);</span><br><span class="line">      <span class="keyword">while</span> (!tasks_.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;Task&gt; <span class="title">task</span><span class="params">(tasks_.RemoveFirst())</span></span>;</span><br><span class="line">        pending_tasks_--;</span><br><span class="line">        <span class="function">MonitorLeaveScope <span class="title">mls</span><span class="params">(&amp;ml)</span></span>;</span><br><span class="line">        **task-&gt;<span class="built_in">Run</span>();**</span><br><span class="line">        <span class="built_in">ASSERT</span>(Isolate::<span class="built_in">Current</span>() == <span class="literal">nullptr</span>);</span><br><span class="line">        task.<span class="built_in">reset</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">RunningToIdleLocked</span>(worker);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (running_workers_.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">      <span class="built_in">ASSERT</span>(tasks_.<span class="built_in">IsEmpty</span>());</span><br><span class="line">      <span class="built_in">OnEnterIdleLocked</span>(&amp;ml);</span><br><span class="line">      <span class="keyword">if</span> (!tasks_.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shutting_down_) &#123;</span><br><span class="line">      <span class="built_in">ObtainDeadWorkersLocked</span>(&amp;dead_workers_to_join);</span><br><span class="line">      <span class="built_in">IdleToDeadLocked</span>(worker);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sleep until we get a new task, we time out or we&#x27;re shutdown.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int64_t</span> idle_start = OS::<span class="built_in">GetCurrentMonotonicMicros</span>();</span><br><span class="line">    <span class="type">bool</span> done = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span> result = ml.<span class="built_in">WaitMicros</span>(<span class="built_in">ComputeTimeout</span>(idle_start));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// We have to drain all pending tasks.</span></span><br><span class="line">      <span class="keyword">if</span> (!tasks_.<span class="built_in">IsEmpty</span>()) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (shutting_down_ || result == Monitor::kTimedOut) &#123;</span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">      <span class="built_in">ObtainDeadWorkersLocked</span>(&amp;dead_workers_to_join);</span><br><span class="line">      <span class="built_in">IdleToDeadLocked</span>(worker);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before we transitioned to dead we obtained the list of previously died dead</span></span><br><span class="line">  <span class="comment">// workers, which we join here. Since every death of a worker will join</span></span><br><span class="line">  <span class="comment">// previously died workers, we keep the pending non-joined [dead_workers_] to</span></span><br><span class="line">  <span class="comment">// effectively 1.</span></span><br><span class="line">  <span class="built_in">JoinDeadWorkersLocked</span>(&amp;dead_workers_to_join);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MessageHandlerTask</strong> </p>
<p>无论是哪种Worker,最后都是执行的<code>MessageHandlerTask</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageHandlerTask</span> : <span class="keyword">public</span> ThreadPool::Task &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">MessageHandlerTask</span><span class="params">(MessageHandler* handler)</span> : handler_(handler) &#123;</span></span><br><span class="line"><span class="built_in">ASSERT</span>(handler != <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="built_in">ASSERT</span>(handler_ != <span class="literal">NULL</span>);</span><br><span class="line">handler_-&gt;<span class="built_in">TaskCallback</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MessageHandler::TaskCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ASSERT</span>(Isolate::<span class="built_in">Current</span>() == <span class="literal">NULL</span>);</span><br><span class="line">  MessageStatus status = kOK;</span><br><span class="line">  <span class="type">bool</span> run_end_callback = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">bool</span> delete_me = <span class="literal">false</span>;</span><br><span class="line">  EndCallback end_callback = <span class="literal">NULL</span>;</span><br><span class="line">  CallbackData callback_data = <span class="number">0</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// We will occasionally release and reacquire this monitor in this</span></span><br><span class="line">    <span class="comment">// function. Whenever we reacquire the monitor we *must* process</span></span><br><span class="line">    <span class="comment">// all pending OOB messages, or we may miss a request for vm</span></span><br><span class="line">    <span class="comment">// shutdown.</span></span><br><span class="line">    <span class="function">MonitorLocker <span class="title">ml</span><span class="params">(&amp;monitor_)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This method is running on the message handler task. Which means no</span></span><br><span class="line">    <span class="comment">// other message handler tasks will be started until this one sets</span></span><br><span class="line">    <span class="comment">// [task_running_] to false.</span></span><br><span class="line">    <span class="built_in">ASSERT</span>(task_running_);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(PRODUCT)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ShouldPauseOnStart</span>(kOK)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">is_paused_on_start</span>()) &#123;</span><br><span class="line">        <span class="built_in">PausedOnStartLocked</span>(&amp;ml, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// More messages may have come in before we (re)acquired the monitor.</span></span><br><span class="line">      status = <span class="built_in">HandleMessages</span>(&amp;ml, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">ShouldPauseOnStart</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// Still paused.</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(oob_queue_-&gt;<span class="built_in">IsEmpty</span>());</span><br><span class="line">        task_running_ = <span class="literal">false</span>;  <span class="comment">// No task in queue.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">PausedOnStartLocked</span>(&amp;ml, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">is_paused_on_exit</span>()) &#123;</span><br><span class="line">      status = <span class="built_in">HandleMessages</span>(&amp;ml, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">ShouldPauseOnExit</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// Still paused.</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(oob_queue_-&gt;<span class="built_in">IsEmpty</span>());</span><br><span class="line">        task_running_ = <span class="literal">false</span>;  <span class="comment">// No task in queue.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">PausedOnExitLocked</span>(&amp;ml, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// !defined(PRODUCT)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == kOK) &#123;</span><br><span class="line">      <span class="keyword">if</span> (start_callback_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// Initialize the message handler by running its start function,</span></span><br><span class="line">        <span class="comment">// if we have one.  For an isolate, this will run the isolate&#x27;s</span></span><br><span class="line">        <span class="comment">// main() function.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Release the monitor_ temporarily while we call the start callback.</span></span><br><span class="line">        ml.<span class="built_in">Exit</span>();</span><br><span class="line">        status = <span class="built_in">start_callback_</span>(callback_data_);</span><br><span class="line">        <span class="built_in">ASSERT</span>(Isolate::<span class="built_in">Current</span>() == <span class="literal">NULL</span>);</span><br><span class="line">        start_callback_ = <span class="literal">NULL</span>;</span><br><span class="line">        ml.<span class="built_in">Enter</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Handle any pending messages for this message handler.</span></span><br><span class="line">      <span class="keyword">if</span> (status != kShutdown) &#123;</span><br><span class="line">        status = <span class="built_in">HandleMessages</span>(&amp;ml, (status == kOK), <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The isolate exits when it encounters an error or when it no</span></span><br><span class="line">    <span class="comment">// longer has live ports.</span></span><br><span class="line">    <span class="keyword">if</span> (status != kOK || !<span class="built_in">HasLivePorts</span>()) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(PRODUCT)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">ShouldPauseOnExit</span>(status)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (FLAG_trace_service_pause_events) &#123;</span><br><span class="line">          OS::<span class="built_in">PrintErr</span>(</span><br><span class="line">              <span class="string">&quot;Isolate %s paused before exiting. &quot;</span></span><br><span class="line">              <span class="string">&quot;Use the Observatory to release it.\n&quot;</span>,</span><br><span class="line">              <span class="built_in">name</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">PausedOnExitLocked</span>(&amp;ml, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// More messages may have come in while we released the monitor.</span></span><br><span class="line">        **status = <span class="built_in">HandleMessages</span>(&amp;ml, <span class="literal">false</span>, <span class="literal">false</span>);**</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ShouldPauseOnExit</span>(status)) &#123;</span><br><span class="line">          <span class="comment">// Still paused.</span></span><br><span class="line">          <span class="built_in">ASSERT</span>(oob_queue_-&gt;<span class="built_in">IsEmpty</span>());</span><br><span class="line">          task_running_ = <span class="literal">false</span>;  <span class="comment">// No task in queue.</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">PausedOnExitLocked</span>(&amp;ml, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// !defined(PRODUCT)</span></span></span><br><span class="line">      <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status != kOK &amp;&amp; <span class="built_in">thread</span>() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="type">const</span> Error&amp; error = Error::<span class="built_in">Handle</span>(<span class="built_in">thread</span>()-&gt;<span class="built_in">sticky_error</span>());</span><br><span class="line">          OS::<span class="built_in">PrintErr</span>(</span><br><span class="line">              <span class="string">&quot;[-] Stopping message handler (%s):\n&quot;</span></span><br><span class="line">              <span class="string">&quot;\thandler:    %s\n&quot;</span></span><br><span class="line">              <span class="string">&quot;\terror:    %s\n&quot;</span>,</span><br><span class="line">              <span class="built_in">MessageStatusString</span>(status), <span class="built_in">name</span>(), error.<span class="built_in">ToCString</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          OS::<span class="built_in">PrintErr</span>(</span><br><span class="line">              <span class="string">&quot;[-] Stopping message handler (%s):\n&quot;</span></span><br><span class="line">              <span class="string">&quot;\thandler:    %s\n&quot;</span>,</span><br><span class="line">              <span class="built_in">MessageStatusString</span>(status), <span class="built_in">name</span>());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      pool_ = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="comment">// Decide if we have a callback before releasing the monitor.</span></span><br><span class="line">      end_callback = end_callback_;</span><br><span class="line">      callback_data = callback_data_;</span><br><span class="line">      run_end_callback = end_callback_ != <span class="literal">NULL</span>;</span><br><span class="line">      delete_me = delete_me_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear task_running_ last.  This allows other tasks to potentially start</span></span><br><span class="line">    <span class="comment">// for this message handler.</span></span><br><span class="line">    <span class="built_in">ASSERT</span>(oob_queue_-&gt;<span class="built_in">IsEmpty</span>());</span><br><span class="line">    task_running_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The handler may have been deleted by another thread here if it is a native</span></span><br><span class="line">  <span class="comment">// message handler.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Message handlers either use delete_me or end_callback but not both.</span></span><br><span class="line">  <span class="built_in">ASSERT</span>(!delete_me || !run_end_callback);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (run_end_callback) &#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(end_callback != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">end_callback</span>(callback_data);</span><br><span class="line">    <span class="comment">// The handler may have been deleted after this point.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (delete_me) &#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里执行了<code>MessageHandler::HandleMessages</code>方法，来处理消息：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">MessageHandler</span>::<span class="title class_">MessageStatus</span> <span class="title class_">MessageHandler</span>::<span class="title class_">HandleMessages</span>(</span><br><span class="line">    <span class="title class_">MonitorLocker</span>* ml,</span><br><span class="line">    bool allow_normal_messages,</span><br><span class="line">    bool allow_multiple_normal_messages) &#123;</span><br><span class="line">  <span class="title function_">ASSERT</span>(monitor_.<span class="title class_">IsOwnedByCurrentThread</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Scheduling of the mutator thread during the isolate start can cause this</span></span><br><span class="line">  <span class="comment">// thread to safepoint.</span></span><br><span class="line">  <span class="comment">// We want to avoid holding the message handler monitor during the safepoint</span></span><br><span class="line">  <span class="comment">// operation to avoid possible deadlocks, which can occur if other threads are</span></span><br><span class="line">  <span class="comment">// sending messages to this message handler.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// If isolate() returns nullptr [StartIsolateScope] does nothing.</span></span><br><span class="line">  ml-&gt;<span class="title class_">Exit</span>();</span><br><span class="line">  <span class="title class_">StartIsolateScope</span> <span class="title function_">start_isolate</span>(<span class="title function_">isolate</span>());</span><br><span class="line">  ml-&gt;<span class="title class_">Enter</span>();</span><br><span class="line"></span><br><span class="line">  auto idle_time_handler =</span><br><span class="line">      <span class="title function_">isolate</span>() != nullptr ? <span class="title function_">isolate</span>()-&gt;<span class="title function_">group</span>()-&gt;<span class="title function_">idle_time_handler</span>() : nullptr;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">MessageStatus</span> max_status = kOK;</span><br><span class="line">  <span class="title class_">Message</span>::<span class="title class_">Priority</span> min_priority =</span><br><span class="line">      ((allow_normal_messages &amp;&amp; !<span class="title function_">paused</span>()) ? <span class="title class_">Message</span>::kNormalPriority</span><br><span class="line">                                            : <span class="title class_">Message</span>::kOOBPriority);</span><br><span class="line">  <span class="attr">std</span>::unique_ptr&lt;<span class="title class_">Message</span>&gt; **message = <span class="title class_">DequeueMessage</span>(min_priority);**</span><br><span class="line">  <span class="keyword">while</span> (message != nullptr) &#123;</span><br><span class="line">    intptr_t message_len = message-&gt;<span class="title class_">Size</span>();</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">      <span class="attr">OS</span>::<span class="title class_">PrintErr</span>(</span><br><span class="line">          <span class="string">&quot;[&lt;] Handling message:\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\tlen:        %&quot;</span> <span class="title class_">Pd</span></span><br><span class="line">          <span class="string">&quot;\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\thandler:    %s\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\tport:       %&quot;</span> <span class="title class_">Pd64</span> <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">          message_len, <span class="title function_">name</span>(), message-&gt;<span class="title function_">dest_port</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Release the monitor_ temporarily while we handle the message.</span></span><br><span class="line">    <span class="comment">// The monitor was acquired in MessageHandler::TaskCallback().</span></span><br><span class="line">    ml-&gt;<span class="title class_">Exit</span>();</span><br><span class="line">    <span class="title class_">Message</span>::<span class="title class_">Priority</span> saved_priority = message-&gt;<span class="title function_">priority</span>();</span><br><span class="line">    <span class="title class_">Dart</span>_Port saved_dest_port = message-&gt;<span class="title function_">dest_port</span>();</span><br><span class="line">    <span class="title class_">MessageStatus</span> status = kOK;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title class_">DisableIdleTimerScope</span> <span class="title function_">disable_idle_timer</span>(idle_time_handler);</span><br><span class="line">      status = <span class="title class_">HandleMessage</span>(<span class="attr">std</span>::<span class="title function_">move</span>(message));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status &gt; max_status) &#123;</span><br><span class="line">      max_status = status;</span><br><span class="line">    &#125;</span><br><span class="line">    ml-&gt;<span class="title class_">Enter</span>();</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">      <span class="attr">OS</span>::<span class="title class_">PrintErr</span>(</span><br><span class="line">          <span class="string">&quot;[.] Message handled (%s):\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\tlen:        %&quot;</span> <span class="title class_">Pd</span></span><br><span class="line">          <span class="string">&quot;\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\thandler:    %s\n&quot;</span></span><br><span class="line">          <span class="string">&quot;\tport:       %&quot;</span> <span class="title class_">Pd64</span> <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">          <span class="title class_">MessageStatusString</span>(status), message_len, <span class="title function_">name</span>(), saved_dest_port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If we are shutting down, do not process any more messages.</span></span><br><span class="line">    <span class="keyword">if</span> (status == kShutdown) &#123;</span><br><span class="line">      <span class="title class_">ClearOOBQueue</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember time since the last message. Don&#x27;t consider OOB messages so</span></span><br><span class="line">    <span class="comment">// using Observatory doesn&#x27;t trigger additional idle tasks.</span></span><br><span class="line">    <span class="keyword">if</span> ((FLAG_idle_timeout_micros != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        (saved_priority == <span class="title class_">Message</span>::kNormalPriority)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (idle_time_handler != nullptr) &#123;</span><br><span class="line">        idle_time_handler-&gt;<span class="title class_">UpdateStartIdleTime</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some callers want to process only one normal message and then quit. At</span></span><br><span class="line">    <span class="comment">// the same time it is OK to process multiple OOB messages.</span></span><br><span class="line">    <span class="keyword">if</span> ((saved_priority == <span class="title class_">Message</span>::kNormalPriority) &amp;&amp;</span><br><span class="line">        !allow_multiple_normal_messages) &#123;</span><br><span class="line">      <span class="comment">// We processed one normal message.  Allow no more.</span></span><br><span class="line">      allow_normal_messages = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reevaluate the minimum allowable priority.  The paused state</span></span><br><span class="line">    <span class="comment">// may have changed as part of handling the message.  We may also</span></span><br><span class="line">    <span class="comment">// have encountered an error during message processing.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Even if we encounter an error, we still process pending OOB</span></span><br><span class="line">    <span class="comment">// messages so that we don&#x27;t lose the message notification.</span></span><br><span class="line">    min_priority = (((max_status == kOK) &amp;&amp; allow_normal_messages &amp;&amp; !<span class="title function_">paused</span>())</span><br><span class="line">                        ? <span class="title class_">Message</span>::kNormalPriority</span><br><span class="line">                        : <span class="title class_">Message</span>::kOOBPriority);</span><br><span class="line">    message = <span class="title class_">DequeueMessage</span>(min_priority);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> max_status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MessageHandler::DequeueMessage</code>则是按照优先级，依次从<code>oob_queue_</code>和<code>queue_</code>中获取消息：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">std</span>::unique_ptr&lt;<span class="title class_">Message</span>&gt; <span class="title class_">MessageHandler</span>::<span class="title class_">DequeueMessage</span>(</span><br><span class="line">    <span class="title class_">Message</span>::<span class="title class_">Priority</span> min_priority) &#123;</span><br><span class="line">  <span class="comment">// TODO(turnidge): Add assert that monitor_ is held here.</span></span><br><span class="line">  <span class="attr">std</span>::unique_ptr&lt;<span class="title class_">Message</span>&gt; message = oob_queue_-&gt;<span class="title class_">Dequeue</span>();</span><br><span class="line">  <span class="keyword">if</span> ((message == nullptr) &amp;&amp; (min_priority &lt; <span class="title class_">Message</span>::kOOBPriority)) &#123;</span><br><span class="line">    message = queue_-&gt;<span class="title class_">Dequeue</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于<code>oob_queue_</code>和<code>queue_</code> 的区别如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">	<span class="title class_">MessageQueue</span>* queue_;</span><br><span class="line">  <span class="title class_">MessageQueue</span>* oob_queue_;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\message.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">	<span class="comment">// A message processed at any interrupt point (stack overflow check) instead</span></span><br><span class="line">  <span class="comment">// of at the top of the message loop. Control messages from dart:isolate or</span></span><br><span class="line">  <span class="comment">// vm-service requests.</span></span><br><span class="line">  bool <span class="title class_">IsOOB</span>() <span class="keyword">const</span> &#123; <span class="keyword">return</span> priority_ == <span class="title class_">Message</span>::kOOBPriority; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里消息处理的步骤也启动了。</p>
<p>总结一下，<code>Dart_RunLoopAsync</code>的主要功能是触发isolate的<code>message_handler</code>处理消息分发：</p>
<p><code>Dart_RunLoopAsync</code> → <code>Isolate::Run()</code> →  <code>message_handler()-&gt;Run()</code> → <strong>pool_-&gt;</strong><code>Run&lt;MessageHandlerTask&gt;</code> <strong>→</strong> <code>ThreadPool::RunImpl</code></p>
<p>在<code>ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task)</code>这里主要触发了2步：</p>
<ul>
<li><code>ScheduleTaskLocked</code>获取到<code>new_worker</code></li>
<li><code>new_worker</code>调用<code>ThreadPool::Worker::StartThread()</code>方法开启循环</li>
</ul>
<p>然后根据是否创建了<code>new_worker</code>有两种情况：</p>
<ul>
<li>有<code>new_worker</code>，使用在<code>OSThread::Start</code>方法中创建了一个新的系统线程，执行<code>ThreadPool::Worker::Main</code>（这个方法的主要作用使用<code>new_worker</code>从线程池中的取出任务执行）</li>
<li>没有<code>new_worker</code>，那么等待已有的Worker空闲时执行任务</li>
</ul>
<p>无论如何，这里的Worker要执行的任务都是在<code>MessageHandler::Run</code>方法中指定的<code>MessageHandlerTask</code> ，而这个任务的内容便是开启<code>MessageHandler::HandleMessages</code> 方法，按照优先级不断的依次从<code>oob_queue_</code>和<code>queue_</code>中获取消息并处理。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p> <img src="https://jixiaoyong.github.io/images/Isolate_spawn_spawnuri_dart_and_native.png"></p>
<p>Isolate是Dart代码运行的地方，拥有独立的event loop，和全局变量，在自己单独的线程运行。</p>
<p>Isolate.spawn默认会创建在同一个IsolateGroup中的Isolate，他们之间共享Heap（这里会发生GC）和一个线程池。</p>
<p>Isolate.spawnUri会从制定的Uri中创建一个新的IsolateGroup和对应的Isolate，并执行Uri中的main方法。</p>
<p>Isolate内部维持一个Event Loop。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>JI, XIAOYONG
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jixiaoyong.github.io/blog/posts/a951661c/" title="Dart Isolate源码分析">https://jixiaoyong.github.io/blog/posts/a951661c/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/posts/4c220635/" rel="prev" title="Flutter UI 绘制与InheritedWidget解析">
                  <i class="fa fa-chevron-left"></i> Flutter UI 绘制与InheritedWidget解析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/posts/550e5790/" rel="next" title="Dart VM">
                  Dart VM <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JI, XIAOYONG</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/schemes/muse.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>





  




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://vercel.xiaoyong.ml","cssUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.css","commentCount":true,"pageview":true,"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.js","locale":{"placeholder":"ヾ(=^▽^=)ノ"},"meta":["nick","mail","link"],"login":"enable","pageSize":10,"el":"#waline","comment":true,"path":"/blog/posts/a951661c/"}</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
