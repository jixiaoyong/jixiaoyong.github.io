<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/https/jixiaoyong.github.io/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon.ico">
  <link rel="mask-icon" href="/blog/https/jixiaoyong.github.io/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jixiaoyong.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="Dart读取文件时，先在Dart代码创建File引用，通过与IOService跨Isolate通信（先通过IO Service而发送请求到native端，等到native执行完操作之后再回调结果）从而实现对文件的读写。 实现一个简单的读取文件的代码如下： 12345678910111213141516171819202122232425import &amp;#x27;dart:io&amp;#x27;;main">
<meta property="og:type" content="article">
<meta property="og:title" content="Dart 读取文件过程分析">
<meta property="og:url" content="https://jixiaoyong.github.io/blog/posts/3db5282/index.html">
<meta property="og:site_name" content="Ji Xiaoyong&#39;s Blog">
<meta property="og:description" content="Dart读取文件时，先在Dart代码创建File引用，通过与IOService跨Isolate通信（先通过IO Service而发送请求到native端，等到native执行完操作之后再回调结果）从而实现对文件的读写。 实现一个简单的读取文件的代码如下： 12345678910111213141516171819202122232425import &amp;#x27;dart:io&amp;#x27;;main">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jixiaoyong.github.io/images/202206041125613.png">
<meta property="og:image" content="https://jixiaoyong.github.io/images//202206041127617.png">
<meta property="article:published_time" content="2022-06-02T08:25:23.000Z">
<meta property="article:modified_time" content="2022-10-23T11:08:17.512Z">
<meta property="article:author" content="JI, XIAOYONG">
<meta property="article:tag" content="blog,jixiaoyong,android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jixiaoyong.github.io/images/202206041125613.png">


<link rel="canonical" href="https://jixiaoyong.github.io/blog/posts/3db5282/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jixiaoyong.github.io/blog/posts/3db5282/","path":"posts/3db5282/","title":"Dart 读取文件过程分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dart 读取文件过程分析 | Ji Xiaoyong's Blog</title>
  





<link rel="dns-prefetch" href="https://vercel.xiaoyong.ml">
  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ji Xiaoyong's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">过程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E7%AB%AF%E5%8F%91%E8%B5%B7%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E8%AF%B7%E6%B1%82"><span class="nav-text">Dart端发起文件读写请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IO-Service%E4%B8%AD%E8%BD%AC"><span class="nav-text">IO Service中转</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Native%E5%A4%84%E7%90%86Dart%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="nav-text">Native处理Dart的指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IOService-NewServicePort"><span class="nav-text">IOService_NewServicePort</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dart-NewNativePort"><span class="nav-text">Dart_NewNativePort</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dart-NewSendPort"><span class="nav-text">Dart_NewSendPort</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-text">结论</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JI, XIAOYONG"
      src="//jixiaoyong.github.io/images/default_avatar.jpg">
  <p class="site-author-name" itemprop="name">JI, XIAOYONG</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jixiaoyong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jixiaoyong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jixiaoyong1995@gmail.com" title="E-Mail → mailto:jixiaoyong1995@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jixiaoyong.github.io/blog/posts/3db5282/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//jixiaoyong.github.io/images/default_avatar.jpg">
      <meta itemprop="name" content="JI, XIAOYONG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ji Xiaoyong's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Dart 读取文件过程分析 | Ji Xiaoyong's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dart 读取文件过程分析<a href="https://github.com/jixiaoyong/blog_source_code/edit/master/blog/source/_posts/Dart%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-02 16:25:23" itemprop="dateCreated datePublished" datetime="2022-06-02T16:25:23+08:00">2022-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-10-23 19:08:17" itemprop="dateModified" datetime="2022-10-23T19:08:17+08:00">2022-10-23</time>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/blog/posts/3db5282/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/blog/posts/3db5282/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/blog/posts/3db5282/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>Dart读取文件时，先在Dart代码创建File引用，通过与<code>IOService</code>跨<code>Isolate</code>通信（先通过IO Service而发送请求到native端，等到native执行完操作之后再回调结果）从而实现对文件的读写。</p>
<p>实现一个简单的读取文件的代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:io&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">var</span> filePath =</span><br><span class="line">      <span class="string">r&quot;G:/21996.1.210529-1541.co_release_CLIENT_CONSUMER_x64FRE_en-us.iso&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> file = File(filePath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> startTime = printCurrentTimeMs(<span class="string">&quot;start run file.readAsBytes&quot;</span>);</span><br><span class="line">  file.readAsBytes().then((value) &#123;</span><br><span class="line">    printCurrentTimeMs(<span class="string">&quot;file.readAsBytes() finish&quot;</span>,</span><br><span class="line">        lastTimeMs: startTime,</span><br><span class="line">        suffix: <span class="string">&quot;\nfile.readAsBytes() result:<span class="subst">$&#123;value.length&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  printCurrentTimeMs(<span class="string">&quot;finish run file.readAsBytes&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> printCurrentTimeMs(<span class="built_in">String</span> prefix, &#123;<span class="built_in">String?</span> suffix, <span class="built_in">int?</span> lastTimeMs&#125;) &#123;</span><br><span class="line">  <span class="keyword">var</span> currentTimeMs = <span class="built_in">DateTime</span>.now().millisecondsSinceEpoch;</span><br><span class="line">  <span class="keyword">var</span> timeElapseString =</span><br><span class="line">      lastTimeMs == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;, time elapse:<span class="subst">$&#123;currentTimeMs - lastTimeMs&#125;</span>ms &quot;</span>;</span><br><span class="line">  <span class="built_in">print</span>(</span><br><span class="line">      <span class="string">&quot;<span class="subst">$prefix</span> current time(<span class="subst">$currentTimeMs</span>)<span class="subst">$timeElapseString</span><span class="subst">$&#123;suffix ?? <span class="string">&quot;&quot;</span>&#125;</span>&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> currentTimeMs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个过程如下：</p>
<p><img src="https://jixiaoyong.github.io/images/202206041125613.png"></p>
<h1 id="过程分析"><a href="#过程分析" class="headerlink" title="过程分析"></a>过程分析</h1><h2 id="Dart端发起文件读写请求"><a href="#Dart端发起文件读写请求" class="headerlink" title="Dart端发起文件读写请求"></a>Dart端发起文件读写请求</h2><p>其中<code>file.readAsBytes()</code> 是具体执行读取文件的地方，他的定义如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\io\file_impl.dart</span></span><br><span class="line">Future&lt;Uint8List&gt; readAsBytes();</span><br></pre></td></tr></table></figure>

<p>在我们创建<code>File</code>时，实际上创建的是<code>_File</code> （<code>class _File extends FileSystemEntity implements File</code>）对象：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\io\file_impl.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// abstract class File implements FileSystemEntity</span></span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&quot;vm:entry-point&quot;</span>)</span><br><span class="line">  <span class="keyword">factory</span> File(<span class="built_in">String</span> path) &#123;</span><br><span class="line">    <span class="keyword">final</span> IOOverrides? overrides = IOOverrides.current;</span><br><span class="line">    <span class="keyword">if</span> (overrides == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> _File(path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> overrides.createFile(path);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>_File</code> 是<code>File</code> 的实现类，所以<code>file.readAsBytes()</code>实际调用的是<code>_File</code> 实现的方法：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\io\file_impl.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read the file in blocks of size 64k.</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">int</span> _blockSize = <span class="number">64</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_File</span> <span class="keyword">extends</span> <span class="title">FileSystemEntity</span> <span class="keyword">implements</span> <span class="title">File</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Future&lt;Uint8List&gt; readAsBytes() &#123;</span><br><span class="line">    Future&lt;Uint8List&gt; readDataChunked(RandomAccessFile file) &#123;</span><br><span class="line">			<span class="comment">// 分段读取文件，每次只读取_blockSize大小的内容</span></span><br><span class="line">      <span class="keyword">var</span> builder = <span class="keyword">new</span> BytesBuilder(copy: <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">var</span> completer = <span class="keyword">new</span> Completer&lt;Uint8List&gt;();</span><br><span class="line">      <span class="keyword">void</span> read() &#123;</span><br><span class="line">				<span class="comment">// 每次只异步读取一部分文本</span></span><br><span class="line">        file.read(_blockSize).then((data) &#123;</span><br><span class="line">          <span class="keyword">if</span> (data.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            builder.add(data);</span><br><span class="line">            read();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            completer.complete(builder.takeBytes());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, onError: completer.completeError);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      read();</span><br><span class="line">      <span class="keyword">return</span> completer.future;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> open().then((file) &#123;</span><br><span class="line">      <span class="keyword">return</span> file.length().then((length) &#123;</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// May be character device, try to read it in chunks.</span></span><br><span class="line">          <span class="keyword">return</span> readDataChunked(file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file.read(length);</span><br><span class="line">      &#125;).whenComplete(file.close);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，无论是普通的文件格式，还是character device，最后都是调用了<code>_RandomAccessFile</code>的<code>open()</code>和<code>read(int bytes)</code>方法异步读取文件。</p>
<blockquote>
<p>设备文件分为Block Device Driver和Character Device Drive两类。<br>Character Device Driver又被称为字符设备或裸设备raw devices; Block Device Driver通常成为块设备。<br>而Block Device Driver是以固定大小长度来传送转移资料 ； Character Device Driver是以不定长度的字元传送资料。 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/qlee/archive/2011/07/27/2118406.html#:~:text=Character">https://www.cnblogs.com/qlee/archive/2011/07/27/2118406.html#:~:text&#x3D;Character</a></p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; flutter\bin\cache\pkg\sky_engine\lib\io\file_impl.dart</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RandomAccessFile</span> <span class="keyword">implements</span> <span class="title">RandomAccessFile</span> </span>&#123;</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">String</span> path;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> _asyncDispatched = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// 读取文件的信息</span></span><br><span class="line">  <span class="keyword">late</span> _FileResourceInfo _resourceInfo;</span><br><span class="line">	<span class="comment">// 对文件的操作引用</span></span><br><span class="line">  _RandomAccessFileOps _ops;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@pragma</span>(<span class="string">&quot;vm:entry-point&quot;</span>)</span><br><span class="line">  _RandomAccessFile(<span class="built_in">int</span> pointer, <span class="keyword">this</span>.path)</span><br><span class="line">      : _ops = <span class="keyword">new</span> _RandomAccessFileOps(pointer) &#123;</span><br><span class="line">    _resourceInfo = <span class="keyword">new</span> _FileResourceInfo(<span class="keyword">this</span>);</span><br><span class="line">    _maybeConnectHandler();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 异步读取文件</span></span><br><span class="line">	Future&lt;Uint8List&gt; read(<span class="built_in">int</span> bytes) &#123;</span><br><span class="line">    <span class="comment">// TODO(40614): Remove once non-nullability is sound.</span></span><br><span class="line">    ArgumentError.checkNotNull(bytes, <span class="string">&quot;bytes&quot;</span>);</span><br><span class="line">			<span class="comment">// 异步读取文件，实际上是将发送指令到IO Service，然后等待返回结果</span></span><br><span class="line">    <span class="keyword">return</span> _dispatch(_IOService.fileRead, [<span class="keyword">null</span>, bytes]).then((response) &#123;</span><br><span class="line">      <span class="keyword">if</span> (_isErrorResponse(response)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> _exceptionFromResponse(response, <span class="string">&quot;read failed&quot;</span>, path);</span><br><span class="line">      &#125;</span><br><span class="line">      _resourceInfo.addRead(response[<span class="number">1</span>].length);</span><br><span class="line">			<span class="comment">// 读取的文件内容</span></span><br><span class="line">      Uint8List result = response[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 同步读取文件</span></span><br><span class="line">  Uint8List readSync(<span class="built_in">int</span> bytes) &#123;</span><br><span class="line">    <span class="comment">// TODO(40614): Remove once non-nullability is sound.</span></span><br><span class="line">    ArgumentError.checkNotNull(bytes, <span class="string">&quot;bytes&quot;</span>);</span><br><span class="line">    _checkAvailable();</span><br><span class="line">		<span class="comment">// 同步读取文件是对文件直接操作</span></span><br><span class="line">    <span class="keyword">var</span> result = _ops.read(bytes);</span><br><span class="line">    <span class="keyword">if</span> (result <span class="keyword">is</span> OSError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> FileSystemException(<span class="string">&quot;readSync failed&quot;</span>, path, result);</span><br><span class="line">    &#125;</span><br><span class="line">    _resourceInfo.addRead(result.length);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">Future&lt;RandomAccessFile&gt; open(&#123;FileMode mode = FileMode.read&#125;) &#123;</span><br><span class="line"><span class="comment">// FileMode  https://github.com/dart-lang/sdk/blob/main/sdk/lib/io/io_service.dart</span></span><br><span class="line">    <span class="keyword">if</span> (mode != FileMode.read &amp;&amp;</span><br><span class="line">        mode != FileMode.write &amp;&amp;</span><br><span class="line">        mode != FileMode.append &amp;&amp;</span><br><span class="line">        mode != FileMode.writeOnly &amp;&amp;</span><br><span class="line">        mode != FileMode.writeOnlyAppend) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Future.error(</span><br><span class="line">          <span class="keyword">new</span> ArgumentError(<span class="string">&#x27;Invalid file mode for this operation&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _dispatchWithNamespace(</span><br><span class="line">				<span class="comment">// 请求操作为“打开文件”，参数为：null，文件路径，操作文件的mode</span></span><br><span class="line">        _IOService.fileOpen, [<span class="keyword">null</span>, _rawPath, mode._mode]).then((response) &#123;</span><br><span class="line">      <span class="keyword">if</span> (_isErrorResponse(response)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> _exceptionFromResponse(response, <span class="string">&quot;Cannot open file&quot;</span>, path);</span><br><span class="line">      &#125;</span><br><span class="line">			<span class="comment">// 从IO Service那里异步获得文件句柄response和path</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> _RandomAccessFile(response, path);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>_RandomAccessFile</code>中，除了同步读写文件是对返回的文件引用直接操作外，很多操作都能看到通过<code>_dispatch()</code>方法与<code>IO Service</code>通信，让我们看一下这个方法的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\io\file_impl.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _RandomAccessFile</span></span><br><span class="line">Future _dispatch(<span class="built_in">int</span> request, <span class="built_in">List</span> data, &#123;<span class="built_in">bool</span> markClosed = <span class="keyword">false</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Future.error(<span class="keyword">new</span> FileSystemException(<span class="string">&quot;File closed&quot;</span>, path));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (_asyncDispatched) &#123;</span><br><span class="line">      <span class="keyword">var</span> msg = <span class="string">&quot;An async operation is currently pending&quot;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Future.error(<span class="keyword">new</span> FileSystemException(msg, path));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (markClosed) &#123;</span><br><span class="line">      <span class="comment">// Set closed to true to ensure that no more async requests can be issued</span></span><br><span class="line">      <span class="comment">// for this file.</span></span><br><span class="line">      closed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _asyncDispatched = <span class="keyword">true</span>;</span><br><span class="line">    data[<span class="number">0</span>] = _pointer();</span><br><span class="line">		<span class="comment">// 主要代码在这里，通过_IOService的_dispatch发送指令</span></span><br><span class="line">    <span class="keyword">return</span> **_IOService._dispatch**(request, data).whenComplete(() &#123;</span><br><span class="line">      _asyncDispatched = <span class="keyword">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// open create之类的操作会调用这个方法，不过最后也是调用_IOService._dispatch(request, data)通信</span></span><br><span class="line"><span class="keyword">static</span> Future _dispatchWithNamespace(<span class="built_in">int</span> request, <span class="built_in">List</span> data) &#123;</span><br><span class="line">    data[<span class="number">0</span>] = _namespacePointer();</span><br><span class="line">		<span class="comment">// 与IO Service进行异步通信，request标记请求操作的类型，data则是数据</span></span><br><span class="line">    <span class="keyword">return</span> **_IOService._dispatch**(request, data);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>查阅<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/blob/main/sdk/lib/io/io_service.dart">_IOService</a>的源码后发现这是个<code>external</code> 方法.</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">external</span> <span class="keyword">static</span> Future _dispatch(<span class="built_in">int</span> request, <span class="built_in">List</span> data);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>An <code>external</code> function is connected to its body by an implementation-specific mechanism. Attempting to invoke an external function that has not been connected to its body will throw a NoSuchMethodError or some subclass thereof.<br>****<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/issues/4300">https://github.com/dart-lang/sdk/issues/4300</a></p>
</blockquote>
<p>根据<code>external</code>的定义，<code>_dispatch</code>方法在不同的机器上面实现不同。我们只看和app相关的实现（在<code>sdk\lib\_internal\vm</code>目录下，vm同级目录还有js等实现），具体的实现如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\_internal\vm\bin\io_service_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _IOService</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_IOService</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 用于向IO Service发送消息</span></span><br><span class="line">  <span class="keyword">static</span> _IOServicePorts _servicePorts = <span class="keyword">new</span> _IOServicePorts();</span><br><span class="line"><span class="comment">// We use a static variable here to hold onto the last result of</span></span><br><span class="line">  <span class="comment">// calling the IO Service frome the native.</span></span><br><span class="line">  <span class="keyword">static</span> RawReceivePort? _receivePort;</span><br><span class="line">  <span class="comment">// the other side(other isolate) will send message back with the _replyToPort</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">late</span> SendPort _replyToPort;</span><br><span class="line">  <span class="comment">// a map holding the registered callbacks for each received message.</span></span><br><span class="line">  <span class="keyword">static</span> HashMap&lt;<span class="built_in">int</span>, Completer&gt; _messageMap = <span class="keyword">new</span> HashMap&lt;<span class="built_in">int</span>, Completer&gt;();</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">int</span> _id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">[request] IO操作的类型，具体值在[sdk/lib/io/io<span class="emphasis">_service.dart]中的_</span>IOService类中定义</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown"><span class="code">          主要有对文件、目录、网络进行操作的请求</span></span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown"><span class="code">[data]    对应的数据，如果是文件，则是文件路径，如果是目录，则是目录路径等等</span></span></span></span><br><span class="line">  <span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Future _dispatch(<span class="built_in">int</span> request, <span class="built_in">List</span> data) &#123;</span><br><span class="line">    <span class="built_in">int</span> id;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="comment">// create a special id to identify the request.</span></span><br><span class="line">      id = _getNextId();</span><br><span class="line">    &#125; <span class="keyword">while</span> (_messageMap.containsKey(id));</span><br><span class="line">		<span class="comment">// 通过_servicePorts获取一个新的SendPort以便向IOService发送消息，</span></span><br><span class="line">		<span class="comment">// 这个SendPort是IO Service返回给dart用来向他发消息的</span></span><br><span class="line">    <span class="keyword">final</span> SendPort servicePort = _servicePorts._getPort(id);</span><br><span class="line">    _ensureInitialize();</span><br><span class="line">    <span class="keyword">final</span> Completer completer = <span class="keyword">new</span> Completer();</span><br><span class="line">    _messageMap[id] = completer;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 向IOService发送消息，当request执行完毕之后，</span></span><br><span class="line">			<span class="comment">// 会调用_replyToPort触发在root zone的回调_receivePort!.handler</span></span><br><span class="line">      **servicePort**.send(&lt;<span class="built_in">dynamic</span>&gt;[id, **_replyToPort**, request, data]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      _messageMap.remove(id)!.complete(error);</span><br><span class="line">      <span class="keyword">if</span> (_messageMap.length == <span class="number">0</span>) &#123;</span><br><span class="line">        _finalize();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> _ensureInitialize() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_receivePort == <span class="keyword">null</span>) &#123;</span><br><span class="line">      _receivePort = <span class="keyword">new</span> RawReceivePort(<span class="keyword">null</span>, <span class="string">&#x27;IO Service&#x27;</span>);</span><br><span class="line">			<span class="comment">// 其他地方可以使用_replyToPort来发消息触发_receivePort 执行handler方法</span></span><br><span class="line">      _replyToPort = _receivePort!.sendPort;</span><br><span class="line">      _receivePort!.handler = (data) &#123;</span><br><span class="line">			<span class="comment">// 在这里处理IOService执行完方法返回的数据</span></span><br><span class="line">        <span class="keyword">assert</span>(data <span class="keyword">is</span> <span class="built_in">List</span> &amp;&amp; data.length == <span class="number">2</span>);</span><br><span class="line">				<span class="comment">// data[0]就是我们在_dispatch方法中获取的id，</span></span><br><span class="line">        <span class="comment">// 将处理结果data[1]通过Completer.complete返回</span></span><br><span class="line">        _messageMap.remove(data[<span class="number">0</span>])!.complete(data[<span class="number">1</span>]);</span><br><span class="line">				<span class="comment">// 释放这个触发这个回调的SendPort</span></span><br><span class="line">        _servicePorts._returnPort(data[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (_messageMap.length == <span class="number">0</span>) &#123;</span><br><span class="line">          _finalize();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，最后是通过<code>RawReceivePort</code>&#x2F;<code>SendPort</code>进行<strong>跨Isolate通信</strong>。</p>
<p><code>_IOService</code>使用<code>_servicePorts</code>对native层发送消息触发IO操作，然后使用<code>_receivePort</code>监听，当IO操作完成时会通过<code>_replyToPort</code> 回调结果，会在 <code>_receivePort!.handler</code>方法中根据当时请求的<code>id</code>找到<code>Completer</code>将结果传递回去。</p>
<p>这样当时我们在 <code>file.readAsBytes()</code>时获取到的<code>Future</code>便会收到回调，从而完成文件操作的流程。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file.readAsBytes().then((value) &#123;</span><br><span class="line">  printCurrentTimeMs(<span class="string">&quot;file.readAsBytes() finish&quot;</span>,</span><br><span class="line">      lastTimeMs: startTime,</span><br><span class="line">      suffix: <span class="string">&quot;\nfile.readAsBytes() result:<span class="subst">$&#123;value.length&#125;</span>&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面是到目前为止涉及到的类关系示意图：</p>
<p><img src="https://jixiaoyong.github.io/images//202206041127617.png"></p>
<h2 id="IO-Service中转"><a href="#IO-Service中转" class="headerlink" title="IO Service中转"></a>IO Service中转</h2><p>那么，这个IO Service是做什么的，他又是如何实现与dart中的调用方双向通信，以及执行调用方需要的功能呢？</p>
<p>位于<code>sdk\lib\_internal\vm\bin\io_service_patch.dart</code>的_IOService是一个中转站，<strong>向上承接</strong>来自Dart代码的IO请求指令（先行返回Future），<strong>向下将这些指令转发</strong>至Native层的IO Service，并<strong>监听回调</strong>，当native层处理完这些IO指令之后，将结果通过Future返回给Dart调用方。</p>
<p>让我们再看一下他的具体实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\_internal\vm\bin\io_service_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _IOService</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_IOService</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 用于向IO Service发送消息</span></span><br><span class="line">  <span class="keyword">static</span> _IOServicePorts _servicePorts = <span class="keyword">new</span> _IOServicePorts();</span><br><span class="line"><span class="comment">// We use a static variable here to hold onto the last result of</span></span><br><span class="line">  <span class="comment">// calling the IO Service frome the native.</span></span><br><span class="line">  <span class="keyword">static</span> RawReceivePort? _receivePort;</span><br><span class="line">  <span class="comment">// the other side(other isolate) will send message back with the _replyToPort</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">late</span> SendPort _replyToPort;</span><br><span class="line">  <span class="comment">// a map holding the registered callbacks for each received message.</span></span><br><span class="line">  <span class="keyword">static</span> HashMap&lt;<span class="built_in">int</span>, Completer&gt; _messageMap = <span class="keyword">new</span> HashMap&lt;<span class="built_in">int</span>, Completer&gt;();</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">int</span> _id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">[request] IO操作的类型，具体值在[sdk/lib/io/io<span class="emphasis">_service.dart]中的_</span>IOService类中定义</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown"><span class="code">          主要有对文件、目录、网络进行操作的请求</span></span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown"><span class="code">[data]    对应的数据，如果是文件，则是文件路径，如果是目录，则是目录路径等等</span></span></span></span><br><span class="line">  <span class="meta">@patch</span></span><br><span class="line">  <span class="keyword">static</span> Future _dispatch(<span class="built_in">int</span> request, <span class="built_in">List</span> data) &#123;</span><br><span class="line">    <span class="built_in">int</span> id;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="comment">// create a special id to identify the request.</span></span><br><span class="line">      id = _getNextId();</span><br><span class="line">    &#125; <span class="keyword">while</span> (_messageMap.containsKey(id));</span><br><span class="line">		<span class="comment">// 通过_servicePorts获取一个新的SendPort以便向IOService发送消息，</span></span><br><span class="line">		<span class="comment">// 这个SendPort是IO Service返回给dart用来向他发消息的</span></span><br><span class="line">    <span class="keyword">final</span> SendPort **servicePort** = _servicePorts.**_getPort(id);**</span><br><span class="line">    _ensureInitialize();</span><br><span class="line">    <span class="keyword">final</span> Completer completer = <span class="keyword">new</span> Completer();</span><br><span class="line">    _messageMap[id] = completer;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 向IOService发送消息，当request执行完毕之后，</span></span><br><span class="line">			<span class="comment">// 会调用_replyToPort触发在root zone的回调_receivePort!.handler</span></span><br><span class="line">      **servicePort**.send(&lt;<span class="built_in">dynamic</span>&gt;[id, **_replyToPort**, request, data]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      _messageMap.remove(id)!.complete(error);</span><br><span class="line">      <span class="keyword">if</span> (_messageMap.length == <span class="number">0</span>) &#123;</span><br><span class="line">        _finalize();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> _ensureInitialize() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_receivePort == <span class="keyword">null</span>) &#123;</span><br><span class="line">      _receivePort = <span class="keyword">new</span> RawReceivePort(<span class="keyword">null</span>, <span class="string">&#x27;IO Service&#x27;</span>);</span><br><span class="line">			<span class="comment">// 其他地方可以使用_replyToPort来发消息触发_receivePort 执行handler方法</span></span><br><span class="line">      _replyToPort = _receivePort!.sendPort;</span><br><span class="line">      _receivePort!.handler = (data) &#123;</span><br><span class="line">			<span class="comment">// 在这里处理IOService执行完方法返回的数据</span></span><br><span class="line">        <span class="keyword">assert</span>(data <span class="keyword">is</span> <span class="built_in">List</span> &amp;&amp; data.length == <span class="number">2</span>);</span><br><span class="line">				<span class="comment">// data[0]就是我们在_dispatch方法中获取的id，</span></span><br><span class="line">        <span class="comment">// 将处理结果data[1]通过Completer.complete返回</span></span><br><span class="line">        _messageMap.remove(data[<span class="number">0</span>])!.complete(data[<span class="number">1</span>]);</span><br><span class="line">				<span class="comment">// 释放这个触发这个回调的SendPort</span></span><br><span class="line">        _servicePorts._returnPort(data[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (_messageMap.length == <span class="number">0</span>) &#123;</span><br><span class="line">          _finalize();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到：</p>
<ul>
<li><code>_IOService</code>持有<code>_IOServicePorts _servicePorts</code>以便获取<code>SendPort servicePort</code>和native层通信，</li>
<li>在之前的代码分析中，我们已经知道<code>_IOService</code>还在<code>_ensureInitialize()</code>中监听着<code>RawReceivePort? _receivePort</code>的回调，</li>
<li>这样当<code>_IOService</code>在<code>_dispatch()</code>方法中将<code>_replyToPort</code>（<code>_receivePort</code>的SendPort）传递给<code>servicePort</code>后，一旦native通过<code>_replyToPort</code>发送处理结果，<code>_IOService</code>立马可以收到并通过<code>Completer.complete</code>返回给<strong>Dart中的调用方</strong>。</li>
</ul>
<aside>
💡 注意这里的`SendPort **servicePort`** ，他是从native层的`_IOService` 获取到的：
1. 在native层通过`PortMap::CreatePort(MessageHandler* handler)`创建好此`Dart_Port port` 
2. `MessageHandler` 在创建`Dart_Port port`的时候就与之关联
3. 在Dart层的`_IOService` 这里监听
这样，当native层的`MessageHandler`执行指令之后，会将`Dart_Port port`传递给`IOServiceCallback`，后者将他和自身执行结果一并打包为native层的Message压入`MessageHandler`的`消息queue`中，然后由消息分发系统按照发送到Dart这里，按照`SendPort **servicePort`** 找到要执行的代码。

</aside>

<p>上述这些步骤能够实施的关键，在于<strong>Dart</strong>层的<code>_IOService</code>如何与<strong>native</strong>层的<code>_IOService</code>关联起来呢？</p>
<p>让我们来分析一下<code>SendPort servicePort</code>的获取过程：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; sdk\lib\_internal\vm\bin\io_service_patch.dart</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_IOService</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 用于向IO Service发送消息</span></span><br><span class="line">	<span class="keyword">static</span> _IOServicePorts _servicePorts = <span class="keyword">new</span> _IOServicePorts();</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_IOServicePorts</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We limit the number of IO Service ports per isolate so that we don&#x27;t</span></span><br><span class="line">  <span class="comment">// spawn too many threads all at once, which can crash the VM on Windows.</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">int</span> maxPorts = <span class="number">32</span>;</span><br><span class="line">  <span class="built_in">List</span>&lt;SendPort&gt; _ports = &lt;SendPort&gt;[];</span><br><span class="line">  <span class="built_in">List</span>&lt;SendPort&gt; _freePorts = &lt;SendPort&gt;[];</span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">int</span>, SendPort&gt; _usedPorts = <span class="keyword">new</span> HashMap&lt;<span class="built_in">int</span>, SendPort&gt;();</span><br><span class="line"></span><br><span class="line">  _IOServicePorts();</span><br><span class="line"></span><br><span class="line">  SendPort _getPort(<span class="built_in">int</span> forRequestId) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_freePorts.isEmpty &amp;&amp; _usedPorts.length &lt; maxPorts) &#123;</span><br><span class="line">			<span class="comment">// 如果没有可用的SendPort,就新建SendPort用于远程服务通信</span></span><br><span class="line">      <span class="keyword">final</span> SendPort port = **_newServicePort()**;</span><br><span class="line">      _ports.add(port);</span><br><span class="line">      _freePorts.add(port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!_freePorts.isEmpty) &#123;</span><br><span class="line">      <span class="comment">// 有空闲SendPort，使用</span></span><br><span class="line">      <span class="keyword">final</span> SendPort port = _freePorts.removeLast();</span><br><span class="line">      <span class="keyword">assert</span>(!_usedPorts.containsKey(forRequestId));</span><br><span class="line">      _usedPorts[forRequestId] = port;</span><br><span class="line">      <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We have already allocated the max number of ports. Re-use an</span></span><br><span class="line">    <span class="comment">// existing one.</span></span><br><span class="line">    <span class="keyword">final</span> SendPort port = _ports[forRequestId % maxPorts];</span><br><span class="line">    _usedPorts[forRequestId] = port;</span><br><span class="line">    <span class="keyword">return</span> port;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 释放掉占用的port</span></span><br><span class="line">  <span class="keyword">void</span> _returnPort(<span class="built_in">int</span> forRequestId) &#123;</span><br><span class="line">    <span class="keyword">final</span> SendPort port = _usedPorts.remove(forRequestId)!;</span><br><span class="line">    <span class="keyword">if</span> (!_usedPorts.values.contains(port)) &#123;</span><br><span class="line">      _freePorts.add(port);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@pragma</span>(<span class="string">&quot;vm:external-name&quot;</span>, <span class="string">&quot;IOService_NewServicePort&quot;</span>)</span><br><span class="line">  <span class="keyword">external</span> <span class="keyword">static</span> SendPort _newServicePort();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里最后的关键方法是<code>SendPort _newServicePort()</code>，这是一个<code>external</code>方法，在native实现。</p>
<h2 id="Native处理Dart的指令"><a href="#Native处理Dart的指令" class="headerlink" title="Native处理Dart的指令"></a>Native处理Dart的指令</h2><h3 id="IOService-NewServicePort"><a href="#IOService-NewServicePort" class="headerlink" title="IOService_NewServicePort"></a>IOService_NewServicePort</h3><p><code>SendPort</code>是由<code>_newServicePort()</code>方法创建的，这是一个<code>external</code>方法，他的native层实现名称是<code>IOService_NewServicePort</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\io_service.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> FUNCTION_NAME(IOService_NewServicePort)(Dart_NativeArguments args) &#123;</span><br><span class="line">  Dart_SetReturnValue(args, Dart_Null());</span><br><span class="line">	<span class="comment">// 创建一个新的native port</span></span><br><span class="line">  Dart_Port service_port = **IOService::GetServicePort();**</span><br><span class="line">  <span class="keyword">if</span> (service_port != ILLEGAL_PORT) &#123;</span><br><span class="line">		<span class="comment">// 【注意】这里根据service_port创建了Dart里面的SendPort对象</span></span><br><span class="line">    <span class="comment">// Return a send port for the service port.</span></span><br><span class="line">    Dart_Handle send_port = Dart_NewSendPort(service_port);</span><br><span class="line">		<span class="comment">// 将当前IOService对应的send_port返回给调用方</span></span><br><span class="line">    Dart_SetReturnValue(args, send_port);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Dart_Port IOService::GetServicePort() &#123;</span><br><span class="line">  <span class="comment">// 注意这里的参数</span></span><br><span class="line">  <span class="comment">// 分别是 native port的名称，收到native port以后得回调方法，是否同时处理</span></span><br><span class="line">  <span class="keyword">return</span> **Dart_NewNativePort(<span class="string">&quot;IOService&quot;</span>, IOServiceCallback, <span class="keyword">true</span>);**</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\include\dart_api.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown">/<span class="strong">**</span></span></span></span><br><span class="line"><span class="strong"><span class="language-markdown"><span class="comment"> <span class="emphasis">*</span></span></span> Returns a new <span class="language-markdown"><span class="strong"><span class="emphasis">SendPort</span></span></span> with the provided <span class="language-markdown"><span class="strong"><span class="emphasis">port id.</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="language-markdown"><span class="comment"> *</span></span></span></span></span><br><span class="line"><span class="strong"><span class="language-markdown"><span class="comment"> <span class="emphasis">* \param port_id The destination port.</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="language-markdown"><span class="comment"> *</span></span></span></span></span><br><span class="line"><span class="strong"><span class="language-markdown"><span class="comment"> <span class="emphasis">* \return A new SendPort if no</span></span></span> errors occurs. Otherwise <span class="language-markdown"><span class="strong"><span class="emphasis">returns</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="language-markdown"><span class="comment"> *</span>   an error handle.</span></span></span></span><br><span class="line"><span class="strong"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span></span><br><span class="line">DART_EXPORT Dart_Handle Dart_NewSendPort(Dart_Port port_id);</span><br></pre></td></tr></table></figure>

<p>注意，在Dart层的<code>_IOService</code>的<code>SendPort _newServicePort()</code> 方法最后再这里调用了<code>IOService_NewServicePort</code>。</p>
<p>这里主要有3个步骤：</p>
<ol>
<li>使用<code>Dart_NewNativePort(&quot;IOService&quot;, IOServiceCallback, true);</code>创建<code>Dart_Port</code></li>
<li>使用<code>Dart_NewSendPort</code>将<code>Dart_Port</code>转化为<code>Dart_Handle</code>（也就是Dart中的<code>SendPort</code>）</li>
<li>返回上面创建好的<code>Dart_Handle</code>，Dart代码拿到返回的Dart_Handle也就是<code>SendPort servicePort</code>之后，就可以和native层的IO Service同通信。</li>
</ol>
<p>接下来我们看一下前2步分别是怎么实现的：</p>
<h3 id="Dart-NewNativePort"><a href="#Dart-NewNativePort" class="headerlink" title="Dart_NewNativePort"></a>Dart_NewNativePort</h3><p>再看一下<code>Dart_NewNativePort</code>的调用参数：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Dart</span>_NewNativePort(<span class="string">&quot;IOService&quot;</span>, <span class="title class_">IOServiceCallback</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\include\dart_native_api.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  Creates a new native port.  When messages are received on this</span></span><br><span class="line"><span class="comment">//  native port, then they will be dispatched to the provided native</span></span><br><span class="line"><span class="comment">//  message handler.</span></span><br><span class="line"><span class="variable constant_">DART_EXPORT</span> <span class="title class_">Dart</span>_Port <span class="title class_">Dart</span>_NewNativePort(<span class="keyword">const</span> char* name,</span><br><span class="line">                                         <span class="title class_">Dart</span>_NativeMessageHandler handler,</span><br><span class="line">                                         bool handle_concurrently);</span><br></pre></td></tr></table></figure>

<p><strong>IOServiceCallback</strong></p>
<p><code>Dart_NewNativePort</code>总共有3个参数，<code>Dart_NativeMessageHandler handler</code>是当这个<code>Dart_Port</code>收到消息的时候，会被回调的方法，也就是我们通过Dart端的<code>_IOService.dispatch</code>方法的**<code>servicePort**.send(&lt;dynamic&gt;[id, **_replyToPort**, request, data]);</code>语句执行向native发送IO指令时，在native这里真正负责执行的方法：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\io_service.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> IOServiceCallback(Dart_Port dest_port_id, Dart_CObject* message) &#123;</span><br><span class="line">  Dart_Port reply_port_id = ILLEGAL_PORT;</span><br><span class="line">  CObject* response = CObject::IllegalArgumentError();</span><br><span class="line">  CObjectArray request(message);</span><br><span class="line">	<span class="comment">// 这里的参数顺序，与Dart层的_IOService(sdk\lib\_internal\vm\bin\io_service_patch.dart)的_dispatch()中的</span></span><br><span class="line">	<span class="comment">// **servicePort**.send(&lt;dynamic&gt;[id, **_replyToPort**, request, data]);</span></span><br><span class="line">	<span class="comment">// 代码中的参数顺序一致</span></span><br><span class="line">  <span class="keyword">if</span> ((message-&gt;type == Dart_CObject_kArray) &amp;&amp; (request.Length() == <span class="number">4</span>) &amp;&amp;</span><br><span class="line">      request[<span class="number">0</span>]-&gt;IsInt32() &amp;&amp; request[<span class="number">1</span>]-&gt;IsSendPort() &amp;&amp;</span><br><span class="line">      request[<span class="number">2</span>]-&gt;IsInt32() &amp;&amp; request[<span class="number">3</span>]-&gt;IsArray()) &#123;</span><br><span class="line">    CObjectInt32 message_id(request[<span class="number">0</span>]);</span><br><span class="line">    CObjectSendPort **reply_port**(request[<span class="number">1</span>]);</span><br><span class="line">    CObjectInt32 request_id(request[<span class="number">2</span>]);</span><br><span class="line">    CObjectArray data(request[<span class="number">3</span>]);</span><br><span class="line">    **reply_port_id** = **reply_port**.Value();</span><br><span class="line">    <span class="comment">// 这里解析完收到的参数后，回去执行对应的文件操作</span></span><br><span class="line">    <span class="keyword">switch</span> (request_id.Value()) &#123;</span><br><span class="line">      **IO_SERVICE_REQUEST_LIST(CASE_REQUEST);**</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        UNREACHABLE();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  CObjectArray result(CObject::NewArray(<span class="number">2</span>));</span><br><span class="line">  result.SetAt(<span class="number">0</span>, request[<span class="number">0</span>]);</span><br><span class="line">	<span class="comment">// response在上面的IO_SERVICE_REQUEST_LIST执行完毕后就会被赋值</span></span><br><span class="line">  result.SetAt(<span class="number">1</span>, **response**);</span><br><span class="line">  ASSERT(reply_port_id != ILLEGAL_PORT);</span><br><span class="line">  **Dart_PostCObject(reply_port_id, result.AsApiCObject());**</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#define **CASE_REQUEST**(type, method, id)                                         \</span><br><span class="line">  <span class="keyword">case</span> IOService::k##type##method##Request:                                    \</span><br><span class="line">    response = type::method##Request(data);                                    \</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>IOService具体的执行是在<code>IO_SERVICE_REQUEST_LIST</code>根据解析到的参数执行对应的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\bin\io_service.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This list must be kept in sync with the list in sdk/lib/io/io_service.dart</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IO_SERVICE_REQUEST_LIST(V)                                             \</span></span><br><span class="line"><span class="meta">  V(File, Exists, 0)                                                           \</span></span><br><span class="line"><span class="meta">  V(File, Create, 1)                                                           \</span></span><br><span class="line"><span class="meta">  V(File, Delete, 2)                                                           \</span></span><br><span class="line"><span class="meta">  V(File, Rename, 3)                                                           \</span></span><br><span class="line"><span class="meta">  V(File, Copy, 4)                                                             \</span></span><br><span class="line"><span class="meta">  V(File, Open, 5)                                                             \</span></span><br><span class="line"><span class="meta">  V(File, ResolveSymbolicLinks, 6)                                             \</span></span><br><span class="line"><span class="meta">  V(File, Close, 7)                                                            \</span></span><br><span class="line"><span class="meta">  V(File, Position, 8)                                                         \</span></span><br><span class="line"><span class="meta">  V(File, SetPosition, 9)                                                      \</span></span><br><span class="line"><span class="meta">  V(File, Truncate, 10)                                                        \</span></span><br><span class="line"><span class="meta">  V(File, Length, 11)                                                          \</span></span><br><span class="line"><span class="meta">  V(File, LengthFromPath, 12)                                                  \</span></span><br><span class="line"><span class="meta">  V(File, LastAccessed, 13)                                                    \</span></span><br><span class="line"><span class="meta">  V(File, SetLastAccessed, 14)                                                 \</span></span><br><span class="line"><span class="meta">  V(File, LastModified, 15)                                                    \</span></span><br><span class="line"><span class="meta">  V(File, SetLastModified, 16)                                                 \</span></span><br><span class="line"><span class="meta">  V(File, Flush, 17)                                                           \</span></span><br><span class="line"><span class="meta">  V(File, ReadByte, 18)                                                        \</span></span><br><span class="line"><span class="meta">  V(File, WriteByte, 19)                                                       \</span></span><br><span class="line"><span class="meta">  V(File, Read, 20)                                                            \</span></span><br><span class="line"><span class="meta">  V(File, ReadInto, 21)                                                        \</span></span><br><span class="line"><span class="meta">  V(File, WriteFrom, 22)                                                       \</span></span><br><span class="line"><span class="meta">  V(File, CreateLink, 23)                                                      \</span></span><br><span class="line"><span class="meta">  V(File, DeleteLink, 24)                                                      \</span></span><br><span class="line"><span class="meta">  V(File, RenameLink, 25)                                                      \</span></span><br><span class="line"><span class="meta">  V(File, LinkTarget, 26)                                                      \</span></span><br><span class="line"><span class="meta">  V(File, Type, 27)                                                            \</span></span><br><span class="line"><span class="meta">  V(File, Identical, 28)                                                       \</span></span><br><span class="line"><span class="meta">  V(File, Stat, 29)                                                            \</span></span><br><span class="line"><span class="meta">  V(File, Lock, 30)                                                            \</span></span><br><span class="line"><span class="meta">  V(Socket, Lookup, 31)                                                        \</span></span><br><span class="line"><span class="meta">  V(Socket, ListInterfaces, 32)                                                \</span></span><br><span class="line"><span class="meta">  V(Socket, ReverseLookup, 33)                                                 \</span></span><br><span class="line"><span class="meta">  V(Directory, Create, 34)                                                     \</span></span><br><span class="line"><span class="meta">  V(Directory, Delete, 35)                                                     \</span></span><br><span class="line"><span class="meta">  V(Directory, Exists, 36)                                                     \</span></span><br><span class="line"><span class="meta">  V(Directory, CreateTemp, 37)                                                 \</span></span><br><span class="line"><span class="meta">  V(Directory, ListStart, 38)                                                  \</span></span><br><span class="line"><span class="meta">  V(Directory, ListNext, 39)                                                   \</span></span><br><span class="line"><span class="meta">  V(Directory, ListStop, 40)                                                   \</span></span><br><span class="line"><span class="meta">  V(Directory, Rename, 41)                                                     \</span></span><br><span class="line"><span class="meta">  V(SSLFilter, ProcessFilter, 42)</span></span><br></pre></td></tr></table></figure>

<p>通过上述代码，可以得知，IOService主要处理的方法有四类：</p>
<ul>
<li><code>File</code></li>
<li><code>Directory</code></li>
<li><code>Socket</code></li>
<li><code>SSLFilter</code></li>
</ul>
<p>在<code>IOServiceCallback</code>方法中，我们注意到，程序最后执行的结果是通过<code>Dart_PostCObject</code>返回的，来看一下他是怎么实现的：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\native_api_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">bool</span> PostCObjectHelper(Dart_Port port_id, Dart_CObject* message) &#123;</span><br><span class="line">  AllocOnlyStackZone zone;</span><br><span class="line">  std::unique_ptr&lt;Message&gt; msg = WriteApiMessage(</span><br><span class="line">      zone.GetZone(), message, port_id, Message::kNormalPriority);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (msg == nullptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Post the message at the given port.</span></span><br><span class="line">  <span class="keyword">return</span> **PortMap::PostMessage(std::move(msg));**</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DART_EXPORT <span class="built_in">bool</span> Dart_PostCObject(Dart_Port port_id, Dart_CObject* message) &#123;</span><br><span class="line">  <span class="keyword">return</span> PostCObjectHelper(port_id, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\port.cc</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bool</span> PortMap::PostMessage(std::unique_ptr&lt;Message&gt; message,</span><br><span class="line">                          <span class="built_in">bool</span> before_events) &#123;</span><br><span class="line">  MutexLocker ml(mutex_);</span><br><span class="line">  <span class="keyword">if</span> (ports_ == nullptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  auto it = ports_-&gt;TryLookup(message-&gt;dest_port());</span><br><span class="line">  <span class="keyword">if</span> (it == ports_-&gt;end()) &#123;</span><br><span class="line">    <span class="comment">// Ownership of external data remains with the poster.</span></span><br><span class="line">    message-&gt;DropFinalizers();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  MessageHandler* handler = (*it).handler;</span><br><span class="line">  ASSERT(handler != nullptr);</span><br><span class="line">  **handler-&gt;PostMessage(std::move(message), before_events);**</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> MessageHandler::PostMessage(std::unique_ptr&lt;Message&gt; message,</span><br><span class="line">                                 <span class="built_in">bool</span> before_events) &#123;</span><br><span class="line">  Message::Priority saved_priority;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    MonitorLocker ml(&amp;monitor_);</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">      Isolate* source_isolate = Isolate::Current();</span><br><span class="line">      <span class="keyword">if</span> (source_isolate != nullptr) &#123;</span><br><span class="line">        OS::PrintErr(</span><br><span class="line">            <span class="string">&quot;[&gt;] Posting message:\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\tlen:        %&quot;</span> Pd <span class="string">&quot;\n\tsource:     (%&quot;</span> Pd64</span><br><span class="line">            <span class="string">&quot;) %s\n\tdest:       %s\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\tdest_port:  %&quot;</span> Pd64 <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">            message-&gt;Size(), static_cast&lt;int64_t&gt;(source_isolate-&gt;main_port()),</span><br><span class="line">            source_isolate-&gt;name(), name(), message-&gt;dest_port());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        OS::PrintErr(</span><br><span class="line">            <span class="string">&quot;[&gt;] Posting message:\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\tlen:        %&quot;</span> Pd</span><br><span class="line">            <span class="string">&quot;\n\tsource:     &lt;native code&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\tdest:       %s\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\tdest_port:  %&quot;</span> Pd64 <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">            message-&gt;Size(), name(), message-&gt;dest_port());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    saved_priority = message-&gt;priority();</span><br><span class="line">		<span class="comment">// **将Message加入到MessageQueue中**</span></span><br><span class="line">    <span class="keyword">if</span> (message-&gt;IsOOB()) &#123;</span><br><span class="line">      oob_queue_-&gt;Enqueue(std::move(message), before_events);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      queue_-&gt;Enqueue(std::move(message), before_events);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (paused_for_messages_) &#123;</span><br><span class="line">      ml.Notify();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pool_ != nullptr &amp;&amp; !task_running_) &#123;</span><br><span class="line">      ASSERT(!delete_me_);</span><br><span class="line">      task_running_ = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">const</span> <span class="built_in">bool</span> launched_successfully = pool_-&gt;Run&lt;MessageHandlerTask&gt;(<span class="keyword">this</span>);</span><br><span class="line">      ASSERT(launched_successfully);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invoke any custom message notification.</span></span><br><span class="line">  MessageNotify(saved_priority);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码最后将结果包装成了Message打包进<code>MessageHandler</code>的<strong>消息队列</strong>中，这样便可以在Dart端通过消息分发接收到结果。</p>
<p><strong>Dart_NewNativePort</strong></p>
<p>再来看一下<code>Dart_NewNativePort</code>的实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\native_api_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">DART_EXPORT Dart_Port <span class="title">Dart_NewNativePort</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         Dart_NativeMessageHandler handler,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="type">bool</span> handle_concurrently)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    name = <span class="string">&quot;&lt;UnnamedNativePort&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    OS::<span class="built_in">PrintErr</span>(<span class="string">&quot;%s expects argument &#x27;handler&#x27; to be non-null.\n&quot;</span>,</span><br><span class="line">                 CURRENT_FUNC);</span><br><span class="line">    <span class="keyword">return</span> ILLEGAL_PORT;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 此方法位于sdk/runtime/vm/dart.cc</span></span><br><span class="line">  <span class="comment">// Used to Indicate that a Dart API call is active.</span></span><br><span class="line">  <span class="keyword">if</span> (!Dart::<span class="built_in">SetActiveApiCall</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> ILLEGAL_PORT;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 【注意，这里切换了isolate，退出当前isolate,直到Dart_NewNativePort执行完毕再切换回当前isolate】</span></span><br><span class="line">  <span class="comment">// Start the native port without a current isolate.</span></span><br><span class="line">  <span class="comment">//  这里的实现可以参考https://github.com/dart-lang/sdk/blob/d437877c500c77d6e08372ba2dbda9c598f5bd8e/runtime/vm/dart_api_impl.cc</span></span><br><span class="line">**<span class="function">IsolateLeaveScope <span class="title">saver</span><span class="params">(Isolate::Current())</span></span>;**</span><br><span class="line"><span class="comment">// 执行完IsolateLeaveScope 后，会切换出当前isolate直到下面的 return port_id;执行完毕，但是在此期间，下面的代码依旧是在当前isolate所在的IOThread也即系统线程下进行的</span></span><br><span class="line"></span><br><span class="line">  NativeMessageHandler* nmh = **<span class="keyword">new</span> <span class="built_in">NativeMessageHandler</span>(name, handler);**</span><br><span class="line">	<span class="comment">// 创建一个Dart_Port并且添加到PortMap中</span></span><br><span class="line">  Dart_Port port_id = **PortMap::<span class="built_in">CreatePort</span>(nmh);**</span><br><span class="line">  <span class="keyword">if</span> (port_id != ILLEGAL_PORT) &#123;</span><br><span class="line">		<span class="comment">// 激活这个端口</span></span><br><span class="line">    PortMap::<span class="built_in">SetPortState</span>(port_id, PortMap::kLivePort);</span><br><span class="line">		<span class="comment">// 在Dart线程池中执行，在这里Run()中的代码会在一个新的线程中执行</span></span><br><span class="line">    <span class="keyword">if</span> (!**nmh-&gt;Run**(**Dart::<span class="built_in">thread_pool</span>()**, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="comment">// 执行完毕之后，在之前调用本方法的环境，回调handler，关闭Dart_Port</span></span><br><span class="line">      PortMap::<span class="built_in">ClosePort</span>(port_id);</span><br><span class="line">      port_id = ILLEGAL_PORT;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Dart::<span class="built_in">ResetActiveApiCall</span>();</span><br><span class="line">  <span class="keyword">return</span> port_id;</span><br><span class="line">  <span class="comment">// 上面IsolateLeaveScope saver对象在构造方法中退出了调用方法的分支，执行到这里后saver对象被回收，执行析构函数，又将Isolate切换回来</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要的流程有：</p>
<ol>
<li>切换退出当前isolate</li>
<li>创建<code>NativeMessageHandler nmh</code>包裹要处理的回调</li>
<li>根据上面创建的<code>nmh</code>创建<code>Dart_Port port_id</code></li>
<li>执行**<code>nmh-&gt;Run()</code>**方法将<code>nmh</code>放到线程池中运行</li>
<li>当<code>nmh</code>执行完毕回调后，关闭<code>Dart_Port port_id</code></li>
</ol>
<p>也就是说，在Dart中向Native发送指令时，通过Dart的<code>_IOService._dispatch()</code>方法中执行<code>_servicePorts._getPort(id);</code>向Native层的IOService获取用于通信的<code>SendPort servicePort</code>时，会先通过Dart_NewNativePort创建一个<strong>NativeMessageHandler</strong>（会压入消息栈中），然后创建一个对应的<code>Dart_Port port_id</code>并返回给Dart用来触发消息。</p>
<p>让我们挨个分析一下：</p>
<p>1.退出当前isolate</p>
<p>见 <a target="_blank" rel="noopener" href="https://www.notion.so/IsolateLeaveScope-d62547a99c6d464bbd1bbf5baa45de18">IsolateLeaveScope</a></p>
<p>2.创建<code>NativeMessageHandler nmh</code>包裹要处理的回调</p>
<p>3.根据上面创建的<code>nmh</code>创建<code>Dart_Port port_id</code></p>
<p>看一下<code>PortMap::CreatePort</code>的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\port.cc</span></span><br><span class="line"></span><br><span class="line">Dart_Port PortMap::CreatePort(MessageHandler* handler) &#123;</span><br><span class="line">  ASSERT(handler != NULL);</span><br><span class="line">  MutexLocker ml(mutex_);</span><br><span class="line">  <span class="keyword">if</span> (ports_ == nullptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> ILLEGAL_PORT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> defined(DEBUG)</span><br><span class="line">  handler-&gt;CheckAccess();</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 不停的遍历，直到找到一个可用的port（类型为int64_t）</span></span><br><span class="line">  <span class="keyword">const</span> Dart_Port port = AllocatePort();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取到的port 只能通过isolate_entry访问</span></span><br><span class="line">  <span class="comment">// The MessageHandler::ports_ is only accessed by [PortMap], it is guarded</span></span><br><span class="line">  <span class="comment">// by the [PortMap::mutex_] we already hold.</span></span><br><span class="line">  MessageHandler::PortSetEntry isolate_entry;</span><br><span class="line">  isolate_entry.port = port;</span><br><span class="line">  handler-&gt;ports_.Insert(isolate_entry);</span><br><span class="line"></span><br><span class="line">  Entry entry;</span><br><span class="line">  entry.port = port;</span><br><span class="line">  entry.handler = handler;</span><br><span class="line">  entry.state = kNewPort;</span><br><span class="line">  ports_-&gt;Insert(entry);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">    OS::PrintErr(</span><br><span class="line">        <span class="string">&quot;[+] Opening port: \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\thandler:    %s\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\tport:       %&quot;</span> Pd64 <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        handler-&gt;name(), entry.port);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> entry.port;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Dart_Port PortMap::AllocatePort() &#123;</span><br><span class="line">  Dart_Port result;</span><br><span class="line"></span><br><span class="line">  ASSERT(mutex_-&gt;IsOwnedByCurrentThread());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep getting new values while we have an illegal port number or the port</span></span><br><span class="line">  <span class="comment">// number is already in use.</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// Ensure port ids are representable in JavaScript for the benefit of</span></span><br><span class="line">    <span class="comment">// vm-service clients such as Observatory.</span></span><br><span class="line">    <span class="keyword">const</span> Dart_Port kMask1 = <span class="number">0xFFFFFFFFFFFFF</span>;</span><br><span class="line">    <span class="comment">// Ensure port ids are never valid object pointers so that reinterpreting</span></span><br><span class="line">    <span class="comment">// an object pointer as a port id never produces a used port id.</span></span><br><span class="line">    <span class="keyword">const</span> Dart_Port kMask2 = <span class="number">0x3</span>;</span><br><span class="line">    result = (prng_-&gt;NextUInt64() &amp; kMask1) | kMask2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The two special marker ports are used for the hashset implementation and</span></span><br><span class="line">    <span class="comment">// cannot be used as actual ports.</span></span><br><span class="line">    <span class="keyword">if</span> (result == PortSet&lt;Entry&gt;::kFreePort ||</span><br><span class="line">        result == PortSet&lt;Entry&gt;::kDeletedPort) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ASSERT(!static_cast&lt;ObjectPtr&gt;(static_cast&lt;uword&gt;(result))-&gt;IsWellFormed());</span><br><span class="line">  &#125; <span class="keyword">while</span> (ports_-&gt;Contains(result));</span><br><span class="line"></span><br><span class="line">  ASSERT(result != <span class="number">0</span>);</span><br><span class="line">  ASSERT(!ports_-&gt;Contains(result));</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.执行**<code>nmh-&gt;Run()</code>**方法将<code>nmh</code>放到线程池中运行</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\message_handler.cc</span></span><br><span class="line">ThreadPool* pool_;</span><br><span class="line"><span class="built_in">bool</span> MessageHandler::Run(ThreadPool* pool,</span><br><span class="line">                         StartCallback start_callback,</span><br><span class="line">                         EndCallback end_callback,</span><br><span class="line">                         CallbackData data) &#123;</span><br><span class="line">  MonitorLocker ml(&amp;monitor_);</span><br><span class="line">  <span class="keyword">if</span> (FLAG_trace_isolates) &#123;</span><br><span class="line">    OS::PrintErr(</span><br><span class="line">        <span class="string">&quot;[+] Starting message handler:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\thandler:    %s\n&quot;</span>,</span><br><span class="line">        name());</span><br><span class="line">  &#125;</span><br><span class="line">  ASSERT(pool_ == NULL);</span><br><span class="line">  ASSERT(!delete_me_);</span><br><span class="line">  pool_ = pool;</span><br><span class="line">  start_callback_ = start_callback;</span><br><span class="line">  end_callback_ = end_callback;</span><br><span class="line">  callback_data_ = data;</span><br><span class="line">  task_running_ = <span class="keyword">true</span>;</span><br><span class="line">	<span class="comment">// 在Dart VM Thread的线程池中执行MessageHandler,会是一个新的线程</span></span><br><span class="line">  <span class="built_in">bool</span> result = pool_-&gt;Run&lt;MessageHandlerTask&gt;(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">    pool_ = nullptr;</span><br><span class="line">    start_callback_ = nullptr;</span><br><span class="line">    end_callback_ = nullptr;</span><br><span class="line">    callback_data_ = <span class="number">0</span>;</span><br><span class="line">    task_running_ = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会在“线程池”运行的时候执行对应的MessageHandler回调</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageHandlerTask</span> : <span class="title">public</span> <span class="title">ThreadPool</span>::<span class="title">Task</span> </span>&#123;</span><br><span class="line"> public:</span><br><span class="line">  explicit MessageHandlerTask(MessageHandler* handler) : handler_(handler) &#123;</span><br><span class="line">    ASSERT(handler != NULL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="keyword">void</span> Run() &#123;</span><br><span class="line">    ASSERT(handler_ != NULL);</span><br><span class="line">		<span class="comment">// 执行具体的逻辑</span></span><br><span class="line">    handler_-&gt;TaskCallback();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  MessageHandler* handler_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(MessageHandlerTask);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\include\dart_api.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A port is used to send or receive inter-isolate messages</span></span><br><span class="line"><span class="keyword">typedef</span> int64_t Dart_Port;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Runs a task on the thread pool.</span></span><br><span class="line">  template &lt;typename T, typename... Args&gt;</span><br><span class="line">  <span class="built_in">bool</span> Run(Args&amp;&amp;... args) &#123;</span><br><span class="line">    <span class="keyword">return</span> RunImpl(std::unique_ptr&lt;Task&gt;(<span class="keyword">new</span> T(std::forward&lt;Args&gt;(args)...)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"><span class="built_in">bool</span> ThreadPool::RunImpl(std::unique_ptr&lt;Task&gt; task) &#123;</span><br><span class="line">  Worker* new_worker = nullptr;</span><br><span class="line">  &#123;</span><br><span class="line">    MonitorLocker ml(&amp;pool_monitor_);</span><br><span class="line">    <span class="keyword">if</span> (shutting_down_) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 创建新的Worker</span></span><br><span class="line">    new_worker = ScheduleTaskLocked(&amp;ml, std::move(task));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (new_worker != nullptr) &#123;</span><br><span class="line">		<span class="comment">// 在线程中执行task</span></span><br><span class="line">    new_worker-&gt;StartThread();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个Worker</span></span><br><span class="line">ThreadPool::Worker* ThreadPool::ScheduleTaskLocked(MonitorLocker* ml,</span><br><span class="line">                                                   std::unique_ptr&lt;Task&gt; task) &#123;</span><br><span class="line">  <span class="comment">// Enqueue the new task.</span></span><br><span class="line">  tasks_.Append(task.release());</span><br><span class="line">  pending_tasks_++;</span><br><span class="line">  ASSERT(pending_tasks_ &gt;= <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify existing idle worker (if available).</span></span><br><span class="line">  <span class="keyword">if</span> (count_idle_ &gt;= pending_tasks_) &#123;</span><br><span class="line">    ASSERT(!idle_workers_.IsEmpty());</span><br><span class="line">    ml-&gt;Notify();</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have maxed out the number of threads running, we will not start a</span></span><br><span class="line">  <span class="comment">// new one.</span></span><br><span class="line">  <span class="keyword">if</span> (max_pool_size_ &gt; <span class="number">0</span> &amp;&amp; (count_idle_ + count_running_) &gt;= max_pool_size_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!idle_workers_.IsEmpty()) &#123;</span><br><span class="line">      ml-&gt;Notify();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Otherwise start a new worker.</span></span><br><span class="line">  auto new_worker = <span class="keyword">new</span> Worker(<span class="keyword">this</span>);</span><br><span class="line">  idle_workers_.Append(new_worker);</span><br><span class="line">  count_idle_++;</span><br><span class="line">  <span class="keyword">return</span> new_worker;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新建的Woker和ThreadPool绑定</span></span><br><span class="line">ThreadPool::Worker::Worker(ThreadPool* pool)</span><br><span class="line">    : pool_(pool), join_id_(OSThread::kInvalidThreadJoinId) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// new_worker-&gt;StartThread();会调用下面的方法</span></span><br><span class="line"><span class="keyword">void</span> ThreadPool::Worker::StartThread() &#123;</span><br><span class="line">  <span class="built_in">int</span> result = OSThread::Start(<span class="string">&quot;DartWorker&quot;</span>, &amp;Worker::Main,</span><br><span class="line">                               reinterpret_cast&lt;uword&gt;(<span class="keyword">this</span>));</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">    FATAL1(<span class="string">&quot;Could not start worker thread: result = %d.&quot;</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OSThread::Start每个端不一样，我们选择Android端的实现</span></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\os_thread_android.cc</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> OSThread::Start(<span class="keyword">const</span> char* name,</span><br><span class="line">                    ThreadStartFunction function,</span><br><span class="line">                    uword parameter) &#123;</span><br><span class="line">  pthread_attr_t attr;</span><br><span class="line">  <span class="built_in">int</span> result = pthread_attr_init(&amp;attr);</span><br><span class="line">  RETURN_ON_PTHREAD_FAILURE(result);</span><br><span class="line"></span><br><span class="line">  result = pthread_attr_setstacksize(&amp;attr, OSThread::GetMaxStackSize());</span><br><span class="line">  RETURN_ON_PTHREAD_FAILURE(result);</span><br><span class="line"></span><br><span class="line">  ThreadStartData* data = <span class="keyword">new</span> ThreadStartData(name, function, parameter);</span><br><span class="line">	<span class="comment">// 声明系统线程类型</span></span><br><span class="line">  pthread_t tid;</span><br><span class="line">	<span class="comment">// 调用系统创建线程的函数 https://blog.csdn.net/liangxanhai/article/details/7767430</span></span><br><span class="line">	<span class="comment">// pthread_create参数含义：1. &amp;tid 指向线程的指针，2. &amp;attr 新建线程的属性 3. ThreadStart线程要执行的方法指针 4. data传给参数ThreadStart的参数</span></span><br><span class="line">  <span class="comment">// 成功执行线程则返回0</span></span><br><span class="line">  result = pthread_create(&amp;tid, &amp;attr, ThreadStart, data);</span><br><span class="line">  RETURN_ON_PTHREAD_FAILURE(result);</span><br><span class="line"></span><br><span class="line">  result = pthread_attr_destroy(&amp;attr);</span><br><span class="line">  RETURN_ON_PTHREAD_FAILURE(result);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dispatch to the thread start function provided by the caller. This trampoline</span></span><br><span class="line"><span class="comment">// is used to ensure that the thread is properly destroyed if the thread just</span></span><br><span class="line"><span class="comment">// exits.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span>* ThreadStart(<span class="keyword">void</span>* data_ptr) &#123;</span><br><span class="line">  <span class="keyword">if</span> (FLAG_worker_thread_priority != kMinInt) &#123;</span><br><span class="line">    <span class="keyword">if</span> (setpriority(PRIO_PROCESS, gettid(), FLAG_worker_thread_priority) ==</span><br><span class="line">        <span class="number">-1</span>) &#123;</span><br><span class="line">      FATAL2(<span class="string">&quot;Setting thread priority to %d failed: errno = %d\n&quot;</span>,</span><br><span class="line">             FLAG_worker_thread_priority, errno);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ThreadStartData* data = reinterpret_cast&lt;ThreadStartData*&gt;(data_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> char* name = data-&gt;name();</span><br><span class="line">  OSThread::ThreadStartFunction function = data-&gt;function();</span><br><span class="line">  uword parameter = data-&gt;parameter();</span><br><span class="line">  delete data;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the thread name. There is 16 bytes limit on the name (including \0).</span></span><br><span class="line">  <span class="comment">// pthread_setname_np ignores names that are too long rather than truncating.</span></span><br><span class="line">  char truncated_name[<span class="number">16</span>];</span><br><span class="line">  snprintf(truncated_name, ARRAY_SIZE(truncated_name), <span class="string">&quot;%s&quot;</span>, name);</span><br><span class="line">  pthread_setname_np(pthread_self(), truncated_name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个系统线程的包装类OSThread和新建的系统线程绑定</span></span><br><span class="line">  <span class="comment">// Create new OSThread object and set as TLS for new thread.</span></span><br><span class="line">  OSThread* thread = OSThread::CreateOSThread();</span><br><span class="line">  <span class="keyword">if</span> (thread != NULL) &#123;</span><br><span class="line">		<span class="comment">// 将线程切换到新创建的系统线程</span></span><br><span class="line">    OSThread::SetCurrent(thread);</span><br><span class="line">    thread-&gt;set_name(name);</span><br><span class="line">    UnblockSIGPROF();</span><br><span class="line">    <span class="comment">// Call the supplied thread start function handing it its parameters.</span></span><br><span class="line">		<span class="comment">// 执行创建ThreadStartData时传入的方法，也就是ThreadPool::Worker::Main(uword args)</span></span><br><span class="line">    function(parameter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">OSThread* OSThread::CreateOSThread() &#123;</span><br><span class="line">  ASSERT(thread_list_lock_ != NULL);</span><br><span class="line">  MutexLocker ml(thread_list_lock_);</span><br><span class="line">  <span class="keyword">if</span> (!creation_enabled_) &#123;</span><br><span class="line">    <span class="keyword">return</span> NULL;</span><br><span class="line">  &#125;</span><br><span class="line">  OSThread* os_thread = <span class="keyword">new</span> OSThread();</span><br><span class="line">  AddThreadToListLocked(os_thread);</span><br><span class="line">  <span class="keyword">return</span> os_thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在创建了新的系统线程后，会执行下面的方法：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\thread_pool.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ThreadPool::Worker::Main(uword args) &#123;</span><br><span class="line">  <span class="comment">// Call the thread start hook here to notify the embedder that the</span></span><br><span class="line">  <span class="comment">// thread pool thread has started.</span></span><br><span class="line">  Dart_ThreadStartCallback start_cb = Dart::thread_start_callback();</span><br><span class="line">  <span class="keyword">if</span> (start_cb != nullptr) &#123;</span><br><span class="line">    start_cb();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  OSThread* os_thread = OSThread::Current();</span><br><span class="line">  ASSERT(os_thread != nullptr);</span><br><span class="line"></span><br><span class="line">  Worker* worker = reinterpret_cast&lt;Worker*&gt;(args);</span><br><span class="line">  ThreadPool* pool = worker-&gt;pool_;</span><br><span class="line">	<span class="comment">// 将Worker和系统线程绑定</span></span><br><span class="line">  os_thread-&gt;owning_thread_pool_worker_ = worker;</span><br><span class="line">  worker-&gt;os_thread_ = os_thread;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Once the worker quits it needs to be joined.</span></span><br><span class="line">  worker-&gt;join_id_ = OSThread::GetCurrentThreadJoinId(os_thread);</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> defined(DEBUG)</span><br><span class="line">  &#123;</span><br><span class="line">    MonitorLocker ml(&amp;pool-&gt;pool_monitor_);</span><br><span class="line">    ASSERT(pool-&gt;idle_workers_.ContainsForDebugging(worker));</span><br><span class="line">  &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  pool-&gt;WorkerLoop(worker);</span><br><span class="line"></span><br><span class="line">  worker-&gt;os_thread_ = nullptr;</span><br><span class="line">  os_thread-&gt;owning_thread_pool_worker_ = nullptr;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the thread exit hook here to notify the embedder that the</span></span><br><span class="line">  <span class="comment">// thread pool thread is exiting.</span></span><br><span class="line">  Dart_ThreadExitCallback exit_cb = Dart::thread_exit_callback();</span><br><span class="line">  <span class="keyword">if</span> (exit_cb != nullptr) &#123;</span><br><span class="line">    exit_cb();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\os_thread.h</span></span><br><span class="line"><span class="comment">// OSThread</span></span><br><span class="line"><span class="comment">// The ThreadPool::Worker which owns this OSThread. If this OSThread was not</span></span><br><span class="line">  <span class="comment">// started by a ThreadPool it will be nullptr. This TLS value is not</span></span><br><span class="line">  <span class="comment">// protected and should only be read/written by the OSThread itself.</span></span><br><span class="line">  <span class="keyword">void</span>* owning_thread_pool_worker_ = nullptr;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// thread_list_lock_ cannot have a static lifetime because the order in which</span></span><br><span class="line">  <span class="comment">// destructors run is undefined. At the moment this lock cannot be deleted</span></span><br><span class="line">  <span class="comment">// either since otherwise, if a thread only begins to run after we have</span></span><br><span class="line">  <span class="comment">// started to run TLS destructors for a call to exit(), there will be a race</span></span><br><span class="line">  <span class="comment">// on its deletion in CreateOSThread().</span></span><br><span class="line">  <span class="keyword">static</span> Mutex* thread_list_lock_;</span><br></pre></td></tr></table></figure>

<h3 id="Dart-NewSendPort"><a href="#Dart-NewSendPort" class="headerlink" title="Dart_NewSendPort"></a>Dart_NewSendPort</h3><p>看一下<code>Dart_NewSendPort</code>如何将创建好的<code>Dart_Port service_port</code>转变为Dart的<code>SendPort</code>的：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -&gt; runtime\vm\dart_api_impl.cc</span></span><br><span class="line"></span><br><span class="line">DART_EXPORT Dart_Handle Dart_NewSendPort(Dart_Port port_id) &#123;</span><br><span class="line">  DARTSCOPE(Thread::Current());</span><br><span class="line">  CHECK_CALLBACK_STATE(T);</span><br><span class="line">  <span class="keyword">if</span> (port_id == ILLEGAL_PORT) &#123;</span><br><span class="line">    <span class="keyword">return</span> Api::NewError(<span class="string">&quot;%s: illegal port_id %&quot;</span> Pd64 <span class="string">&quot;.&quot;</span>, CURRENT_FUNC,</span><br><span class="line">                         port_id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Api::NewHandle(T, SendPort::New(port_id));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; runtime\vm\object.cc</span></span><br><span class="line"></span><br><span class="line">SendPortPtr SendPort::New(Dart_Port id, Heap::Space space) &#123;</span><br><span class="line">  <span class="keyword">return</span> New(id, Isolate::Current()-&gt;origin_id(), space);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SendPortPtr SendPort::New(Dart_Port id,</span><br><span class="line">                          Dart_Port origin_id,</span><br><span class="line">                          Heap::Space space) &#123;</span><br><span class="line">  ASSERT(id != ILLEGAL_PORT);</span><br><span class="line">	<span class="comment">// 创建新的SendPort并将Dart_Port id和当前的isolate id与之绑定</span></span><br><span class="line">  SendPort&amp; result = SendPort::Handle();</span><br><span class="line">  &#123;</span><br><span class="line">    ObjectPtr raw =</span><br><span class="line">        <span class="built_in">Object</span>::Allocate(SendPort::kClassId, SendPort::InstanceSize(), space,</span><br><span class="line">                         SendPort::ContainsCompressedPointers());</span><br><span class="line">    NoSafepointScope no_safepoint;</span><br><span class="line">    result ^= raw;</span><br><span class="line">    result.StoreNonPointer(&amp;result.untag()-&gt;id_, id);</span><br><span class="line">    result.StoreNonPointer(&amp;result.untag()-&gt;origin_id_, origin_id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.ptr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里我们发现，<code>Dart_NewNativePort</code>将要处理的事件<code>handler</code>封装起来，最后在<strong>非当前isolate</strong>的线程中执行。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>从上面的分析中，我们可以知道，在Dart中通过File进行文件操作，其实是通过Dart中的_IOService进行消息中转，将用户的IO指令发送到Native层的IOService中；</p>
<p>IOService通过一些列操作，得到一个<code>SendPort servicePort</code>，与此同时对应的IO操作已经压入消息栈中等待触发在单独的线程中执行；</p>
<p>之后在_IOService中<code>servicePort</code>将用户需要的IO操作和与自己通信的<code>_replyToPort = _receivePort!.sendPort;</code> 通过<code>send</code>方法触发<code>IOServiceCallback</code>执行对应的IO操作，并且在最后调用<code>Dart_PostCObject</code>方法将结果压入消息栈中，这会触发Dart层_IOService的_receivePort!.handler回调事件，然后根据事件失败或者成功，使用Completer通过Event loop一步步将事件上报，最终回调用户需要的命令。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/eieihihi/article/details/119601010">09、Flutter FFI Dart Native API_又吹风_Bassy的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="http://w4lle.com/2021/04/12/kidea-flutter/index.html">快手-开眼快创 Flutter 实践 | w4lle’s Notes</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>JI, XIAOYONG
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jixiaoyong.github.io/blog/posts/3db5282/" title="Dart 读取文件过程分析">https://jixiaoyong.github.io/blog/posts/3db5282/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/posts/550e5790/" rel="prev" title="Dart VM">
                  <i class="fa fa-chevron-left"></i> Dart VM
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/posts/db62c118/" rel="next" title="Dart event loop">
                  Dart event loop <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JI, XIAOYONG</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/schemes/muse.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>





  




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://vercel.xiaoyong.ml","cssUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.css","commentCount":true,"pageview":true,"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.js","locale":{"placeholder":"ヾ(=^▽^=)ノ"},"meta":["nick","mail","link"],"login":"enable","pageSize":10,"el":"#waline","comment":true,"path":"/blog/posts/3db5282/"}</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
