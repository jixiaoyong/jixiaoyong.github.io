<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/https/jixiaoyong.github.io/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon.ico">
  <link rel="mask-icon" href="/blog/https/jixiaoyong.github.io/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jixiaoyong.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":true,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="Flutter 默认提供了Image用于从网络、文件等加载图片，并且使用ImageCache统一管理图片缓存，但有时候并不能满足使用需求（比如网络图片没有磁盘缓存，导致每次 ImageCache 清除缓存之后又要从网络下载），所以又出现了flutter_cached_network_image、extended_image等基于 Flutter 原生的解决方案，以及power_image等基于混合">
<meta property="og:type" content="article">
<meta property="og:title" content="Flutter图片加载方案分析之power_image">
<meta property="og:url" content="https://jixiaoyong.github.io/blog/posts/727d7800/index.html">
<meta property="og:site_name" content="Ji Xiaoyong&#39;s Blog">
<meta property="og:description" content="Flutter 默认提供了Image用于从网络、文件等加载图片，并且使用ImageCache统一管理图片缓存，但有时候并不能满足使用需求（比如网络图片没有磁盘缓存，导致每次 ImageCache 清除缓存之后又要从网络下载），所以又出现了flutter_cached_network_image、extended_image等基于 Flutter 原生的解决方案，以及power_image等基于混合">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jixiaoyong.github.io/images/flutter/power_image_class_structure.png">
<meta property="og:image" content="https://jixiaoyong.github.io/images/flutter/power_image_structure.png">
<meta property="article:published_time" content="2022-08-02T07:54:39.000Z">
<meta property="article:modified_time" content="2022-11-26T09:33:39.170Z">
<meta property="article:author" content="JI, XIAOYONG">
<meta property="article:tag" content="flutter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jixiaoyong.github.io/images/flutter/power_image_class_structure.png">


<link rel="canonical" href="https://jixiaoyong.github.io/blog/posts/727d7800/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jixiaoyong.github.io/blog/posts/727d7800/","path":"posts/727d7800/","title":"Flutter图片加载方案分析之power_image"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Flutter图片加载方案分析之power_image | Ji Xiaoyong's Blog</title>
  





<link rel="dns-prefetch" href="https://vercel.xiaoyong.ml">
  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ji Xiaoyong's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#power-image"><span class="nav-text">power_image</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Flutter-%E7%AB%AF%E5%9B%BE%E7%89%87%E5%B1%95%E7%A4%BA"><span class="nav-text">Flutter 端图片展示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PowerImage"><span class="nav-text">PowerImage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PowerImageState"><span class="nav-text">PowerImageState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PowerTextureImage"><span class="nav-text">PowerTextureImage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PowerExternalImage"><span class="nav-text">PowerExternalImage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PowerImageProvider"><span class="nav-text">PowerImageProvider</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loadAsync"><span class="nav-text">_loadAsync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PowerTextureImageProvider"><span class="nav-text">PowerTextureImageProvider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PowerExternalImageProvider"><span class="nav-text">PowerExternalImageProvider</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Flutter-x2F-Native-%E9%80%9A%E4%BF%A1"><span class="nav-text">Flutter&#x2F;Native 通信</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Native-%E7%AB%AF%E5%9B%BE%E7%89%87%E8%8E%B7%E5%8F%96"><span class="nav-text">Native 端图片获取</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JI, XIAOYONG"
      src="//jixiaoyong.github.io/images/default_avatar.jpg">
  <p class="site-author-name" itemprop="name">JI, XIAOYONG</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jixiaoyong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jixiaoyong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jixiaoyong1995@gmail.com" title="E-Mail → mailto:jixiaoyong1995@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jixiaoyong.github.io/blog/posts/727d7800/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//jixiaoyong.github.io/images/default_avatar.jpg">
      <meta itemprop="name" content="JI, XIAOYONG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ji Xiaoyong's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Flutter图片加载方案分析之power_image | Ji Xiaoyong's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Flutter图片加载方案分析之power_image<a href="https://github.com/jixiaoyong/blog_source_code/edit/master/blog/source/_posts/Flutter%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD%E6%96%B9%E6%A1%88%E5%88%86%E6%9E%90%E4%B9%8Bpower_image.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-08-02 15:54:39" itemprop="dateCreated datePublished" datetime="2022-08-02T15:54:39+08:00">2022-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-26 17:33:39" itemprop="dateModified" datetime="2022-11-26T17:33:39+08:00">2022-11-26</time>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/blog/posts/727d7800/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/blog/posts/727d7800/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/blog/posts/727d7800/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>Flutter 默认提供了<strong>Image</strong>用于从网络、文件等加载图片，并且使用<strong>ImageCache</strong>统一管理图片缓存，但有时候并不能满足使用需求（比如网络图片没有磁盘缓存，导致每次 ImageCache 清除缓存之后又要从网络下载），所以又出现了<a target="_blank" rel="noopener" href="https://github.com/Baseflow/flutter_cached_network_image">flutter_cached_network_image</a>、<a target="_blank" rel="noopener" href="https://github.com/fluttercandies/extended_image">extended_image</a>等基于 Flutter 原生的解决方案，以及<a target="_blank" rel="noopener" href="https://github.com/alibaba/power_image">power_image</a>等基于混合开发的解决方案。</p>
<p>本文对 Alibaba 中的 power_image 加载过程、原理做一简单分析。</p>
<h1 id="power-image"><a href="#power-image" class="headerlink" title="power_image"></a>power_image</h1><p><em>power_image</em>是阿里巴巴出品的 Flutter 混合开发图片加载库，通过<em>texture</em>和<em>ffi</em>技术借助原生图片加载库加载图片、Flutter 端展示图片。</p>
<p>无论是 Flutter <a href="https://jixiaoyong.github.io/blog/posts/1912667a/">Image</a> 组件，还是第三方的<a href="https://jixiaoyong.github.io/blog/posts/23ac516a/"><em>extende_image</em></a>、<em>flutter_cached_nework_image</em>都是在 Flutter 端加载解析图片，这些方案对一般纯 Flutter 开发的 APP 来说基本可以满足要求，但是对于大多数混合开发的 APP 来说，这些方案会在 Flutter 和 Native 同时存在两份图片资源造成内存浪费，此外根据<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yUm4UFggYLgDbj4_JCjEdg#at">贝壳的分析</a>，Flutter 端解决方案存在图片内存释放时机（Flutter 引擎持有的 SkImage 释放时机）以及超大图内存峰值等问题。</p>
<p>而<em>power_image</em>能够较好的解决上述问题，其整体架构如下：</p>
<p>类结构图:<br><img src="https://jixiaoyong.github.io/images/flutter/power_image_class_structure.png" alt="类结构图"></p>
<p>架构图:<br><img src="https://jixiaoyong.github.io/images/flutter/power_image_structure.png" alt="架构图"></p>
<p><em>power_image</em>可以大体划分为<strong>Flutter 端图片展示</strong>和<strong>Native 图片加载</strong>两部分，下面分别分析。</p>
<h1 id="Flutter-端图片展示"><a href="#Flutter-端图片展示" class="headerlink" title="Flutter 端图片展示"></a>Flutter 端图片展示</h1><h2 id="PowerImage"><a href="#PowerImage" class="headerlink" title="PowerImage"></a>PowerImage</h2><p><code>PowerImage</code>继承自<em>StatefulWidget</em>，提供多种创建方式：既可以使用预设的<code>PowerImage.network</code>、<code>PowerImage.file</code>等构造函数从网络、文件等获取图片；也可以使用<code>PowerImage.type</code>、<code>PowerImage.options</code>等自定义通道获取图片并展示；或者使用<code>PowerImage()</code>完全自定义。</p>
<p>除了<code>PowerImage()</code>构造函数之外，上述其余构造函数都根据传入的<code>String? renderingType</code>指定了 PowerImage 特定的<code>PowerImageProvider image</code>属性（是<em>ffi</em>还是<em>texture</em>）用于获取图片。</p>
<h2 id="PowerImageState"><a href="#PowerImageState" class="headerlink" title="PowerImageState"></a>PowerImageState</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerImageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PowerImage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line"></span><br><span class="line">    ImageErrorWidgetBuilder? errorWidgetBuilder = widget.errorBuilder;</span><br><span class="line">    errorWidgetBuilder ??= (...) &#123;</span><br><span class="line">      <span class="keyword">return</span> SizedBox(...);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (widget.image.runtimeType == PowerTextureImageProvider) &#123;</span><br><span class="line">      <span class="keyword">return</span> PowerTextureImage(</span><br><span class="line">        provider: widget.image <span class="keyword">as</span> PowerTextureImageProvider,</span><br><span class="line">        ...);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widget.image.runtimeType == PowerExternalImageProvider) &#123;</span><br><span class="line">      <span class="keyword">return</span> PowerExternalImage(</span><br><span class="line">        provider: widget.image <span class="keyword">as</span> PowerExternalImageProvider,</span><br><span class="line">        ...</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ImageExt(</span><br><span class="line">      image: widget.image,</span><br><span class="line">      imageBuilder: widget.imageBuilder,</span><br><span class="line">      ...</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 PowerImageState 的<code>build()</code>方法中，根据不同的<code>PowerImageProvider image</code>类型会返回不同的 Widget：</p>
<ul>
<li><code>image</code>是 <strong><em>PowerTextureImageProvider</em></strong> 类型：采用 <em>texture</em> 模式展示图片，返回**<em>PowerTextureImage</em><strong>，最终会返回经过封装的</strong><em>Texture</em>**对象。</li>
<li><code>image</code>是**<em>PowerExternalImageProvider</em><strong>类型：采用 <em>ffi</em> 模式展示图片，返回</strong><em>PowerExternalImage</em><strong>，最终返回的是</strong><em>RawImage</em>**对象，和使用 Flutter Image 展示图片的流程一致。</li>
<li>其他类型，按照自定义的规则展示。</li>
</ul>
<p>让我们来分别看一下**<em>PowerTextureImage</em><strong>和</strong><em>PowerExternalImage</em>**的实现：</p>
<h2 id="PowerTextureImage"><a href="#PowerTextureImage" class="headerlink" title="PowerTextureImage"></a>PowerTextureImage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerTextureImage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> PowerTextureImage(&#123;...&#125;):<span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> PowerTextureImageProvider provider;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  PowerTextureState createState() &#123;</span><br><span class="line">    <span class="keyword">return</span> PowerTextureState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerTextureState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PowerTextureImage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ImageExt(</span><br><span class="line">      <span class="comment">// 这里的provider实际上创建的是一个虚假的ui.Image? dummy</span></span><br><span class="line">      image: widget.provider,</span><br><span class="line">      frameBuilder: widget.frameBuilder,</span><br><span class="line">      errorBuilder: widget.errorBuilder,</span><br><span class="line">      width: widget.width,</span><br><span class="line">      height: widget.height,</span><br><span class="line">      fit: widget.fit,</span><br><span class="line">      alignment: widget.alignment,</span><br><span class="line">      <span class="comment">// 注意，这里会创建一个封装的Texture，真正展示图片内容</span></span><br><span class="line">      imageBuilder: buildImage,</span><br><span class="line">      semanticLabel: widget.semanticLabel,</span><br><span class="line">      excludeFromSemantics: widget.excludeFromSemantics,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget buildImage(BuildContext context, ImageInfo? imageInfo) &#123;</span><br><span class="line">    <span class="keyword">if</span> (imageInfo == <span class="keyword">null</span> || imageInfo <span class="keyword">is</span>! PowerTextureImageInfo) &#123;</span><br><span class="line">      <span class="keyword">return</span> SizedBox(</span><br><span class="line">        width: widget.width,</span><br><span class="line">        height: widget.height,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PowerTextureImageInfo textureImageInfo = imageInfo;</span><br><span class="line">    <span class="keyword">return</span> ClipRect(</span><br><span class="line">      child: SizedBox(</span><br><span class="line">        child: FittedBox(</span><br><span class="line">          fit: widget.fit ?? BoxFit.contain,</span><br><span class="line">          alignment: widget.alignment,</span><br><span class="line">          child: SizedBox(</span><br><span class="line">            width: textureImageInfo.width?.toDouble() ?? widget.width,</span><br><span class="line">            height: textureImageInfo.height?.toDouble() ?? widget.height,</span><br><span class="line">            child: Texture(</span><br><span class="line">              <span class="comment">// 注意，这里的textureId是从provider创建的ImageInfo中获取的</span></span><br><span class="line">              textureId: textureImageInfo.textureId!,</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        width: widget.width,</span><br><span class="line">        height: widget.height,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PowerExternalImage"><a href="#PowerExternalImage" class="headerlink" title="PowerExternalImage"></a>PowerExternalImage</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerExternalImage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> PowerExternalImage(&#123;...&#125;):<span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> PowerExternalImageProvider provider;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  PowerExteralState createState() =&gt; PowerExteralState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerExteralState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PowerExternalImage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ImageExt(</span><br><span class="line">      frameBuilder: widget.frameBuilder,</span><br><span class="line">      errorBuilder: widget.errorBuilder,</span><br><span class="line">      <span class="comment">// provider会根据Native数据创建含有对应的ui.Image的</span></span><br><span class="line">      <span class="comment">// ImageInfo，展示对应图片</span></span><br><span class="line">      image: widget.provider,</span><br><span class="line">      width: widget.width,</span><br><span class="line">      height: widget.height,</span><br><span class="line">      fit: widget.fit,</span><br><span class="line">      alignment: widget.alignment,</span><br><span class="line">      semanticLabel: widget.semanticLabel,</span><br><span class="line">      excludeFromSemantics: widget.excludeFromSemantics,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过对比**<em>PowerTextureImage</em><strong>和</strong><em>PowerExternalImage</em>**的源码可以发现，二者最终还是创建了 ImageExt 对象，只不过 PowerTextureImage 中 ImageExt.imageBuilder 返回了 Texture，而 PowerExternalImage 中 ImageExt.imageBuilder 为 null。</p>
<p>再根据下面的<code>_ImageExtState.build</code>源码可以确定，当使用 PowerTextureImage 时 PowerImage 创建的是封装了的 <strong>Texture</strong>，而 PowerExternalImage 时则会使用 PowerExternalImageProvider 创建的 ImageInfo 创建 <strong>RawImage</strong>，这实际上与 Flutter 原有的 Image 组件一致。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _ImageExtState.build</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Widget result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (widget.imageBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">      result = widget.imageBuilder!(context, _imageInfo);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = RawImage(</span><br><span class="line">        image: _imageInfo?.image,</span><br><span class="line">        ...</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的分析，可以知道，**<em>PowerImage</em><strong>使用从</strong><em>PowerImageProvider</em>** 获取的 <strong><em>ImageInfo</em></strong> 来展示图片，采用**<em>texture</em>**方案时，使用 ImageInfo 中的 textureId 并返回 Texture 对象展示图片；而使用 <strong><em>ffi</em></strong> 方案时，会使用 ImageInfo 中的<code>ui.Image image</code>对象传入 RawIamge 展示图片（这部分与 Flutter Image 组件逻辑一致）。</p>
<br/>

<h2 id="PowerImageProvider"><a href="#PowerImageProvider" class="headerlink" title="PowerImageProvider"></a>PowerImageProvider</h2><p>PowerImageProvider 继承自<em>ImageProviderExt</em> -&gt; _ImageProvider_，是<em>power_image</em>的关键类之一，主要实现通过 Flutter&#x2F;Native 跨端通信从 Native 获取&#x2F;释放图片资源等，创建供ImageExt使用的ImageInfo。</p>
<p>相对于 Flutter 官方的 ImageProvider，除了修改部分类为 power_image 对应的类之外，PowerImageProvider主要有以下几点改变：</p>
<ul>
<li>工厂方法<code>PowerImageProvider.options</code>生产PowerImageProvider：根据传入的PowerImageRequestOptions中<code>PowerImageRequestOptions.renderingType</code>的值，分别创建对应的<em><strong>PowerExternalImageProvider</strong></em>或者<em><strong>PowerTextureImageProvider</strong></em>。</li>
<li>重写<code>_loadAsync</code>方法，调用 Native 图片库加载图片，并根据返回值调用子类 <code>createImageInfo</code> 方法创建 PowerImageInfo。</li>
</ul>
<h3 id="loadAsync"><a href="#loadAsync" class="headerlink" title="_loadAsync"></a>_loadAsync</h3><p>通过重写<code>_loadAsync</code>方法，PowerImageProvider 实现了不同的子类分别创建 PowerImageInfo 展示图片、统一让 ImageCache 管理图片。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;ImageInfo&gt; _loadAsync(</span><br><span class="line">      PowerImageProvider key, DecoderCallback? decode) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 跨端通信获取图片资源，后面再详细分析</span></span><br><span class="line">      PowerImageCompleter powerImageCompleter =</span><br><span class="line">          PowerImageLoader.instance.loadImage(options);</span><br><span class="line">      <span class="built_in">Map</span> map = <span class="keyword">await</span> powerImageCompleter.completer!.future;</span><br><span class="line">      <span class="built_in">bool?</span> success = map[<span class="string">&#x27;success&#x27;</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// remove multiFrame image cache On Last Listener Removed</span></span><br><span class="line">      <span class="built_in">bool?</span> isMultiFrame = map[<span class="string">&#x27;_multiFrame&#x27;</span>];</span><br><span class="line">      <span class="keyword">if</span> (isMultiFrame == <span class="keyword">true</span>) &#123;</span><br><span class="line">        _completer!</span><br><span class="line">          .addOnLastListenerRemovedCallback(() &#123;</span><br><span class="line">            scheduleMicrotask(() &#123;</span><br><span class="line">              PaintingBinding.instance!.imageCache!.evict(key);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      _completer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (success != <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// The network may be only temporarily unavailable, or the file will be</span></span><br><span class="line">        <span class="comment">// added on the server later. Avoid having future calls to resolve</span></span><br><span class="line">        <span class="comment">// fail to check the network again.</span></span><br><span class="line">        <span class="keyword">final</span> PowerImageLoadException exception =</span><br><span class="line">            PowerImageLoadException(nativeResult: map);</span><br><span class="line">        PowerImageMonitor.instance().anErrorOccurred(exception);</span><br><span class="line">        <span class="keyword">throw</span> exception;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 创建ImageInfo</span></span><br><span class="line">      <span class="keyword">return</span> createImageInfo(map);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// Depending on where the exception was thrown, the image cache may not</span></span><br><span class="line">      <span class="comment">// have had a chance to track the key in the cache at all.</span></span><br><span class="line">      <span class="comment">// Schedule a microtask to give the cache a chance to add the key.</span></span><br><span class="line">      scheduleMicrotask(() &#123;</span><br><span class="line">        PaintingBinding.instance!.imageCache!.evict(key);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">rethrow</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// chunkEvents.close();</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的分析中，我们得知，<em>texture</em>和<em>ffi</em>方案分别使用 ImageProvider 提供的 PowerImageInfo 中的<code>int? textureId</code>和<code>ui.Image image</code>展示图片，让我们分别看一下他们是如何获取的：</p>
<h3 id="PowerTextureImageProvider"><a href="#PowerTextureImageProvider" class="headerlink" title="PowerTextureImageProvider"></a>PowerTextureImageProvider</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerTextureImageProvider</span> <span class="keyword">extends</span> <span class="title">PowerImageProvider</span> </span>&#123;</span><br><span class="line">  PowerTextureImageProvider(PowerImageRequestOptions options) : <span class="keyword">super</span>(options);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  FutureOr&lt;ImageInfo&gt; createImageInfo(<span class="built_in">Map</span> map) &#123;</span><br><span class="line">    <span class="built_in">int?</span> textureId = map[<span class="string">&#x27;textureId&#x27;</span>];</span><br><span class="line">    <span class="built_in">int?</span> width = map[<span class="string">&#x27;width&#x27;</span>];</span><br><span class="line">    <span class="built_in">int?</span> height = map[<span class="string">&#x27;height&#x27;</span>];</span><br><span class="line">    <span class="keyword">return</span> PowerTextureImageInfo.create(</span><br><span class="line">        textureId: textureId, width: width, height: height);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    PowerImageLoader.instance.releaseImageRequest(options);</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerTextureImageInfo</span> <span class="keyword">extends</span> <span class="title">PowerImageInfo</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> ui.Image? dummy;</span><br><span class="line">	<span class="keyword">final</span> <span class="built_in">int?</span> textureId;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 此方法使用一个通用的ui.Image? dummy创建PowerTextureImageInfo</span></span><br><span class="line">	<span class="comment">// 以便让ImageCache能够管理texture创建的图片</span></span><br><span class="line">	<span class="keyword">static</span> FutureOr&lt;PowerTextureImageInfo&gt; create(</span><br><span class="line">      &#123;<span class="built_in">int?</span> textureId, <span class="built_in">int?</span> width, <span class="built_in">int?</span> height&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (dummy != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> PowerTextureImageInfo(</span><br><span class="line">          textureId: textureId,</span><br><span class="line">          width: width,</span><br><span class="line">          height: height,</span><br><span class="line">          image: dummy!.clone());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dummy = <span class="keyword">await</span> _createImage(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> PowerTextureImageInfo(</span><br><span class="line">        textureId: textureId,</span><br><span class="line">        width: width,</span><br><span class="line">        height: height,</span><br><span class="line">        image: dummy!.clone());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;ui.Image&gt; _createImage(<span class="built_in">int</span> width, <span class="built_in">int</span> height) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Completer&lt;ui.Image&gt; completer = Completer&lt;ui.Image&gt;();</span><br><span class="line">  ui.decodeImageFromPixels(<span class="comment">// 使用指定的Uint8List创建ui.Image</span></span><br><span class="line">    Uint8List.fromList(</span><br><span class="line">        <span class="built_in">List</span>&lt;<span class="built_in">int</span>&gt;.filled(width * height * <span class="number">4</span>, <span class="number">0</span>, growable: <span class="keyword">false</span>)),</span><br><span class="line">    width,</span><br><span class="line">    height,</span><br><span class="line">    ui.PixelFormat.rgba8888,</span><br><span class="line">    (ui.Image image) &#123;</span><br><span class="line">      completer.complete(image);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> completer.future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PowerExternalImageProvider"><a href="#PowerExternalImageProvider" class="headerlink" title="PowerExternalImageProvider"></a>PowerExternalImageProvider</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerExternalImageProvider</span> <span class="keyword">extends</span> <span class="title">PowerImageProvider</span> </span>&#123;</span><br><span class="line">  PowerExternalImageProvider(PowerImageRequestOptions options) : <span class="keyword">super</span>(options);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  FutureOr&lt;ImageInfo&gt; createImageInfo(<span class="built_in">Map</span> map) &#123;</span><br><span class="line">    Completer&lt;ImageInfo&gt; completer = Completer&lt;ImageInfo&gt;();</span><br><span class="line">    <span class="built_in">int</span> handle = map[<span class="string">&#x27;handle&#x27;</span>];</span><br><span class="line">    <span class="built_in">int</span> length = map[<span class="string">&#x27;length&#x27;</span>];</span><br><span class="line">    <span class="built_in">int</span> width = map[<span class="string">&#x27;width&#x27;</span>];</span><br><span class="line">    <span class="built_in">int</span> height = map[<span class="string">&#x27;height&#x27;</span>];</span><br><span class="line">    <span class="built_in">int?</span> rowBytes = map[<span class="string">&#x27;rowBytes&#x27;</span>];</span><br><span class="line">    ui.PixelFormat pixelFormat =</span><br><span class="line">        ui.PixelFormat.values[map[<span class="string">&#x27;flutterPixelFormat&#x27;</span>] ?? <span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取图片在内存中的指针</span></span><br><span class="line">    Pointer&lt;Uint8&gt; pointer = Pointer&lt;Uint8&gt;.fromAddress(handle);</span><br><span class="line">    <span class="comment">// 获取对应内存中的数据</span></span><br><span class="line">    Uint8List pixels = pointer.asTypedList(length);</span><br><span class="line">    <span class="comment">// 根据内存中的数据创建ui.Image，这里会发生内存拷贝，大图片会出现内存峰值偏高</span></span><br><span class="line">    ui.decodeImageFromPixels(pixels, width, height, pixelFormat,</span><br><span class="line">        (ui.Image image) &#123;</span><br><span class="line">      ImageInfo imageInfo = PowerImageInfo(image: image);</span><br><span class="line">      completer.complete(imageInfo);</span><br><span class="line">      <span class="comment">//释放platform_image</span></span><br><span class="line">      PowerImageLoader.instance.releaseImageRequest(options);</span><br><span class="line">    &#125;, rowBytes: rowBytes);</span><br><span class="line">    <span class="keyword">return</span> completer.future;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码可以看到：</p>
<ul>
<li><em>texture</em> 方案采用的 PowerTextureImageProvider 创建的 ImageInfo 对应的 <code>ui.Image image</code> 一个共享的占位符，并不能真正真正绘制内容，实际上图片信息在对应的<code>PowerTextureImageInfo.textureId</code>中；</li>
<li><em>ffi</em> 方案创建的 ImageInfo 则根据 native 内存中的图片数据创建了对应的 ui.Image，与 Flutter 默认的 ImageProvider 提供的 ImageInfo 一样可以被 RawImage 正常使用。</li>
</ul>
<p>这里需要注意，虽然 <em>texture</em> 和 <em>ffi</em> 都采用了ImageCache来管理图片缓存，甚至 <em>ffi</em> 的内存也在Flutter侧管理，但是PowerImage本身不会出现我们之前在<a target="_blank" rel="noopener" href="https://xiaoyong.ml/blog/posts/1912667a/">Flutter Image</a>中分析的加载大量高清网图会出现的<strong>内存爆炸</strong>，这是因为虽然在ImageCache.putIfAbsent方法中_pendingImages同样保存了加载中的图片，但是实际这些<strong>图片加载过程中的内存由Native端图片加载库管理</strong>，而非Flutter，所以只要Native端图片加载库比较成熟，就可以避免这个问题。</p>
<p>到目前为止，我们分析了 PowerImage 根据 PowerImageProvider 获取的 ImageInfo 分别采用 ffi 和 texture 两种方案展示图片的过程。</p>
<br/>

<p>接下来分析一下之前提到的 <code>PowerImageProvider._loadAsync</code> 方法中使用 PowerImageLoader 获取图片的过程。整个过程可以分为 <strong>flutter 端发起请求&#x2F;处理回调</strong>、<strong>native 端接收请求&#x2F;返回结果</strong>两部分，在这过程中 Flutter 和 Native 使用 MethodChannel（发送获取释放图片指令） 和 EventChannel（接收图片成功加载的事件）进行通信。</p>
<h1 id="Flutter-x2F-Native-通信"><a href="#Flutter-x2F-Native-通信" class="headerlink" title="Flutter&#x2F;Native 通信"></a>Flutter&#x2F;Native 通信</h1><p>在上面分析<code>PowerImageProvider._loadAsync</code>方法时，我们注意到其中使用了**<em>PowerImageLoader</em>**获取图片信息 PowerImageCompleter：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PowerImageProvider._loadAsync 省略部分代码</span></span><br><span class="line">Future&lt;ImageInfo&gt; _loadAsync(</span><br><span class="line">    PowerImageProvider key, DecoderCallback? decode) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PowerImageCompleter powerImageCompleter =</span><br><span class="line">          PowerImageLoader.instance.loadImage(options);</span><br><span class="line">          <span class="built_in">Map</span> map = <span class="keyword">await</span> powerImageCompleter.completer!.future;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> createImageInfo(map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里是使用 PowerImageLoader 的单例加载图片，看一下具体的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存发起的图片请求</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">Map</span>&lt;<span class="built_in">String?</span>, PowerImageCompleter&gt; completers =</span><br><span class="line">      &lt;<span class="built_in">String?</span>, PowerImageCompleter&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    PowerImageChannel channel = PowerImageChannel();</span><br><span class="line">    <span class="keyword">static</span> PowerImageLoader instance = PowerImageLoader._();</span><br><span class="line"></span><br><span class="line">    PowerImageLoader._() &#123;</span><br><span class="line">        channel.impl = PowerImagePlatformChannel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化PowerImageChannel等，需要在加载图片之前（比如runApp之前执行）</span></span><br><span class="line">    <span class="keyword">void</span> setup(PowerImageSetupOptions? options) &#123;</span><br><span class="line">        _globalRenderType = options?.globalRenderType ?? defaultGlobalRenderType;</span><br><span class="line">        PowerImageMonitor.instance().errorCallback = options?.errorCallback;</span><br><span class="line">        PowerImageMonitor.instance().errorCallbackSamplingRate = options?.errorCallbackSamplingRate;</span><br><span class="line">        channel.setup();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    PowerImageCompleter loadImage(PowerImageRequestOptions options,) &#123;</span><br><span class="line">        PowerImageRequest request = PowerImageRequest.create(options);<span class="comment">// 创建PowerImageRequest</span></span><br><span class="line">        <span class="comment">// 发起图片请求</span></span><br><span class="line">        channel.startImageRequests(&lt;PowerImageRequest&gt;[request]);</span><br><span class="line">        <span class="comment">// 使用completers记录下刚刚发起的请求</span></span><br><span class="line">        PowerImageCompleter completer = PowerImageCompleter();</span><br><span class="line">        completer.request = request;</span><br><span class="line">        completer.completer = Completer&lt;<span class="built_in">Map</span>&gt;();</span><br><span class="line">        completers[request.uniqueKey()] = completer;</span><br><span class="line">        <span class="keyword">return</span> completer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当上面loadImage发起的图片加载完成之后，会调用此方法，从completers中取回对应的请求，调用完成</span></span><br><span class="line">    <span class="keyword">void</span> onImageComplete(<span class="built_in">Map</span>&lt;<span class="built_in">dynamic</span>, <span class="built_in">dynamic</span>&gt; map) <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="built_in">String?</span> uniqueKey = map[<span class="string">&#x27;uniqueKey&#x27;</span>];</span><br><span class="line">        PowerImageCompleter? completer = completers.remove(uniqueKey);</span><br><span class="line">        <span class="comment">//todo null case</span></span><br><span class="line">        completer?.completer?.complete(map);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先创建了 PowerImageRequest 对象：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerImageRequest</span> </span>&#123;</span><br><span class="line">  PowerImageRequest.create(PowerImageRequestOptions options)</span><br><span class="line">      : imageWidth = options.imageWidth,</span><br><span class="line">        imageHeight = options.imageHeight,</span><br><span class="line">        imageType = options.imageType,</span><br><span class="line">        renderingType = options.renderingType,</span><br><span class="line">        src = options.src;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>imageType</code>表示获取图片的方式（比如<code>network</code>，<code>nativeAsset</code>，<code>file</code>，<code>asset</code>等）；</li>
<li><code>renderingType</code>表示图片渲染方式，比如<code>external</code>（即 ffi 方案）、<code>texture</code>。</li>
</ul>
<p>然后通过<code>PowerImageChannel</code>发送请求（实际的执行的类是<code>PowerImagePlatformChannel</code>）：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerImagePlatformChannel</span> <span class="keyword">extends</span> <span class="title">PowerImageChannelImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  StreamSubscription? _subscription;</span><br><span class="line"></span><br><span class="line">  PowerImagePlatformChannel() &#123;</span><br><span class="line">    eventHandlers[<span class="string">&#x27;onReceiveImageEvent&#x27;</span>] = (<span class="built_in">Map</span>&lt;<span class="built_in">dynamic</span>, <span class="built_in">dynamic</span>&gt; event) &#123;</span><br><span class="line">        <span class="comment">// 将onReceiveImageEvent放到eventHandlers中，</span></span><br><span class="line">        <span class="comment">// 上述PowerImageLoader发起的请求完成后会执行下述代码</span></span><br><span class="line">        PowerImageLoader.instance.onImageComplete(event);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> setup() &#123;</span><br><span class="line">    <span class="comment">// 监听回调方法，监听Native端发送的图片加载结束事件</span></span><br><span class="line">    startListening();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  StreamSubscription? startListening() &#123;</span><br><span class="line">    _subscription ??= eventChannel.receiveBroadcastStream().listen(onEvent);</span><br><span class="line">    <span class="keyword">return</span> _subscription;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, EventHandler?&gt; eventHandlers = &lt;<span class="built_in">String</span>, EventHandler?&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理Native端发送的事件</span></span><br><span class="line">  <span class="keyword">void</span> onEvent(<span class="built_in">dynamic</span> val) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(val <span class="keyword">is</span> <span class="built_in">Map</span>&lt;<span class="built_in">dynamic</span>, <span class="built_in">dynamic</span>&gt;);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Map</span>&lt;<span class="built_in">dynamic</span>, <span class="built_in">dynamic</span>&gt; event = val;</span><br><span class="line">    <span class="built_in">String?</span> eventName = event[<span class="string">&#x27;eventName&#x27;</span>];</span><br><span class="line">    EventHandler? eventHandler = eventHandlers[eventName!];</span><br><span class="line">    <span class="keyword">if</span> (eventHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventHandler(event);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//TODO 发来了不认识的事件,需要处理一下</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> registerEventHandler(<span class="built_in">String</span> eventName, EventHandler eventHandler) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(eventName.isNotEmpty);</span><br><span class="line">    eventHandlers[eventName] = eventHandler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> unregisterEventHandler(<span class="built_in">String</span> eventName) &#123;</span><br><span class="line">    eventHandlers[eventName] = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@visibleForTesting</span></span><br><span class="line">  <span class="keyword">final</span> MethodChannel methodChannel = <span class="keyword">const</span> MethodChannel(<span class="string">&#x27;power_image/method&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@visibleForTesting</span></span><br><span class="line">  EventChannel eventChannel = <span class="keyword">const</span> EventChannel(<span class="string">&#x27;power_image/event&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主动发送请求到Native端</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> startImageRequests(<span class="built_in">List</span>&lt;PowerImageRequest&gt; requests) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> methodChannel.invokeListMethod(</span><br><span class="line">        <span class="string">&#x27;startImageRequests&#x27;</span>, encodeRequests(requests));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> releaseImageRequests(<span class="built_in">List</span>&lt;PowerImageRequest&gt; requests) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> methodChannel.invokeListMethod(</span><br><span class="line">        <span class="string">&#x27;releaseImageRequests&#x27;</span>, encodeRequests(requests));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结一下：</p>
<ul>
<li>使用<code>PowerImageLoader.setup</code>注册 MethodChannel 和 EventChannel</li>
<li>使用<code>PowerImageLoader.loadImage</code>向 Native 发起请求加载图片，将请求保存到<code>PowerImageLoader.completers</code>中并返回给调用者</li>
<li>当 Native 端处理完请求之后会回调 PowerImagePlatformChannel 中注册的 EventChannel，然后会执行<code>PowerImageLoader.instance.onImageComplete(event)</code>方法，使用返回的图片信息，从<code>PowerImageLoader.completers</code>找出并完成之前的请求</li>
</ul>
<br/>

<p>以上分析为 Flutter 端向 Native 端发起请求的过程，下面以 Android 端为例分析一下 Native 端的处理过程：</p>
<p>首先是在 PowerImagePlugin 中向 Flutter 引擎注册对应的方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PowerImagePlugin</span> <span class="title">implements</span> <span class="title">FlutterPlugin</span>, <span class="type">MethodCallHandler &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void onAttachedToEngine(FlutterPluginBinding flutterPluginBinding) &#123;</span><br><span class="line">        <span class="keyword">if</span>(sContext == <span class="literal">null</span>)&#123;</span><br><span class="line">            sContext = flutterPluginBinding.getApplicationContext();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册与Flutter端对应的方法</span></span><br><span class="line">        methodChannel = new MethodChannel(</span><br><span class="line">                flutterPluginBinding.getBinaryMessenger(), <span class="string">&quot;power_image/method&quot;</span>);</span><br><span class="line">        methodChannel.setMethodCallHandler(<span class="keyword">this</span>);</span><br><span class="line">        eventChannel = new EventChannel(</span><br><span class="line">                flutterPluginBinding.getBinaryMessenger(), <span class="string">&quot;power_image/event&quot;</span>);</span><br><span class="line">        eventChannel.setStreamHandler(PowerImageEventSink.getInstance());</span><br><span class="line">        PowerImageRequestManager.getInstance()</span><br><span class="line">                .configWithTextureRegistry(flutterPluginBinding.getTextureRegistry());</span><br><span class="line">        PowerImageDispatcher.getInstance().prepare();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 Flutter 端向 Native 发送消息时，Flutter 引擎会调用<code>PowerImagePlugin.onMethodCall</code>方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PowerImagePlugin.onMethodCall</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> void onMethodCall(MethodCall call, Result result) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;startImageRequests&quot;</span>.equals(call.method)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (call.arguments instanceof List) &#123;</span><br><span class="line">            List arguments = (List) call.arguments;</span><br><span class="line">            <span class="comment">// 将请求结果返回，只是根据传参创建请求并保存，</span></span><br><span class="line">            <span class="comment">// 将请求信息返回给Flutter端</span></span><br><span class="line">            List results = PowerImageRequestManager.getInstance()</span><br><span class="line">                    .configRequestsWithArguments(arguments);</span><br><span class="line">            result.success(results);</span><br><span class="line">            <span class="comment">// 开始真正执行请求，找到上一步创建的请求PowerImageBaseRequest</span></span><br><span class="line">            <span class="comment">// 并执行PowerImageBaseRequest.startLoading</span></span><br><span class="line">            PowerImageRequestManager.getInstance().startLoadingWithArguments(arguments);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;startImageRequests require List arguments&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;releaseImageRequests&quot;</span>.equals(call.method)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (call.arguments instanceof List) &#123;</span><br><span class="line">            List arguments = (List) call.arguments;</span><br><span class="line">            <span class="comment">// 立即执行释放请求</span></span><br><span class="line">            List results = PowerImageRequestManager.getInstance().releaseRequestsWithArguments(arguments);</span><br><span class="line">            result.success(results);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;stopImageRequests require List arguments&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result.notImplemented();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于不同的调用请求：</p>
<ul>
<li><code>startImageRequests</code>：先根据请求参数创建好请求并返回给 Flutter 调用方；然后通过 PowerImageRequestManager 真正执行请求（最终会通过<code>PowerImagePlugin.PowerImageEventSink.getInstance().sendImageStateEvent</code>向 Flutter 通知结果）。</li>
<li><code>releaseImageRequests</code>：立即从<code>PowerImageRequestManager.requests</code>中去除对应的请求并尝试终止任务，并向 Flutter 返回结果。</li>
</ul>
<p>下面着重分析一下执行图片请求的逻辑（<code>startImageRequests</code>的情况）：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PowerImageRequestManager</span> </span>&#123;</span><br><span class="line">  private <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, PowerImageBaseRequest&gt; requests;</span><br><span class="line">  private WeakReference&lt;TextureRegistry&gt; textureRegistryWrf;</span><br><span class="line"></span><br><span class="line">  public <span class="built_in">List</span>&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;&gt; configRequestsWithArguments(<span class="built_in">List</span>&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;&gt; list) &#123;</span><br><span class="line">        <span class="built_in">List</span>&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span> || list.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> results;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; arguments = list.<span class="keyword">get</span>(i);</span><br><span class="line">            <span class="built_in">String</span> renderType = (<span class="built_in">String</span>) arguments.<span class="keyword">get</span>(<span class="string">&quot;renderingType&quot;</span>);</span><br><span class="line">            PowerImageBaseRequest request;</span><br><span class="line">            <span class="keyword">if</span> (RENDER_TYPE_EXTERNAL.equals(renderType)) &#123;<span class="comment">// ffi方案</span></span><br><span class="line">                request = <span class="keyword">new</span> PowerImageExternalRequest(arguments);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RENDER_TYPE_TEXTURE.equals(renderType)) &#123;<span class="comment">// texture方案</span></span><br><span class="line">                request = <span class="keyword">new</span> PowerImageTextureRequest(arguments, textureRegistryWrf.<span class="keyword">get</span>());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存创建的请求</span></span><br><span class="line">            requests.put(request.requestId, request);</span><br><span class="line">            boolean success = request.configTask();</span><br><span class="line">            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; requestInfo = request.encode();</span><br><span class="line">            requestInfo.put(<span class="string">&quot;success&quot;</span>, success);</span><br><span class="line">            results.add(requestInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> startLoadingWithArguments(<span class="built_in">List</span> arguments) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arguments == <span class="keyword">null</span> || arguments.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; arguments.size(); i++) &#123;</span><br><span class="line">            <span class="built_in">Map</span> arg = (<span class="built_in">Map</span>) arguments.<span class="keyword">get</span>(i);</span><br><span class="line">            <span class="built_in">String</span> requestId = (<span class="built_in">String</span>) arg.<span class="keyword">get</span>(<span class="string">&quot;uniqueKey&quot;</span>);</span><br><span class="line">            <span class="comment">// 找出在configRequestsWithArguments方法中创建的请求并执行</span></span><br><span class="line">            PowerImageBaseRequest request = requests.<span class="keyword">get</span>(requestId);</span><br><span class="line">            request.startLoading();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见对于<em>ffi</em>和<em>texture</em>方案，分别涉及到**<em>PowerImageExternalRequest</em><strong>和</strong><em>PowerImageTextureRequest</em><strong>两个类。他们都继承自</strong><em>PowerImageBaseRequest</em>**类，其<code>startLoading</code>方法会调用<code>performLoadImage</code>方法：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PowerImageBaseRequest</span> </span>&#123;</span><br><span class="line">    private <span class="keyword">void</span> performLoadImage() &#123;</span><br><span class="line">        <span class="comment">// 获取图片</span></span><br><span class="line">        PowerImageLoader.getInstance().handleRequest(</span><br><span class="line">                imageRequestConfig,</span><br><span class="line">                <span class="keyword">new</span> PowerImageLoaderProtocol.PowerImageResponse() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    public <span class="keyword">void</span> onResult(PowerImageResult result) &#123;</span><br><span class="line">                        <span class="comment">// 加载到图片之后进行解析</span></span><br><span class="line">                        PowerImageBaseRequest.<span class="keyword">this</span>.onLoadResult(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>PowerImageBaseRequest.performLoadImage</code>方法中：</p>
<ul>
<li>会先通过<code>PowerImageLoader.getInstance().handleRequest</code>方法获取图片；</li>
<li>然后调用<code>PowerImageBaseRequest.this.onLoadResult</code>方法也就是<em>PowerImageExternalRequest</em>和<em>PowerImageTextureRequest</em>的<code>onLoadResult()</code>方法。</li>
</ul>
<p>在他们的<code>onLoadResult(final PowerImageResult result)</code>方法中，入参 PowerImageResult 持有 FlutterImage 对象，后者持有加载的图片的 Drawable，他们根据各自的特点对图片进行处理后（<em>ffi</em>获取 Drawable 的 bitmap 对象，&lt;&gt;如果图片不是<code>ARGB_8888</code>则<em>会</em>发生一次 Bitmap 拷贝&gt;；<em>texture</em>使用 Bitmap 绘制到 Canvas 上面），通过<code>PowerImageBaseRequest.onLoadSuccess()</code>方法或者<code>PowerImageBaseRequest.onLoadFailed</code>返回结果。</p>
<p>其中:</p>
<ul>
<li>PowerImageExternalRequest 从获取到的图片生成 Bitmap 并返回其指针、宽高、大小等属性返回；</li>
<li>PowerImageTextureRequest 则将图片绘制到<code>Surface</code>中并返回<code>textureId</code>等信息。</li>
</ul>
<p>而对于<code>PowerImageLoader.getInstance().handleRequest()</code>，这里面的各个 PowerImageLoaderProtocol 由 Native 端通过<code>PowerImageLoader.getInstance().registerImageLoader</code><strong>注册具体的实现</strong>，<code>handleRequest()</code>方法正是调用他们获取图片。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PowerImageLoader</span> <span class="title">implements</span> <span class="title">PowerImageLoaderProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, PowerImageLoaderProtocol&gt; imageLoaders;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PowerImageLoader() &#123;</span><br><span class="line">        imageLoaders = new HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> static PowerImageLoader instance = new PowerImageLoader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> static PowerImageLoader getInstance() &#123;</span><br><span class="line">        <span class="keyword">return</span> PowerImageLoader.Holder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在Android中调用此方法，注册获取&quot;network&quot;、&quot;nativeAsset&quot;、&quot;asset&quot;、&quot;file&quot;等图片的实现</span></span><br><span class="line">    <span class="keyword">public</span> void registerImageLoader(PowerImageLoaderProtocol loader, String imageType) &#123;</span><br><span class="line">        imageLoaders.put(imageType, loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此方法调用上面registerImageLoader方法注册的ImageLoader获取图片</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void handleRequest(PowerImageRequestConfig request, PowerImageResponse response) &#123;</span><br><span class="line">        PowerImageLoaderProtocol imageLoader = imageLoaders.<span class="keyword">get</span>(request.imageType);</span><br><span class="line">        <span class="keyword">if</span> (imageLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;PowerImageLoader for &quot;</span></span><br><span class="line">                    + request.imageType + <span class="string">&quot; has not been registered.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        imageLoader.handleRequest(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Native-端图片获取"><a href="#Native-端图片获取" class="headerlink" title="Native 端图片获取"></a>Native 端图片获取</h1><p>上面提到，<em>power_image</em>默认的**<em>PowerImageLoaderProtocol</em>**有以下几种类：”<code>network</code>“、”<code>nativeAsset</code>“、”<code>asset</code>“、”<code>file</code>“，这些都需要使用者在 Native 端注册才能正常使用。</p>
<p>以”<code>network</code>“为例,在<code>MainActivity.onCreate</code>方法中：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span>: <span class="type">FlutterActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            PowerImageLoader.getInstance().registerImageLoader(</span><br><span class="line">            PowerImageNetworkLoader(<span class="keyword">this</span>.applic ationContext), <span class="string">&quot;network&quot;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**<em>PowerImageNetworkLoader</em><strong>继承自</strong><em>PowerImageLoaderProtocol</em>**，图片的加载逻辑在其<code>handleRequest</code>方法中：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerImageNetworkLoader</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> context: Context) : PowerImageLoaderProtocol &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleRequest</span><span class="params">(request: <span class="type">PowerImageRequestConfig</span>, response: <span class="type">PowerImageResponse</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 使用Glide加载图片Drawable</span></span><br><span class="line">        Glide.with(context).asDrawable().load(request.srcString())</span><br><span class="line">            .listener(<span class="keyword">object</span> : RequestListener&lt;Drawable&gt; &#123;</span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLoadFailed</span><span class="params">(e: <span class="type">GlideException</span>?,model: <span class="type">Any</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                    target: <span class="type">Target</span>&lt;<span class="type">Drawable</span>&gt;,isFirstResource: <span class="type">Boolean</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">                    response.onResult(PowerImageResult.genFailRet(<span class="string">&quot;Native加载失败: &quot;</span> + <span class="keyword">if</span> (e != <span class="literal">null</span>) e.message <span class="keyword">else</span> <span class="string">&quot;null&quot;</span>))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceReady</span><span class="params">(resource: <span class="type">Drawable</span>,model: <span class="type">Any</span> <span class="type">target</span>:<span class="type">Target</span>&lt;<span class="type">Drawable</span>&gt;,dataSource: <span class="type">DataSource</span>,isFirstResource:<span class="type">Boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function">                )</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (resource <span class="keyword">is</span> GifDrawable) &#123;</span><br><span class="line">                        <span class="comment">// 动图</span></span><br><span class="line">                        <span class="comment">// 加载成功，调用回调</span></span><br><span class="line">                        response.onResult(</span><br><span class="line">                            PowerImageResult.genSucRet(</span><br><span class="line">                                GlideMultiFrameImage(</span><br><span class="line">                                    resource <span class="keyword">as</span> GifDrawable,</span><br><span class="line">                                    <span class="literal">false</span></span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (resource <span class="keyword">is</span> BitmapDrawable) &#123;<span class="comment">// 普通图片</span></span><br><span class="line">                            response.onResult(</span><br><span class="line">                                PowerImageResult.genSucRet(</span><br><span class="line">                                    FlutterSingleFrameImage(</span><br><span class="line">                                        resource <span class="keyword">as</span> BitmapDrawable</span><br><span class="line">                                    )</span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            response.onResult(PowerImageResult.genFailRet(<span class="string">&quot;Native加载失败:  resource : <span class="variable">$resource</span>&quot;</span>))</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).submit(</span><br><span class="line">                <span class="keyword">if</span> (request.width &lt;= <span class="number">0</span>) Target.SIZE_ORIGINAL <span class="keyword">else</span> request.width,</span><br><span class="line">                <span class="keyword">if</span> (request.height &lt;= <span class="number">0</span>) Target.SIZE_ORIGINAL <span class="keyword">else</span> request.height</span><br><span class="line">            )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，当 Flutter 端向 Native 发送消息时：</p>
<ul>
<li>Flutter 引擎会调用<code>PowerImagePlugin.onMethodCall</code>方法，先<strong>创建</strong>对应的请求**<em>PowerImageBaseRequest</em>**；</li>
<li>然后<code>PowerImageRequestManager.getInstance().startLoadingWithArguments</code><strong>执行</strong>刚刚上一步创建的请求，此方法内部执行<code>PowerImageBaseRequest.startLoading()</code>方法；</li>
<li>在**<em>PowerImageBaseRequest</em><strong>类内部，其<code>startLoading</code>方法会调用<code>performLoadImage</code>方法，后者又会调用<code>PowerImageLoader.getInstance().handleRequest()</code>方法</strong>请求加载图片**，并指定回调方法为<code>PowerImageBaseRequest.onLoadResult(result)</code>；</li>
<li><code>PowerImageLoader.handleRequest</code>方法内部通过请求的<code>imageType</code>找到 Native 端（比如 Android 在<code>MainActivity.onCreate</code>中注册的）<code>PowerImageLoaderProtocol imageLoader</code>，并执行其<code>handleRequest</code>方法<strong>处理加载图片</strong>请求；</li>
<li><code>PowerImageLoaderProtocol.handleRequest()</code>方法中<strong>调用原生的图片加载库</strong>获取 Drawable 并生成 PowerImageResult 回调<code>PowerImageResponse.onResult</code>方法，此方法会回调<code>PowerImageBaseRequest.this.onLoadResult(result)</code> ；</li>
<li>在**<em>PowerImageTextureRequest</em><strong>或者</strong><em>PowerImageExternalRequest</em>**的<code>onLoadResult</code>方法中对获取到的<code>PowerImageResult</code>进行处理之后回调<code>PowerImageBaseRequest</code>的<code>onLoadSuccess()</code>或者<code>onLoadFailed(final String errMsg)</code>方法返回图片请求结果。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong><em>power_image</em></strong> 是一个利用原生库加载&#x2F;管理图片的比较适用于 Flutter&#x2F;Native 混合开发的图片加载库，提供了 <strong><em>texture</em></strong> 和 <strong><em>ffi</em></strong> 两种加载图片的方式。</p>
<p>其中，texture 方案实际使用 Texture 组件展示图片；而 ffi 方案则只有图片获取在 Native 端，当使用<code>ui.decodeImageFromPixels</code>方法从 Bitmap 内存指针创建<em>ui.Image</em>之后（根据<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TdTGK21S-Yd3aD-yZDoYyQ#:~:text=decodeImageFromPixels%C2%A0%E4%BC%9A%E6%9C%89%E5%86%85%E5%AD%98%E6%8B%B7%E8%B4%9D%EF%BC%8C%E5%9C%A8%E6%8B%B7%E8%B4%9D%E8%A7%A3%E7%A0%81%E5%90%8E%E7%9A%84%E5%9B%BE%E7%89%87%E6%95%B0%E6%8D%AE%E6%97%B6%EF%BC%8C%E5%86%85%E5%AD%98%E5%B3%B0%E5%80%BC%E4%BC%9A%E6%9B%B4%E5%8A%A0%E4%B8%A5%E9%87%8D">阿里的描述</a>，这里会发生一次内存拷贝，实际代码可以参考<a target="_blank" rel="noopener" href="https://www.notion.so/ui-decodeImageFromPixels-a401c6cf1c92428bb3c3a37da1078a6b">这里</a>），剩下按照和 Flutter Image 类似的步骤展示图片。</p>
<p>根据官方的说法：</p>
<ol>
<li>Texture 适用于日常场景，优先选择；</li>
<li>FFI 更适用于<ol>
<li>flutter &lt;&#x3D; 1.23.0-18.1.pre 版本中，在模拟器上显示图片</li>
<li>获取 ui.Image 图片数据</li>
<li>flutter 侧解码，解码前的数据拷贝影响较小。</li>
</ol>
</li>
</ol>
<p>此外，根据官方<a target="_blank" rel="noopener" href="https://github.com/alibaba/power_image/issues/17">power_image&#x2F;issues&#x2F;17</a>的说法，“在 2.5.3 上 ffi 性能已经跟  <code>texture</code>不相上下了”，而且 textrue 方案在 Android 上较大尺寸可能会 crash（<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/issues/92397">flutter&#x2F;flutter#92397</a>），所以<strong>更推荐使用 ffi 方案</strong>。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/power_image">https://github.com/alibaba/power_image</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TdTGK21S-Yd3aD-yZDoYyQ">Flutter 图片库高燃新登场</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU4MDUxOTI5NA==&mid=2247485142&idx=1&sn=b416f1d0c8f3fd2077075441154df090&scene=21#wechat_redirect">闲鱼 Flutter 图片框架架构演进（超详细）</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yUm4UFggYLgDbj4_JCjEdg#at">Flutter 图片内存优化实践</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/power_image/issues/17">https://github.com/alibaba/power_image&#x2F;issues&#x2F;17</a></p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/ui-decodeImageFromPixels-a401c6cf1c92428bb3c3a37da1078a6b"><code>ui.decodeImageFromPixels分析</code></a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>JI, XIAOYONG
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jixiaoyong.github.io/blog/posts/727d7800/" title="Flutter图片加载方案分析之power_image">https://jixiaoyong.github.io/blog/posts/727d7800/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/blog/tags/flutter/" rel="tag"># flutter</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/posts/23ac516a/" rel="prev" title="Flutter图片加载方案分析之extended_image">
                  <i class="fa fa-chevron-left"></i> Flutter图片加载方案分析之extended_image
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/posts/62beedda/" rel="next" title="Flutter动画分析之Hero">
                  Flutter动画分析之Hero <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JI, XIAOYONG</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/schemes/muse.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>





  




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://vercel.xiaoyong.ml","cssUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.css","commentCount":true,"pageview":true,"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.js","locale":{"placeholder":"ヾ(=^▽^=)ノ"},"meta":["nick","mail","link"],"login":"enable","pageSize":10,"el":"#waline","comment":true,"path":"/blog/posts/727d7800/"}</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/waline/2.5.1/waline.min.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
